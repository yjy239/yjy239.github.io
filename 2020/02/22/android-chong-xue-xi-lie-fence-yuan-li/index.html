<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 fence原理, Android | Linux | Flutter">
    <meta name="description" content="前言在前文中，我们已经讨论了Android 渲染体系中整体流程。但是对于fence，每一个厂商对它的理解都有点点不同，但是大体的思路和框架是跟着Android渲染体系走的。就以上一篇的msm8960为例子，在hwc_set中执行了hwc_s">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 fence原理 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/6.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 fence原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-02-22
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        11.2k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        49 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在前文中，我们已经讨论了Android 渲染体系中整体流程。但是对于fence，每一个厂商对它的理解都有点点不同，但是大体的思路和框架是跟着Android渲染体系走的。就以上一篇的msm8960为例子，在hwc_set中执行了hwc_sync，这个方法做了一件十分重要的申请，如果发现FenceBuffer中的fence是有效的，则会调用阻塞，放开阻塞后，调用下面这个方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token function">ioctl</span><span class="token punctuation">(</span>fbFd<span class="token punctuation">,</span> MSMFB_BUFFER_SYNC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>MSMFB_BUFFER_SYNC 这个命令是对应上高通的fb驱动自己实现的同步命令，生产一个fence进行同步。</p>
<p>到了这里我们似乎没有办法研究fence继续下去了，因为我已经没有源码了。但是，还是秉承OpenGL es的思路，既然找不到硬件的开源，我们把目光转移到软件(CPU)模拟同步栅的逻辑中进行学习。</p>
<p>我们能在Android源码中，在目录/<a href="http://androidxref.com/9.0.0_r3/xref/external/" target="_blank" rel="noopener">external</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/" target="_blank" rel="noopener">drm_hwcomposer</a>下有一个基于drm驱动实现的hwcomposer。</p>
<p>drm(Direct Rendering Manager)驱动是什么？顾名思义，直接渲染控制器，基于dma-buf。为了取代直接复杂的fb驱动通信，当前Linux主流显示框架下，引入了一个新的内核模块，名为drm驱动。原来的fb内核模块，不支持dma-buf，多层图层合成等。而这些问题都会在drm中统一对GPU和Display驱动模块进行管理，是的面向硬件的编程变得统一化。</p>
<p>用一幅wiki上的一副图来表示：<br><img src="/images/drm.png" alt="drm.png"></p>
<p>能看到整个drm中，大致分为三个模块：</p>
<ul>
<li>1.面向用户空间的libdrm</li>
<li>2.KMS 更新画面以及设置显示参数</li>
<li>3.GEM 主要负责显示buffer的分配和释放，也是GPU唯一用到DRM的地方。</li>
</ul>
<p>有一个大佬<a href="https://blog.csdn.net/hexiaolong2009" target="_blank" rel="noopener">何小龙</a>写了一系列的DRM入门文章，写的很棒。之后我将不会大篇幅的介绍DRM驱动的操作，只需要知道基础的操作，就能够进行drm_hwcomposer的解析。<br>drm的atomic操作</p>
<ul>
<li><ol>
<li>drmSetClientCap(DRM_CLIENT_CAP_UNIVERSAL_PLANES) 初始化Plane硬件图层。DRM_CLIENT_CAP_UNIVERSAL_PLANES返回了OverLayer(YUV叠加图层)，Cursor(光标)，Primary(主要图层RGB)</li>
</ol>
</li>
<li><ol start="2">
<li>drmModePropertySetAlloc 申请一个参数承载内存</li>
</ol>
</li>
<li><ol start="3">
<li>drmModePropertySetAdd 添加显示参数，会传入每一个GrpahicBuffer对应的句柄，裁剪区域等,一系列操作就如同drmModeSetPlane一样设置硬件图层参数。</li>
</ol>
</li>
<li><ol start="4">
<li>drmModeAtomicCommit 提交参数到drm驱动进行显示。这个过程中有阻塞等待drm渲染到屏幕，也有非阻塞加入到drm的工作队列中进行消费</li>
</ol>
</li>
<li><ol start="5">
<li>drmModeAtomicFree 释放参数承载内存</li>
</ol>
</li>
</ul>
<p>本文将不会对drm驱动的源码和fb驱动源码进行解析，让我们把注意力集中到SF的机制上，以后有机会会和大家聊一聊这两个驱动的源码以及设计。</p>
<p>如果遇到问题请到本文<a href="https://www.jianshu.com/p/dca7c4d9495c" target="_blank" rel="noopener">https://www.jianshu.com/p/dca7c4d9495c</a>互相讨论</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>首先需要对drm_hwcomposer的hw_device_t结构体创建有一个大体的印象：<br>文件：<a href="http://androidxref.com/9.0.0_r3/xref/external/" target="_blank" rel="noopener">ernal</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/" target="_blank" rel="noopener">drm_hwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/hwcomposer.cpp" target="_blank" rel="noopener">hwcomposer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hwc_device_open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> hw_module_t <span class="token operator">*</span>module<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
                           <span class="token keyword">struct</span> hw_device_t <span class="token operator">*</span><span class="token operator">*</span>dev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> HWC_HARDWARE_COMPOSER<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>hwc_context_t<span class="token operator">></span> <span class="token function">ctx</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">hwc_context_t</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> ret <span class="token operator">=</span> ctx<span class="token operator">-</span><span class="token operator">></span>drm<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ret <span class="token operator">=</span> <span class="token function">hw_get_module</span><span class="token punctuation">(</span>GRALLOC_HARDWARE_MODULE_ID<span class="token punctuation">,</span>
                      <span class="token punctuation">(</span><span class="token keyword">const</span> hw_module_t <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>ctx<span class="token operator">-</span><span class="token operator">></span>gralloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ret <span class="token operator">=</span> ctx<span class="token operator">-</span><span class="token operator">></span>dummy_timeline<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ctx<span class="token operator">-</span><span class="token operator">></span>importer<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>Importer<span class="token operator">::</span><span class="token function">CreateInstance</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ctx<span class="token operator">-</span><span class="token operator">></span>drm<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-</span><span class="token operator">></span>importer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Failed to create importer instance"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ret <span class="token operator">=</span> <span class="token function">hwc_enumerate_displays</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>tag <span class="token operator">=</span> HARDWARE_DEVICE_TAG<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>version <span class="token operator">=</span> HWC_DEVICE_API_VERSION_1_4<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>module <span class="token operator">=</span> <span class="token keyword">const_cast</span><span class="token operator">&lt;</span>hw_module_t <span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">.</span>close <span class="token operator">=</span> hwc_device_close<span class="token punctuation">;</span>

  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>dump <span class="token operator">=</span> hwc_dump<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>prepare <span class="token operator">=</span> hwc_prepare<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>set <span class="token operator">=</span> hwc_set<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>eventControl <span class="token operator">=</span> hwc_event_control<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>setPowerMode <span class="token operator">=</span> hwc_set_power_mode<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>query <span class="token operator">=</span> hwc_query<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>registerProcs <span class="token operator">=</span> hwc_register_procs<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>getDisplayConfigs <span class="token operator">=</span> hwc_get_display_configs<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>getDisplayAttributes <span class="token operator">=</span> hwc_get_display_attributes<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>getActiveConfig <span class="token operator">=</span> hwc_get_active_config<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>setActiveConfig <span class="token operator">=</span> hwc_set_active_config<span class="token punctuation">;</span>
  ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>setCursorPositionAsync <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">/* TODO: Add cursor */</span>

  <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>ctx<span class="token operator">-</span><span class="token operator">></span>device<span class="token punctuation">.</span>common<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在device中同样设置了set和prepare方法，对应渲染屏幕set方法是hwc_set。</p>
<h2 id="fence-的介绍"><a href="#fence-的介绍" class="headerlink" title="fence 的介绍"></a>fence 的介绍</h2><p>在fence中有三个十分重要的对象：</p>
<ul>
<li><ol>
<li>sync_timeline 每当hal的hw_device_t初始化时候，将会对整个渲染进行一个不断递增时间轴的创建，这个时间轴中有许多同步时间点，称为sync_pt。每一个sync_pt同步时间点只会属于一个fence。</li>
</ol>
</li>
<li><ol start="2">
<li>sync_pt sync_pt代表时间轴上的点，告诉SF这个时间点之前都需要进行同步。</li>
</ol>
</li>
<li><ol start="3">
<li>fence 同步等待的核心结构体，只有唤醒了fence，SF的渲染流程才能继续。</li>
</ol>
</li>
</ul>
<p>drm_hwc中整一个fence同步操作都是基于libsync操作dma中sw_sync中进行的，现有一个大致的印象后面该如何工作，我们接下来进行分析。</p>
<h3 id="sync-timeline的初始化"><a href="#sync-timeline的初始化" class="headerlink" title="sync_timeline的初始化"></a>sync_timeline的初始化</h3><p>其中在hw_device_t结构体初始化中，其实有一个操作占了很重要的逻辑。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">ret <span class="token operator">=</span> ctx<span class="token operator">-</span><span class="token operator">></span>dummy_timeline<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/external/" target="_blank" rel="noopener">external</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/" target="_blank" rel="noopener">drm_hwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/hwcomposer.cpp" target="_blank" rel="noopener">hwcomposer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">DummySwSyncTimeline</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">int</span> <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> timeline_fd_<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token function">sw_sync_timeline_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法很简单，实际上就是通过sw_sync_timeline_create创建一个时间轴，把对应内核对象的文件句柄fd返回给timeline_fd_。</p>
<h3 id="sw-sync-timeline-create-创建"><a href="#sw-sync-timeline-create-创建" class="headerlink" title="sw_sync_timeline_create 创建"></a>sw_sync_timeline_create 创建</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/system/" target="_blank" rel="noopener">system</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsync/" target="_blank" rel="noopener">libsync</a>/<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsync/sync.c" target="_blank" rel="noopener">sync.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">sw_sync_timeline_create</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/sys/kernel/debug/sync/sw_sync"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/sw_sync"</span><span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在这个过程中会尝试打开驱动sw_sync。值得注意的是，在高版本中sw_sync已经放入了debug系列中，低版本中有可能使用sw_sync进行软件模拟fence。</p>
<h3 id="sync-timeline-内核中的初始化"><a href="#sync-timeline-内核中的初始化" class="headerlink" title="sync_timeline  内核中的初始化"></a>sync_timeline  内核中的初始化</h3><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c</a>（ 网站上很少有高版本的Android的kernel，这是从google官网上fork的）</p>
<p>首先来看看这个内核模块的文件操作结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> file_operations sw_sync_debugfs_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>open           <span class="token operator">=</span> sw_sync_debugfs_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release        <span class="token operator">=</span> sw_sync_debugfs_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> sw_sync_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>compat_ioctl    <span class="token operator">=</span> sw_sync_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们把目光放到sw_sync_debugfs_open中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sw_sync_debugfs_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">;</span>
    <span class="token keyword">char</span> task_comm<span class="token punctuation">[</span>TASK_COMM_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token function">get_task_comm</span><span class="token punctuation">(</span>task_comm<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>

    obj <span class="token operator">=</span> <span class="token function">sync_timeline_create</span><span class="token punctuation">(</span>task_comm<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

    file<span class="token operator">-</span><span class="token operator">></span>private_data <span class="token operator">=</span> obj<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过sync_timeline_create创建一个sync_timeline，最后保存到对应的file私有数据中。</p>
<h4 id="sync-timeline-create"><a href="#sync-timeline-create" class="headerlink" title="sync_timeline_create"></a>sync_timeline_create</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span><span class="token function">sync_timeline_create</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">;</span>

    obj <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>obj<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>kref<span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token operator">-</span><span class="token operator">></span>context <span class="token operator">=</span> <span class="token function">fence_context_alloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">strlcpy</span><span class="token punctuation">(</span>obj<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>obj<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>active_list_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sync_timeline_debug_add</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">sync_timeline_debug_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>

    <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_timeline_list_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>sync_timeline_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sync_timeline_list_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_timeline_list_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时sync_timeline初始化了context为1，并且初始化了active_list_head和child_list_head两个链表头。最后把sync_timeline添加到全局链表sync_timeline_list_head中。</p>
<h2 id="hrm-hwcomposer-渲染中的同步栅参与的操作"><a href="#hrm-hwcomposer-渲染中的同步栅参与的操作" class="headerlink" title="hrm_hwcomposer 渲染中的同步栅参与的操作"></a>hrm_hwcomposer 渲染中的同步栅参与的操作</h2><p>经过前文的阅读，就能知道在渲染的时候，对应的方法是上面hwc_set方法。这里我们只关注其fence参与的核心事件。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hwc_set</span><span class="token punctuation">(</span>hwc_composer_device_1_t <span class="token operator">*</span>dev<span class="token punctuation">,</span> size_t num_displays<span class="token punctuation">,</span>
                   hwc_display_contents_1_t <span class="token operator">*</span><span class="token operator">*</span>sf_display_contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> hwc_context_t <span class="token operator">*</span>ctx <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_context_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>dev<span class="token operator">-</span><span class="token operator">></span>common<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>CheckedOutputFd<span class="token operator">></span> checked_output_fences<span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>DrmHwcDisplayContents<span class="token operator">></span> displays_contents<span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>DrmCompositionDisplayLayersMap<span class="token operator">></span> layers_map<span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>size_t<span class="token operator">>></span> layers_indices<span class="token punctuation">;</span>
  displays_contents<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>num_displays<span class="token punctuation">)</span><span class="token punctuation">;</span>
  layers_indices<span class="token punctuation">.</span><span class="token function">reserve</span><span class="token punctuation">(</span>num_displays<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_displays<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hwc_display_contents_1_t <span class="token operator">*</span>dc <span class="token operator">=</span> sf_display_contents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    displays_contents<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DrmHwcDisplayContents <span class="token operator">&amp;</span>display_contents <span class="token operator">=</span> displays_contents<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    layers_indices<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>size_t<span class="token operator">></span> <span class="token operator">&amp;</span>indices_to_composite <span class="token operator">=</span> layers_indices<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sf_display_contents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    std<span class="token operator">::</span>string <span class="token function">display_fence_description</span><span class="token punctuation">(</span>display_index_formatter<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checked_output_fences<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dc<span class="token operator">-</span><span class="token operator">></span>retireFenceFd<span class="token punctuation">,</span>
                                       display_fence_description<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       ctx<span class="token operator">-</span><span class="token operator">></span>dummy_timeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    display_contents<span class="token punctuation">.</span>retire_fence <span class="token operator">=</span> <span class="token function">OutputFd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dc<span class="token operator">-</span><span class="token operator">></span>retireFenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    size_t num_dc_layers <span class="token operator">=</span> dc<span class="token operator">-</span><span class="token operator">></span>numHwLayers<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> num_dc_layers<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hwc_layer_1_t <span class="token operator">*</span>sf_layer <span class="token operator">=</span> <span class="token operator">&amp;</span>dc<span class="token operator">-</span><span class="token operator">></span>hwLayers<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>

      display_contents<span class="token punctuation">.</span>layers<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      DrmHwcLayer <span class="token operator">&amp;</span>layer <span class="token operator">=</span> display_contents<span class="token punctuation">.</span>layers<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

      layer<span class="token punctuation">.</span>acquire_fence<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>sf_layer<span class="token operator">-</span><span class="token operator">></span>acquireFenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
      sf_layer<span class="token operator">-</span><span class="token operator">></span>acquireFenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

      std<span class="token operator">::</span>ostringstream layer_fence_formatter<span class="token punctuation">;</span>
      std<span class="token operator">::</span>string <span class="token function">layer_fence_description</span><span class="token punctuation">(</span>layer_fence_formatter<span class="token punctuation">.</span><span class="token function">str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      checked_output_fences<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sf_layer<span class="token operator">-</span><span class="token operator">></span>releaseFenceFd<span class="token punctuation">,</span>
                                         layer_fence_description<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                         ctx<span class="token operator">-</span><span class="token operator">></span>dummy_timeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
      layer<span class="token punctuation">.</span>release_fence <span class="token operator">=</span> <span class="token function">OutputFd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sf_layer<span class="token operator">-</span><span class="token operator">></span>releaseFenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//设置Layer</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>DrmComposition<span class="token operator">></span> <span class="token function">composition</span><span class="token punctuation">(</span>
      ctx<span class="token operator">-</span><span class="token operator">></span>drm<span class="token punctuation">.</span><span class="token function">compositor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateComposition</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>importer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  ret <span class="token operator">=</span> composition<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetLayers</span><span class="token punctuation">(</span>layers_map<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layers_map<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  ret <span class="token operator">=</span> ctx<span class="token operator">-</span><span class="token operator">></span>drm<span class="token punctuation">.</span><span class="token function">compositor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">QueueComposition</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>composition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_displays<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    hwc_display_contents_1_t <span class="token operator">*</span>dc <span class="token operator">=</span> sf_display_contents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dc<span class="token punctuation">)</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>

    size_t num_dc_layers <span class="token operator">=</span> dc<span class="token operator">-</span><span class="token operator">></span>numHwLayers<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> num_dc_layers<span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      hwc_layer_1_t <span class="token operator">*</span>layer <span class="token operator">=</span> <span class="token operator">&amp;</span>dc<span class="token operator">-</span><span class="token operator">></span>hwLayers<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token function">hwc_add_layer_to_retire_fence</span><span class="token punctuation">(</span>layer<span class="token punctuation">,</span> dc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  composition<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们把目光放在fence的参与的逻辑。这这里面有一个核心的vector集合checked_output_fences。大致做了如下几件事情：</p>
<ul>
<li><p>1.设置retireFenceFd</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">  checked_output_fences<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dc<span class="token operator">-</span><span class="token operator">></span>retireFenceFd<span class="token punctuation">,</span>
                                     display_fence_description<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     ctx<span class="token operator">-</span><span class="token operator">></span>dummy_timeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
  display_contents<span class="token punctuation">.</span>retire_fence <span class="token operator">=</span> <span class="token function">OutputFd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dc<span class="token operator">-</span><span class="token operator">></span>retireFenceFd<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>2.把Hal层的acquireFenceFd 设置给drmlayer<pre class="line-numbers language-cpp"><code class="language-cpp">  layer<span class="token punctuation">.</span>acquire_fence<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>sf_layer<span class="token operator">-</span><span class="token operator">></span>acquireFenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
  sf_layer<span class="token operator">-</span><span class="token operator">></span>acquireFenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
</li>
<li><p>2.设置releaseFenceFd</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">checked_output_fences<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sf_layer<span class="token operator">-</span><span class="token operator">></span>releaseFenceFd<span class="token punctuation">,</span>
                                       layer_fence_description<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                       ctx<span class="token operator">-</span><span class="token operator">></span>dummy_timeline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    layer<span class="token punctuation">.</span>release_fence <span class="token operator">=</span> <span class="token function">OutputFd</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sf_layer<span class="token operator">-</span><span class="token operator">></span>releaseFenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><ol start="3">
<li>当QueueComposition 把图像渲染到屏幕后，将会把每一层的releaseFenceFd和retireFenceFd合并为一个fence，最后不用的退休的Fence。<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hwc_add_layer_to_retire_fence</span><span class="token punctuation">(</span>
hwc_layer_1_t <span class="token operator">*</span>layer<span class="token punctuation">,</span> hwc_display_contents_1_t <span class="token operator">*</span>display_contents<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token operator">-</span><span class="token operator">></span>releaseFenceFd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token keyword">return</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<p>if (display_contents-&gt;retireFenceFd &gt;= 0) {<br>  int old_retire_fence = display_contents-&gt;retireFenceFd;<br>  display_contents-&gt;retireFenceFd =</p>
<pre><code>  sync_merge("dc_retire", old_retire_fence, layer-&gt;releaseFenceFd);</code></pre><p>  close(old_retire_fence);<br>} else {<br>  display_contents-&gt;retireFenceFd = dup(layer-&gt;releaseFenceFd);<br>}<br>}</p>
<pre><code></code></pre></li>
</ul>
<h4 id="QueueWork的消费原理"><a href="#QueueWork的消费原理" class="headerlink" title="QueueWork的消费原理"></a>QueueWork的消费原理</h4><p>这里需要注意，在hrm_hwcomposer的处理模型中，每当进行hw_device_t初始化后会在hrm_hwcomposer后台初始化一个线程，接受每一个渲染到屏幕的任务，每当一个任务处理结束之后，将会唤醒队列进行下一个的渲染任务的消费。</p>
<p>消费的核心方法如下：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/external/" target="_blank" rel="noopener">external</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/" target="_blank" rel="noopener">drm_hwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/queue_worker.h" target="_blank" rel="noopener">queue_worker.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> T<span class="token operator">></span>
<span class="token keyword">int</span> QueueWorker<span class="token operator">&lt;</span>T<span class="token operator">></span><span class="token operator">::</span><span class="token function">QueueWork</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>T<span class="token operator">></span> workitem<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lk</span><span class="token punctuation">(</span>mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> wait_func <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> queue_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> max_queue_size_<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">WaitCond</span><span class="token punctuation">(</span>lk<span class="token punctuation">,</span> wait_func<span class="token punctuation">,</span> queue_timeout_ms_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

  queue_<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>workitem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  lk<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  cond_<span class="token punctuation">.</span><span class="token function">notify_one</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到每一个QueueWork进行入队都会进行阻塞，直到达到超时为止。这个时候将会等待上一个渲染任务结束之后，才会唤醒当前的线程。继续进行Commit方法提交到drm进行屏幕渲染。</p>
<p>当然，在提交之前还会做一次检测，看看本次渲染中，有没有OpenGL es等异步图元合成还没有完成。注意在hrm_hwcomposerr中，每一次提交都是通过drmcompositor控制不同屏幕的compositor(如主屏幕则是drmdisplaycompositor)通过drmcomposition(内含有对应不同屏幕的composition，如主屏幕对应drmdisplaycomposition)，进行提交。最后会调用如下方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/external/" target="_blank" rel="noopener">external</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/" target="_blank" rel="noopener">drm_hwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/drmdisplaycompositor.cpp" target="_blank" rel="noopener">drmdisplaycompositor.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>test_only <span class="token operator">&amp;&amp;</span> layer<span class="token punctuation">.</span>acquire_fence<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> acquire_fence <span class="token operator">=</span> layer<span class="token punctuation">.</span>acquire_fence<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> total_fence_timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kAcquireWaitTries<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">int</span> fence_timeout <span class="token operator">=</span> kAcquireWaitTimeoutMs <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
          total_fence_timeout <span class="token operator">+</span><span class="token operator">=</span> fence_timeout<span class="token punctuation">;</span>
          ret <span class="token operator">=</span> <span class="token function">sync_wait</span><span class="token punctuation">(</span>acquire_fence<span class="token punctuation">,</span> fence_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Acquire fence %d wait %d failed (%d). Total time %d"</span><span class="token punctuation">,</span>
                  acquire_fence<span class="token punctuation">,</span> i<span class="token punctuation">,</span> ret<span class="token punctuation">,</span> total_fence_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">else</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        layer<span class="token punctuation">.</span>acquire_fence<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layer<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">//drmModeAtomicAddProperty 设置提交的参数</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

out<span class="token operator">:</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    uint32_t flags <span class="token operator">=</span> DRM_MODE_ATOMIC_ALLOW_MODESET<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>test_only<span class="token punctuation">)</span>
      flags <span class="token operator">|</span><span class="token operator">=</span> DRM_MODE_ATOMIC_TEST_ONLY<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">drmModeAtomicCommit</span><span class="token punctuation">(</span>drm_<span class="token operator">-</span><span class="token operator">></span><span class="token function">fd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pset<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> drm_<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中会遍历每一个Layer中设置好的acquire_fence，进行等待。可以得知，实际上fence阻塞的核心方法是sync_wait。</p>
<p>回过头来，我们纵览全局。还记得Binder驱动中，所有的进程唤起Binder的执行操作都是从一个线程池中唤起，执行任务的。等到了SF进行GraphicBuffer queue入队之后，通过Handler归于SF的主线程中。</p>
<p>那么其实整个流程大致是如下的：<br><img src="/images/SF%E5%A4%9A%E5%BA%94%E7%94%A8%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B.png" alt="SF多应用消费模型.png"></p>
<p>既然渲染的方法是耗时的，那么必定存在需要同步的事件，不允许那些正在渲染到屏幕的GraphicBuffer遭到修改，导致屏幕渲染出现割裂等问题。这个时候就轮到fence登场了。</p>
<p>那么创建fence的方法在哪里呢？其实奥妙和<a href="https://www.jianshu.com/p/2f0ecf6ca08c" target="_blank" rel="noopener">智能指针</a>有着同工异曲的奥妙，我们看看checked_output_fences中每一个元素CheckedOutputFd。</p>
<h3 id="CheckedOutputFd-作用域"><a href="#CheckedOutputFd-作用域" class="headerlink" title="CheckedOutputFd 作用域"></a>CheckedOutputFd 作用域</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/external/" target="_blank" rel="noopener">external</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/" target="_blank" rel="noopener">drm_hwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/external/drm_hwcomposer/hwcomposer.cpp" target="_blank" rel="noopener">hwcomposer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> CheckedOutputFd <span class="token punctuation">{</span>
  <span class="token function">CheckedOutputFd</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span>fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>description<span class="token punctuation">,</span>
                  DummySwSyncTimeline <span class="token operator">&amp;</span>timeline<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">fd_</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">description_</span><span class="token punctuation">(</span>description<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timeline_</span><span class="token punctuation">(</span>timeline<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">}</span>
  <span class="token function">CheckedOutputFd</span><span class="token punctuation">(</span>CheckedOutputFd <span class="token operator">&amp;&amp;</span>rhs<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">description_</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>description_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">timeline_</span><span class="token punctuation">(</span>rhs<span class="token punctuation">.</span>timeline_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span><span class="token function">swap</span><span class="token punctuation">(</span>fd_<span class="token punctuation">,</span> rhs<span class="token punctuation">.</span>fd_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  CheckedOutputFd <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> CheckedOutputFd <span class="token operator">&amp;</span>rhs<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

  <span class="token operator">~</span><span class="token function">CheckedOutputFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd_ <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd_ <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>fd_ <span class="token operator">=</span> timeline_<span class="token punctuation">.</span><span class="token function">CreateDummyFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>fd_ <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Failed to fill %s (%p == %d) before destruction"</span><span class="token punctuation">,</span>
            description_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd_<span class="token punctuation">,</span> <span class="token operator">*</span>fd_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">int</span> <span class="token operator">*</span>fd_ <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>string description_<span class="token punctuation">;</span>
  DummySwSyncTimeline <span class="token operator">&amp;</span>timeline_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上十分简单，我们主要关注析构函数。在析构函数中,实际上就是调用CreateDummyFence创建一个fence。那么我们就要看CheckedOutputFd析构的时机了。</p>
<p>在上面的代码中，我们其实能看到CheckedOutputFd对应的集合checked_output_fences作用域是整个hwc_set函数。换句话说，当这个方法结束之后将会对CheckedOutputFd进行结构。</p>
<h4 id="DummySwSyncTimeline-CreateDummyFence-创建软件模拟fence"><a href="#DummySwSyncTimeline-CreateDummyFence-创建软件模拟fence" class="headerlink" title="DummySwSyncTimeline CreateDummyFence() 创建软件模拟fence"></a>DummySwSyncTimeline CreateDummyFence() 创建软件模拟fence</h4><pre class="line-numbers language-cpp"><code class="language-cpp">UniqueFd <span class="token function">CreateDummyFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">sw_sync_fence_create</span><span class="token punctuation">(</span>timeline_fd_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dummy fence"</span><span class="token punctuation">,</span>
                                   timeline_pt_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    UniqueFd <span class="token function">ret_fd</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">sw_sync_timeline_inc</span><span class="token punctuation">(</span>timeline_fd_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">++</span>timeline_pt_<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret_fd<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心只有两件事情：</p>
<ul>
<li>1.sw_sync_fence_create 创建一个软件模拟的fence</li>
<li>2.sw_sync_timeline_inc sync_timeline 时间轴向后推一个时间同步点。</li>
</ul>
<h4 id="sw-sync-fence-create-创建一个软件模拟的fence"><a href="#sw-sync-fence-create-创建一个软件模拟的fence" class="headerlink" title="sw_sync_fence_create 创建一个软件模拟的fence"></a>sw_sync_fence_create 创建一个软件模拟的fence</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">sw_sync_fence_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sw_sync_create_fence_data data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>

    data<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token function">strlcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SW_SYNC_IOC_CREATE_FENCE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>

    <span class="token keyword">return</span> data<span class="token punctuation">.</span>fence<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，SW_SYNC_IOC_CREATE_FENCE通过ioctl通信进行fence的创建。</p>
<h4 id="内核的fence创建"><a href="#内核的fence创建" class="headerlink" title="内核的fence创建"></a>内核的fence创建</h4><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">sw_sync_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span>
              <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> SW_SYNC_IOC_CREATE_FENCE<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">sw_sync_ioctl_create_fence</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> SW_SYNC_IOC_INC<span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">sw_sync_ioctl_inc</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOTTY<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">sw_sync_ioctl_create_fence</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">,</span>
                       <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span>O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sync_pt <span class="token operator">*</span>pt<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>sync_file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sw_sync_create_fence_data data<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pt <span class="token operator">=</span> <span class="token function">sync_pt_create</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pt<span class="token punctuation">)</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sync_file <span class="token operator">=</span> <span class="token function">sync_file_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fence_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>base<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync_file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    data<span class="token punctuation">.</span>fence <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_to_user</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fput</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> sync_file<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

err<span class="token operator">:</span>
    <span class="token function">put_unused_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.通过sync_pt_create 创建一个新的sync_point</li>
<li>2.sync_file_create 一个fence文件描述符。</li>
<li>3.fd_install 为fence文件描述绑定fd句柄。</li>
</ul>
<h4 id="sync-pt-create-创建一个新的sync-point"><a href="#sync-pt-create-创建一个新的sync-point" class="headerlink" title="sync_pt_create 创建一个新的sync_point"></a>sync_pt_create 创建一个新的sync_point</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> sync_pt <span class="token operator">*</span><span class="token function">sync_pt_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span>
                 <span class="token keyword">unsigned</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sync_pt <span class="token operator">*</span>pt<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>pt<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    pt <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pt<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sync_timeline_get</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fence_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>base<span class="token punctuation">,</span> <span class="token operator">&amp;</span>timeline_fence_ops<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_lock<span class="token punctuation">,</span>
           obj<span class="token operator">-</span><span class="token operator">></span>context<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>child_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>active_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> pt<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span>
<span class="token function">fence_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> fence_ops <span class="token operator">*</span>ops<span class="token punctuation">,</span>
         spinlock_t <span class="token operator">*</span>lock<span class="token punctuation">,</span> u64 context<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> seqno<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">BUG_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>ops <span class="token operator">||</span> <span class="token operator">!</span>ops<span class="token operator">-</span><span class="token operator">></span>wait <span class="token operator">||</span> <span class="token operator">!</span>ops<span class="token operator">-</span><span class="token operator">></span>enable_signaling <span class="token operator">||</span>
           <span class="token operator">!</span>ops<span class="token operator">-</span><span class="token operator">></span>get_driver_name <span class="token operator">||</span> <span class="token operator">!</span>ops<span class="token operator">-</span><span class="token operator">></span>get_timeline_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>refcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fence<span class="token operator">-</span><span class="token operator">></span>ops <span class="token operator">=</span> ops<span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>cb_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    fence<span class="token operator">-</span><span class="token operator">></span>lock <span class="token operator">=</span> lock<span class="token punctuation">;</span>
    fence<span class="token operator">-</span><span class="token operator">></span>context <span class="token operator">=</span> context<span class="token punctuation">;</span>
    fence<span class="token operator">-</span><span class="token operator">></span>seqno <span class="token operator">=</span> seqno<span class="token punctuation">;</span>
    fence<span class="token operator">-</span><span class="token operator">></span>flags <span class="token operator">=</span> <span class="token number">0UL</span><span class="token punctuation">;</span>

    <span class="token function">trace_fence_init</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会为sync_pt申请内存。为fence文件描述符进行赋值，添加fence_ops的操作结构体，初始化fence中的回调队列。最后把sync_pt添加到sync_timeline的child_list_head链表中。</p>
<p>稍微看看fence结构体对应都有哪些操作方法 timeline_fence_ops </p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> fence_ops timeline_fence_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>get_driver_name <span class="token operator">=</span> timeline_fence_get_driver_name<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_timeline_name <span class="token operator">=</span> timeline_fence_get_timeline_name<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>enable_signaling <span class="token operator">=</span> timeline_fence_enable_signaling<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>disable_signaling <span class="token operator">=</span> timeline_fence_disable_signaling<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>signaled <span class="token operator">=</span> timeline_fence_signaled<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>wait <span class="token operator">=</span> fence_default_wait<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> timeline_fence_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fence_value_str <span class="token operator">=</span> timeline_fence_value_str<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>timeline_value_str <span class="token operator">=</span> timeline_fence_timeline_value_str<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">sw_sync_fence_create</span><span class="token punctuation">(</span>timeline_fd_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"dummy fence"</span><span class="token punctuation">,</span>
                                   timeline_pt_ <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token operator">++</span>timeline_pt_<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>回顾当前设置的参数，最重要的是在fence记录了当前timeline_pt_+1,也就是fence预计唤醒的同步时间点。每一次创建都会往前推一个计数，作为新的fence的唤醒同步点。</p>
<h4 id="sync-file-create-创建fence的file结构体"><a href="#sync-file-create-创建fence的file结构体" class="headerlink" title="sync_file_create 创建fence的file结构体"></a>sync_file_create 创建fence的file结构体</h4><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sync_file.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sync_file.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">struct</span> sync_file <span class="token operator">*</span><span class="token function">sync_file_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>sync_file<span class="token punctuation">;</span>

    sync_file <span class="token operator">=</span> <span class="token function">sync_file_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync_file<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    sync_file<span class="token operator">-</span><span class="token operator">></span>fence <span class="token operator">=</span> <span class="token function">fence_get</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">snprintf</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s-%s%llu-%d"</span><span class="token punctuation">,</span>
         fence<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span><span class="token function">get_driver_name</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">,</span>
         fence<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span><span class="token function">get_timeline_name</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">,</span> fence<span class="token operator">-</span><span class="token operator">></span>context<span class="token punctuation">,</span>
         fence<span class="token operator">-</span><span class="token operator">></span>seqno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sync_file<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> sync_file <span class="token operator">*</span><span class="token function">sync_file_alloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>sync_file<span class="token punctuation">;</span>

    sync_file <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>sync_file<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync_file<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    sync_file<span class="token operator">-</span><span class="token operator">></span>file <span class="token operator">=</span> <span class="token function">anon_inode_getfile</span><span class="token punctuation">(</span><span class="token string">"sync_file"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sync_file_fops<span class="token punctuation">,</span>
                         sync_file<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

    <span class="token function">kref_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>kref<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>cb<span class="token punctuation">.</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> sync_file<span class="token punctuation">;</span>

err<span class="token operator">:</span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>sync_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上是申请了sync_file的内存，并且初始化等待队列。同时为文件描述符注入对应的file_operation sync_file_fops：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> file_operations sync_file_fops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> sync_file_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>poll <span class="token operator">=</span> sync_file_poll<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl <span class="token operator">=</span> sync_file_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>compat_ioctl <span class="token operator">=</span> sync_file_ioctl<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>那么我们可以得到一个关系，通过操作sync_file文件描述符的操作，进而进行fence结构体的操作。</p>
<h3 id="sw-sync-timeline-inc-sync-timeline-时间轴向后推一个时间同步点"><a href="#sw-sync-timeline-inc-sync-timeline-时间轴向后推一个时间同步点" class="headerlink" title="sw_sync_timeline_inc sync_timeline 时间轴向后推一个时间同步点"></a>sw_sync_timeline_inc sync_timeline 时间轴向后推一个时间同步点</h3><p>文件：<a href="http://androidxref.com/9.0.0_r3/xref/system/core/libsync/sync.c" target="_blank" rel="noopener">http://androidxref.com/9.0.0_r3/xref/system/core/libsync/sync.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">sw_sync_timeline_inc</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    __u32 arg <span class="token operator">=</span> count<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SW_SYNC_IOC_INC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>发送需要增加count传送到内核。</p>
<h4 id="sw-sync-ioctl-inc"><a href="#sw-sync-ioctl-inc" class="headerlink" title="sw_sync_ioctl_inc"></a>sw_sync_ioctl_inc</h4><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">sw_sync_ioctl_inc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u32 value<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> __user <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>

    <span class="token function">sync_timeline_signal</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后进行sync_timeline_signal方法尝试唤醒timeline中的同步点。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sync_timeline_signal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>obj<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> inc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sync_pt <span class="token operator">*</span>pt<span class="token punctuation">,</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>

    <span class="token function">trace_sync_timeline</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    obj<span class="token operator">-</span><span class="token operator">></span>value <span class="token operator">+</span><span class="token operator">=</span> inc<span class="token punctuation">;</span>

    <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>pt<span class="token punctuation">,</span> next<span class="token punctuation">,</span> <span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>active_list_head<span class="token punctuation">,</span>
                 active_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fence_is_signaled_locked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>base<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">list_del_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>active_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>obj<span class="token operator">-</span><span class="token operator">></span>child_list_lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，把sync_timeline中的记录时间点value的数值加1.紧接着开始遍历添加到active_list中的fence进行唤起。由于此时并没有添加到sync_timeline的active_list中，因此不会有任何操作。</p>
<p>如果发现有fence添加到active_list，将会调用fence_is_signaled_locked检测是否需要唤起这个fence，并且从active_list移除fence。</p>
<p>初始化说完了，并且每一次执行完渲染屏幕的操作就会唤起每一个保存在sync_timeline中active_list的fence。那么哪里进行阻塞呢？我们先把目光放到Fence中。我们能从之前几篇流程中可以的得出，实际上BufferSlot对应的BufferItem中的mFence对象就是Fence类，最后会在setUpHwcComposer中prepareFrame设置到Hal中。</p>
<h3 id="Fence-的介绍"><a href="#Fence-的介绍" class="headerlink" title="Fence 的介绍"></a>Fence 的介绍</h3><p>在Android Framework中有一个用于操作fence同步栅的类。这个类如果阅读前文，就已经是老朋友了。到处出现在SF的渲染合成逻辑。</p>
<p>我们先看部分核心逻辑。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/ui/Fence.cpp" target="_blank" rel="noopener">Fence.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> Fence<span class="token operator">::</span>NO_FENCE <span class="token operator">=</span> sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> Fence<span class="token punctuation">)</span><span class="token punctuation">;</span>

Fence<span class="token operator">::</span><span class="token function">Fence</span><span class="token punctuation">(</span><span class="token keyword">int</span> fenceFd<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">mFenceFd</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

Fence<span class="token operator">::</span><span class="token function">Fence</span><span class="token punctuation">(</span>base<span class="token operator">::</span>unique_fd fenceFd<span class="token punctuation">)</span> <span class="token operator">:</span>
    <span class="token function">mFenceFd</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

status_t Fence<span class="token operator">::</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFenceFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">sync_wait</span><span class="token punctuation">(</span>mFenceFd<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span>errno <span class="token operator">:</span> <span class="token function">status_t</span><span class="token punctuation">(</span>NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

status_t Fence<span class="token operator">::</span><span class="token function">waitForever</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> logname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFenceFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> warningTimeout <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">sync_wait</span><span class="token punctuation">(</span>mFenceFd<span class="token punctuation">,</span> warningTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> ETIME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">sync_wait</span><span class="token punctuation">(</span>mFenceFd<span class="token punctuation">,</span> TIMEOUT_NEVER<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token operator">-</span>errno <span class="token operator">:</span> <span class="token function">status_t</span><span class="token punctuation">(</span>NO_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Fence::NO_FENCE 我们在SF的dequeue初始化流程都能看到，实际上就是一个持有非法的fence的fd，不做任何事情。这里的fd其实就对应在hwc中申请的sync_file对应的文件句柄。</p>
<p>当我们需要进行阻塞时候，将会调用waitForever或者wait进行阻塞。wait方法需要你显示的设置超时参数。waitForever则会先设置一个3秒超时机制，如果返回err&lt;0，则直接进行永久阻塞。</p>
<p>我们需要研究最核心的libsync中sync_wait的机制。</p>
<h3 id="sync-wait-fence阻塞原理"><a href="#sync-wait-fence阻塞原理" class="headerlink" title="sync_wait fence阻塞原理"></a>sync_wait fence阻塞原理</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">sync_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> pollfd fds<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fds<span class="token punctuation">.</span>fd <span class="token operator">=</span> fd<span class="token punctuation">;</span>
    fds<span class="token punctuation">.</span>events <span class="token operator">=</span> POLLIN<span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fds<span class="token punctuation">.</span>revents <span class="token operator">&amp;</span> <span class="token punctuation">(</span>POLLERR <span class="token operator">|</span> POLLNVAL<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                errno <span class="token operator">=</span> EINVAL<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            errno <span class="token operator">=</span> ETIME<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>errno <span class="token operator">==</span> EINTR <span class="token operator">||</span> errno <span class="token operator">==</span> EAGAIN<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上fence使用的是poll系统调用阻塞整个线程。当然关于poll的源码我还没有解析，但是可以去看看我写的<a href="https://www.jianshu.com/p/d38b2970ff3f" target="_blank" rel="noopener">epoll系统调用</a>有进行epoll和poll的比较和解析。</p>
<p>既然是对应上poll的系统调用，就会对应上file_operation 结构体中的poll方法指针。也就是对应sync_file_fops中的poll方法sync_file_poll</p>
<h4 id="内核中fence阻塞原理"><a href="#内核中fence阻塞原理" class="headerlink" title="内核中fence阻塞原理"></a>内核中fence阻塞原理</h4><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sync_file.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sync_file.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">sync_file_poll</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">,</span> poll_table <span class="token operator">*</span>wait<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>sync_file <span class="token operator">=</span> file<span class="token operator">-</span><span class="token operator">></span>private_data<span class="token punctuation">;</span>

    <span class="token function">poll_wait</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>wq<span class="token punctuation">,</span> wait<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">test_and_set_bit</span><span class="token punctuation">(</span>POLL_ENABLED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>fence<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fence_add_callback</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>fence<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>cb<span class="token punctuation">,</span>
                       fence_check_cb_func<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token function">wake_up_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_file<span class="token operator">-</span><span class="token operator">></span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token function">fence_is_signaled</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>fence<span class="token punctuation">)</span> <span class="token operator">?</span> POLLIN <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到epoll中熟悉的身影，poll_wait方法。不过这里设计和epoll不一样。因为epoll自己调用了注册在监听中的文件描述的poll方法，所以就能够自己设置poll_table的回调函数，我们来看看poll系统调用中poll_table的初始化：<br>文件：/<a href="http://androidxref.com/kernel_3.18/xref/fs/" target="_blank" rel="noopener">fs</a>/<a href="http://androidxref.com/kernel_3.18/xref/fs/select.c" target="_blank" rel="noopener">select.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">poll_initwait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> poll_wqueues <span class="token operator">*</span>pwq<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">init_poll_funcptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pwq<span class="token operator">-</span><span class="token operator">></span>pt<span class="token punctuation">,</span> __pollwait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pwq<span class="token operator">-</span><span class="token operator">></span>polling_task <span class="token operator">=</span> current<span class="token punctuation">;</span>
    pwq<span class="token operator">-</span><span class="token operator">></span>triggered <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pwq<span class="token operator">-</span><span class="token operator">></span>error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    pwq<span class="token operator">-</span><span class="token operator">></span>table <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    pwq<span class="token operator">-</span><span class="token operator">></span>inline_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>init_poll_funcptr这个方法就是epoll中,如果注册到epoll的监听并调用了poll_wait会调用的关键的回调函数。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__pollwait</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file <span class="token operator">*</span>filp<span class="token punctuation">,</span> wait_queue_head_t <span class="token operator">*</span>wait_address<span class="token punctuation">,</span>
                poll_table <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> poll_wqueues <span class="token operator">*</span>pwq <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">struct</span> poll_wqueues<span class="token punctuation">,</span> pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> poll_table_entry <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token function">poll_get_entry</span><span class="token punctuation">(</span>pwq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>entry<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    entry<span class="token operator">-</span><span class="token operator">></span>filp <span class="token operator">=</span> <span class="token function">get_file</span><span class="token punctuation">(</span>filp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    entry<span class="token operator">-</span><span class="token operator">></span>wait_address <span class="token operator">=</span> wait_address<span class="token punctuation">;</span>
    entry<span class="token operator">-</span><span class="token operator">></span>key <span class="token operator">=</span> p<span class="token operator">-</span><span class="token operator">></span>_key<span class="token punctuation">;</span>
    <span class="token function">init_waitqueue_func_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>entry<span class="token operator">-</span><span class="token operator">></span>wait<span class="token punctuation">,</span> pollwake<span class="token punctuation">)</span><span class="token punctuation">;</span>
    entry<span class="token operator">-</span><span class="token operator">></span>wait<span class="token punctuation">.</span><span class="token keyword">private</span> <span class="token operator">=</span> pwq<span class="token punctuation">;</span>
    <span class="token function">add_wait_queue</span><span class="token punctuation">(</span>wait_address<span class="token punctuation">,</span> <span class="token operator">&amp;</span>entry<span class="token operator">-</span><span class="token operator">></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在系统调用中，将会通过add_wait_queue添加到poll中的等待队列。当注册到poll系统调用的sync_file执行完poll_wait后，将会进入到poll的循环中，直到fence有信号唤醒对其中的等待队列。</p>
<p>我们回到sync_file_poll方法中，当把等待队列注册到poll后，将会检测是否打开了POLL_ENABLE的标志位，一般是打开的，此时就会进入到fence_add_callback，为fence注册监听，添加到sync_timeline活跃链表中，如果注册成功会先调用wake_up_all唤起所有的fence，最后进行fence_is_signaled,校验是否有需要进行唤醒的fence。</p>
<h5 id="fence-add-callback-fence注册唤醒回调"><a href="#fence-add-callback-fence注册唤醒回调" class="headerlink" title="fence_add_callback fence注册唤醒回调"></a>fence_add_callback fence注册唤醒回调</h5><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/fence.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/fence.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">fence_add_callback</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">,</span> <span class="token keyword">struct</span> fence_cb <span class="token operator">*</span>cb<span class="token punctuation">,</span>
               fence_func_t func<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> was_set<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WARN_ON</span><span class="token punctuation">(</span><span class="token operator">!</span>fence <span class="token operator">||</span> <span class="token operator">!</span>func<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>FENCE_FLAG_SIGNALED_BIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cb<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span>fence<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    was_set <span class="token operator">=</span> <span class="token function">test_and_set_bit</span><span class="token punctuation">(</span>FENCE_FLAG_ENABLE_SIGNAL_BIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>FENCE_FLAG_SIGNALED_BIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>was_set<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">trace_fence_enable_signal</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fence<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span><span class="token function">enable_signaling</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">fence_signal_locked</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>ENOENT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        cb<span class="token operator">-</span><span class="token operator">></span>func <span class="token operator">=</span> func<span class="token punctuation">;</span>
        <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cb<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>cb_list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cb<span class="token operator">-</span><span class="token operator">></span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span>fence<span class="token operator">-</span><span class="token operator">></span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到，实际上fence结构体中有flag标志在控制整个流程。</p>
<ul>
<li>1.如果flags是FENCE_FLAG_SIGNALED_BIT，则说明fence已经唤醒，没必要继续下去。</li>
<li>2.如果FENCE_FLAG_SIGNALED_BIT，如果是从不允许唤醒到运行唤醒，则进行fence enable_signaling操作的校验，校验失败说明添加active_list失败；并调用fence_signal_locked进行唤醒。</li>
<li>3.最后为fence添加一个调用fence_signal_locked后回调方法指针，fence_check_cb_func。</li>
</ul>
<h5 id="fence-enable-signaling"><a href="#fence-enable-signaling" class="headerlink" title="fence enable_signaling"></a>fence enable_signaling</h5><p>fence中enable_signaling的操作指针就是上面方法结构体的timeline_fence_enable_signaling。<br>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sw_sync.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">timeline_fence_enable_signaling</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_pt <span class="token operator">*</span>pt <span class="token operator">=</span> <span class="token function">fence_to_sync_pt</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token function">fence_parent</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">timeline_fence_signaled</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pt<span class="token operator">-</span><span class="token operator">></span>active_list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parent<span class="token operator">-</span><span class="token operator">></span>active_list_head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">timeline_fence_signaled</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_timeline <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token function">fence_parent</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>fence<span class="token operator">-</span><span class="token operator">></span>seqno <span class="token operator">></span> parent<span class="token operator">-</span><span class="token operator">></span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">false</span> <span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时做了一件事情，判断sync_timeline此时的同步时间点和fence预计唤醒的同步时间点进行比较，发现fence的同步时间点大于sync_timeline当前同步时间点，不做任何事情，直接在添加回调步骤fence_signal_locked进行唤醒。否则说明还没到fence需要唤醒的时间点，就会把fence对应的sync_pt添加到sync_timeline的active_list。</p>
<h3 id="fence的唤醒机制"><a href="#fence的唤醒机制" class="headerlink" title="fence的唤醒机制"></a>fence的唤醒机制</h3><p>经过上述的阻塞原理理解后，我们在对fence唤醒原理进行解析。在本文中，通过sync_wait进行阻塞后，唤醒的时机暂时只看到了三个：</p>
<ul>
<li>1.当hwc执行完渲染屏幕操作之前</li>
<li>2.当hwc执行完渲染屏幕操作之后。</li>
<li>3.添加到sync_wait进行阻塞，也会首先进行校验，可能会进行唤醒。</li>
</ul>
<p>先来看当fence需要唤醒时候，fence_is_signaled 唤醒校验机制</p>
<h4 id="fence-is-signaled"><a href="#fence-is-signaled" class="headerlink" title="fence_is_signaled"></a>fence_is_signaled</h4><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/include/linux/fence.h">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/include/linux/fence.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">bool</span>
<span class="token function">fence_is_signaled</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>FENCE_FLAG_SIGNALED_BIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-</span><span class="token operator">></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fence<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span>signaled <span class="token operator">&amp;&amp;</span> fence<span class="token operator">-</span><span class="token operator">></span>ops<span class="token operator">-</span><span class="token operator">></span><span class="token function">signaled</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fence_signal</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.校验的时候，判断到FENCE_FLAG_SIGNALED_BIT标志位，就直接返回true。</li>
<li>2.否则就调用fence的signaled进行判断，调用fence_signal，唤醒fence，能唤醒就返回true，唤醒失败则会返回false。</li>
</ul>
<p>最后都会汇总到fence_signal中进行唤醒。timeline_fence_signaled则是比较记录在fence中的预计时间点和当前的sync_timeline时间点</p>
<h4 id="fence-signal-唤醒fence"><a href="#fence-signal-唤醒fence" class="headerlink" title="fence_signal 唤醒fence"></a>fence_signal 唤醒fence</h4><p>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/fence.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/fence.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fence_signal</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>fence<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fence<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ktime_to_ns</span><span class="token punctuation">(</span>fence<span class="token operator">-></span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fence<span class="token operator">-></span>timestamp <span class="token operator">=</span> <span class="token function">ktime_get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">smp_mb__before_atomic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_and_set_bit</span><span class="token punctuation">(</span>FENCE_FLAG_SIGNALED_BIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token function">trace_fence_signaled</span><span class="token punctuation">(</span>fence<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">test_bit</span><span class="token punctuation">(</span>FENCE_FLAG_ENABLE_SIGNAL_BIT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-></span>flags<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> fence_cb <span class="token operator">*</span>cur<span class="token punctuation">,</span> <span class="token operator">*</span>tmp<span class="token punctuation">;</span>

        <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span>fence<span class="token operator">-></span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">list_for_each_entry_safe</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fence<span class="token operator">-></span>cb_list<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">list_del_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cur<span class="token operator">-></span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cur<span class="token operator">-></span><span class="token function">func</span><span class="token punctuation">(</span>fence<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span>fence<span class="token operator">-></span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上很简单，就是调用fence中注册在回调队列的回调函数fence_check_cb_func。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fence_check_cb_func</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fence <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">struct</span> fence_cb <span class="token operator">*</span>cb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>sync_file<span class="token punctuation">;</span>

    sync_file <span class="token operator">=</span> <span class="token function">container_of</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> <span class="token keyword">struct</span> sync_file<span class="token punctuation">,</span> cb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">wake_up_all</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sync_file<span class="token operator">-></span>wq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后调用wake_up_all唤醒fence对应的等待队列。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>用一幅图总结整个fence在内核中的设计：<br><img src="/images/fence%E6%97%B6%E9%97%B4%E8%BD%B4%E8%AE%BE%E8%AE%A1.png" alt="fence时间轴设计.png"></p>
<p>至此fence的阻塞唤醒原理已经明白了。但是仅仅如此，我们只需要一个fence就好，只需要等待在屏幕渲染之前，以及屏幕渲染之后即可，无论有多少线程来了，我们都可以进行poll的阻塞，等到drm渲染屏幕结束。这样能够处理解耦合，为什么需要嵌入到SF的图元合成渲染流程中呢？</p>
<p>实际上这里面还因为有Client的绘制类型，也就是OpenGL es的绘制。因为OpenGL es实际上是以一条条命令输送给GPU进行计算，是一个异步的过程；除非使用glFlush把命令一口气推给GPU完成，但是会造成阻塞，使得CPU利用率低。</p>
<p>因此，fence还会对OpenGL es的绘制在在关键的步骤进行等待，防止后面出现异常。</p>
<p>首先来看看OpenGL es是如何接洽fence的。我们看看SF中管理OpenGL es操作的RenderEngine类。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> RenderEngine<span class="token operator">::</span><span class="token function">waitFence</span><span class="token punctuation">(</span>base<span class="token operator">::</span>unique_fd fenceFd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>GLExtensions<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasNativeFenceSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token operator">!</span>GLExtensions<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasWaitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    EGLint attribs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>EGL_SYNC_NATIVE_FENCE_FD_ANDROID<span class="token punctuation">,</span> fenceFd<span class="token punctuation">,</span> EGL_NONE<span class="token punctuation">}</span><span class="token punctuation">;</span>
    EGLSyncKHR sync <span class="token operator">=</span> <span class="token function">eglCreateSyncKHR</span><span class="token punctuation">(</span>mEGLDisplay<span class="token punctuation">,</span> EGL_SYNC_NATIVE_FENCE_ANDROID<span class="token punctuation">,</span> attribs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sync <span class="token operator">==</span> EGL_NO_SYNC_KHR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// fenceFd is now owned by EGLSync</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>fenceFd<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">eglWaitSyncKHR</span><span class="token punctuation">(</span>mEGLDisplay<span class="token punctuation">,</span> sync<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    EGLint error <span class="token operator">=</span> <span class="token function">eglGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">eglDestroySyncKHR</span><span class="token punctuation">(</span>mEGLDisplay<span class="token punctuation">,</span> sync<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> EGL_SUCCESS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>大致操作如下三个操作：</p>
<ul>
<li>1.eglCreateSyncKHR 传入sync_file的句柄在OpenGL es中创建sync。</li>
<li>2.eglWaitSyncKHR 进行fence的等待。</li>
<li>3.eglDestroySyncKHR 销毁OpenGL es中的fence对象。</li>
</ul>
<p>老规矩，我们虽然没有各大厂商的源码，但是可以看软件模拟的OpenGL es的机制来一窥究竟。由于libaegl的sync是直接同步的，就算是如其他如模拟器的我们看不到更近一步实现。</p>
<p>不过倒是可以从入口推导一二，在OpenGL es中eglCreateSyncKHR方法实际上是在OpenGL es中创建一个对应的fence的同步栅对象，eglWaitSyncKHR通过管道发送到OpenGL es中进行阻塞等待，直到OpenGL es的操作完成后，将会解开阻塞执行eglDestroySyncKHR方法释放OpenGL es中对应fence的同步栅对象。</p>
<h2 id="Fence-在SF图元合成中状态的流转"><a href="#Fence-在SF图元合成中状态的流转" class="headerlink" title="Fence 在SF图元合成中状态的流转"></a>Fence 在SF图元合成中状态的流转</h2><p>明白了fence的基本原理，我们可以进一步的探索整个SF的中fence在其中处于什么角色。</p>
<p>首先，我们必须清楚一点。从启动到屏幕的第一帧的渲染，fence是不会有任何效果的。因为此时fence还没有经过hwc_set给fence进行赋值。但是到了第二帧开始，已经存在的Layer已经经过了hwc_set的赋值，存在Layer的releaseFence中。</p>
<p>我们来看看在SF中核心的4个流程：</p>
<ul>
<li><ol>
<li>dequeueBuffer GraphicBuffer的出队</li>
</ol>
</li>
<li><ol start="2">
<li>queueBuffer GraphicBuffer的入队</li>
</ol>
</li>
<li><ol start="3">
<li>updateTexImage GraphicBuffer 消费</li>
</ol>
</li>
<li><ol start="4">
<li>GraphicBuffer的释放</li>
</ol>
</li>
</ul>
<h3 id="Fence-在-dequeueBuffer-参与的角色"><a href="#Fence-在-dequeueBuffer-参与的角色" class="headerlink" title="Fence 在 dequeueBuffer 参与的角色"></a>Fence 在 dequeueBuffer 参与的角色</h3><p>我们先来看看Surface中的lock方法，这个方法是onDraw方法之前，ViewRootImpl绘制之前进行调用。这个方法会调用IGraphicBufferProducer的dequeue方法。</p>
<p>我们只关注其核心的方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/Surface.cpp" target="_blank" rel="noopener">Surface.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t Surface<span class="token operator">::</span><span class="token function">lock</span><span class="token punctuation">(</span>
        ANativeWindow_Buffer<span class="token operator">*</span> outBuffer<span class="token punctuation">,</span> ARect<span class="token operator">*</span> inOutDirtyBounds<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    ANativeWindowBuffer<span class="token operator">*</span> out<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> <span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>out<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">void</span><span class="token operator">*</span> vaddr<span class="token punctuation">;</span>
        status_t res <span class="token operator">=</span> backBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">lockAsync</span><span class="token punctuation">(</span>
                GRALLOC_USAGE_SW_READ_OFTEN <span class="token operator">|</span> GRALLOC_USAGE_SW_WRITE_OFTEN<span class="token punctuation">,</span>
                newDirtyRegion<span class="token punctuation">.</span><span class="token function">bounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>vaddr<span class="token punctuation">,</span> fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>res <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            err <span class="token operator">=</span> INVALID_OPERATION<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mLockedBuffer <span class="token operator">=</span> backBuffer<span class="token punctuation">;</span>
            outBuffer<span class="token operator">-</span><span class="token operator">></span>width  <span class="token operator">=</span> backBuffer<span class="token operator">-</span><span class="token operator">></span>width<span class="token punctuation">;</span>
            outBuffer<span class="token operator">-</span><span class="token operator">></span>height <span class="token operator">=</span> backBuffer<span class="token operator">-</span><span class="token operator">></span>height<span class="token punctuation">;</span>
            outBuffer<span class="token operator">-</span><span class="token operator">></span>stride <span class="token operator">=</span> backBuffer<span class="token operator">-</span><span class="token operator">></span>stride<span class="token punctuation">;</span>
            outBuffer<span class="token operator">-</span><span class="token operator">></span>format <span class="token operator">=</span> backBuffer<span class="token operator">-</span><span class="token operator">></span>format<span class="token punctuation">;</span>
            outBuffer<span class="token operator">-</span><span class="token operator">></span>bits   <span class="token operator">=</span> vaddr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>fence参与的步骤有2个：</p>
<ul>
<li>1.BufferQueueProducer  的dequeueBuffer</li>
<li><ol start="2">
<li>GraphicBufferMapper的lockAsync 进行本进程对ion同一段page进行映射的时候，也会进行fence的等待。</li>
</ol>
</li>
</ul>
<h4 id="BufferQueueProducer-dequeueBuffer"><a href="#BufferQueueProducer-dequeueBuffer" class="headerlink" title="BufferQueueProducer dequeueBuffer"></a>BufferQueueProducer dequeueBuffer</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/BufferQueueProducer.cpp" target="_blank" rel="noopener">BufferQueueProducer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">dequeueBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> outSlot<span class="token punctuation">,</span> sp<span class="token operator">&lt;</span>android<span class="token operator">::</span>Fence<span class="token operator">></span><span class="token operator">*</span> outFence<span class="token punctuation">,</span>
                                            uint32_t width<span class="token punctuation">,</span> uint32_t height<span class="token punctuation">,</span> PixelFormat format<span class="token punctuation">,</span>
                                            uint64_t usage<span class="token punctuation">,</span> uint64_t<span class="token operator">*</span> outBufferAge<span class="token punctuation">,</span>
                                            FrameEventHistoryDelta<span class="token operator">*</span> outTimestamps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mConsumerName <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerName<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        eglDisplay <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglDisplay<span class="token punctuation">;</span>
        eglFence <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglFence<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Don't return a fence in shared buffer mode, except for the first</span>
        <span class="token comment" spellcheck="true">// frame.</span>
        <span class="token operator">*</span>outFence <span class="token operator">=</span> <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span> found<span class="token punctuation">)</span> <span class="token operator">?</span>
                Fence<span class="token operator">::</span>NO_FENCE <span class="token operator">:</span> mSlots<span class="token punctuation">[</span>found<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>eglFence <span class="token operator">!=</span> EGL_NO_SYNC_KHR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        EGLint result <span class="token operator">=</span> <span class="token function">eglClientWaitSyncKHR</span><span class="token punctuation">(</span>eglDisplay<span class="token punctuation">,</span> eglFence<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token number">1000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// If something goes wrong, log the error, but return the buffer without</span>
        <span class="token comment" spellcheck="true">// synchronizing access to it. It's too late at this point to abort the</span>
        <span class="token comment" spellcheck="true">// dequeue operation.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> EGL_FALSE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGE</span><span class="token punctuation">(</span><span class="token string">"dequeueBuffer: error %#x waiting for fence"</span><span class="token punctuation">,</span>
                    <span class="token function">eglGetError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> EGL_TIMEOUT_EXPIRED_KHR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGE</span><span class="token punctuation">(</span><span class="token string">"dequeueBuffer: timeout waiting for fence"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">eglDestroySyncKHR</span><span class="token punctuation">(</span>eglDisplay<span class="token punctuation">,</span> eglFence<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> returnFlags<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在dequeue这个进行的时候，会判断OpenGL es对应的eglFence是否有效，有效，则说明上一帧的OpenGL es中有部分工作还没有完成，就进行eglClientWaitSyncKHRfence的等待，直到OpenGL es中的唤醒，最后销毁。</p>
<h4 id="GraphicBufferMapper的lockAsync"><a href="#GraphicBufferMapper的lockAsync" class="headerlink" title="GraphicBufferMapper的lockAsync"></a>GraphicBufferMapper的lockAsync</h4><p>这个方法实际上是对GraphicBuffer句柄对应在ion驱动中page页进行一次映射。<br>我们直接看对应Hal层源码：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/" target="_blank" rel="noopener">interfaces</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/" target="_blank" rel="noopener">graphics</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/" target="_blank" rel="noopener">mapper</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/" target="_blank" rel="noopener">utils</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/" target="_blank" rel="noopener">passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/" target="_blank" rel="noopener">mapper-passthrough</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/2.0/" target="_blank" rel="noopener">2.0</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/interfaces/graphics/mapper/2.0/utils/passthrough/include/mapper-passthrough/2.0/Gralloc0Hal.h" target="_blank" rel="noopener">Gralloc0Hal.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">lock</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> bufferHandle<span class="token punctuation">,</span> uint64_t cpuUsage<span class="token punctuation">,</span>
               <span class="token keyword">const</span> IMapper<span class="token operator">::</span>Rect<span class="token operator">&amp;</span> accessRegion<span class="token punctuation">,</span> base<span class="token operator">::</span>unique_fd fenceFd<span class="token punctuation">,</span>
               <span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">*</span> outData<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result<span class="token punctuation">;</span>
        <span class="token keyword">void</span><span class="token operator">*</span> data <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mMinor <span class="token operator">>=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> mModule<span class="token operator">-</span><span class="token operator">></span>lockAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> mModule<span class="token operator">-</span><span class="token operator">></span><span class="token function">lockAsync</span><span class="token punctuation">(</span>mModule<span class="token punctuation">,</span> bufferHandle<span class="token punctuation">,</span> cpuUsage<span class="token punctuation">,</span> accessRegion<span class="token punctuation">.</span>left<span class="token punctuation">,</span>
                                        accessRegion<span class="token punctuation">.</span>top<span class="token punctuation">,</span> accessRegion<span class="token punctuation">.</span>width<span class="token punctuation">,</span> accessRegion<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
                                        <span class="token operator">&amp;</span>data<span class="token punctuation">,</span> fenceFd<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">waitFenceFd</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">,</span> <span class="token string">"Gralloc0Hal::lock"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            result <span class="token operator">=</span>
                mModule<span class="token operator">-</span><span class="token operator">></span><span class="token function">lock</span><span class="token punctuation">(</span>mModule<span class="token punctuation">,</span> bufferHandle<span class="token punctuation">,</span> cpuUsage<span class="token punctuation">,</span> accessRegion<span class="token punctuation">.</span>left<span class="token punctuation">,</span> accessRegion<span class="token punctuation">.</span>top<span class="token punctuation">,</span>
                              accessRegion<span class="token punctuation">.</span>width<span class="token punctuation">,</span> accessRegion<span class="token punctuation">.</span>height<span class="token punctuation">,</span> <span class="token operator">&amp;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> Error<span class="token operator">::</span>BAD_VALUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">*</span>outData <span class="token operator">=</span> data<span class="token punctuation">;</span>
        <span class="token keyword">return</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">waitFenceFd</span><span class="token punctuation">(</span><span class="token keyword">const</span> base<span class="token operator">::</span>unique_fd<span class="token operator">&amp;</span> fenceFd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> logname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fenceFd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> <span class="token keyword">int</span> warningTimeout <span class="token operator">=</span> <span class="token number">3500</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token function">sync_wait</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">,</span> warningTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> ETIME<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sync_wait</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们能看到这里分为高低两个版本，低版本只支持同步的处理，因此首先判断fenceFd大于等于说明fd有效，就存在对应的sync_file结构体。此时会进行sync_file的等待，直到上一帧处理完，fence才会被唤醒，允许Surface对ion内存进行映射修改。</p>
<p>而高版本支持异步处理，则不需要进行等待</p>
<p>记住dequeueBuffer步骤中，此时是上一帧正在绘制，赋值在Layer中的releaseFence中。也就是Fence处于release状态。</p>
<h3 id="Fence-在queueBuffer中参与的角色"><a href="#Fence-在queueBuffer中参与的角色" class="headerlink" title="Fence 在queueBuffer中参与的角色"></a>Fence 在queueBuffer中参与的角色</h3><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/Surface.cpp" target="_blank" rel="noopener">Surface.cpp</a></p>
<p>当映射好，通过了onDraw对Canvas绘制后，将会调用unlockAndPost发送。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t Surface<span class="token operator">::</span><span class="token function">unlockAndPost</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mLockedBuffer <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> INVALID_OPERATION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    status_t err <span class="token operator">=</span> mLockedBuffer<span class="token operator">-</span><span class="token operator">></span><span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token function">queueBuffer</span><span class="token punctuation">(</span>mLockedBuffer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mPostedBuffer <span class="token operator">=</span> mLockedBuffer<span class="token punctuation">;</span>
    mLockedBuffer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里分为两个步骤：</p>
<ul>
<li>1.unlockAsync GraphicBufferMapper如果是高版本则解开fence的同步，接着会调用对应gralloc的unlock方法，解开当前进程对应ion内存的映射，释放虚拟内存。</li>
<li>2.queueBuffer SF的queueBuffer，进入mQueueItem中准备被消费</li>
</ul>
<h5 id="GraphicBufferMapper-unlock"><a href="#GraphicBufferMapper-unlock" class="headerlink" title="GraphicBufferMapper unlock"></a>GraphicBufferMapper unlock</h5><pre class="line-numbers language-cpp"><code class="language-cpp">    Error <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token keyword">const</span> native_handle_t<span class="token operator">*</span> bufferHandle<span class="token punctuation">,</span> base<span class="token operator">::</span>unique_fd<span class="token operator">*</span> outFenceFd<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        <span class="token keyword">int</span> result<span class="token punctuation">;</span>
        <span class="token keyword">int</span> fenceFd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mMinor <span class="token operator">>=</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> mModule<span class="token operator">-</span><span class="token operator">></span>unlockAsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> mModule<span class="token operator">-</span><span class="token operator">></span><span class="token function">unlockAsync</span><span class="token punctuation">(</span>mModule<span class="token punctuation">,</span> bufferHandle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            result <span class="token operator">=</span> mModule<span class="token operator">-</span><span class="token operator">></span><span class="token function">unlock</span><span class="token punctuation">(</span>mModule<span class="token punctuation">,</span> bufferHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        outFenceFd<span class="token operator">-</span><span class="token operator">></span><span class="token function">reset</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result <span class="token operator">?</span> Error<span class="token operator">::</span>BAD_VALUE <span class="token operator">:</span> Error<span class="token operator">::</span>NONE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程中，如果对应的高版本gralloc模块支持异步处理，则会在unlock进行fence的等待唤醒，否则直接解开映射。</p>
<p>这个过程实际上是把整个过程推后到queueBuffer发送之前。</p>
<h4 id="BufferQueueProducer-queueBuffer"><a href="#BufferQueueProducer-queueBuffer" class="headerlink" title="BufferQueueProducer queueBuffer"></a>BufferQueueProducer queueBuffer</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/BufferQueueProducer.cpp" target="_blank" rel="noopener">BufferQueueProducer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueProducer<span class="token operator">::</span><span class="token function">queueBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> slot<span class="token punctuation">,</span>
        <span class="token keyword">const</span> QueueBufferInput <span class="token operator">&amp;</span>input<span class="token punctuation">,</span> QueueBufferOutput <span class="token operator">*</span>output<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    int64_t requestedPresentTimestamp<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> isAutoTimestamp<span class="token punctuation">;</span>
    android_dataspace dataSpace<span class="token punctuation">;</span>
    Rect <span class="token function">crop</span><span class="token punctuation">(</span>Rect<span class="token operator">::</span>EMPTY_RECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> scalingMode<span class="token punctuation">;</span>
    uint32_t transform<span class="token punctuation">;</span>
    uint32_t stickyTransform<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> acquireFence<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> getFrameTimestamps <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        item<span class="token punctuation">.</span>mFrameNumber <span class="token operator">=</span> currentFrameNumber<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mSlot <span class="token operator">=</span> slot<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mFence <span class="token operator">=</span> acquireFence<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mFenceTime <span class="token operator">=</span> acquireFenceTime<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mIsDroppable <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mAsyncMode <span class="token operator">||</span>
                mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueBufferCannotBlock <span class="token operator">||</span>
                <span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferSlot <span class="token operator">==</span> slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mSurfaceDamage <span class="token operator">=</span> surfaceDamage<span class="token punctuation">;</span>
        item<span class="token punctuation">.</span>mQueuedBuffer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">VALIDATE_CONSISTENCY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">int</span> connectedApi<span class="token punctuation">;</span>
    sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> lastQueuedFence<span class="token punctuation">;</span>

    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// scope for the lock</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        lastQueuedFence <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>mLastQueueBufferFence<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mLastQueueBufferFence <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>acquireFence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mLastQueuedCrop <span class="token operator">=</span> item<span class="token punctuation">.</span>mCrop<span class="token punctuation">;</span>
        mLastQueuedTransform <span class="token operator">=</span> item<span class="token punctuation">.</span>mTransform<span class="token punctuation">;</span>

        <span class="token operator">++</span>mCurrentCallbackTicket<span class="token punctuation">;</span>
        mCallbackCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Wait without lock held</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectedApi <span class="token operator">==</span> NATIVE_WINDOW_API_EGL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Waiting here allows for two full buffers to be queued but not a</span>
        <span class="token comment" spellcheck="true">// third. In the event that frames take varying time, this makes a</span>
        <span class="token comment" spellcheck="true">// small trade-off in favor of latency rather than throughput.</span>
        lastQueuedFence<span class="token operator">-</span><span class="token operator">></span><span class="token function">waitForever</span><span class="token punctuation">(</span><span class="token string">"Throttling EGL Production"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程，我们能够注意到，此时fence的名字已经改成了acquireFence。此时就代表了Fence已经更改成acquire状态。同时记录当前的fence为mLastQueueBufferFence。</p>
<p>当下一个绘制的GraphicBuffer进来之后，如果是通过OpenGL es的swapBuffer触发的queueBuffer操作，则会进行lastQueuedFence的waitForever进行阻塞。</p>
<p>这里面的内在逻辑是什么呢？如果通读我之前写文章，其实发现OpenGL es在eglswapBuffer会进行queueBuffer以及Surface每一次通过unlockAndPost之后会把Canvas中的数据通过queueBuffer进行GraphicBuffer的队列压入。</p>
<p>提示，通过OpenGL es 入队的api都是NATIVE_WINDOW_API_EGL，而通过Canvas的绘制好后unlockAndPost的操作对应的api是NATIVE_WINDOW_API_CPU。</p>
<p>这样就会造成一个问题，两个不同的对象在不断的开始生产各自图元进行入队。当我们已经把一个通过Skia绘制好的GraphicBuffer传入了hwc_set并初始化好fence后，OpenGL es绘制的图元到来会检测上一帧还没绘制就会等到上一帧绘制好后才能继续。</p>
<p>因此，这里意味着OpenGL es生产的图元和一次性和CPU生产的图元一起运到后续的步骤进行合成。</p>
<p>其实这就是为了处理OpenGL es绘制和CPU绘制每一帧花费的时间不同，一般的OpenGL es都是借助GPU进行绘制，因此会快上很多。后面有提到，Android希望每一帧都卡在16.6ms左右也就是60fps中，如果GPU太快，而CPU太慢就会出现因为GPU太快导致SF刷新的频率过高，从而使得性能消耗过大。</p>
<p>如下图：<br><img src="/images/SF%E7%9A%84queueBuffer_fence%E9%80%BB%E8%BE%91.png" alt="SF的queueBuffer_fence逻辑.png"></p>
<p>这就是源码注解中，为什么Google经过权衡之后，偏向选择牺牲SF的吞吐量从而降低刷新频率的原因。</p>
<h3 id="Fence-在-updateTexImage-参与的角色"><a href="#Fence-在-updateTexImage-参与的角色" class="headerlink" title="Fence 在 updateTexImage 参与的角色"></a>Fence 在 updateTexImage 参与的角色</h3><p>在acquireBuffer过程中实际上就是选定需要跳多少帧之后需要显示的GraphicBuffer，实际上Fence真正起作用的是它的调用者updateTexImage。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp" target="_blank" rel="noopener">BufferLayerConsumer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferLayerConsumer<span class="token operator">::</span><span class="token function">updateTexImage</span><span class="token punctuation">(</span>BufferRejecter<span class="token operator">*</span> rejecter<span class="token punctuation">,</span> <span class="token keyword">const</span> DispSync<span class="token operator">&amp;</span> dispSync<span class="token punctuation">,</span>
                                             <span class="token keyword">bool</span><span class="token operator">*</span> autoRefresh<span class="token punctuation">,</span> <span class="token keyword">bool</span><span class="token operator">*</span> queuedBuffer<span class="token punctuation">,</span>
                                             uint64_t maxFrameNumber<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Release the previous buffer.</span>
    err <span class="token operator">=</span> <span class="token function">updateAndReleaseLocked</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mPendingRelease<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>SyncFeatures<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useNativeFenceSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">bindTextureImageLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，fence参与了两件事情：</p>
<ul>
<li>1.updateAndReleaseLocked 释放前一帧的GraphicBuffer，如果打开了useNativeFenceSync标志位则会合并OpenGL es和SF的fence。</li>
<li>2.如果关闭了useNativeFenceSync标志位，bindTextureImageLocked等待OpenGL es在这个过程中完成消费需要的OpenGL es的命令。</li>
</ul>
<h4 id="updateAndReleaseLocked-fence在释放GraphicBuffer的角色"><a href="#updateAndReleaseLocked-fence在释放GraphicBuffer的角色" class="headerlink" title="updateAndReleaseLocked fence在释放GraphicBuffer的角色"></a>updateAndReleaseLocked fence在释放GraphicBuffer的角色</h4><p>此时已经从多个线程通过Handler转化到主线程中执行的步骤，因此到这一步需要释放上一帧的GraphicBuffer时候，需要把当前要释放的GraphicBuffer对应的fence阻塞起来，避免在dequeueBuffer的时候拿出来使用。主要对应其GraphicBufferMapper的lockAsync的方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferLayerConsumer<span class="token operator">::</span><span class="token function">updateAndReleaseLocked</span><span class="token punctuation">(</span><span class="token keyword">const</span> BufferItem<span class="token operator">&amp;</span> item<span class="token punctuation">,</span>
                                                     PendingRelease<span class="token operator">*</span> pendingRelease<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status_t err <span class="token operator">=</span> NO_ERROR<span class="token punctuation">;</span>

    <span class="token keyword">int</span> slot <span class="token operator">=</span> item<span class="token punctuation">.</span>mSlot<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Do whatever sync ops we need to do before releasing the old slot.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot <span class="token operator">!=</span> mCurrentTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">syncForReleaseLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>


    sp<span class="token operator">&lt;</span>Image<span class="token operator">></span> nextTextureImage <span class="token operator">=</span> mImages<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// release old buffer</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentTexture <span class="token operator">!=</span> BufferQueue<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pendingRelease <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status_t status <span class="token operator">=</span>
                    <span class="token function">releaseBufferLocked</span><span class="token punctuation">(</span>mCurrentTexture<span class="token punctuation">,</span> mCurrentTextureImage<span class="token operator">-</span><span class="token operator">></span><span class="token function">graphicBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>status <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">BLC_LOGE</span><span class="token punctuation">(</span><span class="token string">"updateAndRelease: failed to release buffer: %s (%d)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>status<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         status<span class="token punctuation">)</span><span class="token punctuation">;</span>
                err <span class="token operator">=</span> status<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// keep going, with error raised [?]</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pendingRelease<span class="token operator">-</span><span class="token operator">></span>currentTexture <span class="token operator">=</span> mCurrentTexture<span class="token punctuation">;</span>
            pendingRelease<span class="token operator">-</span><span class="token operator">></span>graphicBuffer <span class="token operator">=</span> mCurrentTextureImage<span class="token operator">-</span><span class="token operator">></span><span class="token function">graphicBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pendingRelease<span class="token operator">-</span><span class="token operator">></span>isPending <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">// Update the BufferLayerConsumer state.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面会判断不是当前绘制的GraphicBuffer不是上一次对应的索引，则会释放上一次索引对应的GraphicBuffer。如果是同一个索引，就要判断到mCurrentTexture已经有数据，则会添加到pendingRelease等到合成完毕后再释放，pendingRelease为空直接释放上一帧的内容。</p>
<h4 id="fence-在图元绑定和释放处理的逻辑"><a href="#fence-在图元绑定和释放处理的逻辑" class="headerlink" title="fence 在图元绑定和释放处理的逻辑"></a>fence 在图元绑定和释放处理的逻辑</h4><p>其中的如果slot不是一致的,会调用：</p>
<ul>
<li>1.syncForReleaseLocked 合并同步当前图元对应的fence</li>
<li>2.releaseBufferLocked 释放图元</li>
</ul>
<h4 id="syncForReleaseLocked同步当前图元对应的fence逻辑"><a href="#syncForReleaseLocked同步当前图元对应的fence逻辑" class="headerlink" title="syncForReleaseLocked同步当前图元对应的fence逻辑"></a>syncForReleaseLocked同步当前图元对应的fence逻辑</h4><pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferLayerConsumer<span class="token operator">::</span><span class="token function">syncForReleaseLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">BLC_LOGV</span><span class="token punctuation">(</span><span class="token string">"syncForReleaseLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentTexture <span class="token operator">!=</span> BufferQueue<span class="token operator">::</span>INVALID_BUFFER_SLOT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SyncFeatures<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useNativeFenceSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            base<span class="token operator">::</span>unique_fd fenceFd <span class="token operator">=</span> mRE<span class="token punctuation">.</span><span class="token function">flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fenceFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> <span class="token function">fence</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">Fence</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status_t err <span class="token operator">=</span> <span class="token function">addReleaseFenceLocked</span><span class="token punctuation">(</span>mCurrentTexture<span class="token punctuation">,</span>
                                                 mCurrentTextureImage<span class="token operator">-</span><span class="token operator">></span><span class="token function">graphicBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果发现SF打开了OpenGL es的同步开关，此时会从RenderEngine中拿到对应OpenGL es中的fence同步栅，赋值给当前Fence对象，通过addReleaseFenceLocked把CPU和GPU的同步栅合并起来。</p>
<p>文件:/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/ConsumerBase.cpp" target="_blank" rel="noopener">ConsumerBase.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t ConsumerBase<span class="token operator">::</span><span class="token function">addReleaseFenceLocked</span><span class="token punctuation">(</span><span class="token keyword">int</span> slot<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>GraphicBuffer<span class="token operator">></span> graphicBuffer<span class="token punctuation">,</span> <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span><span class="token operator">&amp;</span> fence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">auto</span> currentStatus <span class="token operator">=</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence<span class="token operator">-</span><span class="token operator">></span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">auto</span> incomingStatus <span class="token operator">=</span> fence<span class="token operator">-</span><span class="token operator">></span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentStatus <span class="token operator">==</span> incomingStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">char</span> fenceName<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span> mergedFence <span class="token operator">=</span> Fence<span class="token operator">::</span><span class="token function">merge</span><span class="token punctuation">(</span>
                fenceName<span class="token punctuation">,</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence<span class="token punctuation">,</span> fence<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mergedFence<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> fence<span class="token punctuation">;</span>
            <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> mergedFence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>incomingStatus <span class="token operator">==</span> Fence<span class="token operator">::</span>Status<span class="token operator">::</span>Unsignaled<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> fence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/include/ui/" target="_blank" rel="noopener">ui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/include/ui/Fence.h" target="_blank" rel="noopener">Fence.h</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">inline</span> Status <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> NO_ERROR<span class="token operator">:</span>
                <span class="token keyword">return</span> Status<span class="token operator">::</span>Signaled<span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span>ETIME<span class="token operator">:</span>
                <span class="token keyword">return</span> Status<span class="token operator">::</span>Unsignaled<span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">return</span> Status<span class="token operator">::</span>Invalid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结合这两段代码，我们实际上能知道，这过程先通过wait方法，但是传入超时时间为0。换句话说通过不等待的poll阻塞方式，直接通过fence_is_signaled获取当前fence对应的状态。</p>
<p>此时发现从OpenGL es内部的fence和当前CPU对应的fence是一致的，就能合并两个fence。不是同一个对象，判断到GPU中的fence还没解开说明还有工作需要做，那就说明后面就不能只能释放。就把mSlots索引对应GraphicBuffer的Fence切换成GPU，在后面进行等待。</p>
<p>我们看看fence中merge做了什么？我们直接看内核中做的工作：<br>文件：<a href="https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sync_file.c">https://github.com/yjy239/android_kernel_4.19/blob/a12d1ce91b8cccb239991af90daf46311b7ba975/drivers/dma-buf/sync_file.c</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">struct</span> sync_file <span class="token operator">*</span><span class="token function">sync_file_merge</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span> <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>a<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>b<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sync_file <span class="token operator">*</span>sync_file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> fence <span class="token operator">*</span><span class="token operator">*</span>fences<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>nfences<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>a_fences<span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>b_fences<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> i_a<span class="token punctuation">,</span> i_b<span class="token punctuation">,</span> num_fences<span class="token punctuation">,</span> a_num_fences<span class="token punctuation">,</span> b_num_fences<span class="token punctuation">;</span>

    sync_file <span class="token operator">=</span> <span class="token function">sync_file_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sync_file<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    a_fences <span class="token operator">=</span> <span class="token function">get_fences</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>a_num_fences<span class="token punctuation">)</span><span class="token punctuation">;</span>
    b_fences <span class="token operator">=</span> <span class="token function">get_fences</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">&amp;</span>b_num_fences<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>a_num_fences <span class="token operator">></span> INT_MAX <span class="token operator">-</span> b_num_fences<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    num_fences <span class="token operator">=</span> a_num_fences <span class="token operator">+</span> b_num_fences<span class="token punctuation">;</span>

    fences <span class="token operator">=</span> <span class="token function">kcalloc</span><span class="token punctuation">(</span>num_fences<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fences<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fences<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> i_a <span class="token operator">=</span> i_b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i_a <span class="token operator">&lt;</span> a_num_fences <span class="token operator">&amp;&amp;</span> i_b <span class="token operator">&lt;</span> b_num_fences<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> fence <span class="token operator">*</span>pt_a <span class="token operator">=</span> a_fences<span class="token punctuation">[</span>i_a<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> fence <span class="token operator">*</span>pt_b <span class="token operator">=</span> b_fences<span class="token punctuation">[</span>i_b<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_a<span class="token operator">-</span><span class="token operator">></span>context <span class="token operator">&lt;</span> pt_b<span class="token operator">-</span><span class="token operator">></span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add_fence</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> pt_a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            i_a<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_a<span class="token operator">-</span><span class="token operator">></span>context <span class="token operator">></span> pt_b<span class="token operator">-</span><span class="token operator">></span>context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">add_fence</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> pt_b<span class="token punctuation">)</span><span class="token punctuation">;</span>

            i_b<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pt_a<span class="token operator">-</span><span class="token operator">></span>seqno <span class="token operator">-</span> pt_b<span class="token operator">-</span><span class="token operator">></span>seqno <span class="token operator">&lt;=</span> INT_MAX<span class="token punctuation">)</span>
                <span class="token function">add_fence</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> pt_a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                <span class="token function">add_fence</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> pt_b<span class="token punctuation">)</span><span class="token punctuation">;</span>

            i_a<span class="token operator">++</span><span class="token punctuation">;</span>
            i_b<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i_a <span class="token operator">&lt;</span> a_num_fences<span class="token punctuation">;</span> i_a<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">add_fence</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> a_fences<span class="token punctuation">[</span>i_a<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i_b <span class="token operator">&lt;</span> b_num_fences<span class="token punctuation">;</span> i_b<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">add_fence</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> <span class="token operator">&amp;</span>i<span class="token punctuation">,</span> b_fences<span class="token punctuation">[</span>i_b<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        fences<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">fence_get</span><span class="token punctuation">(</span>a_fences<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_fences <span class="token operator">></span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nfences <span class="token operator">=</span> <span class="token function">krealloc</span><span class="token punctuation">(</span>fences<span class="token punctuation">,</span> i <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>fences<span class="token punctuation">)</span><span class="token punctuation">,</span>
                  GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nfences<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> err<span class="token punctuation">;</span>

        fences <span class="token operator">=</span> nfences<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sync_file_set_fence</span><span class="token punctuation">(</span>sync_file<span class="token punctuation">,</span> fences<span class="token punctuation">,</span> i<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kfree</span><span class="token punctuation">(</span>fences<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">strlcpy</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sync_file<span class="token punctuation">;</span>

err<span class="token operator">:</span>
    <span class="token function">fput</span><span class="token punctuation">(</span>sync_file<span class="token operator">-</span><span class="token operator">></span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.get_fences 获取sync_file中的对象。此时可能是单一时间点的fence，也可能含有多个时间点的fence_array.</li>
<li>2.不管是哪一种，由于fence的序列是基于同一个sync_timeline为基准不断的单调递增的。因此可以简单通过同步点的大小，找出每一个fence此时对应的时间点顺序。把没有达到释放时间的fence全部合并起来，变成一个fence_array。</li>
</ul>
<p>这个唤醒逻辑如下：<br><img src="/images/fence_merge.png" alt="fence_merge.png"></p>
<p>当进行了OpenGL es和CPU的fencemerge之后，我们可以看updateTexImage中bindTextureImageLocked的逻辑。</p>
<h4 id="bindTextureImageLocked-中fence进行分开或者合并管理"><a href="#bindTextureImageLocked-中fence进行分开或者合并管理" class="headerlink" title="bindTextureImageLocked 中fence进行分开或者合并管理"></a>bindTextureImageLocked 中fence进行分开或者合并管理</h4><p>bindTextureImageLocked的使用时机有两处：</p>
<ul>
<li>1.第一处是在消费图元的时候，如果SF打开了对了OpenGL es的sync同步信号的等待，就会进行在updateTexImage直接执行。</li>
<li>2.第二处在BufferLayer的onDraw方法中直接调用。</li>
</ul>
<p>为什么这2种处理会出现差异呢？useNativeFenceSync这个标志位实际上是处理OpenGL es对应的fence同步栅是否是兼容Android的EGL_ANDROID_native_fence_sync。</p>
<p>兼容那么Android将会在syncForReleaseLocked提前合并OpenGL es中的fence作为同步的标准之一，提前绑定一个RE::Image到SF中。</p>
<p>但是如果不兼容，那就必须分开同步管理，也就是在onDraw中进行等待OpenGL es中合成好，才能继续下一步，其中的核心就是最后的doFenceWaitLocked方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferLayerConsumer<span class="token operator">::</span><span class="token function">doFenceWaitLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRE<span class="token punctuation">.</span><span class="token function">isCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> INVALID_OPERATION<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mCurrentFence<span class="token operator">-</span><span class="token operator">></span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>SyncFeatures<span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">useWaitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            base<span class="token operator">::</span>unique_fd <span class="token function">fenceFd</span><span class="token punctuation">(</span>mCurrentFence<span class="token operator">-</span><span class="token operator">></span><span class="token function">dup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fenceFd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mRE<span class="token punctuation">.</span><span class="token function">waitFence</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>fenceFd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            status_t err <span class="token operator">=</span> mCurrentFence<span class="token operator">-</span><span class="token operator">></span><span class="token function">waitForever</span><span class="token punctuation">(</span><span class="token string">"BufferLayerConsumer::doFenceWaitLocked"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> err<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里有两个判断：</p>
<ul>
<li>1.如果OpenGL es支持fence同步栅，则会通过RenderEngine自己进行等待处理。</li>
<li>2.如果OpenGL es支持Android的fence同步栅，此时已经合并了，直接对着合并后的fence进行等待即可。</li>
</ul>
<h4 id="releaseBufferLocked-释放图元中fence参与的角色"><a href="#releaseBufferLocked-释放图元中fence参与的角色" class="headerlink" title="releaseBufferLocked 释放图元中fence参与的角色"></a>releaseBufferLocked 释放图元中fence参与的角色</h4><p>releaseBufferLocked 执行的时机有2处：</p>
<ul>
<li>1.updateAndReleaseLocked 如果没有pendingReleaseFence，则直接释放上一帧的GraphicBuffer</li>
<li>2.当SF的合成完成后，进行postComposition收尾工作，会遍历mLayersWithQueuedFrames(可视的Layer)调用releasePendingBuffer方法，该方法判断mPendingRelease的isPending是否为true。一般都为true，因为每一次绘制完都会调用releasePendingBuffer生成一个PendingRelease对象，告诉updateAndRelease需要延迟销毁。<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> BufferLayerConsumer<span class="token operator">::</span><span class="token function">releasePendingBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPendingRelease<span class="token punctuation">.</span>isPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
  status_t result <span class="token operator">=</span>
          <span class="token function">releaseBufferLocked</span><span class="token punctuation">(</span>mPendingRelease<span class="token punctuation">.</span>currentTexture<span class="token punctuation">,</span> mPendingRelease<span class="token punctuation">.</span>graphicBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&lt;</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
  mPendingRelease <span class="token operator">=</span> <span class="token function">PendingRelease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
为什么需要一个延时销毁呢？主要是因为在SF中的GraphicBuffer有一种模式是共享模式，这种模式同样需要进行阻塞，不同的是，SF会不断的复用当前这个GraphicBuffer交给应用程序进行渲染。</li>
</ul>
<p>正因为这种特殊原因，需要每一次绘制完后进行才判断，而不是粗暴的直接在选取完需要绘制下一帧之前直接释放掉。</p>
<p>有点偏题了，接下来看看释放的核心方法：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/" target="_blank" rel="noopener">libs</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/" target="_blank" rel="noopener">gui</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/libs/gui/BufferQueueConsumer.cpp" target="_blank" rel="noopener">BufferQueueConsumer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t BufferQueueConsumer<span class="token operator">::</span><span class="token function">releaseBuffer</span><span class="token punctuation">(</span><span class="token keyword">int</span> slot<span class="token punctuation">,</span> uint64_t frameNumber<span class="token punctuation">,</span>
        <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Fence<span class="token operator">></span><span class="token operator">&amp;</span> releaseFence<span class="token punctuation">,</span> EGLDisplay eglDisplay<span class="token punctuation">,</span>
        EGLSyncKHR eglFence<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ATRACE_BUFFER_INDEX</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>slot <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> slot <span class="token operator">>=</span> BufferQueueDefs<span class="token operator">::</span>NUM_BUFFER_SLOTS <span class="token operator">||</span>
            releaseFence <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sp<span class="token operator">&lt;</span>IProducerListener<span class="token operator">></span> listener<span class="token punctuation">;</span>
    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Autolock scope</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>frameNumber <span class="token operator">!=</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFrameNumber <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span>mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> STALE_BUFFER_SLOT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isAcquired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglDisplay <span class="token operator">=</span> eglDisplay<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mEglFence <span class="token operator">=</span> eglFence<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mFence <span class="token operator">=</span> releaseFence<span class="token punctuation">;</span>
        mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCore<span class="token operator">-</span><span class="token operator">></span>mSharedBufferMode <span class="token operator">&amp;&amp;</span> mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span>mShared <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mSlots<span class="token punctuation">[</span>slot<span class="token punctuation">]</span><span class="token punctuation">.</span>mBufferState<span class="token punctuation">.</span><span class="token function">isShared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mActiveBuffers<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mFreeBuffers<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>slot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        listener <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mConnectedProducerListener<span class="token punctuation">;</span>

        mCore<span class="token operator">-</span><span class="token operator">></span>mDequeueCondition<span class="token punctuation">.</span><span class="token function">broadcast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">VALIDATE_CONSISTENCY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token comment" spellcheck="true">// Autolock scope</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>listener <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        listener<span class="token operator">-</span><span class="token operator">></span><span class="token function">onBufferReleased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上很简单，这个方法先把当前fence名字改成releaseFence说明此时fence已经进入会release状态。接着保存当前的GraphicBuffer等，判断到如果不是共享状态，则会把对应的slot从mActiveBuffers放到mFreeBuffers中，等到下一次dequeue时候使用，最后唤醒同一个线程的dequeue的阻塞。</p>
<p>至此，整个SF中fence的状态的流转已经解析完全。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>fence本质上对应上内核中一个文件描述符sync_file，sync_file中有一个核心的fence结构体，用于预计释放的时间点。所有的fence都是以sync_timeline为基准进行递增的。</p>
<p>sync_timeline 作为内核记录已经渲染屏幕多少个时间点，每一次通过hwc_set都会递增一个时间点，并且会尝试的唤醒关联在sync_timeline中active_list中sync_pt的fence的阻塞。</p>
<p>当fence合并之后，将会调用fence_add_callback重新把fence_array中的时间点都加到对应的active_list中。不过这一次唤醒，就需要fence_array中所有的fence都唤醒了，才会唤醒阻塞。</p>
<p>能看到实际上这个过程其实有点像Java中的CyclicBarrier，不过比他灵活多了。关于图，我已经在上文已经画过了，接下来让我们重点关注fence在SurfaceFlinger中的状态流转。</p>
<p>先来看看GraphicBuffer中在SF的状态流转<br><img src="/images/GraphicBuffer%E7%8A%B6%E6%80%81%E6%B5%81%E8%BD%AC.png" alt="GraphicBuffer状态流转.png"></p>
<p>接着再来看看fence在整个SF中各个流程中担当了什么角色：</p>
<h3 id="dequeueBuffer-GraphicBuffer的从SF出队到app进行绘制流程中"><a href="#dequeueBuffer-GraphicBuffer的从SF出队到app进行绘制流程中" class="headerlink" title="dequeueBuffer GraphicBuffer的从SF出队到app进行绘制流程中"></a>dequeueBuffer GraphicBuffer的从SF出队到app进行绘制流程中</h3><ul>
<li><ol>
<li>调用BufferQueueProducer的dequeue方法，获取在BufferQueueProducer中空闲的slot对应的GraphicBuffer，这个过程中，通过fence会等待OpenGL es在还没有完成的工作。</li>
</ol>
</li>
<li><ol start="2">
<li>调用GraphicBufferMapper的lockAsync方法，对ion驱动中的内存地址进行一次内存映射，找到分配出来的图元绘制地址。这个过程如果是低版本或者不支持lockAsync，则会进行等待上一帧GraphicBuffer的fence阻塞，直到对应该GraphicBuffer完成了release操作，才可能完成Surface的lock操作。</li>
</ol>
</li>
</ul>
<h3 id="queueBuffer-GraphicBuffer在应用绘制好后进入SF进程"><a href="#queueBuffer-GraphicBuffer在应用绘制好后进入SF进程" class="headerlink" title="queueBuffer GraphicBuffer在应用绘制好后进入SF进程"></a>queueBuffer GraphicBuffer在应用绘制好后进入SF进程</h3><ul>
<li><ol>
<li>首先Surface在unlockAndPost中先对GraphicBuffer解开内存映射，如果是高版本的gralloc，则会进行阻塞，等到绘制的内容同步到gralloc中，才解开映射。</li>
</ol>
</li>
<li><ol start="2">
<li>调用BufferQueueProducer的queueBuffer方法，把fence转化为acquire状态，GPU(OpenGL es)的完成这一帧的工作会等待CPU(Skia)的绘制工作，避免频率过快导致耗能过高。</li>
</ol>
</li>
</ul>
<h3 id="GraphicBuffer-消费和合成图元"><a href="#GraphicBuffer-消费和合成图元" class="headerlink" title="GraphicBuffer 消费和合成图元"></a>GraphicBuffer 消费和合成图元</h3><p>该方法会通过acquireBuffer决定跳多少帧，显示哪一帧的图元。之后会调用updateAndReleaseLocked方法，主要做了事情：</p>
<ul>
<li><ol>
<li>syncForReleaseLocked判断是否需要合并OpenGL es是否支持Android的fence。支持则会把OpenGL es的fence和CPU的fence合并起来。如果合并了，则可以统一处理OpenGL es和CPU的fence的同步栅唤醒事件，提前执行bindTextureImageLocked方法，把图元交给OpenGL es中进一步处理，交给doFenceWaitLocked进行阻塞等待合并后的fence。</li>
</ol>
</li>
<li><p>2.如果此时Client的绘制模式，当执行到了Layer的onDraw的方法时候，也会执行bindTextureImageLocked，不过，如果此时OpenGL es不支持Android的fence，调用doFenceWaitLocked此时是单独阻塞了OpenGL es中的fence。</p>
</li>
<li><p>3.无论谁都是doFenceWaitLocked进行阻塞，这个方法实际上是等待OpenGL es把GraphicBuffer绑定到OpenGL es操作的GPU中。只有同步了这个步骤了，之后无论HWC还是OpenGL es的绘制才能同步且正确。</p>
</li>
</ul>
<p>当所有绘制完的，把已经释放过的fence会合并到retireFenceFd保存起来。</p>
<p>释放图元因为有Share模式的图元将会把事释放事件从updateAndReleaseLocked推迟到SF执行完合成步骤的postComposition开始释放。</p>
<h3 id="GraphicBuffer的释放"><a href="#GraphicBuffer的释放" class="headerlink" title="GraphicBuffer的释放"></a>GraphicBuffer的释放</h3><p>做的事情很简单，就是一件事情。把GraphicBuffer对应的索引放入mFreeSlots集合中等待是dequeue使用，同时把fence只是名字上转化为release状态。</p>
<p>最后老规矩，我们用一幅图总结：<br><img src="/images/fence%E8%BD%AC%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="fence转化流程图.png"></p>
<p>实际上，总结一句话，Fence的acquire状态其实是阻塞什么时候可以被消费，什么时候可以被渲染到屏幕；而Fence的release状态则是控制什么时候可以出队给应用进行绘制，什么时候可以被映射到内存。</p>
<p>同时也会依据OpenGL es是否兼容Android的fence而是否提前设置本地纹理。</p>
<h1 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h1><p>最后感谢这些大佬：<br><a href="http://tangzm.com/blog/?p=167" target="_blank" rel="noopener">http://tangzm.com/blog/?p=167</a><br><a href="https://blog.csdn.net/w401229755/article/details/39228535" target="_blank" rel="noopener">https://blog.csdn.net/w401229755/article/details/39228535</a></p>
<p>研究fence的时候，其实花了很大的经历在阅读GPU中vblank的fence的机制。因为GPU中也有fence机制，它的核心思想是注册了GPU的irq中断用来唤醒fence。由于下意识的认为GPU中的同步栅和SurfaceFlinger的fence应该也是同步得到，在drm_hwcomposer花了大量的时间找了两者的联系。事实上两者的联系不大，导致做了大量的无用功。</p>
<p>drm_hwcomposer说到底设计上还是不足。使用了阻塞的方式进行drmModeAtomicCommit提交，白白浪费了drm的多线程和SF的多线程模型。仅仅只是完成提交渲染后才解开阻塞。其实阅读源码过程中，drm驱动对应不同的GPU的实现也会在实现自己的fence，可以通过OUT_FENCE_PTR的属性获取这个fence，从而做到更加流程的SurfaceFlinger流程。而实际上在msm8960这些不太新的驱动反而做到了fence同步了GPU自己fb驱动中的fence。</p>
<p>下一篇文章就是SF最后一篇文章，看看SurfaceFlinger是如何处理同步信号，如何把同步信号Vsync发送应用的。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/02/25/android-chong-xue-xi-lie-vsync-tong-bu-xin-hao-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/5.jpg" class="responsive-img" alt="Android 重学系列 Vsync同步信号原理">
                        
                        <span class="card-title">Android 重学系列 Vsync同步信号原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言经过前面系列文章的学习，我们的已经理解了SurfaceFlinger运行机制以及同步机制，但是SurfaceFlinger又是以什么方法是把需要刷新的信号发送给App进程的，本文将会和探讨这个问题。
如果遇到问题可以来本文进行讨论：ht
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-02-25
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/02/14/android-chong-xue-xi-lie-tu-yuan-de-he-cheng-xia/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/9.jpg" class="responsive-img" alt="Android 重学系列 图元的合成(下)">
                        
                        <span class="card-title">Android 重学系列 图元的合成(下)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言整个图元的合成，大致上分为如下6个步骤：

1.preComposition 预处理合成
2.rebuildLayerStacks 重新构建Layer栈
3.setUpHWComposer HWC的渲染或者准备
4.doDebugFla
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-02-14
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
