<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android 重学系列 Vsync同步信号原理, Android | Linux | Flutter">
    <meta name="description" content="前言经过前面系列文章的学习，我们的已经理解了SurfaceFlinger运行机制以及同步机制，但是SurfaceFlinger又是以什么方法是把需要刷新的信号发送给App进程的，本文将会和探讨这个问题。
如果遇到问题可以来本文进行讨论：ht">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android 重学系列 Vsync同步信号原理 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android 重学系列 Vsync同步信号原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android/">
                                <span class="chip bg-color">Android</span>
                            </a>
                        
                            <a href="/tags/Android-Framework/">
                                <span class="chip bg-color">Android Framework</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                SurfaceFlinger
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-02-25
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        12.4k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        52 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过前面系列文章的学习，我们的已经理解了SurfaceFlinger运行机制以及同步机制，但是SurfaceFlinger又是以什么方法是把需要刷新的信号发送给App进程的，本文将会和探讨这个问题。</p>
<p>如果遇到问题可以来本文进行讨论：<a href="https://www.jianshu.com/p/82c0556e9c76" target="_blank" rel="noopener">https://www.jianshu.com/p/82c0556e9c76</a></p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>还记得我写的SurfaceFlinger的第一篇<a href="https://www.jianshu.com/p/9dac91bbb9c9" target="_blank" rel="noopener">SurfaceFlinger初始化</a>一文里面有探讨过一个十分重要的类EventThread，在EventThread初始化中，持有一个十分核心对象DispSyncSource。而DispSyncSource又持有DispSync。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">mEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>vsyncPhaseOffsetNs<span class="token punctuation">,</span>
                                             <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                       impl<span class="token operator">::</span>EventThread<span class="token operator">::</span><span class="token function">InterceptVSyncsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token string">"appEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mSfEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span>
                                             SurfaceFlinger<span class="token operator">::</span>sfVsyncPhaseOffsetNs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"sf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mSFEventThread <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mSfEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                    mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveVSyncEvent</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token string">"sfEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分别创建两个EventThread，一个是名字为sf，一个是app。我在初始化一文就说过，这两个对象在控制着什么时候发送vsync信号。首先来看看DispSync的初始化方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">dispSyncPresentTimeOffset <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>presentTimeOffsetFromVSyncNs<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">::</span>hasSyncFramework<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>dispSyncPresentTimeOffset<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="DispSync-初始化"><a href="#DispSync-初始化" class="headerlink" title="DispSync 初始化"></a>DispSync 初始化</h2><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DispSync.cpp" target="_blank" rel="noopener">DispSync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">DispSync<span class="token operator">::</span><span class="token function">DispSync</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mName</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mRefreshSkipCount</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">DispSyncThread</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

DispSync<span class="token operator">::</span><span class="token operator">~</span><span class="token function">DispSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">void</span> DispSync<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">bool</span> hasSyncFramework<span class="token punctuation">,</span> int64_t dispSyncPresentTimeOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mIgnorePresentFences <span class="token operator">=</span> <span class="token operator">!</span>hasSyncFramework<span class="token punctuation">;</span>
    mPresentTimeOffset <span class="token operator">=</span> dispSyncPresentTimeOffset<span class="token punctuation">;</span>
    mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">"DispSync"</span><span class="token punctuation">,</span> PRIORITY_URGENT_DISPLAY <span class="token operator">+</span> PRIORITY_MORE_FAVORABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// set DispSync to SCHED_FIFO to minimize jitter</span>
    <span class="token keyword">struct</span> sched_param param <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    param<span class="token punctuation">.</span>sched_priority <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">sched_setscheduler</span><span class="token punctuation">(</span>mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">getTid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SCHED_FIFO<span class="token punctuation">,</span> <span class="token operator">&amp;</span>param<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Couldn't set SCHED_FIFO for DispSyncThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">beginResync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mIgnorePresentFences <span class="token operator">&amp;&amp;</span> kEnableZeroPhaseTracer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mZeroPhaseTracer <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>ZeroPhaseTracer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"ZeroPhaseTracer"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> mZeroPhaseTracer<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在DispSync中初始化了DispSyncThread线程，并且在init方法中运行起来，并且设置该线程的task_struct处于最高优先级，调用beginResync初始化所有Vsync中的参数。</p>
<h3 id="DispSyncThread-初始化"><a href="#DispSyncThread-初始化" class="headerlink" title="DispSyncThread 初始化"></a>DispSyncThread 初始化</h3><p>Android中native中的Thread最后会走到threadLoop中：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> <span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        status_t err<span class="token punctuation">;</span>
        nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Vector<span class="token operator">&lt;</span>CallbackInvocation<span class="token operator">></span> callbackInvocations<span class="token punctuation">;</span>

            nsecs_t targetTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Scope for lock</span>
                Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">ATRACE_INT64</span><span class="token punctuation">(</span><span class="token string">"DispSync:Frame"</span><span class="token punctuation">,</span> mFrameNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"[%s] Frame %"</span> PRId64<span class="token punctuation">,</span> mName<span class="token punctuation">,</span> mFrameNumber<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">++</span>mFrameNumber<span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mStop<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>mPeriod <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    err <span class="token operator">=</span> mCond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"error waiting for new events: %s (%d)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                targetTime <span class="token operator">=</span> <span class="token function">computeNextEventTimeLocked</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">bool</span> isWakeup <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">&lt;</span> targetTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_NAME</span><span class="token punctuation">(</span><span class="token string">"DispSync waiting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>targetTime <span class="token operator">==</span> INT64_MAX<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"[%s] Waiting forever"</span><span class="token punctuation">,</span> mName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        err <span class="token operator">=</span> mCond<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"[%s] Waiting until %"</span> PRId64<span class="token punctuation">,</span> mName<span class="token punctuation">,</span> <span class="token function">ns2us</span><span class="token punctuation">(</span>targetTime<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        err <span class="token operator">=</span> mCond<span class="token punctuation">.</span><span class="token function">waitRelative</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">,</span> targetTime <span class="token operator">-</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> TIMED_OUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        isWakeup <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"error waiting for next event: %s (%d)"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// Don't correct by more than 1.5 ms</span>
                <span class="token keyword">static</span> <span class="token keyword">const</span> nsecs_t kMaxWakeupLatency <span class="token operator">=</span> <span class="token function">us2ns</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>isWakeup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mWakeupLatency <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mWakeupLatency <span class="token operator">*</span> <span class="token number">63</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> targetTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">64</span><span class="token punctuation">;</span>
                    mWakeupLatency <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>mWakeupLatency<span class="token punctuation">,</span> kMaxWakeupLatency<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">}</span>

                callbackInvocations <span class="token operator">=</span> <span class="token function">gatherCallbackInvocationsLocked</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackInvocations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">fireCallbackInvocations</span><span class="token punctuation">(</span>callbackInvocations<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>每一次循环都会把mFrameNumber 代表帧数加1.</li>
</ol>
</li>
<li><ol start="2">
<li>如果mPeriod(周期)为0，则进行等待有人通过updateModel方法更新了mPeriod为一个有效的数值，才继续线程的计算。</li>
</ol>
</li>
<li><ol start="3">
<li>每一次执行都会通过computeNextEventTimeLocked计算下一次vsync发送的时间。</li>
</ol>
</li>
<li><ol start="4">
<li>如果目标时间大于当前时间，则会通过Condtion进行等待target时间和now时间差，如果超过最大的int64(也就是long最大数值)，则会直接阻塞等待更新。如果当前时间超过目标时间，则需要立即唤醒需要，isWakeup 设置为true。</li>
</ol>
</li>
<li><ol start="5">
<li>每一次计算，都会记录上一次的时间差值。在下一次计算会把当前的差值计算下去，进行一次调整。其实就是把计算出来需要等待的差值获得64分之一保存起来。当下一次获得新的差值，把时间向后推移当前差值63倍数，这样就有最后一份的调整时间，加上下一次的新的差值，就能找到间隔相似的时间点。但是要注意，每一次发送最大不能超过1500ms，超过了就取1500ms。</li>
</ol>
</li>
<li><ol start="6">
<li><p>在每一次的发送都会计算调整每一个mEventListeners监听的回调时间，只有当前时间大于预期发送时间，才会加入发送集合中，并把时间和回调时间保存在CallbackInvocation。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Vector<span class="token operator">&lt;</span>CallbackInvocation<span class="token operator">></span> <span class="token function">gatherCallbackInvocationsLocked</span><span class="token punctuation">(</span>nsecs_t now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"[%s] gatherCallbackInvocationsLocked @ %"</span> PRId64<span class="token punctuation">,</span> mName<span class="token punctuation">,</span> <span class="token function">ns2us</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   Vector<span class="token operator">&lt;</span>CallbackInvocation<span class="token operator">></span> callbackInvocations<span class="token punctuation">;</span>
   nsecs_t onePeriodAgo <span class="token operator">=</span> now <span class="token operator">-</span> mPeriod<span class="token punctuation">;</span>

   <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mEventListeners<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       nsecs_t t <span class="token operator">=</span> <span class="token function">computeListenerNextEventTimeLocked</span><span class="token punctuation">(</span>mEventListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> onePeriodAgo<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           CallbackInvocation ci<span class="token punctuation">;</span>
           ci<span class="token punctuation">.</span>mCallback <span class="token operator">=</span> mEventListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mCallback<span class="token punctuation">;</span>
           ci<span class="token punctuation">.</span>mEventTime <span class="token operator">=</span> t<span class="token punctuation">;</span>
           <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"[%s] [%s] Preparing to fire"</span><span class="token punctuation">,</span> mName<span class="token punctuation">,</span> mEventListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token punctuation">)</span><span class="token punctuation">;</span>
           callbackInvocations<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
           mEventListeners<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>mLastEventTime <span class="token operator">=</span> t<span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">return</span> callbackInvocations<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
</li>
<li><ol start="7">
<li>如果发现需要发送集合大于0，将会调用fireCallbackInvocations，发送信号回调<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">fireCallbackInvocations</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>CallbackInvocation<span class="token operator">></span><span class="token operator">&amp;</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onDispSyncEvent</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mEventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
</li>
</ul>
<p>那么这个监听是哪里注册的呢？我们稍后解析。mCallback回调就是DispSyncSource，mCallback在这个方法调用onVSyncEvent。这个逻辑我们稍后再看。</p>
<p>让我们回到持有DispSync的对象DispSyncSource。DispSyncSource这个对象只是简单的调用了构造函数，我们需要看看持有DispSyncSource的EventThread对象。</p>
<h3 id="EventThread初始化中DispSync的工作"><a href="#EventThread初始化中DispSync的工作" class="headerlink" title="EventThread初始化中DispSync的工作"></a>EventThread初始化中DispSync的工作</h3><pre class="line-numbers language-cpp"><code class="language-cpp">EventThread<span class="token operator">::</span><span class="token function">EventThread</span><span class="token punctuation">(</span>VSyncSource<span class="token operator">*</span> src<span class="token punctuation">,</span> ResyncWithRateLimitCallback resyncWithRateLimitCallback<span class="token punctuation">,</span>
                         InterceptVSyncsCallback interceptVSyncsCallback<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> threadName<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">mVSyncSource</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mResyncWithRateLimitCallback</span><span class="token punctuation">(</span>resyncWithRateLimitCallback<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">mInterceptVSyncsCallback</span><span class="token punctuation">(</span>interceptVSyncsCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> event <span class="token operator">:</span> mVSyncEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        event<span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>EventThread自己本身也是一个线程，它持有一个方法指针，这个方法是SF的resyncWithRateLimit()，该方法实际上就是DispSync中重新设置mPeriod的关键函数。</p>
<p>同时设置初始化了mVSyncEvent每一个时间的类型为DISPLAY_EVENT_VSYNC。mVSyncEvent这个集合大小其实就是Android允许接入的屏幕个数，这个id也是对应屏幕的type类型，在这里是2.</p>
<h3 id="EventThread发送Vsync信号"><a href="#EventThread发送Vsync信号" class="headerlink" title="EventThread发送Vsync信号"></a>EventThread发送Vsync信号</h3><p>还记得<a href="https://www.jianshu.com/p/67c1e350fe0d" target="_blank" rel="noopener">图元的消费</a>一文中有提到过，当SF执行完queueBuffer方法之后，通过onFrameAvailable回调到MessageQueue::invalidate方法中。这个方法如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> MessageQueue<span class="token operator">::</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mEvents<span class="token operator">-</span><span class="token operator">></span><span class="token function">requestNextVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>接下来会调用如下方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventThread<span class="token operator">::</span><span class="token function">requestNextVsync</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>EventThread<span class="token operator">::</span>Connection<span class="token operator">></span><span class="token operator">&amp;</span> connection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mResyncWithRateLimitCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mResyncWithRateLimitCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        connection<span class="token operator">-</span><span class="token operator">></span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        mCondition<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时就调用了EventThread中持有的mResyncWithRateLimitCallback方法指针，进行Period设定之后，才唤醒EventThread中的阻塞。这个方法就是resyncWithRateLimit。</p>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">constexpr</span> nsecs_t kIgnoreDelay <span class="token operator">=</span> <span class="token function">ms2ns</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">static</span> nsecs_t sLastResyncAttempted <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> sLastResyncAttempted <span class="token operator">></span> kIgnoreDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resyncToHardwareVsync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    sLastResyncAttempted <span class="token operator">=</span> now<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里的方法很简单，其实就是如果两次进行resyncWithRateLimit 同步信号的采样调整时间差小于50纳秒就忽略。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">resyncToHardwareVsync</span><span class="token punctuation">(</span><span class="token keyword">bool</span> makeAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mHWVsyncLock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>makeAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mHWVsyncAvailable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mHWVsyncAvailable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> activeConfig <span class="token operator">=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">getActiveConfig</span><span class="token punctuation">(</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nsecs_t period <span class="token operator">=</span> activeConfig<span class="token operator">-</span><span class="token operator">></span><span class="token function">getVsyncPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">setPeriod</span><span class="token punctuation">(</span>period<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mPrimaryHWVsyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">beginResync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">//eventControl(HWC_DISPLAY_PRIMARY, SurfaceFlinger::EVENT_VSYNC, true);</span>
        mEventControlThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPrimaryHWVsyncEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会从HWC的Hal层拿到硬件层中的Vsync周期，并且设置到DispSync。如果，此时主屏幕的HWC的Vsync标志mPrimaryHWVsyncEnabled是挂壁，会通过EventControlThread通过setVsyncEnabled为true。</p>
<h4 id="DispSync-setPeriod"><a href="#DispSync-setPeriod" class="headerlink" title="DispSync setPeriod"></a>DispSync setPeriod</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DispSync<span class="token operator">::</span><span class="token function">setPeriod</span><span class="token punctuation">(</span>nsecs_t period<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mPeriod <span class="token operator">=</span> period<span class="token punctuation">;</span>
    mPhase <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mReferenceTime <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">updateModel</span><span class="token punctuation">(</span>mPeriod<span class="token punctuation">,</span> mPhase<span class="token punctuation">,</span> mReferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>把周期交给给DispSyncThread.updateModel处理。mPhase，mReferenceTime都设置为0</p>
<h4 id="DispSyncThread-updateModel"><a href="#DispSyncThread-updateModel" class="headerlink" title="DispSyncThread updateModel"></a>DispSyncThread updateModel</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">updateModel</span><span class="token punctuation">(</span>nsecs_t period<span class="token punctuation">,</span> nsecs_t phase<span class="token punctuation">,</span> nsecs_t referenceTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPeriod <span class="token operator">=</span> period<span class="token punctuation">;</span>
        mPhase <span class="token operator">=</span> phase<span class="token punctuation">;</span>
        mReferenceTime <span class="token operator">=</span> referenceTime<span class="token punctuation">;</span>
        mCond<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在updateModel中就会开始唤醒阻塞调整等待时间差的DispSyncThread线程。</p>
<h3 id="EventControlThread-setVsyncEnabled"><a href="#EventControlThread-setVsyncEnabled" class="headerlink" title="EventControlThread setVsyncEnabled"></a>EventControlThread setVsyncEnabled</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventControlThread<span class="token operator">::</span><span class="token function">threadMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> NO_THREAD_SAFETY_ANALYSIS <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> keepRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> currentVsyncEnabled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>keepRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">mSetVSyncEnabled</span><span class="token punctuation">(</span>currentVsyncEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">,</span> currentVsyncEnabled<span class="token punctuation">,</span> keepRunning<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> NO_THREAD_SAFETY_ANALYSIS <span class="token punctuation">{</span>
            <span class="token keyword">return</span> currentVsyncEnabled <span class="token operator">!=</span> mVsyncEnabled <span class="token operator">||</span> keepRunning <span class="token operator">!=</span> mKeepRunning<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        currentVsyncEnabled <span class="token operator">=</span> mVsyncEnabled<span class="token punctuation">;</span>
        keepRunning <span class="token operator">=</span> mKeepRunning<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个线程循环中，会被mCondition阻塞起来，直到currentVsyncEnabled当前设置的状态和mVsyncEnabled不同就会进入下一个循环，调用mSetVSyncEnabled方法。这个方法其实是从SF传进来的SurfaceFlinger::setVsyncEnabled方法指针：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    mEventControlThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventControlThread<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">bool</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span>HWC_DISPLAY_PRIMARY<span class="token punctuation">,</span> enabled<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h5 id="HWC-setVsyncEnabled"><a href="#HWC-setVsyncEnabled" class="headerlink" title="HWC setVsyncEnabled"></a>HWC setVsyncEnabled</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span><span class="token keyword">int</span> disp<span class="token punctuation">,</span> <span class="token keyword">int</span> enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">getHwComposer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span>disp<span class="token punctuation">,</span>
            enabled <span class="token operator">?</span> HWC2<span class="token operator">::</span>Vsync<span class="token operator">::</span>Enable <span class="token operator">:</span> HWC2<span class="token operator">::</span>Vsync<span class="token operator">::</span>Disable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时调用了HWC的setVsyncEnabled方法，设置了vsync信号是否允许被发出。由于我们已经熟悉整个SurfaceFlinger的Hal层设计，我们直奔其中的Hal层的核心方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Error HWC2On1Adapter<span class="token operator">::</span>Display<span class="token operator">::</span><span class="token function">setVsyncEnabled</span><span class="token punctuation">(</span>Vsync enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isValid</span><span class="token punctuation">(</span>enable<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Error<span class="token operator">::</span>BadParameter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enable <span class="token operator">==</span> mVsyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Error<span class="token operator">::</span>None<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>recursive_mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mStateMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> error <span class="token operator">=</span> mDevice<span class="token punctuation">.</span>mHwc1Device<span class="token operator">-</span><span class="token operator">></span><span class="token function">eventControl</span><span class="token punctuation">(</span>mDevice<span class="token punctuation">.</span>mHwc1Device<span class="token punctuation">,</span>
            mHwc1Id<span class="token punctuation">,</span> HWC_EVENT_VSYNC<span class="token punctuation">,</span> enable <span class="token operator">==</span> Vsync<span class="token operator">::</span>Enable<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mVsyncEnabled <span class="token operator">=</span> enable<span class="token punctuation">;</span>
    <span class="token keyword">return</span> Error<span class="token operator">::</span>None<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本质上就是调用了硬件对接层的eventControl方法指针。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/" target="_blank" rel="noopener">hardware</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/" target="_blank" rel="noopener">qcom</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/" target="_blank" rel="noopener">display</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/" target="_blank" rel="noopener">msm8960</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/" target="_blank" rel="noopener">libhwcomposer</a>/<a href="http://androidxref.com/9.0.0_r3/xref/hardware/qcom/display/msm8960/libhwcomposer/hwc.cpp" target="_blank" rel="noopener">hwc.cpp</a><br>这里继续用msm8960的源码看看做了什么。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">hwc_eventControl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> hwc_composer_device_1<span class="token operator">*</span> dev<span class="token punctuation">,</span> <span class="token keyword">int</span> dpy<span class="token punctuation">,</span>
                             <span class="token keyword">int</span> event<span class="token punctuation">,</span> <span class="token keyword">int</span> enable<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    hwc_context_t<span class="token operator">*</span> ctx <span class="token operator">=</span> <span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>isActive<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Display is blanked - Cannot %s vsync"</span><span class="token punctuation">,</span>
              enable <span class="token operator">?</span> <span class="token string">"enable"</span> <span class="token punctuation">:</span> <span class="token string">"disable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> HWC_EVENT_VSYNC<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token operator">-></span>vstate<span class="token punctuation">.</span>enable <span class="token operator">==</span> enable<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">hwc_vsync_control</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> dpy<span class="token punctuation">,</span> enable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                ctx<span class="token operator">-></span>vstate<span class="token punctuation">.</span>enable <span class="token operator">=</span> <span class="token operator">!</span><span class="token operator">!</span>enable<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得我在<a href="https://www.jianshu.com/p/8e29c3d9b27a" target="_blank" rel="noopener">SurfaceFlinger的Hal层初始化</a>一文就有解析过，其实vsync是基于一个线程在底层运转，等到硬件发送vsync同步信号后唤醒线程继续发送回调。</p>
<p>当然在hwc_eventControl此时会记录把当前的标志记录在ctx-&gt;vstate.enable中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">hwc_vsync_control</span><span class="token punctuation">(</span>hwc_context_t<span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token keyword">int</span> dpy<span class="token punctuation">,</span> <span class="token keyword">int</span> enable<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>fakevsync <span class="token operator">&amp;&amp;</span>
       <span class="token function">ioctl</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>dpyAttr<span class="token punctuation">[</span>dpy<span class="token punctuation">]</span><span class="token punctuation">.</span>fd<span class="token punctuation">,</span> MSMFB_OVERLAY_VSYNC_CTRL<span class="token punctuation">,</span>
             <span class="token operator">&amp;</span>enable<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>errno<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会通过ioctl发送一个MSMFB_OVERLAY_VSYNC_CTRL命令，告诉底层GPU是否继续发送vsync。</p>
<p>此时如果是软件模拟vsync，则只是在用户空间创建的一个线程在模拟运作，每一次停止16.666ms后，判断enable标志为，判断是否需要回调到SF中：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">LIKELY</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>fakevsync<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment" spellcheck="true">//阻塞获取硬件发送的vsync信号</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">16666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cur_timestamp <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// send timestamp to HAL</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>vstate<span class="token punctuation">.</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token operator">-</span><span class="token operator">></span><span class="token function">vsync</span><span class="token punctuation">(</span>ctx<span class="token operator">-</span><span class="token operator">></span>proc<span class="token punctuation">,</span> dpy<span class="token punctuation">,</span> cur_timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们探明了本质上vsync在底层中的暂停和运行机制，那么哪里进行了整个vsync的监听呢？其实在SurfaceFlinger的Hal层初始化已经提到过了。EventThread::requestNextVsync方法中把EventThread的阻塞打开了，将会运行监听添加删除以及监听回调的工作。</p>
<h3 id="Vsync-监听逻辑"><a href="#Vsync-监听逻辑" class="headerlink" title="Vsync 监听逻辑"></a>Vsync 监听逻辑</h3><p>EventThread中的线程中有这么一个Looper：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/EventThread.cpp" target="_blank" rel="noopener">EventThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventThread<span class="token operator">::</span><span class="token function">threadMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span> NO_THREAD_SAFETY_ANALYSIS <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>mKeepRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DisplayEventReceiver<span class="token operator">::</span>Event event<span class="token punctuation">;</span>
        Vector<span class="token operator">&lt;</span>sp<span class="token operator">&lt;</span>EventThread<span class="token operator">::</span>Connection<span class="token operator">></span> <span class="token operator">></span> signalConnections<span class="token punctuation">;</span>
        signalConnections <span class="token operator">=</span> <span class="token function">waitForEventLocked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>lock<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// dispatch events to listeners...</span>
        <span class="token keyword">const</span> size_t count <span class="token operator">=</span> signalConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span><span class="token operator">&amp;</span> <span class="token function">conn</span><span class="token punctuation">(</span>signalConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            status_t err <span class="token operator">=</span> conn<span class="token operator">-</span><span class="token operator">></span><span class="token function">postEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span>EAGAIN <span class="token operator">||</span> err <span class="token operator">==</span> <span class="token operator">-</span>EWOULDBLOCK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">removeDisplayEventConnectionLocked</span><span class="token punctuation">(</span>signalConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个Looper会被waitForEventLocked调用Condition给阻塞起来。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Vector<span class="token operator">&lt;</span>sp<span class="token operator">&lt;</span>EventThread<span class="token operator">::</span>Connection<span class="token operator">></span> <span class="token operator">></span> EventThread<span class="token operator">::</span><span class="token function">waitForEventLocked</span><span class="token punctuation">(</span>
        std<span class="token operator">::</span>unique_lock<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span><span class="token operator">*</span> lock<span class="token punctuation">,</span> DisplayEventReceiver<span class="token operator">::</span>Event<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Vector<span class="token operator">&lt;</span>sp<span class="token operator">&lt;</span>EventThread<span class="token operator">::</span>Connection<span class="token operator">></span> <span class="token operator">></span> signalConnections<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>signalConnections<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mKeepRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">bool</span> eventPending <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> waitForVSync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        size_t vsyncCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        nsecs_t timestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int32_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DisplayDevice<span class="token operator">::</span>NUM_BUILTIN_DISPLAY_TYPES<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timestamp <span class="token operator">=</span> mVSyncEvent<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// we have a vsync event to dispatch</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mInterceptVSyncsCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">mInterceptVSyncsCallback</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token operator">*</span>event <span class="token operator">=</span> mVSyncEvent<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                mVSyncEvent<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                vsyncCount <span class="token operator">=</span> mVSyncEvent<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// no vsync event, see if there are some other event</span>
            eventPending <span class="token operator">=</span> <span class="token operator">!</span>mPendingEvents<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>eventPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token operator">*</span>event <span class="token operator">=</span> mPendingEvents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                mPendingEvents<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// find out connections waiting for events</span>
        size_t count <span class="token operator">=</span> mDisplayEventConnections<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            sp<span class="token operator">&lt;</span>Connection<span class="token operator">></span> <span class="token function">connection</span><span class="token punctuation">(</span>mDisplayEventConnections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">promote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>connection <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">bool</span> added <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>count <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    waitForVSync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token comment" spellcheck="true">// fired this time around</span>
                            connection<span class="token operator">-</span><span class="token operator">></span>count <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                            signalConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            added <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>connection<span class="token operator">-</span><span class="token operator">></span>count <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span>
                                   <span class="token punctuation">(</span>vsyncCount <span class="token operator">%</span> connection<span class="token operator">-</span><span class="token operator">></span>count<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            signalConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            added <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>eventPending <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>timestamp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>added<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    signalConnections<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token operator">++</span>i<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// we couldn't promote this reference, the connection has</span>
                <span class="token comment" spellcheck="true">// died, so clean-up!</span>
                mDisplayEventConnections<span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">--</span>count<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Here we figure out if we need to enable or disable vsyncs</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>waitForVSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">disableVSyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timestamp <span class="token operator">&amp;&amp;</span> waitForVSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">enableVSyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timestamp <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>eventPending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>waitForVSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">bool</span> softwareSync <span class="token operator">=</span> mUseSoftwareVSync<span class="token punctuation">;</span>
                <span class="token keyword">auto</span> timeout <span class="token operator">=</span> softwareSync <span class="token operator">?</span> 16ms <span class="token operator">:</span> 1000ms<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mCondition<span class="token punctuation">.</span><span class="token function">wait_for</span><span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span> <span class="token operator">==</span> std<span class="token operator">::</span>cv_status<span class="token operator">::</span>timeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>softwareSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Timed out waiting for hw vsync; faking it"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">;</span>
                    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>id <span class="token operator">=</span> DisplayDevice<span class="token operator">::</span>DISPLAY_PRIMARY<span class="token punctuation">;</span>
                    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mCondition<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token operator">*</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> signalConnections<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程中，timestamp为0且waitForVSync为true则会通过enableVSyncLocked打开进行Vsync信号的监听，说明是第一次打开。如果timestamp不为0，且waitForVSync为false，则说明是从打开到关闭的状态，将会调用disableVSyncLocked。</p>
<p>timestamp是记录每一次打开开始之后开始记录每一次Vsync的时间，waitForVSync则是判断是否有外部应用设置监听到EventThread中。有则会为true。</p>
<p>还记得在EventThread::requestNextVsync中唤醒的阻塞的Condition实际上就是这个循环最后的mCondition。</p>
<p>打开阻塞之后，将会到threadMain中，把信号发送出去。</p>
<h3 id="EventThread-enableVSyncLocked"><a href="#EventThread-enableVSyncLocked" class="headerlink" title="EventThread::enableVSyncLocked"></a>EventThread::enableVSyncLocked</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventThread<span class="token operator">::</span><span class="token function">enableVSyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mUseSoftwareVSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// never enable h/w VSYNC when screen is off</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mVsyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mVsyncEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            mVSyncSource<span class="token operator">-</span><span class="token operator">></span><span class="token function">setCallback</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mVSyncSource<span class="token operator">-</span><span class="token operator">></span><span class="token function">setVSyncEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    mDebugVsyncEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果不是使用软件渲染，则会把EventThread添加一个监听到mVSyncSource也就是DispSyncSource中，并且调用DispSyncSource的setVSyncEnabled。</p>
<h4 id="DispSyncSource-setCallback"><a href="#DispSyncSource-setCallback" class="headerlink" title="DispSyncSource setCallback"></a>DispSyncSource setCallback</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">setCallback</span><span class="token punctuation">(</span>VSyncSource<span class="token operator">::</span>Callback<span class="token operator">*</span> callback<span class="token punctuation">)</span> override<span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCallbackMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>记住就在这里设置监听了，免得之后找不到了。</p>
<h4 id="DispSyncSource-setVSyncEnabled"><a href="#DispSyncSource-setVSyncEnabled" class="headerlink" title="DispSyncSource setVSyncEnabled"></a>DispSyncSource setVSyncEnabled</h4><pre class="line-numbers language-cpp"><code class="language-cpp"> <span class="token keyword">void</span> <span class="token function">setVSyncEnabled</span><span class="token punctuation">(</span><span class="token keyword">bool</span> enable<span class="token punctuation">)</span> override <span class="token punctuation">{</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mVsyncMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>enable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            status_t err <span class="token operator">=</span> mDispSync<span class="token operator">-</span><span class="token operator">></span><span class="token function">addEventListener</span><span class="token punctuation">(</span>mName<span class="token punctuation">,</span> mPhaseOffset<span class="token punctuation">,</span>
                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>DispSync<span class="token operator">::</span>Callback<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"error registering vsync callback: %s (%d)"</span><span class="token punctuation">,</span>
                        <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//ATRACE_INT(mVsyncOnLabel.string(), 1);</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            status_t err <span class="token operator">=</span> mDispSync<span class="token operator">-</span><span class="token operator">></span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>
                    <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>DispSync<span class="token operator">::</span>Callback<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">!=</span> NO_ERROR<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"error unregistering vsync callback: %s (%d)"</span><span class="token punctuation">,</span>
                        <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment" spellcheck="true">//ATRACE_INT(mVsyncOnLabel.string(), 0);</span>
        <span class="token punctuation">}</span>
        mEnabled <span class="token operator">=</span> enable<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果允许Vsync的监听，则把DispSyncSource注册到DispSync中，否则则移除出来。</p>
<h5 id="DispSync-addEventListener"><a href="#DispSync-addEventListener" class="headerlink" title="DispSync addEventListener"></a>DispSync addEventListener</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DispSync.cpp" target="_blank" rel="noopener">DispSync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t <span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> nsecs_t phase<span class="token punctuation">,</span> DispSync<span class="token operator">::</span>Callback<span class="token operator">*</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mEventListeners<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mEventListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mCallback <span class="token operator">==</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        EventListener listener<span class="token punctuation">;</span>
        listener<span class="token punctuation">.</span>mName <span class="token operator">=</span> name<span class="token punctuation">;</span>
        listener<span class="token punctuation">.</span>mPhase <span class="token operator">=</span> phase<span class="token punctuation">;</span>
        listener<span class="token punctuation">.</span>mCallback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
        listener<span class="token punctuation">.</span>mLastEventTime <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> mPeriod <span class="token operator">/</span> <span class="token number">2</span> <span class="token operator">+</span> mPhase <span class="token operator">-</span> mWakeupLatency<span class="token punctuation">;</span>

        mEventListeners<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCond<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上很简答，这里就解释了DispSync中threadLoop需要唤醒的监听是从哪里来的，就是在DispSyncSource的setVsyncEnable方法时候，把Callback添加到DispSync的mEventListeners集合中，等待被唤醒。</p>
<h4 id="Vsync监听回调逻辑"><a href="#Vsync监听回调逻辑" class="headerlink" title="Vsync监听回调逻辑"></a>Vsync监听回调逻辑</h4><p>让我们把目光集中回DispSync中。当DispSync计算出需要唤醒的时间之后，进行解锁，将会调用如下方法：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">void</span> <span class="token function">fireCallbackInvocations</span><span class="token punctuation">(</span><span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>CallbackInvocation<span class="token operator">></span><span class="token operator">&amp;</span> callbacks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> callbacks<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mCallback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onDispSyncEvent</span><span class="token punctuation">(</span>callbacks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mEventTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而此时的Callback实际上就是DispSyncSource的onDispSyncEvent。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onDispSyncEvent</span><span class="token punctuation">(</span>nsecs_t when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        VSyncSource<span class="token operator">::</span>Callback<span class="token operator">*</span> callback<span class="token punctuation">;</span>
        <span class="token punctuation">{</span>
            Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mCallbackMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callback <span class="token operator">=</span> mCallback<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mTraceVsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mValue <span class="token operator">=</span> <span class="token punctuation">(</span>mValue <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token function">ATRACE_INT</span><span class="token punctuation">(</span>mVsyncEventLabel<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            callback<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVSyncEvent</span><span class="token punctuation">(</span>when<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个callback其实就是EventThread注册的回调，也就是EventThread::onVSyncEvent。</p>
<h4 id="EventThread-onVSyncEvent"><a href="#EventThread-onVSyncEvent" class="headerlink" title="EventThread::onVSyncEvent"></a>EventThread::onVSyncEvent</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/EventThread.cpp" target="_blank" rel="noopener">EventThread.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> EventThread<span class="token operator">::</span><span class="token function">onVSyncEvent</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token operator">::</span>mutex<span class="token operator">></span> <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>type <span class="token operator">=</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_VSYNC<span class="token punctuation">;</span>
    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
    mVSyncEvent<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    mCondition<span class="token punctuation">.</span><span class="token function">notify_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时会把DispSync通过computeNextEventTimeLocked计算出来Vsync预期需要发送的时间。此时通过mCondition唤醒waitForEventLocked中的阻塞，发送通过socket正在监听EventThread。这一块的逻辑可以阅读，我写的<a href="https://www.jianshu.com/p/9dac91bbb9c9" target="_blank" rel="noopener">SurfaceFlinger 的初始化</a>一文。</p>
<p>在SurfaceFlinger中有2中EventThread，一种是名为sf的EventThread，一种是名为app的EventThread。</p>
<p>最终在名字为sf的EventThread中最终以Vsync信号到达的基准，执行对应的Handler的回调。</p>
<p>sf的EventThread，我们明白了，那么app的EventThread又是做了什么。这两者又有什么区别呢？</p>
<h3 id="sf的EventThread和app的EventThread的区别"><a href="#sf的EventThread和app的EventThread的区别" class="headerlink" title="sf的EventThread和app的EventThread的区别"></a>sf的EventThread和app的EventThread的区别</h3><h4 id="app的EventThread"><a href="#app的EventThread" class="headerlink" title="app的EventThread"></a>app的EventThread</h4><p>先来看看app的EventThread：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">mEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span> SurfaceFlinger<span class="token operator">::</span>vsyncPhaseOffsetNs<span class="token punctuation">,</span>
                                             <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"app"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mEventThread <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                       impl<span class="token operator">::</span>EventThread<span class="token operator">::</span><span class="token function">InterceptVSyncsCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                       <span class="token string">"appEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">    vsyncPhaseOffsetNs <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>vsyncEventPhaseOffsetNs<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>设置了DispSyncSource的的Phase为vsyncPhaseOffsetNs，也就是1000000ns(VSYNC_EVENT_PHASE_OFFSET_NS mk中配置0.002s)。其中EventThread::InterceptVSyncsCallback()是一个空函数，我们不用去管它。</p>
<h4 id="sf的EventThread"><a href="#sf的EventThread" class="headerlink" title="sf的EventThread"></a>sf的EventThread</h4><p>再来看看sf中的EventThread的实例化</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">   mSfEventThreadSource <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>DispSyncSource<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mPrimaryDispSync<span class="token punctuation">,</span>
                                             SurfaceFlinger<span class="token operator">::</span>sfVsyncPhaseOffsetNs<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"sf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mSFEventThread <span class="token operator">=</span>
            std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>impl<span class="token operator">::</span>EventThread<span class="token operator">></span><span class="token punctuation">(</span>mSfEventThreadSource<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">resyncWithRateLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                                    mInterceptor<span class="token operator">-</span><span class="token operator">></span><span class="token function">saveVSyncEvent</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                                                <span class="token string">"sfEventThread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mEventQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">setEventThread</span><span class="token punctuation">(</span>mSFEventThread<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">    sfVsyncPhaseOffsetNs <span class="token operator">=</span> getInt64<span class="token operator">&lt;</span> ISurfaceFlingerConfigs<span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>ISurfaceFlingerConfigs<span class="token operator">::</span>vsyncSfEventPhaseOffsetNs<span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>同理，sf的EventThread的也是基于同一个mPrimaryDispSync也就是DispSync，设置了SF_VSYNC_EVENT_PHASE_OFFSET_NS(mk中的设置0.006s)的phase。</p>
<p>app和sf中设置的10ms的Phase(相位), 就是我在概述中聊到过的两个控制同步信号的Phase。</p>
<p>同时设置了mInterceptor-&gt;saveVSyncEvent(timestamp)方法指针到其中进行拦截。而这个方法其实就是记录每一次发送的Vsync到一个SurfaceInterceptor。</p>
<p>唯一和app的EventThread不同的是，SF中的MessageQueue注册了对sf的EventThread的监听。</p>
<p>那么哪里监听了代表了app应用进程的EventThread呢？</p>
<h2 id="App应用监听SF中的appEventThread"><a href="#App应用监听SF中的appEventThread" class="headerlink" title="App应用监听SF中的appEventThread"></a>App应用监听SF中的appEventThread</h2><h3 id="Choreographer的初始化"><a href="#Choreographer的初始化" class="headerlink" title="Choreographer的初始化"></a>Choreographer的初始化</h3><p>如果熟知View的绘制流程的哥们应该就能清楚，在ViewRootImpl中如何知道什么开始刷新View，其实有一个核心类Choregrapher。这个类，经常出现在我们视野里面。如果阅读Lottie的源码还是性能优化的帧数检测，都是通过注册这个类的监听得到的。监听方法如下：</p>
<pre class="line-numbers language-java"><code class="language-java">mChoreographer<span class="token punctuation">.</span><span class="token function">postCallback</span><span class="token punctuation">(</span>
                    Choreographer<span class="token punctuation">.</span>CALLBACK_TRAVERSAL<span class="token punctuation">,</span> mTraversalRunnable<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>其实，我们猜都能猜到Choreographer肯定是监听了SurfaceFlinger的VSync同步信号。我们来看看Choreographer的构造函数：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/Choreographer.java" target="_blank" rel="noopener">Choreographer.java</a><br>是一个单例：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> Choreographer <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sThreadInstance<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> ThreadLocal<span class="token operator">&lt;</span>Choreographer<span class="token operator">></span> sThreadInstance <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadLocal</span><span class="token operator">&lt;</span>Choreographer<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> Choreographer <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Looper looper <span class="token operator">=</span> Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>looper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"The current thread must have a looper!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            Choreographer choreographer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Choreographer</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> VSYNC_SOURCE_APP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>looper <span class="token operator">==</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mMainInstance <span class="token operator">=</span> choreographer<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> choreographer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上Choreographer是一个线程本地对象，在其里面实例化了choreographer。这种方式很值得我们学习，这样就没必要使用volatile和synchronized修饰属性和方法。</p>
<p>这种方式可以提高JVM下的性能，因为volatile在解释执行中，判断到属性带了volatile，则会使用order和atomic的模版类修饰Object。如果带了synchronized修饰，则会为方法带上monitor_enter的指令，会对该代码区域进行胖锁瘦锁的策略调整，瘦锁通过scheme简单的切换进程(超过50次没机会获取转化胖锁)，胖锁则是通过一个mmap内存映射的锁futex(可以不访问内核)进行上锁。详细等后面有时间开启的JVM源码解析和大家聊聊。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">private</span> <span class="token function">Choreographer</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">,</span> <span class="token keyword">int</span> vsyncSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mLooper <span class="token operator">=</span> looper<span class="token punctuation">;</span>
        mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">FrameHandler</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mDisplayEventReceiver <span class="token operator">=</span> USE_VSYNC
                <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token function">FrameDisplayEventReceiver</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> vsyncSource<span class="token punctuation">)</span>
                <span class="token operator">:</span> null<span class="token punctuation">;</span>
        mLastFrameTimeNanos <span class="token operator">=</span> Long<span class="token punctuation">.</span>MIN_VALUE<span class="token punctuation">;</span>

        mFrameIntervalNanos <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1000000000</span> <span class="token operator">/</span> <span class="token function">getRefreshRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCallbackQueues <span class="token operator">=</span> <span class="token keyword">new</span> CallbackQueue<span class="token punctuation">[</span>CALLBACK_LAST <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> CALLBACK_LAST<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mCallbackQueues<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">CallbackQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// b/68769804: For low FPS experiments.</span>
        <span class="token function">setFPSDivisor</span><span class="token punctuation">(</span>SystemProperties<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>ThreadedRenderer<span class="token punctuation">.</span>DEBUG_FPS_DIVISOR<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里面有两个核心的类FrameDisplayEventReceiver和FrameHandler,他们共用一个Looper。这两个类才是真正的核心，先来看看FrameDisplayEventReceiver的初始化。</p>
<p>先来看简单的FrameHandler。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FrameHandler</span> <span class="token keyword">extends</span> <span class="token class-name">Handler</span> <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token function">FrameHandler</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span>Message msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> MSG_DO_FRAME<span class="token operator">:</span>
                    <span class="token function">doFrame</span><span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> MSG_DO_SCHEDULE_VSYNC<span class="token operator">:</span>
                    <span class="token function">doScheduleVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> MSG_DO_SCHEDULE_CALLBACK<span class="token operator">:</span>
                    <span class="token function">doScheduleCallback</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>arg1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>FrameHandler处理了三个消息：</p>
<ul>
<li>1.MSG_DO_FRAME 处理注册在Choreographer 的Runnable</li>
<li>2.MSG_DO_SCHEDULE_VSYNC 直接请求下一帧的VSync信号</li>
<li>3.MSG_DO_SCHEDULE_CALLBACK 根据Choreographer的配置执行合适的Handler延时处理。</li>
</ul>
<h4 id="FrameDisplayEventReceiver-初始化"><a href="#FrameDisplayEventReceiver-初始化" class="headerlink" title="FrameDisplayEventReceiver 初始化"></a>FrameDisplayEventReceiver 初始化</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">FrameDisplayEventReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">DisplayEventReceiver</span>
            <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> mHavePendingVsync<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span> mTimestampNanos<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> mFrame<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token function">FrameDisplayEventReceiver</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">,</span> <span class="token keyword">int</span> vsyncSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>looper<span class="token punctuation">,</span> vsyncSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个类基础了DisplayEventReceiver，我们再去看看DisplayEventReceiver的实现。</p>
<h5 id="DisplayEventReceiver-初始化"><a href="#DisplayEventReceiver-初始化" class="headerlink" title="DisplayEventReceiver 初始化"></a>DisplayEventReceiver 初始化</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">DisplayEventReceiver</span><span class="token punctuation">(</span>Looper looper<span class="token punctuation">,</span> <span class="token keyword">int</span> vsyncSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>looper <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"looper must not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mMessageQueue <span class="token operator">=</span> looper<span class="token punctuation">.</span><span class="token function">getQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mReceiverPtr <span class="token operator">=</span> <span class="token function">nativeInit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token operator">&lt;</span>DisplayEventReceiver<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mMessageQueue<span class="token punctuation">,</span>
                vsyncSource<span class="token punctuation">)</span><span class="token punctuation">;</span>

        mCloseGuard<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"dispose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个过程，把MessageQueue设置到native层中，初始化了native层中DisplayEventReceiver。</p>
<h5 id="native中DisplayEventReceiver的初始化"><a href="#native中DisplayEventReceiver的初始化" class="headerlink" title="native中DisplayEventReceiver的初始化"></a>native中DisplayEventReceiver的初始化</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/" target="_blank" rel="noopener">jni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/jni/android_view_DisplayEventReceiver.cpp" target="_blank" rel="noopener">android_view_DisplayEventReceiver.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">nativeInit</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jclass <span class="token class-name">clazz</span><span class="token punctuation">,</span> jobject receiverWeak<span class="token punctuation">,</span>
        jobject messageQueueObj<span class="token punctuation">,</span> jint vsyncSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>MessageQueue<span class="token operator">></span> messageQueue <span class="token operator">=</span> <span class="token function">android_os_MessageQueue_getMessageQueue</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> messageQueueObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>messageQueue <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">jniThrowRuntimeException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"MessageQueue is not initialized."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sp<span class="token operator">&lt;</span>NativeDisplayEventReceiver<span class="token operator">></span> receiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">NativeDisplayEventReceiver</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>
            receiverWeak<span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> vsyncSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    status_t status <span class="token operator">=</span> receiver<span class="token operator">-</span><span class="token operator">></span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    receiver<span class="token operator">-</span><span class="token operator">></span><span class="token function">incStrong</span><span class="token punctuation">(</span>gDisplayEventReceiverClassInfo<span class="token punctuation">.</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// retain a reference for the object</span>
    <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>receiver<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里实际上就是从MessageQueue中获取native队形设置到NativeDisplayEventReceiver，进行初始化，并调用initialize方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">DisplayEventDispatcher<span class="token operator">::</span><span class="token function">DisplayEventDispatcher</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token operator">&lt;</span>Looper<span class="token operator">></span><span class="token operator">&amp;</span> looper<span class="token punctuation">,</span>
        ISurfaceComposer<span class="token operator">::</span>VsyncSource vsyncSource<span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">mLooper</span><span class="token punctuation">(</span>looper<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mReceiver</span><span class="token punctuation">(</span>vsyncSource<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">mWaitingForVsync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"dispatcher %p ~ Initializing display event dispatcher."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

status_t DisplayEventDispatcher<span class="token operator">::</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    status_t result <span class="token operator">=</span> mReceiver<span class="token punctuation">.</span><span class="token function">initCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Failed to initialize display event receiver, status=%d"</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> rc <span class="token operator">=</span> mLooper<span class="token operator">-</span><span class="token operator">></span><span class="token function">addFd</span><span class="token punctuation">(</span>mReceiver<span class="token punctuation">.</span><span class="token function">getFd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> Looper<span class="token operator">::</span>EVENT_INPUT<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> UNKNOWN_ERROR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个方法实际上就是实例化了DisplayEventDispatcher对象，并获取mReceiver中的文件描述符，加入到Looper的监听。而mReceiver就是指DisplayEventReceiver对象，不过这个是在native对应的对象。</p>
<h4 id="DisplayEventReceiver初始化"><a href="#DisplayEventReceiver初始化" class="headerlink" title="DisplayEventReceiver初始化"></a>DisplayEventReceiver初始化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">DisplayEventReceiver<span class="token operator">::</span><span class="token function">DisplayEventReceiver</span><span class="token punctuation">(</span>ISurfaceComposer<span class="token operator">::</span>VsyncSource vsyncSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    sp<span class="token operator">&lt;</span>ISurfaceComposer<span class="token operator">></span> <span class="token function">sf</span><span class="token punctuation">(</span>ComposerService<span class="token operator">::</span><span class="token function">getComposerService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sf <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mEventConnection <span class="token operator">=</span> sf<span class="token operator">-</span><span class="token operator">></span><span class="token function">createDisplayEventConnection</span><span class="token punctuation">(</span>vsyncSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mEventConnection <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mDataChannel <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>gui<span class="token operator">::</span>BitTube<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mEventConnection<span class="token operator">-</span><span class="token operator">></span><span class="token function">stealReceiveChannel</span><span class="token punctuation">(</span>mDataChannel<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

DisplayEventReceiver<span class="token operator">::</span><span class="token operator">~</span><span class="token function">DisplayEventReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

status_t DisplayEventReceiver<span class="token operator">::</span><span class="token function">initCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mDataChannel <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> NO_ERROR<span class="token punctuation">;</span>
    <span class="token keyword">return</span> NO_INIT<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到在DisplayEventReceiver会通过ComposerService获取SurfaceFlinger对应的Binder服务端的代理对象。</p>
<ul>
<li>1.调用createDisplayEventConnection 监听SF的Vsync的事件</li>
<li>2.stealReceiveChannel 获取BitTube中接收端的socket 的文件句柄。</li>
</ul>
<p>我们直接看SurfaceFlinger的createDisplayEventConnection。</p>
<h4 id="SurfaceFlinger的createDisplayEventConnection"><a href="#SurfaceFlinger的createDisplayEventConnection" class="headerlink" title="SurfaceFlinger的createDisplayEventConnection"></a>SurfaceFlinger的createDisplayEventConnection</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">sp<span class="token operator">&lt;</span>IDisplayEventConnection<span class="token operator">></span> SurfaceFlinger<span class="token operator">::</span><span class="token function">createDisplayEventConnection</span><span class="token punctuation">(</span>
        ISurfaceComposer<span class="token operator">::</span>VsyncSource vsyncSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vsyncSource <span class="token operator">==</span> eVsyncSourceSurfaceFlinger<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mSFEventThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">createEventConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mEventThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">createEventConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实面向App应用可以注册监听两者Vsync事件，一个是SurfaceFlinger的EventThread，不过这在Choreographer是隐藏的。另一个就是调用mEventThread的createEventConnection，注册一个EventThread::Connection到appEventThread。</p>
<p>从这里开始就可以通过EventThread进行appEventThread的监听，后续的原理可以阅读<a href="https://www.jianshu.com/p/9dac91bbb9c9" target="_blank" rel="noopener">SurfaceFlinger 的初始化</a>一文。</p>
<p>由于此时把EventThread对应的socket注册到Looper中监听，如果一旦appEventThread有VSync事件来了，将会唤醒Looper的阻塞。</p>
<p>当VSync事件来了将会执行native中MessageQueue的如下代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"> <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mResponses<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Response<span class="token operator">&amp;</span> response <span class="token operator">=</span> mResponses<span class="token punctuation">.</span><span class="token function">editItemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>ident <span class="token operator">==</span> POLL_CALLBACK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> fd <span class="token operator">=</span> response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
            <span class="token keyword">int</span> events <span class="token operator">=</span> response<span class="token punctuation">.</span>events<span class="token punctuation">;</span>
            <span class="token keyword">void</span><span class="token operator">*</span> data <span class="token operator">=</span> response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

            <span class="token keyword">int</span> callbackResult <span class="token operator">=</span> response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>callback<span class="token operator">-</span><span class="token operator">></span><span class="token function">handleEvent</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>callbackResult <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">removeFd</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            response<span class="token punctuation">.</span>request<span class="token punctuation">.</span>callback<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> POLL_CALLBACK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>换句话说就是回调到当前DisplayEventReceiver的handleEvent方法。</p>
<h4 id="DisplayEventReceiver-handleEvent接受处理SF的VSync事件"><a href="#DisplayEventReceiver-handleEvent接受处理SF的VSync事件" class="headerlink" title="DisplayEventReceiver handleEvent接受处理SF的VSync事件"></a>DisplayEventReceiver handleEvent接受处理SF的VSync事件</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> DisplayEventDispatcher<span class="token operator">::</span><span class="token function">handleEvent</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span> events<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token comment" spellcheck="true">// Drain all pending events, keep the last vsync.</span>
    nsecs_t vsyncTimestamp<span class="token punctuation">;</span>
    int32_t vsyncDisplayId<span class="token punctuation">;</span>
    uint32_t vsyncCount<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">processPendingEvents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vsyncTimestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vsyncDisplayId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vsyncCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mWaitingForVsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token function">dispatchVsync</span><span class="token punctuation">(</span>vsyncTimestamp<span class="token punctuation">,</span> vsyncDisplayId<span class="token punctuation">,</span> vsyncCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// keep the callback</span>
<span class="token punctuation">}</span>
<span class="token keyword">bool</span> DisplayEventDispatcher<span class="token operator">::</span><span class="token function">processPendingEvents</span><span class="token punctuation">(</span>
        nsecs_t<span class="token operator">*</span> outTimestamp<span class="token punctuation">,</span> int32_t<span class="token operator">*</span> outId<span class="token punctuation">,</span> uint32_t<span class="token operator">*</span> outCount<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">bool</span> gotVsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    DisplayEventReceiver<span class="token operator">::</span>Event buf<span class="token punctuation">[</span>EVENT_BUFFER_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    ssize_t n<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>n <span class="token operator">=</span> mReceiver<span class="token punctuation">.</span><span class="token function">getEvents</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> EVENT_BUFFER_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>ssize_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> DisplayEventReceiver<span class="token operator">::</span>Event<span class="token operator">&amp;</span> ev <span class="token operator">=</span> buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>header<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_VSYNC<span class="token operator">:</span>
                gotVsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>outTimestamp <span class="token operator">=</span> ev<span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp<span class="token punctuation">;</span>
                <span class="token operator">*</span>outId <span class="token operator">=</span> ev<span class="token punctuation">.</span>header<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
                <span class="token operator">*</span>outCount <span class="token operator">=</span> ev<span class="token punctuation">.</span>vsync<span class="token punctuation">.</span>count<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> DisplayEventReceiver<span class="token operator">::</span>DISPLAY_EVENT_HOTPLUG<span class="token operator">:</span>
                <span class="token function">dispatchHotplug</span><span class="token punctuation">(</span>ev<span class="token punctuation">.</span>header<span class="token punctuation">.</span>timestamp<span class="token punctuation">,</span> ev<span class="token punctuation">.</span>header<span class="token punctuation">.</span>id<span class="token punctuation">,</span> ev<span class="token punctuation">.</span>hotplug<span class="token punctuation">.</span>connected<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>

                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> gotVsync<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这段函数会通过processPendingEvents从socket中读取数据出来，并且通过dispatchVsync传递vsync的时间戳，ID,迭代次数等。</p>
<h4 id="NativeDisplayEventReceiver-dispatchVsync"><a href="#NativeDisplayEventReceiver-dispatchVsync" class="headerlink" title="NativeDisplayEventReceiver dispatchVsync"></a>NativeDisplayEventReceiver dispatchVsync</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> NativeDisplayEventReceiver<span class="token operator">::</span><span class="token function">dispatchVsync</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">,</span> int32_t id<span class="token punctuation">,</span> uint32_t count<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> AndroidRuntime<span class="token operator">::</span><span class="token function">getJNIEnv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ScopedLocalRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span> <span class="token function">receiverObj</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token function">jniGetReferent</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> mReceiverWeakGlobal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>receiverObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>receiverObj<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                gDisplayEventReceiverClassInfo<span class="token punctuation">.</span>dispatchVsync<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> id<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    mMessageQueue<span class="token operator">-</span><span class="token operator">></span><span class="token function">raiseAndClearException</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"dispatchVsync"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是反射Java层的dispatchVsync方法。</p>
<h4 id="Java层的dispatchVsync"><a href="#Java层的dispatchVsync" class="headerlink" title="Java层的dispatchVsync"></a>Java层的dispatchVsync</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/" target="_blank" rel="noopener">base</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/" target="_blank" rel="noopener">core</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/" target="_blank" rel="noopener">android</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/" target="_blank" rel="noopener">view</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/view/DisplayEventReceiver.java" target="_blank" rel="noopener">DisplayEventReceiver.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchVsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestampNanos<span class="token punctuation">,</span> <span class="token keyword">int</span> builtInDisplayId<span class="token punctuation">,</span> <span class="token keyword">int</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">onVsync</span><span class="token punctuation">(</span>timestampNanos<span class="token punctuation">,</span> builtInDisplayId<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>会继续回调到FrameDisplayEventReceiver中的onVsync回调。</p>
<h4 id="FrameDisplayEventReceiver-onVsync"><a href="#FrameDisplayEventReceiver-onVsync" class="headerlink" title="FrameDisplayEventReceiver onVsync"></a>FrameDisplayEventReceiver onVsync</h4><pre class="line-numbers language-java"><code class="language-java"> <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onVsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> timestampNanos<span class="token punctuation">,</span> <span class="token keyword">int</span> builtInDisplayId<span class="token punctuation">,</span> <span class="token keyword">int</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>builtInDisplayId <span class="token operator">!=</span> SurfaceControl<span class="token punctuation">.</span>BUILT_IN_DISPLAY_ID_MAIN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scheduleVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">long</span> now <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>timestampNanos <span class="token operator">></span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                timestampNanos <span class="token operator">=</span> now<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mHavePendingVsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                mHavePendingVsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            mTimestampNanos <span class="token operator">=</span> timestampNanos<span class="token punctuation">;</span>
            mFrame <span class="token operator">=</span> frame<span class="token punctuation">;</span>
            Message msg <span class="token operator">=</span> Message<span class="token punctuation">.</span><span class="token function">obtain</span><span class="token punctuation">(</span>mHandler<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> timestampNanos <span class="token operator">/</span> TimeUtils<span class="token punctuation">.</span>NANOS_PER_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mHavePendingVsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token function">doFrame</span><span class="token punctuation">(</span>mTimestampNanos<span class="token punctuation">,</span> mFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果不是主屏幕，则调用scheduleVsync，进行下一帧的请求。如果回调回来的时间比当前大，则timestampNanos直接取当前时间。直接执行sendMessageAtTime，在timestampNanos执行当前的run方法，因为FrameDisplayEventReceiver实现了Runnable。核心是doFrame方法，执行从Choreographer通过postCallback注册进来的Runnable方法。</p>
<h2 id="Choreographer-postCallbackDelayedInternal"><a href="#Choreographer-postCallbackDelayedInternal" class="headerlink" title="Choreographer postCallbackDelayedInternal"></a>Choreographer postCallbackDelayedInternal</h2><p>在Choreographer调用postCallback时候，判断如果需要回调的时间小于当前时间，如果开启了则会走scheduleFrameLocked；如果当前时间大于回调时间，则不需要VSync的回调，立即走FrameHandler逻辑，如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">postCallbackDelayedInternal</span><span class="token punctuation">(</span><span class="token keyword">int</span> callbackType<span class="token punctuation">,</span>
            Object action<span class="token punctuation">,</span> Object token<span class="token punctuation">,</span> <span class="token keyword">long</span> delayMillis<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            final <span class="token keyword">long</span> now <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            final <span class="token keyword">long</span> dueTime <span class="token operator">=</span> now <span class="token operator">+</span> delayMillis<span class="token punctuation">;</span>
            mCallbackQueues<span class="token punctuation">[</span>callbackType<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">addCallbackLocked</span><span class="token punctuation">(</span>dueTime<span class="token punctuation">,</span> action<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>dueTime <span class="token operator">&lt;=</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scheduleFrameLocked</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_DO_SCHEDULE_CALLBACK<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span>arg1 <span class="token operator">=</span> callbackType<span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> dueTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="scheduleFrameLocked"><a href="#scheduleFrameLocked" class="headerlink" title="scheduleFrameLocked"></a>scheduleFrameLocked</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleFrameLocked</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mFrameScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>USE_VSYNC<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunningOnLooperThreadLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleVsyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_DO_SCHEDULE_VSYNC<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtFrontOfQueue</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> nextFrameTime <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>
                        mLastFrameTimeNanos <span class="token operator">/</span> TimeUtils<span class="token punctuation">.</span>NANOS_PER_MS <span class="token operator">+</span> sFrameDelay<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Message msg <span class="token operator">=</span> mHandler<span class="token punctuation">.</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span>MSG_DO_FRAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
                msg<span class="token punctuation">.</span><span class="token function">setAsynchronous</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mHandler<span class="token punctuation">.</span><span class="token function">sendMessageAtTime</span><span class="token punctuation">(</span>msg<span class="token punctuation">,</span> nextFrameTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.如果使用了VSync信号的监听，如果通过isRunningOnLooperThreadLocked判断注册的监听是主线程准确点说是Choreograoher注册的线程，则会走scheduleVsyncLocked。否则通过Handler发送一个MSG_DO_SCHEDULE_VSYNC消息到handler的MessageQueue的顶部。</p>
</li>
<li><ol start="2">
<li>如果关闭了VSync信号的监听，则会直接延时10ms发送MSG_DO_FRAME处理下一帧的绘制行为.<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">private</span> <span class="token keyword">static</span> final <span class="token keyword">long</span> DEFAULT_FRAME_DELAY <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
</li>
</ul>
<h4 id="scheduleVsyncLocked"><a href="#scheduleVsyncLocked" class="headerlink" title="scheduleVsyncLocked"></a>scheduleVsyncLocked</h4><pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleVsyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mDisplayEventReceiver<span class="token punctuation">.</span><span class="token function">scheduleVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>对应的native方法如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">status_t DisplayEventDispatcher<span class="token operator">::</span><span class="token function">scheduleVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mWaitingForVsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment" spellcheck="true">// Drain all pending events.</span>
        nsecs_t vsyncTimestamp<span class="token punctuation">;</span>
        int32_t vsyncDisplayId<span class="token punctuation">;</span>
        uint32_t vsyncCount<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">processPendingEvents</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vsyncTimestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vsyncDisplayId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>vsyncCount<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        status_t status <span class="token operator">=</span> mReceiver<span class="token punctuation">.</span><span class="token function">requestNextVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> status<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mWaitingForVsync <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法很简单，只是往SurfaceFlinger请求一个VSync的请求，直到SurfaceFlinger发出回调后，到FrameDisplayEventReceiver的onVSync的onVysnc通过doFrame统一处理应用程序需要刷新界面的时机。</p>
<h4 id="doFrame-处理注册在Choreographer的回调函数"><a href="#doFrame-处理注册在Choreographer的回调函数" class="headerlink" title="doFrame 处理注册在Choreographer的回调函数"></a>doFrame 处理注册在Choreographer的回调函数</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">doFrame</span><span class="token punctuation">(</span><span class="token keyword">long</span> frameTimeNanos<span class="token punctuation">,</span> <span class="token keyword">int</span> frame<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startNanos<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mFrameScheduled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// no work to do</span>
            <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

            <span class="token keyword">long</span> intendedFrameTimeNanos <span class="token operator">=</span> frameTimeNanos<span class="token punctuation">;</span>
            startNanos <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> jitterNanos <span class="token operator">=</span> startNanos <span class="token operator">-</span> frameTimeNanos<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>jitterNanos <span class="token operator">>=</span> mFrameIntervalNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> skippedFrames <span class="token operator">=</span> jitterNanos <span class="token operator">/</span> mFrameIntervalNanos<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>skippedFrames <span class="token operator">>=</span> SKIPPED_FRAME_WARNING_LIMIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">final</span> <span class="token keyword">long</span> lastFrameOffset <span class="token operator">=</span> jitterNanos <span class="token operator">%</span> mFrameIntervalNanos<span class="token punctuation">;</span>
                frameTimeNanos <span class="token operator">=</span> startNanos <span class="token operator">-</span> lastFrameOffset<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>frameTimeNanos <span class="token operator">&lt;</span> mLastFrameTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">scheduleVsyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mFPSDivisor <span class="token operator">></span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> timeSinceVsync <span class="token operator">=</span> frameTimeNanos <span class="token operator">-</span> mLastFrameTimeNanos<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>timeSinceVsync <span class="token operator">&lt;</span> <span class="token punctuation">(</span>mFrameIntervalNanos <span class="token operator">*</span> mFPSDivisor<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> timeSinceVsync <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">scheduleVsyncLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">setVsync</span><span class="token punctuation">(</span>intendedFrameTimeNanos<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mFrameScheduled <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            mLastFrameTimeNanos <span class="token operator">=</span> frameTimeNanos<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>

            AnimationUtils<span class="token punctuation">.</span><span class="token function">lockAnimationClock</span><span class="token punctuation">(</span>frameTimeNanos <span class="token operator">/</span> TimeUtils<span class="token punctuation">.</span>NANOS_PER_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">markInputHandlingStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_INPUT<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">markAnimationsStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_ANIMATION<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            mFrameInfo<span class="token punctuation">.</span><span class="token function">markPerformTraversalsStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_TRAVERSAL<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">doCallbacks</span><span class="token punctuation">(</span>Choreographer<span class="token punctuation">.</span>CALLBACK_COMMIT<span class="token punctuation">,</span> frameTimeNanos<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            AnimationUtils<span class="token punctuation">.</span><span class="token function">unlockAnimationClock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在doFrame中依次处理了四种不同的类型Runnable：</p>
<ul>
<li>1.CALLBACK_INPUT 处理点击事件的回调</li>
<li>2.Choreographer.CALLBACK_ANIMATION 处理动画的回调</li>
<li>3.CALLBACK_TRAVERSAL 处理View的绘制流程的回调</li>
<li>4.CALLBACK_COMMIT 该处理是View 的绘制流程结束之后，进行的绘制结束后的处理，在这里可以进行绘制延时报告等处理，还有onTrimMemory分发到主线程后在进行回收等。</li>
</ul>
<p>至此就分析完了整个Vsync的回调流程，如何从SurfaceFlinger回调到app进程。</p>
<h3 id="VSync-推算计算原理"><a href="#VSync-推算计算原理" class="headerlink" title="VSync 推算计算原理"></a>VSync 推算计算原理</h3><p>在这个过程中，DispSync有一个十分关键的函数computeNextEventTimeLocked用于计算下一个Vsync信号发送的时间，我们来看看这个方法究竟做了什么。</p>
<h4 id="SurfaceFlinger接收到VSync信号进行采样"><a href="#SurfaceFlinger接收到VSync信号进行采样" class="headerlink" title="SurfaceFlinger接收到VSync信号进行采样"></a>SurfaceFlinger接收到VSync信号进行采样</h4><p>不过在推算这个方法之前，我们需要看看SurfaceFlinger接受到硬件的VSync信号的调整函数,回调流程在<a href="https://www.jianshu.com/p/8e29c3d9b27a" target="_blank" rel="noopener">SurfaceFlinger 的HAL层初始化</a>一文中已经讲解过了，和热插拔的回调流程一致：<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/SurfaceFlinger.cpp" target="_blank" rel="noopener">SurfaceFlinger.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> SurfaceFlinger<span class="token operator">::</span><span class="token function">onVsyncReceived</span><span class="token punctuation">(</span>int32_t sequenceId<span class="token punctuation">,</span>
        hwc2_display_t displayId<span class="token punctuation">,</span> int64_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mStateLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// Ignore any vsyncs from a previous hardware composer.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sequenceId <span class="token operator">!=</span> <span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mComposerSequenceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    int32_t type<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">getBE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mHwc<span class="token operator">-</span><span class="token operator">></span><span class="token function">onVsync</span><span class="token punctuation">(</span>displayId<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> needsHwVsync <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// Scope for the lock</span>
        Mutex<span class="token operator">::</span>Autolock <span class="token function">_l</span><span class="token punctuation">(</span>mHWVsyncLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> DisplayDevice<span class="token operator">::</span>DISPLAY_PRIMARY <span class="token operator">&amp;&amp;</span> mPrimaryHWVsyncEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            needsHwVsync <span class="token operator">=</span> mPrimaryDispSync<span class="token punctuation">.</span><span class="token function">addResyncSample</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>needsHwVsync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">enableHardwareVsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">disableHardwareVsync</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.调用DispSync 的addResyncSample对同步信号进行采样校准</li>
<li>2.enableHardwareVsync 在EventControlThread打开Vysnc的开关。</li>
</ul>
<p>我们主要看addResyncSample的核心原理。</p>
<h4 id="DispSync-addResyncSample"><a href="#DispSync-addResyncSample" class="headerlink" title="DispSync addResyncSample"></a>DispSync addResyncSample</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DispSync.cpp" target="_blank" rel="noopener">DispSync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">enum</span> <span class="token punctuation">{</span> MAX_RESYNC_SAMPLES <span class="token operator">=</span> <span class="token number">32</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> DispSync<span class="token operator">::</span><span class="token function">addResyncSample</span><span class="token punctuation">(</span>nsecs_t timestamp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    size_t idx <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> mNumResyncSamples<span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
    mResyncSamples<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPhase <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        mReferenceTime <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
        mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">updateModel</span><span class="token punctuation">(</span>mPeriod<span class="token punctuation">,</span> mPhase<span class="token punctuation">,</span> mReferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">&lt;</span> MAX_RESYNC_SAMPLES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mNumResyncSamples<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mFirstResyncSample <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">updateModelLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNumResyncSamplesSincePresent<span class="token operator">++</span> <span class="token operator">></span> MAX_RESYNC_SAMPLES_WITHOUT_PRESENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">resetErrorLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>mIgnorePresentFences<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">hasAnyEventListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">bool</span> modelLocked <span class="token operator">=</span> mModelUpdated <span class="token operator">&amp;&amp;</span> mError <span class="token operator">&lt;</span> <span class="token punctuation">(</span>kErrorThreshold <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span>modelLocked<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法实际上是记录mNumResyncSamples目标当前是周期第几个采样点，同时把mFirstResyncSample除余一次得到此时开始计算的时间点在周期哪里，这些周期是什么意思，等下就明白了。最核心的方法是updateModelLocked进行DispSync的模型的更新。</p>
<h2 id="updateModelLocked-DispSync-模型更新的核心方法"><a href="#updateModelLocked-DispSync-模型更新的核心方法" class="headerlink" title="updateModelLocked DispSync 模型更新的核心方法"></a>updateModelLocked DispSync 模型更新的核心方法</h2><p>在聊这个方法之前，我补充了一点便于理解概念。</p>
<p>我发现有的人曾经试着解释这一段代码的逻辑，但是解释显得有点麻烦。这个方法实际上就是构造一个三角函数一样的函数模型。在聊里面实现细节之前，我们回顾一下简单的初中函数sin 正弦函数的模型。<br>正弦函数定义：</p>
<blockquote>
<p>一般正弦函数：Asin(ωt+Φ)+k<br>最简单的正弦函数是sin(t)，随着时间变化而周期性变化的函数。</p>
</blockquote>
<p>我记得，我在模电中第一次接触了和正弦函数表示形式一致的正弦波，其中有几个参数有特殊定义，其中ωt+Φ 就是我们说的相位(phase)；Φ就是初相决定函数的左右移动；A是幅度；ω角速度,决定了正弦波的周期(T=2π/|ω|)；k代表偏距,控制图像的上下移动;两个同频率(ω相同)正弦波之间相位之差称为相位差。</p>
<p>表示在图里面就是如下：<br><img src="/images/%E6%AD%A3%E5%BC%A6%E6%B3%A2%E6%88%AA%E5%8F%96.png" alt="正弦波截取.png"></p>
<p>这种特性可以让两个不同正弦波有着不变的相位差，很符合我们appEventThread和sfEventThread的推导。</p>
<p>有了这些概念之后，我们来解析这个函数就简单了。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> DispSync<span class="token operator">::</span><span class="token function">updateModelLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">>=</span> MIN_RESYNC_SAMPLES_FOR_UPDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nsecs_t durationSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        nsecs_t minDuration <span class="token operator">=</span> INT64_MAX<span class="token punctuation">;</span>
        nsecs_t maxDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumResyncSamples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t idx <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
            size_t prev <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> MAX_RESYNC_SAMPLES <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
            nsecs_t duration <span class="token operator">=</span> mResyncSamples<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">-</span> mResyncSamples<span class="token punctuation">[</span>prev<span class="token punctuation">]</span><span class="token punctuation">;</span>
            durationSum <span class="token operator">+</span><span class="token operator">=</span> duration<span class="token punctuation">;</span>
            minDuration <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>minDuration<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            maxDuration <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>maxDuration<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        durationSum <span class="token operator">-</span><span class="token operator">=</span> minDuration <span class="token operator">+</span> maxDuration<span class="token punctuation">;</span>
        mPeriod <span class="token operator">=</span> durationSum <span class="token operator">/</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">double</span> sampleAvgX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> sampleAvgY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> scale <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> M_PI <span class="token operator">/</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Intentionally skip the first sample</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumResyncSamples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t idx <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
            nsecs_t sample <span class="token operator">=</span> mResyncSamples<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">-</span> mReferenceTime<span class="token punctuation">;</span>
            <span class="token keyword">double</span> samplePhase <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>sample <span class="token operator">%</span> mPeriod<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>
            sampleAvgX <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>samplePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sampleAvgY <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>samplePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        sampleAvgX <span class="token operator">/</span><span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sampleAvgY <span class="token operator">/</span><span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mPhase <span class="token operator">=</span> <span class="token function">nsecs_t</span><span class="token punctuation">(</span><span class="token function">atan2</span><span class="token punctuation">(</span>sampleAvgY<span class="token punctuation">,</span> sampleAvgX<span class="token punctuation">)</span> <span class="token operator">/</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPhase <span class="token operator">&lt;</span> <span class="token operator">-</span><span class="token punctuation">(</span>mPeriod <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPhase <span class="token operator">+</span><span class="token operator">=</span> mPeriod<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mPeriod <span class="token operator">+</span><span class="token operator">=</span> mPeriod <span class="token operator">*</span> mRefreshSkipCount<span class="token punctuation">;</span>

        mThread<span class="token operator">-</span><span class="token operator">></span><span class="token function">updateModel</span><span class="token punctuation">(</span>mPeriod<span class="token punctuation">,</span> mPhase<span class="token punctuation">,</span> mReferenceTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mModelUpdated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们带入上一段addResyncSample代码，以及图来解释。对于这种线性代数来说，我们使用数学模型无疑能减少理解的难度。</p>
<p>先来看看几个比较重要的宏：</p>
<ul>
<li>1.MAX_RESYNC_SAMPLES 为 32 为采样个数点</li>
<li>2.MAX_RESYNC_SAMPLES_WITHOUT_PRESENT 为 4 </li>
<li>3.MIN_RESYNC_SAMPLES_FOR_UPDATE 为 6</li>
</ul>
<h3 id="VSync重新采样计算周期"><a href="#VSync重新采样计算周期" class="headerlink" title="VSync重新采样计算周期"></a>VSync重新采样计算周期</h3><p>继续思考一个问题，怎么样才能把软件VSync信号的发送间隔或者说周期在整个系统环境中是是相对合理，或者说是正确的。因为硬件到软件是有时间消耗的，软件自己处理也是有时间消耗的，要找到一个适合的周期告诉应用刷新View。不能太快，太快SF处理不过来，或者说能耗过高。太慢了，就导致帧数太低。</p>
<p>addResyncSample中计算的第一件事情计算mFirstResyncSample 和 mNumResyncSamples。</p>
<p>这两个参数代表了什么含义呢？首先看这两行代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"> size_t idx <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> mNumResyncSamples<span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
    mResyncSamples<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> timestamp<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>mResyncSamples是存在于DispSync中的缓存64个大小数组，保存每一个VSync后的时间戳。</p>
<p>不难能看出，mResyncSamples的index 是通过：</p>
<blockquote>
<p>index = (mFirstResyncSample + mNumResyncSamples) % 32</p>
</blockquote>
<p>通过这种方法能看出，其实mResyncSamples的数组就是存储每一次的VSync到达的时间，只存储32份。</p>
<p>用一幅图来表示，实际上就是在这个一次函数中，取32点，如下图：<br><img src="/images/%E6%97%B6%E9%97%B4%E9%87%87%E6%A0%B7.png" alt="时间采样.png"></p>
<p>每一次通过设定的周期mPeriod中采样32个点，而且希望实在第一个周期中进行计算。因为在第一个周期中，每一个点就对应上mResyncSamples时间戳数组的下标。</p>
<p>也只有这样才能解释是这样计算的。比如mFirstResyncSample在第一次唤醒VSync是0，mNumResyncSamples也是0，找到mResyncSamples也就是第0次VSync(不存在)和第一次VSync时间差就是0，找到第0个位置把当前时间戳缓存下来。</p>
<p>第二段代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"> <span class="token keyword">if</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">&lt;</span> MAX_RESYNC_SAMPLES<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mNumResyncSamples<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        mFirstResyncSample <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果mNumResyncSamples小于32 则mNumResyncSamples = mNumResyncSamples +1；否则则mFirstResyncSample = （mFirstResyncSample + 1）% 32</p>
<p>到这里我们就能理解了mFirstResyncSample和mNumResyncSamples分别代表什么。我们分为2种情况：</p>
<ul>
<li><p>1.一开始mFirstResyncSample和mNumResyncSamples必定是0.那么每一次递增都会递增mNumResyncSamples。假如此时mNumResyncSamples已经叠加了六次，对应到上图采样点位置如下：<br><img src="/images/%E9%87%87%E6%A0%B7%E6%83%85%E5%86%B5%E4%B8%80.png" alt="采样情况一.png"></p>
</li>
<li><ol start="2">
<li>不断的递增mNumResyncSamples，如果超出了32个采样点，则会把mFirstResyncSample对应第一周期第一个位置。<br><img src="/images/%E9%87%87%E6%A0%B7%E6%83%85%E5%86%B5%E4%BA%8C.png" alt="采样情况二.png"></li>
</ol>
</li>
</ul>
<p>接下来看看updateModelLock,第三段代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">>=</span> MIN_RESYNC_SAMPLES_FOR_UPDATE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        nsecs_t durationSum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        nsecs_t minDuration <span class="token operator">=</span> INT64_MAX<span class="token punctuation">;</span>
        nsecs_t maxDuration <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumResyncSamples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t idx <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
            size_t prev <span class="token operator">=</span> <span class="token punctuation">(</span>idx <span class="token operator">+</span> MAX_RESYNC_SAMPLES <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
            nsecs_t duration <span class="token operator">=</span> mResyncSamples<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">-</span> mResyncSamples<span class="token punctuation">[</span>prev<span class="token punctuation">]</span><span class="token punctuation">;</span>
            durationSum <span class="token operator">+</span><span class="token operator">=</span> duration<span class="token punctuation">;</span>
            minDuration <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>minDuration<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
            maxDuration <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>maxDuration<span class="token punctuation">,</span> duration<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        durationSum <span class="token operator">-</span><span class="token operator">=</span> minDuration <span class="token operator">+</span> maxDuration<span class="token punctuation">;</span>
        mPeriod <span class="token operator">=</span> durationSum <span class="token operator">/</span> <span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先mNumResyncSamples要6以上才需要更新。换句话说要VSync要经过5次到来(差不多过了20%)才会进行调整周期。应该是VSync在5次以内，采样起来就很少样本，推算出来的软件周期就不准确。</p>
<p>假如是第一次渲染到第六次，那么这6次过程中，mNumResyncSamples会递增到6，mFirstResyncSample为0.</p>
<p>理想是每一次VSync从硬件到SF，SF从第一次VSync消费到第二次的间隔是一致的，但是实际上是不太可能，这个间隔和当前的CPU环境相关。在第一次的时候，会基于硬件传递上来的VSync周期计算处一个新的软件周期出来。<br>如下图：<br><img src="/images/%E5%91%A8%E6%9C%9F%E8%AE%A1%E7%AE%97.png" alt="周期计算.png"></p>
<p>假如要处理第2帧对应的VSync，此时会遍历mResyncSamples中index为1，和0的时间戳，计算两者之间的差值，找到最大的时间差和最小的时间差。并把时间差都累计起来，计算到从第0次到第6次之间总时间差。</p>
<p>总时间差减去最大和最小。新的周期mPeriod的计算如下：</p>
<blockquote>
<p>新VSync 软件发送周期 = durationSum / (mNumResyncSamples - 3)</p>
</blockquote>
<p>拿到总的时间差除以mNumResyncSamples - 3(因为剔除了最大和最小的时间间隙)，其实就是变相找到这6个Vsync采样点时间戳的平均值。</p>
<p>通过这种方法能找到比较合适的软件发送VSync周期，因为硬件发送信号到软件，软件处理完。这是需要一个时间周期，直接使用硬件的VSync的周期是不可取，需要结合当前软件和硬件的运行情况进行动态调整。</p>
<h3 id="VSync重新采样计算相位"><a href="#VSync重新采样计算相位" class="headerlink" title="VSync重新采样计算相位"></a>VSync重新采样计算相位</h3><p>到了这里周期算出来了，好像已经完成了整个逻辑了，因为Android已经找到了相对合适的VSync发送周期时间了。一般的工程师到这里的就放弃思考了，但是Google工程做的更加的完备。</p>
<p>我们依照上面，把点都还在一个时间轴上</p>
<p>我们思考一下，如果我们直接把每一次计算好新的软件发送VSync周期作为基准通知SF和App进程。这样会造成什么？我们先把部分的VSync间隔mPeriod周期的点画在时间轴上。<br><img src="/images/%E9%87%87%E6%A0%B7%E7%82%B9.png" alt="采样点.png"></p>
<p>因为硬件发出的VSync 必定是周期性的,我们不妨使用有着类似性质的数学工具正弦函数来看这个计算结果(虽然数学上不严谨，因为VSync并非是连续性的)。</p>
<p>假设硬件发出的VSync 发出的周期，我们把这一整个周期看成一个正弦函数(经过原点，无初相，忽略偏距)：$Asin(ω_{h}t)$ </p>
<p>由于硬件发出的VSync的信号要经过内核中断，经过用户空间等一些系列CPU参与的工作必定有一定耗时，同时从当前的VSync到下一次的VSync也有消耗。</p>
<p>那么处理方案有2个：</p>
<ul>
<li>1.扩大周期，也就是进一步减小ω的数值。但是这个方案是不可能的.因为无论如何硬件发出VSync的频率要和软件发出的VSync的频率是一致，不然软硬件处理的时机没办法对应上。</li>
<li>2.在ω相等的前提下，增加初相，做一个正弦函数的相位差。换句话说就是延时操作，这样做可以找到CPU处理硬件VSync到软件这一部分的消耗。</li>
</ul>
<p>说明软件如果需要发送VSync必定带着初相Φ，同时又要和原来的硬件发送的VSync频率几乎相同(因为计算mPeriod是基于硬件VSync发送周期计算)，那么$ω<em>{h} = ω</em>{s}$，由此可得</p>
<blockquote>
<p>软件发送VSync的频率函数=$Asin(ω_{h}t + Φ)$ </p>
</blockquote>
<p>换句话说，我们求这个Φ(初相)大小。</p>
<p>如下图：<br><img src="/images/%E8%BD%AF%E7%A1%AC%E4%BB%B6VSync%E7%9B%B8%E4%BD%8D%E5%B7%AE.png" alt="软硬件VSync相位差.png"></p>
<p>因此有了这一层的数学原理，所以Google工程师会计算两种VSync发送频率的相位差。</p>
<p>再来看第四段代码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">double</span> sampleAvgX <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> sampleAvgY <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> scale <span class="token operator">=</span> <span class="token number">2.0</span> <span class="token operator">*</span> M_PI <span class="token operator">/</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mPeriod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Intentionally skip the first sample</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumResyncSamples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            size_t idx <span class="token operator">=</span> <span class="token punctuation">(</span>mFirstResyncSample <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">%</span> MAX_RESYNC_SAMPLES<span class="token punctuation">;</span>
            nsecs_t sample <span class="token operator">=</span> mResyncSamples<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">-</span> mReferenceTime<span class="token punctuation">;</span>
            <span class="token keyword">double</span> samplePhase <span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>sample <span class="token operator">%</span> mPeriod<span class="token punctuation">)</span> <span class="token operator">*</span> scale<span class="token punctuation">;</span>
            sampleAvgX <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>samplePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sampleAvgY <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>samplePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sampleAvgX <span class="token operator">/</span><span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sampleAvgY <span class="token operator">/</span><span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mPhase <span class="token operator">=</span> <span class="token function">nsecs_t</span><span class="token punctuation">(</span><span class="token function">atan2</span><span class="token punctuation">(</span>sampleAvgY<span class="token punctuation">,</span> sampleAvgX<span class="token punctuation">)</span> <span class="token operator">/</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>scale = 2 * PI / mPeriod<br>实际上就是把 2 * PI切分成已经动态获取到的周期切割成360份，比如mPeriod动态计算后是16ms,那么scale代表  360 / 16，1ms代表22度。</p>
</blockquote>
<blockquote>
<p>mReferenceTime 代表第一帧进来硬件的VSync时间戳,作为之后所有VSync的时间基础。</p>
</blockquote>
<p>首先先跳开第一次VSync的时间。遍历后面的VSync对应的时间。这里实际上是计算每一次VSync的时间和调用addResyncSample保存当前时间的mReferenceTime。</p>
<blockquote>
<p>样本相对时间戳sample = mResyncSamples<a href="每一次VSync发送的时间">index</a> - mReferenceTime(第一次硬件VSync时间)</p>
</blockquote>
<p>这里理解起来有点困难。sample的计算实际上是告诉我们当前的时间点和第一次硬件VSync的差。这是一个校准的过程，这样就能保证计算出来的结果都是基于第一次VSync的硬件发送时间为基准。如果mReferenceTime记录上一次软件的VSync会把上一次的软件运行误差一起记录下来。</p>
<p>samplePhase又是什么意思呢？记住在这个过程中两个角色：</p>
<ul>
<li>1.真实的VSync发送时间点</li>
<li>2.经过均值化后，理想的VSync发送的时间点。</li>
</ul>
<p>下图中，红色点是均值化后理想的发送时机，蓝色的点是真正的VSync时机<br><img src="/images/%E9%87%87%E6%A0%B7%E7%82%B9%E7%9A%84%E5%81%8F%E5%B7%AE.png" alt="采样点的偏差.png"></p>
<p>实际上每一次请求VSync周期和均值周期是有偏差的，我们来找找看这个偏差数值比起一个周期mPeriod偏移了多少，如果能求出前后两次软件发送VSync请求偏移量的均值，就说明我们能够找到在当前CPU环境下软件发送前后两次VSync在CPU中消耗了多少。</p>
<p>换句话说，我们就找到了软件VSync应该理想下应该距离硬件发送VSync的时间点。</p>
<p>因此samplePhase的计算法则其实就是把时间转化为角度(前面已经求出1ms是多少度)：</p>
<blockquote>
<p>样本相位samplePhase = (sample % mPeriod) * scale<br>sample % mPeriod代表当前距离第一次硬件发送上来的VSync有多少个周期了，同时余数在mPeriod的哪个位置，最后乘以度数就能得到当前的样本相位。</p>
</blockquote>
<p>接下来这一段要这么看：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mNumResyncSamples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            sampleAvgX <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">cos</span><span class="token punctuation">(</span>samplePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sampleAvgY <span class="token operator">+</span><span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>samplePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        sampleAvgX <span class="token operator">/</span><span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sampleAvgY <span class="token operator">/</span><span class="token operator">=</span> <span class="token keyword">double</span><span class="token punctuation">(</span>mNumResyncSamples <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mPhase <span class="token operator">=</span> <span class="token function">nsecs_t</span><span class="token punctuation">(</span><span class="token function">atan2</span><span class="token punctuation">(</span>sampleAvgY<span class="token punctuation">,</span> sampleAvgX<span class="token punctuation">)</span> <span class="token operator">/</span> scale<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到本质上就是找到每一个采样点，也就是获取每一次软件VSync的偏差角度，求其平均值。由于角度的计算特殊，所以使用了atan的方式进行计算。</p>
<p>换算过程图里面如下<br><img src="/images/%E8%AE%A1%E7%AE%97%E8%A7%92%E5%BA%A6.png" alt="计算角度.png"><br>记住我们是不知道蓝色的先是长什么样子的，其实是只有红色点独立在坐标中,这里只是为了好理解才画出来。只有经过计算了mPhase，已知硬件VSync频率的角速度，我们就可以画出蓝色曲线。</p>
<p>其实在这里我们可以这里理解，应该每一次VSync发送的点就是在这个周期上的某一个点左右，这样我们能够通过$phase = atan2(sampleAvgY, sampleAvgX)$计算出mPhase来得到新的phase也就是对应Φ初相。</p>
<p>当x为0的时候，就能找到距离原点的距离(也就是距离mReferenceTime位置)。但是我们需要的是时间,因此需要如下的计算得到从角度转化回真实的时间：<br>$mPhase =  atan2(sampleAvgY, sampleAvgX) / scale$</p>
<h4 id="DispSync-computeNextEventTimeLocked"><a href="#DispSync-computeNextEventTimeLocked" class="headerlink" title="DispSync computeNextEventTimeLocked"></a>DispSync computeNextEventTimeLocked</h4><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DispSync.cpp" target="_blank" rel="noopener">DispSync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">nsecs_t <span class="token function">computeNextEventTimeLocked</span><span class="token punctuation">(</span>nsecs_t now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>kTraceDetailedInfo<span class="token punctuation">)</span> <span class="token function">ATRACE_CALL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"[%s] computeNextEventTimeLocked"</span><span class="token punctuation">,</span> mName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        nsecs_t nextEventTime <span class="token operator">=</span> INT64_MAX<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mEventListeners<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            nsecs_t t <span class="token operator">=</span> <span class="token function">computeListenerNextEventTimeLocked</span><span class="token punctuation">(</span>mEventListeners<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> nextEventTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                nextEventTime <span class="token operator">=</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> nextEventTime<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中会为每一个加入到DispSync监听的对象通过computeListenerNextEventTimeLocked计算下一次应该发送的Vsync的时间点。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    nsecs_t <span class="token function">computeListenerNextEventTimeLocked</span><span class="token punctuation">(</span><span class="token keyword">const</span> EventListener<span class="token operator">&amp;</span> listener<span class="token punctuation">,</span> nsecs_t baseTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        nsecs_t lastEventTime <span class="token operator">=</span> listener<span class="token punctuation">.</span>mLastEventTime <span class="token operator">+</span> mWakeupLatency<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>baseTime <span class="token operator">&lt;</span> lastEventTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            baseTime <span class="token operator">=</span> lastEventTime<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        baseTime <span class="token operator">-</span><span class="token operator">=</span> mReferenceTime<span class="token punctuation">;</span>
        nsecs_t phase <span class="token operator">=</span> mPhase <span class="token operator">+</span> listener<span class="token punctuation">.</span>mPhase<span class="token punctuation">;</span>
        baseTime <span class="token operator">-</span><span class="token operator">=</span> phase<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>baseTime <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            baseTime <span class="token operator">=</span> <span class="token operator">-</span>mPeriod<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        nsecs_t numPeriods <span class="token operator">=</span> baseTime <span class="token operator">/</span> mPeriod<span class="token punctuation">;</span>
        nsecs_t t <span class="token operator">=</span> <span class="token punctuation">(</span>numPeriods <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> mPeriod <span class="token operator">+</span> phase<span class="token punctuation">;</span>
        t <span class="token operator">+</span><span class="token operator">=</span> mReferenceTime<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> listener<span class="token punctuation">.</span>mLastEventTime <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> mPeriod <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            t <span class="token operator">+</span><span class="token operator">=</span> mPeriod<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        t <span class="token operator">-</span><span class="token operator">=</span> mWakeupLatency<span class="token punctuation">;</span>

        <span class="token keyword">return</span> t<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>理解了上述VSync是怎么进行周期和相位计算的，理解这里就很简单了。VSync周期是分为32份进行管理的，这里mWakeupLatency也就是添加了一个唤醒延时，这个延时就是VSync周期中每一份的1/2作为开销。</p>
<p>如果当前的时间比上一次的唤醒时间加上唤醒开销都要小，则取</p>
<blockquote>
<p> listener.mLastEventTime + mWakeupLatency</p>
</blockquote>
<p>记住这里的listener是什么呢？实际上就是appEventThread中的DispSyncSource以及sfEventThread中的DispSyncSource，也就是上文中设置setVsyncEnable进来的。</p>
<p>这里的计算是和常规的思路是反过来的，对应整个Android系统来说，首先注册了sf的DispSyncSource，之后App应用启动后，才注册了app的DispSyncSource。</p>
<p>baseTime是DispSync初始化线程时间。</p>
<ul>
<li>1.baseTime = baseTime -  mReferenceTime 以第一次硬件发送VSync时间校准了。</li>
<li>2.第一次phase = mPhase(软件VSync的相位偏移) + listener.mPhase,这个时候加的是sf的偏移量0.01s。同时baseTime 向前推移phase，找到没有偏移影响的基础时间。</li>
<li>3.如果baseTime校准异常，则baseTime -= mPeriod</li>
<li>4.查看当前baseTime 在哪一个VSync周期中，找到下一个周期并且加上偏移量就是下一次VSync发送时机，记住要加上mReferenceTime这个基准点。</li>
<li>5.如果算出来的预期时间比上次的发送Vsync时间小于3/5个周期，则说明本次时机和原来VSync的时机太接近，应该放到下一个周期。</li>
<li>6.预期时间最后还要记得，减掉唤醒时间。</li>
<li>7.第二次循环后，listener变成了app的EventThread。</li>
</ul>
<p>那么appEventThread和sfEventThread的相位是怎么出来的呢？其实就是每一个listener的mPhase设置的0.002s和0.006s。</p>
<h3 id="跳帧的计算原理"><a href="#跳帧的计算原理" class="headerlink" title="跳帧的计算原理"></a>跳帧的计算原理</h3><p>我们熟悉了VSync的计算原理以及预期计算原理之后，我们其实可以发现在SF消费阶段，有一个跳帧处理，我们来看看。<br>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/BufferLayerConsumer.cpp" target="_blank" rel="noopener">BufferLayerConsumer.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">nsecs_t BufferLayerConsumer<span class="token operator">::</span><span class="token function">computeExpectedPresent</span><span class="token punctuation">(</span><span class="token keyword">const</span> DispSync<span class="token operator">&amp;</span> dispSync<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> uint32_t hwcLatency <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nsecs_t nextRefresh <span class="token operator">=</span> dispSync<span class="token punctuation">.</span><span class="token function">computeNextRefresh</span><span class="token punctuation">(</span>hwcLatency<span class="token punctuation">)</span><span class="token punctuation">;</span>

    nsecs_t extraPadding <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>SurfaceFlinger<span class="token operator">::</span>vsyncPhaseOffsetNs <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        extraPadding <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1ms (6% of 60Hz)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> nextRefresh <span class="token operator">+</span> extraPadding<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/" target="_blank" rel="noopener">frameworks</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/" target="_blank" rel="noopener">services</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/" target="_blank" rel="noopener">surfaceflinger</a>/<a href="http://androidxref.com/9.0.0_r3/xref/frameworks/native/services/surfaceflinger/DispSync.cpp" target="_blank" rel="noopener">DispSync.cpp</a></p>
<pre class="line-numbers language-cpp"><code class="language-cpp">nsecs_t DispSync<span class="token operator">::</span><span class="token function">computeNextRefresh</span><span class="token punctuation">(</span><span class="token keyword">int</span> periodOffset<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    Mutex<span class="token operator">::</span>Autolock <span class="token function">lock</span><span class="token punctuation">(</span>mMutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsecs_t now <span class="token operator">=</span> <span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    nsecs_t phase <span class="token operator">=</span> mReferenceTime <span class="token operator">+</span> mPhase<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>now <span class="token operator">-</span> phase<span class="token punctuation">)</span> <span class="token operator">/</span> mPeriod<span class="token punctuation">)</span> <span class="token operator">+</span> periodOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> mPeriod <span class="token operator">+</span> phase<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法就是计算核心，periodOffset首先是0.</p>
<p>计算当前的时间和软件开始发送VSync之间差除以mPeriod从而找到是第几个的VSync周期，拿到下一个周期加回原来的因计算减去的软件Vsync相位，同时加上appEventThread的相位。</p>
<blockquote>
<p>下一帧显示时间 = 软件VSync下一次发送时间点 + appEventThread的相位偏移。</p>
</blockquote>
<p>到这里就把整个VSync的计算原理全部解析了一遍。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>老规矩，我们先上一副时序图来总结VSync的发送与监听流程。<br><img src="/images/VSync%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6.jpg" alt="VSync回调机制.jpg"></p>
<p>VSync和Fence都是SF中的同步机制。可以说，两者都是SF渲染机制的核心。不过两者之间的角色不一样。</p>
<p>Fence的要旨是控制GraphicBuffer的状态，是否允许工作，因为Fence是一段共享内存，很可能被多个进程修改，维护的是GraphicBuffer资源的资源竞争的问题，保证资源一次只被一个进程绘制。</p>
<p>VSync的要旨是协调硬件，软件之间工作的时序性，如下图：<br><img src="/images/SF_Vsync.png" alt="SF_Vsync.png"></p>
<p>为什么需要拿到硬件VSync发送周期后，动态计算软件的VSync周期呢(当时间不足的时候，进行阻塞)？原因很简单，实际上就是因为VSync从硬件触发后，途径内核，SF的处理会有一定的消耗，所以软件发送VSync需要一定的延时，周期也会比原来硬件VSync的大一点(近似相等)。</p>
<p>软件发送VSync的周期是怎么计算的呢？会把每一次VSync存储在一个大小为32的采样数组中。每一次取出6个采样点，取出间隔最大和最小，找到这个6个点的平均间隔，这就是软件发送VSync周期。</p>
<p>软件发送VSync的延时是怎么计算的呢？</p>
<blockquote>
<p>会把每一次VSync采样点和刚才计算的软件发送周期进行比对。按照道理采样点应该和软件发送周期是吻合的，但是出现了偏差，Google工程师认为这就是软件消耗的时间。那么这个消耗的时间同样可以作为整个周期性函数的初相，也就是和硬件发送VSync周期函数的偏移量(相位差)。</p>
</blockquote>
<p>VSync请求发送时候，是怎么推算下一次分发VSync呢？</p>
<blockquote>
<p>我们通过上面两个条件计算出了，关键的两个参数，相位和周期，就能通过当前的时间点所属的周期往后推一个点，那个点就是VSync下一次发送的时间。</p>
</blockquote>
<p>SF是怎么进行跳帧处理呢？</p>
<blockquote>
<p>因为每一次App应用的View绘制流程都是等到VSync进行刷新的。那么每一次VSync时间必定和GraphicBuffer入队时间是相对应。因此只需要推算出下一个周期的VSync加上appEventThread的相位偏移，就能找到预计显示的时间。</p>
</blockquote>
<p>为了避免SF进程和app进程之间处理VSync之间工作时序出现异常，如下图：<br><img src="/images/sf%E5%92%8Capp%E7%9A%84%E6%97%B6%E9%97%B4%E5%B7%AE.png" alt="sf和app的时间差.png"></p>
<p>这两个时间差是以硬件传递过来的VSync周期为基准，计算出软件的周期和延时。再以软件的延时相位为基准，app和sf向后延时一段各自固定的时间。</p>
<p>为什要做这两个EventThread处理的事件，先来看看各自做了什么：</p>
<ul>
<li>1.app 进程接收到VSync，开始进行View的构建，最后把GraphicBuffer交给SF处理。</li>
<li>2.sf进程则是收到VSync之后，采集足够的样本，重新计算当前的周期和相位。</li>
</ul>
<p>无论是哪一方当做完当前的事件之后会调用requestNextVsync，请求下一次VSync。最后计算出预期VSync的那个，选出最小的那个最为下一次DispSync发出VSync时机。</p>
<p>app以VSync信号为基准刷新View把GraphicBuffer交给SF处理。VSync的周期又是根据前后两次计算的。如果VSync周期太大了，就会导致app刷新太慢。因此软件发送VSync周期的计算是把app刷新的CPU开销一起计算进来。因此必须先完成app对应的VSync信号，才能处理SF的VSync重新调整周期。不然会得到一个不是很准确的VSync周期。</p>
<p>假如没有这个相位差，会发生什么？sf一定比app快(因为处于task最高优先级的FIFO队列中)。这样就是出现SF提前进行VSync计算，计算平局值没算入app绘制消耗。导致了周期计算失误，同时在推算下一个VSync的时候，会提前点。导致第一帧还没算完，就要准备显示第二帧造成类似下图jank的情况。<br><img src="/images/jank.png" alt="jank.png"></p>
<p>不过，一般的jank是因为绘制一帧的事件太长，导致后面的帧全部造成延时。而VSync的相位混淆，则是因为VSync软件周期太短了，导致GraphicBuffer多显示了一个VSync周期。</p>
<h3 id="第二次讨论多缓冲中的作用"><a href="#第二次讨论多缓冲中的作用" class="headerlink" title="第二次讨论多缓冲中的作用"></a>第二次讨论多缓冲中的作用</h3><p>为了避免在VSync模型的jank异常，SF使用了多缓冲(多GraphicBuffer)方式进行处理<br>纵览对应整个SF并行模型：</p>
<p><img src="/images/SF%E5%B9%B6%E8%A1%8C%E6%B6%88%E8%B4%B9%E6%A8%A1%E5%9E%8B.png" alt="SF并行消费模型.png"></p>
<p>App进程通过Surface的图元生产者的dequeue获取GraphicBuffer，在方法waitForFreeSlotThenRelock从mFreeSlots和mFreeBuffer中分配Buffer时候有这么一段：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">        <span class="token keyword">const</span> <span class="token keyword">int</span> maxBufferCount <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMaxBufferCountLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> tooManyBuffers <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token operator">></span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>size_t<span class="token operator">></span><span class="token punctuation">(</span>maxBufferCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tooManyBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">BQ_LOGV</span><span class="token punctuation">(</span><span class="token string">"%s: queue size is %zu, waiting"</span><span class="token punctuation">,</span> callerString<span class="token punctuation">,</span>
                    mCore<span class="token operator">-</span><span class="token operator">></span>mQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>换句话说每一次分配都校验，当前消费的缓冲队列中是否大于了maxBufferCount。而这个maxBufferCount是通过getMaxBufferCountLocked获取的。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">int</span> BufferQueueCore<span class="token operator">::</span><span class="token function">getMaxBufferCountLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> maxBufferCount <span class="token operator">=</span> mMaxAcquiredBufferCount <span class="token operator">+</span> mMaxDequeuedBufferCount <span class="token operator">+</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>mAsyncMode <span class="token operator">||</span> mDequeueBufferCannotBlock<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    maxBufferCount <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span>mMaxBufferCount<span class="token punctuation">,</span> maxBufferCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> maxBufferCount<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里面mMaxDequeuedBufferCount，就是SF判断是否打开了3重缓冲开关时候获取的，关闭则设置2，打开则设置默认1.</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">if</span> <span class="token punctuation">(</span>mFlinger<span class="token operator">-</span><span class="token operator">></span><span class="token function">isLayerTripleBufferingDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mProducer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setMaxDequeuedBufferCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>为什么会这样呢？因为9.0抛弃了三重缓冲，改用动态缓冲。实际上我们可以看看4.4的源码：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">ifdef</span> TARGET_DISABLE_TRIPLE_BUFFERING</span>
<span class="token macro property">#warning "disabling triple buffering"</span>
    mSurfaceFlingerConsumer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setDefaultMaxBufferCount</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
    mSurfaceFlingerConsumer<span class="token operator">-</span><span class="token operator">></span><span class="token function">setDefaultMaxBufferCount</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4.4很粗暴的直接设置了消费者消费的数量。而在9.0的源码中，当Surface进行connect的时候就会开始调整可分配的mSlot插槽的数量:</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">    <span class="token keyword">int</span> delta <span class="token operator">=</span> mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMaxBufferCountLocked</span><span class="token punctuation">(</span>mCore<span class="token operator">-</span><span class="token operator">></span>mAsyncMode<span class="token punctuation">,</span>
            mDequeueTimeout <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mConsumerControlledByApp <span class="token operator">&amp;&amp;</span> producerControlledByApp <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            mCore<span class="token operator">-</span><span class="token operator">></span>mMaxBufferCount<span class="token punctuation">)</span> <span class="token operator">-</span>
            mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">getMaxBufferCountLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mCore<span class="token operator">-</span><span class="token operator">></span><span class="token function">adjustAvailableSlotsLocked</span><span class="token punctuation">(</span>delta<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> BAD_VALUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过当前的模式计算出最大需要多少的图元，和当前的图元最大的图元相比。进行调整，大了则扩容到mSlots;小了则缩容量，多余放到mUnusedSlots中。动态的扩充可申请容量比起原来的粗暴设置多缓冲，显得优化的更多性能。</p>
<h1 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h1><p>到这里SurfaceFlinger的全系列文章已经结束了，从12月末尾一直写到现在，耗时近3个月。我也在大大小小的细节品味了一次高版本的渲染原理。比起低版本性能上确实优化了很多。我也学习很多之前没有接触过知识，就差没有拿出一个GPU的内核模块源码进行分析。可以说应该是目前全网最全的解剖源码了。</p>
<p>但是学习到这个地步，你就精通了SurfaceFlinger吗？不，并没有。最多算是熟悉，这仅仅只是一个开始，SurfaceFlinger只是展露了冰山一角，还有很多内容没有和大家聊，如DataSpace是如何运作，GraphicBuffer中HDR映射的句柄又是什么东西又是怎么运作的，还有GPU底层irq，同步栅是如何唤醒等等。</p>
<p>但是对应一个中级的应用开发工程师就足够了。特别是需要经常接触音视频开发的工程师，这些东西都是必须懂得的。不然写不出好代码。</p>
<p>不知道VSync原理，不知道dequeue原理，你会发现如果音视屏生产者过快会造成jank的效果，甚至因为dequeue动态调整的slot的问题可能出现丢帧等各种各样的问题。甚至不知道OpenGL es的swapBuffer在Android中实际上做的是dequeue和queue的工作，和Canvas.lock以及unlockAndPost一样的工作。</p>
<p>闲话就不多说了，之后可能会暂时停笔一小段时间，因为有一个比较感兴趣的业务接下来做了，对我来说也是一个挑战。等下一段的开始，就是和大家聊聊Skia的源码和大家熟知的View的绘制流程。有了这个基础，我就可以横向比对flutter engine中是如何渲染画面，比较双方的优劣。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/04/12/android-chong-xue-xi-lie-surfaceview-he-textureview-yuan-ma-qian-xi-shang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/7.jpg" class="responsive-img" alt="Android 重学系列 SurfaceView和TextureView 源码浅析(上)">
                        
                        <span class="card-title">Android 重学系列 SurfaceView和TextureView 源码浅析(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言时隔一个月，回来继续写文章了。这个月写了一个关于自定义Camera的需求，想了想干脆实现一个滤镜相机好了，以回顾之前学习OpenGL es的知识。
Android重学系列原定计划是，先解析View的绘制流程，接着解析Skia的核心原理。
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-04-12
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Android-Framework/" class="post-category">
                                    Android Framework
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/02/22/android-chong-xue-xi-lie-fence-yuan-li/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/6.jpg" class="responsive-img" alt="Android 重学系列 fence原理">
                        
                        <span class="card-title">Android 重学系列 fence原理</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言在前文中，我们已经讨论了Android 渲染体系中整体流程。但是对于fence，每一个厂商对它的理解都有点点不同，但是大体的思路和框架是跟着Android渲染体系走的。就以上一篇的msm8960为例子，在hwc_set中执行了hwc_s
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-02-22
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/SurfaceFlinger/" class="post-category">
                                    SurfaceFlinger
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android/">
                        <span class="chip bg-color">Android</span>
                    </a>
                    
                    <a href="/tags/Android-Framework/">
                        <span class="chip bg-color">Android Framework</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
