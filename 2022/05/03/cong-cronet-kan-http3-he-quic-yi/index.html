<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="从Cronet 看Http3和QUIC(一), Android | Linux | Flutter">
    <meta name="description" content="前言前一段时间，在公司内部进行了一次QUIC协议的演讲。当时因为时间有限，没有仔细的讨论Cronet 的源码细节，仅仅只是介绍了QUIC的协议细节。本文就从Cronet源码出发，聊聊QUIC的一些实现，进而看看QUIC对比Http2的优势，">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>从Cronet 看Http3和QUIC(一) | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/4.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        从Cronet 看Http3和QUIC(一)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/quic/">
                                <span class="chip bg-color">quic</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-05-03
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        7.8k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        35 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前一段时间，在公司内部进行了一次QUIC协议的演讲。当时因为时间有限，没有仔细的讨论Cronet 的源码细节，仅仅只是介绍了QUIC的协议细节。本文就从<code>Cronet</code>源码出发，聊聊QUIC的一些实现，进而看看QUIC对比Http2的优势，解决了什么问题？</p>
<p>网上搜了不少QUIC解析文章，不是太老就是粗略聊聊原理，没有几个真的深入源码层面来证明说法是否正确，本文将主要根据QUIC最新的源码来聊聊整个协议的设计，以及这样做的优势</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="Http-发展史"><a href="#Http-发展史" class="headerlink" title="Http 发展史"></a>Http 发展史</h2><p>在聊QUIC之前，我们需要对QUIC有一个初步的了解。QUIC本质上是在Http之上进一步的发展，而不是凭空出现的，而是为了解决Http之前的痛点诞生的。为此我们需要先了解http的发展，以及每一代比起上一代都解决了什么问题。</p>
<p>下图是一个Http的发展进程：</p>
<p><img src="/images/Http%E5%8F%91%E5%B1%95.png" alt="Http发展.png"></p>
<p>在这个发展史中可以看到在Http2.0正式推出之前，Google就开始实验QUIC协议。并在2018年在QUIC基础上进一步的发展出Http3协议。在2021年正式发布出QUIC协议。</p>
<p>能看到Http 1到SPDY协议中间间隔10年时间，究竟是为什么在Http 2.0正式发布之前，就开始了Http3前身QUIC进行实验了？那必然是很早就被Google发现了Http 2.0协议的有根本性的缺陷，无法被弥补，需要立即实验下一代协议。</p>
<p>再来看看如今Http 2.0的全网使用情况：</p>
<p>![Http2 全网占比.png](/images/Http2 全网占比.png)</p>
<p>能看到目前Http 2.0全网使用率从发展到2022年2月份还是50%的使用率，而在5月份就是骤降了5%。实际上都转去了QUIC协议，如今已尽占比接近25%了。那究竟有什么魅力，导致这么多开发者青睐QUIC协议呢？</p>
<p>带着疑问，我们来简单回顾一下每一代Http协议实现的功能，以及缺点。</p>
<h3 id="Http-1"><a href="#Http-1" class="headerlink" title="Http 1"></a>Http 1</h3><p>在Http 1中奠定了Http协议的基本语义：</p>
<ul>
<li>由请求行/状态行，body和header 构成 Http请求</li>
</ul>
<p><img src="/images/Http%E8%AF%B7%E6%B1%82%E5%8D%8F%E8%AE%AE%E7%BB%93%E6%9E%84.png" alt="Http请求协议结构.png"></p>
<p><img src="/images/Http%E5%93%8D%E5%BA%94%E5%8D%8F%E8%AE%AE%E7%BB%93%E6%9E%84.png" alt="Http响应协议结构.png"></p>
<p>Http的缺点分为如下几点：</p>
<ul>
<li><p>1.header 编码效率低：特别是Rest 架构，往往无状态容易，没有对Header进行编码压缩</p>
</li>
<li><p>2.多路复用成本过高</p>
<ul>
<li>慢启动</li>
<li>一旦网络发生异动就需要重建连接，无论如何都需要3次握手，缓慢</li>
</ul>
</li>
<li><p>3.一旦长连接建立了就无法中断</p>
</li>
<li><p>4.Http 应用层不支持流控</p>
</li>
</ul>
<p>为了解决这些问题，就诞生出了Http 2.0协议。</p>
<h3 id="Http-2-0"><a href="#Http-2-0" class="headerlink" title="Http 2.0"></a>Http 2.0</h3><p>Http 2.0在Http 1.0基础上实现了如下的功能：</p>
<ul>
<li><p>1.多路复用</p>
<ul>
<li>连接，Stream级别流控</li>
<li>带权重，依赖优先级</li>
<li>Stream Reset</li>
<li>应用层数据交换单位细化到Frame(帧)</li>
</ul>
</li>
<li><p>2.HPack 头部编码</p>
</li>
<li><p>3.服务器消息推送</p>
</li>
</ul>
<p>关于Http 2.0详细的设计，可以阅读我之前写的<a href="https://www.jianshu.com/p/639eaac1b5eb" target="_blank" rel="noopener">Okhttp源码解析</a>中的<code>Http2Connection</code>相关的源码解析。里面有详细剖析Okhttp是如何进行Frame江湖，以及HPack是如何压缩的，还有流是如何控制的。</p>
<p>Http 2.0的缺点如下：</p>
<ul>
<li>1.队头阻塞</li>
</ul>
<p><img src="/images/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE-Http2%E9%98%9F%E5%A4%B4%E9%98%BB%E5%A1%9E.png" alt="网络协议-Http2队头阻塞.png"></p>
<p>因为Http 2.0中使用的是多路复用的流模型，一个tcp链接的发送数据过程中可能会把一个个请求分割成多个流发送到服务器。，因为Tcp的tls加密是一个Record的加密，也就是接近10stream大小进行加密。如果其中在某一个流丢失了，整一串都会解密失败。</p>
<p>这就是Http 2.0最为严重的队头阻塞问题。</p>
<ul>
<li>2.建立连接速度缓慢，能看到整个过程都需要一个十分冗长的过程，三次握手，tls密钥交换等等。可以简单看看https的建立链接过程：</li>
</ul>
<p><img src="/images/Https%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B.png" alt="Https通信模型.png"></p>
<ul>
<li>3.基于TCP四元组确定一个链接，在移动互联网中表现不佳。因为移动设备经常移动，可能在公交地铁等地方，出现了基站变换，Wi-Fi变化等状态。导致四元组发声变化，而需要重新建立链接。</li>
</ul>
<h2 id="QUIC"><a href="#QUIC" class="headerlink" title="QUIC"></a>QUIC</h2><p>Http 2.0的问题很大情况是因为TCP本身在传输层本身就需要保证包的有序性导致的，因此QUIC干脆抛弃TCP协议，使用UDP协议，可以看看下面QUIC的协议构成：</p>
<p><img src="/images/%E7%BD%91%E7%BB%9C%E5%8D%8F%E8%AE%AE-QUIC_Http3.png" alt="网络协议-QUIC_Http3.png"></p>
<p>Http2是基于TCP协议，并在可以独立出tls加密协议出来。可以选择是否使用tls加密。</p>
<p>能看到QUIC协议本质上是基于UDP传输层协议。在这个之上的应用层是QUIC协议，其中包含了tls加密协议。而未来的Http3则是在QUIC协议上进一步发展的。</p>
<p>QUIC的源码十分之多和复杂？为什么如此呢？能看到QUIC实际上是在UDP上发展，那么需要保证网络数据包的有序性以及正确性，就需要把类似TCP可靠协议逻辑放在QUIC中实现。</p>
<p>也正因如此，QUIC是在应用层实现的协议，可以很灵活的切换各种协议状态，而不需要在内核中增加socket中netFamily的族群，在传输层增加逻辑。</p>
<p>为什么QUIC协议中内置tls协议呢？往后看就知道优势在哪里了。</p>
<h3 id="QUIC-使用"><a href="#QUIC-使用" class="headerlink" title="QUIC 使用"></a>QUIC 使用</h3><p>在聊QUIC之前，我们需要熟悉这个协议<code>cronet</code>是如何使用的QUIC协议的。</p>
<p>估计熟悉的人不多，因为<code>cronet</code>网络库官方告诉你的依赖方式，需要的引擎需要通过GooglePlay获取到<code>cronet</code>的引擎才能完整的使用所有的功能。国内环境一般是没有GooglePlay因此如果想要使用cronet，最好把源码弄下来，自己生成so库或者使用生成好的so库。</p>
<p>这里就不多说依赖，来看看如何使用的：</p>
<ul>
<li>1.先生成一个<code>CronetEngine</code>引擎</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    CronetEngine<span class="token punctuation">.</span>Builder myBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronetEngine<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CronetEngine cronetEngine <span class="token operator">=</span> myBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li>2.构造一个网络请求过程中，不同状态的回调函数：</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"> <span class="token keyword">class</span> <span class="token class-name">MyUrlRequestCallback</span> <span class="token keyword">extends</span> <span class="token class-name">UrlRequest<span class="token punctuation">.</span>Callback</span> <span class="token punctuation">{</span>
      <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TAG <span class="token operator">=</span> <span class="token string">"MyUrlRequestCallback"</span><span class="token punctuation">;</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onRedirectReceived</span><span class="token punctuation">(</span>UrlRequest request<span class="token punctuation">,</span> UrlResponseInfo info<span class="token punctuation">,</span> String newLocationUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onRedirectReceived method called."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// You should call the request.followRedirect() method to continue</span>
        <span class="token comment" spellcheck="true">// processing the request.</span>
        request<span class="token punctuation">.</span><span class="token function">followRedirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onResponseStarted</span><span class="token punctuation">(</span>UrlRequest request<span class="token punctuation">,</span> UrlResponseInfo info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onResponseStarted method called."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// You should call the request.read() method before the request can be</span>
        <span class="token comment" spellcheck="true">// further processed. The following instruction provides a ByteBuffer object</span>
        <span class="token comment" spellcheck="true">// with a capacity of 102400 bytes to the read() method.</span>
        request<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">102400</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReadCompleted</span><span class="token punctuation">(</span>UrlRequest request<span class="token punctuation">,</span> UrlResponseInfo info<span class="token punctuation">,</span> ByteBuffer byteBuffer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onReadCompleted method called."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// You should keep reading the request until there's no more data.</span>
        request<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>ByteBuffer<span class="token punctuation">.</span><span class="token function">allocateDirect</span><span class="token punctuation">(</span><span class="token number">102400</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSucceeded</span><span class="token punctuation">(</span>UrlRequest request<span class="token punctuation">,</span> UrlResponseInfo info<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onSucceeded method called."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol start="3">
<li>生成<code>UrlRequest</code>对象，并启动请求：</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">    Executor executor <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UrlRequest<span class="token punctuation">.</span>Builder requestBuilder <span class="token operator">=</span> cronetEngine<span class="token punctuation">.</span><span class="token function">newUrlRequestBuilder</span><span class="token punctuation">(</span>
            <span class="token string">"https://www.example.com"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyUrlRequestCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    UrlRequest request <span class="token operator">=</span> requestBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其实就是这么简单。</p>
<p>下面是对Cronet中UrlRequest请求的生命周期：</p>
<p><img src="/images/cronet-lifecycle.png" alt="cronet-lifecycle.png"></p>
<h3 id="QUIC-源码架构"><a href="#QUIC-源码架构" class="headerlink" title="QUIC 源码架构"></a>QUIC 源码架构</h3><p>在聊QUIC源码之前，我们需要初步的对<code>Cronet</code>的源码架构有一个了解。这部分的源码实在太多，接下来的源码使用的分支是最新的<code>chromium</code> 浏览器内核中<code>Cronet</code>模块。</p>
<p>下面是一个Cronet的核心类在整个Cronet的组成：</p>
<p><img src="/images/cronet.png" alt="cronet.png"></p>
<p>根据上面的示意图，可以看到Cronet，将整个模块分为如下几个部分：</p>
<ul>
<li><p>面向应用的api层，如Android，iOS。</p>
<ul>
<li>iOS 则是由一个Cronet的中类方法通过<code>cronet_environment</code>控制<code>cronet</code>引擎。</li>
<li>Android 则复杂很多。首先面向开发者的java-api接口，在这个api接口中有4种不同的实现，分别是<code>GmsCoreCronetProvider</code>,<code>PlayServicesCronetProvider</code>，<code>NativeCronetProvider</code>,<code>JavaCronetProvider</code>.为什么会这样呢？其实前两者是在Google环境和存在Google商店下内置了Cronet的组件库，那么就可以直接复用Google为你提供的Cronet 网络请求服务，从而减小包大小。当然如果上述<code>Cronet</code>引擎都找不到，就会装载默认的<code>JavaCronetProvider</code>对象，通过<code>JavaUrlRequest</code>使用<code>URLConnection</code>进行网络请求。当然我们可以把<code>GmsCoreCronetProvider</code>,<code>PlayServicesCronetProvider</code>看成<code>NativeCronetProvider</code>也未尝不可，之后我们也只看这个引擎加载器的源码。最终<code>NativeCronetProvider 最终会生成</code>CronetUrlRequest`对象交给开发者进行请求</li>
</ul>
</li>
<li><p>对于Android jni层来说，几乎java每一个步骤下生成的Java对象都会在jni的中有一个native对象。这里只说核心的几个。而在jni中，名字带有Adapter的对象一般都是适配器，连接java层对应在native的对象。</p>
<ul>
<li><code>CronetURLRequest</code>对应在jni中也有一个<code>CronetURLRequest</code>负责请求的总启动.</li>
<li><code>CronetURLRequestAdapter</code> 负责监听<code>CronetURLRequest</code>回调到java层对应的生命周期回调。</li>
<li><code>CronetUploadDataStream</code> 控制post时候需要发送的消息体数据流</li>
</ul>
</li>
<li><p><code>Cronet Core</code> 也就是<code>cronet</code>的核心引擎层。在这个层级里面，无论是iOS还是Android最终都会调用到他们的api。其中在这个引擎层中包含了3部分，<code>UrlRequest 控制请求事务流转曾层</code>，<code>缓存与请求流控制层</code>，<code>QUIC实现层</code>。当然这<code>cronet</code>并不只是包含了qui协议c，同级别的具体协议实现还包含了如http1.0，http2.0，webscoket等，可以在UrlRequest组建的时候决定当前请求的协议应该是什么。</p>
<ul>
<li><p><code>URLRequest</code> 所有的请求都会存在一个<code>URLRequestJobFactory</code> 请求工作工厂，当 <code>URLRequest</code> 需要执行的请求的时候，就会通过这个工厂生成一个<code>Job</code>对象进行生命周期的流转，当真正执行的时候就会把事情委托给<code>HttpCache</code>,进行流级别的控制管理</p>
</li>
<li><p><code>HttpCache</code> 本质上是一个面向流的缓存。可以缓存多个请求事务(Transaction)，同时每个事务会控制不同的流。而每一个新的流都会生成一个全新的<code>HttpStreamRequest</code>，通过<code>JobController</code> 创建一个<code>HttpStreamFactory::Job</code>将请求委托给事务<code>HttpTransaction</code>，<code>HttpTransaction</code>进行生命周期的流转。而在这个全新的Job，就会根据之前在 <code>URLRequest</code> 配置好的协议头，执行不同的协议请求处理器，并调用<code>HttpTransaction</code>开始请求。</p>
<ul>
<li><code>QUIC</code>协议层部分则是对应<code>quic</code>的具体实现。其中会生成一个<code>QuicStreamRequest</code>控制每一个<code>quic</code>请求流，而这个请求流会把事务委托给<code>QuicStreamFactory</code>生成<code>QuicStreamFactory::Job</code>工作对象。在Job中事务流转整个请求的状态。并在这个Job中控制UDP传输quic协议格式的数据。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>有一个大致的认识后，让我们进一步的了解整个QUIC的运行机制，再来看看QUIC协议中原理以及其优越性。</p>
<h2 id="QUIC-源码解析"><a href="#QUIC-源码解析" class="headerlink" title="QUIC 源码解析"></a>QUIC 源码解析</h2><p>先根据使用来看看最初几个api的设计,来看看<code>CronetEngine.Builder</code>的构造函数：</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> <span class="token function">Builder</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token function">createBuilderDelegate</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">private</span> <span class="token keyword">static</span> ICronetEngineBuilder <span class="token function">createBuilderDelegate</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>CronetProvider<span class="token operator">></span> providers <span class="token operator">=</span>
                    <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>CronetProvider<span class="token punctuation">.</span><span class="token function">getAllProviders</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            CronetProvider provider <span class="token operator">=</span> <span class="token function">getEnabledCronetProviders</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> providers<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Log<span class="token punctuation">.</span><span class="token function">isLoggable</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> Log<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span>
                        String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Using '%s' provider for creating CronetEngine.Builder."</span><span class="token punctuation">,</span>
                                provider<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> provider<span class="token punctuation">.</span><span class="token function">createBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mBuilderDelegate<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上是通过<code>CronetProvider.getAllProviders</code>获取所有的Cronet引擎提供容器，通过<code>getEnabledCronetProviders</code>筛选出第一个可用的Cronet引擎。</p>
<h4 id="CronetProvider-getAllProviders"><a href="#CronetProvider-getAllProviders" class="headerlink" title="CronetProvider getAllProviders"></a>CronetProvider getAllProviders</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String JAVA_CRONET_PROVIDER_CLASS <span class="token operator">=</span>
            <span class="token string">"org.chromium.net.impl.JavaCronetProvider"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String NATIVE_CRONET_PROVIDER_CLASS <span class="token operator">=</span>
            <span class="token string">"org.chromium.net.impl.NativeCronetProvider"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String PLAY_SERVICES_CRONET_PROVIDER_CLASS <span class="token operator">=</span>
            <span class="token string">"com.google.android.gms.net.PlayServicesCronetProvider"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String GMS_CORE_CRONET_PROVIDER_CLASS <span class="token operator">=</span>
            <span class="token string">"com.google.android.gms.net.GmsCoreCronetProvider"</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String RES_KEY_CRONET_IMPL_CLASS <span class="token operator">=</span> <span class="token string">"CronetProviderClassName"</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> List<span class="token operator">&lt;</span>CronetProvider<span class="token operator">></span> <span class="token function">getAllProviders</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Use LinkedHashSet to preserve the order and eliminate duplicate providers.</span>
        Set<span class="token operator">&lt;</span>CronetProvider<span class="token operator">></span> providers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedHashSet</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addCronetProviderFromResourceFile</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> providers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addCronetProviderImplByClassName</span><span class="token punctuation">(</span>
                context<span class="token punctuation">,</span> PLAY_SERVICES_CRONET_PROVIDER_CLASS<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addCronetProviderImplByClassName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> GMS_CORE_CRONET_PROVIDER_CLASS<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addCronetProviderImplByClassName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> NATIVE_CRONET_PROVIDER_CLASS<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addCronetProviderImplByClassName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> JAVA_CRONET_PROVIDER_CLASS<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Collections<span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span>providers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">addCronetProviderImplByClassName</span><span class="token punctuation">(</span>
            Context context<span class="token punctuation">,</span> String className<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>CronetProvider<span class="token operator">></span> providers<span class="token punctuation">,</span> <span class="token keyword">boolean</span> logError<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ClassLoader loader <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">CronetProvider</span><span class="token operator">></span> providerClass <span class="token operator">=</span>
                    loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">asSubclass</span><span class="token punctuation">(</span>CronetProvider<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Constructor<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">CronetProvider</span><span class="token operator">></span> ctor <span class="token operator">=</span>
                    providerClass<span class="token punctuation">.</span><span class="token function">getConstructor</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            providers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>ctor<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logReflectiveOperationException</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> logError<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvocationTargetException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logReflectiveOperationException</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> logError<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logReflectiveOperationException</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> logError<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logReflectiveOperationException</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> logError<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">logReflectiveOperationException</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> logError<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">addCronetProviderFromResourceFile</span><span class="token punctuation">(</span>
            Context context<span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>CronetProvider<span class="token operator">></span> providers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> resId <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIdentifier</span><span class="token punctuation">(</span>
                RES_KEY_CRONET_IMPL_CLASS<span class="token punctuation">,</span> <span class="token string">"string"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// Resource not found</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// The resource wasn't included in the app; therefore, there is nothing to add.</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        String className <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>resId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">==</span> null <span class="token operator">||</span> className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>PLAY_SERVICES_CRONET_PROVIDER_CLASS<span class="token punctuation">)</span>
                <span class="token operator">||</span> className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>GMS_CORE_CRONET_PROVIDER_CLASS<span class="token punctuation">)</span>
                <span class="token operator">||</span> className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>JAVA_CRONET_PROVIDER_CLASS<span class="token punctuation">)</span>
                <span class="token operator">||</span> className<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>NATIVE_CRONET_PROVIDER_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addCronetProviderImplByClassName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> className<span class="token punctuation">,</span> providers<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到整个核心就是</p>
<ul>
<li>1.获取资源ID为<code>CronetProviderClassName</code> 所对应的Cronet引擎类名。</li>
<li>2.反射内置好的<code>GmsCoreCronetProvider</code>,<code>PlayServicesCronetProvider</code>，<code>NativeCronetProvider</code>,<code>JavaCronetProvider</code>四种类名为默认引擎提供器</li>
</ul>
<p>在这里我们只需要阅读<code>NativeCronetProvider#createBuilder().mBuilderDelegate</code>相关的源码即可。</p>
<h3 id="NativeCronetProvider-createBuilder"><a href="#NativeCronetProvider-createBuilder" class="headerlink" title="NativeCronetProvider createBuilder"></a>NativeCronetProvider createBuilder</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NativeCronetProvider</span> <span class="token keyword">extends</span> <span class="token class-name">CronetProvider</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@UsedByReflection</span><span class="token punctuation">(</span><span class="token string">"CronetProvider.java"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token function">NativeCronetProvider</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> CronetEngine<span class="token punctuation">.</span>Builder <span class="token function">createBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ICronetEngineBuilder impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeCronetEngineBuilderWithLibraryLoaderImpl</span><span class="token punctuation">(</span>mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExperimentalCronetEngine<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>impl<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从名字能很侵袭的看到整个过程是一个委托者设计模式，构建一个<code>ExperimentalCronetEngine</code>对象，而这个对象将真正的执行者委托给<code>NativeCronetEngineBuilderWithLibraryLoaderImpl</code>.而之前的<code>mBuilderDelegate</code>就是指<code>NativeCronetEngineBuilderWithLibraryLoaderImpl</code>对象。</p>
<h3 id="NativeCronetEngineBuilderWithLibraryLoaderImpl-build"><a href="#NativeCronetEngineBuilderWithLibraryLoaderImpl-build" class="headerlink" title="NativeCronetEngineBuilderWithLibraryLoaderImpl build"></a>NativeCronetEngineBuilderWithLibraryLoaderImpl build</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NativeCronetEngineBuilderImpl</span> <span class="token keyword">extends</span> <span class="token class-name">CronetEngineBuilderImpl</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token function">NativeCronetEngineBuilderImpl</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ExperimentalCronetEngine <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">setUserAgent</span><span class="token punctuation">(</span><span class="token function">getDefaultUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        ExperimentalCronetEngine builder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronetUrlRequestContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Clear MOCK_CERT_VERIFIER reference if there is any, since</span>
        <span class="token comment" spellcheck="true">// the ownership has been transferred to the engine.</span>
        mMockCertVerifier <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> builder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到直接返回<code>CronetUrlRequestContext</code>对象作为<code>CronetEngine</code>返回给应用层。之后会通过<code>CronetUrlRequestContext</code>调用<code>newUrlRequestBuilder</code>获取UrlRequestBuilder。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">CronetEngineBuilderImpl</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mApplicationContext <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enableQuic</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enableHttp2</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enableBrotli</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enableHttpCache</span><span class="token punctuation">(</span>CronetEngine<span class="token punctuation">.</span>Builder<span class="token punctuation">.</span>HTTP_CACHE_DISABLED<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enableNetworkQualityEstimator</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">enablePublicKeyPinningBypassForLocalTrustAnchors</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而<code>CronetEngineBuilderImpl</code>将默认支持quic的选项，http2选项，关闭httpCache。</p>
<h3 id="CronetUrlRequestContext-构造函数"><a href="#CronetUrlRequestContext-构造函数" class="headerlink" title="CronetUrlRequestContext 构造函数"></a>CronetUrlRequestContext 构造函数</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">CronetUrlRequestContext</span><span class="token punctuation">(</span><span class="token keyword">final</span> CronetEngineBuilderImpl builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mRttListenerList<span class="token punctuation">.</span><span class="token function">disableThreadAsserts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mThroughputListenerList<span class="token punctuation">.</span><span class="token function">disableThreadAsserts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mNetworkQualityEstimatorEnabled <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">networkQualityEstimatorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CronetLibraryLoader<span class="token punctuation">.</span><span class="token function">ensureInitialized</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>IntegratedModeState<span class="token punctuation">.</span>INTEGRATED_MODE_ENABLED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            CronetUrlRequestContextJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setMinLogLevel</span><span class="token punctuation">(</span><span class="token function">getLoggingLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">httpCacheMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> HttpCacheType<span class="token punctuation">.</span>DISK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mInUseStoragePath <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">storagePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>sInUseStoragePaths<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sInUseStoragePaths<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>mInUseStoragePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Disk cache storage path already in use"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            mInUseStoragePath <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mUrlRequestContextAdapter <span class="token operator">=</span>
                    CronetUrlRequestContextJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRequestContextAdapter</span><span class="token punctuation">(</span>
                            <span class="token function">createNativeUrlRequestContextConfig</span><span class="token punctuation">(</span>builder<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mUrlRequestContextAdapter <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"Context Adapter creation failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Init native Chromium URLRequestContext on init thread.</span>
        CronetLibraryLoader<span class="token punctuation">.</span><span class="token function">postToInitThread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CronetLibraryLoader<span class="token punctuation">.</span><span class="token function">ensureInitializedOnInitThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// mUrlRequestContextAdapter is guaranteed to exist until</span>
                    <span class="token comment" spellcheck="true">// initialization on init and network threads completes and</span>
                    <span class="token comment" spellcheck="true">// initNetworkThread is called back on network thread.</span>
                    CronetUrlRequestContextJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initRequestContextOnInitThread</span><span class="token punctuation">(</span>
                            mUrlRequestContextAdapter<span class="token punctuation">,</span> CronetUrlRequestContext<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里核心就是围绕3个native方法:</p>
<ul>
<li>1.<code>CronetUrlRequestContextJni.get().setMinLogLevel(getLoggingLevel())</code> 设置日志等级</li>
<li>2.<code>CronetUrlRequestContextJni.get().createRequestContextAdapter</code> 通过<code>createNativeUrlRequestContextConfig</code>获取当前<code>Cronet</code>的配置在native下层创建一个<code>UrlRequestContextAdapter</code></li>
<li>3.<code>CronetUrlRequestContextJni.get().initRequestContextOnInitThread</code>在异步线程中初始化。</li>
</ul>
<p>核心是<code>CronetUrlRequestContextJni.get().createRequestContextAdapter</code> 以及<code>CronetUrlRequestContextJni.get().initRequestContextOnInitThread</code>。要弄懂Cronet在jni层调用之前需要了解Cronet的jni初始化的JNI_OnLoad 做了什么。</p>
<p>不过在这之前先来简单看看<code>createNativeUrlRequestContextConfig</code>看看UrlRequestContextConfig(UrlRequest上下文的配置)都有些什么选项？</p>
<h4 id="createNativeUrlRequestContextConfig-创建Context配置对象"><a href="#createNativeUrlRequestContextConfig-创建Context配置对象" class="headerlink" title="createNativeUrlRequestContextConfig 创建Context配置对象"></a>createNativeUrlRequestContextConfig 创建Context配置对象</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">createNativeUrlRequestContextConfig</span><span class="token punctuation">(</span>CronetEngineBuilderImpl builder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> urlRequestContextConfig <span class="token operator">=</span>
                CronetUrlRequestContextJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRequestContextConfig</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">getUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">storagePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">quicEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">getDefaultQuicUserAgentId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">http2Enabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">brotliEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">cacheDisabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">httpCacheMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">httpCacheMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">experimentalOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">mockCertVerifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> builder<span class="token punctuation">.</span><span class="token function">networkQualityEstimatorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">publicKeyPinningBypassForLocalTrustAnchorsEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        builder<span class="token punctuation">.</span><span class="token function">threadPriority</span><span class="token punctuation">(</span>Process<span class="token punctuation">.</span>THREAD_PRIORITY_BACKGROUND<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urlRequestContextConfig <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Experimental options parsing failed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>CronetEngineBuilderImpl<span class="token punctuation">.</span>QuicHint quicHint <span class="token operator">:</span> builder<span class="token punctuation">.</span><span class="token function">quicHints</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            CronetUrlRequestContextJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addQuicHint</span><span class="token punctuation">(</span>urlRequestContextConfig<span class="token punctuation">,</span> quicHint<span class="token punctuation">.</span>mHost<span class="token punctuation">,</span>
                    quicHint<span class="token punctuation">.</span>mPort<span class="token punctuation">,</span> quicHint<span class="token punctuation">.</span>mAlternatePort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>CronetEngineBuilderImpl<span class="token punctuation">.</span>Pkp pkp <span class="token operator">:</span> builder<span class="token punctuation">.</span><span class="token function">publicKeyPins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            CronetUrlRequestContextJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addPkp</span><span class="token punctuation">(</span>urlRequestContextConfig<span class="token punctuation">,</span> pkp<span class="token punctuation">.</span>mHost<span class="token punctuation">,</span> pkp<span class="token punctuation">.</span>mHashes<span class="token punctuation">,</span>
                    pkp<span class="token punctuation">.</span>mIncludeSubdomains<span class="token punctuation">,</span> pkp<span class="token punctuation">.</span>mExpirationDate<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> urlRequestContextConfig<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到配置除了上面说过的quic模式和，http2模式。还有httpCache的开关以及Cache的大小。</p>
<p>注意如果想要使用<code>QUIC</code>需要设置<code>QuicHint</code>，告诉QUIC协议哪些<code>url</code>和<code>host</code>支持<code>quic</code>协议。</p>
<p>另外，还能通过设置<code>CronetEngineBuilderImpl.Pkp</code> 设置默认的加密公钥。</p>
<h3 id="cronet-jni-JNI-OnLoad"><a href="#cronet-jni-JNI-OnLoad" class="headerlink" title="cronet_jni JNI_OnLoad"></a>cronet_jni JNI_OnLoad</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">extern</span> <span class="token string">"C"</span> jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> cronet<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">CronetOnLoad</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> reserved<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">JNI_OnUnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cronet<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">CronetOnUnLoad</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> reserved<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c">jint <span class="token function">CronetOnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  base<span class="token punctuation">:</span><span class="token punctuation">:</span>android<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">InitVM</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>
  JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> base<span class="token punctuation">:</span><span class="token punctuation">:</span>android<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">RegisterMainDexNatives</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">RegisterNonMainDexNatives</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>base<span class="token punctuation">:</span><span class="token punctuation">:</span>android<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">OnJNIOnLoadInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token function">NativeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> JNI_VERSION_1_6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">CronetOnUnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> jvm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>base<span class="token punctuation">:</span><span class="token punctuation">:</span>ThreadPoolInstance<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    base<span class="token punctuation">:</span><span class="token punctuation">:</span>ThreadPoolInstance<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">Shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  base<span class="token punctuation">:</span><span class="token punctuation">:</span>android<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">LibraryLoaderExitHook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.<code>RegisterMainDexNatives</code> 和 <code>RegisterNonMainDexNatives</code> 实际上是加载通过<code>jni_registration_generator.py</code>生成的cpp文件。这种文件生成出来就是为了减少<code>dlsym()</code>耗时。</li>
</ul>
<p>了解<code>jni</code>的小伙伴都会清楚<code>jni</code>有两种注册方式一种是简单的直接声明native方法，然后通过AS可以自动生成<code>包名_类名_方法名</code>的cpp方法。而后虚拟机加载native的方法时候，就会通过<code>dlsym()</code>调用查找<code>so</code>动态库中的对应的方法。另一种则是通过<code>JNIEnv-&gt;RegisterNatives</code>手动在<code>JNI_OnLoad</code>注册当前的native方法关联的java方法(注意要有指向包和类名)。</p>
<p>而<code>jni_registration_generator.py</code>就是会遍历所有java文件中的native方法并<code>JNIEnv-&gt;RegisterNatives</code>手动注册的代码cpp代码。同时会遍历Java文件中带上了<code>@CalledByNative</code>方法，说明这是<code>native</code>想要调用<code>java</code>方法，也会生成相关的反射jmethod的方法的文件。</p>
<p>在这里<code>RegisterMainDexNatives</code> 和 <code>RegisterNonMainDexNatives</code> 本质上就是装在生成好的动态注册的jni方法。</p>
<p>这个不是重点之后有机会再仔细聊聊。</p>
<ul>
<li><ol start="2">
<li><code>OnJNIOnLoadInit</code> 这个方法就是获取<code>JNIUtils</code>类中的<code>ClassLoader</code>,并获取<code>ClassLoader#loadClass</code>的jmethodID保存到全局变量<code>g_class_loader_load_class_method_id</code></li>
</ol>
</li>
<li><p>3.<code>NativeInit</code> 在全局生成一个名为<code>Cronet</code>的线程池。</p>
</li>
</ul>
<h3 id="CreateRequestContextAdapter-初始化"><a href="#CreateRequestContextAdapter-初始化" class="headerlink" title="CreateRequestContextAdapter 初始化"></a>CreateRequestContextAdapter 初始化</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token comment" spellcheck="true">// Creates RequestContextAdater if config is valid URLRequestContextConfig,</span>
<span class="token comment" spellcheck="true">// returns 0 otherwise.</span>
<span class="token keyword">static</span> jlong <span class="token function">JNI_CronetUrlRequestContext_CreateRequestContextAdapter</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jlong jconfig<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestContextConfig<span class="token operator">></span> <span class="token function">context_config</span><span class="token punctuation">(</span>
      <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>URLRequestContextConfig<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>jconfig<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  CronetURLRequestContextAdapter<span class="token operator">*</span> context_adapter <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token function">CronetURLRequestContextAdapter</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>context_config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>context_adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简答就是初始化了<code>CronetURLRequestContextAdapter</code>一个cpp对象对应java对象，并返回当前对象的地址到java中。</p>
<h4 id="CreateRequestContextAdapter-头文件"><a href="#CreateRequestContextAdapter-头文件" class="headerlink" title="CreateRequestContextAdapter 头文件"></a>CreateRequestContextAdapter 头文件</h4><p>要了解一个c++的类，首先看看头文件，然后再看看构造函数。</p>
<pre class="line-numbers language-h"><code class="language-h">namespace net {
class NetLog;
class URLRequestContext;
}  // namespace net

namespace cronet {
class TestUtil;

struct URLRequestContextConfig;

// Adapter between Java CronetUrlRequestContext and CronetURLRequestContext.
class CronetURLRequestContextAdapter
    : public CronetURLRequestContext::Callback {
 public:
  explicit CronetURLRequestContextAdapter(
      std::unique_ptr<URLRequestContextConfig> context_config);

  CronetURLRequestContextAdapter(const CronetURLRequestContextAdapter&) =
      delete;
  CronetURLRequestContextAdapter& operator=(
      const CronetURLRequestContextAdapter&) = delete;

  ~CronetURLRequestContextAdapter() override;

...
 private:
  friend class TestUtil;

  // Native Cronet URL Request Context.
  raw_ptr<CronetURLRequestContext> context_;

  // Java object that owns this CronetURLRequestContextAdapter.
  base::android::ScopedJavaGlobalRef<jobject> jcronet_url_request_context_;
};

}  // namespace cronet

#endif  // COMPONENTS_CRONET_ANDROID_CRONET_URL_REQUEST_CONTEXT_ADAPTER_H_
};

}  // namespace cronet
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里其实持有了一个<code>CronetURLRequestContext</code>native对象，这个对象顾名思义就是Cronet请求时候的上下文。同时持有将会持有一个<code>UrlRequestContext</code>的java对象。</p>
<p>之后当<code>Cronet</code>的状态发生变化都会通过这里的回调java层的<code>CronetUrlRequestContext</code>中的监听。</p>
<h4 id="CronetURLRequestContextAdapter-构造函数"><a href="#CronetURLRequestContextAdapter-构造函数" class="headerlink" title="CronetURLRequestContextAdapter 构造函数"></a>CronetURLRequestContextAdapter 构造函数</h4><pre class="line-numbers language-cpp"><code class="language-cpp">CronetURLRequestContextAdapter<span class="token operator">::</span><span class="token function">CronetURLRequestContextAdapter</span><span class="token punctuation">(</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestContextConfig<span class="token operator">></span> context_config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Create context and pass ownership of |this| (self) to the context.</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>CronetURLRequestContextAdapter<span class="token operator">></span> <span class="token function">self</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> BUILDFLAG(INTEGRATED_MODE)</span>
  <span class="token comment" spellcheck="true">// Create CronetURLRequestContext running in integrated network task runner.</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
  context_ <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token function">CronetURLRequestContext</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>context_config<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>CronetURLRequestContextAdapter 则会创建一个<code>CronetURLRequestContext</code>对象</p>
<h4 id="CronetURLRequestContext-头文件"><a href="#CronetURLRequestContext-头文件" class="headerlink" title="CronetURLRequestContext 头文件"></a>CronetURLRequestContext 头文件</h4><pre class="line-numbers language-h"><code class="language-h">class CronetURLRequestContext {
 public:
  // Callback implemented by CronetURLRequestContext() caller and owned by
  // CronetURLRequestContext::NetworkTasks.
  class Callback {
   public:
    virtual ~Callback() = default;

    // Invoked on network thread when initialized.
    virtual void OnInitNetworkThread() = 0;

    // Invoked on network thread immediately prior to destruction.
    virtual void OnDestroyNetworkThread() = 0;

...
  };


  CronetURLRequestContext(
      std::unique_ptr<URLRequestContextConfig> context_config,
      std::unique_ptr<Callback> callback,
      scoped_refptr<base::SingleThreadTaskRunner> network_task_runner =
          nullptr);

  CronetURLRequestContext(const CronetURLRequestContext&) = delete;
  CronetURLRequestContext& operator=(const CronetURLRequestContext&) = delete;

  // Releases all resources for the request context and deletes the object.
  // Blocks until network thread is destroyed after running all pending tasks.
  virtual ~CronetURLRequestContext();

  // Called on init thread to initialize URLRequestContext.
  void InitRequestContextOnInitThread();
...

 private:
  friend class TestUtil;
  class ContextGetter;

  class NetworkTasks : public net::EffectiveConnectionTypeObserver,
                       public net::RTTAndThroughputEstimatesObserver,
                       public net::NetworkQualityEstimator::RTTObserver,
                       public net::NetworkQualityEstimator::ThroughputObserver {
   public:
    // Invoked off the network thread.
    NetworkTasks(std::unique_ptr<URLRequestContextConfig> config,
                 std::unique_ptr<CronetURLRequestContext::Callback> callback);

    NetworkTasks(const NetworkTasks&) = delete;
    NetworkTasks& operator=(const NetworkTasks&) = delete;

    // Invoked on the network thread.
    ~NetworkTasks() override;
...

   private:
...
  };

...
};

}  // namespace cronet

#endif  // COMPONENTS_CRONET_CRONET_URL_REQUEST_CONTEXT_H_
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个头文件分为3部分：</p>
<ul>
<li><code>CronetURLRequestContext</code> 承载所有<code>URLRequest</code>请求的上下文，主要用于构建网络任务的环境，回调网络质量相关的回调（如rtt耗时等）</li>
<li><code>Callback</code> 用于回调来自<code>NetworkQualityEstimator</code>对象对网络质量的监控</li>
<li><code>NetworkTasks</code> 实现了<code>Callback</code>的回调，承载网络请求的起始</li>
</ul>
<h4 id="CronetURLRequestContext-构造函数"><a href="#CronetURLRequestContext-构造函数" class="headerlink" title="CronetURLRequestContext 构造函数"></a>CronetURLRequestContext 构造函数</h4><pre class="line-numbers language-cpp"><code class="language-cpp">
CronetURLRequestContext<span class="token operator">::</span><span class="token function">CronetURLRequestContext</span><span class="token punctuation">(</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestContextConfig<span class="token operator">></span> context_config<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Callback<span class="token operator">></span> callback<span class="token punctuation">,</span>
    scoped_refptr<span class="token operator">&lt;</span>base<span class="token operator">::</span>SingleThreadTaskRunner<span class="token operator">></span> network_task_runner<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">bidi_stream_detect_broken_connection_</span><span class="token punctuation">(</span>
          context_config<span class="token operator">-</span><span class="token operator">></span>bidi_stream_detect_broken_connection<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">heartbeat_interval_</span><span class="token punctuation">(</span>context_config<span class="token operator">-</span><span class="token operator">></span>heartbeat_interval<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">default_load_flags_</span><span class="token punctuation">(</span>
          net<span class="token operator">::</span>LOAD_NORMAL <span class="token operator">|</span>
          <span class="token punctuation">(</span>context_config<span class="token operator">-</span><span class="token operator">></span>load_disable_cache <span class="token operator">?</span> net<span class="token operator">::</span>LOAD_DISABLE_CACHE <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">network_tasks_</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token function">NetworkTasks</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>context_config<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">network_task_runner_</span><span class="token punctuation">(</span>network_task_runner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>network_task_runner_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    network_thread_ <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>base<span class="token operator">::</span>Thread<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"network"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    base<span class="token operator">::</span>Thread<span class="token operator">::</span>Options options<span class="token punctuation">;</span>
    options<span class="token punctuation">.</span>message_pump_type <span class="token operator">=</span> base<span class="token operator">::</span>MessagePumpType<span class="token operator">::</span>IO<span class="token punctuation">;</span>
    network_thread_<span class="token operator">-</span><span class="token operator">></span><span class="token function">StartWithOptions</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    network_task_runner_ <span class="token operator">=</span> network_thread_<span class="token operator">-</span><span class="token operator">></span><span class="token function">task_runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>初始化一个<code>NetworkTasks</code>作为一个网络请求任务承载者。并初始化一个名为<code>network</code>的线程，并以这个线程创建一个<code>looper</code>赋值给<code>network_task_runner_</code>，之后所有的请求任务都会在这个loop中开始。</p>
<h4 id="initRequestContextOnInitThread"><a href="#initRequestContextOnInitThread" class="headerlink" title="initRequestContextOnInitThread"></a>initRequestContextOnInitThread</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CronetURLRequestContext<span class="token operator">::</span><span class="token function">InitRequestContextOnInitThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">DCHECK</span><span class="token punctuation">(</span><span class="token function">OnInitThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> proxy_config_service <span class="token operator">=</span>
      cronet<span class="token operator">::</span><span class="token function">CreateProxyConfigService</span><span class="token punctuation">(</span><span class="token function">GetNetworkTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  g_net_log<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">EnsureInitializedOnInitThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">GetNetworkTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span>
      FROM_HERE<span class="token punctuation">,</span>
      base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CronetURLRequestContext<span class="token operator">::</span>NetworkTasks<span class="token operator">::</span>Initialize<span class="token punctuation">,</span>
                     base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span>network_tasks_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GetNetworkTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     <span class="token function">GetFileThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">task_runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>proxy_config_service<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>GetNetworkTaskRunner</code>获取<code>network_task_runner_</code>调用<code>PostTask</code>进入切换到<code>network</code>线程的loop，执行<code>CronetURLRequestContext::NetworkTasks::Initialize</code>方法</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CronetURLRequestContext<span class="token operator">::</span>NetworkTasks<span class="token operator">::</span><span class="token function">Initialize</span><span class="token punctuation">(</span>
    scoped_refptr<span class="token operator">&lt;</span>base<span class="token operator">::</span>SingleThreadTaskRunner<span class="token operator">></span> network_task_runner<span class="token punctuation">,</span>
    scoped_refptr<span class="token operator">&lt;</span>base<span class="token operator">::</span>SequencedTaskRunner<span class="token operator">></span> file_task_runner<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>net<span class="token operator">::</span>ProxyConfigService<span class="token operator">></span> proxy_config_service<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestContextConfig<span class="token operator">></span> <span class="token function">config</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>context_config_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  network_task_runner_ <span class="token operator">=</span> network_task_runner<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">></span>network_thread_priority<span class="token punctuation">)</span>
    <span class="token function">SetNetworkThreadPriorityOnNetworkThread</span><span class="token punctuation">(</span>
        config<span class="token operator">-</span><span class="token operator">></span>network_thread_priority<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  base<span class="token operator">::</span><span class="token function">DisallowBlocking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  net<span class="token operator">::</span>URLRequestContextBuilder context_builder<span class="token punctuation">;</span>
  context_builder<span class="token punctuation">.</span><span class="token function">set_network_delegate</span><span class="token punctuation">(</span>
      std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>BasicNetworkDelegate<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context_builder<span class="token punctuation">.</span><span class="token function">set_net_log</span><span class="token punctuation">(</span>g_net_log<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">net_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  context_builder<span class="token punctuation">.</span><span class="token function">set_proxy_resolution_service</span><span class="token punctuation">(</span>
      cronet<span class="token operator">::</span><span class="token function">CreateProxyResolutionService</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>proxy_config_service<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                           g_net_log<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">net_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  config<span class="token operator">-</span><span class="token operator">></span><span class="token function">ConfigureURLRequestContextBuilder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>context_builder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  effective_experimental_options_ <span class="token operator">=</span>
      base<span class="token operator">::</span><span class="token function">Value</span><span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">></span>effective_experimental_options<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">></span>enable_network_quality_estimator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>net<span class="token operator">::</span>NetworkQualityEstimatorParams<span class="token operator">></span> nqe_params <span class="token operator">=</span>
        std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>net<span class="token operator">::</span>NetworkQualityEstimatorParams<span class="token operator">></span><span class="token punctuation">(</span>
            std<span class="token operator">::</span>map<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token punctuation">,</span> std<span class="token operator">::</span>string<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">></span>nqe_forced_effective_connection_type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      nqe_params<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetForcedEffectiveConnectionType</span><span class="token punctuation">(</span>
          config<span class="token operator">-</span><span class="token operator">></span>nqe_forced_effective_connection_type<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    network_quality_estimator_ <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>net<span class="token operator">::</span>NetworkQualityEstimator<span class="token operator">></span><span class="token punctuation">(</span>
        std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>nqe_params<span class="token punctuation">)</span><span class="token punctuation">,</span> g_net_log<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">net_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    network_quality_estimator_<span class="token operator">-</span><span class="token operator">></span><span class="token function">AddEffectiveConnectionTypeObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    network_quality_estimator_<span class="token operator">-</span><span class="token operator">></span><span class="token function">AddRTTAndThroughputEstimatesObserver</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    context_builder<span class="token punctuation">.</span><span class="token function">set_network_quality_estimator</span><span class="token punctuation">(</span>
        network_quality_estimator_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token comment" spellcheck="true">// Disable net::CookieStore.</span>
  context_builder<span class="token punctuation">.</span><span class="token function">SetCookieStore</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  context_ <span class="token operator">=</span> context_builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">></span>enable_quic<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> quic_hint <span class="token operator">:</span> config<span class="token operator">-</span><span class="token operator">></span>quic_hints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>quic_hint<span class="token operator">-</span><span class="token operator">></span>host<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Empty QUIC hint host: "</span> <span class="token operator">&lt;&lt;</span> quic_hint<span class="token operator">-</span><span class="token operator">></span>host<span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      url<span class="token operator">::</span>CanonHostInfo host_info<span class="token punctuation">;</span>
      std<span class="token operator">::</span>string <span class="token function">canon_host</span><span class="token punctuation">(</span>
          net<span class="token operator">::</span><span class="token function">CanonicalizeHost</span><span class="token punctuation">(</span>quic_hint<span class="token operator">-</span><span class="token operator">></span>host<span class="token punctuation">,</span> <span class="token operator">&amp;</span>host_info<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>host_info<span class="token punctuation">.</span><span class="token function">IsIPAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token operator">!</span>net<span class="token operator">::</span><span class="token function">IsCanonicalizedHostCompliant</span><span class="token punctuation">(</span>canon_host<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>quic_hint<span class="token operator">-</span><span class="token operator">></span>port <span class="token operator">&lt;=</span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>uint16_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          quic_hint<span class="token operator">-</span><span class="token operator">></span>port <span class="token operator">></span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>uint16_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>quic_hint<span class="token operator">-</span><span class="token operator">></span>alternate_port <span class="token operator">&lt;=</span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>uint16_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          quic_hint<span class="token operator">-</span><span class="token operator">></span>alternate_port <span class="token operator">></span> std<span class="token operator">::</span>numeric_limits<span class="token operator">&lt;</span>uint16_t<span class="token operator">></span><span class="token operator">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      url<span class="token operator">::</span>SchemeHostPort <span class="token function">quic_server</span><span class="token punctuation">(</span><span class="token string">"https"</span><span class="token punctuation">,</span> canon_host<span class="token punctuation">,</span> quic_hint<span class="token operator">-</span><span class="token operator">></span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
      net<span class="token operator">::</span>AlternativeService <span class="token function">alternative_service</span><span class="token punctuation">(</span>
          net<span class="token operator">::</span>kProtoQUIC<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span>
          <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>uint16_t<span class="token operator">></span><span class="token punctuation">(</span>quic_hint<span class="token operator">-</span><span class="token operator">></span>alternate_port<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">http_server_properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">SetQuicAlternativeService</span><span class="token punctuation">(</span>
          quic_server<span class="token punctuation">,</span> net<span class="token operator">::</span><span class="token function">NetworkIsolationKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> alternative_service<span class="token punctuation">,</span>
          base<span class="token operator">::</span>Time<span class="token operator">::</span><span class="token function">Max</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> quic<span class="token operator">::</span><span class="token function">ParsedQuicVersionVector</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> pkp <span class="token operator">:</span> config<span class="token operator">-</span><span class="token operator">></span>pkp_list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Add the host pinning.</span>
    context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">transport_security_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">AddHPKP</span><span class="token punctuation">(</span>
        pkp<span class="token operator">-</span><span class="token operator">></span>host<span class="token punctuation">,</span> pkp<span class="token operator">-</span><span class="token operator">></span>expiration_date<span class="token punctuation">,</span> pkp<span class="token operator">-</span><span class="token operator">></span>include_subdomains<span class="token punctuation">,</span>
        pkp<span class="token operator">-</span><span class="token operator">></span>pin_hashes<span class="token punctuation">,</span> GURL<span class="token operator">::</span><span class="token function">EmptyGURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">transport_security_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token operator">-</span><span class="token operator">></span><span class="token function">SetEnablePublicKeyPinningBypassForLocalTrustAnchors</span><span class="token punctuation">(</span>
          config<span class="token operator">-</span><span class="token operator">></span>bypass_public_key_pinning_for_local_trust_anchors<span class="token punctuation">)</span><span class="token punctuation">;</span>

  callback_<span class="token operator">-</span><span class="token operator">></span><span class="token function">OnInitNetworkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  is_context_initialized_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>config<span class="token operator">-</span><span class="token operator">></span>enable_network_quality_estimator <span class="token operator">&amp;&amp;</span> cronet_prefs_manager_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    network_task_runner_<span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span>
        FROM_HERE<span class="token punctuation">,</span>
        base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span>CronetURLRequestContext<span class="token operator">::</span>NetworkTasks<span class="token operator">::</span>InitializeNQEPrefs<span class="token punctuation">,</span>
            base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token macro property">#<span class="token directive keyword">if</span> BUILDFLAG(ENABLE_REPORTING)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">reporting_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> preloaded_header <span class="token operator">:</span> config<span class="token operator">-</span><span class="token operator">></span>preloaded_report_to_headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">reporting_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ProcessReportToHeader</span><span class="token punctuation">(</span>
          preloaded_header<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> net<span class="token operator">::</span><span class="token function">NetworkIsolationKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          preloaded_header<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">network_error_logging_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> preloaded_header <span class="token operator">:</span> config<span class="token operator">-</span><span class="token operator">></span>preloaded_nel_headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">network_error_logging_service</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">OnHeader</span><span class="token punctuation">(</span>
          net<span class="token operator">::</span><span class="token function">NetworkIsolationKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> preloaded_header<span class="token punctuation">.</span>origin<span class="token punctuation">,</span> net<span class="token operator">::</span><span class="token function">IPAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          preloaded_header<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span>  </span><span class="token comment" spellcheck="true">// BUILDFLAG(ENABLE_REPORTING)</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>tasks_waiting_for_context_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>tasks_waiting_for_context_<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    tasks_waiting_for_context_<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>别看这段代码很长实际上做的事情也就如下几件：</p>
<ul>
<li>1.根据<code>URLRequestContextConfig</code>装载出<code>NetworkQualityEstimator</code>网络质量监控器</li>
<li>2.创建<code>URLRequestContext</code> 对象，为之后的<code>UrlRequest</code>做准备</li>
<li>3.如果<code>URLRequestContextConfig</code>允许了quic协议那么会加载所有的<code>QuicHint</code>中的资源路径，端口号作为识别。之后遇到这些请求就会使用quic协议，最后生成的<code>SchemeHostPort</code>通过<code>SetQuicAlternativeService</code>保存到<code>URLRequestContext</code></li>
</ul>
<p>到目前为止java层的<code>CronetUrlRequestContext</code>通过native层的<code>CronetUrlRequestContextAdapter</code>创建了一个对应在native层的<code>CronetUrlRequestContext</code>对象进行一一对应。</p>
<p>当准备好了<code>CronetUrlRequestContext</code>,就可以使用<code>CronetUrlRequestContext</code>创建<code>newUrlRequestBuilder</code>请求</p>
<h4 id="CronetEngineBase-newUrlRequestBuilder-创建请求对象"><a href="#CronetEngineBase-newUrlRequestBuilder-创建请求对象" class="headerlink" title="CronetEngineBase newUrlRequestBuilder 创建请求对象"></a>CronetEngineBase newUrlRequestBuilder 创建请求对象</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ExperimentalUrlRequest<span class="token punctuation">.</span>Builder <span class="token function">newUrlRequestBuilder</span><span class="token punctuation">(</span>
            String url<span class="token punctuation">,</span> UrlRequest<span class="token punctuation">.</span>Callback callback<span class="token punctuation">,</span> Executor executor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">UrlRequestBuilderImpl</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="UrlRequestBuilderImpl-createRequest-创建请求对象"><a href="#UrlRequestBuilderImpl-createRequest-创建请求对象" class="headerlink" title="UrlRequestBuilderImpl createRequest 创建请求对象"></a>UrlRequestBuilderImpl createRequest 创建请求对象</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UrlRequestBase <span class="token function">createRequest</span><span class="token punctuation">(</span>String url<span class="token punctuation">,</span> UrlRequest<span class="token punctuation">.</span>Callback callback<span class="token punctuation">,</span> Executor executor<span class="token punctuation">,</span>
            <span class="token keyword">int</span> priority<span class="token punctuation">,</span> Collection<span class="token operator">&lt;</span>Object<span class="token operator">></span> requestAnnotations<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disableCache<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> disableConnectionMigration<span class="token punctuation">,</span> <span class="token keyword">boolean</span> allowDirectExecutor<span class="token punctuation">,</span>
            <span class="token keyword">boolean</span> trafficStatsTagSet<span class="token punctuation">,</span> <span class="token keyword">int</span> trafficStatsTag<span class="token punctuation">,</span> <span class="token keyword">boolean</span> trafficStatsUidSet<span class="token punctuation">,</span>
            <span class="token keyword">int</span> trafficStatsUid<span class="token punctuation">,</span> RequestFinishedInfo<span class="token punctuation">.</span>Listener requestFinishedListener<span class="token punctuation">,</span>
            <span class="token keyword">int</span> idempotency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkHaveAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CronetUrlRequest</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> url<span class="token punctuation">,</span> priority<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> executor<span class="token punctuation">,</span> requestAnnotations<span class="token punctuation">,</span>
                    disableCache<span class="token punctuation">,</span> disableConnectionMigration<span class="token punctuation">,</span> allowDirectExecutor<span class="token punctuation">,</span>
                    trafficStatsTagSet<span class="token punctuation">,</span> trafficStatsTag<span class="token punctuation">,</span> trafficStatsUidSet<span class="token punctuation">,</span> trafficStatsUid<span class="token punctuation">,</span>
                    requestFinishedListener<span class="token punctuation">,</span> idempotency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单，这里把之前在<code>UrlRequestBuilderImpl</code>组合的参数都保存到<code>CronetUrlRequest</code>返回给应用层。</p>
<h5 id="CronetUrlRequest-start-启动请求"><a href="#CronetUrlRequest-start-启动请求" class="headerlink" title="CronetUrlRequest.start 启动请求"></a>CronetUrlRequest.start 启动请求</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mUrlRequestAdapterLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">checkNotStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                mUrlRequestAdapter <span class="token operator">=</span> CronetUrlRequestJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createRequestAdapter</span><span class="token punctuation">(</span>
                        CronetUrlRequest<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> mRequestContext<span class="token punctuation">.</span><span class="token function">getUrlRequestContextAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        mInitialUrl<span class="token punctuation">,</span> mPriority<span class="token punctuation">,</span> mDisableCache<span class="token punctuation">,</span> mDisableConnectionMigration<span class="token punctuation">,</span>
                        mRequestContext<span class="token punctuation">.</span><span class="token function">hasRequestFinishedListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token operator">||</span> mRequestFinishedListener <span class="token operator">!=</span> null<span class="token punctuation">,</span>
                        mTrafficStatsTagSet<span class="token punctuation">,</span> mTrafficStatsTag<span class="token punctuation">,</span> mTrafficStatsUidSet<span class="token punctuation">,</span>
                        mTrafficStatsUid<span class="token punctuation">,</span> mIdempotency<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mRequestContext<span class="token punctuation">.</span><span class="token function">onRequestStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mInitialMethod <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>CronetUrlRequestJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHttpMethod</span><span class="token punctuation">(</span>
                                mUrlRequestAdapter<span class="token punctuation">,</span> CronetUrlRequest<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> mInitialMethod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Invalid http method "</span> <span class="token operator">+</span> mInitialMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">boolean</span> hasContentType <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> header <span class="token operator">:</span> mRequestHeaders<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>header<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"Content-Type"</span><span class="token punctuation">)</span>
                            <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>header<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        hasContentType <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>CronetUrlRequestJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addRequestHeader</span><span class="token punctuation">(</span>mUrlRequestAdapter<span class="token punctuation">,</span>
                                CronetUrlRequest<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> header<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                                <span class="token string">"Invalid header "</span> <span class="token operator">+</span> header<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> header<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mUploadDataStream <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hasContentType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span>
                                <span class="token string">"Requests with upload data must have a Content-Type."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    mStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    mUploadDataStream<span class="token punctuation">.</span><span class="token function">postTaskToExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mUploadDataStream<span class="token punctuation">.</span><span class="token function">initializeWithRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>mUrlRequestAdapterLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isDoneLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                mUploadDataStream<span class="token punctuation">.</span><span class="token function">attachNativeAdapterToRequest</span><span class="token punctuation">(</span>mUrlRequestAdapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token function">startInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// If there's an exception, cleanup and then throw the exception to the caller.</span>
                <span class="token comment" spellcheck="true">// start() is synchronized so we do not acquire mUrlRequestAdapterLock here.</span>
                <span class="token function">destroyRequestAdapterLocked</span><span class="token punctuation">(</span>RequestFinishedInfo<span class="token punctuation">.</span>FAILED<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">startInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">"mUrlRequestAdapterLock"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">startInternalLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CronetUrlRequestJni<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>mUrlRequestAdapter<span class="token punctuation">,</span> CronetUrlRequest<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里围绕着4个核心的jni方法：</p>
<ul>
<li>1.<code>createRequestAdapter</code> 生成一个jni的<code>UrlRequestAdapter</code>对象</li>
<li>2.回调<code>onRequestStarted</code>生命周期</li>
<li>3.<code>setHttpMethod</code> 为jni的<code>UrlRequestAdapter</code> 设置 http请求类型</li>
<li>4.<code>addRequestHeader</code>为请求装载header</li>
<li>5.<code>mUploadDataStream</code>读取并把body的数据缓存到jni的<code>UploadDataStream</code>中.</li>
<li>6.调用<code>startInternalLocked</code>也就是<code>CronetUrlRequest</code>的start</li>
</ul>
<h4 id="CronetURLRequestAdapter-创建"><a href="#CronetURLRequestAdapter-创建" class="headerlink" title="CronetURLRequestAdapter 创建"></a>CronetURLRequestAdapter 创建</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> jlong <span class="token function">JNI_CronetUrlRequest_CreateRequestAdapter</span><span class="token punctuation">(</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span><span class="token operator">&amp;</span> jurl_request<span class="token punctuation">,</span>
    jlong jurl_request_context_adapter<span class="token punctuation">,</span>
    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jstring<span class="token operator">></span><span class="token operator">&amp;</span> jurl_string<span class="token punctuation">,</span>
    jint jpriority<span class="token punctuation">,</span>
    jboolean jdisable_cache<span class="token punctuation">,</span>
    jboolean jdisable_connection_migration<span class="token punctuation">,</span>
    jboolean jenable_metrics<span class="token punctuation">,</span>
    jboolean jtraffic_stats_tag_set<span class="token punctuation">,</span>
    jint jtraffic_stats_tag<span class="token punctuation">,</span>
    jboolean jtraffic_stats_uid_set<span class="token punctuation">,</span>
    jint jtraffic_stats_uid<span class="token punctuation">,</span>
    jint jidempotency<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  CronetURLRequestContextAdapter<span class="token operator">*</span> context_adapter <span class="token operator">=</span>
      reinterpret_cast<span class="token operator">&lt;</span>CronetURLRequestContextAdapter<span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span>
          jurl_request_context_adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>


  CronetURLRequestAdapter<span class="token operator">*</span> adapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CronetURLRequestAdapter</span><span class="token punctuation">(</span>
      context_adapter<span class="token punctuation">,</span> env<span class="token punctuation">,</span> jurl_request<span class="token punctuation">,</span> url<span class="token punctuation">,</span>
      static_cast<span class="token operator">&lt;</span>net<span class="token operator">:</span><span class="token operator">:</span>RequestPriority<span class="token operator">></span><span class="token punctuation">(</span>jpriority<span class="token punctuation">)</span><span class="token punctuation">,</span> jdisable_cache<span class="token punctuation">,</span>
      jdisable_connection_migration<span class="token punctuation">,</span> jenable_metrics<span class="token punctuation">,</span> jtraffic_stats_tag_set<span class="token punctuation">,</span>
      jtraffic_stats_tag<span class="token punctuation">,</span> jtraffic_stats_uid_set<span class="token punctuation">,</span> jtraffic_stats_uid<span class="token punctuation">,</span>
      static_cast<span class="token operator">&lt;</span>net<span class="token operator">:</span><span class="token operator">:</span>Idempotency<span class="token operator">></span><span class="token punctuation">(</span>jidempotency<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> reinterpret_cast<span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">CronetURLRequestAdapter<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CronetURLRequestAdapter</span><span class="token punctuation">(</span>
    CronetURLRequestContextAdapter<span class="token operator">*</span> context<span class="token punctuation">,</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    jobject jurl_request<span class="token punctuation">,</span>
    <span class="token keyword">const</span> GURL<span class="token operator">&amp;</span> url<span class="token punctuation">,</span>
    net<span class="token operator">:</span><span class="token operator">:</span>RequestPriority priority<span class="token punctuation">,</span>
    jboolean jdisable_cache<span class="token punctuation">,</span>
    jboolean jdisable_connection_migration<span class="token punctuation">,</span>
    jboolean jenable_metrics<span class="token punctuation">,</span>
    jboolean jtraffic_stats_tag_set<span class="token punctuation">,</span>
    jint jtraffic_stats_tag<span class="token punctuation">,</span>
    jboolean jtraffic_stats_uid_set<span class="token punctuation">,</span>
    jint jtraffic_stats_uid<span class="token punctuation">,</span>
    net<span class="token operator">:</span><span class="token operator">:</span>Idempotency idempotency<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">request_</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">CronetURLRequest</span><span class="token punctuation">(</span>context<span class="token operator">-</span><span class="token operator">></span><span class="token function">cronet_url_request_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>CronetURLRequestAdapter<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               url<span class="token punctuation">,</span>
                               priority<span class="token punctuation">,</span>
                               jdisable_cache <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">,</span>
                               jdisable_connection_migration <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">,</span>
                               jenable_metrics <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">,</span>
                               jtraffic_stats_tag_set <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">,</span>
                               jtraffic_stats_tag<span class="token punctuation">,</span>
                               jtraffic_stats_uid_set <span class="token operator">==</span> JNI_TRUE<span class="token punctuation">,</span>
                               jtraffic_stats_uid<span class="token punctuation">,</span>
                               idempotency<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  owner_<span class="token punctuation">.</span><span class="token function">Reset</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jurl_request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>CronetURLRequestContextAdapter</code> 持有一个 <code>CronetURLRequest</code>对象。刚刚好对应java层中的<code>CronetURLRequest</code>。整个请求的发起就是从<code>CronetURLRequest</code>开始。</p>
<h5 id="CronetURLRequest-构造函数"><a href="#CronetURLRequest-构造函数" class="headerlink" title="CronetURLRequest 构造函数"></a>CronetURLRequest 构造函数</h5><pre class="line-numbers language-cpp"><code class="language-cpp">CronetURLRequest<span class="token operator">::</span><span class="token function">CronetURLRequest</span><span class="token punctuation">(</span>CronetURLRequestContext<span class="token operator">*</span> context<span class="token punctuation">,</span>
                                   std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Callback<span class="token operator">></span> callback<span class="token punctuation">,</span>
                                   <span class="token keyword">const</span> GURL<span class="token operator">&amp;</span> url<span class="token punctuation">,</span>
                                   net<span class="token operator">::</span>RequestPriority priority<span class="token punctuation">,</span>
                                   <span class="token keyword">bool</span> disable_cache<span class="token punctuation">,</span>
                                   <span class="token keyword">bool</span> disable_connection_migration<span class="token punctuation">,</span>
                                   <span class="token keyword">bool</span> enable_metrics<span class="token punctuation">,</span>
                                   <span class="token keyword">bool</span> traffic_stats_tag_set<span class="token punctuation">,</span>
                                   int32_t traffic_stats_tag<span class="token punctuation">,</span>
                                   <span class="token keyword">bool</span> traffic_stats_uid_set<span class="token punctuation">,</span>
                                   int32_t traffic_stats_uid<span class="token punctuation">,</span>
                                   net<span class="token operator">::</span>Idempotency idempotency<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">context_</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">network_tasks_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     url<span class="token punctuation">,</span>
                     priority<span class="token punctuation">,</span>
                     <span class="token function">CalculateLoadFlags</span><span class="token punctuation">(</span>context<span class="token operator">-</span><span class="token operator">></span><span class="token function">default_load_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                        disable_cache<span class="token punctuation">,</span>
                                        disable_connection_migration<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     enable_metrics<span class="token punctuation">,</span>
                     traffic_stats_tag_set<span class="token punctuation">,</span>
                     traffic_stats_tag<span class="token punctuation">,</span>
                     traffic_stats_uid_set<span class="token punctuation">,</span>
                     traffic_stats_uid<span class="token punctuation">,</span>
                     idempotency<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initial_method_</span><span class="token punctuation">(</span><span class="token string">"GET"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">initial_request_headers_</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>net<span class="token operator">::</span>HttpRequestHeaders<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">DCHECK</span><span class="token punctuation">(</span><span class="token operator">!</span>context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">IsOnNetworkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到<code>CronetURLRequest</code>默认设置<code>GET</code> http的方法，同时创建<code>HttpRequestHeaders</code>接受Http协议的头部信息。</p>
<h4 id="CronetURLRequest-start"><a href="#CronetURLRequest-start" class="headerlink" title="CronetURLRequest start"></a>CronetURLRequest start</h4><p>java方法<code>CronetUrlRequestJni.get().start</code>所对应的jni方法如下，也就是<code>CronetURLRequest</code>的start方法。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CronetURLRequestAdapter<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                                    <span class="token keyword">const</span> JavaParamRef<span class="token operator">&lt;</span>jobject<span class="token operator">></span><span class="token operator">&amp;</span> jcaller<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CronetURLRequest<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">DCHECK</span><span class="token punctuation">(</span><span class="token operator">!</span>context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">IsOnNetworkThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTaskToNetworkThread</span><span class="token punctuation">(</span>
      FROM_HERE<span class="token punctuation">,</span>
      base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CronetURLRequest<span class="token operator">::</span>NetworkTasks<span class="token operator">::</span>Start<span class="token punctuation">,</span>
                     base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>network_tasks_<span class="token punctuation">)</span><span class="token punctuation">,</span>
                     base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span>context_<span class="token punctuation">)</span><span class="token punctuation">,</span> initial_method_<span class="token punctuation">,</span>
                     std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>initial_request_headers_<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>upload_<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>start方法其实就是切换到network线程。调用<code>NetworkTasks</code>名为start类方法。</p>
<h5 id="NetworkTasks-Start"><a href="#NetworkTasks-Start" class="headerlink" title="NetworkTasks Start"></a>NetworkTasks Start</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> CronetURLRequest<span class="token operator">::</span>NetworkTasks<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span>
    CronetURLRequestContext<span class="token operator">*</span> context<span class="token punctuation">,</span>
    <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> method<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>net<span class="token operator">::</span>HttpRequestHeaders<span class="token operator">></span> request_headers<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>net<span class="token operator">::</span>UploadDataStream<span class="token operator">></span> upload<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  url_request_ <span class="token operator">=</span> context<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetURLRequestContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateRequest</span><span class="token punctuation">(</span>
      initial_url_<span class="token punctuation">,</span> net<span class="token operator">::</span>DEFAULT_PRIORITY<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> MISSING_TRAFFIC_ANNOTATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
  url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetLoadFlags</span><span class="token punctuation">(</span>initial_load_flags_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">set_method</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
  url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetExtraRequestHeaders</span><span class="token punctuation">(</span><span class="token operator">*</span>request_headers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetPriority</span><span class="token punctuation">(</span>initial_priority_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetIdempotency</span><span class="token punctuation">(</span>idempotency_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>string referer<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request_headers<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetHeader</span><span class="token punctuation">(</span>net<span class="token operator">::</span>HttpRequestHeaders<span class="token operator">::</span>kReferer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>referer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetReferrer</span><span class="token punctuation">(</span>referer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>upload<span class="token punctuation">)</span>
    url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">set_upload</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>upload<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>traffic_stats_tag_set_ <span class="token operator">||</span> traffic_stats_uid_set_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property">#<span class="token directive keyword">if</span> BUILDFLAG(IS_ANDROID)</span>
    url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">set_socket_tag</span><span class="token punctuation">(</span>net<span class="token operator">::</span><span class="token function">SocketTag</span><span class="token punctuation">(</span>
        traffic_stats_uid_set_ <span class="token operator">?</span> traffic_stats_uid_ <span class="token operator">:</span> net<span class="token operator">::</span>SocketTag<span class="token operator">::</span>UNSET_UID<span class="token punctuation">,</span>
        traffic_stats_tag_set_ <span class="token operator">?</span> traffic_stats_tag_
                               <span class="token operator">:</span> net<span class="token operator">::</span>SocketTag<span class="token operator">::</span>UNSET_TAG<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
  <span class="token punctuation">}</span>
  url_request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>GetURLRequestContext()-&gt;CreateRequest</code>创造一个<code>URLRequest</code>对象。将保存在<code>CronetURLRequest</code>填充到<code>URLRequest</code>中，并调用这个对象的start方法。</p>
<p>而这个<code>URLRequest</code> 你可以看成Cronet的内核对外的最重要的接口。因为iOS的模块最终也是对接到<code>URLRequest</code>对象中。</p>
<h3 id="URLRequest-的头文件"><a href="#URLRequest-的头文件" class="headerlink" title="URLRequest 的头文件"></a>URLRequest 的头文件</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">NET_EXPORT</span> URLRequest <span class="token operator">:</span> <span class="token keyword">public</span> base<span class="token operator">::</span>SupportsUserData <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>

  <span class="token keyword">typedef</span> URLRequestJob<span class="token operator">*</span><span class="token punctuation">(</span>ProtocolFactory<span class="token punctuation">)</span><span class="token punctuation">(</span>URLRequest<span class="token operator">*</span> request<span class="token punctuation">,</span>
                                          <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> scheme<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> kMaxRedirects <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">URLRequest</span><span class="token punctuation">(</span><span class="token keyword">const</span> URLRequest<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  URLRequest<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> URLRequest<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">~</span><span class="token function">URLRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token keyword">protected</span><span class="token operator">:</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token keyword">private</span><span class="token operator">:</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">URLRequestJob</span><span class="token punctuation">;</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">URLRequestContext</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// For testing purposes.</span>
  <span class="token comment" spellcheck="true">// TODO(maksims): Remove this.</span>
  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">TestNetworkDelegate</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// URLRequests are always created by calling URLRequestContext::CreateRequest.</span>
  <span class="token function">URLRequest</span><span class="token punctuation">(</span><span class="token keyword">const</span> GURL<span class="token operator">&amp;</span> url<span class="token punctuation">,</span>
             RequestPriority priority<span class="token punctuation">,</span>
             Delegate<span class="token operator">*</span> delegate<span class="token punctuation">,</span>
             <span class="token keyword">const</span> URLRequestContext<span class="token operator">*</span> context<span class="token punctuation">,</span>
             NetworkTrafficAnnotationTag traffic_annotation<span class="token punctuation">,</span>
             <span class="token keyword">bool</span> is_for_websockets<span class="token punctuation">,</span>
             absl<span class="token operator">::</span>optional<span class="token operator">&lt;</span>net<span class="token operator">::</span>NetLogSource<span class="token operator">></span> net_log_source<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  raw_ptr<span class="token operator">&lt;</span><span class="token keyword">const</span> URLRequestContext<span class="token operator">></span> context_<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestJob<span class="token operator">></span> job_<span class="token punctuation">;</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>UploadDataStream<span class="token operator">></span> upload_data_stream_<span class="token punctuation">;</span>

  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>GURL<span class="token operator">></span> url_chain_<span class="token punctuation">;</span>
  SiteForCookies site_for_cookies_<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面有3个核心的对象：</p>
<ul>
<li>1.<code>context_</code>类型是<code>URLRequestContext</code>，该类负责了<code>URLRequest</code>请求过程中需要的上下文，其中有一个核心的核心上下文<code>QuicContext</code>用于quic协议请求的过程</li>
<li>2.<code>job_</code> 这个对象是<code>URLRequestJob</code> 这是<code>URLRequest</code>真正用于执行请求的任务对象，内置请求任务生命周期</li>
<li>3.<code>upload_data_stream_</code> 是<code>UploadDataStream</code>，这个数据流是用于保存post时候的，消息体。</li>
</ul>
<h3 id="URLRequest-Start"><a href="#URLRequest-Start" class="headerlink" title="URLRequest Start"></a>URLRequest Start</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> URLRequest<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>status_ <span class="token operator">!=</span> OK<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">StartJob</span><span class="token punctuation">(</span>context_<span class="token operator">-</span><span class="token operator">></span><span class="token function">job_factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateJob</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很见到在这里获取<code>job_factory</code>通过<code>CreateJob</code> 创建一个<code>URLRequestJob</code>工作项，并调用<code>UrlRequest</code>的<code>StartJob</code>启动URLRequestJob。<br>简单看看<code>CreateJob</code>返回的是什么类型的<code>URLRequestJob</code>.</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestJob<span class="token operator">></span> URLRequestJobFactory<span class="token operator">::</span><span class="token function">CreateJob</span><span class="token punctuation">(</span>
    URLRequest<span class="token operator">*</span> request<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>request<span class="token operator">-</span><span class="token operator">></span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>URLRequestErrorJob<span class="token operator">></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> ERR_INVALID_URL<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>g_interceptor_for_testing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestJob<span class="token operator">></span> <span class="token function">job</span><span class="token punctuation">(</span>
        g_interceptor_for_testing<span class="token operator">-</span><span class="token operator">></span><span class="token function">MaybeInterceptRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>job<span class="token punctuation">)</span>
      <span class="token keyword">return</span> job<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> it <span class="token operator">=</span> protocol_handler_map_<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">></span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">scheme</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> protocol_handler_map_<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>URLRequestErrorJob<span class="token operator">></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                                                ERR_UNKNOWN_URL_SCHEME<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> it<span class="token operator">-</span><span class="token operator">></span>second<span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateJob</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上在不同的协议都会对应上不同的<code>URLRequestJob</code>工厂，而这些网络协议创建工厂为<code>ProtocolHandler</code>.这些<code>ProtocolHandler</code>都可以通过设置到<code>protocol_handler_map_</code>中，根据协议头scheme进行自定义协议实现。</p>
<p>而在这个内核层中，默认自带了<code>HttpProtocolHandler</code>实现,如下：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">HttpProtocolHandler</span> <span class="token operator">:</span> <span class="token keyword">public</span> URLRequestJobFactory<span class="token operator">::</span>ProtocolHandler <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>

  <span class="token keyword">explicit</span> <span class="token function">HttpProtocolHandler</span><span class="token punctuation">(</span><span class="token keyword">bool</span> is_for_websockets<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token function">is_for_websockets_</span><span class="token punctuation">(</span>is_for_websockets<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token function">HttpProtocolHandler</span><span class="token punctuation">(</span><span class="token keyword">const</span> HttpProtocolHandler<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  HttpProtocolHandler<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> HttpProtocolHandler<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
  <span class="token operator">~</span><span class="token function">HttpProtocolHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestJob<span class="token operator">></span> <span class="token function">CreateJob</span><span class="token punctuation">(</span>URLRequest<span class="token operator">*</span> request<span class="token punctuation">)</span> <span class="token keyword">const</span> override <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token operator">-</span><span class="token operator">></span><span class="token function">is_for_websockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> is_for_websockets_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>URLRequestErrorJob<span class="token operator">></span><span class="token punctuation">(</span>request<span class="token punctuation">,</span>
                                                  ERR_UNKNOWN_URL_SCHEME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> URLRequestHttpJob<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> <span class="token keyword">bool</span> is_for_websockets_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到默认的 Http对应的协议处理器<code>HttpProtocolHandler</code>,并通过<code>CreateJob</code>创建请求任务对应<code>URLRequestHttpJob</code>。而这个的设置时机：</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">URLRequestJobFactory<span class="token operator">::</span><span class="token function">URLRequestJobFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">SetProtocolHandler</span><span class="token punctuation">(</span>url<span class="token operator">::</span>kHttpScheme<span class="token punctuation">,</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HttpProtocolHandler<span class="token operator">></span><span class="token punctuation">(</span>
                                           <span class="token comment" spellcheck="true">/*is_for_websockets=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SetProtocolHandler</span><span class="token punctuation">(</span>url<span class="token operator">::</span>kHttpsScheme<span class="token punctuation">,</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HttpProtocolHandler<span class="token operator">></span><span class="token punctuation">(</span>
                                            <span class="token comment" spellcheck="true">/*is_for_websockets=*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> BUILDFLAG(ENABLE_WEBSOCKETS)</span>
  <span class="token function">SetProtocolHandler</span><span class="token punctuation">(</span>url<span class="token operator">::</span>kWsScheme<span class="token punctuation">,</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HttpProtocolHandler<span class="token operator">></span><span class="token punctuation">(</span>
                                         <span class="token comment" spellcheck="true">/*is_for_websockets=*/</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">SetProtocolHandler</span><span class="token punctuation">(</span>url<span class="token operator">::</span>kWssScheme<span class="token punctuation">,</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>HttpProtocolHandler<span class="token operator">></span><span class="token punctuation">(</span>
                                          <span class="token comment" spellcheck="true">/*is_for_websockets=*/</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span>  </span><span class="token comment" spellcheck="true">// BUILDFLAG(ENABLE_WEBSOCKETS)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>job_factory</code>也就是<code>URLRequestJobFactory</code>类型，能看到构造函数中默认的设置了http和https，ws,wss的协议处理器。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> URLRequest<span class="token operator">::</span><span class="token function">StartJob</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>URLRequestJob<span class="token operator">></span> job<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  job_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>job<span class="token punctuation">)</span><span class="token punctuation">;</span>
  job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetExtraRequestHeaders</span><span class="token punctuation">(</span>extra_request_headers_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetPriority</span><span class="token punctuation">(</span>priority_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetRequestHeadersCallback</span><span class="token punctuation">(</span>request_headers_callback_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetEarlyResponseHeadersCallback</span><span class="token punctuation">(</span>early_response_headers_callback_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetResponseHeadersCallback</span><span class="token punctuation">(</span>response_headers_callback_<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>upload_data_stream_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetUpload</span><span class="token punctuation">(</span>upload_data_stream_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  job_<span class="token operator">-</span><span class="token operator">></span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是把URLRequest 中的头部，优先级，回调，消息体的数据流引用数据保存到<code>URLRequestJob</code>，并调用<code>URLRequestJob</code>的Start。此时<code>URLRequestJob</code>一般是指<code>URLRequestHttpJob</code>.</p>
<h4 id="URLRequestHttpJob-Start"><a href="#URLRequestHttpJob-Start" class="headerlink" title="URLRequestHttpJob Start"></a>URLRequestHttpJob Start</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> URLRequestHttpJob<span class="token operator">::</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  request_info_<span class="token punctuation">.</span>url <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>method <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">method</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  request_info_<span class="token punctuation">.</span>network_isolation_key <span class="token operator">=</span>
      request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">isolation_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">network_isolation_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>possibly_top_frame_origin <span class="token operator">=</span>
      request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">isolation_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">top_frame_origin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>is_subframe_document_resource <span class="token operator">=</span>
      request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">isolation_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">request_type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span>
      net<span class="token operator">::</span>IsolationInfo<span class="token operator">::</span>RequestType<span class="token operator">::</span>kSubFrame<span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>load_flags <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">load_flags</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>secure_dns_policy <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">secure_dns_policy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>traffic_annotation <span class="token operator">=</span>
      net<span class="token operator">::</span><span class="token function">MutableNetworkTrafficAnnotationTag</span><span class="token punctuation">(</span>request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">traffic_annotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>socket_tag <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">socket_tag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  request_info_<span class="token punctuation">.</span>idempotency <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIdempotency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> BUILDFLAG(ENABLE_REPORTING)</span>
  request_info_<span class="token punctuation">.</span>reporting_upload_depth <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">reporting_upload_depth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

  <span class="token keyword">bool</span> should_add_cookie_header <span class="token operator">=</span> <span class="token function">ShouldAddCookieHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>should_add_cookie_header<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">OnGotFirstPartySetMetadata</span><span class="token punctuation">(</span><span class="token function">FirstPartySetMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  absl<span class="token operator">::</span>optional<span class="token operator">&lt;</span>FirstPartySetMetadata<span class="token operator">></span> metadata <span class="token operator">=</span>
      cookie_util<span class="token operator">::</span><span class="token function">ComputeFirstPartySetMetadataMaybeAsync</span><span class="token punctuation">(</span>
          <span class="token function">SchemefulSite</span><span class="token punctuation">(</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">isolation_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">cookie_store</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">cookie_access_delegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">force_ignore_top_frame_party_for_cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>URLRequestHttpJob<span class="token operator">::</span>OnGotFirstPartySetMetadata<span class="token punctuation">,</span>
                         weak_factory_<span class="token punctuation">.</span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">OnGotFirstPartySetMetadata</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>metadata<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将<code>UrlRequest</code>的请求参数保存到<code>request_info_</code>。如果没有任何的cookie则直接调用<code>OnGotFirstPartySetMetadata</code>,如果存在全局通用cookie,则把数据保存到<code>FirstPartySetMetadata</code>。并调用<code>OnGotFirstPartySetMetadata</code>.</p>
<h4 id="OnGotFirstPartySetMetadata"><a href="#OnGotFirstPartySetMetadata" class="headerlink" title="OnGotFirstPartySetMetadata"></a>OnGotFirstPartySetMetadata</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> URLRequestHttpJob<span class="token operator">::</span><span class="token function">OnGotFirstPartySetMetadata</span><span class="token punctuation">(</span>
    FirstPartySetMetadata first_party_set_metadata<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  first_party_set_metadata_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>first_party_set_metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>

  request_info_<span class="token punctuation">.</span>privacy_mode <span class="token operator">=</span> <span class="token function">DeterminePrivacyMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  GURL <span class="token function">referrer</span><span class="token punctuation">(</span>request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">referrer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>referrer<span class="token punctuation">.</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token operator">::</span>string referer_value <span class="token operator">=</span> referrer<span class="token punctuation">.</span><span class="token function">spec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    request_info_<span class="token punctuation">.</span>extra_headers<span class="token punctuation">.</span><span class="token function">SetHeader</span><span class="token punctuation">(</span>HttpRequestHeaders<span class="token operator">::</span>kReferer<span class="token punctuation">,</span>
                                          referer_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  request_info_<span class="token punctuation">.</span>extra_headers<span class="token punctuation">.</span><span class="token function">SetHeaderIfMissing</span><span class="token punctuation">(</span>
      HttpRequestHeaders<span class="token operator">::</span>kUserAgent<span class="token punctuation">,</span>
      http_user_agent_settings_ <span class="token operator">?</span>
          http_user_agent_settings_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetUserAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">AddExtraHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ShouldAddCookieHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    cookie_partition_key_ <span class="token operator">=</span>
        absl<span class="token operator">::</span><span class="token function">make_optional</span><span class="token punctuation">(</span>CookiePartitionKey<span class="token operator">::</span><span class="token function">FromNetworkIsolationKey</span><span class="token punctuation">(</span>
            request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">isolation_info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">network_isolation_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            base<span class="token operator">::</span><span class="token function">OptionalOrNullptr</span><span class="token punctuation">(</span>
                first_party_set_metadata_<span class="token punctuation">.</span><span class="token function">top_frame_owner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">AddCookieHeaderAndStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">StartTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.先通过<code>SetHeader</code>以及<code>AddExtraHeaders</code>设置<code>Referer</code>,<code>GZIP</code>等常用的Header</li>
<li>2.如果存在cookie则通过<code>AddCookieHeaderAndStart</code>添加到Header中<code>Cookie</code>为key的数据集合中。不过</li>
<li>3.<code>StartTransaction</code>启动事务。</li>
</ul>
<h4 id="URLRequestHttpJob-StartTransaction"><a href="#URLRequestHttpJob-StartTransaction" class="headerlink" title="URLRequestHttpJob StartTransaction"></a>URLRequestHttpJob StartTransaction</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> URLRequestHttpJob<span class="token operator">::</span><span class="token function">StartTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token function">StartTransactionInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> URLRequestHttpJob<span class="token operator">::</span><span class="token function">StartTransactionInternal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>


  <span class="token keyword">int</span> rv<span class="token punctuation">;</span>

  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>transaction_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rv <span class="token operator">=</span> transaction_<span class="token operator">-</span><span class="token operator">></span><span class="token function">RestartWithAuth</span><span class="token punctuation">(</span>
        auth_credentials_<span class="token punctuation">,</span> base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>URLRequestHttpJob<span class="token operator">::</span>OnStartCompleted<span class="token punctuation">,</span>
                                          base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    auth_credentials_ <span class="token operator">=</span> <span class="token function">AuthCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

    rv <span class="token operator">=</span> request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">http_transaction_factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateTransaction</span><span class="token punctuation">(</span>
        priority_<span class="token punctuation">,</span> <span class="token operator">&amp;</span>transaction_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">==</span> OK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      transaction_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetConnectedCallback</span><span class="token punctuation">(</span>base<span class="token operator">::</span><span class="token function">BindRepeating</span><span class="token punctuation">(</span>
          <span class="token operator">&amp;</span>URLRequestHttpJob<span class="token operator">::</span>NotifyConnectedCallback<span class="token punctuation">,</span> base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      transaction_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetRequestHeadersCallback</span><span class="token punctuation">(</span>request_headers_callback_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      transaction_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetEarlyResponseHeadersCallback</span><span class="token punctuation">(</span>
          early_response_headers_callback_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      transaction_<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetResponseHeadersCallback</span><span class="token punctuation">(</span>response_headers_callback_<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>throttling_entry_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span>
          <span class="token operator">!</span>throttling_entry_<span class="token operator">-</span><span class="token operator">></span><span class="token function">ShouldRejectRequest</span><span class="token punctuation">(</span><span class="token operator">*</span>request_<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rv <span class="token operator">=</span> transaction_<span class="token operator">-</span><span class="token operator">></span><span class="token function">Start</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span>request_info_<span class="token punctuation">,</span>
            base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>URLRequestHttpJob<span class="token operator">::</span>OnStartCompleted<span class="token punctuation">,</span>
                           base<span class="token operator">::</span><span class="token function">Unretained</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            request_<span class="token operator">-</span><span class="token operator">></span><span class="token function">net_log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        start_time_ <span class="token operator">=</span> base<span class="token operator">::</span>TimeTicks<span class="token operator">::</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Special error code for the exponential back-off module.</span>
        rv <span class="token operator">=</span> ERR_TEMPORARILY_THROTTLED<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>rv <span class="token operator">==</span> ERR_IO_PENDING<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// The transaction started synchronously, but we need to notify the</span>
  <span class="token comment" spellcheck="true">// URLRequest delegate via the message loop.</span>
  base<span class="token operator">::</span>ThreadTaskRunnerHandle<span class="token operator">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span>
      FROM_HERE<span class="token punctuation">,</span> base<span class="token operator">::</span><span class="token function">BindOnce</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>URLRequestHttpJob<span class="token operator">::</span>OnStartCompleted<span class="token punctuation">,</span>
                                weak_factory_<span class="token punctuation">.</span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程中存在一个核心的对象<code>transaction_</code>也就是<code>HttpTransaction</code>。之后请求Job工作项，就将请求委托给<code>HttpTransaction</code>.</p>
<p>如果发现<code>URLRequestHttpJob</code>已经存在了<code>HttpTransaction</code>，那么就会调用<code>HttpTransaction</code>的<code>RestartWithAuth</code>重新启动并且校验权限。</p>
<p>如果发现没有创建，则调用事务工厂<code>CreateTransaction</code>创建<code>HttpTransaction</code>，然后调用Start方法正式启动事务，开始请求。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>首先进行一个初步的总结，到了<code>HttpTransaction</code>之后，就会开始流转请求的生命周期，然后进行quic协议的初始化，执行quic的请求。</p>
<p>不过限于篇幅，以及Cronet设计上的确实比较冗长，这里先做一个简单的总结先：</p>
<p>可以将Cronet的设计组合看成3层：</p>
<ul>
<li>1.java的api层</li>
<li>2.用于连通java和native的jni的adapter层</li>
<li>3.通用于所有平台的内核层</li>
</ul>
<p>java层会通过反射尝试获取不同环境依赖下的cronetProvider，也就是Cornet的内核提供器。有的是依赖Google环境，有的可以自己自己直接依赖native的包，都没有则使用默认的 android自带的网络请求。</p>
<p>jni层，实际上就是末尾带上了Adapter的类以及和java层中相同类名的类，这些类一般不做任何事情，一般会包裹一个对应相同名字的cpp对象在native中，并且把相同的行为赋予给Adpater以及对应的native对象。</p>
<ul>
<li><p>java层CronetUrlRequestContext 会对应上 jni中的<code>CronetURLRequestContextAdapter</code>作为枢纽，间接控制native中的<code>CronetURLRequestContext</code>。而<code>CronetURLRequestContext</code>则是控制了整个请求的上下文</p>
</li>
<li><p>java层<code>CronetUrlRequest</code> 会对应上jni中的<code>CronetURLRequestAdapter</code>,并间接控制native层的<code>CronetUrlRequest</code>对象。</p>
</li>
</ul>
<p>而这个对象最终会控制native层的<code>UrlRequest</code>，而这个对象最终会通向Cronet的内核层。并且会从thridParty文件夹中找到quic协议相关的处理。</p>
<p>后续的文章将会继续揭晓<code>HttpTransaction</code>如何进行事务流转，并且quic是如何执行。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2022/05/03/cong-cronet-kan-http3-he-quic-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="从Cronet 看Http3和QUIC(一)">
                        
                        <span class="card-title">从Cronet 看Http3和QUIC(一)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言前一段时间，在公司内部进行了一次QUIC协议的演讲。当时因为时间有限，没有仔细的讨论Cronet 的源码细节，仅仅只是介绍了QUIC的协议细节。本文就从Cronet源码出发，聊聊QUIC的一些实现，进而看看QUIC对比Http2的优势，
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-05-03
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/quic/">
                        <span class="chip bg-color">quic</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/24/shadow-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Shadow源码解析">
                        
                        <span class="card-title">Shadow源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言时隔4年。本文再次来聊聊Shadow 这个0 hook的插件库。目前看来，确实是腾讯这个Shadow 插件库做到0 hook api实现插件化。在腾讯内部也是广泛使用，其设计上解藕的非常好，可以独立升级插件的插件依赖库很少造成冲突，可以
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-04-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Android常用第三方库/">
                        <span class="chip bg-color">Android常用第三方库</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
