<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Shadow源码解析, Android | Linux | Flutter">
    <meta name="description" content="前言时隔4年。本文再次来聊聊Shadow 这个0 hook的插件库。目前看来，确实是腾讯这个Shadow 插件库做到0 hook api实现插件化。在腾讯内部也是广泛使用，其设计上解藕的非常好，可以独立升级插件的插件依赖库很少造成冲突，可以">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Shadow源码解析 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/22.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Shadow源码解析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Android常用第三方库/">
                                <span class="chip bg-color">Android常用第三方库</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-24
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        10k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        47 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>时隔4年。本文再次来聊聊Shadow 这个0 hook的插件库。目前看来，确实是腾讯这个Shadow 插件库做到0 hook api实现插件化。在腾讯内部也是广泛使用，其设计上解藕的非常好，可以独立升级插件的插件依赖库很少造成冲突，可以几个版本的Shadow插件混用不造成异常。</p>
<p>如果还在观望的朋友，相信阅读完本文可以对这个插件库有更多的信心。当然如果是到海外，Google市场，可能需要自己斟酌一二再使用Shadow。毕竟对于Google来说动态更新这个行为也不是它希望的。</p>
<p>不熟悉插件化原理的，可以阅读我之前写插件文章<a href="https://www.jianshu.com/p/d824056f510b" target="_blank" rel="noopener">横向浅析Small,RePlugin两个插件化框架</a>，在里面深刻的描述了3年前的插件化的原理。</p>
<p>有什么问题可以来本文<a href="https://www.jianshu.com/p/e1738998abd1" target="_blank" rel="noopener">https://www.jianshu.com/p/e1738998abd1</a> 下讨论</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>Shadow 比起其他插件库多了几个特殊概念。很多人就是上来如何使用，实际上不对Shadow 的整体有一个初步的概念，很难用的好这个库。</p>
<p>对于Shadow来说，可其他的插件库一样分为宿主和插件两个部分。从设计的角度上更加接近RePlugin，需要宿主和插件业务，分别依赖宿主库和插件库。</p>
<p>实际上，对于Shadow来说，插件业务生成的插件包，不仅仅只有一个插件业务的apk。往往是一个由如下4部分组成：</p>
<ul>
<li>1.manger.apk 专门用于联通宿主apk。当宿主apk启动插件的时候，需要启动manager模块，加载 loader.apk,runtime.apk,以及业务插件apk。</li>
<li>2.loader.apk 专门用于映射坑位Activity/Broadcast/Service/ContentProvider 与 业务插件中四大组件对应的类名</li>
<li>3.runtime.apk 用于申明四大组件的类。注意runtime.apk中的AndroidManifest 中不需要声明。这些坑位需要直接声明到宿主中</li>
<li>4.插件业务生成的apk 业务的实现</li>
</ul>
<h2 id="关于0-hook的思考"><a href="#关于0-hook的思考" class="headerlink" title="关于0 hook的思考"></a>关于0 hook的思考</h2><p>在聊Shadow的使用和实现方案之前，我们稍微的回顾一下hook点最少的RePlugin框架。Hook了一个Context注入了自己的ClassLoader。那么如何在这个基础上进一步前进，实现0 hook。</p>
<p>能不能想办法达到不 hook任何一个位置，从而实现宿主管理插件的功能呢？当然我也没有想出来，只是有不少人已经想出来了，并进行实现。</p>
<p>RePlugin的思路简单说一下，RePlugin把插件框架氛围两个部分：</p>
<ul>
<li>宿主 用于控制插件版本和加载插件。并反射插件进程中的固定入口，启动插件中的组件</li>
<li>插件 主要是通过Gradle 插件替换了四大组件为自己的代理类这几个类是自己在插件库实现的PluginActivity。</li>
</ul>
<p>为什么需要Hook Context呢？为了让插件和宿主可以互相通信。RePlugin会生成一个PluginClassLoader 用于宿主和插件互相查找对方类。而apk的classLoader 最早是存在Context中，因此需要Hook Context。</p>
<p>既然知道了为什么需要Hook Context了？我们可否想办法处理一下，避免Hook Context。其实方案已经摆在眼前了。</p>
<p>就以坑位Activity为例子。插件库的Gradle 插件转化的PluginActivity 需要正常工作就需要Hook Context。那么我们为何不做如下行为，干脆把Context也交给我们来代理好了，PluginActivity不继承任何类。PluginActivity 将会实现所有Activity 对外的接口，而他所有行为直接以来宿主的坑位Activity了，不久好了吗？</p>
<p>回头来想想我四年前说过的，插件化需要跨越的三大问题，这么做是否解决？</p>
<ul>
<li>越过AndroidManifest的校验。</li>
<li>查找插件的Class</li>
<li>加载插件资源</li>
</ul>
<h5 id="三个问题的解决方式"><a href="#三个问题的解决方式" class="headerlink" title="三个问题的解决方式"></a>三个问题的解决方式</h5><ul>
<li><p>对于第一个问题：目前的方案，因为是插件库把Activity转化成一个不继承任何类的PluginActivity，并依赖坑位Activity的行为。因此只需要声明坑位的Activity，只是这个坑位的Activity需要做特殊处理，可以注入PluginActivity，并调用公有回调</p>
</li>
<li><p>对于第二个问题，也解决了。因为不是通过内置的ClassLoader查找Class。而是通过自己生成的ClassLoader 查找Class</p>
</li>
<li><p>第三个问题，更好解决。Context都是自己创建的了，为什么不可以自己在自己的Context做好资源管理呢？</p>
</li>
</ul>
<p>这么想，0 hook 通过代理设计模式实现插件化似乎可行。而Shadow 也是如此思想。接下来看看他如何使用，如何解耦插件库和宿主库的。</p>
<h2 id="Shadow-使用"><a href="#Shadow-使用" class="headerlink" title="Shadow 使用"></a>Shadow 使用</h2><p>为了避免插件库影响原来的业务逻辑，一般会常见一个壳模块。这个模块作为主模块，被业务工程依赖。</p>
<h4 id="根目录工程"><a href="#根目录工程" class="headerlink" title="根目录工程"></a>根目录工程</h4><p>在工程根目录的build.gradle 新增</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">buildscript <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>System<span class="token operator">.</span><span class="token function">getenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">"DISABLE_TENCENT_MAVEN_MIRROR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            maven <span class="token punctuation">{</span> url <span class="token string">'https://mirrors.tencent.com/nexus/repository/maven-public/'</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">google</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">jcenter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>



        maven <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token string">"GitHubPackages"</span>
            url <span class="token string">"https://maven.pkg.github.com/tencent/shadow"</span>
            <span class="token comment" spellcheck="true">//一个只读账号兼容Github Packages暂时不支持匿名下载</span>
            <span class="token comment" spellcheck="true">//https://github.community/t/download-from-github-package-registry-without-authentication/14407</span>
            credentials <span class="token punctuation">{</span>
                username <span class="token operator">=</span> <span class="token string">'readonlypat'</span>
                password <span class="token operator">=</span> <span class="token string">'\u0062\u0036\u0064\u0037\u0035\u0032\u0062\u0061\u0035\u0038\u0063\u0064\u0032\u0061\u0038\u0037\u0064\u0033\u0034\u0033\u0039\u0038\u0035\u0036\u0032\u0034\u0065\u0039\u0031\u0036\u0066\u0065\u0065\u0062\u0031\u0065\u0033\u0037\u0061\u0039'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    ext<span class="token operator">.</span>shadow_version <span class="token operator">=</span> <span class="token string">'local-d93420c5-SNAPSHOT'</span>
    dependencies <span class="token punctuation">{</span>
        c
        classpath <span class="token string">"com.tencent.shadow.core:gradle-plugin:$shadow_version"</span>
        <span class="token comment" spellcheck="true">// NOTE: Do not place your application dependencies here; they belong</span>
        <span class="token comment" spellcheck="true">// in the individual module build.gradle files</span>
    <span class="token punctuation">}</span>
    apply from<span class="token punctuation">:</span> <span class="token string">'buildscriptAdditions.gradle'</span><span class="token punctuation">,</span> to<span class="token punctuation">:</span> buildscript
<span class="token punctuation">}</span>

apply from<span class="token punctuation">:</span> <span class="token string">'baseBuildAdditions.gradle'</span>

allprojects <span class="token punctuation">{</span>
    repositories <span class="token punctuation">{</span>
        <span class="token function">google</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">mavenCentral</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        maven <span class="token punctuation">{</span>
            name <span class="token operator">=</span> <span class="token string">"GitHubPackages"</span>
            url <span class="token string">"https://maven.pkg.github.com/tencent/shadow"</span>
            <span class="token comment" spellcheck="true">//一个只读账号兼容Github Packages暂时不支持匿名下载</span>
            <span class="token comment" spellcheck="true">//https://github.community/t/download-from-github-package-registry-without-authentication/14407</span>
            credentials <span class="token punctuation">{</span>
                username <span class="token operator">=</span> <span class="token string">'readonlypat'</span>
                password <span class="token operator">=</span> <span class="token string">'\u0062\u0036\u0064\u0037\u0035\u0032\u0062\u0061\u0035\u0038\u0063\u0064\u0032\u0061\u0038\u0037\u0064\u0033\u0034\u0033\u0039\u0038\u0035\u0036\u0032\u0034\u0065\u0039\u0031\u0036\u0066\u0065\u0065\u0062\u0031\u0065\u0033\u0037\u0061\u0039'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意，classpath，<code>com.tencent.shadow.core:gradle-plugin</code> 插件是将所有的四大组件，替换成Shadow的对应的代理类。而这些代理类会把工作交给runtime中真正的Activity组件实现</p>
<h4 id="2-创建一个模块plugin-shadow-apk："><a href="#2-创建一个模块plugin-shadow-apk：" class="headerlink" title="2 创建一个模块plugin-shadow-apk："></a>2 创建一个模块plugin-shadow-apk：</h4><pre class="line-numbers language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//Shadow Transform后业务代码会有一部分实际引用runtime中的类</span>
    <span class="token comment" spellcheck="true">//如果不以compileOnly方式依赖，会导致其他Transform或者Proguard找不到这些类</span>
    compileOnly <span class="token string">"com.tencent.shadow.core:runtime:$shadow_version"</span>
<span class="token punctuation">}</span>


apply plugin<span class="token punctuation">:</span> <span class="token string">'com.tencent.shadow.plugin'</span>

shadow <span class="token punctuation">{</span>
    packagePlugin <span class="token punctuation">{</span>
        pluginTypes <span class="token punctuation">{</span>
            debug <span class="token punctuation">{</span>
                loaderApkConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token string">'sample-loader-debug.apk'</span><span class="token punctuation">,</span> <span class="token string">':sample-loader:assembleDebug'</span><span class="token punctuation">)</span>
                runtimeApkConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token string">'sample-runtime-debug.apk'</span><span class="token punctuation">,</span> <span class="token string">':sample-runtime:assembleDebug'</span><span class="token punctuation">)</span>
                pluginApks <span class="token punctuation">{</span>
                    pluginApk1 <span class="token punctuation">{</span>
                        businessName <span class="token operator">=</span> <span class="token string">'sample-plugin'</span><span class="token comment" spellcheck="true">//businessName相同的插件，context获取的Dir是相同的。businessName留空，表示和宿主相同业务，直接使用宿主的Dir。</span>
                        partKey <span class="token operator">=</span> <span class="token string">'sample-plugin'</span>
                        buildTask <span class="token operator">=</span> <span class="token string">'assembleDebug'</span>
                        apkName <span class="token operator">=</span> <span class="token string">'plugin-shadow-apk-debug.apk'</span>
                        apkPath <span class="token operator">=</span> <span class="token string">'plugin-shadow-apk/build/outputs/apk/debug/plugin-shadow-apk-debug.apk'</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            release <span class="token punctuation">{</span>
                loaderApkConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token string">'sample-loader-release.apk'</span><span class="token punctuation">,</span> <span class="token string">':sample-loader:assembleRelease'</span><span class="token punctuation">)</span>
                runtimeApkConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Tuple2</span><span class="token punctuation">(</span><span class="token string">'sample-runtime-release.apk'</span><span class="token punctuation">,</span> <span class="token string">':sample-runtime:assembleRelease'</span><span class="token punctuation">)</span>
                pluginApks <span class="token punctuation">{</span>
                    pluginApk1 <span class="token punctuation">{</span>
                        businessName <span class="token operator">=</span> <span class="token string">'demo'</span>
                        partKey <span class="token operator">=</span> <span class="token string">'sample-plugin'</span>
                        buildTask <span class="token operator">=</span> <span class="token string">'assembleRelease'</span>
                        apkName <span class="token operator">=</span> <span class="token string">'plugin-shadow-apk-release.apk'</span>
                        apkPath <span class="token operator">=</span> <span class="token string">'plugin-shadow-apk/build/outputs/apk/release/plugin-shadow-apk-release.apk'</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        loaderApkProjectPath <span class="token operator">=</span> <span class="token string">'sample-loader'</span>

        runtimeApkProjectPath <span class="token operator">=</span> <span class="token string">'sample-runtime'</span>

        version <span class="token operator">=</span> <span class="token number">4</span>
        compactVersion <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
        uuidNickName <span class="token operator">=</span> <span class="token string">"1.1.5"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>有了这个<code>shadow</code>任务实现后，就能通过命令<code>./gradlew packageDebugPlugin</code> 直接生成<code>runtime的apk</code> + <code>loade的apk</code> + <code>插件业务的apk</code>  的压缩包。</p>
<p>最后记得依赖业务模块</p>
<h4 id="2-Shadow-的宿主"><a href="#2-Shadow-的宿主" class="headerlink" title="2.Shadow 的宿主"></a>2.Shadow 的宿主</h4><pre class="line-numbers language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>
    implementation <span class="token function">project</span><span class="token punctuation">(</span><span class="token string">':introduce-shadow-lib'</span><span class="token punctuation">)</span>

    <span class="token comment" spellcheck="true">//如果introduce-shadow-lib发布到Maven，在pom中写明此依赖，宿主就不用写这个依赖了。</span>
    implementation <span class="token string">"com.tencent.shadow.dynamic:host:$shadow_version"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>宿主通过如下方法启动插件的Activity</p>
<pre><code>public static final int FROM_ID_START_ACTIVITY = 1001;
public static final int FROM_ID_CALL_SERVICE = 1002;
pluginManager.enter(MainActivity.this, FROM_ID_START_ACTIVITY, new Bundle(), new EnterCallback() {
    @Override
    public void onShowLoadingView(View view) {
        MainActivity.this.setContentView(view);//显示Manager传来的Loading页面
    }

    @Override
    public void onCloseLoadingView() {
        MainActivity.this.setContentView(linearLayout);
    }

    @Override
    public void onEnterComplete() {
        v.setEnabled(true);
    }
});
</code></pre><h4 id="3-Shadow-中的runtime"><a href="#3-Shadow-中的runtime" class="headerlink" title="3.Shadow 中的runtime"></a>3.Shadow 中的runtime</h4><p>构建一个 application 级别的工程，依赖</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">implementation <span class="token string">"com.tencent.shadow.core:activity-container:$shadow_version"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>请实现几个坑位Activity:</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginDefaultProxyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">PluginContainerActivity</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginNativeProxyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">NativePluginContainerActivity</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginSingleInstance1ProxyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">PluginContainerActivity</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>



<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginSingleTask1ProxyActivity</span> <span class="token keyword">extends</span> <span class="token class-name">PluginContainerActivity</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>紧接着，生成一个loader-apk即可。</p>
<p>这几个Activity可以不用注册当前apk的AndroidManifest中，需要注册到宿主apk中的AndroidManifest。对于Shadow来说，只需要能在这个apk中找到这个Class就可以了。</p>
<p>请在宿主的AndroidManifest 注册上面申明的Activity</p>
<p>宿主：</p>
<pre class="line-numbers language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainPluginProcessService<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:plugin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>


<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tencent.shadow.sample.runtime.PluginDefaultProxyActivity<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>launchMode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>standard<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>screenOrientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>portrait<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>configChanges</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|screenLayout|fontScale|uiMode|orientation|screenSize|smallestScreenSize|layoutDirection<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>hardwareAccelerated</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/PluginContainerActivity<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:plugin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tencent.shadow.sample.runtime.PluginSingleInstance1ProxyActivity<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>launchMode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>singleInstance<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>screenOrientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>portrait<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>configChanges</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|screenLayout|fontScale|uiMode|orientation|screenSize|smallestScreenSize|layoutDirection<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>hardwareAccelerated</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/PluginContainerActivity<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:plugin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tencent.shadow.sample.runtime.PluginSingleTask1ProxyActivity<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>launchMode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>singleTask<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>screenOrientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>portrait<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>configChanges</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|screenLayout|fontScale|uiMode|orientation|screenSize|smallestScreenSize|layoutDirection<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>hardwareAccelerated</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/PluginContainerActivity<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:plugin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provider</span>
    <span class="token attr-name"><span class="token namespace">android:</span>authorities</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tencent.shadow.contentprovider.authority.dynamic<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tencent.shadow.core.runtime.container.PluginContainerContentProvider<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>请注意必须都申明好<code>android:process=":plugin"</code>，需要和承载插件业务<code>MainPluginProcessService</code> 在同一个进程，这样才能在插件进程中从ClassLoader找到这几个类。</p>
<h4 id="4-Shadow的-loader"><a href="#4-Shadow的-loader" class="headerlink" title="4.Shadow的 loader"></a>4.Shadow的 loader</h4><p>构建一个 application 级别的工程，依赖</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">dependencies <span class="token punctuation">{</span>
    implementation <span class="token string">"com.tencent.shadow.dynamic:loader-impl:$shadow_version"</span>

    compileOnly <span class="token string">"com.tencent.shadow.core:activity-container:$shadow_version"</span>
    compileOnly <span class="token string">"com.tencent.shadow.core:common:$shadow_version"</span>
    <span class="token comment" spellcheck="true">//下面这行依赖是为了防止在proguard的时候找不到LoaderFactory接口</span>
    compileOnly <span class="token string">"com.tencent.shadow.dynamic:host:$shadow_version"</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>构建一个<code>CoreLoaderFactoryImpl</code>:</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>impl<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CoreLoaderFactoryImpl</span> <span class="token keyword">implements</span> <span class="token class-name">CoreLoaderFactory</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@NotNull</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ShadowPluginLoader <span class="token function">build</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NotNull</span> Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SamplePluginLoader</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意 CoreLoaderFactoryImpl 这个类名必须固定，这是Shadow自身的hook点。宿主会通过manager 进行查找。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamplePluginLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ShadowPluginLoader</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String TAG <span class="token operator">=</span> <span class="token string">"shadow"</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> ComponentManager componentManager<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SamplePluginLoader</span><span class="token punctuation">(</span>Context hostAppContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>hostAppContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        componentManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SampleComponentManager</span><span class="token punctuation">(</span>hostAppContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ComponentManager <span class="token function">getComponentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> componentManager<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是构建<code>ComponentManager</code>.这个类中，loader将会实现把 runtime 中写好的代理Activity和插件业务的Activity进行一一映射。</p>
<p>案例如下：</p>
<pre><code>public class SampleComponentManager extends ComponentManager {

    /**
     * sample-runtime 模块中定义的壳子Activity，需要在宿主AndroidManifest.xml注册
     */
    private static final String DEFAULT_ACTIVITY = "com.tencent.shadow.sample.runtime.PluginDefaultProxyActivity";
    private static final String SINGLE_INSTANCE_ACTIVITY = "com.tencent.shadow.sample.runtime.PluginSingleInstance1ProxyActivity";
    private static final String SINGLE_TASK_ACTIVITY = "com.tencent.shadow.sample.runtime.PluginSingleTask1ProxyActivity";
    private static final String DEFAULT_NATIVE_ACTIVITY = "com.tencent.shadow.sample.runtime.PluginNativeProxyActivity";

    private Context context;

    public SampleComponentManager(Context context) {
        this.context = context;
    }


    /**
     * 配置插件Activity 到 壳子Activity的对应关系
     *
     * @param pluginActivity 插件Activity
     * @return 壳子Activity
     */
    @Override
    public ComponentName onBindContainerActivity(ComponentName pluginActivity) {
        switch (pluginActivity.getClassName()) {
            /**
             * 这里配置对应的对应关系
             */
            case "com.sample.test.SampleActivity":
                return new ComponentName(context, DEFAULT_NATIVE_ACTIVITY);
        }
        return new ComponentName(context, DEFAULT_ACTIVITY);
    }

    /**
     * 配置对应宿主中预注册的壳子contentProvider的信息
     */
    @Override
    public ContainerProviderInfo onBindContainerContentProvider(ComponentName pluginContentProvider) {
        return new ContainerProviderInfo(
                "com.tencent.shadow.runtime.container.PluginContainerContentProvider",
                "com.tencent.shadow.contentprovider.authority.dynamic");
    }

    @Override
    public List&lt;BroadcastInfo&gt; getBroadcastInfoList(String partKey) {
        List&lt;ComponentManager.BroadcastInfo&gt; broadcastInfos = new ArrayList&lt;&gt;();

        //如果有静态广播需要像下面代码这样注册
//        if (partKey.equals(Constant.PART_KEY_PLUGIN_MAIN_APP)) {
//            broadcastInfos.add(
//                    new ComponentManager.BroadcastInfo(
//                            "com.tencent.shadow.demo.usecases.receiver.MyReceiver",
//                            new String[]{"com.tencent.test.action"}
//                    )
//            );
//        }
        return broadcastInfos;
    }

}</code></pre><p>到运行的时候，GameActivity 所有的行为将会依赖PluginNativeProxyActivity 的实现。</p>
<p>其他的Activity 映射到 普通的PluginDefaultProxyActivity 即可</p>
<h4 id="5-Shadow-中的manager"><a href="#5-Shadow-中的manager" class="headerlink" title="5.Shadow 中的manager"></a>5.Shadow 中的manager</h4><p>需要专门构建一个Android工程，这个工程可以参照github中的案例。</p>
<p>新增配置：</p>
<pre><code>allprojects {
    repositories {
        if (!System.getenv().containsKey("DISABLE_TENCENT_MAVEN_MIRROR")) {
            maven { url 'https://mirrors.tencent.com/nexus/repository/maven-public/' }
        } else {
            google()
            jcenter()
        }
        maven { url 'https://mirrors.tencent.com/repository/maven/cubershiTempShadowPublish' }
        maven {
            name = "GitHubPackages"
            url "https://maven.pkg.github.com/tencent/shadow"
            //一个只读账号兼容Github Packages暂时不支持匿名下载
            //https://github.community/t/download-from-github-package-registry-without-authentication/14407
            credentials {
                username = 'readonlypat'
                password = '\u0062\u0036\u0064\u0037\u0035\u0032\u0062\u0061\u0035\u0038\u0063\u0064\u0032\u0061\u0038\u0037\u0064\u0033\u0034\u0033\u0039\u0038\u0035\u0036\u0032\u0034\u0065\u0039\u0031\u0036\u0066\u0065\u0065\u0062\u0031\u0065\u0033\u0037\u0061\u0039'
            }
        }
        mavenLocal()
    }
}</code></pre><p>新增依赖：</p>
<pre><code>dependencies {
    implementation "com.tencent.shadow.dynamic:manager:$shadow_version"
    compileOnly "com.tencent.shadow.core:common:$shadow_version"
    compileOnly "com.tencent.shadow.dynamic:host:$shadow_version"
}</code></pre><p>继承FastPluginManager</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SamplePluginManager</span> <span class="token keyword">extends</span> <span class="token class-name">FastPluginManager</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> ExecutorService executorService <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> Context mCurrentContext<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SamplePluginManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mCurrentContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * @return PluginManager实现的别名，用于区分不同PluginManager实现的数据存储路径
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"sample-manager"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * @return demo插件so的abi
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> String <span class="token function">getAbi</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"armeabi-v7a"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * @return 宿主中注册的PluginProcessService实现的类名
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> String <span class="token function">getPluginProcessServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"com.tencent.shadow.sample.introduce_shadow_lib.MainPluginProcessService"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> <span class="token keyword">long</span> fromId<span class="token punctuation">,</span> Bundle bundle<span class="token punctuation">,</span> <span class="token keyword">final</span> EnterCallback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromId <span class="token operator">==</span> Constant<span class="token punctuation">.</span>FROM_ID_START_ACTIVITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_ZIP_PATH<span class="token punctuation">,</span> <span class="token string">"/data/local/tmp/plugin-debug.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_PART_KEY<span class="token punctuation">,</span> <span class="token string">"sample-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_ACTIVITY_CLASSNAME<span class="token punctuation">,</span> <span class="token string">"com.sample.test.SampleActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">onStartActivity</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fromId <span class="token operator">==</span> Constant<span class="token punctuation">.</span>FROM_ID_CALL_SERVICE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callPluginService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"不认识的fromId=="</span> <span class="token operator">+</span> fromId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onStartActivity</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> Bundle bundle<span class="token punctuation">,</span> <span class="token keyword">final</span> EnterCallback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String pluginZipPath <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_ZIP_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String partKey <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_PART_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String className <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_ACTIVITY_CLASSNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"className == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Bundle extras <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_EXTRAS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> View view <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>mCurrentContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_load_plugin<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callback<span class="token punctuation">.</span><span class="token function">onShowLoadingView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    InstalledPlugin installedPlugin
                            <span class="token operator">=</span> <span class="token function">installPlugin</span><span class="token punctuation">(</span>pluginZipPath<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//这个调用是阻塞的</span>
                    Intent pluginIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pluginIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span>
                            context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            className
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pluginIntent<span class="token punctuation">.</span><span class="token function">replaceExtras</span><span class="token punctuation">(</span>extras<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token function">startPluginActivity</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> installedPlugin<span class="token punctuation">,</span> partKey<span class="token punctuation">,</span> pluginIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    Handler uiHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    uiHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token annotation punctuation">@Override</span>
                        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            callback<span class="token punctuation">.</span><span class="token function">onCloseLoadingView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            callback<span class="token punctuation">.</span><span class="token function">onEnterComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>getName 用于控制插件版本等信息的名字。manager会通过这个名字找到数据库存储的信息加载合适数据</li>
<li>getAbi 当前加载的so 是什么cpu框架的</li>
<li>enter 可以通过id 来判断当前的行为，从而根据id跳转到合适的Activity</li>
</ul>
<h2 id="Shadow-的源码解析"><a href="#Shadow-的源码解析" class="headerlink" title="Shadow 的源码解析"></a>Shadow 的源码解析</h2><p>先来看看宿主的原理。宿主想要启动插件中的某个Activity需要经历如下几个步骤：</p>
<ul>
<li><p>1.通过 <code>new DynamicPluginManager(fixedPathPmUpdater);</code> 声明DynamicPluginManager对象</p>
</li>
<li><p>2.调用<code>DynamicPluginManager</code>的enter方法启动插件中Manager.apk的相同id的行为。</p>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">                pluginManager<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span>MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">,</span> FROM_ID_START_ACTIVITY<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EnterCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onShowLoadingView</span><span class="token punctuation">(</span>View view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setContentView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//显示Manager传来的Loading页面</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCloseLoadingView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        MainActivity<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setContentView</span><span class="token punctuation">(</span>linearLayout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onEnterComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        v<span class="token punctuation">.</span><span class="token function">setEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="1-DynamicPluginManager-enter"><a href="#1-DynamicPluginManager-enter" class="headerlink" title="1.DynamicPluginManager enter"></a>1.DynamicPluginManager enter</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> <span class="token keyword">long</span> fromId<span class="token punctuation">,</span> Bundle bundle<span class="token punctuation">,</span> EnterCallback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"enter fromId:"</span> <span class="token operator">+</span> fromId <span class="token operator">+</span> <span class="token string">" callback:"</span> <span class="token operator">+</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">updateManagerImpl</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mManagerImpl<span class="token punctuation">.</span><span class="token function">enter</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> fromId<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mUpdater<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-1-updateManagerImpl"><a href="#1-1-updateManagerImpl" class="headerlink" title="1.1.updateManagerImpl"></a>1.1.updateManagerImpl</h4><pre class="line-numbers language-java"><code class="language-java">  FixedPathPmUpdater fixedPathPmUpdater
                <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FixedPathPmUpdater</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/data/local/tmp/sample-manager-debug.apk"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateManagerImpl</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File latestManagerImplApk <span class="token operator">=</span> mUpdater<span class="token punctuation">.</span><span class="token function">getLatest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String md5 <span class="token operator">=</span> <span class="token function">md5File</span><span class="token punctuation">(</span>latestManagerImplApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"TextUtils.equals(mCurrentImplMd5, md5) : "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mCurrentImplMd5<span class="token punctuation">,</span> md5<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>TextUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>mCurrentImplMd5<span class="token punctuation">,</span> md5<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ManagerImplLoader implLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ManagerImplLoader</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> latestManagerImplApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            PluginManagerImpl newImpl <span class="token operator">=</span> implLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Bundle state<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mManagerImpl <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mManagerImpl<span class="token punctuation">.</span><span class="token function">onSaveInstanceState</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mManagerImpl<span class="token punctuation">.</span><span class="token function">onDestroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                state <span class="token operator">=</span> null<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            newImpl<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mManagerImpl <span class="token operator">=</span> newImpl<span class="token punctuation">;</span>
            mCurrentImplMd5 <span class="token operator">=</span> md5<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中实际上就是校验了<code>manager.apk</code>的和之前的md5是否一致，不是则需要更新。</p>
<p>发现了更新则执行如下几个步骤：</p>
<ul>
<li><ol>
<li>ManagerImplLoader 的 load 方法创建一个<code>PluginManagerImpl</code>对象</li>
</ol>
</li>
<li><ol start="2">
<li>原来的ManagerImplLoader 不为空，则依次调用<code>PluginManagerImpl</code>的<code>onSaveInstanceState</code>和<code>onDestroy</code></li>
</ol>
</li>
<li><ol start="3">
<li><code>PluginManagerImpl</code>的onCreate方法，更新<code>mManagerImpl</code>。</li>
</ol>
</li>
</ul>
<h4 id="1-3-ManagerImplLoader-load创建-PluginManagerImpl对象"><a href="#1-3-ManagerImplLoader-load创建-PluginManagerImpl对象" class="headerlink" title="1.3.ManagerImplLoader.load创建 PluginManagerImpl对象"></a>1.3.<code>ManagerImplLoader.load</code>创建 <code>PluginManagerImpl</code>对象</h4><pre class="line-numbers language-java"><code class="language-java">
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String MANAGER_FACTORY_CLASS_NAME <span class="token operator">=</span> <span class="token string">"com.tencent.shadow.dynamic.impl.ManagerFactoryImpl"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> REMOTE_PLUGIN_MANAGER_INTERFACES <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token punctuation">{</span>
                    <span class="token string">"com.tencent.shadow.core.common"</span><span class="token punctuation">,</span>
                    <span class="token string">"com.tencent.shadow.dynamic.host"</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">private</span> Context applicationContext<span class="token punctuation">;</span>
    <span class="token keyword">final</span> <span class="token keyword">private</span> InstalledApk installedApk<span class="token punctuation">;</span>

    <span class="token function">ManagerImplLoader</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> File apk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        applicationContext <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        File root <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ManagerImplLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        File odexDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>apk<span class="token punctuation">.</span><span class="token function">lastModified</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Character<span class="token punctuation">.</span>MAX_RADIX<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        odexDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        installedApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstalledApk</span><span class="token punctuation">(</span>apk<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> odexDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    PluginManagerImpl <span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ApkClassLoader apkClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApkClassLoader</span><span class="token punctuation">(</span>
                installedApk<span class="token punctuation">,</span>
                <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">loadWhiteList</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        Context pluginManagerContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChangeApkContextWrapper</span><span class="token punctuation">(</span>
                applicationContext<span class="token punctuation">,</span>
                installedApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">,</span>
                apkClassLoader
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ManagerFactory managerFactory <span class="token operator">=</span> apkClassLoader<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span>
                    ManagerFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    MANAGER_FACTORY_CLASS_NAME
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> managerFactory<span class="token punctuation">.</span><span class="token function">buildManager</span><span class="token punctuation">(</span>pluginManagerContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>ManagerImplLoader</code> 实际上是获得了<code>manager.apk</code>文件后，<br>并根据<code>manager.apk</code>文件生成两个对象：</p>
<ul>
<li>对应的<code>ApkClassLoader</code>用于查找manager.apk的类。</li>
<li>生成<code>ChangeApkContextWrapper</code>用于获取资源和获取<code>ApkClassLoader</code>。</li>
</ul>
<p>最后通过<code>ApkClassLoader</code> 查找这个apk中的<code>com.tencent.shadow.dynamic.impl.ManagerFactoryImpl</code> 类并实例化后，调用<code>buildManager</code> 生成<code>PluginManagerImpl</code>对象。</p>
<p>接下来的逻辑就是进入到了Manager.apk中了，是不是有点Replugin那味道了。</p>
<h4 id="2-ManagerFactoryImpl-buildManager"><a href="#2-ManagerFactoryImpl-buildManager" class="headerlink" title="2.ManagerFactoryImpl buildManager"></a>2.ManagerFactoryImpl buildManager</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 此类包名及类名固定
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ManagerFactoryImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ManagerFactory</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> PluginManagerImpl <span class="token function">buildManager</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SamplePluginManager</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此在manager工程中需要 写一个类名<code>ManagerFactoryImpl</code>，作为Manager.apk逻辑的入口。因此此时在宿主中返回的<code>PluginManagerImpl</code> 实际上就是自己编写的manager工程中返回的<code>SamplePluginManager</code>类。</p>
<p>在这个案例中，<code>SamplePluginManager</code>继承的是<code>PluginManagerThatUseDynamicLoader</code>.紧接着调用SamplePluginManager 的 onCreate 和 onDestroy。</p>
<h4 id="2-3-SamplePluginManager-enter"><a href="#2-3-SamplePluginManager-enter" class="headerlink" title="2.3. SamplePluginManager enter"></a>2.3. SamplePluginManager enter</h4><p>demo中的enter</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">enter</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> <span class="token keyword">long</span> fromId<span class="token punctuation">,</span> Bundle bundle<span class="token punctuation">,</span> <span class="token keyword">final</span> EnterCallback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fromId <span class="token operator">==</span> Constant<span class="token punctuation">.</span>FROM_ID_START_ACTIVITY<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_ZIP_PATH<span class="token punctuation">,</span> <span class="token string">"/data/local/tmp/plugin-debug.zip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_PART_KEY<span class="token punctuation">,</span> <span class="token string">"sample-plugin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bundle<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_ACTIVITY_CLASSNAME<span class="token punctuation">,</span> <span class="token string">"com.sample.test.SampleActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">onStartActivity</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> bundle<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fromId <span class="token operator">==</span> Constant<span class="token punctuation">.</span>FROM_ID_CALL_SERVICE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callPluginService</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"不认识的fromId=="</span> <span class="token operator">+</span> fromId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般的在SampleManager 中都会，都会根据<code>fromId</code>的业务类型来判断当前执行行为。就以<code>FROM_ID_START_ACTIVITY</code>为例子。这里尝试着启动<code>plugin-debug.zip</code>插件包中的插件。</p>
<p>而这个插件包存在着三个apk，<code>loader.apk</code>,<code>runtime.apk</code>,<code>$插件业务.apk</code>.因此可以说manager.apk管理了当前插件的加载逻辑。</p>
<h5 id="2-4-SamplePluginManager-onStartActivity"><a href="#2-4-SamplePluginManager-onStartActivity" class="headerlink" title="2.4. SamplePluginManager.onStartActivity"></a>2.4. SamplePluginManager.onStartActivity</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">onStartActivity</span><span class="token punctuation">(</span><span class="token keyword">final</span> Context context<span class="token punctuation">,</span> Bundle bundle<span class="token punctuation">,</span> <span class="token keyword">final</span> EnterCallback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> String pluginZipPath <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_ZIP_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String partKey <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_PLUGIN_PART_KEY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String className <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_ACTIVITY_CLASSNAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>className <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"className == null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">final</span> Bundle extras <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span>Constant<span class="token punctuation">.</span>KEY_EXTRAS<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> View view <span class="token operator">=</span> LayoutInflater<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>mCurrentContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inflate</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_load_plugin<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            callback<span class="token punctuation">.</span><span class="token function">onShowLoadingView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    InstalledPlugin installedPlugin <span class="token operator">=</span> <span class="token function">installPlugin</span><span class="token punctuation">(</span>pluginZipPath<span class="token punctuation">,</span> null<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    Intent pluginIntent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    pluginIntent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span>
                            context<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            className
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>extras <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        pluginIntent<span class="token punctuation">.</span><span class="token function">replaceExtras</span><span class="token punctuation">(</span>extras<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token function">startPluginActivity</span><span class="token punctuation">(</span>installedPlugin<span class="token punctuation">,</span> partKey<span class="token punctuation">,</span> pluginIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    callback<span class="token punctuation">.</span><span class="token function">onCloseLoadingView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>为了不阻塞进程，一般都会开启一个线程，进行加载插件包apk的数据。当加载成功后，就会启动插件的Activity。</p>
<h5 id="2-4-1-FastPluginManager-installPlugin"><a href="#2-4-1-FastPluginManager-installPlugin" class="headerlink" title="2.4.1 FastPluginManager.installPlugin"></a>2.4.1 FastPluginManager.installPlugin</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> InstalledPlugin <span class="token function">installPlugin</span><span class="token punctuation">(</span>String zip<span class="token punctuation">,</span> String hash <span class="token punctuation">,</span> <span class="token keyword">boolean</span> odex<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">,</span> JSONException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> ExecutionException <span class="token punctuation">{</span>
        <span class="token keyword">final</span> PluginConfig pluginConfig <span class="token operator">=</span> <span class="token function">installPluginFromZip</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>zip<span class="token punctuation">)</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> String uuid <span class="token operator">=</span> pluginConfig<span class="token punctuation">.</span>UUID<span class="token punctuation">;</span>
        List<span class="token operator">&lt;</span>Future<span class="token operator">></span> futures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginConfig<span class="token punctuation">.</span>runTime <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> pluginConfig<span class="token punctuation">.</span>pluginLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Future odexRuntime <span class="token operator">=</span> mFixedPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> Object <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                    <span class="token function">oDexPluginLoaderOrRunTime</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> InstalledType<span class="token punctuation">.</span>TYPE_PLUGIN_RUNTIME<span class="token punctuation">,</span>
                            pluginConfig<span class="token punctuation">.</span>runTime<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>odexRuntime<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Future odexLoader <span class="token operator">=</span> mFixedPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> Object <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                    <span class="token function">oDexPluginLoaderOrRunTime</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> InstalledType<span class="token punctuation">.</span>TYPE_PLUGIN_LOADER<span class="token punctuation">,</span>
                            pluginConfig<span class="token punctuation">.</span>pluginLoader<span class="token punctuation">.</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>odexLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> PluginConfig<span class="token punctuation">.</span>PluginFileInfo<span class="token operator">></span> plugin <span class="token operator">:</span> pluginConfig<span class="token punctuation">.</span>plugins<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> String partKey <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> File apkFile <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>file<span class="token punctuation">;</span>
            Future extractSo <span class="token operator">=</span> mFixedPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> Object <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                    <span class="token function">extractSo</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> partKey<span class="token punctuation">,</span> apkFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            futures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>extractSo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>odex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Future odexPlugin <span class="token operator">=</span> mFixedPool<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> Object <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                        <span class="token function">oDexPlugin</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> partKey<span class="token punctuation">,</span> apkFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                futures<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>odexPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>Future future <span class="token operator">:</span> futures<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">onInstallCompleted</span><span class="token punctuation">(</span>pluginConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token function">getInstalledPlugins</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.oDexPluginLoaderOrRunTime 安装 压缩包的runtime和loader的apk，并转化成dex。并复制到目标文件夹</li>
<li>2.extractSo 安装记录so的位置并复制到目标文件夹</li>
<li>3.oDexPlugin 把业务的apk转化成dex，拷贝到目标目录</li>
</ul>
<h4 id="2-4-2-FastPluginManager-startPluginActivity"><a href="#2-4-2-FastPluginManager-startPluginActivity" class="headerlink" title="2.4.2 FastPluginManager startPluginActivity"></a>2.4.2 FastPluginManager startPluginActivity</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startPluginActivity</span><span class="token punctuation">(</span> InstalledPlugin installedPlugin<span class="token punctuation">,</span> String partKey<span class="token punctuation">,</span> Intent pluginIntent<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">,</span> FailedException <span class="token punctuation">{</span>
        Intent intent <span class="token operator">=</span> <span class="token function">convertActivityIntent</span><span class="token punctuation">(</span>installedPlugin<span class="token punctuation">,</span> partKey<span class="token punctuation">,</span> pluginIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mPluginLoader<span class="token punctuation">.</span><span class="token function">startActivityInPluginProcess</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Intent <span class="token function">convertActivityIntent</span><span class="token punctuation">(</span>InstalledPlugin installedPlugin<span class="token punctuation">,</span> String partKey<span class="token punctuation">,</span> Intent pluginIntent<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">,</span> FailedException <span class="token punctuation">{</span>
        <span class="token function">loadPlugin</span><span class="token punctuation">(</span>installedPlugin<span class="token punctuation">.</span>UUID<span class="token punctuation">,</span> partKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map map <span class="token operator">=</span> mPluginLoader<span class="token punctuation">.</span><span class="token function">getLoadedPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Boolean isCall <span class="token operator">=</span> <span class="token punctuation">(</span>Boolean<span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>partKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isCall <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>isCall<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPluginLoader<span class="token punctuation">.</span><span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>partKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mPluginLoader<span class="token punctuation">.</span><span class="token function">convertActivityIntent</span><span class="token punctuation">(</span>pluginIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadPluginLoaderAndRuntime</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">,</span> String partKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">,</span> FailedException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPpsController <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">bindPluginProcessService</span><span class="token punctuation">(</span><span class="token function">getPluginProcessServiceName</span><span class="token punctuation">(</span>partKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">waitServiceConnected</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">loadRunTime</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">loadPluginLoader</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">loadPlugin</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">,</span> String partKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> RemoteException<span class="token punctuation">,</span> TimeoutException<span class="token punctuation">,</span> FailedException <span class="token punctuation">{</span>
        <span class="token function">loadPluginLoaderAndRuntime</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> partKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Map map <span class="token operator">=</span> mPluginLoader<span class="token punctuation">.</span><span class="token function">getLoadedPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>partKey<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mPluginLoader<span class="token punctuation">.</span><span class="token function">loadPlugin</span><span class="token punctuation">(</span>partKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这三个方法之间的关系：</p>
<ul>
<li>1.启动一个Service服务，并等待服务10秒。在这10秒中会创建一个<code>mPluginLoader</code>对象</li>
<li>2.loadRunTime 通过<code>mPluginLoader</code> 加载runtime.apk的数据</li>
<li>3.loadPluginLoader 通过<code>mPluginLoader</code> 加载loader.apk的数据</li>
<li>4.mPluginLoader.loadPlugin 加载插件</li>
<li>5.mPluginLoader.callApplicationOnCreate 调用插件的Application的onCreate方法</li>
<li>6.convertActivityIntent 检查坑位和插件Activity的映射关系</li>
<li>7.mPluginLoader.startActivityInPluginProcess 启动Activity在插件进程</li>
</ul>
<h4 id="2-5-manager工程通过BaseDynamicPluginManager启动插件进程"><a href="#2-5-manager工程通过BaseDynamicPluginManager启动插件进程" class="headerlink" title="2.5. manager工程通过BaseDynamicPluginManager启动插件进程"></a>2.5. manager工程通过BaseDynamicPluginManager启动插件进程</h4><p>还记得在SampleManager中重载的<code>getPluginProcessServiceName</code>方法，其中写死了一个Service的类名：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> String <span class="token function">getPluginProcessServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"com.tencent.shadow.sample.introduce_shadow_lib.MainPluginProcessService"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上是通过<code>bindPluginProcessService</code>这个方法启动这个Service：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">bindPluginProcessService</span><span class="token punctuation">(</span><span class="token keyword">final</span> String serviceName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mServiceConnecting<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"pps service connecting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"bindPluginProcessService "</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        mConnectCountDownLatch<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        mServiceConnecting<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> CountDownLatch startBindingLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">boolean</span><span class="token punctuation">[</span><span class="token punctuation">]</span> asyncResult <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">boolean</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        mUiHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                intent<span class="token punctuation">.</span><span class="token function">setComponent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>mHostContext<span class="token punctuation">,</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> binding <span class="token operator">=</span> mHostContext<span class="token punctuation">.</span><span class="token function">bindService</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ServiceConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"onServiceConnected connectCountDownLatch:"</span> <span class="token operator">+</span> mConnectCountDownLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mServiceConnecting<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment" spellcheck="true">// service connect 后处理逻辑</span>
                        <span class="token function">onPluginServiceConnected</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> service<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        mConnectCountDownLatch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"onServiceConnected countDown:"</span> <span class="token operator">+</span> mConnectCountDownLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"onServiceDisconnected"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        mServiceConnecting<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">onPluginServiceDisconnected</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> BIND_AUTO_CREATE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                asyncResult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> binding<span class="token punctuation">;</span>
                startBindingLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//等待bindService真正开始</span>
            startBindingLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>asyncResult<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"无法绑定PPS:"</span> <span class="token operator">+</span> serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">waitServiceConnected</span><span class="token punctuation">(</span><span class="token keyword">int</span> timeout<span class="token punctuation">,</span> TimeUnit timeUnit<span class="token punctuation">)</span> <span class="token keyword">throws</span> TimeoutException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"waitServiceConnected 不能在主线程中调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"waiting service connect connectCountDownLatch:"</span> <span class="token operator">+</span> mConnectCountDownLatch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">long</span> s <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> isTimeout <span class="token operator">=</span> <span class="token operator">!</span>mConnectCountDownLatch<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> timeUnit<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>isTimeout<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">TimeoutException</span><span class="token punctuation">(</span><span class="token string">"连接Service超时 ,等待了："</span> <span class="token operator">+</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"service connected "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>System<span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程十分的简单，实际上就是通过宿主的Context的bindService方法，启动一个固定类名的Service。并监听<code>onServiceConnected</code>方法，回调抽象方法<code>onPluginServiceConnected</code>.</p>
<p>而<code>onPluginServiceConnected</code>有两种实现，BaseDynamicPluginManager 的子类有两个：</p>
<ul>
<li>1.<code>PluginManagerThatSupportMultiLoader</code> </li>
<li>2.<code>PluginManagerThatUseDynamicLoader</code></li>
</ul>
<p>这里就挑选<code>PluginManagerThatUseDynamicLoader</code>进行解析。</p>
<h5 id="2-5-1-PluginManagerThatUseDynamicLoader-onPluginServiceConnected"><a href="#2-5-1-PluginManagerThatUseDynamicLoader-onPluginServiceConnected" class="headerlink" title="2.5.1  PluginManagerThatUseDynamicLoader onPluginServiceConnected"></a>2.5.1  PluginManagerThatUseDynamicLoader onPluginServiceConnected</h5><pre class="line-numbers language-java"><code class="language-java">   <span class="token comment" spellcheck="true">/**
     * 插件进程PluginProcessService的接口
     */</span>
    <span class="token keyword">protected</span> PpsController mPpsController<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/**
     * 插件加载服务端接口6
     */</span>
    <span class="token keyword">protected</span> PluginLoader mPluginLoader<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token function">PluginManagerThatUseDynamicLoader</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onPluginServiceConnected</span><span class="token punctuation">(</span>ComponentName name<span class="token punctuation">,</span> IBinder service<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mPpsController <span class="token operator">=</span> PluginProcessService<span class="token punctuation">.</span><span class="token function">wrapBinder</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mPpsController<span class="token punctuation">.</span><span class="token function">setUuidManager</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">UuidManagerBinder</span><span class="token punctuation">(</span>PluginManagerThatUseDynamicLoader<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">DeadObjectException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isErrorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"onServiceConnected RemoteException:"</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSimpleName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"TransactionTooLargeException"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isErrorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"onServiceConnected TransactionTooLargeException:"</span> <span class="token operator">+</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            IBinder iBinder <span class="token operator">=</span> mPpsController<span class="token punctuation">.</span><span class="token function">getPluginLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>iBinder <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPluginLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BinderPluginLoader</span><span class="token punctuation">(</span>iBinder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isErrorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"onServiceConnected mPpsController getPluginLoader:"</span><span class="token punctuation">,</span> ignored<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程，把对方服务端回调的Binder对象包裹成<code>PpsController</code>对象。</p>
<p>并调用PpsController对象的setUuidManager设置uuid给远端Service进程。接着通过<code>getPluginLoader</code>获取远端Service的Binder对象，并包装成<code>BinderPluginLoader</code>用于通信。</p>
<p>之后把所有的数据都往PpsController和PluginLoader通信相当于让所有的行为都交给远端Service所在的进程处理。</p>
<p>因为Context是从宿主中传递过来的，因此需要把该<code>getPluginProcessServiceName</code>对应的服务端类名注册到宿主中，且Class也需要声明在宿主中。</p>
<p>简单的看看宿主都做了什么吧。</p>
<h5 id="2-5-2-宿主声明的插件进程服务"><a href="#2-5-2-宿主声明的插件进程服务" class="headerlink" title="2.5.2 宿主声明的插件进程服务"></a>2.5.2 宿主声明的插件进程服务</h5><p>需要现在宿主中声明：</p>
<pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>.MainPluginProcessService<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:plugin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>然后MainPluginProcessService继承PluginProcessService。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token comment" spellcheck="true">/**
 * 一个PluginProcessService（简称PPS）代表一个插件进程。插件进程由PPS启动触发启动。
 * 新建PPS子类允许一个宿主中有多个互不影响的插件进程。
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MainPluginProcessService</span> <span class="token keyword">extends</span> <span class="token class-name">PluginProcessService</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>所有的事务交给<code>PluginProcessService</code>处理。能看到在这里，一般都会通过<code>android:process</code>标示完全不同的进程。所有的组件也会生存在这个进程，因此在声明坑位的时候，需要和<code>MainPluginProcessService</code>标示为同一个进程。</p>
<pre class="line-numbers language-xml"><code class="language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>activity</span>
            <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>com.tencent.shadow.sample.runtime.PluginDefaultProxyActivity<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>launchMode</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>standard<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>screenOrientation</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>portrait<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>configChanges</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>mcc|mnc|locale|touchscreen|keyboard|keyboardHidden|navigation|screenLayout|fontScale|uiMode|orientation|screenSize|smallestScreenSize|layoutDirection<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>hardwareAccelerated</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>theme</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>@style/PluginContainerActivity<span class="token punctuation">"</span></span>
            <span class="token attr-name"><span class="token namespace">android:</span>process</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>:plugin<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h5 id="2-4-2-2-1-PluginProcessService-loadRuntime"><a href="#2-4-2-2-1-PluginProcessService-loadRuntime" class="headerlink" title="2.4.2.2.1.PluginProcessService loadRuntime"></a>2.4.2.2.1.PluginProcessService loadRuntime</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">loadRuntime</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">)</span> <span class="token keyword">throws</span> FailedException <span class="token punctuation">{</span>
        <span class="token function">checkUuidManagerNotNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setUuid</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mRuntimeLoaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FailedException</span><span class="token punctuation">(</span>ERROR_CODE_RELOAD_RUNTIME_EXCEPTION
                    <span class="token punctuation">,</span> <span class="token string">"重复调用loadRuntime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"loadRuntime uuid:"</span> <span class="token operator">+</span> uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            InstalledApk installedApk<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                installedApk <span class="token operator">=</span> mUuidManager<span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RemoteException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FailedException</span><span class="token punctuation">(</span>ERROR_CODE_UUID_MANAGER_DEAD_EXCEPTION<span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FailedException</span><span class="token punctuation">(</span>ERROR_CODE_FILE_NOT_FOUND_EXCEPTION<span class="token punctuation">,</span> <span class="token string">"uuid=="</span> <span class="token operator">+</span> uuid <span class="token operator">+</span> <span class="token string">"的Runtime没有找到。cause:"</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            InstalledApk installedRuntimeApk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InstalledApk</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">,</span> installedApk<span class="token punctuation">.</span>oDexPath<span class="token punctuation">,</span> installedApk<span class="token punctuation">.</span>libraryPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> loaded <span class="token operator">=</span> DynamicRuntime<span class="token punctuation">.</span><span class="token function">loadRuntime</span><span class="token punctuation">(</span>installedRuntimeApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loaded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                DynamicRuntime<span class="token punctuation">.</span><span class="token function">saveLastRuntimeInfo</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> installedRuntimeApk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            mRuntimeLoaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isErrorEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"loadRuntime发生RuntimeException"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FailedException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.mUuidManager.getRuntime 实际上就是通信到Manager 所在的主进程获取之前在Manager中安装的runtime.apk的信息</li>
<li>2.DynamicRuntime.loadRuntime 装载runtime的ClassLoader</li>
<li>3.如果加载好了，就调用<code>saveLastRuntimeInfo</code> 把apk中的信息dex地址，so地址，apk地址都保存在sp中。</li>
</ul>
<h6 id="2-5-3-DynamicRuntime-loadRuntime"><a href="#2-5-3-DynamicRuntime-loadRuntime" class="headerlink" title="2.5.3.DynamicRuntime loadRuntime"></a>2.5.3.DynamicRuntime loadRuntime</h6><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">loadRuntime</span><span class="token punctuation">(</span>InstalledApk installedRuntimeApk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ClassLoader contextClassLoader <span class="token operator">=</span> DynamicRuntime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        RuntimeClassLoader runtimeClassLoader <span class="token operator">=</span> <span class="token function">getRuntimeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>runtimeClassLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            String apkPath <span class="token operator">=</span> runtimeClassLoader<span class="token punctuation">.</span>apkPath<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"last apkPath:"</span> <span class="token operator">+</span> apkPath <span class="token operator">+</span> <span class="token string">" new apkPath:"</span> <span class="token operator">+</span> installedRuntimeApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>apkPath<span class="token punctuation">,</span> installedRuntimeApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//已经加载相同版本的runtime了,不需要加载</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"已经加载相同apkPath的runtime了,不需要加载"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">//版本不一样，说明要更新runtime，先恢复正常的classLoader结构</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"加载不相同apkPath的runtime了,先恢复classLoader树结构"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token function">recoveryClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">//正常处理，将runtime 挂到pathclassLoader之上</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">hackParentToRuntime</span><span class="token punctuation">(</span>installedRuntimeApk<span class="token punctuation">,</span> contextClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> RuntimeClassLoader <span class="token function">getRuntimeClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ClassLoader contextClassLoader <span class="token operator">=</span> DynamicRuntime<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassLoader tmpClassLoader <span class="token operator">=</span> contextClassLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>tmpClassLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>tmpClassLoader <span class="token keyword">instanceof</span> <span class="token class-name">RuntimeClassLoader</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token punctuation">(</span>RuntimeClassLoader<span class="token punctuation">)</span> tmpClassLoader<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tmpClassLoader <span class="token operator">=</span> tmpClassLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">hackParentToRuntime</span><span class="token punctuation">(</span>InstalledApk installedRuntimeApk<span class="token punctuation">,</span> ClassLoader contextClassLoader<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        RuntimeClassLoader runtimeClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeClassLoader</span><span class="token punctuation">(</span>installedRuntimeApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">,</span> installedRuntimeApk<span class="token punctuation">.</span>oDexPath<span class="token punctuation">,</span>
                installedRuntimeApk<span class="token punctuation">.</span>libraryPath<span class="token punctuation">,</span> contextClassLoader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hackParentClassLoader</span><span class="token punctuation">(</span>contextClassLoader<span class="token punctuation">,</span> runtimeClassLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RuntimeClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseDexClassLoader</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/**
         * 加载的apk路径
         */</span>
        <span class="token keyword">private</span> String apkPath<span class="token punctuation">;</span>


        <span class="token function">RuntimeClassLoader</span><span class="token punctuation">(</span>String dexPath<span class="token punctuation">,</span> String optimizedDirectory<span class="token punctuation">,</span> String librarySearchPath<span class="token punctuation">,</span> ClassLoader parent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> optimizedDirectory <span class="token operator">==</span> null <span class="token operator">?</span> null <span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>optimizedDirectory<span class="token punctuation">)</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>apkPath <span class="token operator">=</span> dexPath<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程是十分简单的，就是把runtime.apk 的路径生成一个RuntimeClassLoader，并通过反射，设置为为当前进程ClassLoader父ClassLoader。</p>
<p>由于ClassLoader的双亲委托机制，当前进程要查找runtime中设置的坑位时候，通过委托机制会优先交给RuntimeClassLoader进行查找。这样宿主的<code>AndroidManifest.xml</code>注册了坑位，且在插件进程的ClassLoader 也注入了Class。</p>
<p>这样就保证了在插件进程，看起来就像AndroidManifest和Class 都在同一模块一样。这么做的好处是显而易见的，可以拆开实现，这样就能在插件包中自定义坑位逻辑，而不需要更新宿主。</p>
<h5 id="2-5-4-PluginProcessService-loadPluginLoader"><a href="#2-5-4-PluginProcessService-loadPluginLoader" class="headerlink" title="2.5.4.PluginProcessService loadPluginLoader"></a>2.5.4.PluginProcessService loadPluginLoader</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">loadPluginLoader</span><span class="token punctuation">(</span>String uuid<span class="token punctuation">)</span> <span class="token keyword">throws</span> FailedException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"loadPluginLoader uuid:"</span> <span class="token operator">+</span> uuid <span class="token operator">+</span> <span class="token string">" mPluginLoader:"</span> <span class="token operator">+</span> mPluginLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">checkUuidManagerNotNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setUuid</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mPluginLoader <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">FailedException</span><span class="token punctuation">(</span>ERROR_CODE_RELOAD_LOADER_EXCEPTION
                    <span class="token punctuation">,</span> <span class="token string">"重复调用loadPluginLoader"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            InstalledApk installedApk<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            PluginLoaderImpl pluginLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoaderImplLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">,</span> uuid<span class="token punctuation">,</span> <span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pluginLoader<span class="token punctuation">.</span><span class="token function">setUuidManager</span><span class="token punctuation">(</span>mUuidManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mPluginLoader <span class="token operator">=</span> pluginLoader<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FailedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>LoaderImplLoader.load</code>方法，开始加载loader.apk中的内容。并调用<code>pluginLoader.setUuidManager</code>设置<code>mUuidManager</code>.最后<code>PluginLoaderImpl</code>作为全局变量保存下来。</p>
<p>接下来就到了loader.apk的加载时机了</p>
<h4 id="2-5-5-LoaderImplLoader-load-加载loader-apk"><a href="#2-5-5-LoaderImplLoader-load-加载loader-apk" class="headerlink" title="2.5.5 LoaderImplLoader.load 加载loader.apk"></a>2.5.5 LoaderImplLoader.load 加载loader.apk</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">LoaderImplLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ImplLoader</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/**
     * 加载{@link #sLoaderFactoryImplClassName}时
     * 需要从宿主PathClassLoader（含双亲委派）中加载的类
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> sInterfaces <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//当runtime是动态加载的时候，runtime的ClassLoader是PathClassLoader的parent，</span>
            <span class="token comment" spellcheck="true">// 所以不需要写在这个白名单里。但是写在这里不影响，也可以兼容runtime打包在宿主的情况。</span>
            <span class="token string">"com.tencent.shadow.core.runtime.container"</span><span class="token punctuation">,</span>
            <span class="token string">"com.tencent.shadow.dynamic.host"</span><span class="token punctuation">,</span>
            <span class="token string">"com.tencent.shadow.core.common"</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> String sLoaderFactoryImplClassName
            <span class="token operator">=</span> <span class="token string">"com.tencent.shadow.dynamic.loader.impl.LoaderFactoryImpl"</span><span class="token punctuation">;</span>

    PluginLoaderImpl <span class="token function">load</span><span class="token punctuation">(</span>InstalledApk installedApk<span class="token punctuation">,</span> String uuid<span class="token punctuation">,</span> Context appContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
        ApkClassLoader pluginLoaderClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ApkClassLoader</span><span class="token punctuation">(</span>
                installedApk<span class="token punctuation">,</span>
                LoaderImplLoader<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token function">loadWhiteList</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token number">1</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        LoaderFactory loaderFactory <span class="token operator">=</span> pluginLoaderClassLoader<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span>
                LoaderFactory<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                sLoaderFactoryImplClassName
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> loaderFactory<span class="token punctuation">.</span><span class="token function">buildLoader</span><span class="token punctuation">(</span>uuid<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getCustomWhiteList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> sInterfaces<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程也是类似的，通过loader.apk生成一个<code>ApkClassLoader</code>，并获取一个固定的类名<code>LoaderFactoryImpl</code>并实例化，最后调用<code>buildLoader</code>方法。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Deprecated</span><span class="token punctuation">(</span><span class="token string">"兼容旧版本dynamic-host访问这个类名"</span><span class="token punctuation">,</span> level <span class="token operator">=</span> DeprecationLevel<span class="token punctuation">.</span>HIDDEN<span class="token punctuation">)</span>
<span class="token keyword">class</span> LoaderFactoryImpl <span class="token operator">:</span> com<span class="token punctuation">.</span>tencent<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span>loader<span class="token punctuation">.</span>impl<span class="token punctuation">.</span><span class="token function">LoaderFactoryImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin"><span class="token keyword">open</span> <span class="token keyword">class</span> LoaderFactoryImpl <span class="token operator">:</span> LoaderFactory <span class="token punctuation">{</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">buildLoader</span><span class="token punctuation">(</span>p0<span class="token operator">:</span> String<span class="token punctuation">,</span> p2<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> PluginLoaderImpl <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">PluginLoaderBinder</span><span class="token punctuation">(</span><span class="token function">DynamicPluginLoader</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> p0<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是返回了<code>PluginLoaderBinder</code>对象。注意这是一个Binder对象。当有Manager所在的进程调用PluginLoader对应的方式时候，实际上调用就是<code>DynamicPluginLoader</code>对象对应的方法。</p>
<p>来看看<code>DynamicPluginLoader</code>的构造函数。</p>
<h5 id="2-5-6-DynamicPluginLoader-构建SamplePluginLoader"><a href="#2-5-6-DynamicPluginLoader-构建SamplePluginLoader" class="headerlink" title="2.5.6.DynamicPluginLoader 构建SamplePluginLoader"></a>2.5.6.DynamicPluginLoader 构建SamplePluginLoader</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">open</span> <span class="token keyword">val</span> delegateProviderKey<span class="token operator">:</span> String <span class="token operator">=</span> DelegateProviderHolder<span class="token punctuation">.</span>DEFAULT_KEY<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> CORE_LOADER_FACTORY_IMPL_NAME <span class="token operator">=</span>
                <span class="token string">"com.tencent.shadow.dynamic.loader.impl.CoreLoaderFactoryImpl"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">init</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> coreLoaderFactory <span class="token operator">=</span> mDynamicLoaderClassLoader<span class="token punctuation">.</span><span class="token function">getInterface</span><span class="token punctuation">(</span>
                    CoreLoaderFactory<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">,</span>
                    CORE_LOADER_FACTORY_IMPL_NAME
            <span class="token punctuation">)</span>
            mPluginLoader <span class="token operator">=</span> coreLoaderFactory<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>hostContext<span class="token punctuation">)</span>
            DelegateProviderHolder<span class="token punctuation">.</span><span class="token function">setDelegateProvider</span><span class="token punctuation">(</span>mPluginLoader<span class="token punctuation">.</span>delegateProviderKey<span class="token punctuation">,</span> mPluginLoader<span class="token punctuation">)</span>
            ContentProviderDelegateProviderHolder<span class="token punctuation">.</span><span class="token function">setContentProviderDelegateProvider</span><span class="token punctuation">(</span>mPluginLoader<span class="token punctuation">)</span>
            mPluginLoader<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"当前的classLoader找不到PluginLoader的实现"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        mContext <span class="token operator">=</span> hostContext<span class="token punctuation">;</span>
        mUuid <span class="token operator">=</span> uuid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>这个过程先反射loader.apk中的<code>CoreLoaderFactoryImpl</code>对象，并调用build方法。此时在<code>DynamicPluginLoader</code>中的<code>mPluginLoader</code>,实际上就是指我们自定义的SamplePluginLoader。注意这个对象是继承于<code>ShadowPluginLoader</code>.</p>
</li>
<li><p>DelegateProviderHolder.setDelegateProvider 缓存SamplePluginLoader到一个map中，key为<code>DEFAULT_KEY</code>. 说明其实在Shadow的manager进程中，支持多个Loader来处理映射关系</p>
</li>
<li><p>将<code>mPluginLoader</code>缓存到<code>ContentProviderDelegateProviderHolder</code>的静态变量<code>contentProviderDelegateProvider</code>.</p>
</li>
<li><p>调用<code>mPluginLoader</code>的<code>onCreate</code></p>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        mComponentManager <span class="token operator">=</span> <span class="token function">getComponentManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        mComponentManager<span class="token punctuation">.</span><span class="token function">setPluginContentProviderManager</span><span class="token punctuation">(</span>mPluginContentProviderManager<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>很简单就是取出了SamplePluginLoader中声明的SampleComponentManager 对象，保存到<code>ShadowPluginLoader</code>中</p>
<h5 id="2-5-6-Manager进程-loadPlugin"><a href="#2-5-6-Manager进程-loadPlugin" class="headerlink" title="2.5.6 Manager进程 loadPlugin"></a>2.5.6 Manager进程 loadPlugin</h5><p>注意在 <code>PluginProcessService</code>中返回如下Binder</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> PpsBinder mPpsControllerBinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PpsBinder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> IBinder <span class="token function">onBind</span><span class="token punctuation">(</span>Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"onBind:"</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> mPpsControllerBinder<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这个Binder就是操作<code>PluginProcessService</code>。</p>
<p>在Manager进程中做了两个步骤进行加载插件</p>
<ul>
<li>1.获取PluginProcessService 的 PluginLoaderImpl 对象</li>
<li>2.调用PluginLoaderImpl的loadPlugin</li>
</ul>
<p>而这个<code>PluginLoaderImpl</code>就是指上文的<code>PluginLoaderBinder</code>对象.此时loadPlugin调用的就是DynamicPluginLoader如下方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    fun <span class="token function">loadPlugin</span><span class="token punctuation">(</span>partKey<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        val installedApk <span class="token operator">=</span> mUuidManager<span class="token punctuation">.</span><span class="token function">getPlugin</span><span class="token punctuation">(</span>mUuid<span class="token punctuation">,</span> partKey<span class="token punctuation">)</span>
        val future <span class="token operator">=</span> mPluginLoader<span class="token punctuation">.</span><span class="token function">loadPlugin</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">)</span>
        future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h6 id="ShadowPluginLoader-loadPlugin"><a href="#ShadowPluginLoader-loadPlugin" class="headerlink" title="ShadowPluginLoader loadPlugin"></a>ShadowPluginLoader loadPlugin</h6><pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>LoadPluginException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">loadPlugin</span><span class="token punctuation">(</span>
            installedApk<span class="token operator">:</span> InstalledApk
    <span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> loadParameters <span class="token operator">=</span> installedApk<span class="token punctuation">.</span><span class="token function">getLoadParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span>isInfoEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"start loadPlugin"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 在这里初始化PluginServiceManager</span>
        mPluginServiceManagerLock<span class="token punctuation">.</span><span class="token function">withLock</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">::</span>mPluginServiceManager<span class="token punctuation">.</span>isInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mPluginServiceManager <span class="token operator">=</span> <span class="token function">PluginServiceManager</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mHostAppContext<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            mComponentManager<span class="token punctuation">.</span><span class="token function">setPluginServiceManager</span><span class="token punctuation">(</span>mPluginServiceManager<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> LoadPluginBloc<span class="token punctuation">.</span><span class="token function">loadPlugin</span><span class="token punctuation">(</span>
                mExecutorService<span class="token punctuation">,</span>
                mPluginPackageInfoSet<span class="token punctuation">,</span>
                <span class="token operator">::</span>allPluginPackageInfo<span class="token punctuation">,</span>
                mComponentManager<span class="token punctuation">,</span>
                mLock<span class="token punctuation">,</span>
                mPluginPartsMap<span class="token punctuation">,</span>
                mHostAppContext<span class="token punctuation">,</span>
                installedApk<span class="token punctuation">,</span>
                loadParameters<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.创建一个mPluginServiceManager 对象并保存到mComponentManager 中</li>
<li>2.在LoadPluginBloc方法将会对Plugin所有的核心数据进行解析</li>
</ul>
<h5 id="LoadPluginBloc-loadPlugin"><a href="#LoadPluginBloc-loadPlugin" class="headerlink" title="LoadPluginBloc loadPlugin"></a>LoadPluginBloc loadPlugin</h5><pre class="line-numbers language-kotlin"><code class="language-kotlin"> <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>LoadPluginException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">loadPlugin</span><span class="token punctuation">(</span>
            executorService<span class="token operator">:</span> ExecutorService<span class="token punctuation">,</span>
            pluginPackageInfoSet<span class="token operator">:</span> MutableSet<span class="token operator">&lt;</span>PackageInfo<span class="token operator">></span><span class="token punctuation">,</span>
            allPluginPackageInfo<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">(</span>Array<span class="token operator">&lt;</span>PackageInfo<span class="token operator">></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            componentManager<span class="token operator">:</span> ComponentManager<span class="token punctuation">,</span>
            lock<span class="token operator">:</span> ReentrantLock<span class="token punctuation">,</span>
            pluginPartsMap<span class="token operator">:</span> MutableMap<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> PluginParts<span class="token operator">></span><span class="token punctuation">,</span>
            hostAppContext<span class="token operator">:</span> Context<span class="token punctuation">,</span>
            installedApk<span class="token operator">:</span> InstalledApk<span class="token punctuation">,</span>
            loadParameters<span class="token operator">:</span> LoadParameters
    <span class="token punctuation">)</span><span class="token operator">:</span> Future<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">></span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>installedApk<span class="token punctuation">.</span>apkFilePath <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">LoadPluginException</span><span class="token punctuation">(</span><span class="token string">"apkFilePath==null"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> buildClassLoader <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">withLock</span> <span class="token punctuation">{</span>
                    LoadApkBloc<span class="token punctuation">.</span><span class="token function">loadPlugin</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">,</span> loadParameters<span class="token punctuation">,</span> pluginPartsMap<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> getPackageInfo <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable <span class="token punctuation">{</span>
                <span class="token keyword">val</span> archiveFilePath <span class="token operator">=</span> installedApk<span class="token punctuation">.</span>apkFilePath
                <span class="token keyword">val</span> packageManager <span class="token operator">=</span> hostAppContext<span class="token punctuation">.</span>packageManager

                <span class="token keyword">val</span> packageArchiveInfo <span class="token operator">=</span> packageManager<span class="token punctuation">.</span><span class="token function">getPackageArchiveInfo</span><span class="token punctuation">(</span>
                        archiveFilePath<span class="token punctuation">,</span>
                        PackageManager<span class="token punctuation">.</span>GET_ACTIVITIES
                                <span class="token operator">or</span> PackageManager<span class="token punctuation">.</span>GET_META_DATA
                                <span class="token operator">or</span> PackageManager<span class="token punctuation">.</span>GET_SERVICES
                                <span class="token operator">or</span> PackageManager<span class="token punctuation">.</span>GET_PROVIDERS
                                <span class="token operator">or</span> PackageManager<span class="token punctuation">.</span>GET_SIGNATURES
                <span class="token punctuation">)</span>
                        <span class="token operator">?:</span> <span class="token keyword">throw</span> <span class="token function">NullPointerException</span><span class="token punctuation">(</span><span class="token string">"getPackageArchiveInfo return null.archiveFilePath==<span class="token interpolation variable">$archiveFilePath</span>"</span><span class="token punctuation">)</span>

                <span class="token keyword">val</span> tempContext <span class="token operator">=</span> <span class="token function">ShadowContext</span><span class="token punctuation">(</span>hostAppContext<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{</span>
                    <span class="token function">setBusinessName</span><span class="token punctuation">(</span>loadParameters<span class="token punctuation">.</span>businessName<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">val</span> dataDir <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    tempContext<span class="token punctuation">.</span>dataDir
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">File</span><span class="token punctuation">(</span>tempContext<span class="token punctuation">.</span>filesDir<span class="token punctuation">,</span> <span class="token string">"dataDir"</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                dataDir<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>nativeLibraryDir <span class="token operator">=</span> installedApk<span class="token punctuation">.</span>libraryPath
                packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>dataDir <span class="token operator">=</span> dataDir<span class="token punctuation">.</span>absolutePath
                packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>processName <span class="token operator">=</span> hostAppContext<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>processName
                packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid <span class="token operator">=</span> hostAppContext<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>uid

                lock<span class="token punctuation">.</span><span class="token function">withLock</span> <span class="token punctuation">{</span> pluginPackageInfoSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>packageArchiveInfo<span class="token punctuation">)</span> <span class="token punctuation">}</span>
                packageArchiveInfo
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> buildPluginInfo <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable <span class="token punctuation">{</span>
                <span class="token keyword">val</span> packageInfo <span class="token operator">=</span> getPackageInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                ParsePluginApkBloc<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">,</span> loadParameters<span class="token punctuation">,</span> hostAppContext<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> buildPackageManager <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable <span class="token punctuation">{</span>
                <span class="token keyword">val</span> packageInfo <span class="token operator">=</span> getPackageInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> hostPackageManager <span class="token operator">=</span> hostAppContext<span class="token punctuation">.</span>packageManager
                <span class="token function">PluginPackageManagerImpl</span><span class="token punctuation">(</span>hostPackageManager<span class="token punctuation">,</span> packageInfo<span class="token punctuation">,</span> allPluginPackageInfo<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> buildResources <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable <span class="token punctuation">{</span>
                <span class="token keyword">val</span> packageInfo <span class="token operator">=</span> getPackageInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                CreateResourceBloc<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>packageInfo<span class="token punctuation">,</span> installedApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">,</span> hostAppContext<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> buildAppComponentFactory <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable<span class="token operator">&lt;</span>ShadowAppComponentFactory<span class="token operator">></span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> pluginClassLoader <span class="token operator">=</span> buildClassLoader<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> pluginInfo <span class="token operator">=</span> buildPluginInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginInfo<span class="token punctuation">.</span>appComponentFactory <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">val</span> clazz <span class="token operator">=</span> pluginClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>pluginInfo<span class="token punctuation">.</span>appComponentFactory<span class="token punctuation">)</span>
                    ShadowAppComponentFactory<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">.</span><span class="token function">cast</span><span class="token punctuation">(</span>clazz<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token function">ShadowAppComponentFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> buildApplication <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>Callable <span class="token punctuation">{</span>
                <span class="token keyword">val</span> pluginClassLoader <span class="token operator">=</span> buildClassLoader<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> resources <span class="token operator">=</span> buildResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> pluginInfo <span class="token operator">=</span> buildPluginInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> packageInfo <span class="token operator">=</span> getPackageInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> appComponentFactory <span class="token operator">=</span> buildAppComponentFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                CreateApplicationBloc<span class="token punctuation">.</span><span class="token function">createShadowApplication</span><span class="token punctuation">(</span>
                        pluginClassLoader<span class="token punctuation">,</span>
                        pluginInfo<span class="token punctuation">,</span>
                        resources<span class="token punctuation">,</span>
                        hostAppContext<span class="token punctuation">,</span>
                        componentManager<span class="token punctuation">,</span>
                        packageInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">,</span>
                        appComponentFactory
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token keyword">val</span> buildRunningPlugin <span class="token operator">=</span> executorService<span class="token punctuation">.</span><span class="token function">submit</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">File</span><span class="token punctuation">(</span>installedApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token function">LoadPluginException</span><span class="token punctuation">(</span><span class="token string">"插件文件不存在.pluginFile=="</span> <span class="token operator">+</span> installedApk<span class="token punctuation">.</span>apkFilePath<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">val</span> pluginPackageManager <span class="token operator">=</span> buildPackageManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> pluginClassLoader <span class="token operator">=</span> buildClassLoader<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> resources <span class="token operator">=</span> buildResources<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> pluginInfo <span class="token operator">=</span> buildPluginInfo<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> shadowApplication <span class="token operator">=</span> buildApplication<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> appComponentFactory <span class="token operator">=</span> buildAppComponentFactory<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                lock<span class="token punctuation">.</span><span class="token function">withLock</span> <span class="token punctuation">{</span>
                    componentManager<span class="token punctuation">.</span><span class="token function">addPluginApkInfo</span><span class="token punctuation">(</span>pluginInfo<span class="token punctuation">)</span>
                    pluginPartsMap<span class="token punctuation">[</span>pluginInfo<span class="token punctuation">.</span>partKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">PluginParts</span><span class="token punctuation">(</span>
                            appComponentFactory<span class="token punctuation">,</span>
                            shadowApplication<span class="token punctuation">,</span>
                            pluginClassLoader<span class="token punctuation">,</span>
                            resources<span class="token punctuation">,</span>
                            pluginInfo<span class="token punctuation">.</span>businessName<span class="token punctuation">,</span>
                            pluginPackageManager
                    <span class="token punctuation">)</span>
                    PluginPartInfoManager<span class="token punctuation">.</span><span class="token function">addPluginInfo</span><span class="token punctuation">(</span>pluginClassLoader<span class="token punctuation">,</span> <span class="token function">PluginPartInfo</span><span class="token punctuation">(</span>shadowApplication<span class="token punctuation">,</span> resources<span class="token punctuation">,</span>
                            pluginClassLoader<span class="token punctuation">,</span> pluginPackageManager<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> buildRunningPlugin
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到整个过程都是通过线程的Future方式并发执行的。</p>
<ul>
<li><ol>
<li>buildClassLoader 实际上就是转化apk的路径为一个PluginClassLoader</li>
</ol>
</li>
<li>2.getPackageInfo 则是通过<code>packageManager.getPackageArchiveInfo</code>读取该apk中所有的四大组件相关的信息</li>
<li><ol start="3">
<li>buildPluginInfo 根据getPackageInfo返回的内容生成PluginInfo。注意在这个过程中会校验宿主的Context的packageName是否和插件包的xml中的包名一直。只有一致才会继续解析出插件信息。</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token annotation builtin">@Throws</span><span class="token punctuation">(</span>ParsePluginApkException<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">fun</span> <span class="token function">parse</span><span class="token punctuation">(</span>packageArchiveInfo<span class="token operator">:</span> PackageInfo<span class="token punctuation">,</span> loadParameters<span class="token operator">:</span> LoadParameters<span class="token punctuation">,</span> hostAppContext<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> PluginInfo <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName <span class="token operator">!=</span> hostAppContext<span class="token punctuation">.</span>packageName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/*
            要求插件和宿主包名一致有两方面原因：
            1.正常的构建过程中，aapt会将包名写入到arsc文件中。插件正常安装运行时，如果以
            android.content.Context.getPackageName为参数传给
            android.content.res.Resources.getIdentifier方法，可以正常获取到资源。但是在插件环境运行时，
            Context.getPackageName会得到宿主的packageName，则getIdentifier方法不能正常获取到资源。为此，
            一个可选的办法是继承Resources，覆盖getIdentifier方法。但是Resources的构造器已经被标记为
            @Deprecated了，未来可能会不可用，因此不首选这个方法。

            2.Android系统，更多情况下是OEM修改的Android系统，会在我们的context上调用getPackageName或者
            getOpPackageName等方法，然后将这个packageName跨进程传递做它用。系统的其他代码会以这个packageName
            去PackageManager中查询权限等信息。如果插件使用自己的包名，就需要在Context的getPackageName等实现中
            new Throwable()，然后判断调用来源以决定返回自己的包名还是插件的包名。但是如果保持采用宿主的包名，则没有
            这个烦恼。

            我们也可以始终认为Shadow App是宿主的扩展代码，使用是宿主的一部分，那么采用宿主的包名就是理所应当的了。
             */</span>
            <span class="token keyword">throw</span> <span class="token function">ParsePluginApkException</span><span class="token punctuation">(</span><span class="token string">"插件和宿主包名不一致。宿主:<span class="token interpolation"><span class="token delimiter variable">${</span>hostAppContext<span class="token punctuation">.</span>packageName<span class="token delimiter variable">}</span></span> 插件:<span class="token interpolation"><span class="token delimiter variable">${</span>packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName<span class="token delimiter variable">}</span></span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">/*
        partKey的作用是用来区分一个Component是来自于哪个插件apk的
         */</span>
        <span class="token keyword">val</span> partKey <span class="token operator">=</span> loadParameters<span class="token punctuation">.</span>partKey

        <span class="token keyword">val</span> pluginInfo <span class="token operator">=</span> <span class="token function">PluginInfo</span><span class="token punctuation">(</span>
                loadParameters<span class="token punctuation">.</span>businessName
                <span class="token punctuation">,</span> partKey
                <span class="token punctuation">,</span> packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>packageName
                <span class="token punctuation">,</span> packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>className
        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>P<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pluginInfo<span class="token punctuation">.</span>appComponentFactory <span class="token operator">=</span> packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>appComponentFactory
        <span class="token punctuation">}</span>
        packageArchiveInfo<span class="token punctuation">.</span>activities<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
            pluginInfo<span class="token punctuation">.</span><span class="token function">putActivityInfo</span><span class="token punctuation">(</span><span class="token function">PluginActivityInfo</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>name<span class="token punctuation">,</span> it<span class="token punctuation">.</span>themeResource<span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        packageArchiveInfo<span class="token punctuation">.</span>services<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> pluginInfo<span class="token punctuation">.</span><span class="token function">putServiceInfo</span><span class="token punctuation">(</span><span class="token function">PluginServiceInfo</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
        packageArchiveInfo<span class="token punctuation">.</span>providers<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
            pluginInfo<span class="token punctuation">.</span><span class="token function">putPluginProviderInfo</span><span class="token punctuation">(</span><span class="token function">PluginProviderInfo</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>name<span class="token punctuation">,</span> it<span class="token punctuation">.</span>authority<span class="token punctuation">,</span> it<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> pluginInfo
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注解上说的挺好的。如果不明白的，可以阅读我之前写的<a href="https://www.jianshu.com/p/817a787910f2" target="_blank" rel="noopener">Android资源管理系列文章</a>。这里面详细的阐述了Android是如何管理资源的。</p>
<p>简单来说就是在Android的资源管理中，有多重缓存。这里不想像我之前写的插件化文章一样一个自己生成ResourceImpl 设置进去管理，因为方法被标记为<code>@Deprecated</code>了。</p>
<p>其次就是动态权限相关的，如果阅读过相关的源码就能明白在动态权限中，所有的信息都保存在一个xml文件中。这个xml权限将以packageName+permissionName等为key记录相关信息。在Shadow看来，一来插件并不是真正的安装在Android系统中不符合规范，而来实际上插件对于宿主来说也是一种延伸。</p>
<p>因此需要保证宿主的packageName和插件记录在AndroidManifest中的packageName一致。</p>
<ul>
<li><p>4.生成一个PluginPackageManagerImpl 对象</p>
</li>
<li><p>5.CreateResourceBloc.create 更新宿主的ResourceImpl。这个方式属于比较熟悉源码的人才能明白。</p>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">create</span><span class="token punctuation">(</span>packageArchiveInfo<span class="token operator">:</span> PackageInfo<span class="token punctuation">,</span> archiveFilePath<span class="token operator">:</span> String<span class="token punctuation">,</span> hostAppContext<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> Resources <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//先用宿主context初始化一个WebView，以便WebView的逻辑去修改sharedLibraryFiles，将webview.apk添加进去</span>
        <span class="token keyword">val</span> latch <span class="token operator">=</span> <span class="token function">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{</span>
            <span class="token function">WebView</span><span class="token punctuation">(</span>hostAppContext<span class="token punctuation">)</span>
            latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">val</span> packageManager <span class="token operator">=</span> hostAppContext<span class="token punctuation">.</span>packageManager
        packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>publicSourceDir <span class="token operator">=</span> archiveFilePath
        packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>sourceDir <span class="token operator">=</span> archiveFilePath
        packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>sharedLibraryFiles <span class="token operator">=</span> hostAppContext<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">.</span>sharedLibraryFiles
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> packageManager<span class="token punctuation">.</span><span class="token function">getResourcesForApplication</span><span class="token punctuation">(</span>packageArchiveInfo<span class="token punctuation">.</span>applicationInfo<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> PackageManager<span class="token punctuation">.</span>NameNotFoundException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这过程中，核心的方法只有<code>getResourcesForApplication</code>这个。它最终会调用到ResourceManager的<code>getOrCreateResources</code>方法中。那么此时会在ResourceManager中为当前的apk资源创建一个全新的ResourceImpl。</p>
<ul>
<li><p>6.创建一个<code>ShadowAppComponentFactory</code>,用于对于xml中的<code>appComponentFactory</code>。</p>
</li>
<li><p>7.<code>CreateApplicationBloc.createShadowApplication</code>根据以上plugin信息实例化一个插件的Application，但是插件的Application的已经通过gradle插件转化为ShadowApplication了</p>
</li>
<li><ol start="8">
<li><code>componentManager.addPluginApkInfo</code> 对坑位和插件的Activity进行映射。</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">addPluginApkInfo</span><span class="token punctuation">(</span>pluginInfo<span class="token operator">:</span> PluginInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">fun</span> <span class="token function">common</span><span class="token punctuation">(</span>pluginComponentInfo<span class="token operator">:</span> PluginComponentInfo<span class="token punctuation">,</span>componentName<span class="token operator">:</span>ComponentName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            packageNameMap<span class="token punctuation">[</span>pluginComponentInfo<span class="token punctuation">.</span>className<span class="token operator">!!</span><span class="token punctuation">]</span> <span class="token operator">=</span> pluginInfo<span class="token punctuation">.</span>packageName
            <span class="token keyword">val</span> previousValue <span class="token operator">=</span> pluginInfoMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>componentName<span class="token punctuation">,</span> pluginInfo<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>previousValue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token function">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"重复添加Component：<span class="token interpolation variable">$componentName</span>"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            pluginComponentInfoMap<span class="token punctuation">[</span>componentName<span class="token punctuation">]</span> <span class="token operator">=</span> pluginComponentInfo
        <span class="token punctuation">}</span>

        pluginInfo<span class="token punctuation">.</span>mActivities<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> componentName <span class="token operator">=</span> <span class="token function">ComponentName</span><span class="token punctuation">(</span>pluginInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> it<span class="token punctuation">.</span>className<span class="token operator">!!</span><span class="token punctuation">)</span>
            <span class="token function">common</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span>componentName<span class="token punctuation">)</span>
            componentMap<span class="token punctuation">[</span>componentName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">onBindContainerActivity</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        pluginInfo<span class="token punctuation">.</span>mServices<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> componentName <span class="token operator">=</span> <span class="token function">ComponentName</span><span class="token punctuation">(</span>pluginInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> it<span class="token punctuation">.</span>className<span class="token operator">!!</span><span class="token punctuation">)</span>
            <span class="token function">common</span><span class="token punctuation">(</span>it<span class="token punctuation">,</span>componentName<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        pluginInfo<span class="token punctuation">.</span>mProviders<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> componentName <span class="token operator">=</span> <span class="token function">ComponentName</span><span class="token punctuation">(</span>pluginInfo<span class="token punctuation">.</span>packageName<span class="token punctuation">,</span> it<span class="token punctuation">.</span>className<span class="token operator">!!</span><span class="token punctuation">)</span>
            mPluginContentProviderManager<span class="token operator">!!</span><span class="token punctuation">.</span><span class="token function">addContentProviderInfo</span><span class="token punctuation">(</span>pluginInfo<span class="token punctuation">.</span>partKey<span class="token punctuation">,</span>it<span class="token punctuation">,</span><span class="token function">onBindContainerContentProvider</span><span class="token punctuation">(</span>componentName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法在<code>onBindContainerActivity</code>.这个方法需要我们进行重载，如上文的</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String DEFAULT_ACTIVITY <span class="token operator">=</span> <span class="token string">"com.tencent.shadow.sample.runtime.PluginDefaultProxyActivity"</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> ComponentName <span class="token function">onBindContainerActivity</span><span class="token punctuation">(</span>ComponentName pluginActivity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>pluginActivity<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/**
             * 这里配置对应的对应关系
             */</span>
            <span class="token keyword">case</span> <span class="token string">"com.sample.test.SampleActivity"</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> DEFAULT_NATIVE_ACTIVITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComponentName</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> DEFAULT_ACTIVITY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>因此这个方法是对runtime中的坑位和实际插件业务Activity之间的映射关系。</p>
<ul>
<li>9.最后把这些信息都保存到PluginPartInfoManager。</li>
</ul>
<h3 id="3-BinderPluginLoader-callApplicationOnCreate"><a href="#3-BinderPluginLoader-callApplicationOnCreate" class="headerlink" title="3.BinderPluginLoader.callApplicationOnCreate"></a>3.BinderPluginLoader.callApplicationOnCreate</h3><p>接下来在Manager进程就会调用<code>PluginLoader.callApplicationOnCreate</code>.而这个PluginLoader对象实际上是一个Binder对象，最后会调用到DynamicPluginLoader中。而这个方法最后又会调用到ShadowPluginLoader中。</p>
<p>当然这个过程只会调用一次，通过一个Map来记录那些插件是已经加载过了。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">callApplicationOnCreate</span><span class="token punctuation">(</span>partKey<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">fun</span> <span class="token function">realAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> pluginParts <span class="token operator">=</span> <span class="token function">getPluginParts</span><span class="token punctuation">(</span>partKey<span class="token punctuation">)</span>
            pluginParts<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
                <span class="token keyword">val</span> application <span class="token operator">=</span> pluginParts<span class="token punctuation">.</span>application
                application<span class="token punctuation">.</span><span class="token function">attachBaseContext</span><span class="token punctuation">(</span>mHostAppContext<span class="token punctuation">)</span>
                mPluginContentProviderManager<span class="token punctuation">.</span><span class="token function">createContentProviderAndCallOnCreate</span><span class="token punctuation">(</span>
                        application<span class="token punctuation">,</span> partKey<span class="token punctuation">,</span> pluginParts<span class="token punctuation">)</span>
                application<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUiThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">realAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> waitUiLock <span class="token operator">=</span> <span class="token function">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            mUiHandler<span class="token punctuation">.</span><span class="token function">post</span> <span class="token punctuation">{</span>
                <span class="token function">realAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                waitUiLock<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            waitUiLock<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">
    fun <span class="token function">createContentProviderAndCallOnCreate</span><span class="token punctuation">(</span>mContext<span class="token operator">:</span> Context<span class="token punctuation">,</span> partKey<span class="token operator">:</span> String<span class="token punctuation">,</span> pluginParts<span class="token operator">:</span> PluginParts<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pluginProviderInfoMap<span class="token punctuation">[</span>partKey<span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span>forEach <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                val contentProvider <span class="token operator">=</span> pluginParts<span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">.</span>appComponentFactory
                        <span class="token punctuation">.</span><span class="token function">instantiateProvider</span><span class="token punctuation">(</span>pluginParts<span class="token punctuation">.</span>classLoader<span class="token punctuation">,</span> it<span class="token punctuation">.</span>className<span class="token punctuation">)</span>
                contentProvider<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">attachInfo</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> it<span class="token punctuation">.</span>providerInfo<span class="token punctuation">)</span>
                providerMap<span class="token punctuation">[</span>it<span class="token punctuation">.</span>authority<span class="token operator">!</span><span class="token operator">!</span><span class="token punctuation">]</span> <span class="token operator">=</span> contentProvider
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"partKey==$partKey className==${it.className} providerInfo==${it.providerInfo}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里的顺序，和源码的顺序一致：依次调用业务插件Application的<code>attachBaseContext</code>，<code>CP的attachInfo</code>,<code>Application的onCreate</code></p>
<h4 id="4-DynamicPluginLoader-convertActivityIntent"><a href="#4-DynamicPluginLoader-convertActivityIntent" class="headerlink" title="4. DynamicPluginLoader convertActivityIntent"></a>4. DynamicPluginLoader convertActivityIntent</h4><p>接下来Mananager进程，调用BinderPluginLoader的convertActivityIntent，而这个方法最终还是调用到了<code>DynamicPluginLoader</code>中。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">fun</span> <span class="token function">convertActivityIntent</span><span class="token punctuation">(</span>pluginActivityIntent<span class="token operator">:</span> Intent<span class="token punctuation">)</span><span class="token operator">:</span> Intent<span class="token operator">?</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> mPluginLoader<span class="token punctuation">.</span>mComponentManager<span class="token punctuation">.</span><span class="token function">convertPluginActivityIntent</span><span class="token punctuation">(</span>pluginActivityIntent<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">convertPluginActivityIntent</span><span class="token punctuation">(</span>pluginIntent<span class="token operator">:</span> Intent<span class="token punctuation">)</span><span class="token operator">:</span> Intent <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginIntent<span class="token punctuation">.</span><span class="token function">isPluginComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            pluginIntent<span class="token punctuation">.</span><span class="token function">toActivityContainerIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            pluginIntent
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 调用前必须先调用isPluginComponent判断Intent确实一个插件内的组件
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> Intent<span class="token punctuation">.</span><span class="token function">toActivityContainerIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Intent <span class="token punctuation">{</span>
        <span class="token keyword">val</span> bundleForPluginLoader <span class="token operator">=</span> <span class="token function">Bundle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> pluginComponentInfo <span class="token operator">=</span> pluginComponentInfoMap<span class="token punctuation">[</span>component<span class="token punctuation">]</span><span class="token operator">!!</span>
        bundleForPluginLoader<span class="token punctuation">.</span><span class="token function">putParcelable</span><span class="token punctuation">(</span>CM_ACTIVITY_INFO_KEY<span class="token punctuation">,</span> pluginComponentInfo<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">toContainerIntent</span><span class="token punctuation">(</span>bundleForPluginLoader<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">/**
     * 构造pluginIntent对应的ContainerIntent
     * 调用前必须先调用isPluginComponent判断Intent确实一个插件内的组件
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> Intent<span class="token punctuation">.</span><span class="token function">toContainerIntent</span><span class="token punctuation">(</span>bundleForPluginLoader<span class="token operator">:</span> Bundle<span class="token punctuation">)</span><span class="token operator">:</span> Intent <span class="token punctuation">{</span>
        <span class="token keyword">val</span> component <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>component<span class="token operator">!!</span>
        <span class="token keyword">val</span> className <span class="token operator">=</span> component<span class="token punctuation">.</span>className
        <span class="token keyword">val</span> packageName <span class="token operator">=</span> packageNameMap<span class="token punctuation">[</span>className<span class="token punctuation">]</span><span class="token operator">!!</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>component <span class="token operator">=</span> <span class="token function">ComponentName</span><span class="token punctuation">(</span>packageName<span class="token punctuation">,</span> className<span class="token punctuation">)</span>
        <span class="token keyword">val</span> containerComponent <span class="token operator">=</span> componentMap<span class="token punctuation">[</span>component<span class="token punctuation">]</span><span class="token operator">!!</span>
        <span class="token keyword">val</span> businessName <span class="token operator">=</span> pluginInfoMap<span class="token punctuation">[</span>component<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span>businessName
        <span class="token keyword">val</span> partKey <span class="token operator">=</span> pluginInfoMap<span class="token punctuation">[</span>component<span class="token punctuation">]</span><span class="token operator">!!</span><span class="token punctuation">.</span>partKey

        <span class="token keyword">val</span> pluginExtras<span class="token operator">:</span> Bundle<span class="token operator">?</span> <span class="token operator">=</span> extras
        <span class="token function">replaceExtras</span><span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token keyword">as</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span>

        <span class="token keyword">val</span> containerIntent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        containerIntent<span class="token punctuation">.</span>component <span class="token operator">=</span> containerComponent

        bundleForPluginLoader<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>CM_CLASS_NAME_KEY<span class="token punctuation">,</span> className<span class="token punctuation">)</span>
        bundleForPluginLoader<span class="token punctuation">.</span><span class="token function">putString</span><span class="token punctuation">(</span>CM_PACKAGE_NAME_KEY<span class="token punctuation">,</span> packageName<span class="token punctuation">)</span>

        containerIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>CM_EXTRAS_BUNDLE_KEY<span class="token punctuation">,</span> pluginExtras<span class="token punctuation">)</span>
        containerIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>CM_BUSINESS_NAME_KEY<span class="token punctuation">,</span> businessName<span class="token punctuation">)</span>
        containerIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>CM_PART_KEY<span class="token punctuation">,</span> partKey<span class="token punctuation">)</span>
        containerIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>CM_LOADER_BUNDLE_KEY<span class="token punctuation">,</span> bundleForPluginLoader<span class="token punctuation">)</span>
        containerIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>LOADER_VERSION_KEY<span class="token punctuation">,</span> BuildConfig<span class="token punctuation">.</span>VERSION_NAME<span class="token punctuation">)</span>
        containerIntent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span>PROCESS_ID_KEY<span class="token punctuation">,</span> DelegateProviderHolder<span class="token punctuation">.</span>sCustomPid<span class="token punctuation">)</span>
        <span class="token keyword">return</span> containerIntent
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Shadow，在启动插件Activity的时候，直接写入类名到Intent中。接着会在DynamicPluginLoader中检查之前通过addPluginInfo 完成的映射关系。把插件的Activity对应的坑位变成目标启动的Activity。而原来插件的Activity将会存到Intent中。</p>
<p>等待坑位的处理。</p>
<p>此时我们假设是映射的是一个<code>PluginDefaultProxyActivity</code>.那么<code>PluginDefaultProxyActivity(继承了PluginContainerActivity)</code>这个Activity声明在AndroidManifest.xml的进程刚好是<code>plugin</code>。就是通过这个手段达到的跨进程启动Activity的手段。</p>
<h5 id="5-坑位PluginContainerActivity-构造函数"><a href="#5-坑位PluginContainerActivity-构造函数" class="headerlink" title="5.坑位PluginContainerActivity 构造函数"></a>5.坑位PluginContainerActivity 构造函数</h5><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">PluginContainerActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        HostActivityDelegate delegate<span class="token punctuation">;</span>
        DelegateProvider delegateProvider <span class="token operator">=</span> DelegateProviderHolder<span class="token punctuation">.</span><span class="token function">getDelegateProvider</span><span class="token punctuation">(</span><span class="token function">getDelegateProviderKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>delegateProvider <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            delegate <span class="token operator">=</span> delegateProvider<span class="token punctuation">.</span><span class="token function">getHostActivityDelegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delegate<span class="token punctuation">.</span><span class="token function">setDelegator</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"PluginContainerActivity: DelegateProviderHolder没有初始化"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            delegate <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span>hostActivityDelegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
        hostActivityDelegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>还记得之前把<code>SamplePluginLoader</code>存到了<code>DelegateProviderHolder</code>中。此时把它取出来。而刚好的是loader和runtime正好在插件进程。</p>
<p>因此这样才能那个在找到SamplePluginLoader。而这里<code>delegateProvider</code>就是指<code>SamplePluginLoader</code>.</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getHostActivityDelegate</span><span class="token punctuation">(</span>aClass<span class="token operator">:</span> Class<span class="token operator">&lt;</span><span class="token keyword">out</span> HostActivityDelegator<span class="token operator">></span><span class="token punctuation">)</span><span class="token operator">:</span> HostActivityDelegate <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">ShadowActivityDelegate</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时会返回一个<code>ShadowActivityDelegate</code>对象并把调用<code>setDelegator</code>，设置当前的Activity为代理者。并设置到全局<code>hostActivityDelegate</code>.</p>
<p>之后所有坑位相关的生命周期都会传递到<code>ShadowActivityDelegate</code>中处理。就以onCreate为例子</p>
<h4 id="5-PluginContainerActivity-onCreate"><a href="#5-PluginContainerActivity-onCreate" class="headerlink" title="5.PluginContainerActivity onCreate"></a>5.PluginContainerActivity onCreate</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">final</span> <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        isBeforeOnCreate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        mHostTheme <span class="token operator">=</span> null<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//释放资源</span>

        <span class="token keyword">boolean</span> illegalIntent <span class="token operator">=</span> <span class="token function">isIllegalIntent</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>illegalIntent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span>hostActivityDelegate <span class="token operator">=</span> null<span class="token punctuation">;</span>
            hostActivityDelegate <span class="token operator">=</span> null<span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"illegalIntent savedInstanceState=="</span> <span class="token operator">+</span> savedInstanceState <span class="token operator">+</span> <span class="token string">" getIntent().getExtras()=="</span> <span class="token operator">+</span> <span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getExtras</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>hostActivityDelegate <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            hostActivityDelegate<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">//这里是进程被杀后重启后走到，当需要恢复fragment状态的时候，由于系统保留了TAG，会因为找不到fragment引起crash</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"onCreate: hostActivityDelegate==null finish activity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先校验插件包对应的loader版本是否和VersionName一致，以及判断进程号是否改变了。一旦出现了问题则拒绝启动插件的Activity。</p>
<p>接着才会走到<code>ShadowActivityDelegate</code>的onCreate</p>
<h4 id="6-ShadowActivityDelegate-onCreate"><a href="#6-ShadowActivityDelegate-onCreate" class="headerlink" title="6.ShadowActivityDelegate onCreate"></a>6.ShadowActivityDelegate onCreate</h4><pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">val</span> pluginInitBundle <span class="token operator">=</span> savedInstanceState <span class="token operator">?:</span> mHostActivityDelegator<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>extras<span class="token operator">!!</span>

        mCallingActivity <span class="token operator">=</span> pluginInitBundle<span class="token punctuation">.</span><span class="token function">getParcelable</span><span class="token punctuation">(</span>CM_CALLING_ACTIVITY_KEY<span class="token punctuation">)</span>
        mBusinessName <span class="token operator">=</span> pluginInitBundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>CM_BUSINESS_NAME_KEY<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> partKey <span class="token operator">=</span> pluginInitBundle<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>CM_PART_KEY<span class="token punctuation">)</span><span class="token operator">!!</span>
        mPartKey <span class="token operator">=</span> partKey
        mDI<span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> partKey<span class="token punctuation">)</span>
        mDependenciesInjected <span class="token operator">=</span> <span class="token boolean">true</span>

        mMixResources <span class="token operator">=</span> <span class="token function">MixResources</span><span class="token punctuation">(</span>mHostActivityDelegator<span class="token punctuation">.</span><span class="token function">superGetResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mPluginResources<span class="token punctuation">)</span>

        <span class="token keyword">val</span> bundleForPluginLoader <span class="token operator">=</span> pluginInitBundle<span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span>CM_LOADER_BUNDLE_KEY<span class="token punctuation">)</span><span class="token operator">!!</span>
        mBundleForPluginLoader <span class="token operator">=</span> bundleForPluginLoader
        bundleForPluginLoader<span class="token punctuation">.</span>classLoader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>javaClass<span class="token punctuation">.</span>classLoader
        <span class="token keyword">val</span> pluginActivityClassName <span class="token operator">=</span> bundleForPluginLoader<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>CM_CLASS_NAME_KEY<span class="token punctuation">)</span><span class="token operator">!!</span>
        <span class="token keyword">val</span> pluginActivityInfo<span class="token operator">:</span> PluginActivityInfo <span class="token operator">=</span> bundleForPluginLoader<span class="token punctuation">.</span><span class="token function">getParcelable</span><span class="token punctuation">(</span>CM_ACTIVITY_INFO_KEY<span class="token punctuation">)</span><span class="token operator">!!</span>

        mCurrentConfiguration <span class="token operator">=</span> <span class="token function">Configuration</span><span class="token punctuation">(</span>resources<span class="token punctuation">.</span>configuration<span class="token punctuation">)</span>
        mPluginHandleConfigurationChange <span class="token operator">=</span>
                <span class="token punctuation">(</span>pluginActivityInfo<span class="token punctuation">.</span>activityInfo<span class="token operator">!!</span><span class="token punctuation">.</span>configChanges
                        <span class="token operator">or</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SCREEN_SIZE<span class="token comment" spellcheck="true">//系统本身就会单独对待这个属性，不声明也不会重启Activity。</span>
                        <span class="token operator">or</span> ActivityInfo<span class="token punctuation">.</span>CONFIG_SMALLEST_SCREEN_SIZE<span class="token comment" spellcheck="true">//系统本身就会单独对待这个属性，不声明也不会重启Activity。</span>
                        <span class="token operator">or</span> <span class="token number">0x20000000</span> <span class="token comment" spellcheck="true">//见ActivityInfo.CONFIG_WINDOW_CONFIGURATION 系统处理属性</span>
                        <span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>savedInstanceState <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mRawIntentExtraBundle <span class="token operator">=</span> pluginInitBundle<span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span>CM_EXTRAS_BUNDLE_KEY<span class="token punctuation">)</span>
            mHostActivityDelegator<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">replaceExtras</span><span class="token punctuation">(</span>mRawIntentExtraBundle<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        mHostActivityDelegator<span class="token punctuation">.</span>intent<span class="token punctuation">.</span><span class="token function">setExtrasClassLoader</span><span class="token punctuation">(</span>mPluginClassLoader<span class="token punctuation">)</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">val</span> pluginActivity <span class="token operator">=</span> mAppComponentFactory<span class="token punctuation">.</span><span class="token function">instantiateActivity</span><span class="token punctuation">(</span>
                    mPluginClassLoader<span class="token punctuation">,</span>
                    pluginActivityClassName<span class="token punctuation">,</span>
                    mHostActivityDelegator<span class="token punctuation">.</span>intent
            <span class="token punctuation">)</span>
            <span class="token function">initPluginActivity</span><span class="token punctuation">(</span>pluginActivity<span class="token punctuation">,</span> pluginActivityInfo<span class="token punctuation">)</span>
            <span class="token keyword">super</span><span class="token punctuation">.</span>pluginActivity <span class="token operator">=</span> pluginActivity

            <span class="token keyword">if</span> <span class="token punctuation">(</span>mLogger<span class="token punctuation">.</span>isDebugEnabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mLogger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{} mPluginHandleConfigurationChange=={}"</span><span class="token punctuation">,</span> mPluginActivity<span class="token punctuation">.</span>javaClass<span class="token punctuation">.</span>canonicalName<span class="token punctuation">,</span> mPluginHandleConfigurationChange<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">//使PluginActivity替代ContainerActivity接收Window的Callback</span>
            mHostActivityDelegator<span class="token punctuation">.</span>window<span class="token punctuation">.</span>callback <span class="token operator">=</span> pluginActivity

            <span class="token comment" spellcheck="true">//设置插件AndroidManifest.xml 中注册的WindowSoftInputMode</span>
            mHostActivityDelegator<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">setSoftInputMode</span><span class="token punctuation">(</span>pluginActivityInfo<span class="token punctuation">.</span>activityInfo<span class="token punctuation">.</span>softInputMode<span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">//Activity.onCreate调用之前应该先收到onWindowAttributesChanged。</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mCallOnWindowAttributesChanged<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                pluginActivity<span class="token punctuation">.</span><span class="token function">onWindowAttributesChanged</span><span class="token punctuation">(</span>
                    mBeforeOnCreateOnWindowAttributesChangedCalledParams
                <span class="token punctuation">)</span>
                mBeforeOnCreateOnWindowAttributesChangedCalledParams <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">val</span> pluginSavedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span> <span class="token operator">=</span>
                savedInstanceState<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">getBundle</span><span class="token punctuation">(</span>PLUGIN_OUT_STATE_KEY<span class="token punctuation">)</span>
            pluginSavedInstanceState<span class="token operator">?</span><span class="token punctuation">.</span>classLoader <span class="token operator">=</span> mPluginClassLoader
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>Q<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">notifyPluginActivityPreCreated</span><span class="token punctuation">(</span>pluginActivity<span class="token punctuation">,</span> pluginSavedInstanceState<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            pluginActivity<span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>pluginSavedInstanceState<span class="token punctuation">)</span>
            mPluginActivityCreated <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token function">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上很简单，实例化插件的Activity对象后。</p>
<ul>
<li>initPluginActivity 初始化插件的Activity。注意插件的Activity已经被替换成了ShadowActivity了。这个方法中为插件Activity设置了classLoader，application等核心参数</li>
<li>插件的Activity监听来自坑位的Window.Callback.以及处理setSoftInputMode</li>
<li>调用插件Activity的onCreate</li>
</ul>
<h4 id="7-gradle-plugin插件库的原理"><a href="#7-gradle-plugin插件库的原理" class="headerlink" title="7.gradle-plugin插件库的原理"></a>7.gradle-plugin插件库的原理</h4><p>这里就不详细描述插件业务依赖的gradle插件原理。核心方法在<code>ShadowPlugin</code>中。这个插件的职责是打包出插件包以及转化插件工程中组件集成的对象。如继承于Activity，就被转化成继承ShadowActivity。</p>
<p>不熟悉Gradle的读者，可以阅读我之前写的<a href="https://www.jianshu.com/p/d1099b77a753" target="_blank" rel="noopener">Gradle入门</a></p>
<p>核心就是这个task</p>
<pre class="line-numbers language-groovy"><code class="language-groovy">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>project<span class="token operator">.</span><span class="token function">hasProperty</span><span class="token punctuation">(</span><span class="token string">"disable_shadow_transform"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            baseExtension<span class="token operator">.</span><span class="token function">registerTransform</span><span class="token punctuation">(</span><span class="token function">ShadowTransform</span><span class="token punctuation">(</span>
                    project<span class="token punctuation">,</span>
                    classPoolBuilder<span class="token punctuation">,</span>
                    <span class="token punctuation">{</span> shadowExtension<span class="token operator">.</span>transformConfig<span class="token operator">.</span>useHostContext <span class="token punctuation">}</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中他设置了如下转化器</p>
<pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">TransformManager</span><span class="token punctuation">(</span>ctClassInputMap<span class="token punctuation">:</span> Map<span class="token operator">&lt;</span>CtClass<span class="token punctuation">,</span> InputClass<span class="token operator">></span><span class="token punctuation">,</span>
                       classPool<span class="token punctuation">:</span> ClassPool<span class="token punctuation">,</span>
                       useHostContext<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> Array<span class="token operator">&lt;</span>String<span class="token operator">></span>
<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token function">AbstractTransformManager</span><span class="token punctuation">(</span>ctClassInputMap<span class="token punctuation">,</span> classPool<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    override val mTransformList<span class="token punctuation">:</span> List<span class="token operator">&lt;</span>SpecificTransform<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">listOf</span><span class="token punctuation">(</span>
            <span class="token function">ApplicationTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">ActivityTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">ServiceTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">IntentServiceTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">InstrumentationTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">FragmentSupportTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">DialogSupportTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">WebViewTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">ContentProviderTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">PackageManagerTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">PackageItemInfoTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">AppComponentFactoryTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">LayoutInflaterTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">KeepHostContextTransform</span><span class="token punctuation">(</span><span class="token function">useHostContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ApplicationTransform</span> <span class="token punctuation">:</span> <span class="token function">SimpleRenameTransform</span><span class="token punctuation">(</span>
        <span class="token function">mapOf</span><span class="token punctuation">(</span>
                <span class="token string">"android.app.Application"</span>
                        to <span class="token string">"com.tencent.shadow.core.runtime.ShadowApplication"</span>
                <span class="token punctuation">,</span>
                <span class="token string">"android.app.Application\$ActivityLifecycleCallbacks"</span>
                        to <span class="token string">"com.tencent.shadow.core.runtime.ShadowActivityLifecycleCallbacks"</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">ActivityTransform</span> <span class="token punctuation">:</span> <span class="token function">SimpleRenameTransform</span><span class="token punctuation">(</span>
        <span class="token function">mapOf</span><span class="token punctuation">(</span>
                <span class="token string">"android.app.Activity"</span>
                        to <span class="token string">"com.tencent.shadow.core.runtime.ShadowActivity"</span>
        <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个映射方式，很简单。就是把代码中的Application 全部替换成ShadowApplication。Activity全部替换成ShadowActivity。</p>
<p>因此插件库中所有的Activity本质上就是ShadowActivity。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>用一张图简单总结：<br><img src="/images/Shadow.png" alt="Shadow.png"></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>至此Shadow的全流程就解析就完成了。后续会恢复正常，开始有规律的开始更新文章。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/05/03/cong-cronet-kan-http3-he-quic-yi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/4.jpg" class="responsive-img" alt="从Cronet 看Http3和QUIC(一)">
                        
                        <span class="card-title">从Cronet 看Http3和QUIC(一)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言前一段时间，在公司内部进行了一次QUIC协议的演讲。当时因为时间有限，没有仔细的讨论Cronet 的源码细节，仅仅只是介绍了QUIC的协议细节。本文就从Cronet源码出发，聊聊QUIC的一些实现，进而看看QUIC对比Http2的优势，
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-05-03
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/quic/">
                        <span class="chip bg-color">quic</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/24/xiao-neng-bi-ji-android-dan-yuan-ce-shi-yu-junit-yuan-ma-jie-xi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/18.jpg" class="responsive-img" alt="效能笔记 Android单元测试与JUnit源码解析">
                        
                        <span class="card-title">效能笔记 Android单元测试与JUnit源码解析</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言进入大厂已经有一段时间了，这段时间确实接触了在外面未曾接触到很多东西。而在外界津津乐道的进阶知识点（什么native hook，性能监控，插件化），在大厂内部只是常识罢了。这群大牛早在16年的时候发文研究透了。
还是需要端正态度，从零开
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-04-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/test/">
                        <span class="chip bg-color">test</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
