<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android socket源码解析(三)socket的connect源码解析, Android | Linux | Flutter">
    <meta name="description" content="前言上一篇文章着重的聊了socket服务端的bind，listen，accpet的逻辑。本文来着重聊聊connect都做了什么？
如果遇到什么问题，可以来本文 https://www.jianshu.com/p/da6089fdcfe1 下">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android socket源码解析(三)socket的connect源码解析 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/3.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android socket源码解析(三)socket的connect源码解析
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/socket/">
                                <span class="chip bg-color">socket</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-24
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.9k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        39 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>上一篇文章着重的聊了socket服务端的bind，listen，accpet的逻辑。本文来着重聊聊connect都做了什么？</p>
<p>如果遇到什么问题，可以来本文 <a href="https://www.jianshu.com/p/da6089fdcfe1" target="_blank" rel="noopener">https://www.jianshu.com/p/da6089fdcfe1</a> 下讨论</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="1-Connect-系统调用"><a href="#1-Connect-系统调用" class="headerlink" title="1.Connect 系统调用"></a>1.Connect 系统调用</h2><p>当服务端一切都准备好了。客户端就会尝试的通过<code>connect</code>系统调用，尝试的和服务端建立远程连接。</p>
<pre><code>    protected void connect(SocketAddress address, int timeout)
            throws IOException {
        boolean connected = false;
        try {
            if (address == null || !(address instanceof InetSocketAddress))
                throw new IllegalArgumentException("unsupported address type");
            InetSocketAddress addr = (InetSocketAddress) address;
            if (addr.isUnresolved())
                throw new UnknownHostException(addr.getHostName());
            this.port = addr.getPort();
            this.address = addr.getAddress();

            connectToAddress(this.address, port, timeout);
            connected = true;
        } finally {
            if (!connected) {
                try {
                    close();
                } catch (IOException ioe) {
                    /* Do nothing. If connect threw an exception then
                       it will be passed up the call stack */
                }
            }
        }
    }

    private void connectToAddress(InetAddress address, int port, int timeout) throws IOException {
        if (address.isAnyLocalAddress()) {
            doConnect(InetAddress.getLocalHost(), port, timeout);
        } else {
            doConnect(address, port, timeout);
        }
    }
</code></pre><p>首先校验当前socket中是否有正确的目标地址。然后获取IP地址和端口调用<code>connectToAddress</code>。</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">doConnect</span><span class="token punctuation">(</span>InetAddress address<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>fdLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>closePending <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>socket <span class="token operator">==</span> null <span class="token operator">||</span> <span class="token operator">!</span>socket<span class="token punctuation">.</span><span class="token function">isBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                NetHooks<span class="token punctuation">.</span><span class="token function">beforeTcpConnect</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> address<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">acquireFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                BlockGuard<span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">socketConnect</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> port<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">/* socket may have been closed during poll/select */</span>
                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>fdLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>closePending<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SocketException</span> <span class="token punctuation">(</span><span class="token string">"Socket closed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    socket<span class="token punctuation">.</span><span class="token function">setBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    socket<span class="token punctuation">.</span><span class="token function">setConnected</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token function">releaseFD</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中，能看到有一个<code>NetHooks</code>跟踪socket的调用，也能看到<code>BlockGuard</code>跟踪了socket的connect调用。因此可以hook这两个地方跟踪socket，不过很少用就是了。</p>
<p>核心方法是<code>socketConnect</code>方法，这个方法就是调用<code>IoBridge.connect</code>方法。同理也会调用到jni中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Linux_connect</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jobject javaFd<span class="token punctuation">,</span> jobject javaAddress<span class="token punctuation">,</span> jint port<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token function">NET_IPV4_FALLBACK</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> connect<span class="token punctuation">,</span> javaFd<span class="token punctuation">,</span> javaAddress<span class="token punctuation">,</span> port<span class="token punctuation">,</span> NULL_ADDR_FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>能看到也是调用了<code>connect</code>系统调用。</p>
<h3 id="2-Linux内核的connect系统调用"><a href="#2-Linux内核的connect系统调用" class="headerlink" title="2.Linux内核的connect系统调用"></a>2.Linux内核的connect系统调用</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>connect<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr __user <span class="token operator">*</span><span class="token punctuation">,</span> uservaddr<span class="token punctuation">,</span>
        <span class="token keyword">int</span><span class="token punctuation">,</span> addrlen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sockaddr_storage address<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">,</span> fput_needed<span class="token punctuation">;</span>

    sock <span class="token operator">=</span> <span class="token function">sockfd_lookup_light</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>err<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fput_needed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sock<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">move_addr_to_kernel</span><span class="token punctuation">(</span>uservaddr<span class="token punctuation">,</span> addrlen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>address<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_put<span class="token punctuation">;</span>

    err <span class="token operator">=</span>
        <span class="token function">security_socket_connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_put<span class="token punctuation">;</span>

    err <span class="token operator">=</span> sock<span class="token operator">-></span>ops<span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>address<span class="token punctuation">,</span> addrlen<span class="token punctuation">,</span>
                 sock<span class="token operator">-></span>file<span class="token operator">-></span>f_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
out_put<span class="token punctuation">:</span>
    <span class="token function">fput_light</span><span class="token punctuation">(</span>sock<span class="token operator">-></span>file<span class="token punctuation">,</span> fput_needed<span class="token punctuation">)</span><span class="token punctuation">;</span>
out<span class="token punctuation">:</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.sockfd_lookup_light 从fd中私有数据查找到<code>socket</code>结构体</li>
<li>2.move_addr_to_kernel 拷贝地址</li>
<li>3.security_socket_connect 通过SELinux校验当前文件描述符的对该操作是否有合法性</li>
<li>4.调用<code>inet_stream_ops</code>中对应的<code>connect</code>的方法指针。而这里的方法就是指向<code>inet_stream_connect</code>。</li>
</ul>
<h4 id="2-1-inet-stream-ops-inet-stream-connect"><a href="#2-1-inet-stream-ops-inet-stream-connect" class="headerlink" title="2.1.inet_stream_ops inet_stream_connect"></a>2.1.inet_stream_ops inet_stream_connect</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/af_inet.c" target="_blank" rel="noopener">af_inet.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">__inet_stream_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>uaddr<span class="token punctuation">,</span>
              <span class="token keyword">int</span> addr_len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk <span class="token operator">=</span> sock<span class="token operator">-></span>sk<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    <span class="token keyword">long</span> timeo<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr_len <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uaddr<span class="token operator">-></span>sa_family<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>uaddr<span class="token operator">-></span>sa_family <span class="token operator">==</span> AF_UNSPEC<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> sk<span class="token operator">-></span>sk_prot<span class="token operator">-></span><span class="token function">disconnect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sock<span class="token operator">-></span>state <span class="token operator">=</span> err <span class="token operator">?</span> SS_DISCONNECTING <span class="token punctuation">:</span> SS_UNCONNECTED<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>sock<span class="token operator">-></span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token keyword">case</span> SS_CONNECTED<span class="token punctuation">:</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EISCONN<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token keyword">case</span> SS_CONNECTING<span class="token punctuation">:</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EALREADY<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Fall out of switch with err, set for this state */</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> SS_UNCONNECTED<span class="token punctuation">:</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EISCONN<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_state <span class="token operator">!=</span> TCP_CLOSE<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        err <span class="token operator">=</span> sk<span class="token operator">-></span>sk_prot<span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> uaddr<span class="token punctuation">,</span> addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        sock<span class="token operator">-></span>state <span class="token operator">=</span> SS_CONNECTING<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token operator">-</span>EINPROGRESS<span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    timeo <span class="token operator">=</span> <span class="token function">sock_sndtimeo</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> sk<span class="token operator">-></span>sk_state<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>TCPF_SYN_SENT <span class="token operator">|</span> TCPF_SYN_RECV<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> writebias <span class="token operator">=</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_protocol <span class="token operator">==</span> IPPROTO_TCP<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>fastopen_req <span class="token operator">&amp;&amp;</span>
                <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>fastopen_req<span class="token operator">-></span>data <span class="token operator">?</span> <span class="token number">1</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Error code is set above */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>timeo <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">inet_wait_for_connect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> timeo<span class="token punctuation">,</span> writebias<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        err <span class="token operator">=</span> <span class="token function">sock_intr_errno</span><span class="token punctuation">(</span>timeo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">signal_pending</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_state <span class="token operator">==</span> TCP_CLOSE<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> sock_error<span class="token punctuation">;</span>


    sock<span class="token operator">-></span>state <span class="token operator">=</span> SS_CONNECTED<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
out<span class="token punctuation">:</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>

sock_error<span class="token punctuation">:</span>
    err <span class="token operator">=</span> <span class="token function">sock_error</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">:</span> <span class="token operator">-</span>ECONNABORTED<span class="token punctuation">;</span>
    sock<span class="token operator">-></span>state <span class="token operator">=</span> SS_UNCONNECTED<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_prot<span class="token operator">-></span><span class="token function">disconnect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">)</span>
        sock<span class="token operator">-></span>state <span class="token operator">=</span> SS_DISCONNECTING<span class="token punctuation">;</span>
    <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>__inet_stream_connect<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">inet_stream_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>uaddr<span class="token punctuation">,</span>
            <span class="token keyword">int</span> addr_len<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>

    <span class="token function">lock_sock</span><span class="token punctuation">(</span>sock<span class="token operator">-></span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">__inet_stream_connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> uaddr<span class="token punctuation">,</span> addr_len<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">release_sock</span><span class="token punctuation">(</span>sock<span class="token operator">-></span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>inet_stream_connect<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中做的事情如下：</p>
<ul>
<li>1.首先校验地址类型是<code>AF_UNSPEC</code>,说明此时没有指定则返回</li>
<li>2.校验socket的状态，只有<code>SS_UNCONNECTED</code>状态下，才会执行核心方法<code>sk-&gt;sk_prot-&gt;connect</code>进行tcp的三次握手。并把socket的状态设置为<code>SS_CONNECTING</code></li>
<li>3.然后校验<code>sock</code>结构体的状态，如果是<code>TCPF_SYN_SENT</code>或者<code>TCPF_SYN_RECV</code>，且<code>sock</code>结构体中判断协议类型为<code>IPPROTO_TCP</code>，并且<code>fastopen_req</code>的数据存在。那么就会通过<code>inet_wait_for_connect</code>等待sock结构体中TFO的数据传输完毕，并检查<code>signal_pending</code>是否有需要执行的信号</li>
<li>4.最后设置<code>socket</code>结构体状态为<code>SS_CONNECTED</code>.</li>
</ul>
<p>注意<code>sk_prot</code>所指向的方法是，<code>tcp_prot</code>中<code>connect</code>所指向的方法，也就是指<code>tcp_v4_connect</code>.</p>
<h4 id="2-2-tcp-prot-tcp-v4-connect"><a href="#2-2-tcp-prot-tcp-v4-connect" class="headerlink" title="2.2.tcp_prot tcp_v4_connect"></a>2.2.tcp_prot tcp_v4_connect</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/tcp_ipv4.c" target="_blank" rel="noopener">tcp_ipv4.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">tcp_v4_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>uaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> addr_len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sockaddr_in <span class="token operator">*</span>usin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in <span class="token operator">*</span><span class="token punctuation">)</span>uaddr<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> inet_sock <span class="token operator">*</span>inet <span class="token operator">=</span> <span class="token function">inet_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> tcp_sock <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __be16 orig_sport<span class="token punctuation">,</span> orig_dport<span class="token punctuation">;</span>
    __be32 daddr<span class="token punctuation">,</span> nexthop<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>fl4<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rtable <span class="token operator">*</span>rt<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ip_options_rcu <span class="token operator">*</span>inet_opt<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>addr_len <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>usin<span class="token operator">-></span>sin_family <span class="token operator">!=</span> AF_INET<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EAFNOSUPPORT<span class="token punctuation">;</span>

    nexthop <span class="token operator">=</span> daddr <span class="token operator">=</span> usin<span class="token operator">-></span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">;</span>
    inet_opt <span class="token operator">=</span> <span class="token function">rcu_dereference_protected</span><span class="token punctuation">(</span>inet<span class="token operator">-></span>inet_opt<span class="token punctuation">,</span>
                         <span class="token function">sock_owned_by_user</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inet_opt <span class="token operator">&amp;&amp;</span> inet_opt<span class="token operator">-></span>opt<span class="token punctuation">.</span>srr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>daddr<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        nexthop <span class="token operator">=</span> inet_opt<span class="token operator">-></span>opt<span class="token punctuation">.</span>faddr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    orig_sport <span class="token operator">=</span> inet<span class="token operator">-></span>inet_sport<span class="token punctuation">;</span>
    orig_dport <span class="token operator">=</span> usin<span class="token operator">-></span>sin_port<span class="token punctuation">;</span>
    fl4 <span class="token operator">=</span> <span class="token operator">&amp;</span>inet<span class="token operator">-></span>cork<span class="token punctuation">.</span>fl<span class="token punctuation">.</span>u<span class="token punctuation">.</span>ip4<span class="token punctuation">;</span>
    rt <span class="token operator">=</span> <span class="token function">ip_route_connect</span><span class="token punctuation">(</span>fl4<span class="token punctuation">,</span> nexthop<span class="token punctuation">,</span> inet<span class="token operator">-></span>inet_saddr<span class="token punctuation">,</span>
                  <span class="token function">RT_CONN_FLAGS</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">,</span> sk<span class="token operator">-></span>sk_bound_dev_if<span class="token punctuation">,</span>
                  IPPROTO_TCP<span class="token punctuation">,</span>
                  orig_sport<span class="token punctuation">,</span> orig_dport<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inet_opt <span class="token operator">||</span> <span class="token operator">!</span>inet_opt<span class="token operator">-></span>opt<span class="token punctuation">.</span>srr<span class="token punctuation">)</span>
        daddr <span class="token operator">=</span> fl4<span class="token operator">-></span>daddr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inet<span class="token operator">-></span>inet_saddr<span class="token punctuation">)</span>
        inet<span class="token operator">-></span>inet_saddr <span class="token operator">=</span> fl4<span class="token operator">-></span>saddr<span class="token punctuation">;</span>
    inet<span class="token operator">-></span>inet_rcv_saddr <span class="token operator">=</span> inet<span class="token operator">-></span>inet_saddr<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tp<span class="token operator">-></span>rx_opt<span class="token punctuation">.</span>ts_recent_stamp <span class="token operator">&amp;&amp;</span> inet<span class="token operator">-></span>inet_daddr <span class="token operator">!=</span> daddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* Reset inherited state */</span>
        tp<span class="token operator">-></span>rx_opt<span class="token punctuation">.</span>ts_recent       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tp<span class="token operator">-></span>rx_opt<span class="token punctuation">.</span>ts_recent_stamp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span>tp<span class="token operator">-></span>repair<span class="token punctuation">)</span><span class="token punctuation">)</span>
            tp<span class="token operator">-></span>write_seq       <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>tcp_death_row<span class="token punctuation">.</span>sysctl_tw_recycle <span class="token operator">&amp;&amp;</span>
        <span class="token operator">!</span>tp<span class="token operator">-></span>rx_opt<span class="token punctuation">.</span>ts_recent_stamp <span class="token operator">&amp;&amp;</span> fl4<span class="token operator">-></span>daddr <span class="token operator">==</span> daddr<span class="token punctuation">)</span>
        <span class="token function">tcp_fetch_timewait_stamp</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rt<span class="token operator">-></span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>

    inet<span class="token operator">-></span>inet_dport <span class="token operator">=</span> usin<span class="token operator">-></span>sin_port<span class="token punctuation">;</span>
    inet<span class="token operator">-></span>inet_daddr <span class="token operator">=</span> daddr<span class="token punctuation">;</span>

    <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>icsk_ext_hdr_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>inet_opt<span class="token punctuation">)</span>
        <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>icsk_ext_hdr_len <span class="token operator">=</span> inet_opt<span class="token operator">-></span>opt<span class="token punctuation">.</span>optlen<span class="token punctuation">;</span>

    tp<span class="token operator">-></span>rx_opt<span class="token punctuation">.</span>mss_clamp <span class="token operator">=</span> TCP_MSS_DEFAULT<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Socket identity is still unknown (sport may be zero).
     * However we set state to SYN-SENT and not releasing socket
     * lock select source port, enter ourselves into the hash tables and
     * complete initialization after this.
     */</span>
    <span class="token function">tcp_set_state</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> TCP_SYN_SENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">inet_hash_connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcp_death_row<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> failure<span class="token punctuation">;</span>

    <span class="token function">inet_set_txhash</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    rt <span class="token operator">=</span> <span class="token function">ip_route_newports</span><span class="token punctuation">(</span>fl4<span class="token punctuation">,</span> rt<span class="token punctuation">,</span> orig_sport<span class="token punctuation">,</span> orig_dport<span class="token punctuation">,</span>
                   inet<span class="token operator">-></span>inet_sport<span class="token punctuation">,</span> inet<span class="token operator">-></span>inet_dport<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> failure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">/* OK, now commit destination to socket.  */</span>
    sk<span class="token operator">-></span>sk_gso_type <span class="token operator">=</span> SKB_GSO_TCPV4<span class="token punctuation">;</span>
    <span class="token function">sk_setup_caps</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rt<span class="token operator">-></span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>tp<span class="token operator">-></span>write_seq <span class="token operator">&amp;&amp;</span> <span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span>tp<span class="token operator">-></span>repair<span class="token punctuation">)</span><span class="token punctuation">)</span>
        tp<span class="token operator">-></span>write_seq <span class="token operator">=</span> <span class="token function">secure_tcp_sequence_number</span><span class="token punctuation">(</span>inet<span class="token operator">-></span>inet_saddr<span class="token punctuation">,</span>
                               inet<span class="token operator">-></span>inet_daddr<span class="token punctuation">,</span>
                               inet<span class="token operator">-></span>inet_sport<span class="token punctuation">,</span>
                               usin<span class="token operator">-></span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>

    inet<span class="token operator">-></span>inet_id <span class="token operator">=</span> tp<span class="token operator">-></span>write_seq <span class="token operator">^</span> jiffies<span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token function">tcp_connect</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    rt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> failure<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

failure<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>tcp_v4_connect<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>本质上核心任务有三件:</p>
<ul>
<li>ip_route_connect 查找/创建一个通过DDNS缓存好的目的地址对应的 rtable 缓存路由表</li>
<li>ip_route_newports 会检查分配过的端口号是否在第一步出现了变更，并更新端口号</li>
<li><code>sk_setup_caps</code> 将获取的<code>rtable</code> 中的<code>dst_entry</code>保存到<code>sock</code>结构体的<code>sk_dst_cache</code></li>
<li>通过<code>tcp_set_state(sk, TCP_SYN_SENT)</code> 将当前的sock结构体状态设置为<code>TCP_SYN_SENT</code></li>
<li>tcp_connect 进行tcp的三次握手操作</li>
</ul>
<h3 id="3-路由表的简单介绍"><a href="#3-路由表的简单介绍" class="headerlink" title="3.路由表的简单介绍"></a>3.路由表的简单介绍</h3><p>想要能够理解下文内容，先要明白什么是路由表。</p>
<blockquote>
<p>在计算机网络中，路由表/路由择域选择库(RIB) 是一个存储在路由器或者计算机的电子表格或者数据库。路由表存储着指向特定网络地址的路径（在一些情况下，还记录有路径的路由度量值）。 路由表中含有网络周边的拓扑信息。路由表建立的主要目标是为了实现路由协议和静态路由选择。</p>
</blockquote>
<p>路由表分为两大类：</p>
<ul>
<li>静态路由表 由系统管理员事先设置好的路由表，一般在安装好的时候根据网络配置就确定</li>
<li>动态路由表 根据运行的网络系统而不断的发生变化的路由表。路由器会根据路由选择协议提供的功能自动学习和记忆网络的运行情况，必要的时候会计算出最大路径</li>
</ul>
<p>每个路由器都有一个路由表(RIB)和转发表 (fib表)，路由表用于决策路由，转发表决策转发分组。下文会接触到这两种表。</p>
<p>这两个表有什么区别呢？</p>
<p>网上虽然给了如下的定义：</p>
<ul>
<li>RIB保存了每种协议的网络拓扑以及路由表。这里面将会包含许多相同前缀的路有地址</li>
<li>FIB是从保存在内存中的多种协议中的路由表中找到最佳路径的路由。</li>
</ul>
<p>但实际上在Linux 3.8.1中并没有明确的区分。整个路由相关的逻辑都是使用了fib转发表承担的。</p>
<p>先来看看几个和FIB转发表相关的核心结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> rtable <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> dst_entry    dst<span class="token punctuation">;</span>

    <span class="token keyword">int</span>            rt_genid<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span>        rt_flags<span class="token punctuation">;</span>
    __u16            rt_type<span class="token punctuation">;</span>
    __u8            rt_is_input<span class="token punctuation">;</span>
    __u8            rt_uses_gateway<span class="token punctuation">;</span>

    <span class="token keyword">int</span>            rt_iif<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Info on neighbour */</span>
    __be32            rt_gateway<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Miscellaneous cached information */</span>
    u32            rt_pmtu<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> list_head    rt_uncached<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>熟悉Linux命令朋友一定就能认出这里面大部分的字段都可以通过route命令查找到。</p>
<p>命令执行结果如下：<br><img src="/images/route%E5%91%BD%E4%BB%A4.png" alt="route命令.png"></p>
<p>在这route命令结果的字段实际上都对应上了结构体中的字段含义：</p>
<ul>
<li><code>dst</code> 也就是dst_entry结构体，这个结构体包含了十分多的内容，比如局域网中邻居的信息，xfrm 用于IP Spec的相关信息</li>
<li><code>rt_genid</code> 一个从0开始递增的序列号,当selinux初始化的时候为每一个net结构体中所对应的协议。当初每个进程的selinux的时候，会获取当前进程命令空间（namespace）中的网络抽象链表（net结构体）,遍历每个net增加一个序列号。</li>
<li><code>rt_flags</code> 对应了命令的Flags字段。大致上有如下几种：</li>
</ul>
<table>
<thead>
<tr>
<th>flags</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>U</td>
<td>路由是活动的</td>
</tr>
<tr>
<td>H</td>
<td>目标是个主机</td>
</tr>
<tr>
<td>G</td>
<td>需要经过网关</td>
</tr>
<tr>
<td>R</td>
<td>恢复动态路由产生的表项</td>
</tr>
<tr>
<td>D</td>
<td>由路由的后台程序动态地安装</td>
</tr>
<tr>
<td>M</td>
<td>由路由的后台程序修改</td>
</tr>
<tr>
<td>!</td>
<td>拒绝路由</td>
</tr>
</tbody></table>
<ul>
<li><code>rt_type</code> 当前的路由的类型。对应在Linux内核就是如下这个枚举：<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* rtm_type */</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ul>
<p>enum {<br>    RTN_UNSPEC,<br>    RTN_UNICAST,        /* 网关或者直接路由    <em>/<br>    RTN_LOCAL,        /</em> 本地路由        <em>/<br>    RTN_BROADCAST,        /</em> 接受本地广播，作为广播发送<em>/<br>    RTN_ANYCAST,        /</em> 接受本地广播，<br>但以单播方式发送 <em>/<br>    RTN_MULTICAST,        /*多播路由    */<br>    RTN_BLACKHOLE,        /</em> 丢包路由<em>/<br>    RTN_UNREACHABLE,    /*目标路由不可到达  */<br>    RTN_PROHIBIT,        /</em>    管理禁止<em>/<br>    RTN_THROW,        /</em> 不在表内        <em>/<br>    RTN_NAT,        /</em> 路由转化    <em>/<br>    RTN_XRESOLVE,        /</em> 使用外部解析器    */<br>    __RTN_MAX<br>};</p>
<pre><code>
- `rt_is_input ` 判断当前的路由是输入还是输出

- `rt_uses_gateway ` 判断当前路由是否使用网关

- `rt_iif ` 套接口绑定了设备接口

- `rt_gateway` 路由所对应的网关

- `rt_pmtu`pmtu 最大路径信息

- `rt_uncached` 无法抵达的路由集合

知道路由表的的内容后。再来FIB转发表的内容。实际上从下面的源码其实可以得知，路由表的获取，实际上是先从fib转发表的路由字典树获取到后在同感加工获得路由表对象。

转发表的内容就更加简单

```c
struct fib_table {
    struct hlist_node    tb_hlist;
    u32            tb_id;
    int            tb_default;
    int            tb_num_default;
    unsigned long        tb_data[0];
};</code></pre><ul>
<li><code>tb_hlist</code> fib转发表的双端链表节点</li>
<li><code>tb_id</code> 路由标识，最多可以有256个路由表</li>
<li><code>tb_num_default</code>当前fib默认的序列号</li>
<li><code>tb_data</code> 指向转发表中真正的转发数据</li>
</ul>
<h3 id="4-本地路由分配原理"><a href="#4-本地路由分配原理" class="headerlink" title="4.本地路由分配原理"></a>4.本地路由分配原理</h3><p>还记得在之前总结的ip地址的结构吗？</p>
<p><img src="/images/IP%E6%8A%A5%E6%96%87.png" alt="IP报文.png"></p>
<p>需要进行一次tcp的通信，意味着需要把ip报文准备好。因此需要决定源ip地址和目标IP地址。目标ip地址在之前通过netd查询到了，此时需要得到本地发送的源ip地址。</p>
<p>然而在实际情况下，往往是面对如下这么情况：公网一个对外的ip地址，而内网会被映射成多个不同内网的ip地址。而这个过程就是通过DDNS动态的在内存中进行更新。</p>
<p>因此<code>ip_route_connect</code>实际上就是选择一个缓存好的，通过DDNS设置好的内网ip地址并找到作为结果返回，将会在之后发送包的时候填入这些存在结果信息。而查询内网ip地址的过程，可以成为RTNetLink。</p>
<p>在Linux中有一个常用的命令<code>ifconfig</code>也可以实现类似增加一个内网ip地址的功能：</p>
<pre><code>ifconfig eth0 add 33ffe:3240:800:1005::2/64</code></pre><p>比如说为网卡eth0增加一个IPV6的地址。而这个过程实际上就是调用了devinet内核模块设定好的添加新ip地址方式，并在回调中把该ip地址刷新到内存中。</p>
<p>注意<code>devinet</code>和<code>RTNetLink</code>严格来说不是一个存在同一个模块。虽然都是使用<code>rtnl_register</code>注册方法到rtnl模块中：</p>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/devinet.c" target="_blank" rel="noopener">devinet.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> __net_initdata <span class="token keyword">struct</span> pernet_operations devinet_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>init <span class="token operator">=</span> devinet_init_net<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>exit <span class="token operator">=</span> devinet_exit_net<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> rtnl_af_ops inet_af_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>family          <span class="token operator">=</span> AF_INET<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>fill_link_af      <span class="token operator">=</span> inet_fill_link_af<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_link_af_size <span class="token operator">=</span> inet_get_link_af_size<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>validate_link_af <span class="token operator">=</span> inet_validate_link_af<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>set_link_af      <span class="token operator">=</span> inet_set_link_af<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> __init <span class="token function">devinet_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IN4_ADDR_HSIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">INIT_HLIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inet_addr_lst<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">register_pernet_subsys</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>devinet_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">register_gifconf</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> inet_gifconf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">register_netdevice_notifier</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_netdev_notifier<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">queue_delayed_work</span><span class="token punctuation">(</span>system_power_efficient_wq<span class="token punctuation">,</span> <span class="token operator">&amp;</span>check_lifetime_work<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">rtnl_af_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inet_af_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">rtnl_register</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> RTM_NEWADDR<span class="token punctuation">,</span> inet_rtm_newaddr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rtnl_register</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> RTM_DELADDR<span class="token punctuation">,</span> inet_rtm_deladdr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rtnl_register</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> RTM_GETADDR<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> inet_dump_ifaddr<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rtnl_register</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> RTM_GETNETCONF<span class="token punctuation">,</span> inet_netconf_get_devconf<span class="token punctuation">,</span>
              inet_netconf_dump_devconf<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/route.c" target="_blank" rel="noopener">route.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> __init <span class="token function">ip_rt_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    ip_idents <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>IP_IDENTS_SZ <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ip_idents<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    ipv4_dst_ops<span class="token punctuation">.</span>gc_thresh <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0</span><span class="token punctuation">;</span>
    ip_rt_max_size <span class="token operator">=</span> INT_MAX<span class="token punctuation">;</span>

    <span class="token function">devinet_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ip_fib_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">rtnl_register</span><span class="token punctuation">(</span>PF_INET<span class="token punctuation">,</span> RTM_GETROUTE<span class="token punctuation">,</span> inet_rtm_getroute<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">register_pernet_subsys</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rt_genid_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">register_pernet_subsys</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ipv4_inetpeer_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上整个route模块，是跟着ipv4 内核模块一起初始化好的。能看到其中就根据不同的rtnl操作符号注册了对应不同的方法。</p>
<p>整个DDNS的工作流程大体如下：</p>
<ul>
<li>1.内核空间初始化 rtnetlink 模块，创建 NETLINK_ROUTE 协议簇类型的 netlink 套接字；</li>
<li>2.用户空间创建 NETLINK_ROUTE 协议簇类型的 netlink 套接字，并且绑定到 RTMGRP_IPV4_IFADDR 组播 group 中；</li>
<li>3.用户空间接收从内核空间发来的消息，如果没有消息，则阻塞自身；</li>
<li>4.当主机被分配了新的 IPV4 地址，内核空间通过 netlink_broadcast，将 RTM_NEWADDR 消息发送到 RTNLGRP_IPV4_IFADDR 组播 group 中 ;</li>
<li>5.用户空间接收消息，进行验证、处理；</li>
</ul>
<p>当然，在tcp三次握手执行之前，需要得到当前的源地址，那么就需要通过rtnl进行查询内存中分配的ip。</p>
<h3 id="4-1-ip-route-connect"><a href="#4-1-ip-route-connect" class="headerlink" title="4.1.ip_route_connect"></a>4.1.ip_route_connect</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/route.h" target="_blank" rel="noopener">route.h</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> rtable <span class="token operator">*</span><span class="token function">ip_route_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>fl4<span class="token punctuation">,</span>
                          __be32 dst<span class="token punctuation">,</span> __be32 src<span class="token punctuation">,</span> u32 tos<span class="token punctuation">,</span>
                          <span class="token keyword">int</span> oif<span class="token punctuation">,</span> u8 protocol<span class="token punctuation">,</span>
                          __be16 sport<span class="token punctuation">,</span> __be16 dport<span class="token punctuation">,</span>
                          <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> net <span class="token operator">*</span>net <span class="token operator">=</span> <span class="token function">sock_net</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rtable <span class="token operator">*</span>rt<span class="token punctuation">;</span>

    <span class="token function">ip_route_connect_init</span><span class="token punctuation">(</span>fl4<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> tos<span class="token punctuation">,</span> oif<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span>
                  sport<span class="token punctuation">,</span> dport<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dst <span class="token operator">||</span> <span class="token operator">!</span>src<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rt <span class="token operator">=</span> <span class="token function">__ip_route_output_key</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> fl4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> rt<span class="token punctuation">;</span>
        <span class="token function">ip_rt_put</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">flowi4_update_output</span><span class="token punctuation">(</span>fl4<span class="token punctuation">,</span> oif<span class="token punctuation">,</span> tos<span class="token punctuation">,</span> fl4<span class="token operator">-></span>daddr<span class="token punctuation">,</span> fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">security_sk_classify_flow</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token function">flowi4_to_flowi</span><span class="token punctuation">(</span>fl4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">ip_route_output_flow</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> fl4<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法核心就是<code>__ip_route_output_key</code>.当目的地址或者源地址有其一为空，则会调用<code>__ip_route_output_key</code>填充ip地址。目的地址为空说明可能是在回环链路中通信，如果源地址为空，那个说明可能往目的地址通信需要填充本地被DDNS分配好的内网地址。</p>
<h4 id="4-2-ip-route-connect-init"><a href="#4-2-ip-route-connect-init" class="headerlink" title="4.2.ip_route_connect_init"></a>4.2.ip_route_connect_init</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">ip_route_connect_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>fl4<span class="token punctuation">,</span> __be32 dst<span class="token punctuation">,</span> __be32 src<span class="token punctuation">,</span>
                     u32 tos<span class="token punctuation">,</span> <span class="token keyword">int</span> oif<span class="token punctuation">,</span> u8 protocol<span class="token punctuation">,</span>
                     __be16 sport<span class="token punctuation">,</span> __be16 dport<span class="token punctuation">,</span>
                     <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    __u8 flow_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>transparent<span class="token punctuation">)</span>
        flow_flags <span class="token operator">|</span><span class="token operator">=</span> FLOWI_FLAG_ANYSRC<span class="token punctuation">;</span>

    <span class="token function">flowi4_init_output</span><span class="token punctuation">(</span>fl4<span class="token punctuation">,</span> oif<span class="token punctuation">,</span> sk<span class="token operator">-></span>sk_mark<span class="token punctuation">,</span> tos<span class="token punctuation">,</span> RT_SCOPE_UNIVERSE<span class="token punctuation">,</span>
               protocol<span class="token punctuation">,</span> flow_flags<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> dport<span class="token punctuation">,</span> sport<span class="token punctuation">,</span>
               <span class="token function">sock_i_uid</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个方法中核心还是调用了<code>flowi4_init_output</code>进行flowi4结构体的初始化。</p>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/flow.h" target="_blank" rel="noopener">flow.h</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">flowi4_init_output</span><span class="token punctuation">(</span><span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>fl4<span class="token punctuation">,</span> <span class="token keyword">int</span> oif<span class="token punctuation">,</span>
                      __u32 mark<span class="token punctuation">,</span> __u8 tos<span class="token punctuation">,</span> __u8 scope<span class="token punctuation">,</span>
                      __u8 proto<span class="token punctuation">,</span> __u8 flags<span class="token punctuation">,</span>
                      __be32 daddr<span class="token punctuation">,</span> __be32 saddr<span class="token punctuation">,</span>
                      __be16 dport<span class="token punctuation">,</span> __be16 sport<span class="token punctuation">,</span>
                      kuid_t uid<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    fl4<span class="token operator">-></span>flowi4_oif <span class="token operator">=</span> oif<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_iif <span class="token operator">=</span> LOOPBACK_IFINDEX<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_mark <span class="token operator">=</span> mark<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_tos <span class="token operator">=</span> tos<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_scope <span class="token operator">=</span> scope<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_proto <span class="token operator">=</span> proto<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_flags <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_secid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_uid <span class="token operator">=</span> uid<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>daddr <span class="token operator">=</span> daddr<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> saddr<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>fl4_dport <span class="token operator">=</span> dport<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>fl4_sport <span class="token operator">=</span> sport<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程把数据中的源地址，目的地址，源地址端口和目的地址端口，协议类型等数据给记录下来，之后内网ip地址的查询与更新就会频繁的和这个结构体进行交互。</p>
<p>能看到实际上<code>flowi4</code>是一个用于承载数据的临时结构体，包含了本次路由操作需要的数据。</p>
<h4 id="4-3-ip-route-output-key"><a href="#4-3-ip-route-output-key" class="headerlink" title="4.3.__ip_route_output_key"></a>4.3.__ip_route_output_key</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/*
 * Major route resolver routine.
 */</span>

<span class="token keyword">struct</span> rtable <span class="token operator">*</span><span class="token function">__ip_route_output_key</span><span class="token punctuation">(</span><span class="token keyword">struct</span> net <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>fl4<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> net_device <span class="token operator">*</span>dev_out <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    __u8 tos <span class="token operator">=</span> <span class="token function">RT_FL_TOS</span><span class="token punctuation">(</span>fl4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> fib_result res<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rtable <span class="token operator">*</span>rth<span class="token punctuation">;</span>
    <span class="token keyword">int</span> orig_oif<span class="token punctuation">;</span>

    res<span class="token punctuation">.</span>tclassid    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>fi        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span>table    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    orig_oif <span class="token operator">=</span> fl4<span class="token operator">-></span>flowi4_oif<span class="token punctuation">;</span>

    fl4<span class="token operator">-></span>flowi4_iif <span class="token operator">=</span> LOOPBACK_IFINDEX<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_tos <span class="token operator">=</span> tos <span class="token operator">&amp;</span> IPTOS_RT_MASK<span class="token punctuation">;</span>
    fl4<span class="token operator">-></span>flowi4_scope <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tos <span class="token operator">&amp;</span> RTO_ONLINK<span class="token punctuation">)</span> <span class="token operator">?</span>
             RT_SCOPE_LINK <span class="token punctuation">:</span> RT_SCOPE_UNIVERSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        rth <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ipv4_is_multicast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">ipv4_is_lbcast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">ipv4_is_zeronet</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* I removed check for oif == dev_out->oif here.
           It was wrong for two reasons:
           1. ip_dev_find(net, saddr) can return wrong iface, if saddr
              is assigned to multiple interfaces.
           2. Moreover, we are allowed to send packets with saddr
              of another iface. --ANK
         */</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fl4<span class="token operator">-></span>flowi4_oif <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token function">ipv4_is_multicast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span> <span class="token operator">||</span>
             <span class="token function">ipv4_is_lbcast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* It is equivalent to inet_addr_type(saddr) == RTN_LOCAL */</span>
            dev_out <span class="token operator">=</span> <span class="token function">__ip_dev_find</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> fl4<span class="token operator">-></span>saddr<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_out <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

            fl4<span class="token operator">-></span>flowi4_oif <span class="token operator">=</span> dev_out<span class="token operator">-></span>ifindex<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> make_route<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>flowi4_flags <span class="token operator">&amp;</span> FLOWI_FLAG_ANYSRC<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* It is equivalent to inet_addr_type(saddr) == RTN_LOCAL */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__ip_dev_find</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> fl4<span class="token operator">-></span>saddr<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>fl4<span class="token operator">-></span>flowi4_oif<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dev_out <span class="token operator">=</span> <span class="token function">dev_get_by_index_rcu</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> fl4<span class="token operator">-></span>flowi4_oif<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rth <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENODEV<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dev_out <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* RACE: Check return value of inet_select_addr instead. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>dev_out<span class="token operator">-></span>flags <span class="token operator">&amp;</span> IFF_UP<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">__in_dev_get_rcu</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rth <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENETUNREACH<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ipv4_is_local_multicast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token function">ipv4_is_lbcast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span>
                fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> <span class="token function">inet_select_addr</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                  RT_SCOPE_LINK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> make_route<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ipv4_is_multicast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span><span class="token punctuation">)</span>
                fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> <span class="token function">inet_select_addr</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                  fl4<span class="token operator">-></span>flowi4_scope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span>
                fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> <span class="token function">inet_select_addr</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                  RT_SCOPE_HOST<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fl4<span class="token operator">-></span>daddr <span class="token operator">=</span> fl4<span class="token operator">-></span>saddr<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span>
            fl4<span class="token operator">-></span>daddr <span class="token operator">=</span> fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span>INADDR_LOOPBACK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dev_out <span class="token operator">=</span> net<span class="token operator">-></span>loopback_dev<span class="token punctuation">;</span>
        fl4<span class="token operator">-></span>flowi4_oif <span class="token operator">=</span> LOOPBACK_IFINDEX<span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>type <span class="token operator">=</span> RTN_LOCAL<span class="token punctuation">;</span>
        flags <span class="token operator">|</span><span class="token operator">=</span> RTCF_LOCAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> make_route<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fib_lookup</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> fl4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span>fi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span>table <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fl4<span class="token operator">-></span>flowi4_oif<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>fl4<span class="token operator">-></span>saddr <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> <span class="token function">inet_select_addr</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                                  RT_SCOPE_LINK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            res<span class="token punctuation">.</span>type <span class="token operator">=</span> RTN_UNICAST<span class="token punctuation">;</span>
            <span class="token keyword">goto</span> make_route<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rth <span class="token operator">=</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENETUNREACH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>type <span class="token operator">==</span> RTN_LOCAL<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fl4<span class="token operator">-></span>saddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>fi<span class="token operator">-></span>fib_prefsrc<span class="token punctuation">)</span>
                fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> res<span class="token punctuation">.</span>fi<span class="token operator">-></span>fib_prefsrc<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                fl4<span class="token operator">-></span>saddr <span class="token operator">=</span> fl4<span class="token operator">-></span>daddr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dev_out <span class="token operator">=</span> net<span class="token operator">-></span>loopback_dev<span class="token punctuation">;</span>
        fl4<span class="token operator">-></span>flowi4_oif <span class="token operator">=</span> dev_out<span class="token operator">-></span>ifindex<span class="token punctuation">;</span>
        flags <span class="token operator">|</span><span class="token operator">=</span> RTCF_LOCAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> make_route<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

make_route<span class="token punctuation">:</span>
    rth <span class="token operator">=</span> <span class="token function">__mkroute_output</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> fl4<span class="token punctuation">,</span> orig_oif<span class="token punctuation">,</span> dev_out<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

out<span class="token punctuation">:</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rth<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行的事务如下：</p>
<ul>
<li><p>1.首先校验<code>fl4-&gt;saddr</code>是否存在，存在说明我们设置了源ip地址。如果这个过程中发现没有绑定网卡设备id且这个ip地址是多播或者本地回环，那么就会尝试的调用<code>__ip_dev_find</code>找到源地址所对应的网卡驱动设备对应的ID，并绑定到<code>fl4-&gt;flowi4_oif</code>中，然后进入<code>make_route</code>标签创建路由</p>
</li>
<li><p>2.如果<code>fl4-&gt;flowi4_oif</code>存在，说明已经绑定了设备ID。那么就是尝试的通过<code>inet_select_addr</code>方法更新<code>fl4-&gt;saddr</code>所记录的ip地址</p>
</li>
<li><p>3.<code>fl4-&gt;daddr</code>目的地址为空，说明是本地传给本地，就会强制设置为<code>INADDR_LOOPBACK</code>本地回环地址，也就是本地网卡设备id，然后进入<code>make_route</code>标签创建路由对象</p>
</li>
<li><p>4.<code>fib_lookup</code>查找<code>fl4</code>所对应在路由表中的路由数据(包含下一跳网管，路由ip等)，承载这个结果的是<code>fib_result</code>而这个对象中最为核心是<code>fib_table</code>。如果找到数据，则通过<code>make_route</code>标签构建路由对象</p>
</li>
<li><p>4.如果通过<code>__ip_dev_find</code>查到的结果类型是<code>RTN_LOCAL</code>说明是本地回环网卡，就会将<code>dev_out-&gt;ifindex</code>赋值给<code>fl4-&gt;flowi4_oif</code>。并且flags增加<code>RTCF_LOCAL</code>.</p>
</li>
</ul>
<h3 id="4-4-fib表设计的数据结构以及路由路径压缩原理"><a href="#4-4-fib表设计的数据结构以及路由路径压缩原理" class="headerlink" title="4.4.fib表设计的数据结构以及路由路径压缩原理"></a>4.4.fib表设计的数据结构以及路由路径压缩原理</h3><p>想要弄清楚ip路由表的核心逻辑，必须明白路由表的几个核心的数据结构。当然网上搜索到的和本文很可能大为不同。本文是基于LInux 内核3.1.8.之后的设计几乎都沿用这一套。</p>
<p>而内核将路由表进行大规模的重新设计，很大一部分的原因是网络环境日益庞大且复杂。需要全新的方式进行优化管理系统中的路由表。</p>
<p>下面是fib_table 路由表所涉及的数据结构：</p>
<p><img src="/images/fib%E8%B7%AF%E7%94%B1%E8%A1%A8.png" alt="fib路由表.png"></p>
<p>依次从最外层的结构体介绍：</p>
<ul>
<li><code>net</code> 结构体。该结构体一般保存在socket结构体中负责了网络相关的核心信息与操作</li>
<li><code>netns_ipv4</code>结构体。该结构体象征着在ipv4的协议下，所有路由表配置，路由表，路由表过滤器等相关操作</li>
<li><code>fib_table</code> 路由表</li>
<li><code>trie</code>  路由表字典树</li>
<li><code>leaf</code> trie字典树有两种节点，其中一种就是<code>leaf</code>象征着实际存储的路由数据</li>
<li><code>tnode</code>. trie 字典树中的另一种节点，该节点不包含任何内容，但是指示了真正存储数据的leaf结构体在何处</li>
<li><code>leaf_info</code> 保存在leaf的散列表中，该结构体缓存了相同/近似网段路由</li>
<li><code>fib_ailas</code>相同网段下都有各自的fib_ailas，不同fib_ailas并可以共享fib_info</li>
<li><code>fib_info</code> 每一个路由的具体信息</li>
<li><code>fib_nh</code> 路由的下一跳路由</li>
</ul>
<p>能看到路由表的存储实际上通过字典树的数据结构压缩实现的。但是和常见的字典树有点区别，这种特殊的字典树称为LC-trie 快速路由查找算法。</p>
<p>这一篇文章对于快速路由查找算法的理解写的很不错: <a href="https://blog.csdn.net/dog250/article/details/6596046" target="_blank" rel="noopener">https://blog.csdn.net/dog250/article/details/6596046</a></p>
<h4 id="4-5-字典树-前缀树"><a href="#4-5-字典树-前缀树" class="headerlink" title="4.5.字典树(前缀树)"></a>4.5.字典树(前缀树)</h4><p>首先理解字典树：字典树简单的来说，就是把一串数据化为二进制格式，根据左0，右1的方式构成的。</p>
<p>如图下所示：<br><img src="/images/trie.png" alt="trie.png"></p>
<p>这个过程用图来展示，就是沿着字典树路径不断向下读，比如依次读取abd节点就能得到00这个数字。依次读取abeh就能得到010这个数字。</p>
<p>说到底这种方式只是存储数据的一种方式。而使用数的好处就能很轻易的找到公共前缀，在字典树中找到公共最大子树，也就找到了公共前缀。</p>
<h4 id="LC-trie"><a href="#LC-trie" class="headerlink" title="LC-trie"></a>LC-trie</h4><p>而LC-trie 则是在这之上做了压缩优化处理，想要理解这个算法，必须要明白在<code>tnode</code>中存在两个十分核心的数据：</p>
<ul>
<li>pos</li>
<li>bits</li>
</ul>
<p>这负责什么事情呢？下面就简单说说整个lc-trie的算法就能明白了。</p>
<ul>
<li><p>比较每一次插入的路由项的二进制。比较本次和上一次已经插入的路由项目，找到不一样的二进制位数。找到后就生成一个<code>tnode</code>加入到当前的父<code>tnode</code>中。此时不同的位数决定了tnode中的pos的数值，bits决定的是这个tnode将会有多少的子节点/叶子节点(存储着真正的路由项目)</p>
</li>
<li><p>调整整个路由树的高度。调整的核心手段就是调整bits的大小。bits决定了一个节点能容纳的子节点。一旦bits小了，整个树就会增高。bits大了，整个树高度就会变矮。</p>
</li>
</ul>
<p>当然先来看看方法<code>__ip_dev_find</code>是如何查找</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> net_device <span class="token operator">*</span><span class="token function">__ip_dev_find</span><span class="token punctuation">(</span><span class="token keyword">struct</span> net <span class="token operator">*</span>net<span class="token punctuation">,</span> __be32 addr<span class="token punctuation">,</span> bool devref<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    u32 hash <span class="token operator">=</span> <span class="token function">inet_addr_hash</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> net_device <span class="token operator">*</span>result <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> in_ifaddr <span class="token operator">*</span>ifa<span class="token punctuation">;</span>

    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hlist_for_each_entry_rcu</span><span class="token punctuation">(</span>ifa<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inet_addr_lst<span class="token punctuation">[</span>hash<span class="token punctuation">]</span><span class="token punctuation">,</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ifa<span class="token operator">-></span>ifa_local <span class="token operator">==</span> addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">struct</span> net_device <span class="token operator">*</span>dev <span class="token operator">=</span> ifa<span class="token operator">-></span>ifa_dev<span class="token operator">-></span>dev<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">net_eq</span><span class="token punctuation">(</span><span class="token function">dev_net</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> dev<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> flowi4 fl4 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>daddr <span class="token operator">=</span> addr <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> fib_result res <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> fib_table <span class="token operator">*</span>local<span class="token punctuation">;</span>

        local <span class="token operator">=</span> <span class="token function">fib_get_table</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> RT_TABLE_LOCAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>local <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token function">fib_table_lookup</span><span class="token punctuation">(</span>local<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fl4<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> FIB_LOOKUP_NOREF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
            res<span class="token punctuation">.</span>type <span class="token operator">==</span> RTN_LOCAL<span class="token punctuation">)</span>
            result <span class="token operator">=</span> <span class="token function">FIB_RES_DEV</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">&amp;&amp;</span> devref<span class="token punctuation">)</span>
        <span class="token function">dev_hold</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>__ip_dev_find<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>首先先从<code>inet_addr_lst</code>查找是否存在缓存好的路由所对应的设备驱动id。这个缓存是每一次通过类似ipconfig的命令添加动态进来的</li>
<li>如果找不到，说明没有访问过这个ip地址，接下来就会尝试的从磁盘等缓存获取ip地址相关的数据，核心方法就是<code>fib_table_lookup</code>。</li>
</ul>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/fib_trie.c" target="_blank" rel="noopener">fib_trie.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">fib_table_lookup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> fib_table <span class="token operator">*</span>tb<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>flp<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> fib_result <span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token keyword">int</span> fib_flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> trie <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> trie <span class="token operator">*</span><span class="token punctuation">)</span> tb<span class="token operator">-></span>tb_data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rt_trie_node <span class="token operator">*</span>n<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> tnode <span class="token operator">*</span>pn<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> pos<span class="token punctuation">,</span> bits<span class="token punctuation">;</span>
    t_key key <span class="token operator">=</span> <span class="token function">ntohl</span><span class="token punctuation">(</span>flp<span class="token operator">-></span>daddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> chopped_off<span class="token punctuation">;</span>
    t_key cindex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> current_prefix_length <span class="token operator">=</span> KEYLENGTH<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> tnode <span class="token operator">*</span>cn<span class="token punctuation">;</span>
    t_key pref_mismatch<span class="token punctuation">;</span>

    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    n <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span>t<span class="token operator">-></span>trie<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>n<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> failed<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_IP_FIB_TRIE_STATS</span>
    t<span class="token operator">-></span>stats<span class="token punctuation">.</span>gets<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment" spellcheck="true">/* Just a leaf? */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_LEAF</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ret <span class="token operator">=</span> <span class="token function">check_leaf</span><span class="token punctuation">(</span>tb<span class="token punctuation">,</span> t<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> leaf <span class="token operator">*</span><span class="token punctuation">)</span>n<span class="token punctuation">,</span> key<span class="token punctuation">,</span> flp<span class="token punctuation">,</span> res<span class="token punctuation">,</span> fib_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> found<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    pn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> tnode <span class="token operator">*</span><span class="token punctuation">)</span> n<span class="token punctuation">;</span>
    chopped_off <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>pn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        pos <span class="token operator">=</span> pn<span class="token operator">-></span>pos<span class="token punctuation">;</span>
        bits <span class="token operator">=</span> pn<span class="token operator">-></span>bits<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chopped_off<span class="token punctuation">)</span>
            cindex <span class="token operator">=</span> <span class="token function">tkey_extract_bits</span><span class="token punctuation">(</span><span class="token function">mask_pfx</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> current_prefix_length<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           pos<span class="token punctuation">,</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

        n <span class="token operator">=</span> <span class="token function">tnode_get_child_rcu</span><span class="token punctuation">(</span>pn<span class="token punctuation">,</span> cindex<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
failed<span class="token punctuation">:</span>
    ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
found<span class="token punctuation">:</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>fib_table_lookup<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个方法就是通过<code>tkey_extract_bits</code>生成tnode中对应的叶子节点所在index，从而通过<code>tnode_get_child_rcu</code>拿到tnode节点中index所对应的数组中获取叶下一级别的tnode或者叶子结点。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> rt_trie_node <span class="token operator">*</span><span class="token function">tnode_get_child_rcu</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> tnode <span class="token operator">*</span>tn<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">BUG_ON</span><span class="token punctuation">(</span>i <span class="token operator">>=</span> <span class="token number">1U</span> <span class="token operator">&lt;&lt;</span> tn<span class="token operator">-></span>bits<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">rcu_dereference_rtnl</span><span class="token punctuation">(</span>tn<span class="token operator">-></span>child<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> KEYLENGTH (8*sizeof(t_key))</span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> t_key<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">inline</span> t_key <span class="token function">tkey_extract_bits</span><span class="token punctuation">(</span>t_key a<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> bits<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>offset <span class="token operator">&lt;</span> KEYLENGTH<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t_key<span class="token punctuation">)</span><span class="token punctuation">(</span>a <span class="token operator">&lt;&lt;</span> offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">>></span> <span class="token punctuation">(</span>KEYLENGTH <span class="token operator">-</span> bits<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其中查找index最为核心方法如上，这个过程，先通过key左移动pos个位，再向右边移动（32 - bits）算法找到对应index。</p>
<p>在这里能对路由压缩算法有一定的理解即可，本文重点不在这里。当从路由树中找到了结果就返回<code>fib_result</code>结构体。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> fib_result <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    prefixlen<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    nh_sel<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    type<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span>    scope<span class="token punctuation">;</span>
    u32        tclassid<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> fib_info <span class="token operator">*</span>fi<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> fib_table <span class="token operator">*</span>table<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head <span class="token operator">*</span>fa_head<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>查询的结果最为核心的就是<code>fib_table</code>路由表，存储了真正的路由转发信息</p>
<h4 id="4-6-mkroute-output"><a href="#4-6-mkroute-output" class="headerlink" title="4.6.__mkroute_output"></a>4.6.__mkroute_output</h4><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/route.c" target="_blank" rel="noopener">route.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* called with rcu_read_lock() */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> rtable <span class="token operator">*</span><span class="token function">__mkroute_output</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> fib_result <span class="token operator">*</span>res<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> <span class="token keyword">struct</span> flowi4 <span class="token operator">*</span>fl4<span class="token punctuation">,</span> <span class="token keyword">int</span> orig_oif<span class="token punctuation">,</span>
                       <span class="token keyword">struct</span> net_device <span class="token operator">*</span>dev_out<span class="token punctuation">,</span>
                       <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> fib_info <span class="token operator">*</span>fi <span class="token operator">=</span> res<span class="token operator">-></span>fi<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> fib_nh_exception <span class="token operator">*</span>fnhe<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> in_device <span class="token operator">*</span>in_dev<span class="token punctuation">;</span>
    u16 type <span class="token operator">=</span> res<span class="token operator">-></span>type<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> rtable <span class="token operator">*</span>rth<span class="token punctuation">;</span>
    bool do_cache<span class="token punctuation">;</span>

    in_dev <span class="token operator">=</span> <span class="token function">__in_dev_get_rcu</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    do_cache <span class="token operator">=</span> true<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> RTN_BROADCAST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flags <span class="token operator">|</span><span class="token operator">=</span> RTCF_BROADCAST <span class="token operator">|</span> RTCF_LOCAL<span class="token punctuation">;</span>
        fi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> RTN_MULTICAST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        flags <span class="token operator">|</span><span class="token operator">=</span> RTCF_MULTICAST <span class="token operator">|</span> RTCF_LOCAL<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ip_check_mc_rcu</span><span class="token punctuation">(</span>in_dev<span class="token punctuation">,</span> fl4<span class="token operator">-></span>daddr<span class="token punctuation">,</span> fl4<span class="token operator">-></span>saddr<span class="token punctuation">,</span>
                     fl4<span class="token operator">-></span>flowi4_proto<span class="token punctuation">)</span><span class="token punctuation">)</span>
            flags <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>RTCF_LOCAL<span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            do_cache <span class="token operator">=</span> false<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fi <span class="token operator">&amp;&amp;</span> res<span class="token operator">-></span>prefixlen <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span>
            fi <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    fnhe <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    do_cache <span class="token operator">&amp;</span><span class="token operator">=</span> fi <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>do_cache<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> rtable __rcu <span class="token operator">*</span><span class="token operator">*</span>prth<span class="token punctuation">;</span>
        <span class="token keyword">struct</span> fib_nh <span class="token operator">*</span>nh <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">FIB_RES_NH</span><span class="token punctuation">(</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        fnhe <span class="token operator">=</span> <span class="token function">find_exception</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fnhe<span class="token punctuation">)</span>
            prth <span class="token operator">=</span> <span class="token operator">&amp;</span>fnhe<span class="token operator">-></span>fnhe_rth_output<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>flowi4_flags <span class="token operator">&amp;</span>
                     FLOWI_FLAG_KNOWN_NH <span class="token operator">&amp;&amp;</span>
                     <span class="token operator">!</span><span class="token punctuation">(</span>nh<span class="token operator">-></span>nh_gw <span class="token operator">&amp;&amp;</span>
                       nh<span class="token operator">-></span>nh_scope <span class="token operator">==</span> RT_SCOPE_LINK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                do_cache <span class="token operator">=</span> false<span class="token punctuation">;</span>
                <span class="token keyword">goto</span> add<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            prth <span class="token operator">=</span> <span class="token function">raw_cpu_ptr</span><span class="token punctuation">(</span>nh<span class="token operator">-></span>nh_pcpu_rth_output<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        rth <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span><span class="token operator">*</span>prth<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rt_cache_valid</span><span class="token punctuation">(</span>rth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">dst_hold</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rth<span class="token operator">-></span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> rth<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

add<span class="token punctuation">:</span>
    rth <span class="token operator">=</span> <span class="token function">rt_dst_alloc</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">,</span>
               <span class="token function">IN_DEV_CONF_GET</span><span class="token punctuation">(</span>in_dev<span class="token punctuation">,</span> NOPOLICY<span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token function">IN_DEV_CONF_GET</span><span class="token punctuation">(</span>in_dev<span class="token punctuation">,</span> NOXFRM<span class="token punctuation">)</span><span class="token punctuation">,</span>
               do_cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rth<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOBUFS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    rth<span class="token operator">-></span>dst<span class="token punctuation">.</span>output <span class="token operator">=</span> ip_output<span class="token punctuation">;</span>

    rth<span class="token operator">-></span>rt_genid <span class="token operator">=</span> <span class="token function">rt_genid_ipv4</span><span class="token punctuation">(</span><span class="token function">dev_net</span><span class="token punctuation">(</span>dev_out<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_flags    <span class="token operator">=</span> flags<span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_type    <span class="token operator">=</span> type<span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_is_input <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_iif    <span class="token operator">=</span> orig_oif <span class="token operator">?</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_pmtu    <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_gateway <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    rth<span class="token operator">-></span>rt_uses_gateway <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rth<span class="token operator">-></span>rt_uncached<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RT_CACHE_STAT_INC</span><span class="token punctuation">(</span>out_slow_tot<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> RTCF_LOCAL<span class="token punctuation">)</span>
        rth<span class="token operator">-></span>dst<span class="token punctuation">.</span>input <span class="token operator">=</span> ip_local_deliver<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RTCF_BROADCAST <span class="token operator">|</span> RTCF_MULTICAST<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> RTCF_LOCAL <span class="token operator">&amp;&amp;</span>
            <span class="token operator">!</span><span class="token punctuation">(</span>dev_out<span class="token operator">-></span>flags <span class="token operator">&amp;</span> IFF_LOOPBACK<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rth<span class="token operator">-></span>dst<span class="token punctuation">.</span>output <span class="token operator">=</span> ip_mc_output<span class="token punctuation">;</span>
            <span class="token function">RT_CACHE_STAT_INC</span><span class="token punctuation">(</span>out_slow_mc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_IP_MROUTE</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> RTN_MULTICAST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IN_DEV_MFORWARD</span><span class="token punctuation">(</span>in_dev<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span><span class="token function">ipv4_is_local_multicast</span><span class="token punctuation">(</span>fl4<span class="token operator">-></span>daddr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                rth<span class="token operator">-></span>dst<span class="token punctuation">.</span>input <span class="token operator">=</span> ip_mr_input<span class="token punctuation">;</span>
                rth<span class="token operator">-></span>dst<span class="token punctuation">.</span>output <span class="token operator">=</span> ip_mc_output<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

    <span class="token function">rt_set_nexthop</span><span class="token punctuation">(</span>rth<span class="token punctuation">,</span> fl4<span class="token operator">-></span>daddr<span class="token punctuation">,</span> res<span class="token punctuation">,</span> fnhe<span class="token punctuation">,</span> fi<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rth<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法做的事情很简单，本质上就是想要找到这个路由的下一跳是哪里？</p>
<ul>
<li><p>1.do_cache 首先设置为true，这样就是默认使用缓存的路由。</p>
</li>
<li><p>2。如果此时是多播，并通过<code>ip_check_mc_rcu</code>校验了多播相关的列表中，有目的地址相关的缓存，则do_cache 为false，不从<code>fib_nh</code>的<code>nh_pcpu_rth_output</code>查找缓存中已经缓存的rtable。</p>
</li>
<li><p>3.其他情况下，都默认会从<code>fib_nh</code>的<code>nh_pcpu_rth_output</code>查找缓存中已经缓存的rtable。如果这个过程，如果<code>rt_cache_valid</code>校验到该缓存的<code>rtable</code>所对应的网络设备号一致则有效，有效则返回。无效则进入到<code>add</code>标签中创建一个全新的<code>rtable</code>结构体。</p>
</li>
<li><p>4.rt_dst_alloc 创建一个全新的<code>rtable</code> 结构体。其中并设置好当前的协议类型，是否是输入型路由，rt_genid 生成唯一id等等。注意，这里需要额外注意设置在dst_entry的方法指针：<code>ip_output</code>.这个方法将会从数据链路arp协议传递上ip层的入口。也是<code>netfilter</code>的入口。</p>
</li>
<li><p>5.rt_set_nexthop 将会为<code>rtable</code> 设置和寻找下一跳的信息。一般来说，在一个局域网中，Linux服务器下一跳往往是指向网关。 设置好网关后返回<code>rtable</code></p>
</li>
</ul>
<p>####4.7. rt_set_nexthop</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">rt_set_nexthop</span><span class="token punctuation">(</span><span class="token keyword">struct</span> rtable <span class="token operator">*</span>rt<span class="token punctuation">,</span> __be32 daddr<span class="token punctuation">,</span>
               <span class="token keyword">const</span> <span class="token keyword">struct</span> fib_result <span class="token operator">*</span>res<span class="token punctuation">,</span>
               <span class="token keyword">struct</span> fib_nh_exception <span class="token operator">*</span>fnhe<span class="token punctuation">,</span>
               <span class="token keyword">struct</span> fib_info <span class="token operator">*</span>fi<span class="token punctuation">,</span> u16 type<span class="token punctuation">,</span> u32 itag<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    bool cached <span class="token operator">=</span> false<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fi<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">struct</span> fib_nh <span class="token operator">*</span>nh <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">FIB_RES_NH</span><span class="token punctuation">(</span><span class="token operator">*</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>nh<span class="token operator">-></span>nh_gw <span class="token operator">&amp;&amp;</span> nh<span class="token operator">-></span>nh_scope <span class="token operator">==</span> RT_SCOPE_LINK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rt<span class="token operator">-></span>rt_gateway <span class="token operator">=</span> nh<span class="token operator">-></span>nh_gw<span class="token punctuation">;</span>
            rt<span class="token operator">-></span>rt_uses_gateway <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">dst_init_metrics</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rt<span class="token operator">-></span>dst<span class="token punctuation">,</span> fi<span class="token operator">-></span>fib_metrics<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_IP_ROUTE_CLASSID</span>
        rt<span class="token operator">-></span>dst<span class="token punctuation">.</span>tclassid <span class="token operator">=</span> nh<span class="token operator">-></span>nh_tclassid<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>fnhe<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cached <span class="token operator">=</span> <span class="token function">rt_bind_exception</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> fnhe<span class="token punctuation">,</span> daddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>rt<span class="token operator">-></span>dst<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> DST_NOCACHE<span class="token punctuation">)</span><span class="token punctuation">)</span>
            cached <span class="token operator">=</span> <span class="token function">rt_cache_route</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span> rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token operator">!</span>cached<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            rt<span class="token operator">-></span>dst<span class="token punctuation">.</span>flags <span class="token operator">|</span><span class="token operator">=</span> DST_NOCACHE<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rt<span class="token operator">-></span>rt_gateway<span class="token punctuation">)</span>
                rt<span class="token operator">-></span>rt_gateway <span class="token operator">=</span> daddr<span class="token punctuation">;</span>
            <span class="token function">rt_add_uncached_list</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        <span class="token function">rt_add_uncached_list</span><span class="token punctuation">(</span>rt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_IP_ROUTE_CLASSID</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_IP_MULTIPLE_TABLES</span>
    <span class="token function">set_class_tag</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> res<span class="token operator">-></span>tclassid<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
    <span class="token function">set_class_tag</span><span class="token punctuation">(</span>rt<span class="token punctuation">,</span> itag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里面有一个核心的结构体名为<code>fib_nh_exception</code>。这个是指fib表中去往目的地址情况下最理想的下一跳的地址。</p>
<p>而这个结构体在上一个方法通过<code>find_exception</code>获得.遍历从<code>fib_result</code>获取到<code>fib_nh</code>结构体中的<code>nh_exceptions</code>链表。从这链表中找到一模一样的目的地址并返回得到的。</p>
<ul>
<li><p>如果<code>fib_nh_exception</code>的不为空，那么就会执行<code>rt_bind_exception</code>方法，将fnhe和<code>rtable</code>绑定起来.注意<code>unlikely</code>说明大部分情况下都很难走到这分支。</p>
</li>
<li><p>如果<code>rtable</code>的<code>dst.flags</code>关闭了<code>DST_NOCACHE</code> 标志位。就会调用<code>rt_cache_route</code>。到了这里一般是没有找到下一跳地址，这个过程会通过<code>rt_cache_route</code>这个方法，将rtable 缓存到<code>nh-&gt;nh_rth_input</code>或者<code>nh-&gt;nh_pcpu_rth_output</code>.</p>
</li>
<li><p>如果不能缓存，且没有设置网关，则把目的地址设置到网关，并加入到不可达队列中</p>
</li>
<li><p>当然，无法从fib转发表中找到fib_info，也是加入到不可达队列中。</p>
</li>
</ul>
<h3 id="5-tcp-connect-开始进行三次握手"><a href="#5-tcp-connect-开始进行三次握手" class="headerlink" title="5. tcp_connect 开始进行三次握手"></a>5. tcp_connect 开始进行三次握手</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/tcp_output.c" target="_blank" rel="noopener">tcp_output.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token comment" spellcheck="true">/* Build a SYN and send it off. */</span>
<span class="token keyword">int</span> <span class="token function">tcp_connect</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> tcp_sock <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sk_buff <span class="token operator">*</span>buff<span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>

    <span class="token function">tcp_connect_init</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>tp<span class="token operator">-></span>repair<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">tcp_finish_connect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    buff <span class="token operator">=</span> <span class="token function">alloc_skb_fclone</span><span class="token punctuation">(</span>MAX_TCP_HEADER <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">,</span> sk<span class="token operator">-></span>sk_allocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>buff <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOBUFS<span class="token punctuation">;</span>

    <span class="token function">skb_reserve</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> MAX_TCP_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">tcp_init_nondata_skb</span><span class="token punctuation">(</span>buff<span class="token punctuation">,</span> tp<span class="token operator">-></span>write_seq<span class="token operator">++</span><span class="token punctuation">,</span> TCPHDR_SYN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tp<span class="token operator">-></span>retrans_stamp <span class="token operator">=</span> tcp_time_stamp<span class="token punctuation">;</span>
    <span class="token function">tcp_connect_queue_skb</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tcp_ecn_send_syn</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> buff<span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> tp<span class="token operator">-></span>fastopen_req <span class="token operator">?</span> <span class="token function">tcp_send_syn_data</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> buff<span class="token punctuation">)</span> <span class="token punctuation">:</span>
          <span class="token function">tcp_transmit_skb</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> sk<span class="token operator">-></span>sk_allocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> <span class="token operator">-</span>ECONNREFUSED<span class="token punctuation">)</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>

    tp<span class="token operator">-></span>snd_nxt <span class="token operator">=</span> tp<span class="token operator">-></span>write_seq<span class="token punctuation">;</span>
    tp<span class="token operator">-></span>pushed_seq <span class="token operator">=</span> tp<span class="token operator">-></span>write_seq<span class="token punctuation">;</span>
    <span class="token function">TCP_INC_STATS</span><span class="token punctuation">(</span><span class="token function">sock_net</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">,</span> TCP_MIB_ACTIVEOPENS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Timer for repeating the SYN until an answer. */</span>
    <span class="token function">inet_csk_reset_xmit_timer</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> ICSK_TIME_RETRANS<span class="token punctuation">,</span>
                  <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>icsk_rto<span class="token punctuation">,</span> TCP_RTO_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>tcp_connect<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>tcp_connect_init 初始化sock转化成<code>tcp_sock</code>结构体，并初始化需要发送tcp 协议包所需要的数据</p>
</li>
<li><p><code>alloc_skb_fclone</code> 申请内存给<code>sk_buff</code>，这个对象<code>sk_buff</code>就是用于承载tcp发送的网络数据包真正的实体。</p>
</li>
<li><p><code>skb_reserve</code> 为<code>sk_buff</code>设置最大头部信息长度.这个长度大小如下：</p>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">if</span> defined(CONFIG_WLAN) || IS_ENABLED(CONFIG_AX25)</span>
<span class="token macro property"># <span class="token directive keyword">if</span> defined(CONFIG_MAC80211_MESH)</span>
<span class="token macro property">#  <span class="token directive keyword">define</span> LL_MAX_HEADER 128</span>
<span class="token macro property"># <span class="token directive keyword">else</span></span>
<span class="token macro property">#  <span class="token directive keyword">define</span> LL_MAX_HEADER 96</span>
<span class="token macro property"># <span class="token directive keyword">endif</span></span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property"># <span class="token directive keyword">define</span> LL_MAX_HEADER 32</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">if</span> !IS_ENABLED(CONFIG_NET_IPIP) &amp;&amp; !IS_ENABLED(CONFIG_NET_IPGRE) &amp;&amp; \
    !IS_ENABLED(CONFIG_IPV6_SIT) &amp;&amp; !IS_ENABLED(CONFIG_IPV6_TUNNEL)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_HEADER LL_MAX_HEADER</span>
<span class="token macro property">#<span class="token directive keyword">else</span></span>
<span class="token macro property">#<span class="token directive keyword">define</span> MAX_HEADER (LL_MAX_HEADER + 48)</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> MAX_TCP_HEADER    (128 + MAX_HEADER)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果是ipv4 且没有打开<code>CONFIG_WLAN</code>，<code>CONFIG_AX25</code>。此时给sk_buff的头部长度限制为<code>160</code>字节</p>
<ul>
<li><p><code>tcp_init_nondata_skb</code>初始化发送<code>SYN</code>信号所需要的数据填充到<code>sk_buff</code>中。在这个过程中过去tcp_sock所记录的序列号<code>write_seq</code>加一填充再数据缓冲区。</p>
</li>
<li><p><code>tcp_connect_queue_skb</code> 将当前的<code>sk_buff</code>插入到sock结构体的<code>sk_write_queue</code>。</p>
</li>
<li><p><code>tcp_transmit_skb</code>将SYN 信号包发送出去。这里关于<code>tcp_transmit_skb</code>发送SYN数据包流程就不多说，放到之后的sock发送数据包流程聊。</p>
</li>
<li><p><code>inet_csk_reset_xmit_timer</code> 设置一个定时器不断的保持活跃当前链接，直到接受到了SYN的应答信号。</p>
</li>
</ul>
<p>这里指的注意的是<code>inet_csk_reset_xmit_timer</code>方法。</p>
<h3 id="6-inet-csk-reset-xmit-timer"><a href="#6-inet-csk-reset-xmit-timer" class="headerlink" title="6.inet_csk_reset_xmit_timer"></a>6.inet_csk_reset_xmit_timer</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">inet_csk_reset_xmit_timer</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> what<span class="token punctuation">,</span>
                         <span class="token keyword">unsigned</span> <span class="token keyword">long</span> when<span class="token punctuation">,</span>
                         <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> max_when<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inet_connection_sock <span class="token operator">*</span>icsk <span class="token operator">=</span> <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>when <span class="token operator">></span> max_when<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        when <span class="token operator">=</span> max_when<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>what <span class="token operator">==</span> ICSK_TIME_RETRANS <span class="token operator">||</span> what <span class="token operator">==</span> ICSK_TIME_PROBE0 <span class="token operator">||</span>
        what <span class="token operator">==</span> ICSK_TIME_EARLY_RETRANS <span class="token operator">||</span> what <span class="token operator">==</span>  ICSK_TIME_LOSS_PROBE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        icsk<span class="token operator">-></span>icsk_pending <span class="token operator">=</span> what<span class="token punctuation">;</span>
        icsk<span class="token operator">-></span>icsk_timeout <span class="token operator">=</span> jiffies <span class="token operator">+</span> when<span class="token punctuation">;</span>
        <span class="token function">sk_reset_timer</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>icsk<span class="token operator">-></span>icsk_retransmit_timer<span class="token punctuation">,</span> icsk<span class="token operator">-></span>icsk_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>what <span class="token operator">==</span> ICSK_TIME_DACK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> INET_CSK_DEBUG</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>将<code>sock</code>结构体转化为<code>inet_connection_sock</code>.此时设置的定时起类型为<code>ICSK_TIME_RETRANS</code>。因此会调用<code>sk_reset_timer</code>。将<code>inet_connection_sock</code>的<code>icsk_retransmit_timer</code>设置给sock的时间重试队列中。</p>
<p>其中超时时间已经在<code>tcp_connect_init</code>设置在<code>inet_connection_sock-&gt;icsk_rto</code>中</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> TCP_TIMEOUT_INIT ((unsigned)(1*HZ))</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也就是当前时间往后 100个中断，在Linux 2.6中就是100ms.</p>
<p>其中<code>icsk_retransmit_timer</code>方法指向就是<code>tcp_keepalive_timer</code>。</p>
<ul>
<li><p>这个方法如果发现了tcp的状态已经处于了<code>TCP_LISTEN</code>,自己进程自己通信自己，或者已经是<code>TCP_CLOSE</code>不执行任何内容。</p>
</li>
<li><p>如果处于<code>TCP_FIN_WAIT2</code>,且sock已经<code>SOCK_DEAD</code>状态了，则销毁当前的sock结构体。</p>
</li>
</ul>
<h3 id="7-服务端接受到SYN回应接受-SYN-ACK-信息"><a href="#7-服务端接受到SYN回应接受-SYN-ACK-信息" class="headerlink" title="7.服务端接受到SYN回应接受 SYN_ACK 信息"></a>7.服务端接受到SYN回应接受 SYN_ACK 信息</h3><p>而从下层传递到应用层的tcp协议进行处理，会调用到<code>tcp_v4_do_rcv</code>方法。</p>
<p><code>tcp_v4_do_rcv</code>方法最终调用到 <code>tcp_rcv_state_process</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">tcp_rcv_state_process</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> sk_buff <span class="token operator">*</span>skb<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">struct</span> tcphdr <span class="token operator">*</span>th<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> tcp_sock <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> inet_connection_sock <span class="token operator">*</span>icsk <span class="token operator">=</span> <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> TCP_CLOSE<span class="token punctuation">:</span>
        <span class="token keyword">goto</span> discard<span class="token punctuation">;</span>

    <span class="token keyword">case</span> TCP_LISTEN<span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>th<span class="token operator">-></span>ack<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>th<span class="token operator">-></span>rst<span class="token punctuation">)</span>
            <span class="token keyword">goto</span> discard<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>th<span class="token operator">-></span>syn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>th<span class="token operator">-></span>fin<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> discard<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>icsk<span class="token operator">-></span>icsk_af_ops<span class="token operator">-></span><span class="token function">conn_request</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">kfree_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">goto</span> discard<span class="token punctuation">;</span>

    <span class="token keyword">case</span> TCP_SYN_SENT<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>tcp_rcv_state_process<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时的服务器应该是调用玩accpet和listen的方法，进入到了<code>TCP_LISTEN</code> 状态。</p>
<p>因此就会在这个方法中进入到<code>tcp_rcv_state_process</code>的<code>TCP_LISTEN</code>的分支.核心就是<code>icsk-&gt;icsk_af_ops-&gt;conn_request</code>.</p>
<p>而核心的方法是通过该结构体注入：</p>
<pre><code>const struct inet_connection_sock_af_ops ipv4_specific = {
    .queue_xmit       = ip_queue_xmit,
    .send_check       = tcp_v4_send_check,
    .rebuild_header       = inet_sk_rebuild_header,
    .sk_rx_dst_set       = inet_sk_rx_dst_set,
    .conn_request       = tcp_v4_conn_request,
    .syn_recv_sock       = tcp_v4_syn_recv_sock,
    .net_header_len       = sizeof(struct iphdr),
    .setsockopt       = ip_setsockopt,
    .getsockopt       = ip_getsockopt,
    .addr2sockaddr       = inet_csk_addr2sockaddr,
    .sockaddr_len       = sizeof(struct sockaddr_in),
    .bind_conflict       = inet_csk_bind_conflict,
#ifdef CONFIG_COMPAT
    .compat_setsockopt = compat_ip_setsockopt,
    .compat_getsockopt = compat_ip_getsockopt,
#endif
    .mtu_reduced       = tcp_v4_mtu_reduced,
};</code></pre><p>也就是<code>tcp_v4_conn_request</code>方法。 当执行完该方法后，就会在<code>tcp_rcv_state_process</code>通过<code>tcp_check_req</code>方法将状态设置为<code>TCP_SYN_RECV</code>.</p>
<h4 id="7-1-tcp-v4-conn-request"><a href="#7-1-tcp-v4-conn-request" class="headerlink" title="7.1.tcp_v4_conn_request"></a>7.1.tcp_v4_conn_request</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">tcp_v4_conn_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> sk_buff <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* Never answer to SYNs send to broadcast or multicast */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skb_rtable</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token operator">-></span>rt_flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>RTCF_BROADCAST <span class="token operator">|</span> RTCF_MULTICAST<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> drop<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">tcp_conn_request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcp_request_sock_ops<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>tcp_request_sock_ipv4_ops<span class="token punctuation">,</span> sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span>

drop<span class="token punctuation">:</span>
    <span class="token function">NET_INC_STATS_BH</span><span class="token punctuation">(</span><span class="token function">sock_net</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">,</span> LINUX_MIB_LISTENDROPS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>tcp_v4_conn_request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件： /<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/tcp_input.c" target="_blank" rel="noopener">tcp_input.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">tcp_conn_request</span><span class="token punctuation">(</span><span class="token keyword">struct</span> request_sock_ops <span class="token operator">*</span>rsk_ops<span class="token punctuation">,</span>
             <span class="token keyword">const</span> <span class="token keyword">struct</span> tcp_request_sock_ops <span class="token operator">*</span>af_ops<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> sk_buff <span class="token operator">*</span>skb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> tcp_options_received tmp_opt<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> request_sock <span class="token operator">*</span>req<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> tcp_sock <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> dst_entry <span class="token operator">*</span>dst <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    __u32 isn <span class="token operator">=</span> <span class="token function">TCP_SKB_CB</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token operator">-></span>tcp_tw_isn<span class="token punctuation">;</span>
    bool want_cookie <span class="token operator">=</span> false<span class="token punctuation">,</span> fastopen<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> flowi fl<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> tcp_fastopen_cookie foc <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">tcp_openreq_init</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tmp_opt<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    err <span class="token operator">=</span> af_ops<span class="token operator">-></span><span class="token function">send_synack</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> dst<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fl<span class="token punctuation">,</span> req<span class="token punctuation">,</span>
                  <span class="token function">skb_get_queue_mapping</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>foc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>tcp_conn_request<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.<code>tcp_openreq_init</code>先读取从客户端发送来的<code>sk_buff</code>socket数据缓冲区的内容。并<code>request_sock</code> 中的<code>rcv_nxt</code> 设置为客户端的序列号+1.也就是我们常说的读取SYN_ACK数据，并把客户端提供的 seq+1.</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">tcp_openreq_init</span><span class="token punctuation">(</span><span class="token keyword">struct</span> request_sock <span class="token operator">*</span>req<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> tcp_options_received <span class="token operator">*</span>rx_opt<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> sk_buff <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inet_request_sock <span class="token operator">*</span>ireq <span class="token operator">=</span> <span class="token function">inet_rsk</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

    req<span class="token operator">-></span>rcv_wnd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/* So that tcp_send_synack() knows! */</span>
    req<span class="token operator">-></span>cookie_ts <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">tcp_rsk</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token operator">-></span>rcv_isn <span class="token operator">=</span> <span class="token function">TCP_SKB_CB</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token operator">-></span>seq<span class="token punctuation">;</span>
    <span class="token function">tcp_rsk</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token operator">-></span>rcv_nxt <span class="token operator">=</span> <span class="token function">TCP_SKB_CB</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token operator">-></span>seq <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">tcp_rsk</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token operator">-></span>snt_synack <span class="token operator">=</span> tcp_time_stamp<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法将会调用<code>send_synack</code> 发送SYN-ACK 信号。而这个方法最终就是指向了<code>tcp_v4_send_synack</code>方法。</p>
<p>而这个方法最终还是会调用<code>tcp_make_synack</code>构建SYN_ACK数据包， 并通过ip_output方法发送出去。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> sk_buff <span class="token operator">*</span><span class="token function">tcp_make_synack</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> dst_entry <span class="token operator">*</span>dst<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> request_sock <span class="token operator">*</span>req<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> tcp_fastopen_cookie <span class="token operator">*</span>foc<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> tcphdr <span class="token operator">*</span>th<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    th<span class="token operator">-></span>syn <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    th<span class="token operator">-></span>ack <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token function">tcp_init_nondata_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token function">tcp_rsk</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token operator">-></span>snt_isn<span class="token punctuation">,</span>
                 TCPHDR_SYN <span class="token operator">|</span> TCPHDR_ACK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    th<span class="token operator">-></span>seq <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token function">TCP_SKB_CB</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token operator">-></span>seq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    th<span class="token operator">-></span>ack_seq <span class="token operator">=</span> <span class="token function">htonl</span><span class="token punctuation">(</span><span class="token function">tcp_rsk</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token operator">-></span>rcv_nxt<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> skb<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是构建一个<code>sk_buff</code> socket数据缓冲区。<code>tcphdr</code>代表即将发送出去tcp封装数据包的协议头。这里会读取客户端发送的数据缓冲区，但是会修改tcp头部信息。</p>
<p>这里tcp的头部设置好标志位:把tcp封装的头部标志syn和ack 都设置为1. 并把seq设置为服务端的skb的序列号。同时设置<code>ack_seq</code>为再上面设置好的<code>rcv_nxt</code>，也就是客户端的序列号+1.</p>
<h3 id="8-客户端接受到了来自服务端SYN-ACK信号后返回ACK的应答信号"><a href="#8-客户端接受到了来自服务端SYN-ACK信号后返回ACK的应答信号" class="headerlink" title="8.客户端接受到了来自服务端SYN-ACK信号后返回ACK的应答信号"></a>8.客户端接受到了来自服务端SYN-ACK信号后返回ACK的应答信号</h3><p>还是<code>tcp_rcv_state_process</code> 方法处理来自服务端发送ACK信号。此时，客户端发送玩SYN信号，此时进入到了<code>TCP_SYN_SENT</code>状态。直接看<code>TCP_SYN_SENT</code>分支</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">case</span> TCP_SYN_SENT<span class="token punctuation">:</span>
        queued <span class="token operator">=</span> <span class="token function">tcp_rcv_synsent_state_process</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> th<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>queued <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> queued<span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">/* Do step6 onward by hand. */</span>
        <span class="token function">tcp_urg</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> th<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__kfree_skb</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">tcp_data_snd_check</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="8-1-tcp-rcv-synsent-state-process"><a href="#8-1-tcp-rcv-synsent-state-process" class="headerlink" title="8.1.tcp_rcv_synsent_state_process"></a>8.1.tcp_rcv_synsent_state_process</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">tcp_rcv_synsent_state_process</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">,</span> <span class="token keyword">struct</span> sk_buff <span class="token operator">*</span>skb<span class="token punctuation">,</span>
                     <span class="token keyword">const</span> <span class="token keyword">struct</span> tcphdr <span class="token operator">*</span>th<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


        <span class="token function">smp_mb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">tcp_finish_connect</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_write_pending <span class="token operator">||</span>
            icsk<span class="token operator">-></span>icsk_accept_queue<span class="token punctuation">.</span>rskq_defer_accept <span class="token operator">||</span>
            icsk<span class="token operator">-></span>icsk_ack<span class="token punctuation">.</span>pingpong<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">tcp_send_ack</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.<code>tcp_finish_connect</code> 将当前的客户端 设置为<code>TCP_ESTABLISHED</code>状态,告诉上层应用层已经准备就绪可以和服务端端通信</p>
</li>
<li><p>2.<code>tcp_send_ack</code> 发送ACK 数据包给服务器。</p>
</li>
</ul>
<h3 id="9-服务器接受到客户端发送的ACK-数据包"><a href="#9-服务器接受到客户端发送的ACK-数据包" class="headerlink" title="9. 服务器接受到客户端发送的ACK 数据包"></a>9. 服务器接受到客户端发送的ACK 数据包</h3><p>服务端最后还是走到老方法<code>tcp_rcv_state_process</code>,此时服务端已经到了<code>TCP_RCVD</code>状态,进入到了该方法的<code>TCP_RCVD</code>的分支</p>
<pre class="line-numbers language-c"><code class="language-c">    <span class="token keyword">case</span> TCP_SYN_RECV<span class="token punctuation">:</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">smp_mb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">tcp_set_state</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> TCP_ESTABLISHED<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sk<span class="token operator">-></span><span class="token function">sk_state_change</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>服务端直接设置状态为<code>TCP_ESTABLISHED</code>,告诉上层应用层已经准备就绪可以和客户端通信。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>到这里就结束了对socket的connect 系统调用解析。内容确实十分多。也涉及到了SYN，SYN-ACK，ACK数据包的发送逻辑，本文将会把数据包的发送解析放到下一篇文章进行详细的描述。老规矩，先进行总结。</p>
<h4 id="FIB-路由"><a href="#FIB-路由" class="headerlink" title="FIB 路由"></a>FIB 路由</h4><p>在connect 系统调用之前还是需要知道fib路由转发表的核心逻辑。</p>
<p>首先在Linux中路由表实际上指的就是FIB 表。而FIB转发表中最为核心的结构体就是fib_table. 而fib表记录了真实的路由数据也就是<code>fib_info</code>。而fib_table的管理的数据则是通过一个名为<code>LC-Trie</code>的前缀树进行管理。</p>
<p>每当需要发送数据包之前，都会从net结构体中寻找换存在fib_table的数据。通过保存在tnode的<code>pos</code>和<code>index</code>字段，通过位移的手段迅速找到对应的叶子结点从而找到缓存好的跳转表数据。</p>
<h4 id="connect-系统调用"><a href="#connect-系统调用" class="headerlink" title="connect 系统调用"></a>connect 系统调用</h4><p>主要做了两件事情：</p>
<ul>
<li><p>为三次握手查找目的地址所需要的路由，其中包含了下一跳等内容</p>
</li>
<li><p>进行三次握手。三次握手可以总结为如下的图：</p>
</li>
</ul>
<p><img src="/images/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B.png" alt="TCP三次握手.png"></p>
<p>三次握手中发生了几次状态的变化。其实也是保证了包的顺序以及应答之间的状态。</p>
<p>总的来说就是三个步骤：</p>
<ul>
<li>请求</li>
<li>应答</li>
<li>应答之应答 注意在这个步骤中将不等待服务端，在发送该数据包之前就设置为就绪状态。</li>
</ul>
<p>下一篇章就来聊聊socket的发送数据包流程。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/24/android-socket-yuan-ma-jie-xi-si-socket-de-fa-song-shu-ju-yuan-li-shang/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="Android socket源码解析(四)socket的发送数据原理(上)">
                        
                        <span class="card-title">Android socket源码解析(四)socket的发送数据原理(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言上一篇文章仔细的聊了下socket的connect的原理。本文来自仔细聊聊socket发送的原理。
首先看看socket在调用connect之后，是如何调用api发送数据包的：
    InputStream inputStream =
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-04-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/socket/">
                        <span class="chip bg-color">socket</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/04/24/android-socket-yuan-ma-jie-xi-er-socket-de-bang-ding-yu-jian-ting/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Android socket源码解析(二)socket的绑定与监听">
                        
                        <span class="card-title">Android socket源码解析(二)socket的绑定与监听</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言对socket在内核的设计又了初步的印象后，可以进一步的探索socket整个流程。在这里我们先讨论服务端中，如果把准备好一个socket 绑定并进行监听的。
如果遇到什么问题可以来 https://www.jianshu.com/p/6
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2022-04-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/socket/">
                        <span class="chip bg-color">socket</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
