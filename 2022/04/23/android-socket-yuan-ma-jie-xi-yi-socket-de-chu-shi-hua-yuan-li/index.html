<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android socket源码解析(一)socket的初始化原理, Android | Linux | Flutter">
    <meta name="description" content="前言前四篇文章讲述了Okhttp的核心原理，得知Okhttp是基于Socket开发的，而不是基于HttpUrlConnection开发的。
其中对于客户端来说，核心有如下四个步骤：

1.dns lookup 把资源地址转化为ip地址
2.">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Android socket源码解析(一)socket的初始化原理 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/11.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        Android socket源码解析(一)socket的初始化原理
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/socket/">
                                <span class="chip bg-color">socket</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-04-23
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        6.8k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        30 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前四篇文章讲述了Okhttp的核心原理，得知Okhttp是基于Socket开发的，而不是基于HttpUrlConnection开发的。</p>
<p>其中对于客户端来说，核心有如下四个步骤：</p>
<ul>
<li>1.dns lookup 把资源地址转化为ip地址</li>
<li>2.socket.connect 通过socket把客户端和服务端联系起来</li>
<li>3.socket.starthandshake</li>
<li>4.socket.handshake</li>
</ul>
<p>第五篇介绍了DNS的查询流程。本文开始聊聊Socket中的核心原理。而socket就是所有网络编程的核心，就算是DNS的查询实现也是通过socket为基础实现。</p>
<p>注意接下来涉及的内核源码是3.1.8。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>Socket是什么？在计算机术语中都叫套接字。这种翻译比较拗口且难以理解。我在网上看到一个比较有趣的解释，socket的在日常用法的语义为插槽。如果把语义延展开来，可以看成是两个服务器之间的用于通信的插槽，一旦通过connect链接起来就把两个服务器之间的通信通道通过socket插槽链接起来了。</p>
<h4 id="1-客户端使用"><a href="#1-客户端使用" class="headerlink" title="1.客户端使用"></a>1.客户端使用</h4><p>来看看Java中的用法（这里我们只关注客户端tcp传输的逻辑），一般使用如下：</p>
<ul>
<li><p>1.声明一个Socket对象</p>
<pre class="line-numbers language-java"><code class="language-java">Socket socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>也可以直接想Okhttp中一样直接使用默认的构造函数</p>
<pre class="line-numbers language-java"><code class="language-java">Socket socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>2.如果之前没有设置过地址，那么此时就需要connect 链接对端的地址</p>
<pre class="line-numbers language-java"><code class="language-java">socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> connectTimeout<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><ol start="3">
<li>获取到socket的读写流，往socket中写入数据，或者读取数据</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
InputStream inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
len <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>实际上客户端的用法十分简单。</p>
<p>对于服务端又是怎么使用的呢？</p>
<h4 id="2-服务端使用"><a href="#2-服务端使用" class="headerlink" title="2.服务端使用"></a>2.服务端使用</h4><ul>
<li><p>1.构建一个ServerSocket 对象后，调用accept方法生成一个Socket对象</p>
<pre class="line-numbers language-java"><code class="language-java">
  ServerSocket server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerSocket</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>

  Socket socket <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><ol start="2">
<li><p>通过获取读取流和写入流进行对客户端socket的发送的数据的读取以及应答。</p>
<pre class="line-numbers language-java"><code class="language-java">
InputStream inputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">byte</span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> len<span class="token punctuation">;</span>
StringBuilder sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>len <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> <span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

OutputStream outputStream <span class="token operator">=</span> socket<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
outputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"..."</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
</li>
</ul>
<p>当理解了整个使用后，我们依次来看看socket在底层中都做了什么？</p>
<h2 id="正文-1"><a href="#正文-1" class="headerlink" title="正文"></a>正文</h2><p>我们先从客户端Socket实例化，到服务端Socket的初始化并监听开始考察。</p>
<h3 id="1-客户端Socket实例化"><a href="#1-客户端Socket实例化" class="headerlink" title="1.客户端Socket实例化"></a>1.客户端Socket实例化</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token function">Socket</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">setImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">setImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>factory <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            impl <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">createSocketImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkOldImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// SocketImpl!</span>
            impl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SocksSocketImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">!=</span> null<span class="token punctuation">)</span>
            impl<span class="token punctuation">.</span><span class="token function">setSocket</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Socket所有的事情都会交给这个SocksSocketImpl完成。</p>
<h4 id="2-SocksSocketImpl-构造函数与初始化"><a href="#2-SocksSocketImpl-构造函数与初始化" class="headerlink" title="2.SocksSocketImpl 构造函数与初始化"></a>2.SocksSocketImpl 构造函数与初始化</h4><p>先来看看SocksSocketImpl 的UML继承结构</p>
<p><img src="/images/SocksSocketImpl.png" alt="SocksSocketImpl.png"></p>
<p>这个结构图中，<code>SocketOptions</code>定义了接口敞亮，抽象类<code>SocketImpl</code> 定义了connect等核心的抽象方法，<code>PlainSocketImpl</code>则定义了一个构造函数，这一个特殊的构造函数，这个构造函数为<code>PlainSocketImpl</code>创建了一个<code>FileDescriptor</code>文件描述符对象。</p>
<p><code>SocksSocketImpl</code>无参构造函数并不会做任何事情：</p>
<pre class="line-numbers language-java"><code class="language-java">
    <span class="token function">SocksSocketImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Nothing needed</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>而setSocket中，调用的是<code>SocketImpl</code>中方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">setSocket</span><span class="token punctuation">(</span>Socket soc<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>socket <span class="token operator">=</span> soc<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>存储当前的socket对象</p>
<h3 id="3-Socket-connect-链接到客户端"><a href="#3-Socket-connect-链接到客户端" class="headerlink" title="3.Socket connect 链接到客户端"></a>3.Socket connect 链接到客户端</h3><p>上文中，当Okhttp客户端需要链接到某个地址，就会尝试着从域名中解析出地址和端口，然后通过这两个数据生成<code>InetSocketAddress</code>对象。</p>
<pre class="line-numbers language-kotlin"><code class="language-kotlin">  <span class="token keyword">open</span> <span class="token keyword">fun</span> <span class="token function">connectSocket</span><span class="token punctuation">(</span>socket<span class="token operator">:</span> Socket<span class="token punctuation">,</span> address<span class="token operator">:</span> InetSocketAddress<span class="token punctuation">,</span> connectTimeout<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    socket<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> connectTimeout<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">   <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span>SocketAddress endpoint<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>


        InetSocketAddress epoint <span class="token operator">=</span> <span class="token punctuation">(</span>InetSocketAddress<span class="token punctuation">)</span> endpoint<span class="token punctuation">;</span>
        InetAddress addr <span class="token operator">=</span> epoint<span class="token punctuation">.</span><span class="token function">getAddress</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> port <span class="token operator">=</span> epoint<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">checkAddress</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> <span class="token string">"connect"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        SecurityManager security <span class="token operator">=</span> System<span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>epoint<span class="token punctuation">.</span><span class="token function">isUnresolved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                security<span class="token punctuation">.</span><span class="token function">checkConnect</span><span class="token punctuation">(</span>epoint<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                security<span class="token punctuation">.</span><span class="token function">checkConnect</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">getHostAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>created<span class="token punctuation">)</span>
            <span class="token function">createImpl</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oldImpl<span class="token punctuation">)</span>
            impl<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>epoint<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>epoint<span class="token punctuation">.</span><span class="token function">isUnresolved</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                impl<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span><span class="token function">getHostName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                impl<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedOperationException</span><span class="token punctuation">(</span><span class="token string">"SocketImpl.connect(addr, timeout)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        connected <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        bound <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.首先通过SecurityManager 校验即将链接的服务器地址和端口号是否合，不合法则直接抛出异常</p>
</li>
<li><p>2.如果没有创建过，则调用<code>createImpl</code> 创建一个底层的Socket对象</p>
</li>
<li><p>3.如果不是使用以前的Socket的对象，也就是<code>oldImpl</code>为false，那么就调用<code>SocksSocketImpl</code>的<code>connect</code>进行链接。</p>
</li>
</ul>
<h4 id="3-1-Socket-createImpl-创建一个底层的Socket对象"><a href="#3-1-Socket-createImpl-创建一个底层的Socket对象" class="headerlink" title="3.1.Socket createImpl 创建一个底层的Socket对象"></a>3.1.Socket createImpl 创建一个底层的Socket对象</h4><pre class="line-numbers language-java"><code class="language-java">     <span class="token keyword">void</span> <span class="token function">createImpl</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> stream<span class="token punctuation">)</span> <span class="token keyword">throws</span> SocketException <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>impl <span class="token operator">==</span> null<span class="token punctuation">)</span>
            <span class="token function">setImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            impl<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
            created <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">SocketException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心还是<code>SocksSocketImpl</code>的<code>create</code> 方法。</p>
<h5 id="3-2-AbstractPlainSocketImpl-create"><a href="#3-2-AbstractPlainSocketImpl-create" class="headerlink" title="3.2.AbstractPlainSocketImpl create"></a>3.2.AbstractPlainSocketImpl create</h5><p>文件：/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/" target="_blank" rel="noopener">ojluni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/" target="_blank" rel="noopener">main</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/" target="_blank" rel="noopener">java</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/ojluni/src/main/java/java/net/AbstractPlainSocketImpl.java" target="_blank" rel="noopener">AbstractPlainSocketImpl.java</a></p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> stream<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>stream<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ResourceManager<span class="token punctuation">.</span><span class="token function">beforeUdpCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token function">socketCreate</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioe<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">socketCreate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>socket <span class="token operator">!=</span> null<span class="token punctuation">)</span>
            socket<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSocket <span class="token operator">!=</span> null<span class="token punctuation">)</span>
            serverSocket<span class="token punctuation">.</span><span class="token function">setCreated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> fd<span class="token punctuation">.</span><span class="token function">valid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            guard<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是由<code>PlainSocketImpl</code>实现的抽象方法<code>socketCreate</code>完成的。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">socketCreate</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isStream<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{</span>
        fd<span class="token punctuation">.</span>setInt$<span class="token punctuation">(</span>IoBridge<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET6<span class="token punctuation">,</span> isStream <span class="token operator">?</span> SOCK_STREAM <span class="token operator">:</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>getInt$<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>serverSocket <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            IoUtils<span class="token punctuation">.</span><span class="token function">setBlocking</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            IoBridge<span class="token punctuation">.</span><span class="token function">setSocketOption</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>IoBridge.socket</code>创建一个socket对象后，并返回这个对象对应的文件描述符具柄设置到<code>PlainSocketImpl</code>中缓存的文件描述符对象.注意这个过程写死了<code>AF_INET6</code> 作为ip地址族传入。说明必定是可以接受ipv6协议的地址数据。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> FileDescriptor <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span> <span class="token keyword">throws</span> SocketException <span class="token punctuation">{</span>
        FileDescriptor fd<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            fd <span class="token operator">=</span> Libcore<span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">socket</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> errnoException<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> errnoException<span class="token punctuation">.</span><span class="token function">rethrowAsSocketException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这个方法是一个native方法，我们去下面文件中：<br><a href="http://androidxref.com/9.0.0_r3/xref/libcore/" target="_blank" rel="noopener">libcore</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/" target="_blank" rel="noopener">luni</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/" target="_blank" rel="noopener">src</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/" target="_blank" rel="noopener">main</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/native/" target="_blank" rel="noopener">native</a>/<a href="http://androidxref.com/9.0.0_r3/xref/libcore/luni/src/main/native/libcore_io_Linux.cpp" target="_blank" rel="noopener">libcore_io_Linux.cpp</a></p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> jobject <span class="token function">Linux_socket</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jint domain<span class="token punctuation">,</span> jint type<span class="token punctuation">,</span> jint protocol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> AF_PACKET<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        protocol <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// Packet sockets specify the protocol in host byte order.</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">throwIfMinusOne</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"socket"</span><span class="token punctuation">,</span> <span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span><span class="token function">socket</span><span class="token punctuation">(</span>domain<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> fd <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token function">jniCreateFileDescriptor</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> fd<span class="token punctuation">)</span> <span class="token operator">:</span> NULL<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是调用了系统调用<code>socket</code> 为套接字创建一个对应的文件描述符后，返回一个Java的FileDescriptor 对象返回。</p>
<h3 id="4-Socket系统调用"><a href="#4-Socket系统调用" class="headerlink" title="4.Socket系统调用"></a>4.Socket系统调用</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/socket.c" target="_blank" rel="noopener">socket.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token function">SYSCALL_DEFINE3</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> protocol<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> retval<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">;</span>
    <span class="token keyword">int</span> flags<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    flags <span class="token operator">=</span> type <span class="token operator">&amp;</span> <span class="token operator">~</span>SOCK_TYPE_MASK<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>SOCK_CLOEXEC <span class="token operator">|</span> SOCK_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    type <span class="token operator">&amp;</span><span class="token operator">=</span> SOCK_TYPE_MASK<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>SOCK_NONBLOCK <span class="token operator">!=</span> O_NONBLOCK <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> SOCK_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span>
        flags <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> <span class="token operator">~</span>SOCK_NONBLOCK<span class="token punctuation">)</span> <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">;</span>

    retval <span class="token operator">=</span> <span class="token function">sock_create</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

    retval <span class="token operator">=</span> <span class="token function">sock_map_fd</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> flags <span class="token operator">&amp;</span> <span class="token punctuation">(</span>O_CLOEXEC <span class="token operator">|</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>retval <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_release<span class="token punctuation">;</span>

out<span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true">/* It may be already another descriptor 8) Not kernel problem. */</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>

out_release<span class="token punctuation">:</span>
    <span class="token function">sock_release</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> retval<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>分为2个步骤：</p>
<ul>
<li>1.sock_create 创建一个socket 结构体</li>
<li>2.sock_map_fd 把结构体和fd具柄关联起来</li>
</ul>
<p>为了更加清晰的理解<code>socket</code>结构体的内容我们看看这个结构体都包含了什么字段？</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> socket <span class="token punctuation">{</span>
    socket_state        state<span class="token punctuation">;</span>

    <span class="token function">kmemcheck_bitfield_begin</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">short</span>            type<span class="token punctuation">;</span>
    <span class="token function">kmemcheck_bitfield_end</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span>        flags<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> socket_wq __rcu    <span class="token operator">*</span>wq<span class="token punctuation">;</span>

    <span class="token keyword">struct</span> file        <span class="token operator">*</span>file<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sock        <span class="token operator">*</span>sk<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> proto_ops    <span class="token operator">*</span>ops<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.socket_state 当前socket的枚举状态</li>
<li>2.type 当前socket对应的类型</li>
<li>3.flag 当前socket带上的标识为</li>
<li>4.socket中对应的等待队列</li>
<li>5.file socket对应的文件描述符</li>
<li>6.sock 结构体是指socket中更为核心的具体操作函数以及标志位</li>
<li>7.proto_ops 对应的协议操作结构体</li>
</ul>
<h4 id="4-1-sock-create-创建socket结构体"><a href="#4-1-sock-create-创建socket结构体" class="headerlink" title="4.1.__sock_create 创建socket结构体"></a>4.1.__sock_create 创建socket结构体</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">__sock_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> net <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">int</span> family<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span>
             <span class="token keyword">struct</span> socket <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token keyword">int</span> kern<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> net_proto_family <span class="token operator">*</span>pf<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


    err <span class="token operator">=</span> <span class="token function">security_socket_create</span><span class="token punctuation">(</span>family<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> err<span class="token punctuation">;</span>


    sock <span class="token operator">=</span> <span class="token function">sock_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    sock<span class="token operator">-></span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pf <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span>net_families<span class="token punctuation">[</span>family<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token operator">-</span>EAFNOSUPPORT<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pf<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_release<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">try_module_get</span><span class="token punctuation">(</span>pf<span class="token operator">-></span>owner<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_release<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/* Now protected by module ref count */</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> pf<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_module_put<span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">try_module_get</span><span class="token punctuation">(</span>sock<span class="token operator">-></span>ops<span class="token operator">-></span>owner<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_module_busy<span class="token punctuation">;</span>

    <span class="token function">module_put</span><span class="token punctuation">(</span>pf<span class="token operator">-></span>owner<span class="token punctuation">)</span><span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">security_socket_post_create</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> family<span class="token punctuation">,</span> type<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_sock_release<span class="token punctuation">;</span>
    <span class="token operator">*</span>res <span class="token operator">=</span> sock<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.<code>security_socket_create</code> 通过SELinux进行校验。SELinux本质上就是在一个文件中写好了每一个进程允许做的事情，当需要读取文件数据，socket等敏感操作时候将会进行一次check。可以通过security_register 进行注册。</p>
</li>
<li><ol start="2">
<li>一旦校验通过后，则会调用<code>sock_alloc</code>创建一个<code>sock</code>结构体，该并在结构体记录当前type，常见的数据类型如下：</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">enum</span> sock_type <span class="token punctuation">{</span>
SOCK_STREAM <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
SOCK_DGRAM <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">,</span>
SOCK_RAW <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>SOCK_STREAM</code> 是指面向数据流属于TCP协议；<code>SOCK_DGRAM</code>面向数据报文属于UDP协议；<code>SOCK_RAW</code> 是指原始ip包</p>
<ul>
<li><ol start="3">
<li>rcu_dereference 进行rcu（Read-Copy-update）模式保护当前net_families (地址族)数组中对应引用的指针。<code>rcu</code>实际上就是我之前说过的一种特殊的线程设计，任意读取数据，写时候需要进行同步的方式。当读取的情况比较多的时候，就可以采用这种方式。  注意<code>net_families</code> 是指当前的传递下来的<code>domain</code>,也就是这是<code>ipv4</code>还是<code>ipv6</code>族。</li>
</ol>
</li>
<li><p>4.调用<code>net_families</code>中对应族的的create方法。</p>
</li>
</ul>
<p>在这里涉及到了几个比较核心结构体。</p>
<h3 id="4-1-1-socket-结构体的创建与socket-内核模块的初始化"><a href="#4-1-1-socket-结构体的创建与socket-内核模块的初始化" class="headerlink" title="4.1.1.socket  结构体的创建与socket 内核模块的初始化"></a>4.1.1.socket  结构体的创建与socket 内核模块的初始化</h3><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> socket <span class="token operator">*</span><span class="token function">sock_alloc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">;</span>

    inode <span class="token operator">=</span> <span class="token function">new_inode_pseudo</span><span class="token punctuation">(</span>sock_mnt<span class="token operator">-></span>mnt_sb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>inode<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    sock <span class="token operator">=</span> <span class="token function">SOCKET_I</span><span class="token punctuation">(</span>inode<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">kmemcheck_annotate_bitfield</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-></span>i_ino <span class="token operator">=</span> <span class="token function">get_next_ino</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-></span>i_mode <span class="token operator">=</span> S_IFSOCK <span class="token operator">|</span> S_IRWXUGO<span class="token punctuation">;</span>
    inode<span class="token operator">-></span>i_uid <span class="token operator">=</span> <span class="token function">current_fsuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-></span>i_gid <span class="token operator">=</span> <span class="token function">current_fsgid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    inode<span class="token operator">-></span>i_op <span class="token operator">=</span> <span class="token operator">&amp;</span>sockfs_inode_ops<span class="token punctuation">;</span>

    <span class="token function">this_cpu_add</span><span class="token punctuation">(</span>sockets_in_use<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> sock<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.new_inode_pseudo 通过虚拟文件系统创建一个inode对象。注意这里是通过结构体为名为<code>sock_mnt</code>的<code>vfsmount</code> 创建一个inode</li>
</ul>
<ul>
<li><ol start="2">
<li><code>SOCKET_I</code> 从inode中创建socket结构体。</li>
</ol>
</li>
</ul>
<h4 id="4-1-2-socket模块的初始化以及对应vfsmount生成原理"><a href="#4-1-2-socket模块的初始化以及对应vfsmount生成原理" class="headerlink" title="4.1.2.socket模块的初始化以及对应vfsmount生成原理"></a>4.1.2.socket模块的初始化以及对应vfsmount生成原理</h4><p>关于<code>sock_mnt</code> 初始化，在socket内核模块加载时候就加载好了：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">sock_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>
    err <span class="token operator">=</span> <span class="token function">net_sysctl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

    <span class="token function">skb_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">init_inodecache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token function">register_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sock_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_fs<span class="token punctuation">;</span>
    sock_mnt <span class="token operator">=</span> <span class="token function">kern_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sock_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上就是初始化好socket对应的虚拟文件系统操作,把<code>sock_fs_type</code>注册在虚拟文件系统中，并通过kern_mount 调用操作结构体的<code>mount</code>指针挂在在系统中，返回<code>mnt</code> 结构体挂载对象进行操作。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> file_system_type sock_fs_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span>        <span class="token string">"sockfs"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mount <span class="token operator">=</span>    sockfs_mount<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kill_sb <span class="token operator">=</span>    kill_anon_super<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>结合第一段代码，可以得知，实际上整个socket内核模块初始化调用的就是<code>sockfs_mount</code>。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> dentry <span class="token operator">*</span><span class="token function">sockfs_mount</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file_system_type <span class="token operator">*</span>fs_type<span class="token punctuation">,</span>
             <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">mount_pseudo</span><span class="token punctuation">(</span>fs_type<span class="token punctuation">,</span> <span class="token string">"socket:"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sockfs_ops<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>sockfs_dentry_operations<span class="token punctuation">,</span> SOCKFS_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> super_operations sockfs_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>alloc_inode    <span class="token operator">=</span> sock_alloc_inode<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>destroy_inode    <span class="token operator">=</span> sock_destroy_inode<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>statfs        <span class="token operator">=</span> simple_statfs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> dentry_operations sockfs_dentry_operations <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>d_dname  <span class="token operator">=</span> sockfs_dname<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><code>mount_pseudo</code> 会为当前socket对应的超级块设置一套操作结构体，生成对应的inode的时候会先调用<code>dentry_operations</code> 生成一个个detry(你可以看成文件路径),接着调用<code>sockfs_ops</code>的<code>alloc_inode</code> 生成inode。</p>
<h6 id="4-1-3-sock-alloc-inode-生成对应的inode"><a href="#4-1-3-sock-alloc-inode-生成对应的inode" class="headerlink" title="4.1.3.sock_alloc_inode 生成对应的inode"></a>4.1.3.sock_alloc_inode 生成对应的inode</h6><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> inode <span class="token operator">*</span><span class="token function">sock_alloc_inode</span><span class="token punctuation">(</span><span class="token keyword">struct</span> super_block <span class="token operator">*</span>sb<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> socket_alloc <span class="token operator">*</span>ei<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> socket_wq <span class="token operator">*</span>wq<span class="token punctuation">;</span>

    ei <span class="token operator">=</span> <span class="token function">kmem_cache_alloc</span><span class="token punctuation">(</span>sock_inode_cachep<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ei<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    wq <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>wq<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>wq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">kmem_cache_free</span><span class="token punctuation">(</span>sock_inode_cachep<span class="token punctuation">,</span> ei<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">init_waitqueue_head</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wq<span class="token operator">-></span>wait<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wq<span class="token operator">-></span>fasync_list <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token function">RCU_INIT_POINTER</span><span class="token punctuation">(</span>ei<span class="token operator">-></span>socket<span class="token punctuation">.</span>wq<span class="token punctuation">,</span> wq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ei<span class="token operator">-></span>socket<span class="token punctuation">.</span>state <span class="token operator">=</span> SS_UNCONNECTED<span class="token punctuation">;</span>
    ei<span class="token operator">-></span>socket<span class="token punctuation">.</span>flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    ei<span class="token operator">-></span>socket<span class="token punctuation">.</span>ops <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ei<span class="token operator">-></span>socket<span class="token punctuation">.</span>sk <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    ei<span class="token operator">-></span>socket<span class="token punctuation">.</span>file <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>ei<span class="token operator">-></span>vfs_inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程实际上从快速缓存中生成一个<code>socket_alloc</code> 对象，这个对象中持有inode结构体。并初始化对应的那个等待队列。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> socket <span class="token operator">*</span><span class="token function">SOCKET_I</span><span class="token punctuation">(</span><span class="token keyword">struct</span> inode <span class="token operator">*</span>inode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span><span class="token function">container_of</span><span class="token punctuation">(</span>inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> socket_alloc<span class="token punctuation">,</span> vfs_inode<span class="token punctuation">)</span><span class="token operator">-></span>socket<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>当需要获取对应的socket结构体时候，就会通过<code>inode</code>反过来查找<code>socket_alloc</code>中的<code>socket</code>.</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> socket_alloc <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> socket socket<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> inode vfs_inode<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-1-4-Linux内核网络模块初始化-net-families-地址族的注册"><a href="#4-1-4-Linux内核网络模块初始化-net-families-地址族的注册" class="headerlink" title="4.1.4.Linux内核网络模块初始化 net_families 地址族的注册"></a>4.1.4.Linux内核网络模块初始化 net_families 地址族的注册</h3><p>知道socket结构体是如何生成的。再来关注<code>net_families</code>是什么时候注册的。地址族是什么？顾名思义就是指地址类别，比如ipv4，ipv6等地址类型。</p>
<p>我们看看文件：<br>/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/af_inet.c" target="_blank" rel="noopener">af_inet.c</a></p>
<p>对应ipv4 内核模块的注册代码：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">inet_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inet_protosw <span class="token operator">*</span>q<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> list_head <span class="token operator">*</span>r<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    rc <span class="token operator">=</span> <span class="token function">proto_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcp_prot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

    rc <span class="token operator">=</span> <span class="token function">proto_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udp_prot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_unregister_tcp_proto<span class="token punctuation">;</span>

    rc <span class="token operator">=</span> <span class="token function">proto_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>raw_prot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_unregister_udp_proto<span class="token punctuation">;</span>

    rc <span class="token operator">=</span> <span class="token function">proto_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ping_prot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_unregister_raw_proto<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/*
     *    Tell SOCKET that we are alive...
     */</span>

    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">sock_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inet_family_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_SYSCTL</span>
    <span class="token function">ip_static_sysctl_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    <span class="token comment" spellcheck="true">/*
     *    Add all the base protocols.
     */</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>icmp_protocol<span class="token punctuation">,</span> IPPROTO_ICMP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">pr_crit</span><span class="token punctuation">(</span><span class="token string">"%s: Cannot add ICMP protocol\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udp_protocol<span class="token punctuation">,</span> IPPROTO_UDP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">pr_crit</span><span class="token punctuation">(</span><span class="token string">"%s: Cannot add UDP protocol\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tcp_protocol<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">pr_crit</span><span class="token punctuation">(</span><span class="token string">"%s: Cannot add TCP protocol\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span> <span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token operator">&amp;</span>inetsw<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>inetsw<span class="token punctuation">[</span>SOCK_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>r<span class="token punctuation">)</span>
        <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>q <span class="token operator">=</span> inetsw_array<span class="token punctuation">;</span> q <span class="token operator">&lt;</span> <span class="token operator">&amp;</span>inetsw_array<span class="token punctuation">[</span>INETSW_ARRAY_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>q<span class="token punctuation">)</span>
        <span class="token function">inet_register_protosw</span><span class="token punctuation">(</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">arp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">ip_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">tcp_v4_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">tcp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">udp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token function">udplite4_register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ping_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


    <span class="token function">ipfrag_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">dev_add_pack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ip_packet_type<span class="token punctuation">)</span><span class="token punctuation">;</span>

    rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token function">fs_initcall</span><span class="token punctuation">(</span>inet_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一段其实就是Linux内核对网络模块的初始化：</p>
<ul>
<li><ol>
<li>proto_register 将<code>tcp_prot</code>(tcp协议),<code>udp_prot</code>(udp协议),<code>raw_prot</code>(原始ip包),<code>ping_prot</code>( ping 协议) 结构体注册到全局变量<code>proto_list</code>。</li>
</ol>
</li>
</ul>
<p>简单的看看<code>tcp_prot</code> 结构体内容：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> proto tcp_prot <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name            <span class="token operator">=</span> <span class="token string">"TCP"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>owner            <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>close            <span class="token operator">=</span> tcp_close<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>connect        <span class="token operator">=</span> tcp_v4_connect<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>disconnect        <span class="token operator">=</span> tcp_disconnect<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>accept            <span class="token operator">=</span> inet_csk_accept<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ioctl            <span class="token operator">=</span> tcp_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>init            <span class="token operator">=</span> tcp_v4_init_sock<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>destroy        <span class="token operator">=</span> tcp_v4_destroy_sock<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>shutdown        <span class="token operator">=</span> tcp_shutdown<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>setsockopt        <span class="token operator">=</span> tcp_setsockopt<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>getsockopt        <span class="token operator">=</span> tcp_getsockopt<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>recvmsg        <span class="token operator">=</span> tcp_recvmsg<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sendmsg        <span class="token operator">=</span> tcp_sendmsg<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sendpage        <span class="token operator">=</span> tcp_sendpage<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>backlog_rcv        <span class="token operator">=</span> tcp_v4_do_rcv<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release_cb        <span class="token operator">=</span> tcp_release_cb<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>hash            <span class="token operator">=</span> inet_hash<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unhash            <span class="token operator">=</span> inet_unhash<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_port        <span class="token operator">=</span> inet_csk_get_port<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>enter_memory_pressure    <span class="token operator">=</span> tcp_enter_memory_pressure<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>stream_memory_free    <span class="token operator">=</span> tcp_stream_memory_free<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sockets_allocated    <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_sockets_allocated<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>orphan_count        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_orphan_count<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>memory_allocated    <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_memory_allocated<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>memory_pressure    <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_memory_pressure<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysctl_mem        <span class="token operator">=</span> sysctl_tcp_mem<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysctl_wmem        <span class="token operator">=</span> sysctl_tcp_wmem<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysctl_rmem        <span class="token operator">=</span> sysctl_tcp_rmem<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_header        <span class="token operator">=</span> MAX_TCP_HEADER<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>obj_size        <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tcp_sock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>slab_flags        <span class="token operator">=</span> SLAB_DESTROY_BY_RCU<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>twsk_prot        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_timewait_sock_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>rsk_prot        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_request_sock_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>h<span class="token punctuation">.</span>hashinfo        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_hashinfo<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>no_autobind        <span class="token operator">=</span> true<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这个结构体定义了tcp协议的面向网络链接的操作符</p>
<ul>
<li><p>2.<code>sock_register</code>初始化socket模块以及协议族，从严格意义来说在<code>proto_register</code>注册过程中已经完成了常用协议的注册。</p>
</li>
<li><p>3.<code>inet_add_protocol</code> 将<code>icmp_protocol</code>,<code>udp_protocol</code>,<code>tcp_protocol</code> 等回调协议添加到<code>inet_protos</code> 链表中。</p>
</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> net_protocol <span class="token operator">*</span>prot<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> protocol<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">cmpxchg</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> net_protocol <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>inet_protos<span class="token punctuation">[</span>protocol<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token constant">NULL</span><span class="token punctuation">,</span> prot<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>我们调tcp协议对应的<code>tcp_protocol</code>结构体看看里面定义了什么操作函数：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> net_protocol tcp_protocol <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>early_demux    <span class="token operator">=</span>    tcp_v4_early_demux<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>handler    <span class="token operator">=</span>    tcp_v4_rcv<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>err_handler    <span class="token operator">=</span>    tcp_v4_err<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>no_policy    <span class="token operator">=</span>    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>netns_ok    <span class="token operator">=</span>    <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>icmp_strict_tag_validation <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>主要函数<code>handler</code> 所对应的<code>tcp_v4_rcv</code>方法。这个方法决定了tcp协议数据从另一端到来后的操作。</p>
<ul>
<li><ol start="4">
<li>遍历<code>inetsw_array</code> 数组，把每个元素通过<code>inet_register_protosw</code>方法注册到<code>inetsw</code>数组中。</li>
</ol>
</li>
</ul>
<p>来看看<code>inetsw_array</code> 内容：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> inet_protosw inetsw_array<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>type <span class="token operator">=</span>       SOCK_STREAM<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>protocol <span class="token operator">=</span>   IPPROTO_TCP<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>prot <span class="token operator">=</span>       <span class="token operator">&amp;</span>tcp_prot<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>ops <span class="token operator">=</span>        <span class="token operator">&amp;</span>inet_stream_ops<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>flags <span class="token operator">=</span>      INET_PROTOSW_PERMANENT <span class="token operator">|</span>
                  INET_PROTOSW_ICSK<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>

    <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>type <span class="token operator">=</span>       SOCK_DGRAM<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>protocol <span class="token operator">=</span>   IPPROTO_UDP<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>prot <span class="token operator">=</span>       <span class="token operator">&amp;</span>udp_prot<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>ops <span class="token operator">=</span>        <span class="token operator">&amp;</span>inet_dgram_ops<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>flags <span class="token operator">=</span>      INET_PROTOSW_PERMANENT<span class="token punctuation">,</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span>

       <span class="token punctuation">{</span>
        <span class="token punctuation">.</span>type <span class="token operator">=</span>       SOCK_DGRAM<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>protocol <span class="token operator">=</span>   IPPROTO_ICMP<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>prot <span class="token operator">=</span>       <span class="token operator">&amp;</span>ping_prot<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>ops <span class="token operator">=</span>        <span class="token operator">&amp;</span>inet_dgram_ops<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>flags <span class="token operator">=</span>      INET_PROTOSW_REUSE<span class="token punctuation">,</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span>

       <span class="token punctuation">{</span>
           <span class="token punctuation">.</span>type <span class="token operator">=</span>       SOCK_RAW<span class="token punctuation">,</span>
           <span class="token punctuation">.</span>protocol <span class="token operator">=</span>   IPPROTO_IP<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/* wild card */</span>
           <span class="token punctuation">.</span>prot <span class="token operator">=</span>       <span class="token operator">&amp;</span>raw_prot<span class="token punctuation">,</span>
           <span class="token punctuation">.</span>ops <span class="token operator">=</span>        <span class="token operator">&amp;</span>inet_sockraw_ops<span class="token punctuation">,</span>
           <span class="token punctuation">.</span>flags <span class="token operator">=</span>      INET_PROTOSW_REUSE<span class="token punctuation">,</span>
       <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个数组决定了tcp层协议的操作符，协议类型，以及协议面向外部的模块处理方法。</p>
<p>举一个tcp的例子：</p>
<ul>
<li>类型 为SOCK_STREAM 代表是面向数据流</li>
<li>protocol 为 <code>IPPROTO_TCP</code> 代表当前协议是tcp协议</li>
<li>prot 为<code>tcp_prot</code> 就是tcp协议的特殊操作方法</li>
<li>ops 为<code>inet_stream_ops</code> 是指当前数据流对应的文件描述符中复写的操作是什么</li>
<li>flags 是指当前的协议状态。<code>INET_PROTOSW_PERMANENT</code> 是指永久不变的协议，<code>INET_PROTOSW_REUSE</code> 是指该协议会复用端口。</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> proto_ops inet_stream_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>family           <span class="token operator">=</span> PF_INET<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>owner           <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release       <span class="token operator">=</span> inet_release<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>bind           <span class="token operator">=</span> inet_bind<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>connect       <span class="token operator">=</span> inet_stream_connect<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>socketpair       <span class="token operator">=</span> sock_no_socketpair<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>accept           <span class="token operator">=</span> inet_accept<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>getname       <span class="token operator">=</span> inet_getname<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>poll           <span class="token operator">=</span> tcp_poll<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ioctl           <span class="token operator">=</span> inet_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>listen           <span class="token operator">=</span> inet_listen<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>shutdown       <span class="token operator">=</span> inet_shutdown<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>setsockopt       <span class="token operator">=</span> sock_common_setsockopt<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>getsockopt       <span class="token operator">=</span> sock_common_getsockopt<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sendmsg       <span class="token operator">=</span> inet_sendmsg<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>recvmsg       <span class="token operator">=</span> inet_recvmsg<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mmap           <span class="token operator">=</span> sock_no_mmap<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sendpage       <span class="token operator">=</span> inet_sendpage<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>splice_read       <span class="token operator">=</span> tcp_splice_read<span class="token punctuation">,</span>
<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_COMPAT</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这个结构体中，我们就能大致猜到整个tcp的设计框架了。必定是先找到socket文件描述符中对应的协议文件描述符<code>inet_stream_ops</code>,接着找到<code>tcp_prot</code>结构体进行进一步的处理。</p>
<ul>
<li><ol start="5">
<li>arp_init 对数据链路层的arp协议相关的邻居表进行初始化。</li>
</ol>
</li>
<li><ol start="6">
<li>ip_init  对网络层的ip模块的初始化，在这里初始化ip对应的route_table 内存。</li>
</ol>
</li>
<li><ol start="7">
<li>tcp_v4_init 与 tcp_init 可以看作一个整体都是初始化tcp模块。<code>tcp_init</code> 初始化了<code>inet_hashinfo</code>结构体。这个结构体实际上就是用于管理分配给socket端口。该结构体会通过一个哈希表对端口进行一次管理。</li>
</ol>
</li>
</ul>
<ul>
<li><ol start="8">
<li><code>tcp_init</code> 方法则是初始化请求需要的内存，以及<code>inet_hashinfo</code>中的hash表， 并计算之后每一个请求和接受的临时缓冲区计算好大小阈值。发送缓冲区为16kb，接受缓冲区大小约为85kb。</li>
</ol>
</li>
</ul>
<ul>
<li>9.<code>udp_init</code> 初始化了UDP需要的内存阈值，<code>udplite4_register</code>  则是注册一个全新的UDLITE协议到内核中。在这个过程就能看到内核添加一个自定义协议的原始三步骤: <code>proto_register</code> ,<code>inet_add_protocol</code>,<code>inet_register_protosw</code></li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> __init <span class="token function">udplite4_register</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">udp_table_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udplite_table<span class="token punctuation">,</span> <span class="token string">"UDP-Lite"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">proto_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udplite_prot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_register_err<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">inet_add_protocol</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udplite_protocol<span class="token punctuation">,</span> IPPROTO_UDPLITE<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_unregister_proto<span class="token punctuation">;</span>

    <span class="token function">inet_register_protosw</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>udplite4_protosw<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol start="10">
<li><code>ping_init</code> 对Ping协议进行初始化</li>
</ol>
</li>
<li><ol start="11">
<li><code>ipfrag_init</code> 初始化<code>inet_frags</code>结构体。该结构体实际上负责了整个数据流临时缓冲区的分片。</li>
</ol>
</li>
</ul>
<p>我们把重心放在<code>sock_register</code>中。</p>
<h5 id="4-1-5-sock-register-注册创建地址族结构体"><a href="#4-1-5-sock-register-注册创建地址族结构体" class="headerlink" title="4.1.5.sock_register 注册创建地址族结构体"></a>4.1.5.sock_register 注册创建地址族结构体</h5><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">sock_register</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> net_proto_family <span class="token operator">*</span>ops<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>ops<span class="token operator">-></span>family <span class="token operator">>=</span> NPROTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOBUFS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">spin_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>net_family_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rcu_dereference_protected</span><span class="token punctuation">(</span>net_families<span class="token punctuation">[</span>ops<span class="token operator">-></span>family<span class="token punctuation">]</span><span class="token punctuation">,</span>
                      <span class="token function">lockdep_is_held</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>net_family_lock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EEXIST<span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>net_families<span class="token punctuation">[</span>ops<span class="token operator">-></span>family<span class="token punctuation">]</span><span class="token punctuation">,</span> ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
        err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>net_family_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到是做了一个rcu的锁进行保护后，把<code>net_proto_family</code>注册到<code>net_families</code> 数组中。</p>
<p>来看看注册的对象，<code>family</code>的字段为<code>PF_INET</code>，能通过<code>net_families</code>寻找下标为<code>PF_INET</code> 找到<code>inet_family_ops</code>.这样就注册到socket模块中。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> net_proto_family inet_family_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>family <span class="token operator">=</span> PF_INET<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>create <span class="token operator">=</span> inet_create<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>owner    <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在socket进行初始化的时候，调用了<code>net_families</code> 中对应family下的<code>net_proto_family</code>，设置的是<code>AF_INET6</code>的参数。说明是进入了对应的ipv6的内核模块进行创建，我们来看看ipv6内核模块加载的核心方法。</p>
<p>这里注意，如果你去看源码你会发现在Java源码中对应<code>AF_INET6</code> 是一个placeholder方法返回的默认数值是0.实际上这个过程是JVM加载的时候设置进去的。而设置的数据可以打印<code>AF_INET6</code>出来 也是对应上内核<code>AF_INET6</code>一样的数值<code>10</code></p>
<h4 id="4-1-6-ipv6-ip地址族内核模块初始化"><a href="#4-1-6-ipv6-ip地址族内核模块初始化" class="headerlink" title="4.1.6.ipv6 ip地址族内核模块初始化"></a>4.1.6.ipv6 ip地址族内核模块初始化</h4><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">inet6_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    err <span class="token operator">=</span> <span class="token function">sock_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>inet6_family_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>inet6_init<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注册这个结构体：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> net_proto_family inet6_family_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>family <span class="token operator">=</span> PF_INET6<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>create <span class="token operator">=</span> inet6_create<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>owner    <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>说明此时注册在socket模块中<code>net_families</code> 对应下标是<code>PF_INET6</code>的创建协议族方法。</p>
<p>我们回到最初的<code>__sock_create</code>方法创建socket结构体的下面这段话</p>
<pre class="line-numbers language-c"><code class="language-c"> err <span class="token operator">=</span> pf<span class="token operator">-></span><span class="token function">create</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> sock<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> kern<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>就能明白，实际上就是调用了<code>inet6_create</code>方法。</p>
<h5 id="4-1-7-inet6-create-创建ipv6的协议族"><a href="#4-1-7-inet6-create-创建ipv6的协议族" class="headerlink" title="4.1.7.inet6_create 创建ipv6的协议族"></a>4.1.7.inet6_create 创建ipv6的协议族</h5><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv6/" target="_blank" rel="noopener">ipv6</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv6/af_inet6.c" target="_blank" rel="noopener">af_inet6.c</a></p>
<p>注意此时传下来的参数是socket结构体，<code>socket-&gt;type</code> 为<code>SOCK_STREAM</code>（此时我们讨论的是TCP）</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">inet6_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> net <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">,</span>
            <span class="token keyword">int</span> kern<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inet_sock <span class="token operator">*</span>inet<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> ipv6_pinfo <span class="token operator">*</span>np<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> inet_protosw <span class="token operator">*</span>answer<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> proto <span class="token operator">*</span>answer_prot<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> answer_flags<span class="token punctuation">;</span>
    <span class="token keyword">int</span> try_loading_module <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> err<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    err <span class="token operator">=</span> <span class="token operator">-</span>ESOCKTNOSUPPORT<span class="token punctuation">;</span>
    <span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_for_each_entry_rcu</span><span class="token punctuation">(</span>answer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>inetsw6<span class="token punctuation">[</span>sock<span class="token operator">-></span>type<span class="token punctuation">]</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">/* Check the non-wild match. */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">==</span> answer<span class="token operator">-></span>protocol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>protocol <span class="token operator">!=</span> IPPROTO_IP<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">/* Check for the two wild cases. */</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>IPPROTO_IP <span class="token operator">==</span> protocol<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                protocol <span class="token operator">=</span> answer<span class="token operator">-></span>protocol<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>IPPROTO_IP <span class="token operator">==</span> answer<span class="token operator">-></span>protocol<span class="token punctuation">)</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        err <span class="token operator">=</span> <span class="token operator">-</span>EPROTONOSUPPORT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    err <span class="token operator">=</span> <span class="token operator">-</span>EPERM<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sock<span class="token operator">-></span>type <span class="token operator">==</span> SOCK_RAW <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>kern <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">capable</span><span class="token punctuation">(</span>CAP_NET_RAW<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_rcu_unlock<span class="token punctuation">;</span>

    sock<span class="token operator">-></span>ops <span class="token operator">=</span> answer<span class="token operator">-></span>ops<span class="token punctuation">;</span>
    answer_prot <span class="token operator">=</span> answer<span class="token operator">-></span>prot<span class="token punctuation">;</span>
    answer_flags <span class="token operator">=</span> answer<span class="token operator">-></span>flags<span class="token punctuation">;</span>
    <span class="token function">rcu_read_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WARN_ON</span><span class="token punctuation">(</span>answer_prot<span class="token operator">-></span>slab <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token operator">-</span>ENOBUFS<span class="token punctuation">;</span>
    sk <span class="token operator">=</span> <span class="token function">sk_alloc</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> PF_INET6<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">,</span> answer_prot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sk <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out<span class="token punctuation">;</span>

    <span class="token function">sock_init_data</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>INET_PROTOSW_REUSE <span class="token operator">&amp;</span> answer_flags<span class="token punctuation">)</span>
        sk<span class="token operator">-></span>sk_reuse <span class="token operator">=</span> SK_CAN_REUSE<span class="token punctuation">;</span>

    inet <span class="token operator">=</span> <span class="token function">inet_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    inet<span class="token operator">-></span>is_icsk <span class="token operator">=</span> <span class="token punctuation">(</span>INET_PROTOSW_ICSK <span class="token operator">&amp;</span> answer_flags<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>SOCK_RAW <span class="token operator">==</span> sock<span class="token operator">-></span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        inet<span class="token operator">-></span>inet_num <span class="token operator">=</span> protocol<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IPPROTO_RAW <span class="token operator">==</span> protocol<span class="token punctuation">)</span>
            inet<span class="token operator">-></span>hdrincl <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sk<span class="token operator">-></span>sk_destruct        <span class="token operator">=</span> inet_sock_destruct<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_family        <span class="token operator">=</span> PF_INET6<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_protocol        <span class="token operator">=</span> protocol<span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_backlog_rcv    <span class="token operator">=</span> answer<span class="token operator">-></span>prot<span class="token operator">-></span>backlog_rcv<span class="token punctuation">;</span>

    <span class="token function">inet_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token operator">-></span>pinet6 <span class="token operator">=</span> np <span class="token operator">=</span> <span class="token function">inet6_sk_generic</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    np<span class="token operator">-></span>hop_limit    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    np<span class="token operator">-></span>mcast_hops    <span class="token operator">=</span> IPV6_DEFAULT_MCASTHOPS<span class="token punctuation">;</span>
    np<span class="token operator">-></span>mc_loop    <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    np<span class="token operator">-></span>pmtudisc    <span class="token operator">=</span> IPV6_PMTUDISC_WANT<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_ipv6only    <span class="token operator">=</span> net<span class="token operator">-></span>ipv6<span class="token punctuation">.</span>sysctl<span class="token punctuation">.</span>bindv6only<span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>inet<span class="token operator">-></span>inet_num<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        inet<span class="token operator">-></span>inet_sport <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>inet<span class="token operator">-></span>inet_num<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sk<span class="token operator">-></span>sk_prot<span class="token operator">-></span><span class="token function">hash</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token operator">-></span>sk_prot<span class="token operator">-></span>init<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        err <span class="token operator">=</span> sk<span class="token operator">-></span>sk_prot<span class="token operator">-></span><span class="token function">init</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">sk_common_release</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> out<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.遍历保存在<code>inetsw6</code>的协议列表中对应type的协议结构体,赋值到answer中。对应在ipv6中的tcp协议结构体是如下：<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> inet_protosw tcpv6_protosw <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span>type        <span class="token operator">=</span>    SOCK_STREAM<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>protocol    <span class="token operator">=</span>    IPPROTO_TCP<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>prot        <span class="token operator">=</span>    <span class="token operator">&amp;</span>tcpv6_prot<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>ops        <span class="token operator">=</span>    <span class="token operator">&amp;</span>inet6_stream_ops`<span class="token punctuation">,</span>
  <span class="token punctuation">.</span>flags        <span class="token operator">=</span>    INET_PROTOSW_PERMANENT <span class="token operator">|</span>
              INET_PROTOSW_ICSK<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ul>
<p>此时<code>socket</code>结构体中的ops就被替换成了<code>inet6_stream_ops</code>,如果是v4，则是替换成<code>inet_stream_ops</code>.</p>
<ul>
<li>2.通过<code>sk_alloc</code>方法创建sock结构体，并且把<code>tcpv6_prot</code>赋值给<code>sock</code>结构体.并记录当前的协议类型，<code>sock_init_data</code>则初始化sock的的关键操作。</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">sock_init_data</span><span class="token punctuation">(</span><span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">skb_queue_head_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_receive_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">skb_queue_head_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_write_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">skb_queue_head_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_error_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_send_head    <span class="token operator">=</span>    <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_timer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_allocation    <span class="token operator">=</span>    GFP_KERNEL<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_rcvbuf        <span class="token operator">=</span>    sysctl_rmem_default<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_sndbuf        <span class="token operator">=</span>    sysctl_wmem_default<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_state        <span class="token operator">=</span>    TCP_CLOSE<span class="token punctuation">;</span>
    <span class="token function">sk_set_socket</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> sock<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">sock_set_flag</span><span class="token punctuation">(</span>sk<span class="token punctuation">,</span> SOCK_ZAPPED<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>sock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sk<span class="token operator">-></span>sk_type    <span class="token operator">=</span>    sock<span class="token operator">-></span>type<span class="token punctuation">;</span>
        sk<span class="token operator">-></span>sk_wq    <span class="token operator">=</span>    sock<span class="token operator">-></span>wq<span class="token punctuation">;</span>
        sock<span class="token operator">-></span>sk    <span class="token operator">=</span>    sk<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        sk<span class="token operator">-></span>sk_wq    <span class="token operator">=</span>    <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_dst_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rwlock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_callback_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">lockdep_set_class_and_name</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_callback_lock<span class="token punctuation">,</span>
            af_callback_keys <span class="token operator">+</span> sk<span class="token operator">-></span>sk_family<span class="token punctuation">,</span>
            af_family_clock_key_strings<span class="token punctuation">[</span>sk<span class="token operator">-></span>sk_family<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_state_change    <span class="token operator">=</span>    sock_def_wakeup<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_data_ready    <span class="token operator">=</span>    sock_def_readable<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_write_space    <span class="token operator">=</span>    sock_def_write_space<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_error_report    <span class="token operator">=</span>    sock_def_error_report<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_destruct        <span class="token operator">=</span>    sock_def_destruct<span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_frag<span class="token punctuation">.</span>page    <span class="token operator">=</span>    <span class="token constant">NULL</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_frag<span class="token punctuation">.</span>offset    <span class="token operator">=</span>    <span class="token number">0</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_peek_off        <span class="token operator">=</span>    <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_peer_pid     <span class="token operator">=</span>    <span class="token constant">NULL</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_peer_cred    <span class="token operator">=</span>    <span class="token constant">NULL</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_write_pending    <span class="token operator">=</span>    <span class="token number">0</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_rcvlowat        <span class="token operator">=</span>    <span class="token number">1</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_rcvtimeo        <span class="token operator">=</span>    MAX_SCHEDULE_TIMEOUT<span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_sndtimeo        <span class="token operator">=</span>    MAX_SCHEDULE_TIMEOUT<span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_stamp <span class="token operator">=</span> <span class="token function">ktime_set</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> CONFIG_NET_RX_BUSY_POLL</span>
    sk<span class="token operator">-></span>sk_napi_id        <span class="token operator">=</span>    <span class="token number">0</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_ll_usec        <span class="token operator">=</span>    sysctl_net_busy_read<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

    sk<span class="token operator">-></span>sk_max_pacing_rate <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0U</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_pacing_rate <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0U</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/*
     * Before updating sk_refcnt, we must commit prior changes to memory
     * (Documentation/RCU/rculist_nulls.txt for details)
     */</span>
    <span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_refcnt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sk<span class="token operator">-></span>sk_drops<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>sock_init_data<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> proto tcpv6_prot <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name            <span class="token operator">=</span> <span class="token string">"TCPv6"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>owner            <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>close            <span class="token operator">=</span> tcp_close<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>connect        <span class="token operator">=</span> tcp_v6_connect<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>disconnect        <span class="token operator">=</span> tcp_disconnect<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>accept            <span class="token operator">=</span> inet_csk_accept<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>ioctl            <span class="token operator">=</span> tcp_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>init            <span class="token operator">=</span> tcp_v6_init_sock<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>destroy        <span class="token operator">=</span> tcp_v6_destroy_sock<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>shutdown        <span class="token operator">=</span> tcp_shutdown<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>setsockopt        <span class="token operator">=</span> tcp_setsockopt<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>getsockopt        <span class="token operator">=</span> tcp_getsockopt<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>recvmsg        <span class="token operator">=</span> tcp_recvmsg<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sendmsg        <span class="token operator">=</span> tcp_sendmsg<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sendpage        <span class="token operator">=</span> tcp_sendpage<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>backlog_rcv        <span class="token operator">=</span> tcp_v6_do_rcv<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release_cb        <span class="token operator">=</span> tcp_release_cb<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>hash            <span class="token operator">=</span> tcp_v6_hash<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unhash            <span class="token operator">=</span> inet_unhash<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>get_port        <span class="token operator">=</span> inet_csk_get_port<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>enter_memory_pressure    <span class="token operator">=</span> tcp_enter_memory_pressure<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>stream_memory_free    <span class="token operator">=</span> tcp_stream_memory_free<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sockets_allocated    <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_sockets_allocated<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>memory_allocated    <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_memory_allocated<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>memory_pressure    <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_memory_pressure<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>orphan_count        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_orphan_count<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysctl_mem        <span class="token operator">=</span> sysctl_tcp_mem<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysctl_wmem        <span class="token operator">=</span> sysctl_tcp_wmem<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>sysctl_rmem        <span class="token operator">=</span> sysctl_tcp_rmem<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>max_header        <span class="token operator">=</span> MAX_TCP_HEADER<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>obj_size        <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tcp6_sock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>slab_flags        <span class="token operator">=</span> SLAB_DESTROY_BY_RCU<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>twsk_prot        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp6_timewait_sock_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>rsk_prot        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp6_request_sock_ops<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>h<span class="token punctuation">.</span>hashinfo        <span class="token operator">=</span> <span class="token operator">&amp;</span>tcp_hashinfo<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>no_autobind        <span class="token operator">=</span> true<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>3.调用了sk_prot的init方法。其实对应就是<code>tcpv6_prot</code>的init方法。</li>
</ul>
<h5 id="4-1-8-sk-alloc-创建sock结构体"><a href="#4-1-8-sk-alloc-创建sock结构体" class="headerlink" title="4.1.8.sk_alloc 创建sock结构体"></a>4.1.8.sk_alloc 创建sock结构体</h5><pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> sock <span class="token operator">*</span><span class="token function">sk_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> net <span class="token operator">*</span>net<span class="token punctuation">,</span> <span class="token keyword">int</span> family<span class="token punctuation">,</span> gfp_t priority<span class="token punctuation">,</span>
              <span class="token keyword">struct</span> proto <span class="token operator">*</span>prot<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">;</span>

    sk <span class="token operator">=</span> <span class="token function">sk_prot_alloc</span><span class="token punctuation">(</span>prot<span class="token punctuation">,</span> priority <span class="token operator">|</span> __GFP_ZERO<span class="token punctuation">,</span> family<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sk<span class="token operator">-></span>sk_family <span class="token operator">=</span> family<span class="token punctuation">;</span>
        sk<span class="token operator">-></span>sk_prot <span class="token operator">=</span> sk<span class="token operator">-></span>sk_prot_creator <span class="token operator">=</span> prot<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> sk<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>sk_alloc<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里值得注意的是sock结构体真正进行初始化的是通过 <code>sk_prot_alloc</code>，当初始化结束后，才对sock结构体中的数据进行赋值。注意在这里<code>sock</code>结构体把对应协议<code>proto</code>结构体保存在<code>sk_prot</code>字段中。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> sock <span class="token operator">*</span><span class="token function">sk_prot_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> proto <span class="token operator">*</span>prot<span class="token punctuation">,</span> gfp_t priority<span class="token punctuation">,</span>
        <span class="token keyword">int</span> family<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> kmem_cache <span class="token operator">*</span>slab<span class="token punctuation">;</span>

    slab <span class="token operator">=</span> prot<span class="token operator">-></span>slab<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>slab <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span>
        sk <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span>prot<span class="token operator">-></span>obj_size<span class="token punctuation">,</span> priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">return</span> sk<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到是通过<code>kmalloc</code>从高速缓冲区中初始化一段结构体大小为<code>obj_size</code>的内存。这个大小是什么呢？</p>
<p>实际上并非是一致暴露在我们眼中<code>sock</code>结构体而是<code>tcp6_sock</code></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token punctuation">.</span>obj_size       <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> tcp6_sock<span class="token punctuation">)</span><span class="token punctuation">,</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>只是这个结构体拥有了<code>sock</code>结构体所有的字段，且内存结构一致而直接转化成<code>sock</code>结构体.</p>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/linux/" target="_blank" rel="noopener">linux</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/linux/ipv6.h" target="_blank" rel="noopener">ipv6.h</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> tcp6_sock <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> tcp_sock      tcp<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">/* ipv6_pinfo has to be the last member of tcp6_sock, see inet6_sk_generic */</span>
    <span class="token keyword">struct</span> ipv6_pinfo inet6<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个<code>tcp6_sock</code>结构体包含了<code>tcp_sock</code> 真正包含sock结构体和一个<code>ipv6_pinfo</code> ipv6地址内容的结构体.</p>
<p>让我们继续深挖<code>tcp_sock</code>的内存结构：<br>文件：/<a href="http://androidxref.com/kernel_3.18/xref/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/linux/" target="_blank" rel="noopener">linux</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/linux/tcp.h" target="_blank" rel="noopener">tcp.h</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> tcp_sock <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* inet_connection_sock has to be the first member of tcp_sock */</span>
    <span class="token keyword">struct</span> inet_connection_sock    inet_conn<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>但是还不够清晰，继续深挖，因为可以直接无缝强转<code>sock</code>结构体必定包含这个结构体在<code>inet_connection_sock</code>中。</p>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/inet_connection_sock.h" target="_blank" rel="noopener">inet_connection_sock.h</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> inet_connection_sock <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* inet_sock has to be the first member! */</span>
    <span class="token keyword">struct</span> inet_sock      icsk_inet<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/include/" target="_blank" rel="noopener">include</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/include/net/inet_sock.h" target="_blank" rel="noopener">inet_sock.h</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> inet_sock <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">/* sk and pinet6 has to be the first two members of inet_sock */</span>
    <span class="token keyword">struct</span> sock        sk<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>终于看到了，<code>sock</code>结构体在这里。实际上这个思想想不想我们java的继承呢？只是内存结构上有一定要求而已。</p>
<p><img src="/images/sock%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84.png" alt="sock内存结构.png"></p>
<h5 id="4-1-9-tcpv6-prot-init"><a href="#4-1-9-tcpv6-prot-init" class="headerlink" title="4.1.9.tcpv6_prot init"></a>4.1.9.tcpv6_prot init</h5><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv6/" target="_blank" rel="noopener">ipv6</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv6/tcp_ipv6.c" target="_blank" rel="noopener">tcp_ipv6.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">tcp_v6_init_sock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inet_connection_sock <span class="token operator">*</span>icsk <span class="token operator">=</span> <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">tcp_init_sock</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    icsk<span class="token operator">-></span>icsk_af_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>ipv6_specific<span class="token punctuation">;</span>


    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.inet_csk 其实就是相当于把<code>sock</code>强转成<code>inet_connection_sock</code>。因为<code>inet_connection_sock</code>结构体内存结构前半段和<code>sock</code>一致，因此可以无缝转化。</p>
</li>
<li><p>2.tcp_init_sock 初始化<code>inet_connection_sock</code>结构体</p>
</li>
</ul>
<p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/" target="_blank" rel="noopener">ipv4</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/ipv4/tcp.c" target="_blank" rel="noopener">tcp.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">tcp_init_sock</span><span class="token punctuation">(</span><span class="token keyword">struct</span> sock <span class="token operator">*</span>sk<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> inet_connection_sock <span class="token operator">*</span>icsk <span class="token operator">=</span> <span class="token function">inet_csk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> tcp_sock <span class="token operator">*</span>tp <span class="token operator">=</span> <span class="token function">tcp_sk</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">__skb_queue_head_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tp<span class="token operator">-></span>out_of_order_queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tcp_init_xmit_timers</span><span class="token punctuation">(</span>sk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tcp_prequeue_init</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">INIT_LIST_HEAD</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tp<span class="token operator">-></span>tsq_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

    icsk<span class="token operator">-></span>icsk_rto <span class="token operator">=</span> TCP_TIMEOUT_INIT<span class="token punctuation">;</span>
    tp<span class="token operator">-></span>mdev_us <span class="token operator">=</span> <span class="token function">jiffies_to_usecs</span><span class="token punctuation">(</span>TCP_TIMEOUT_INIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    icsk<span class="token operator">-></span>icsk_sync_mss <span class="token operator">=</span> tcp_sync_mss<span class="token punctuation">;</span>

    sk<span class="token operator">-></span>sk_sndbuf <span class="token operator">=</span> sysctl_tcp_wmem<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    sk<span class="token operator">-></span>sk_rcvbuf <span class="token operator">=</span> sysctl_tcp_rmem<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里转化sock结构体为<code>tcp_sock</code>和<code>inet_connection_sock</code>.</p>
<p>为<code>tcp_sock</code> 设置<code>sk_buf</code>的缓存队列，设置tcp一次允许超时的时间为1000个时间钟；初始化<code>tcp_sock</code>的<code>out_of_order_queue</code>队列，初始化<code>sk_buff_head</code> scok预缓冲数据包队列</p>
<p>为<code>sock</code> 结构体设置定时器,设置之前计算好的接受和发送缓冲区的大小。</p>
<h3 id="4-2-sock-map-fd-把socket结构体和文件描述符关联起来"><a href="#4-2-sock-map-fd-把socket结构体和文件描述符关联起来" class="headerlink" title="4.2.sock_map_fd 把socket结构体和文件描述符关联起来"></a>4.2.sock_map_fd 把socket结构体和文件描述符关联起来</h3><p>文件：/<a href="http://androidxref.com/kernel_3.18/xref/net/" target="_blank" rel="noopener">net</a>/<a href="http://androidxref.com/kernel_3.18/xref/net/socket.c" target="_blank" rel="noopener">socket.c</a></p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sock_map_fd</span><span class="token punctuation">(</span><span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> file <span class="token operator">*</span>newfile<span class="token punctuation">;</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">get_unused_fd_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>

    newfile <span class="token operator">=</span> <span class="token function">sock_alloc_file</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>newfile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fd_install</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> newfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> fd<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">put_unused_fd</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>newfile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是调用了<code>sock_alloc_file</code>方法，为socket结构体创建一个file结构体。</p>
<p>在看socket对应的文件描述符的生成之前，我们需要补充如下的知识点：</p>
<pre class="line-numbers language-c"><code class="language-c">    err <span class="token operator">=</span> <span class="token function">register_filesystem</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sock_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> out_fs<span class="token punctuation">;</span>
    sock_mnt <span class="token operator">=</span> <span class="token function">kern_mount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sock_fs_type<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> file_system_type sock_fs_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span>        <span class="token string">"sockfs"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mount <span class="token operator">=</span>    sockfs_mount<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kill_sb <span class="token operator">=</span>    kill_anon_super<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>从这两个代码段，可以得知。socket模块在初始化时候会加载一个结构体为<code>file_system_type</code>。这个结构体是用于注册VFS 也就是虚拟文件系统的类型结构体。</p>
<p>这里的含义是，注册并挂载了<code>sockfs</code>虚拟文件系统。而在下面的<code>sock_alloc_file</code> 所创建的socket文件描述符就是创建在这个虚拟文件系统中。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">struct</span> file <span class="token operator">*</span><span class="token function">sock_alloc_file</span><span class="token punctuation">(</span><span class="token keyword">struct</span> socket <span class="token operator">*</span>sock<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dname<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> qstr name <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">""</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> path path<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> file <span class="token operator">*</span>file<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dname<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">.</span>name <span class="token operator">=</span> dname<span class="token punctuation">;</span>
        name<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sock<span class="token operator">-></span>sk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        name<span class="token punctuation">.</span>name <span class="token operator">=</span> sock<span class="token operator">-></span>sk<span class="token operator">-></span>sk_prot_creator<span class="token operator">-></span>name<span class="token punctuation">;</span>
        name<span class="token punctuation">.</span>len <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    path<span class="token punctuation">.</span>dentry <span class="token operator">=</span> <span class="token function">d_alloc_pseudo</span><span class="token punctuation">(</span>sock_mnt<span class="token operator">-></span>mnt_sb<span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    path<span class="token punctuation">.</span>mnt <span class="token operator">=</span> <span class="token function">mntget</span><span class="token punctuation">(</span>sock_mnt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">d_instantiate</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>dentry<span class="token punctuation">,</span> <span class="token function">SOCK_INODE</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SOCK_INODE</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token operator">-></span>i_fop <span class="token operator">=</span> <span class="token operator">&amp;</span>socket_file_ops<span class="token punctuation">;</span>

    file <span class="token operator">=</span> <span class="token function">alloc_file</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">,</span> FMODE_READ <span class="token operator">|</span> FMODE_WRITE<span class="token punctuation">,</span>
          <span class="token operator">&amp;</span>socket_file_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">/* drop dentry, keep inode */</span>
        <span class="token function">ihold</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span>dentry<span class="token operator">-></span>d_inode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">path_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> file<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sock<span class="token operator">-></span>file <span class="token operator">=</span> file<span class="token punctuation">;</span>
    file<span class="token operator">-></span>f_flags <span class="token operator">=</span> O_RDWR <span class="token operator">|</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> O_NONBLOCK<span class="token punctuation">)</span><span class="token punctuation">;</span>
    file<span class="token operator">-></span>private_data <span class="token operator">=</span> sock<span class="token punctuation">;</span>
    <span class="token keyword">return</span> file<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里面<code>sk-&gt;sk_prot_creator</code>是指<code>inet6_create</code>中调用的<code>sk_alloc</code>，在此时就是指<code>tcpv6_prot</code>.</p>
<p>注意在socket内存文件申请时候，使用socket文件系统中，对应mount挂载对象生成对应的内存文件路径。</p>
<p>核心源码如下；</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sockfs_dname</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dentry <span class="token operator">*</span>dentry<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> buflen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">dynamic_dname</span><span class="token punctuation">(</span>dentry<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> <span class="token string">"socket:[%lu]"</span><span class="token punctuation">,</span>
                dentry<span class="token operator">-></span>d_inode<span class="token operator">-></span>i_ino<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>文件名为<code>socket:[inode号]</code>。 </p>
<p>当生成了socket对应的file内存文件后，就会保存到<code>socket</code> 结构体中。</p>
<p>在Linux内核初始化时候，会初始化Socket内核模块对应的自定义文件系统(<code>file_system_type</code> )  <code>sock_fs_type</code> 结构体。</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> file_system_type sock_fs_type <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span>        <span class="token string">"sockfs"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>mount <span class="token operator">=</span>    sockfs_mount<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>kill_sb <span class="token operator">=</span>    kill_anon_super<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该结构体定义了挂载函数，文件系统名，删除数据时候对超级块的清理操作</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> super_operations sockfs_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>alloc_inode    <span class="token operator">=</span> sock_alloc_inode<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>destroy_inode    <span class="token operator">=</span> sock_destroy_inode<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>statfs        <span class="token operator">=</span> simple_statfs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这种文件系统实际上设置的就是对超级块的操作。当挂载成功后，又注册了如下的信息：</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> super_operations sockfs_ops <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>alloc_inode    <span class="token operator">=</span> sock_alloc_inode<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>destroy_inode    <span class="token operator">=</span> sock_destroy_inode<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>statfs        <span class="token operator">=</span> simple_statfs<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
 * sockfs_dname() is called from d_path().
 */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">sockfs_dname</span><span class="token punctuation">(</span><span class="token keyword">struct</span> dentry <span class="token operator">*</span>dentry<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>buffer<span class="token punctuation">,</span> <span class="token keyword">int</span> buflen<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">dynamic_dname</span><span class="token punctuation">(</span>dentry<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> <span class="token string">"socket:[%lu]"</span><span class="token punctuation">,</span>
                dentry<span class="token operator">-></span>d_inode<span class="token operator">-></span>i_ino<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> dentry_operations sockfs_dentry_operations <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span>d_dname  <span class="token operator">=</span> sockfs_dname<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> dentry <span class="token operator">*</span><span class="token function">sockfs_mount</span><span class="token punctuation">(</span><span class="token keyword">struct</span> file_system_type <span class="token operator">*</span>fs_type<span class="token punctuation">,</span>
             <span class="token keyword">int</span> flags<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_name<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">mount_pseudo</span><span class="token punctuation">(</span>fs_type<span class="token punctuation">,</span> <span class="token string">"socket:"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sockfs_ops<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>sockfs_dentry_operations<span class="token punctuation">,</span> SOCKFS_MAGIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就定义了文件目录对象操作<code>dentry_operations</code> 这里面决定了目录名为对应<code>socket:[inode]</code>号，并且设置了<code>sockfs_ops</code> 申请<code>inode</code>的操作对象。</p>
<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>到这里就聊完了客户端对应的socket是如何通过socket系统调用初始化的。能看到在创建socket的时候，内核创建的结构体嵌套层级十分多，在这里先中断源码解析流程，进行一次总结。</p>
<p>在Linux内核中，无法直接访问socket所对应的文件描述符，因为对应socket的<code>file_operation</code> 是禁止的。只能通过socket系统调用访问socket对应的socket描述符。</p>
<p>在内核启动初期，会启动socket内核模块，并挂载socket内核模块对应的文件系统。并初始化默认的协议集。</p>
<p>当Java调用了Socket.connect 方法后。一个socket对象才会开始通过<code>SocksSocketImpl</code>创建 socket对象。</p>
<p>而这个方法本质上调用还是<code>socket</code>系统调用。将会创建一个复杂且庞大的结构体。</p>
<p>不过我们需要记住一点，无论怎么变都不可能脱离七层网络协议。socket系统调用是对<code>传输层</code>，<code>网络层</code>，<code>数据链路层</code>,<code>物理层</code>的封装。那么相对的，生成出来的socket结构体也是根据这一层层的设计，进行封装的。</p>
<p>暴露在最外层的是<code>socket</code>结构体,将会根据设置的socket类型，从而找到对应的地址族以及协议类型。</p>
<p>在这个过程中<code>socket</code>结构体存在如下几个核心结构体：</p>
<ul>
<li>1.<code>sock</code> socket 持有通用的核心操作以及核心字段</li>
<li>2.<code>inet6_stream_ops</code> 则是不同协议下不同的操作行为</li>
</ul>
<p>因此整个关系如下图：</p>
<p><img src="/images/socket%E7%BB%93%E6%9E%84%E4%BD%93.png" alt="socket结构体.png"></p>
<p>在整个<code>socket</code>通信过程，暴露向外的如上层应用层，或者说是面向开发者来说是<code>socket</code>结构体。对于内核来说就是<code>sock</code>结构体。值得注意的是，这两者之间是互相持有的.<code>sock</code> 通过<code>sk_socket</code> 找到<code>socket</code>；<code>socket</code>通过<code>sk</code>找到<code>sock</code>.</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2022/04/24/android-socket-yuan-ma-jie-xi-er-socket-de-bang-ding-yu-jian-ting/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/22.jpg" class="responsive-img" alt="Android socket源码解析(二)socket的绑定与监听">
                        
                        <span class="card-title">Android socket源码解析(二)socket的绑定与监听</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言对socket在内核的设计又了初步的印象后，可以进一步的探索socket整个流程。在这里我们先讨论服务端中，如果把准备好一个socket 绑定并进行监听的。
如果遇到什么问题可以来 https://www.jianshu.com/p/6
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2022-04-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/socket/">
                        <span class="chip bg-color">socket</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/05/20/zi-jie-he-teng-xun-mian-shi-de-guo-cheng-he-gan-xiang-ji-lu-yi-you-offer/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="字节和腾讯面试的过程和感想记录(已有offer)">
                        
                        <span class="card-title">字节和腾讯面试的过程和感想记录(已有offer)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言这段时间稍微断更了一段时间，因为我在准备面试。经过两次面试后，有一些比较深刻的认识。对于大厂来说，除了对专业知识考究之外，对算法也尤为看重。
简单的说一下情况，字节已经拿到offer，腾讯所有的面面试已经通过了,也应该有offer了。字
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-05-20
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/随笔/" class="post-category">
                                    随笔
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/随笔/">
                        <span class="chip bg-color">随笔</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
