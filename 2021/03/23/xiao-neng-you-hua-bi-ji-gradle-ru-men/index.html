<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="效能优化笔记 Gradle入门, Android | Linux | Flutter">
    <meta name="description" content="前言本文将会聊聊这两周以来学习的Gradle 脚本知识点。先后阅读了Gradle in Action 以及Gradle for Android. 总的来说,Gradle in Action 从Gradle脚本起源以及构建开始聊起来，会让人对">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>效能优化笔记 Gradle入门 | yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/5.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        效能优化笔记 Gradle入门
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Gradle/">
                                <span class="chip bg-color">Gradle</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Gradle/" class="post-category">
                                Gradle
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-23
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        11.5k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        52 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文将会聊聊这两周以来学习的Gradle 脚本知识点。先后阅读了<code>Gradle in Action</code> 以及<code>Gradle for Android</code>. 总的来说,<code>Gradle in Action</code> 从Gradle脚本起源以及构建开始聊起来，会让人对<code>Gradle</code>有宏观的印象。而<code>Gradle for Android</code> 则更加倾向于<code>Android</code>开发中,<code>Gradle</code>脚本都做了什么，以及一些常用的技巧。</p>
<p>如果是新人入门，可以先阅读<code>Gradle in Action</code>.而<code>Gradle for Android</code> 我个人认为差强人意，如果是对分渠道打包等小技巧不太熟悉的入门开发者，可以阅读。但是我希望的介绍Android 编译插件<code>AppExtension</code> 的每个执行任务介绍和源码并没有介绍，着实让人遗憾。</p>
<p>我为了加强学习，我把Gradle的源码大致看了一边，发现这两本书说的都不太准确，可能还有点过时了。</p>
<p>现在结合辉哥的课程，Gradle源码以及自己的踩坑经历来总结一下Gradle的知识点。</p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><h2 id="1-Gradle-概论"><a href="#1-Gradle-概论" class="headerlink" title="1.Gradle 概论"></a>1.Gradle 概论</h2><p>Gradle为何物？Gradle 究竟和常见的构建脚本有什么区别？</p>
<p>先来看看Java老项目中，常用的构建脚本<code>Ant</code>和<code>Maven</code>。这两者都是使用XML描述整个构建逻辑。导致了维护构建代码成为了噩梦。而后Maven推出现的<code>Mojo</code>以及Ant推出的<code>Ivy</code>都是为了弥补这种问题. 然后在Maven中编写插件进行依赖是一个很麻烦的事情。</p>
<p>为了解决这些问题，并让构建工具可以拥有可读性以及更加具有表达性。以动态语言Groovy为核心的Gradle就诞生了。</p>
<h3 id="1-1Gradle-特性"><a href="#1-1Gradle-特性" class="headerlink" title="1.1Gradle 特性"></a>1.1Gradle 特性</h3><h4 id="1-1-1-可表达性的构建语言以及底层Api"><a href="#1-1-1-可表达性的构建语言以及底层Api" class="headerlink" title="1.1.1 可表达性的构建语言以及底层Api"></a>1.1.1 可表达性的构建语言以及底层Api</h4><p>摒弃XML 形式进行构建描述，转而使用动态语言构成的DSL描述Gradle脚本.</p>
<p>而对于整个构建脚本，规范了如下核心api：<br><img src="/images/gradle%E6%A0%B8%E5%BF%83api.png" alt="gradle核心api.png"></p>
<ul>
<li><p>1.project 指代整个工程的构建对象。可以通过该对象获取此次构建所有的任务，依赖，仓库，插件等。</p>
</li>
<li><p>2.RepositoryHandler 负责了对应管理依赖组件仓库</p>
</li>
<li><p>3.DependencyHandler 负责了当前项目依赖的组件</p>
</li>
<li><p>4.Task 负责当前组件中需要执行的任务</p>
</li>
<li><p>5.TaskContainer 承载了当前构建脚本的所有的任务</p>
</li>
<li><p>6.Action 是存在于Task中真正的执行逻辑。</p>
</li>
<li><p>7.ExtensionContainer 是指各种插件扩展的集合。比如在Android构建插件AppPlugin就被这个容器管理。</p>
</li>
</ul>
<p>当我们需要编写一个简单的Gradle脚本时候，只需要写好如下内容，就能完成一次简单的Gradle构建脚本编写。</p>
<pre><code>apply plugin: 'com.android.application'


buildscript {
    repositories {
        google()
        jcenter()
    }
    dependencies {
...
    }
}


android{
}


dependencies {
 ...
}</code></pre><p>而这些大括号包裹起来的，实际上就是指代project中对应对象的模块。当Gradle脚本运行时候，会从上往下的执行代码段。而这些通过括号包起来的对象，就是配置在对应插件的内容。</p>
<p>当执行到插件部分时候，就会取出括号内容进行执行。</p>
<p>比如此时就是先发现<code>apply plugin: 'com.android.application'</code>就会在project中保存好此插件，当打包流程走到了需要执行插件的时期， 就会执行Android打包的插件。</p>
<h4 id="1-1-2-Gradle-就是Groovy"><a href="#1-1-2-Gradle-就是Groovy" class="headerlink" title="1.1.2 Gradle 就是Groovy"></a>1.1.2 Gradle 就是Groovy</h4><p>Gradle本身就是通过Groovy 语言构成的。而Groovy本身也是基于JVM设计的一套字节码设计的语言。因此可以完美兼容Java，kotlin编译插件。也就是说可以完美对接壮大的Java社区。</p>
<p>基于Groovy的语言的表达性，除了在Gradle脚本中写下简易的Task任务：</p>
<pre><code>task("hello") {
    println("--- hello")
}</code></pre><p>还能创建一个Groovy文件，通过如下方式创建一个Task。</p>
<pre><code>project.getTasks().create("hello",{
            println("--- hello")
        })</code></pre><h4 id="1-1-3-灵活的约定能力"><a href="#1-1-3-灵活的约定能力" class="headerlink" title="1.1.3 灵活的约定能力"></a>1.1.3 灵活的约定能力</h4><p>Gradle脚本和Maven完全不同的是其灵活的约定能力。比如Maven很武断只允许一个工程包含一个工程源码目录以及一个jar包。而Gradle没有这种约定，完全可以通过脚本逻辑自己决定多个工程源码目录，生产多个不同jar包。</p>
<h4 id="1-1-4-强大的鲁棒和依赖管理功能"><a href="#1-1-4-强大的鲁棒和依赖管理功能" class="headerlink" title="1.1.4 强大的鲁棒和依赖管理功能"></a>1.1.4 强大的鲁棒和依赖管理功能</h4><ul>
<li><p>1.Gradle 可以做到传递性依赖，可以把依赖下来的库需要依赖的组件都依赖下来。</p>
</li>
<li><p>2.对比Maven和Ivy，当发生异常时候，就算实现相同也不能保证不同机器之间能复现这种情况。仓库可能会因为项目而改变，就算有一点点不同，缓存的依赖也会认为解析过了，导致构建失败。而Gradle所以的子模块都会当成子项目可以独立运行和构建，会找到那些需要重新构建的子模块，不需要重新构建的直接缓存在本地。</p>
</li>
</ul>
<h4 id="1-1-5-可扩展的构建"><a href="#1-1-5-可扩展的构建" class="headerlink" title="1.1.5 可扩展的构建"></a>1.1.5 可扩展的构建</h4><p>这里是指，可以轻易的对Gradle打包周期进行扩展。同时Gradle可以清楚哪一块任务是增量编译，哪一块需要重新编译。还能把功能测试，单元测试集成到构建的过程中。</p>
<p>另一点，可以编写一个插件复用于构建行为，并进行维护，发布。</p>
<h2 id="2-Gradle的生命周期"><a href="#2-Gradle的生命周期" class="headerlink" title="2.Gradle的生命周期"></a>2.Gradle的生命周期</h2><p>对Gradle有了大致印象后，来聊聊更加实际的。Gradle脚本构建生命周期。</p>
<h3 id="2-1-Gradle-构建的三大基本要素"><a href="#2-1-Gradle-构建的三大基本要素" class="headerlink" title="2.1 Gradle 构建的三大基本要素"></a>2.1 Gradle 构建的三大基本要素</h3><p>我们先抛开java或者Android的打包插件。来看看Gradle默认的构建的三大要素：</p>
<ul>
<li>1.project </li>
<li>2.task</li>
<li>3.property</li>
</ul>
<p>在这里面project可以是多项目，每个项目可以是多task，每个task可以是多个参数property。</p>
<p><img src="/images/gradle%E8%84%9A%E6%9C%AC%E5%85%83%E7%B4%A0.png" alt="gradle脚本元素.png"></p>
<p>注意我们常说的插件，依赖，仓库都隶属于项目当中。</p>
<p>除此之外，我们还经常通过定义如下，来扩展属性：</p>
<pre><code>ext{
 prop = 123
}

println project.ext.prop</code></pre><h3 id="2-2-Gradle-生命周期"><a href="#2-2-Gradle-生命周期" class="headerlink" title="2.2.Gradle 生命周期"></a>2.2.Gradle 生命周期</h3><p>在<code>Gradle in Action</code> 和<code>Gradle for Android</code>两本书中，把Gradle脚本构建大致拆分为如下三个生命周期：</p>
<ul>
<li>1.初始化</li>
<li>2.配置</li>
<li>3.执行</li>
</ul>
<p>然而，经过阅读了<code>Gradle 5.6.1</code>的源码之后，发现并不准确。实际上整个流程如下：<br><img src="/images/gradle%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" alt="gradle生命周期.png"></p>
<p>大致上可以分为如下6个阶段</p>
<ul>
<li><p>1.初始化</p>
</li>
<li><p>2.读取配置文件</p>
</li>
<li><p>3.配置项目</p>
</li>
<li><p>4.构建项目任务的执行环图</p>
</li>
<li><p>5.根据执行环图执行项目的任务</p>
</li>
<li><p>6.结束</p>
</li>
</ul>
<p>我们根据这个生命周期图，和简单的浏览一遍关键源码来看看这些周期都做了什么？</p>
<h3 id="2-2-1-构建初始化"><a href="#2-2-1-构建初始化" class="headerlink" title="2.2.1.构建初始化"></a>2.2.1.构建初始化</h3><p>有考虑过AndroidStudio是开始构建脚本的吗？可能有的人注意过，当我们命令执行开始编译，或者输入命令执行执行构建的某个的任务的时候(如GreenDao 构建Dao文件)，会输入如下类似的命令： <code>.gradlew app:clean</code>。</p>
<p>同样的，在jenkins上编写远程服务器命令脚本，需要打一个debug包，我们往往会输入如下命令:<code>.gradlew app:assembleDebug</code>。</p>
<p>那么gradlew 命令是什么东西呢？实际上就是AS在根目录下写好的一个脚本<br><img src="/images/gradlew.png" alt="gradlew.png"></p>
<p>在Linux和MacOS是指这个<code>gradlew</code>的shell脚本。Window则是指<code>gradlew.bat</code>脚本。</p>
<p>其中在<code>gradlew</code>脚本中最核心的是指下面这一段：</p>
<pre><code>eval set -- $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS "\"-Dorg.gradle.appname=$APP_BASE_NAME\"" -classpath "\"$CLASSPATH\"" org.gradle.wrapper.GradleWrapperMain "$APP_ARGS"

exec "$JAVACMD" "$@"</code></pre><ul>
<li>eval 可以把外部参数替换为本次执行命令中需要的参数</li>
<li>在eval 后接上set，代表本次shell脚本见鬼执行set命令</li>
<li>$@ 是指本次输入到脚本中所有的参数</li>
<li>exec 说明此时需要启动一个新的进程启动后面的命令<code>"$JAVACMD"  "$@"</code>。则是指启动一个进程，这个进程将会执行<code>bin/java</code>的方式执行java程序，而这个程序的入口就是<code>/gradle/wrapper/gradle-wrapper.jar</code>下的<code>org.gradle.wrapper.GradleWrapperMain</code>的main方法。</li>
</ul>
<p>如果熟悉shell编程和Gradle脚本参数的高手，完全可以修改shell脚本的命令行，让AS的编译定制化。</p>
<p>当Gradle构建进程启动后，另一个核心的事件，就是需要注册Gradle构建脚本默认的服务插件。</p>
<p>当进程启动后，会读取<code>META_INF/service</code>文件夹下的<code>org.gradle.internal.service.scopes.PluginServiceRegistry</code>文件中对应的启动插件。</p>
<pre><code>org.gradle.caching.internal.BuildCacheServices
org.gradle.internal.service.scopes.ExecutionServices
org.gradle.instantexecution.InstantExecutionServices
org.gradle.workers.internal.WorkersServices
org.gradle.api.internal.artifacts.DependencyServices
org.gradle.composite.internal.CompositeBuildServices
org.gradle.tooling.internal.provider.LauncherServices
org.gradle.plugin.internal.PluginUsePluginServiceRegistry
org.gradle.internal.resource.transport.http.HttpResourcesPluginServiceRegistry
org.gradle.vcs.internal.services.VersionControlServices
org.gradle.caching.http.internal.HttpBuildCacheServiceServices
org.gradle.buildinit.plugins.internal.services.BuildInitServices
org.gradle.api.reporting.components.internal.DiagnosticsServices
org.gradle.plugins.ide.internal.tooling.ToolingModelServices
org.gradle.plugins.ide.internal.IdeServices
org.gradle.ide.xcode.internal.services.XcodeServices
org.gradle.api.publish.ivy.internal.IvyServices
org.gradle.language.java.internal.JavaToolChainServiceRegistry
org.gradle.language.java.internal.JavaLanguagePluginServiceRegistry
org.gradle.language.jvm.internal.JvmPluginServiceRegistry
org.gradle.language.nativeplatform.internal.registry.NativeLanguageServices
org.gradle.language.scala.internal.toolchain.ScalaToolChainServiceRegistry
org.gradle.api.publish.maven.internal.MavenPublishServices
org.gradle.platform.base.internal.registry.ComponentModelBaseServiceRegistry
org.gradle.jvm.internal.services.PlatformJvmServices
org.gradle.nativeplatform.internal.services.NativeBinaryServices
org.gradle.play.internal.toolchain.PlayToolChainServiceRegistry
org.gradle.api.internal.tasks.CompileServices
org.gradle.api.plugins.internal.PluginAuthorServices
org.gradle.api.publish.internal.service.PublishServices
org.gradle.internal.resource.transport.gcp.gcs.GcsResourcesPluginServiceRegistry
org.gradle.internal.resource.transport.aws.s3.S3ResourcesPluginServiceRegistry
org.gradle.internal.resource.transport.sftp.SftpResourcesPluginServiceRegistry
org.gradle.api.internal.tasks.testing.TestingBasePluginServiceRegistry
org.gradle.jvm.test.internal.services.JvmTestingServices
org.gradle.nativeplatform.test.internal.services.NativeTestingServices
org.gradle.language.cpp.internal.tooling.ToolingNativeServices</code></pre><p>这些全局插件服务最后都会注册到<code>DefaultServiceRegistry</code>。其中最核心的就是<code>CompositeBuildServices</code> 这个服务将会生成一个<code>DefaultGradleLauncher</code>象征构建的对象。之后所有的生命周期都从<code>DefaultGradleLauncher</code>发起。</p>
<p>注意构建期间大部分的运行服务其实是由<code>BuildTreeScopeServices</code>构建的<code>BuildScopeServices</code>提供的。</p>
<p>这个流程是不是很像Android Groovy插件注册的流程。</p>
<p>注意从<code>DefaultGradleLauncher</code> 这个对象中，Gradle就严格定义了，每一个周期的行为和名字。Gradle生命周期构建生命周期指的就是如下的枚举类：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">enum</span> Stage <span class="token punctuation">{</span>
        LoadSettings<span class="token punctuation">,</span>
        Configure<span class="token punctuation">,</span>
        TaskGraph<span class="token punctuation">,</span>
        RunTasks <span class="token punctuation">{</span>
            String <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token string">"Build"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        Finished<span class="token punctuation">;</span>

        <span class="token keyword">private</span> <span class="token function">Stage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>

        String <span class="token function">getDisplayName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-2-2-读取配置文件-LoadSettings"><a href="#2-2-2-读取配置文件-LoadSettings" class="headerlink" title="2.2.2.读取配置文件(LoadSettings)"></a>2.2.2.读取配置文件(LoadSettings)</h3><p>整个构建执行入口如下：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> GradleInternal <span class="token function">executeTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doBuildStages</span><span class="token punctuation">(</span>DefaultGradleLauncher<span class="token punctuation">.</span>Stage<span class="token punctuation">.</span>RunTasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>gradle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是<code>doBuildStages</code>方法,该方法调用doClassicBuildStages：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">doClassicBuildStages</span><span class="token punctuation">(</span>DefaultGradleLauncher<span class="token punctuation">.</span>Stage upTo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>upTo <span class="token operator">!=</span> DefaultGradleLauncher<span class="token punctuation">.</span>Stage<span class="token punctuation">.</span>LoadSettings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareProjects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>upTo <span class="token operator">!=</span> DefaultGradleLauncher<span class="token punctuation">.</span>Stage<span class="token punctuation">.</span>Configure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">prepareTaskExecution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>upTo <span class="token operator">!=</span> DefaultGradleLauncher<span class="token punctuation">.</span>Stage<span class="token punctuation">.</span>TaskGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>instantExecution<span class="token punctuation">.</span><span class="token function">saveTaskGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">runWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上就是一层层的递进整个生命周期：LoadSettings -&gt; Configure -&gt; TaskGraph -&gt; RunTasks</p>
<p>在<code>LoadSettings</code> 中分别做了如下3件事情：</p>
<h4 id="2-2-2-1-加载init文件下的全局Gradle文件"><a href="#2-2-2-1-加载init文件下的全局Gradle文件" class="headerlink" title="2.2.2.1.加载init文件下的全局Gradle文件"></a>2.2.2.1.加载init文件下的全局Gradle文件</h4><p>首先，构建的时候会通过通过<code>InitScriptHandler</code>服务读取init文件夹下的gradle文件。核心代码如下：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findScripts</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>File<span class="token operator">></span> scripts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File userInitScript <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">resolveScriptFile</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userHomeDir<span class="token punctuation">,</span> <span class="token string">"init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userInitScript <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            scripts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>userInitScript<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findScriptsInDir</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userHomeDir<span class="token punctuation">,</span> <span class="token string">"init.d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">findScripts</span><span class="token punctuation">(</span>Collection<span class="token operator">&lt;</span>File<span class="token operator">></span> scripts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gradleHome <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findScriptsInDir</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gradleHome<span class="token punctuation">,</span> <span class="token string">"init.d"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> scripts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>可以看到实际上整个构成就是读取Gradle具体执行目录下的<code>init</code>文件夹和<code>init.d</code>的gradle文件。</p>
<p>如这个命令<code>gradle --init-script init.gradle clean</code>. 通过<code>--init-script</code> 参数设置全局的查找<code>init</code>文件夹下<code>.gradle</code>文件。</p>
<h4 id="2-2-2-2-查找settings-gradle"><a href="#2-2-2-2-查找settings-gradle" class="headerlink" title="2.2.2.2.查找settings.gradle"></a>2.2.2.2.查找settings.gradle</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> BuildLayout <span class="token function">getLayoutFor</span><span class="token punctuation">(</span>BuildLayoutConfiguration configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">isUseEmptySettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildLayoutFrom</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> <span class="token punctuation">(</span>File<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            File explicitSettingsFile <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getSettingsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>explicitSettingsFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>explicitSettingsFile<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MissingResourceException</span><span class="token punctuation">(</span>explicitSettingsFile<span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Could not read settings file '%s' as it does not exist."</span><span class="token punctuation">,</span> explicitSettingsFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildLayoutFrom</span><span class="token punctuation">(</span>configuration<span class="token punctuation">,</span> explicitSettingsFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                File currentDir <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">getCurrentDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">boolean</span> searchUpwards <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">isSearchUpwards</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayoutFor</span><span class="token punctuation">(</span>currentDir<span class="token punctuation">,</span> searchUpwards <span class="token operator">?</span> null <span class="token operator">:</span> currentDir<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    BuildLayout <span class="token function">getLayoutFor</span><span class="token punctuation">(</span>File currentDir<span class="token punctuation">,</span> File stopAt<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File settingsFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findExistingSettingsFileIn</span><span class="token punctuation">(</span>currentDir<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>settingsFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span>currentDir<span class="token punctuation">,</span> settingsFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>File candidate <span class="token operator">=</span> currentDir<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> candidate <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>candidate<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>stopAt<span class="token punctuation">)</span><span class="token punctuation">;</span> candidate <span class="token operator">=</span> candidate<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                settingsFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findExistingSettingsFileIn</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>settingsFile <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    settingsFile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findExistingSettingsFileIn</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> <span class="token string">"master"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>settingsFile <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span>candidate<span class="token punctuation">,</span> settingsFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span>currentDir<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>currentDir<span class="token punctuation">,</span> <span class="token string">"settings.gradle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这两段代码做了如事情：</p>
<ul>
<li><p>1.如果设置了<code>useEmptySettings</code>,说明不需要查找settings.gradle。这么样做，需要通过自己的脚本手动设置一个<code>settings.gradle</code>文件，或者在默认位置有一个。</p>
</li>
<li><p>2.如果通过<code>-c</code>或者<code>--settings-file</code> 的方式设置好了<code>settings.gradle</code> 文件也可以直接返回。</p>
</li>
<li><p>3.从当前目录不断的向上层递归查找，<code>settings.gradle</code>文件.同时<code>master</code>文件夹也在搜索范围内。</p>
</li>
</ul>
<h4 id="2-2-2-3-编译buildSrc子模块"><a href="#2-2-2-3-编译buildSrc子模块" class="headerlink" title="2.2.2.3.编译buildSrc子模块"></a>2.2.2.3.编译buildSrc子模块</h4><p>一般的，每个项目想要编译一套本项目的插件，一般都会新建一个名为<code>buildSrc</code>的文件夹。在这个文件夹中写好插件需要的<code>groovy</code>文件。这是因为在Gradle脚本中，默认一个子模块名字为<code>buildSrc</code>就是项目的编译插件。</p>
<p>在这里通过<code>DefaultSettingsPreparer</code> 的<code>prepareSettings</code>方法开始查找配置文件时候，调用的<code>findAndLoadSettings</code>方法：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> SettingsInternal <span class="token function">findSettingsAndLoadIfAppropriate</span><span class="token punctuation">(</span>GradleInternal gradle<span class="token punctuation">,</span> StartParameter startParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SettingsLocation settingsLocation <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">findSettings</span><span class="token punctuation">(</span>startParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassLoaderScope buildSourceClassLoaderScope <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>buildSourceBuilder<span class="token punctuation">.</span><span class="token function">buildAndCreateClassLoader</span><span class="token punctuation">(</span>settingsLocation<span class="token punctuation">.</span><span class="token function">getSettingsDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> startParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>settingsProcessor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>gradle<span class="token punctuation">,</span> settingsLocation<span class="token punctuation">,</span> buildSourceClassLoaderScope<span class="token punctuation">,</span> startParameter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ClassLoaderScope <span class="token function">buildAndCreateClassLoader</span><span class="token punctuation">(</span>File rootDir<span class="token punctuation">,</span> StartParameter containingBuildParameters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File buildSrcDir <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>rootDir<span class="token punctuation">,</span> <span class="token string">"buildSrc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ClassPath classpath <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createBuildSourceClasspath</span><span class="token punctuation">(</span>buildSrcDir<span class="token punctuation">,</span> containingBuildParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>classLoaderScope<span class="token punctuation">.</span><span class="token function">createChild</span><span class="token punctuation">(</span>buildSrcDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">export</span><span class="token punctuation">(</span>classpath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到此时会找到根目录下的<code>buildSrc</code>文件，组成一个ClassPath，然后进行编译。</p>
<h4 id="2-2-2-4-解析gradle-properties"><a href="#2-2-2-4-解析gradle-properties" class="headerlink" title="2.2.2.4.解析gradle.properties"></a>2.2.2.4.解析gradle.properties</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">void</span> <span class="token function">loadProperties</span><span class="token punctuation">(</span>File settingsDir<span class="token punctuation">,</span> StartParameterInternal startParameter<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> systemProperties<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> envProperties<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultProperties<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overrideProperties<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addGradleProperties</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultProperties<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>startParameter<span class="token punctuation">.</span><span class="token function">getGradleHomeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"gradle.properties"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addGradleProperties</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultProperties<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>settingsDir<span class="token punctuation">,</span> <span class="token string">"gradle.properties"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addGradleProperties</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>overrideProperties<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>startParameter<span class="token punctuation">.</span><span class="token function">getGradleUserHomeDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"gradle.properties"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setSystemProperties</span><span class="token punctuation">(</span>startParameter<span class="token punctuation">.</span><span class="token function">getSystemPropertiesArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overrideProperties<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEnvProjectProperties</span><span class="token punctuation">(</span>envProperties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overrideProperties<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSystemProjectProperties</span><span class="token punctuation">(</span>systemProperties<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>overrideProperties<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>startParameter<span class="token punctuation">.</span><span class="token function">getProjectProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在这里解析如下几种位置的<code>gradle.properties</code>:</p>
<ul>
<li>1.<code>gradle home dir</code>（gradle 具体执行文件夹） 文件夹下的<code>gradle.properties</code></li>
<li>2.<code>gradle user dir</code> （用户gradle 根目录）文件夹下的<code>gradle.properties</code></li>
<li>3.解析启动构建时候命令行设置的系统参数</li>
<li>4.解析设置在环境变量参数</li>
<li>5.解析设置在系统配置参数</li>
<li>6.解析启动构建时候命令行传进来的项目参数</li>
</ul>
<p>这也是为什么我们在不同位置设置的<code>gradle.properties</code> 参数，都能在插件运行时候生效的原因。</p>
<h4 id="2-2-2-5-解析settings-gradle"><a href="#2-2-2-5-解析settings-gradle" class="headerlink" title="2.2.2.5.解析settings.gradle"></a>2.2.2.5.解析settings.gradle</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> SettingsInternal <span class="token function">process</span><span class="token punctuation">(</span>GradleInternal gradle<span class="token punctuation">,</span>
                                SettingsLocation settingsLocation<span class="token punctuation">,</span>
                                ClassLoaderScope buildRootClassLoaderScope<span class="token punctuation">,</span>
                                StartParameter startParameter<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span> properties <span class="token operator">=</span> propertiesLoader<span class="token punctuation">.</span><span class="token function">mergeProperties</span><span class="token punctuation">(</span>Collections<span class="token punctuation">.</span>&lt;String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token function">emptyMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    TextResourceScriptSource settingsScript <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextResourceScriptSource</span><span class="token punctuation">(</span>textResourceLoader<span class="token punctuation">.</span><span class="token function">loadFile</span><span class="token punctuation">(</span><span class="token string">"settings file"</span><span class="token punctuation">,</span> settingsLocation<span class="token punctuation">.</span><span class="token function">getSettingsFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SettingsInternal settings <span class="token operator">=</span> settingsFactory<span class="token punctuation">.</span><span class="token function">createSettings</span><span class="token punctuation">(</span>gradle<span class="token punctuation">,</span> settingsLocation<span class="token punctuation">.</span><span class="token function">getSettingsDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> settingsScript<span class="token punctuation">,</span> properties<span class="token punctuation">,</span> startParameter<span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">applySettingsScript</span><span class="token punctuation">(</span>settingsScript<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> settings<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当找到所有的数据后就会合并参数，生成 <code>DefaultSettings</code>对象并保存其中。</p>
<h3 id="2-2-3-配置生成Project对象（Config）"><a href="#2-2-3-配置生成Project对象（Config）" class="headerlink" title="2.2.3. 配置生成Project对象（Config）"></a>2.2.3. 配置生成Project对象（Config）</h3><h4 id="2-2-3-1-根据settings-gradle生成Project对象"><a href="#2-2-3-1-根据settings-gradle生成Project对象" class="headerlink" title="2.2.3.1 根据settings.gradle生成Project对象"></a>2.2.3.1 根据settings.gradle生成Project对象</h4><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span>SettingsInternal settings<span class="token punctuation">,</span> GradleInternal gradle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getRootProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> settings<span class="token punctuation">.</span><span class="token function">getDefaultProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> settings<span class="token punctuation">.</span><span class="token function">getRootClassLoaderScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span>ProjectDescriptor rootProjectDescriptor<span class="token punctuation">,</span> ProjectDescriptor defaultProject<span class="token punctuation">,</span> GradleInternal gradle<span class="token punctuation">,</span> ClassLoaderScope buildRootClassLoaderScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createProjects</span><span class="token punctuation">(</span>rootProjectDescriptor<span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">attachDefaultProject</span><span class="token punctuation">(</span>defaultProject<span class="token punctuation">,</span> gradle<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attachDefaultProject</span><span class="token punctuation">(</span>ProjectDescriptor defaultProject<span class="token punctuation">,</span> GradleInternal gradle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        gradle<span class="token punctuation">.</span><span class="token function">setDefaultProject</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ProjectInternal<span class="token punctuation">)</span>gradle<span class="token punctuation">.</span><span class="token function">getRootProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProjectRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getProject</span><span class="token punctuation">(</span>defaultProject<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createProjects</span><span class="token punctuation">(</span>ProjectDescriptor rootProjectDescriptor<span class="token punctuation">,</span> GradleInternal gradle<span class="token punctuation">,</span> ClassLoaderScope buildRootClassLoaderScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        ProjectInternal rootProject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectFactory<span class="token punctuation">.</span><span class="token function">createProject</span><span class="token punctuation">(</span>rootProjectDescriptor<span class="token punctuation">,</span> <span class="token punctuation">(</span>ProjectInternal<span class="token punctuation">)</span>null<span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">.</span><span class="token function">createChild</span><span class="token punctuation">(</span><span class="token string">"root-project"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        gradle<span class="token punctuation">.</span><span class="token function">setRootProject</span><span class="token punctuation">(</span>rootProject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addProjects</span><span class="token punctuation">(</span>rootProject<span class="token punctuation">,</span> rootProjectDescriptor<span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addProjects</span><span class="token punctuation">(</span>ProjectInternal parent<span class="token punctuation">,</span> ProjectDescriptor parentProjectDescriptor<span class="token punctuation">,</span> GradleInternal gradle<span class="token punctuation">,</span> ClassLoaderScope buildRootClassLoaderScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Iterator var5 <span class="token operator">=</span> parentProjectDescriptor<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var5<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ProjectDescriptor childProjectDescriptor <span class="token operator">=</span> <span class="token punctuation">(</span>ProjectDescriptor<span class="token punctuation">)</span>var5<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ProjectInternal childProject <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>projectFactory<span class="token punctuation">.</span><span class="token function">createProject</span><span class="token punctuation">(</span>childProjectDescriptor<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> parent<span class="token punctuation">.</span><span class="token function">getClassLoaderScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createChild</span><span class="token punctuation">(</span><span class="token string">"project-"</span> <span class="token operator">+</span> childProjectDescriptor<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addProjects</span><span class="token punctuation">(</span>childProject<span class="token punctuation">,</span> childProjectDescriptor<span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> buildRootClassLoaderScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个过程就是从settings.gradle 文件中取出所有的项目，通过<code>projectFactory.createProject</code>生成一个新的<code>project</code>对象，最后<code>addProjects</code>保存起来。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> DefaultProject <span class="token function">createProject</span><span class="token punctuation">(</span>ProjectDescriptor projectDescriptor<span class="token punctuation">,</span> ProjectInternal parent<span class="token punctuation">,</span> GradleInternal gradle<span class="token punctuation">,</span> ClassLoaderScope selfClassLoaderScope<span class="token punctuation">,</span> ClassLoaderScope baseClassLoaderScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        File buildFile <span class="token operator">=</span> projectDescriptor<span class="token punctuation">.</span><span class="token function">getBuildFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        TextResource resource <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resourceLoader<span class="token punctuation">.</span><span class="token function">loadFile</span><span class="token punctuation">(</span><span class="token string">"build file"</span><span class="token punctuation">,</span> buildFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ScriptSource source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TextResourceScriptSource</span><span class="token punctuation">(</span>resource<span class="token punctuation">)</span><span class="token punctuation">;</span>
        DefaultProject project <span class="token operator">=</span> <span class="token punctuation">(</span>DefaultProject<span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>instantiator<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span>DefaultProject<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>projectDescriptor<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> parent<span class="token punctuation">,</span> projectDescriptor<span class="token punctuation">.</span><span class="token function">getProjectDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> buildFile<span class="token punctuation">,</span> source<span class="token punctuation">,</span> gradle<span class="token punctuation">,</span> gradle<span class="token punctuation">.</span><span class="token function">getServiceRegistryFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> selfClassLoaderScope<span class="token punctuation">,</span> baseClassLoaderScope<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        project<span class="token punctuation">.</span><span class="token function">beforeEvaluate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Action</span><span class="token operator">&lt;</span>Project<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                NameValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>project<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"project name"</span><span class="token punctuation">,</span> DefaultProjectDescriptor<span class="token punctuation">.</span>INVALID_NAME_IN_INCLUDE_HINT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            parent<span class="token punctuation">.</span><span class="token function">addChildProject</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>projectRegistry<span class="token punctuation">.</span><span class="token function">addProject</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> project<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>而这个过程就是通过settings找到对应子模块以及对应子模块的<code>build.gradle</code>位置，并创建<code>DefaultProject</code>对象，并添加到需要依赖的父项目中。最后注册到<code>ProjectRegistry</code>中。</p>
<h3 id="2-2-4-构建项目任务的执行环图-TaskGraph"><a href="#2-2-4-构建项目任务的执行环图-TaskGraph" class="headerlink" title="2.2.4.构建项目任务的执行环图(TaskGraph)"></a>2.2.4.构建项目任务的执行环图(TaskGraph)</h3><p>在这个过程中为，我分为2个阶段：</p>
<ul>
<li>1.根据settings遍历所有的子模块，生成每个模块对应Project对象</li>
<li>2.根据任务之间的依赖生成一个任务，项目有向无环图。</li>
</ul>
<h4 id="2-2-4-1-根据任务之间的依赖生成一个任务，项目有向无环图"><a href="#2-2-4-1-根据任务之间的依赖生成一个任务，项目有向无环图" class="headerlink" title="2.2.4.1 根据任务之间的依赖生成一个任务，项目有向无环图"></a>2.2.4.1 根据任务之间的依赖生成一个任务，项目有向无环图</h4><p>整个构建的核心对象，是通过<code>GradleScopeServices</code>生成的</p>
<pre class="line-numbers language-java"><code class="language-java">BuildConfigurationActionExecuter <span class="token function">createBuildConfigurationActionExecuter</span><span class="token punctuation">(</span>CommandLineTaskParser commandLineTaskParser<span class="token punctuation">,</span> TaskSelector taskSelector<span class="token punctuation">,</span> ProjectConfigurer projectConfigurer<span class="token punctuation">,</span> ProjectStateRegistry projectStateRegistry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    List<span class="token operator">&lt;</span>BuildConfigurationAction<span class="token operator">></span> taskSelectionActions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token operator">&lt;</span>BuildConfigurationAction<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加 DefaultTasksBuildExecutionAction</span>
    taskSelectionActions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultTasksBuildExecutionAction</span><span class="token punctuation">(</span>projectConfigurer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加 TaskNameResolvingBuildConfigurationAction</span>
    taskSelectionActions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TaskNameResolvingBuildConfigurationAction</span><span class="token punctuation">(</span>commandLineTaskParser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 添加 ExcludedTaskFilteringBuildConfigurationAction</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultBuildConfigurationActionExecuter</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ExcludedTaskFilteringBuildConfigurationAction</span><span class="token punctuation">(</span>taskSelector<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> taskSelectionActions<span class="token punctuation">,</span> projectStateRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心对象为：</p>
<ul>
<li><ol>
<li>ExcludedTaskFilteringBuildConfigurationAction 通过 <code>-x</code> 或者 <code>--exclude-task</code> 制定好Task添加到任务集合中。</li>
</ol>
</li>
<li><ol start="2">
<li>DefaultTasksBuildExecutionAction 如果没有设定制定执行任务，就会设置默认的任务执行，并且传递启动进程时候的构建参数</li>
</ol>
</li>
<li><ol start="3">
<li>TaskNameResolvingBuildConfigurationAction  此时会解析每个模块中所有任务(把<code>app:clean</code> 拆分成app模块到clean任务)，并分析所有任务的依赖关系放到<code>TaskGraph</code>容器中</li>
</ol>
</li>
</ul>
<h3 id="2-2-5-执行任务-RunTasks"><a href="#2-2-5-执行任务-RunTasks" class="headerlink" title="2.2.5.执行任务( RunTasks)"></a>2.2.5.执行任务( RunTasks)</h3><p>核心入口是<code>DefaultGradleLauncher</code>的<code>runWork</code>方法</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>stage <span class="token operator">!=</span> DefaultGradleLauncher<span class="token punctuation">.</span>Stage<span class="token punctuation">.</span>TaskGraph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Cannot execute tasks: current stage = "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            List<span class="token operator">&lt;</span>Throwable<span class="token operator">></span> taskFailures <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>buildExecuter<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>gradle<span class="token punctuation">,</span> taskFailures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>taskFailures<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MultipleBuildFailures</span><span class="token punctuation">(</span>taskFailures<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>stage <span class="token operator">=</span> DefaultGradleLauncher<span class="token punctuation">.</span>Stage<span class="token punctuation">.</span>RunTasks<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">    BuildWorkExecutor <span class="token function">createBuildExecuter</span><span class="token punctuation">(</span>StyledTextOutputFactory textOutputFactory<span class="token punctuation">,</span> IncludedBuildControllers includedBuildControllers<span class="token punctuation">,</span> BuildOperationExecutor buildOperationExecutor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BuildOperationFiringBuildWorkerExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">IncludedBuildLifecycleBuildWorkExecutor</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultBuildWorkExecutor</span><span class="token punctuation">(</span>Arrays<span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DryRunBuildExecutionAction</span><span class="token punctuation">(</span>textOutputFactory<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SelectedTaskExecutionAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> includedBuildControllers<span class="token punctuation">)</span><span class="token punctuation">,</span> buildOperationExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>最终通过<code>BuildWorkExecutor</code>开始执行所有的任务。可以看到实际上返回的是<code>BuildOperationFiringBuildWorkerExecutor</code>对象。而这个对象实际上是一个门面对象，包含了执行任务之前的预处理，以及任务的执行。</p>
<p>在这个过程中做了如下几件事情：</p>
<ul>
<li>1.处理<code>--dry-run</code>命令</li>
<li>2.执行任务的预处理</li>
<li>3.开启线程执行任务</li>
</ul>
<h4 id="2-2-5-1-处理-dry-run命令"><a href="#2-2-5-1-处理-dry-run命令" class="headerlink" title="2.2.5.1.处理--dry-run命令"></a>2.2.5.1.处理<code>--dry-run</code>命令</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>BuildExecutionContext context<span class="token punctuation">,</span> Collection<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> Throwable<span class="token operator">></span> taskFailures<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        GradleInternal gradle <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getGradle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>gradle<span class="token punctuation">.</span><span class="token function">getStartParameter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDryRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Iterator var4 <span class="token operator">=</span> gradle<span class="token punctuation">.</span><span class="token function">getTaskGraph</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAllTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                Task task <span class="token operator">=</span> <span class="token punctuation">(</span>Task<span class="token punctuation">)</span>var4<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>textOutputFactory
                    <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>DryRunBuildExecutionAction<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>TaskInternal<span class="token punctuation">)</span>task<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">getIdentityPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">style</span><span class="token punctuation">(</span>Style<span class="token punctuation">.</span>ProgressStatus<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"SKIPPED"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            context<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程能看到如果构建启动带上了<code>--dry-run</code>参数。能看到此时跳过了所有的任务，直接往后执行。</p>
<p>换句话说，当我们需要快速配置项目，比如说第一次加载工程时候。不想要依赖和构建工程，完全可以使用这个命令跳过这些任务，减少执行时间。</p>
<h5 id="2-2-5-2-任务的预处理"><a href="#2-2-5-2-任务的预处理" class="headerlink" title="2.2.5.2.任务的预处理"></a>2.2.5.2.任务的预处理</h5><pre class="line-numbers language-java"><code class="language-java">TaskExecuter <span class="token function">createTaskExecuter</span><span class="token punctuation">(</span>TaskExecutionModeResolver repository<span class="token punctuation">,</span>
                                BuildCacheController buildCacheController<span class="token punctuation">,</span>
                                TaskInputsListener inputsListener<span class="token punctuation">,</span>
                                TaskActionListener actionListener<span class="token punctuation">,</span>
                                OutputChangeListener outputChangeListener<span class="token punctuation">,</span>
                                ClassLoaderHierarchyHasher classLoaderHierarchyHasher<span class="token punctuation">,</span>
                                TaskSnapshotter taskSnapshotter<span class="token punctuation">,</span>
                                FileCollectionFingerprinterRegistry fingerprinterRegistry<span class="token punctuation">,</span>
                                BuildOperationExecutor buildOperationExecutor<span class="token punctuation">,</span>
                                AsyncWorkTracker asyncWorkTracker<span class="token punctuation">,</span>
                                BuildOutputCleanupRegistry cleanupRegistry<span class="token punctuation">,</span>
                                ExecutionHistoryStore executionHistoryStore<span class="token punctuation">,</span>
                                OutputFilesRepository outputFilesRepository<span class="token punctuation">,</span>
                                BuildScanPluginApplied buildScanPlugin<span class="token punctuation">,</span>
                                FileCollectionFactory fileCollectionFactory<span class="token punctuation">,</span>
                                PropertyWalker propertyWalker<span class="token punctuation">,</span>
                                TaskExecutionGraphInternal taskExecutionGraph<span class="token punctuation">,</span>
                                TaskExecutionListener taskExecutionListener<span class="token punctuation">,</span>
                                TaskListenerInternal taskListenerInternal<span class="token punctuation">,</span>
                                TaskCacheabilityResolver taskCacheabilityResolver<span class="token punctuation">,</span>
                                WorkExecutor<span class="token operator">&lt;</span>AfterPreviousExecutionContext<span class="token punctuation">,</span> CachingResult<span class="token operator">></span> workExecutor<span class="token punctuation">,</span>
                                ReservedFileSystemLocationRegistry reservedFileSystemLocationRegistry<span class="token punctuation">,</span>
                                ListenerManager listenerManager
<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">boolean</span> buildCacheEnabled <span class="token operator">=</span> buildCacheController<span class="token punctuation">.</span><span class="token function">isEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> scanPluginApplied <span class="token operator">=</span> buildScanPlugin<span class="token punctuation">.</span><span class="token function">isBuildScanPluginApplied</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 这个 executer 才是真正执行 task 的</span>
    TaskExecuter executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecuteActionsTaskExecuter</span><span class="token punctuation">(</span>
        buildCacheEnabled<span class="token punctuation">,</span>
        scanPluginApplied<span class="token punctuation">,</span>
        taskSnapshotter<span class="token punctuation">,</span>
        executionHistoryStore<span class="token punctuation">,</span>
        buildOperationExecutor<span class="token punctuation">,</span>
        asyncWorkTracker<span class="token punctuation">,</span>
        actionListener<span class="token punctuation">,</span>
        taskCacheabilityResolver<span class="token punctuation">,</span>
        fingerprinterRegistry<span class="token punctuation">,</span>
        classLoaderHierarchyHasher<span class="token punctuation">,</span>
        workExecutor<span class="token punctuation">,</span>
        listenerManager
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 下面这些都是装饰</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ValidatingTaskExecuter</span><span class="token punctuation">(</span>executer<span class="token punctuation">,</span> reservedFileSystemLocationRegistry<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipEmptySourceFilesTaskExecuter</span><span class="token punctuation">(</span>inputsListener<span class="token punctuation">,</span> executionHistoryStore<span class="token punctuation">,</span> cleanupRegistry<span class="token punctuation">,</span> outputChangeListener<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolveBeforeExecutionOutputsTaskExecuter</span><span class="token punctuation">(</span>taskSnapshotter<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buildCacheEnabled <span class="token operator">||</span> scanPluginApplied<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StartSnapshotTaskInputsBuildOperationTaskExecuter</span><span class="token punctuation">(</span>buildOperationExecutor<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolveAfterPreviousExecutionStateTaskExecuter</span><span class="token punctuation">(</span>executionHistoryStore<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CleanupStaleOutputsExecuter</span><span class="token punctuation">(</span>cleanupRegistry<span class="token punctuation">,</span> outputFilesRepository<span class="token punctuation">,</span> buildOperationExecutor<span class="token punctuation">,</span> outputChangeListener<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FinalizePropertiesTaskExecuter</span><span class="token punctuation">(</span>executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ResolveTaskExecutionModeExecuter</span><span class="token punctuation">(</span>repository<span class="token punctuation">,</span> fileCollectionFactory<span class="token punctuation">,</span> propertyWalker<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipTaskWithNoActionsExecuter</span><span class="token punctuation">(</span>taskExecutionGraph<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SkipOnlyIfTaskExecuter</span><span class="token punctuation">(</span>executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CatchExceptionTaskExecuter</span><span class="token punctuation">(</span>executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    executer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventFiringTaskExecuter</span><span class="token punctuation">(</span>buildOperationExecutor<span class="token punctuation">,</span> taskExecutionListener<span class="token punctuation">,</span> taskListenerInternal<span class="token punctuation">,</span> executer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> executer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>任务执行器通过装饰者设计层层包装。</p>
<p>ExecuteActionsTaskExecuter 为真正执行Task任务对象</p>
<p>接下来就从最外层的核心嵌套装饰者开始介绍</p>
<ul>
<li>1.EventFiringTaskExecuter 回调一个构建之前的监听</li>
<li>2.CatchExceptionTaskExecuter 为这个任务添加<code>try -catch</code></li>
<li>3.SkipOnlyIfTaskExecuter 判断到在task中设置<code>onlyif</code>方法，根据该boolean方法判断当前的Task是否跳过。</li>
<li>4.SkipTaskWithNoActionsExecuter 跳过那些通过<code>dry-run</code>之类的方法，蒋设置为<code>skip</code>的任务</li>
<li>5.ResolveTaskExecutionModeExecuter 解析Task属性，如输出和输出。获取Task的<code>Execution Mode</code>执行模式。执行模式决定了当前的Task是否加载缓存代替执行任务，决定是否记录缓存。</li>
<li><ol start="6">
<li>SkipEmptySourceFilesTaskExecuter 跳过那些没有任何输入文件的任务</li>
</ol>
</li>
<li>7.ValidatingTaskExecuter 对Task的属性进行校验</li>
</ul>
<h4 id="2-2-5-3-执行任务"><a href="#2-2-5-3-执行任务" class="headerlink" title="2.2.5.3.执行任务"></a>2.2.5.3.执行任务</h4><p>核心是<code>TaskExecution</code> 中的<code>execute</code> 方法</p>
<pre class="line-numbers language-java"><code class="language-java">        <span class="token keyword">public</span> WorkResult <span class="token function">execute</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Nullable</span> InputChangesInternal inputChanges<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            WorkResult var2<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                ExecuteActionsTaskExecuter<span class="token punctuation">.</span>LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Executing actions for {}."</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ExecuteActionsTaskExecuter<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>actionListener<span class="token punctuation">.</span><span class="token function">beforeActions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
                ExecuteActionsTaskExecuter<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeActions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">,</span> inputChanges<span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDidWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> WorkResult<span class="token punctuation">.</span>DID_WORK <span class="token operator">:</span> WorkResult<span class="token punctuation">.</span>DID_NO_WORK<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setExecuting</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ExecuteActionsTaskExecuter<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>actionListener<span class="token punctuation">.</span><span class="token function">afterActions</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> var2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.会回调执行钱的监听</li>
<li>2.executeActions 会执行Task中的Action中的execute方法。</li>
<li>3.为当前的任务打上标识位。</li>
</ul>
<h3 id="2-2-6-结束"><a href="#2-2-6-结束" class="headerlink" title="2.2.6 结束"></a>2.2.6 结束</h3><p>实际上很简单，没做什么事情就是回调构建结束的监听。</p>
<h4 id="2-2-7-总结"><a href="#2-2-7-总结" class="headerlink" title="2.2.7.总结"></a>2.2.7.总结</h4><p>实际上在Gradle脚本中我们可以为上面6个生命周期添加监听。如下图：<br><img src="/images/gradle%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E7%9B%91%E5%90%AC.png" alt="gradle生命周期监听.png"></p>
<h2 id="3-Groovy和build-gradle-之间的关系"><a href="#3-Groovy和build-gradle-之间的关系" class="headerlink" title="3.Groovy和build.gradle 之间的关系"></a>3.Groovy和build.gradle 之间的关系</h2><p>本文将不会聊太多的Groovy的语法。关于Groovy的语法，如果熟悉kotlin的是十分容易上手的。</p>
<p>能看到在生命周期中，通过<code>settings.gradle</code>找到每个子模块的<code>build.gradle</code>文件。并且会尝试着在Config的过程中，找到Project后，并执行每一个子项目的<code>build.gradle</code>文件。</p>
<p>虽然表现形式不同，文件后缀不同，但是<code>build.gradle</code>的确是一个<code>groovy</code>的脚本。之所以可以表现出如此洁净的方式，也得益于Groovy的闭包设计。</p>
<p>那么问题来了。<code>build.gradle</code>是如何执行，才能让<code>build.gradle</code>文件和Gradle构建联系到一起呢？</p>
<p>先来看看一个简单<code>build.gradle</code>脚本：</p>
<pre class="line-numbers language-java"><code class="language-java">apply plugin<span class="token operator">:</span> <span class="token string">'com.android.application'</span>
apply plugin<span class="token operator">:</span> <span class="token string">'kotlin-android'</span>
apply plugin<span class="token operator">:</span> <span class="token string">'kotlin-android-extensions'</span>
apply plugin<span class="token operator">:</span> <span class="token string">'com.image.monitor'</span>

android <span class="token punctuation">{</span>
    compileSdkVersion <span class="token number">30</span>
    buildToolsVersion <span class="token string">"30.0.2"</span>

    defaultConfig <span class="token punctuation">{</span>
        applicationId <span class="token string">"com.yjy.gradletest"</span>
        minSdkVersion <span class="token number">21</span>
        targetSdkVersion <span class="token number">30</span>
        versionCode <span class="token number">1</span>
        versionName <span class="token string">"1.0"</span>

        testInstrumentationRunner <span class="token string">"androidx.test.runner.AndroidJUnitRunner"</span>

    <span class="token punctuation">}</span>

    buildTypes <span class="token punctuation">{</span>
        release <span class="token punctuation">{</span>
            minifyEnabled <span class="token boolean">false</span>
            proguardFiles <span class="token function">getDefaultProguardFile</span><span class="token punctuation">(</span><span class="token string">'proguard-android-optimize.txt'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'proguard-rules.pro'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    compileOptions <span class="token punctuation">{</span>
        sourceCompatibility <span class="token number">1.8</span>
        targetCompatibility <span class="token number">1.8</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">task</span><span class="token punctuation">(</span><span class="token string">"hello"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--- hello"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


dependencies <span class="token punctuation">{</span>
    implementation <span class="token function">fileTree</span><span class="token punctuation">(</span>dir<span class="token operator">:</span> <span class="token string">"libs"</span><span class="token punctuation">,</span> include<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"*.jar"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    implementation <span class="token string">"org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"</span>
    implementation <span class="token string">'androidx.core:core-ktx:1.1.0'</span>
    implementation <span class="token string">'androidx.appcompat:appcompat:1.1.0'</span>
    implementation <span class="token string">'androidx.constraintlayout:constraintlayout:2.0.4'</span>
    testImplementation <span class="token string">'junit:junit:4.12'</span>
    androidTestImplementation <span class="token string">'androidx.test.ext:junit:1.1.2'</span>
    androidTestImplementation <span class="token string">'androidx.test.espresso:espresso-core:3.3.0'</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这里面有了一个Android模块构建的基本要素：</p>
<ul>
<li><code>android</code> 构建插件</li>
<li>自定义插件</li>
<li><code>android</code> 构建插件</li>
<li>依赖</li>
</ul>
<p>这种写法也必定可以转化为<code>.groovy</code>后缀的文件写法。但是这样不直观，我们可以直接看看build.gradle 转化的class文件就能一目了然整个<code>build.gradle</code>是如何执行的。</p>
<p>我们可以下载安装groovy环境，并调用命令<code>groovyc classes build.gradle</code>。把上述<code>build.gradle</code>文件转化为下面直观的class文件：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">build</span> <span class="token keyword">extends</span> <span class="token class-name">Script</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token function">build</span><span class="token punctuation">(</span>Binding context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>InvokerHelper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> build<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> Object <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"com.android.application"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"kotlin-android"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"kotlin-android-extensions"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"com.image.monitor"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_run_closure1</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token function">_run_closure1</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"30.0.2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure4</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token function">_closure4</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"com.yjy.gradletest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.test.runner.AndroidJUnitRunner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Generated</span>
                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure4</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure5</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token function">_closure5</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure7</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                            <span class="token keyword">public</span> <span class="token function">_closure7</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"proguard-android-optimize.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"proguard-rules.pro"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token annotation punctuation">@Generated</span>
                            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure7</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Generated</span>
                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                var2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure5</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure6</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token function">_closure6</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $<span class="token keyword">const</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $<span class="token keyword">const</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Generated</span>
                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">static</span> <span class="token punctuation">{</span>
                        __$<span class="token function">swapInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure6</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Generated</span>
            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        var1<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_run_closure1</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_run_closure2</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token function">_run_closure2</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"--- hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Generated</span>
            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        var1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"hello"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_run_closure2</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_run_closure3</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token function">_run_closure3</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"dir"</span><span class="token punctuation">,</span> <span class="token string">"libs"</span><span class="token punctuation">,</span> <span class="token string">"include"</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"*.jar"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">GStringImpl</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>var2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callGroovyObjectGetProperty</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"org.jetbrains.kotlin:kotlin-stdlib:"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.core:core-ktx:1.1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.appcompat:appcompat:1.1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.constraintlayout:constraintlayout:2.0.4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"junit:junit:4.12"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.test.ext:junit:1.1.2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.test.espresso:espresso-core:3.3.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Generated</span>
            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> var1<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_run_closure3</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上<code>build.gradle</code> 文件整体是一个带着<code>main</code>函数的，且继承于<code>Script</code>的<code>build</code>类。</p>
<p>在Config阶段时候，构建完Project对象后，就会通过读取build.gradle文件的每一行数据，转化成类似上述的<code>class</code>文件。</p>
<h4 id="3-0-CallSite机制的介绍"><a href="#3-0-CallSite机制的介绍" class="headerlink" title="3.0. CallSite机制的介绍"></a>3.0. CallSite机制的介绍</h4><p>在这个class文件中，很难看到有对象直接调用方法。取而代之的是通过<code>$getCallSiteArray</code> 方法间接的调用方法。</p>
<p>这种机制在Groovy脚本中成为<code>CallSite</code> 机制。 本质是是为了解决JVM 实现动态语言慢的原因。因为JVM的方法执行等都是静态编译完成的，几乎所有信息在编译阶段都能获得，这样就造成了基于JVM 实现的动态语言缓慢的原因之一。</p>
<p>为了解决这个问题，在<code>Groovy 1.6</code> 之后，就引入<code>CallSite</code> 机制。实际上就是通过反射等方式调用方法。获得一个方法下对应类型参数的执行结果缓存。也不会在编译阶段就绑定好方法和方法描述符之间的关系。而是等到运行时候在确定。</p>
<p>用通俗一点的话，就是每一行的执行都通过反射参数的方式进行占位，只有等到运行时候才能确定真正运行对象。</p>
<h4 id="3-1-build-gradle-的执行入口"><a href="#3-1-build-gradle-的执行入口" class="headerlink" title="3.1.build.gradle 的执行入口"></a>3.1.build.gradle 的执行入口</h4><p>在这个类中，会调用main方法的核心方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>InvokerHelper<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> build<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上这里调用的是<code>InvokerHelper</code>的<code>runScript</code>方法。这个方法会构建一个构建根据传入的<code>build</code>类构建<code>build</code>对象，并反射调用run方法。</p>
<h4 id="3-2-build-gradle的构建内容"><a href="#3-2-build-gradle的构建内容" class="headerlink" title="3.2.build.gradle的构建内容"></a>3.2.build.gradle的构建内容</h4><p>在<code>build.gradle</code> 转化的class文件中可以分为3个闭包对象，以及设置插件部分。</p>
<h5 id="3-2-1-设置插件部分与执行插件原理"><a href="#3-2-1-设置插件部分与执行插件原理" class="headerlink" title="3.2.1.设置插件部分与执行插件原理"></a>3.2.1.设置插件部分与执行插件原理</h5><pre class="line-numbers language-java"><code class="language-java">        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"com.android.application"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"kotlin-android"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"kotlin-android-extensions"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        var1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScriptBytecodeAdapter<span class="token punctuation">.</span><span class="token function">createMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token string">"plugin"</span><span class="token punctuation">,</span> <span class="token string">"com.image.monitor"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这一部分实际上做的是，调用了<code>DefaultProject</code> 的<code>apply</code>方法。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span> options<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        DefaultObjectConfigurationAction action <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createObjectConfigurationAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ConfigureUtil<span class="token punctuation">.</span><span class="token function">configureByMap</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
        action<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会生成<code>DefaultObjectConfigurationAction</code> 对象，并以当前map的key为索引找到<code>DefaultObjectConfigurationAction</code>对应的方法，把Map的的value注入进去。</p>
<p>比如在这里，我们设置了一个Android构建插件<code>com.android.application</code>.此时会生成一个<code>DefaultObjectConfigurationAction</code>  对象。而在这个对象中，存在如下一个<code>plugin</code>方法。此时<code>ConfigureUtil.configureByMap</code> 就会反射该方法，并把<code>com.android.application</code> 为参数反射该方法。</p>
<p>并添加到<code>DefaultObjectConfigurationAction</code>准备执行<code>actions</code> 队列中。等到后续的时机在通过这个<code>Runnable</code>对象，执行到Android构建插件中。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> ObjectConfigurationAction <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token keyword">final</span> String pluginId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>actions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                DefaultObjectConfigurationAction<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">applyType</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当<code>configureByMap</code>执行结束后，就会执行<code>DefaultObjectConfigurationAction</code>的<code>execute</code>方法执行actions的准备执行队列，在这里执行的是<code>applyType</code>方法。</p>
<p>每一个String类型的插件，都会先从缓存查找是否缓存了对应字符串对应的插件类对象。会把每一个插件对应的缓存类都缓存到<code>idMappings</code>中，如下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">this</span><span class="token punctuation">.</span>idMappings <span class="token operator">=</span> CacheBuilder<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token operator">&lt;</span>DefaultPluginRegistry<span class="token punctuation">.</span>PluginIdLookupCacheKey<span class="token punctuation">,</span> Optional<span class="token operator">&lt;</span>PluginImplementation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>>></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> Optional<span class="token operator">&lt;</span>PluginImplementation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">>></span> <span class="token function">load</span><span class="token punctuation">(</span>DefaultPluginRegistry<span class="token punctuation">.</span>PluginIdLookupCacheKey key<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
                PluginId pluginId <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ClassLoader classLoader <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                PluginDescriptorLocator locator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassloaderBackedPluginDescriptorLocator</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">)</span><span class="token punctuation">;</span>
                PluginDescriptor pluginDescriptor <span class="token operator">=</span> locator<span class="token punctuation">.</span><span class="token function">findPluginDescriptor</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginDescriptor <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span> Optional<span class="token punctuation">.</span><span class="token function">absent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    String implClassName <span class="token operator">=</span> pluginDescriptor<span class="token punctuation">.</span><span class="token function">getImplementationClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>GUtil<span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>implClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidPluginException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"No implementation class specified for plugin '%s' in %s."</span><span class="token punctuation">,</span> pluginId<span class="token punctuation">,</span> pluginDescriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        Class <span class="token class-name">implClass</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            implClass <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>implClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InvalidPluginException</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Could not find implementation class '%s' for plugin '%s' specified in %s."</span><span class="token punctuation">,</span> implClassName<span class="token punctuation">,</span> pluginId<span class="token punctuation">,</span> pluginDescriptor<span class="token punctuation">)</span><span class="token punctuation">,</span> var10<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        PotentialPlugin<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> potentialPlugin <span class="token operator">=</span> pluginInspector<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>implClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        PluginImplementation<span class="token operator">&lt;</span>Object<span class="token operator">></span> withId <span class="token operator">=</span> DefaultPluginRegistry<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">RegistryAwarePluginImplementation</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> pluginId<span class="token punctuation">,</span> potentialPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token punctuation">(</span>Optional<span class="token punctuation">)</span>Cast<span class="token punctuation">.</span><span class="token function">uncheckedCast</span><span class="token punctuation">(</span>Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>withId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>首先每一个通过plugin方法设置进来的插件，都会包装成一个<code>PluginId</code>。此时会尝试的获取缓存，获取不到则通过如下两行代码获取字符串对应的插件入口类：</p>
<pre class="line-numbers language-java"><code class="language-java"> String implClassName <span class="token operator">=</span> pluginDescriptor<span class="token punctuation">.</span><span class="token function">getImplementationClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>GUtil<span class="token punctuation">.</span><span class="token function">isTrue</span><span class="token punctuation">(</span>implClassName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        Class <span class="token class-name">implClass</span><span class="token punctuation">;</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            implClass <span class="token operator">=</span> classLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>implClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> var10<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                        <span class="token punctuation">}</span>

                        PotentialPlugin<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> potentialPlugin <span class="token operator">=</span> pluginInspector<span class="token punctuation">.</span><span class="token function">inspect</span><span class="token punctuation">(</span>implClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        PluginImplementation<span class="token operator">&lt;</span>Object<span class="token operator">></span> withId <span class="token operator">=</span> DefaultPluginRegistry<span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">new</span> <span class="token class-name">RegistryAwarePluginImplementation</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> pluginId<span class="token punctuation">,</span> potentialPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token punctuation">(</span>Optional<span class="token punctuation">)</span>Cast<span class="token punctuation">.</span><span class="token function">uncheckedCast</span><span class="token punctuation">(</span>Optional<span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>withId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>    public String getImplementationClassName() {
        Properties properties = GUtil.loadProperties(this.propertiesFileUrl);
        return properties.getProperty("implementation-class");
    }</code></pre><p>能看到此时就是获取了对应的插件包路径中的<code>implementation-class</code> 属性。</p>
<p>这也是为什么，我们编写自定义插件的时候，必须要<code>META-INF/gradle-plugin</code>的<code>.properties</code>文件写入</p>
<pre><code>implementation-class=com.yjy.plugin.ImageMonitor</code></pre><p>才能让Gradle脚本找到对应的插件执行入口。</p>
<p>当找到入口类后就会实例化对象，并在如下<code>DefaultPluginManager</code>的<code>addPlugin</code>方法作为入口</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addPlugin</span><span class="token punctuation">(</span>Runnable adder<span class="token punctuation">,</span> PluginImplementation<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> plugin<span class="token punctuation">,</span> String pluginId<span class="token punctuation">,</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> pluginClass<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> imperative <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">isImperative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>imperative<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Plugin<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> pluginInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">producePluginInstance</span><span class="token punctuation">(</span>pluginClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token function">isHasRules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">applyImperativeRulesHybrid</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">,</span> pluginInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">applyImperative</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">,</span> pluginInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>instances<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pluginClass<span class="token punctuation">,</span> pluginInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>pluginContainer<span class="token punctuation">.</span><span class="token function">pluginAdded</span><span class="token punctuation">(</span>pluginInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">applyRules</span><span class="token punctuation">(</span>pluginId<span class="token punctuation">,</span> pluginClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        adder<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>调用每一个插件中的<code>apply</code>方法。</p>
<h4 id="3-2-2-Android-插件闭包属性"><a href="#3-2-2-Android-插件闭包属性" class="headerlink" title="3.2.2. Android 插件闭包属性"></a>3.2.2. Android 插件闭包属性</h4><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_run_closure1</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
            <span class="token keyword">public</span> <span class="token function">_run_closure1</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"30.0.2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure4</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token function">_closure4</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"com.yjy.gradletest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"1.0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"androidx.test.runner.AndroidJUnitRunner"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Generated</span>
                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure4</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure5</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token function">_closure5</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure7</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                            <span class="token keyword">public</span> <span class="token function">_closure7</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> var2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">"proguard-android-optimize.txt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"proguard-rules.pro"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>

                            <span class="token annotation punctuation">@Generated</span>
                            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure7</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Generated</span>
                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                var2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure5</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">_closure6</span> <span class="token keyword">extends</span> <span class="token class-name">Closure</span> <span class="token keyword">implements</span> <span class="token class-name">GeneratedClosure</span> <span class="token punctuation">{</span>
                    <span class="token keyword">public</span> <span class="token function">_closure6</span><span class="token punctuation">(</span>Object _outerInstance<span class="token punctuation">,</span> Object _thisObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var3 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">super</span><span class="token punctuation">(</span>_outerInstance<span class="token punctuation">,</span> _thisObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span>Object it<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var2 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        var2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $<span class="token keyword">const</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> $<span class="token keyword">const</span>$<span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token annotation punctuation">@Generated</span>
                    <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>

                    <span class="token keyword">static</span> <span class="token punctuation">{</span>
                        __$<span class="token function">swapInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> var2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_closure6</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getThisObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Generated</span>
            <span class="token keyword">public</span> Object <span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                CallSite<span class="token punctuation">[</span><span class="token punctuation">]</span> var1 <span class="token operator">=</span> $<span class="token function">getCallSiteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">doCall</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Object<span class="token punctuation">)</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        var1<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">callCurrent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">_run_closure1</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>android {
    compileSdkVersion 30
    buildToolsVersion "30.0.2"

    defaultConfig {
        applicationId "com.yjy.gradletest"
        minSdkVersion 21
        targetSdkVersion 30
        versionCode 1
        versionName "1.0"

        testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"

    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }

    compileOptions {
        sourceCompatibility 1.8
        targetCompatibility 1.8
    }
}</code></pre><p>class 文件的闭包层级对应上<code>build.gradle</code> 中的<code>android</code> 闭包模块。而这个对象实际上指的就是<code>com.android.application</code> 插件 中设置的 扩展对象<code>AppExtension</code>.</p>
<ul>
<li>闭包<code>defaultConfig</code>  对应在<code>BaseExtension</code> 中的<code>defaultConfig</code>  方法。</li>
<li>闭包<code>buildTypes</code> 对应在<code>BaseExtension</code> 中的<code>buildTypes</code>  方法。</li>
<li>闭包<code>compileOptions</code>对应在<code>BaseExtension</code> 中的 <code>compileOptions</code> 方法。</li>
</ul>
<h2 id="4-Android插件的周期"><a href="#4-Android插件的周期" class="headerlink" title="4.Android插件的周期"></a>4.Android插件的周期</h2><p>通过第二节，我们熟悉了Gradle的基本生命周期。通过简单的扫一遍生命周期源码对Gradle有一个初步的熟悉。</p>
<p>通过第三节得知了Groovy脚本和build.gradle 之间的关系。并了解了实际上所有的Android项目打包构建操作都是来源于插件<code>com.android.application</code> .</p>
<p>现在再来聊聊Android 插件的周期。</p>
<p>从Gradle的生命周期，我们可以得知在<code>Config</code>生命周期中，会从根项目开始解析每一个子模块的<code>build.gradle</code>文件，在Config阶段把其中的插件信息收集起来并执行。</p>
<p>从<code>3.2.1</code> 节可以得知，实际上所有的插件都是从gradle安装目录下,和当前写在<code>build.gradle</code>的插件名相同的<code>. properties</code> 文件。 实现类的入口为<code>implementation-class</code> 所对应的全类名。</p>
<p>从<code>build.gradle</code> 开始看看Android插件<code>apply plugin: 'com.android.application'</code>.对应在如下文件名<code>com.android.application.properties</code>：</p>
<pre><code>implementation-class=com.android.build.gradle.AppPlugin</code></pre><p>此时会在<code>PluginManager</code> 中实例化这个<code>AppPlugin</code>  对象，并执行这个对象的<code>apply</code> 方法。 当然这个过程会校验，这个class是否是可以转化为<code>Plugin</code>接口实现的对象。</p>
<h3 id="4-1-AppPlugin-注册扩展对象"><a href="#4-1-AppPlugin-注册扩展对象" class="headerlink" title="4.1.AppPlugin 注册扩展对象"></a>4.1.AppPlugin 注册扩展对象</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppPlugin</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAppPlugin</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Inject</span>
    <span class="token keyword">public</span> <span class="token function">AppPlugin</span><span class="token punctuation">(</span>
            ToolingModelBuilderRegistry registry<span class="token punctuation">,</span> SoftwareComponentFactory componentFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>registry<span class="token punctuation">,</span> componentFactory<span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment" spellcheck="true">/*isBaseApplication*/</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">pluginSpecificApply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Project project<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">registerModelBuilder</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> ToolingModelBuilderRegistry registry<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> GlobalScope globalScope<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> VariantManager variantManager<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> BaseExtension extension<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> ExtraModelInfo extraModelInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        registry<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">AppModelBuilder</span><span class="token punctuation">(</span>
                        globalScope<span class="token punctuation">,</span>
                        variantManager<span class="token punctuation">,</span>
                        taskManager<span class="token punctuation">,</span>
                        <span class="token punctuation">(</span>BaseAppModuleExtension<span class="token punctuation">)</span> extension<span class="token punctuation">,</span>
                        extraModelInfo<span class="token punctuation">,</span>
                        <span class="token function">getProjectType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@NonNull</span>
    <span class="token keyword">protected</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">AppExtension</span><span class="token operator">></span> <span class="token function">getExtensionClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> BaseAppModuleExtension<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>AppPlugin 继承了<code>AbstractAppPlugin</code> ，实现了<code>Plugin</code>接口。在基类<code>AbstractAppPlugin</code>中：</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">protected</span> BaseExtension <span class="token function">createExtension</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> Project project<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> ProjectOptions projectOptions<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> GlobalScope globalScope<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> NamedDomainObjectContainer<span class="token operator">&lt;</span>BuildType<span class="token operator">></span> buildTypeContainer<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> NamedDomainObjectContainer<span class="token operator">&lt;</span>ProductFlavor<span class="token operator">></span> productFlavorContainer<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> NamedDomainObjectContainer<span class="token operator">&lt;</span>SigningConfig<span class="token operator">></span> signingConfigContainer<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> NamedDomainObjectContainer<span class="token operator">&lt;</span>BaseVariantOutput<span class="token operator">></span> buildOutputs<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> SourceSetManager sourceSetManager<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> ExtraModelInfo extraModelInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> project<span class="token punctuation">.</span><span class="token function">getExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                        <span class="token string">"android"</span><span class="token punctuation">,</span>
                        <span class="token function">getExtensionClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        project<span class="token punctuation">,</span>
                        projectOptions<span class="token punctuation">,</span>
                        globalScope<span class="token punctuation">,</span>
                        buildTypeContainer<span class="token punctuation">,</span>
                        productFlavorContainer<span class="token punctuation">,</span>
                        signingConfigContainer<span class="token punctuation">,</span>
                        buildOutputs<span class="token punctuation">,</span>
                        sourceSetManager<span class="token punctuation">,</span>
                        extraModelInfo<span class="token punctuation">,</span>
                        isBaseApplication<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过如下方法，为AppPlugin注册了一个<code>android</code>的扩展<code>BaseAppModuleExtension</code>对象，并保存在<code>ExtensionContainer</code>中。 实现了这个扩展对象，并注册在<code>ExtensionContainer</code> 中，就能在<code>build.gradle</code>  使用<code>android</code> 闭包了。</p>
<p>后续的执行步骤，都会从这个android闭包中，获取对应的数据，从而做到可配置的构建打包。</p>
<h3 id="4-2-AppPlugin-执行入口"><a href="#4-2-AppPlugin-执行入口" class="headerlink" title="4.2. AppPlugin 执行入口"></a>4.2. AppPlugin 执行入口</h3><pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Project project<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        CrashReporting<span class="token punctuation">.</span><span class="token function">runAction</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">></span> <span class="token punctuation">{</span>
                    <span class="token function">basePluginApply</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">pluginSpecificApply</span><span class="token punctuation">(</span>project<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.basePluginApply 则是构建整个Android包的入口方法</li>
<li>2.pluginSpecificApply 用于处理如Feature动态模块的</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">basePluginApply</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Project project<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// We run by default in headless mode, so the JVM doesn't steal focus.</span>
        System<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span><span class="token string">"java.awt.headless"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>project <span class="token operator">=</span> project<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        threadRecorder<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>
                ExecutionType<span class="token punctuation">.</span>BASE_PLUGIN_PROJECT_CONFIGURE<span class="token punctuation">,</span>
                project<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                null<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>configureProject<span class="token punctuation">)</span><span class="token punctuation">;</span>

        threadRecorder<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>
                ExecutionType<span class="token punctuation">.</span>BASE_PLUGIN_PROJECT_BASE_EXTENSION_CREATION<span class="token punctuation">,</span>
                project<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                null<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>configureExtension<span class="token punctuation">)</span><span class="token punctuation">;</span>

        threadRecorder<span class="token punctuation">.</span><span class="token function">record</span><span class="token punctuation">(</span>
                ExecutionType<span class="token punctuation">.</span>BASE_PLUGIN_PROJECT_TASKS_CREATION<span class="token punctuation">,</span>
                project<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                null<span class="token punctuation">,</span>
                <span class="token keyword">this</span><span class="token operator">:</span><span class="token operator">:</span>createTasks<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是三部分线程池中执行的三个函数：</p>
<ul>
<li><p>1.configureProject 为工程配置<code>JavaBasePlugin</code>,并创建了一个<code>assemble</code>任务容器，并监听了项目的构建结束行为后，清除缓存，关闭工作中线程。</p>
</li>
<li><p>2.configureExtension 为<code>AppPlugin</code> 配置<code>BaseVariantOutput</code> 输出扩展对象;同时通过4.1节的<code>createExtension</code>创建<code>android</code>扩展对象；创建任务管理者、发布渠道管理者;添加<code>buildTypeContainer</code>接收到打包结束的监听，并根据签名进行签名。</p>
</li>
<li><p>3.createTasks 创建任务 监听project的<code>BeforeEvaluate</code>,在项目执行build脚本之前添加一些前置的任务。监听project的<code>afterEvaluate</code>添加并运行Apk包打包的任务。</p>
</li>
</ul>
<p>核心代码在BasePlugin 下：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">createAndroidTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
List<span class="token operator">&lt;</span>VariantScope<span class="token operator">></span> variantScopes <span class="token operator">=</span> variantManager<span class="token punctuation">.</span><span class="token function">createAndroidTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过<code>variantManager</code> 创建Android 的构建打包核心任务。</p>
<pre class="line-numbers language-java"><code class="language-java">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createTasksForVariantData</span><span class="token punctuation">(</span><span class="token keyword">final</span> VariantScope variantScope<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> BaseVariantData variantData <span class="token operator">=</span> variantScope<span class="token punctuation">.</span><span class="token function">getVariantData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> VariantType variantType <span class="token operator">=</span> variantData<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">final</span> GradleVariantConfiguration variantConfig <span class="token operator">=</span> variantScope<span class="token punctuation">.</span><span class="token function">getVariantConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        taskManager<span class="token punctuation">.</span><span class="token function">createAssembleTask</span><span class="token punctuation">(</span>variantData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>variantType<span class="token punctuation">.</span><span class="token function">isBaseModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            taskManager<span class="token punctuation">.</span><span class="token function">createBundleTask</span><span class="token punctuation">(</span>variantData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>variantType<span class="token punctuation">.</span><span class="token function">isTestComponent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            taskManager<span class="token punctuation">.</span><span class="token function">createTasksForVariantScope</span><span class="token punctuation">(</span>
                    variantScope<span class="token punctuation">,</span>
                    variantScopes
                            <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>TaskManager<span class="token operator">:</span><span class="token operator">:</span>isLintVariant<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>Collectors<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是通过<code>ApplicationTaskManager</code> 调用的<code>createTasksForVariantScope</code> 创建Android的打包任务。</p>
<h3 id="4-3-Android-构建的任务"><a href="#4-3-Android-构建的任务" class="headerlink" title="4.3 Android 构建的任务"></a>4.3 Android 构建的任务</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createTasksForVariantScope</span><span class="token punctuation">(</span>
            <span class="token annotation punctuation">@NonNull</span> <span class="token keyword">final</span> VariantScope variantScope<span class="token punctuation">,</span>
            <span class="token annotation punctuation">@NonNull</span> List<span class="token operator">&lt;</span>VariantScope<span class="token operator">></span> variantScopesForLint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment" spellcheck="true">// Create all current streams (dependencies mostly at this point)</span>
        <span class="token function">createDependencyStreams</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to publish the applicationId.</span>
        <span class="token function">createApplicationIdWriterTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

        <span class="token comment" spellcheck="true">// Add a task to check the manifest</span>
        taskFactory<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CheckManifest<span class="token punctuation">.</span>CreationAction</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to process the manifest(s)</span>
        <span class="token function">createMergeApkManifestsTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to create the res values</span>
        <span class="token function">createGenerateResValuesTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to compile renderscript files.</span>
        <span class="token function">createRenderscriptTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to merge the resource folders</span>
        <span class="token function">createMergeResourcesTasks</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add tasks to compile shader</span>
        <span class="token function">createShaderTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to merge the asset folders</span>
        <span class="token function">createMergeAssetsTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to create the BuildConfig class</span>
        <span class="token function">createBuildConfigTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to process the Android Resources and generate source files</span>
        <span class="token function">createApkProcessResTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">registerRClassTransformStream</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to process the java resources</span>
        <span class="token function">createProcessJavaResTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">createAidlTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add external native build tasks</span>
        <span class="token function">createExternalNativeBuildJsonGenerators</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">createExternalNativeBuildTasks</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a task to merge the jni libs folders</span>
        <span class="token function">createMergeJniLibFoldersTasks</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add feature related tasks if necessary</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>variantScope<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isBaseModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// Add data binding tasks if enabled</span>
        <span class="token function">createDataBindingTasksIfNecessary</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add a compile task</span>
        <span class="token function">createCompileTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        taskFactory<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StripDebugSymbolsTask<span class="token punctuation">.</span>CreationAction</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>variantScope<span class="token punctuation">.</span><span class="token function">getVariantData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMultiOutputPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>MultiOutputPolicy<span class="token punctuation">.</span>SPLITS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>extension<span class="token punctuation">.</span><span class="token function">getBuildToolsRevision</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMajor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                        <span class="token string">"Pure splits can only be used with buildtools 21 and later"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">createSplitTasks</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">createPackagingTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">maybeCreateLintVitalTask</span><span class="token punctuation">(</span>
                <span class="token punctuation">(</span>ApkVariantData<span class="token punctuation">)</span> variantScope<span class="token punctuation">.</span><span class="token function">getVariantData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> variantScopesForLint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Create the lint tasks, if enabled</span>
        <span class="token function">createLintTasks</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">,</span> variantScopesForLint<span class="token punctuation">)</span><span class="token punctuation">;</span>

        taskFactory<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PackagedDependenciesWriterTask<span class="token punctuation">.</span>CreationAction</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">createDynamicBundleTask</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">;</span>

        taskFactory<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ApkZipPackagingTask<span class="token punctuation">.</span>CreationAction</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>variantScope<span class="token punctuation">.</span><span class="token function">getGlobalScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hasDynamicFeatures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">createSoftwareComponent</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">,</span> <span class="token string">"_apk"</span><span class="token punctuation">,</span> APK_PUBLICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">createSoftwareComponent</span><span class="token punctuation">(</span>variantScope<span class="token punctuation">,</span> <span class="token string">"_aab"</span><span class="token punctuation">,</span> AAB_PUBLICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>1.createDependencyStreams 创建依赖库的读取流保存在<code>TransformManager</code>中，等待后续的TransformClasses流程使用</p>
</li>
<li><ol start="2">
<li>createApplicationIdWriterTask 读取<code>build.gradle</code>中<code>android</code>闭包的ApplicationId。</li>
</ol>
</li>
<li><p>3.CheckManifest.CreationAction 校验Manifest.xml 格式是否正常</p>
</li>
<li><p>4.createMergeApkManifestsTask 合并所有模块的Manifest.xml</p>
</li>
<li><p>5.createGenerateResValuesTask  创建每个资源所对应的id</p>
</li>
<li><p>6.createRenderscriptTask 编译<code>renderscript</code> 文件</p>
</li>
<li><p>7.createMergeResourcesTasks 合并资源任务</p>
</li>
<li><p>8.createShaderTask 编译<code>Shader</code>着色器文件</p>
</li>
<li><p>9.createMergeAssetsTask 合并<code>asset</code>文件夹的内容</p>
</li>
<li><p>10.createBuildConfigTask 生成<code>BuildConfig.class</code> 文件任务</p>
</li>
<li><p>11.createApkProcessResTask 替换id为R文件中对应的ID，并且进行aapt2的资源文件进行混淆。</p>
</li>
<li><p>12.registerRClassTransformStream 为<code>TransformManager</code> 添加资源文件流，为后续添加自定义转化资源id做准备</p>
</li>
<li><p>13.createProcessJavaResTask 通过Java 源代码到同一个目录下</p>
</li>
<li><p>14.createAidlTask 转化<code>aidl</code>文件为class文件</p>
</li>
<li><p>15.createExternalNativeBuildJsonGenerators，createExternalNativeBuildTasks，createMergeJniLibFoldersTasks 处理jni模块并进行编译</p>
</li>
<li><p>16.createDataBindingTasksIfNecessary 处理dataBinding任务</p>
</li>
<li><p>17.createCompileTask 编译java代码，并且进行混淆</p>
</li>
<li><p>18.createPackagingTask 进行apk的打包</p>
</li>
<li><p>19.PackagedDependenciesWriterTask 打包进依赖文件</p>
</li>
<li><p>20.ApkZipPackagingTask 把所有生成的多个apk包等编译产物进行进一步的打包。如多渠道打包时候，可以把多个apk进行打包。</p>
</li>
</ul>
<p>这些任务都有自己的所属的任务组，也有自己的依赖顺序。当在<code>RunTasks</code>阶段的时候，就会运行并且编译。细节方面本文就暂时不聊，等到后续有机会会一个个任务的看看Android插件是如何执行的。</p>
<p>用一副很经典的图总结如下：</p>
<p><img src="/images/android%E6%89%93%E5%8C%85%E6%B5%81%E7%A8%8B.png" alt="android打包流程.png"></p>
<h2 id="5-自定义插件"><a href="#5-自定义插件" class="headerlink" title="5.自定义插件"></a>5.自定义插件</h2><p>如何自定义插件，已经从上述4节有了初步的了解。现在来实战一下，我们写一个Transform 把所有继承于<code>ImageView</code>的对象都转化为自定义的ImageView从而监听所有ImageView的行为：</p>
<p>当我们需要添加一个插件如下：</p>
<pre><code>apply plugin: 'com.image.monitor'</code></pre><p>我们可以新建一个<code>buildSrc</code>模块，并在文件夹main下建立<code>/resources/META-INF/gradle-plugins</code> 文件夹，并创建一个和插件名一致的文件：<code>com.image.monitor.properties</code></p>
<p>并写入如下内容，实现入口类名：</p>
<pre><code>implementation-class=com.yjy.plugin.ImageMonitor</code></pre><h3 id="5-1-ImageMonitor-入口内容"><a href="#5-1-ImageMonitor-入口内容" class="headerlink" title="5.1 ImageMonitor 入口内容"></a>5.1 ImageMonitor 入口内容</h3><pre class="line-numbers language-groovy"><code class="language-groovy"><span class="token keyword">class</span> <span class="token class-name">ImageMonitor</span> <span class="token keyword">implements</span> <span class="token class-name">Plugin</span><span class="token operator">&lt;</span>Project<span class="token operator">></span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">apply</span><span class="token punctuation">(</span>Project project<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment" spellcheck="true">// println "project -->"+project</span>

        <span class="token comment" spellcheck="true">// 找到android 插件</span>
        <span class="token keyword">def</span> android <span class="token operator">=</span> project<span class="token operator">.</span>extensions<span class="token operator">.</span><span class="token function">getByType</span><span class="token punctuation">(</span>AppExtension<span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">//注册一个新的transform</span>
        android<span class="token operator">.</span><span class="token function">registerTransform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ImageTransform</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>一般的流程首先找到<code>AppExtension</code> 扩展对象。这个对象就是AppPlugin注册好的对外扩展对象。并调用<code>registerTransform</code> 添加自定义的<code>ImageTransform</code>.</p>
<p>当配置阶段解析执行<code>buildSrc</code>后，就会把<code>ImageTransform</code>对象 保存到<code>TransformManager</code>中。此时会等到<code>Android</code> 最顶层项目的<code>build.gradle</code>执行<code>apply</code> 方法后，会把<code>TransformManager</code> 中注册的转化器转为<code>TransformTask</code>任务 全部设置到 该模块编译完Java模块后，合并转化dex之前。</p>
<p>因此<code>Transform</code> 可以处理每个模块的源码，以及链接的第三方库。注意，是没办法处理Android源码。</p>
<h3 id="5-2-ImageTransform-实现"><a href="#5-2-ImageTransform-实现" class="headerlink" title="5.2.ImageTransform 实现"></a>5.2.ImageTransform 实现</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">ImageTransform</span> <span class="token keyword">extends</span> <span class="token class-name">Transform</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    String <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">"ImageTransform"</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">//关注的目标</span>
    <span class="token annotation punctuation">@Override</span>
    Set<span class="token operator">&lt;</span>QualifiedContent<span class="token punctuation">.</span>ContentType<span class="token operator">></span> <span class="token function">getInputTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TransformManager<span class="token punctuation">.</span>CONTENT_CLASS
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    Set<span class="token operator">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> QualifiedContent<span class="token punctuation">.</span>Scope<span class="token operator">></span> <span class="token function">getScopes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> TransformManager<span class="token punctuation">.</span>SCOPE_FULL_PROJECT
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// 增量编译</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">boolean</span> <span class="token function">isIncremental</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">void</span> <span class="token function">transform</span><span class="token punctuation">(</span>TransformInvocation transformInvocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> TransformException<span class="token punctuation">,</span> InterruptedException<span class="token punctuation">,</span> IOException <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transformInvocation<span class="token punctuation">)</span>

        Collection<span class="token operator">&lt;</span>TransformInput<span class="token operator">></span> inputs <span class="token operator">=</span> transformInvocation<span class="token punctuation">.</span>inputs
        TransformOutputProvider outputs <span class="token operator">=</span> transformInvocation<span class="token punctuation">.</span>outputProvider

        <span class="token keyword">if</span><span class="token punctuation">(</span>outputs <span class="token operator">!=</span> null<span class="token punctuation">)</span><span class="token punctuation">{</span>
            outputs<span class="token punctuation">.</span><span class="token function">deleteAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        inputs<span class="token punctuation">.</span>each <span class="token punctuation">{</span> TransformInput input <span class="token operator">-</span><span class="token operator">></span>
            <span class="token comment" spellcheck="true">// 处理自己写的代码</span>
            input<span class="token punctuation">.</span>directoryInputs<span class="token punctuation">.</span>each <span class="token punctuation">{</span> DirectoryInput dicInput <span class="token operator">-</span><span class="token operator">></span>
                <span class="token function">handleDicInput</span><span class="token punctuation">(</span>dicInput<span class="token punctuation">,</span>outputs<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment" spellcheck="true">// 处理引入的包</span>
            input<span class="token punctuation">.</span>jarInputs<span class="token punctuation">.</span>each <span class="token punctuation">{</span> JarInput jarInput <span class="token operator">-</span><span class="token operator">></span>
               <span class="token function">handleJarInput</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">,</span>outputs<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>


        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">handleJarInput</span><span class="token punctuation">(</span>JarInput jarInput<span class="token punctuation">,</span>TransformOutputProvider outputs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span>absolutePath<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 先拷贝到一个临时的jar ，然后在从临时的jar拷贝回去</span>
            def jarName <span class="token operator">=</span> jarInput<span class="token punctuation">.</span>name
            def md5Name <span class="token operator">=</span> DigestUtils<span class="token punctuation">.</span><span class="token function">md5Hex</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>jarName<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".jar"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                jarName <span class="token operator">=</span> jarName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>jarName<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            JarFile jarFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarFile</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">)</span>
            Enumeration enumeration <span class="token operator">=</span> jarFile<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            File tmpFile  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>jarInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span>File<span class="token punctuation">.</span>separator<span class="token operator">+</span><span class="token string">"class_temp.jar"</span><span class="token punctuation">)</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>tmpFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                tmpFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            JarOutputStream jarOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JarOutputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>tmpFile<span class="token punctuation">)</span><span class="token punctuation">)</span>


            <span class="token keyword">while</span> <span class="token punctuation">(</span>enumeration<span class="token punctuation">.</span><span class="token function">hasMoreElements</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

                JarEntry entry <span class="token operator">=</span> <span class="token punctuation">(</span>JarEntry<span class="token punctuation">)</span>enumeration<span class="token punctuation">.</span><span class="token function">nextElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// println("zipEntry->" + entry)</span>
                String entryName <span class="token operator">=</span> entry<span class="token punctuation">.</span>name
                def zipEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZipEntry</span><span class="token punctuation">(</span>entryName<span class="token punctuation">)</span>
                def inputStream <span class="token operator">=</span> jarFile<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span>zipEntry<span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// println("zipEntry->" + entryName)</span>

                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filterClass</span><span class="token punctuation">(</span>entryName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    jarOutputStream<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span>zipEntry<span class="token punctuation">)</span>
                    ClassReader classReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>IOUtils<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    def writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                    ClassVisitor visitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MonitorImageClassVisitor</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span>

                    classReader<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">,</span>ClassReader<span class="token punctuation">.</span>EXPAND_FRAMES<span class="token punctuation">)</span>

                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    jarOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// 不是class文件 直接写到临时的jar中</span>
                    jarOutputStream<span class="token punctuation">.</span><span class="token function">putNextEntry</span><span class="token punctuation">(</span>zipEntry<span class="token punctuation">)</span>
                    jarOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>IOUtils<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span>inputStream<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>


                jarOutputStream<span class="token punctuation">.</span><span class="token function">closeEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment" spellcheck="true">// println("zipEntry close->" + entryName)</span>
            <span class="token punctuation">}</span>

            jarOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            jarFile<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">//input 写入到 output</span>
            def dest <span class="token operator">=</span> outputs<span class="token punctuation">.</span><span class="token function">getContentLocation</span><span class="token punctuation">(</span>jarName<span class="token operator">+</span>md5Name<span class="token punctuation">,</span>
                    jarInput<span class="token punctuation">.</span>contentTypes<span class="token punctuation">,</span>jarInput<span class="token punctuation">.</span>scopes<span class="token punctuation">,</span> Format<span class="token punctuation">.</span>JAR<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//            println("copy name->" + jarName+md5Name)</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token comment" spellcheck="true">//            println("copy ->" + dest)</span>

            FileUtils<span class="token punctuation">.</span><span class="token function">copyFile</span><span class="token punctuation">(</span>tmpFile<span class="token punctuation">,</span>dest<span class="token punctuation">)</span>

            tmpFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>


    <span class="token keyword">void</span> <span class="token function">handleDicInput</span><span class="token punctuation">(</span>DirectoryInput dicInput<span class="token punctuation">,</span>TransformOutputProvider outputs<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>dicInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            dicInput<span class="token punctuation">.</span>file<span class="token punctuation">.</span>eachFileRecurse <span class="token punctuation">{</span> File file <span class="token operator">-</span><span class="token operator">></span>
                String name <span class="token operator">=</span> file<span class="token punctuation">.</span>name
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">filterClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    ClassReader reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassReader</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>bytes<span class="token punctuation">)</span>
                    ClassWriter writer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassWriter</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

                    <span class="token comment" spellcheck="true">// 修改这里就好</span>
                    ClassVisitor visitor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MonitorImageClassVisitor</span><span class="token punctuation">(</span>writer<span class="token punctuation">)</span>

                    reader<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">,</span>ClassReader<span class="token punctuation">.</span>EXPAND_FRAMES<span class="token punctuation">)</span>

                    <span class="token comment" spellcheck="true">// 覆盖dic</span>
                    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> code <span class="token operator">=</span>writer<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    FileOutputStream out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span>
                            parentFile<span class="token punctuation">.</span>absolutePath<span class="token operator">+</span>File<span class="token punctuation">.</span>separator<span class="token operator">+</span>name<span class="token punctuation">)</span>
                    out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span>

                    out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">//input 写入到 output</span>
        def dest <span class="token operator">=</span> outputs<span class="token punctuation">.</span><span class="token function">getContentLocation</span><span class="token punctuation">(</span>dicInput<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
                dicInput<span class="token punctuation">.</span>contentTypes<span class="token punctuation">,</span>dicInput<span class="token punctuation">.</span>scopes<span class="token punctuation">,</span> Format<span class="token punctuation">.</span>DIRECTORY<span class="token punctuation">)</span>

        FileUtils<span class="token punctuation">.</span><span class="token function">copyDirectory</span><span class="token punctuation">(</span>dicInput<span class="token punctuation">.</span>file<span class="token punctuation">,</span>dest<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">boolean</span> <span class="token function">filterClass</span><span class="token punctuation">(</span>String className<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>className<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">".class"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"R\$"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"R.class"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token string">"BuildConfig.class"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>getInputTypes 在生成<code>TramsformTask</code> 之前会根据该方法找到转化器关注的数据流，从而封装成一个任务。 这里代表的是，关注class文件</p>
</li>
<li><p>getScopes 代表该转化器作用的范围</p>
</li>
<li><p>isIncremental 是否增量更新</p>
</li>
</ul>
<ul>
<li><p>transform 方法是关注的输入流传进来后，经过这边的处理转化为输出流输出出去。</p>
</li>
<li><p>本文中<code>handleDicInput</code> 代表了遍历文件夹中所有的class文件，通过MonitorImageClassVisitor 对文件流进行修改处理，并覆盖在原来的class文件上</p>
</li>
<li><p>本文中<code>handleJarInput</code> 代表遍历该模块链接的所有的jar包。先解压jar包的内容，再把里面的class流进行修改后再拷贝到全新的jar包中。最后把该新jar包覆盖到老的上面</p>
</li>
</ul>
<p>最后两点其实都是模版代码。</p>
<h3 id="5-2-ClassVisitor"><a href="#5-2-ClassVisitor" class="headerlink" title="5.2. ClassVisitor"></a>5.2. ClassVisitor</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MonitorImageClassVisitor</span> <span class="token keyword">extends</span> <span class="token class-name">ClassVisitor</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token function">MonitorImageClassVisitor</span><span class="token punctuation">(</span>ClassVisitor cv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>Opcodes<span class="token punctuation">.</span>ASM6<span class="token punctuation">,</span> cv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">int</span> version<span class="token punctuation">,</span> <span class="token keyword">int</span> access<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String signature<span class="token punctuation">,</span> String superName<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string">"android/widget/ImageView"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>superName<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span><span class="token string">"com/yjy/gradletest/MonitorImageView"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"superName ->"</span><span class="token operator">+</span>superName<span class="token operator">+</span> <span class="token string">" name->"</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            superName <span class="token operator">=</span> <span class="token string">"com/yjy/gradletest/MonitorImageView"</span><span class="token punctuation">;</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"superName ->"</span><span class="token operator">+</span>superName<span class="token operator">+</span> <span class="token string">" name->"</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span>version<span class="token punctuation">,</span> access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> superName<span class="token punctuation">,</span> interfaces<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> AnnotationVisitor <span class="token function">visitAnnotation</span><span class="token punctuation">(</span>String descriptor<span class="token punctuation">,</span> <span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitAnnotation</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> MethodVisitor <span class="token function">visitMethod</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String descriptor<span class="token punctuation">,</span> String signature<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> exceptions<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        MethodVisitor visitor <span class="token operator">=</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitMethod</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> exceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        SampleMethodVisitor methodVisitor<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">SampleMethodVisitor</span><span class="token punctuation">(</span>visitor<span class="token punctuation">,</span>access<span class="token punctuation">,</span>name<span class="token punctuation">,</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> methodVisitor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> FieldVisitor <span class="token function">visitField</span><span class="token punctuation">(</span><span class="token keyword">int</span> access<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String descriptor<span class="token punctuation">,</span> String signature<span class="token punctuation">,</span> Object value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitField</span><span class="token punctuation">(</span>access<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该方法实际上是用于通过ClassReader监听遍历class数据流。当检测到不同的属性或者方法会回调。</p>
<p><code>visitMethod</code> 是指访问每一个class中的方法。而这边返回自定义的<code>AdviceAdapter</code> 对象则是对当前方法加工后的返回。</p>
<p><code>AdviceAdapter</code> 来源于ASM库对<code>MethodVisitor</code>的封装。</p>
<p>本文中<code>visit</code> 方法是访问到的每一个class文件流的回调。此时会判断当前的父类是<code>android/widget/ImageView</code>并且不是<code>com/yjy/gradletest/MonitorImageView</code>类。那么就把这种ImageView全部继承于<code>com/yjy/gradletest/MonitorImageView</code>。</p>
<p>这样就能在<code>com/yjy/gradletest/MonitorImageView</code> 中监听到所有操作ImageView的信息。</p>
<h3 id="5-3-AdviceAdapter"><a href="#5-3-AdviceAdapter" class="headerlink" title="5.3. AdviceAdapter"></a>5.3. AdviceAdapter</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">class</span> <span class="token class-name">SampleMethodVisitor</span> <span class="token keyword">extends</span> <span class="token class-name">AdviceAdapter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> String mMethodName<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SampleMethodVisitor</span><span class="token punctuation">(</span>MethodVisitor methodVisitor<span class="token punctuation">,</span><span class="token keyword">int</span> access<span class="token punctuation">,</span>String methodName<span class="token punctuation">,</span>String des<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>Opcodes<span class="token punctuation">.</span>ASM6<span class="token punctuation">,</span> methodVisitor<span class="token punctuation">,</span>access<span class="token punctuation">,</span>methodName<span class="token punctuation">,</span>des<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mMethodName <span class="token operator">=</span> methodName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> AnnotationVisitor <span class="token function">visitAnnotation</span><span class="token punctuation">(</span>String descriptor<span class="token punctuation">,</span> <span class="token keyword">boolean</span> visible<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitAnnotation</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> visible<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitParameter</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token keyword">int</span> access<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitParameter</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> access<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment" spellcheck="true">/**
     * 访问到每一行
     * @param opcode
     * @param owner
     * @param name
     * @param descriptor
     * @param isInterface
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitMethodInsn</span><span class="token punctuation">(</span><span class="token keyword">int</span> opcode<span class="token punctuation">,</span> String owner<span class="token punctuation">,</span> String name<span class="token punctuation">,</span> String descriptor<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isInterface<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>mMethodName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"onCreate"</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>owner<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"androidx/appcompat/app/AppCompatActivity"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            System<span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"visit methodName ->"</span><span class="token operator">+</span>mMethodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 访问方法</span>
            mv<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span><span class="token string">"TAG"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mv<span class="token punctuation">.</span><span class="token function">visitLdcInsn</span><span class="token punctuation">(</span><span class="token string">"enterMethod"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mv<span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>Opcodes<span class="token punctuation">.</span>INVOKESTATIC<span class="token punctuation">,</span><span class="token string">"android/util/Log"</span><span class="token punctuation">,</span><span class="token string">"e"</span><span class="token punctuation">,</span>
                    <span class="token string">"(Ljava/lang/String;Ljava/lang/String;)I"</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mv<span class="token punctuation">.</span><span class="token function">visitInsn</span><span class="token punctuation">(</span>POP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitMethodInsn</span><span class="token punctuation">(</span>opcode<span class="token punctuation">,</span> owner<span class="token punctuation">,</span> name<span class="token punctuation">,</span> descriptor<span class="token punctuation">,</span> isInterface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//        if(name.equals("onCreate")){</span>
<span class="token comment" spellcheck="true">//            System.out.println("owner:"+owner+" name:"+name);</span>
<span class="token comment" spellcheck="true">//        }</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">visitEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><p>visitAnnotation 访问方法的注解</p>
</li>
<li><p>visitParameter 访问方法参数</p>
</li>
<li><p>visitMethodInsn 访问方法每一行</p>
</li>
<li><p>visitEnd 访问结束</p>
</li>
</ul>
<p>整个AdviceAdapter生命执行的流程如下：</p>
<blockquote>
<p>visitAnnotationDefault?<br>( visitAnnotation | visitParameterAnnotation | visitAttribute )*<br>( visitCode<br>( visitTryCatchBlock | visitLabel | visitFrame | visitXxxInsn |<br>visitLocalVariable | visitLineNumber )*<br>visitMaxs )?<br>visitEnd</p>
</blockquote>
<p>可以在我们关心的流程中，class中每一个方法，每一个属性，每一个注解做到自己想要ASM插桩，或者修改。</p>
<p>本文在<code>visitMethodInsn</code> 中检测到当前方法所属的class为<code>androidx/appcompat/app/AppCompatActivity</code> 并且是<code>onCreate</code>方法，就会添加一个 <code>Log.e("TAG","enterMethod")</code> 方法的打印。</p>
<h3 id="5-4-自定义插件-总结"><a href="#5-4-自定义插件-总结" class="headerlink" title="5.4.自定义插件 总结"></a>5.4.自定义插件 总结</h3><p>这里写入新的方法在每一行方法中，并非是像aspectj 直接hook那些字符串模版匹配的方法，直接通过反射设置到原来方法前后。而这里则是省去了反射，直接通过字节码的方式，写入方法。</p>
<p>如果我们不太能根据写出来的方法对应字节码，不妨使用<code>AMS ByteCode OutLine</code> 插件转化出来复制到需要的位置即可。</p>
<p>这种方式实际上在很多地方都有用到。比如说在RePlugin中对插件的处理，比如说在性能优化中通过这种ASM插桩检测慢方法，anr等。学会这种方式，就能完成更多看起来不太可能实现功能。</p>
<p>这种方式我也在写业务中使用。比如说进行全局的插桩权限申请流程，从而做到权限申请之前做自己的特殊业务流程。</p>
<h2 id="6-总结"><a href="#6-总结" class="headerlink" title="6.总结"></a>6.总结</h2><p>最后感谢这个系列的文章：</p>
<ul>
<li><a href="https://www.jianshu.com/p/625bc82003d7" target="_blank" rel="noopener">Gradle源码分析</a></li>
<li><a href="https://blog.csdn.net/johnny_jian/article/details/83362796" target="_blank" rel="noopener">CallSite机制</a></li>
<li><a href="https://www.jianshu.com/p/206d00dfd683" target="_blank" rel="noopener">辉哥的Gradle 插件 + ASM 实战 - 监控图片加载告警</a></li>
</ul>
<p>本文花了很长时间撰写。需要的资料和基础散落在不同的地方。辉哥推荐的两本书也只是基础介绍，并没有对Gradle有深度的剖析，看完了还是云里雾里，需要自己看一遍Gradle的运行源码。而且Groovy的发展十分快，很多资料也是散落在不同的第方法，着实花了不少时间。</p>
<p>这里并非是什么高深的文章,仅仅只是对Gradle的入门，对整个Gradle有一个统筹的印象。实际上我们编写Android项目时候，可以阅读通过Extension 暴露出来的android 扩展对象做到更多有趣的事情。</p>
<p>下篇来聊聊，如何捕捉Java层和native层的异常。</p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/05/20/zi-jie-he-teng-xun-mian-shi-de-guo-cheng-he-gan-xiang-ji-lu-yi-you-offer/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/2.jpg" class="responsive-img" alt="字节和腾讯面试的过程和感想记录(已有offer)">
                        
                        <span class="card-title">字节和腾讯面试的过程和感想记录(已有offer)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言这段时间稍微断更了一段时间，因为我在准备面试。经过两次面试后，有一些比较深刻的认识。对于大厂来说，除了对专业知识考究之外，对算法也尤为看重。
简单的说一下情况，字节已经拿到offer，腾讯所有的面面试已经通过了,也应该有offer了。字
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-05-20
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/随笔/" class="post-category">
                                    随笔
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/随笔/">
                        <span class="chip bg-color">随笔</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/03/23/xiao-neng-you-hua-bi-ji-class-wen-jian-chu-shi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/17.jpg" class="responsive-img" alt="效能优化笔记class 文件初识">
                        
                        <span class="card-title">效能优化笔记class 文件初识</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            前言我一直觉得我的学习态度和方法很有问题，不然也不会觉得自己走到一个奇怪的瓶颈。一个很特殊的怪圈，就是怎么学都达不到大厂的水准和效率。从现在开始需要端正自己的态度，低姿态学习。学的多，不如学的牢固稳妥。
后续的更新计划，只要加班不厉害，每周
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-03-23
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/JVM/" class="post-category">
                                    JVM
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JVM/">
                        <span class="chip bg-color">JVM</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
