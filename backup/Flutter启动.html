<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="Android | Linux | Flutter">
    <meta name="description" content="yjy239的博客">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>yjy239的博客</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper head-container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">yjy239的博客</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right nav-menu">
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/" class="waves-effect waves-light">
						
						<i class="fa fa-home"></i>
						
						<span>首页</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/tags" class="waves-effect waves-light">
						
						<i class="fa fa-tags"></i>
						
						<span>标签</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/categories" class="waves-effect waves-light">
						
						<i class="fa fa-bookmark"></i>
						
						<span>分类</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/archives" class="waves-effect waves-light">
						
						<i class="fa fa-archive"></i>
						
						<span>归档</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/about" class="waves-effect waves-light">
						
						<i class="fa fa-user-circle-o"></i>
						
						<span>关于</span>
					</a>
          
        </li>
    
    <li class="hide-on-med-and-down nav-item" >
		
					  <a href="/friends" class="waves-effect waves-light">
						
						<i class="fa fa-address-book"></i>
						
						<span>友情链接</span>
					</a>
          
        </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">yjy239的博客</div>
        <div class="logo-desc">
            
            萌新级别的Android工程师
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
<li class="m-nav-item">
			
				<a href="/" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-home"></i>
					
					首页
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/tags" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-tags"></i>
					
					标签
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/categories" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-bookmark"></i>
					
					分类
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/archives" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-archive"></i>
					
					归档
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/about" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-user-circle-o"></i>
					
					关于
				</a>
          
        </li>
        
<li class="m-nav-item">
			
				<a href="/friends" class="waves-effect waves-light">
					
					<i class="fa fa-fw fa-address-book"></i>
					
					友情链接
				</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/yjy239" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/yjy239" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/0.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-04-01
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        8.8k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        48 分
                    </div>
                    
                
				
				
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="fa fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Flutter-Application初始化启动入口"><a href="#Flutter-Application初始化启动入口" class="headerlink" title="Flutter Application初始化启动入口"></a>Flutter Application初始化启动入口</h1><pre class="line-numbers language-java"><code class="language-java">FlutterMain<span class="token punctuation">.</span><span class="token function">startInitialization</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="1-FlutterMain-startInitialization"><a href="#1-FlutterMain-startInitialization" class="headerlink" title="1. FlutterMain startInitialization"></a>1. FlutterMain startInitialization</h2><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">startInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isRunningInRobolectricTest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    FlutterLoader<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startInitialization</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startInitialization</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context applicationContext<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> Settings settings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Do not run startInitialization more than once.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>settings <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"startInitialization must be called on the main thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Ensure that the context is actually the application context.</span>
    <span class="token keyword">final</span> Context appContext <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>settings <span class="token operator">=</span> settings<span class="token punctuation">;</span>

    initStartTimestampMillis <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initConfig</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    VsyncWaiter<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WindowManager<span class="token punctuation">)</span> appContext<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>WINDOW_SERVICE<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Callable<span class="token operator">&lt;</span>InitResult<span class="token operator">></span> initTask <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">Callable</span><span class="token operator">&lt;</span>InitResult<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> InitResult <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ResourceExtractor resourceExtractor <span class="token operator">=</span> <span class="token function">initResources</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>

            System<span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>
                    <span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token annotation punctuation">@Override</span>
                      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        FlutterJNI<span class="token punctuation">.</span><span class="token function">nativePrefetchDefaultFontManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>resourceExtractor <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              resourceExtractor<span class="token punctuation">.</span><span class="token function">waitForCompletion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">InitResult</span><span class="token punctuation">(</span>
                PathUtils<span class="token punctuation">.</span><span class="token function">getFilesDir</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
                PathUtils<span class="token punctuation">.</span><span class="token function">getCacheDirectory</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">,</span>
                PathUtils<span class="token punctuation">.</span><span class="token function">getDataDirectory</span><span class="token punctuation">(</span>appContext<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    initResultFuture <span class="token operator">=</span> Executors<span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>initTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.初始化VsyncWaiter 用于监听Vsync信号</li>
<li>2.initResources 初始化资源</li>
<li>3.启动单个线程池初始化libflutter.so的动态库</li>
<li>4.启动一个线程执行jni的nativePrefetchDefaultFontManager方法 预加载Skia的字体管理器</li>
<li>5.等待资源初始化成功后返回</li>
</ul>
<h3 id="2-FlutterLoader-initResources"><a href="#2-FlutterLoader-initResources" class="headerlink" title="2.FlutterLoader initResources"></a>2.FlutterLoader initResources</h3><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> ResourceExtractor <span class="token function">initResources</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context applicationContext<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ResourceExtractor resourceExtractor <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>DEBUG <span class="token operator">||</span> BuildConfig<span class="token punctuation">.</span>JIT_RELEASE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> String dataDirPath <span class="token operator">=</span> PathUtils<span class="token punctuation">.</span><span class="token function">getDataDirectory</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> String packageName <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> PackageManager packageManager <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getPackageManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">final</span> AssetManager assetManager <span class="token operator">=</span> applicationContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      resourceExtractor <span class="token operator">=</span>
          <span class="token keyword">new</span> <span class="token class-name">ResourceExtractor</span><span class="token punctuation">(</span>dataDirPath<span class="token punctuation">,</span> packageName<span class="token punctuation">,</span> packageManager<span class="token punctuation">,</span> assetManager<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment" spellcheck="true">// In debug/JIT mode these assets will be written to disk and then</span>
      <span class="token comment" spellcheck="true">// mapped into memory so they can be provided to the Dart VM.</span>
      resourceExtractor
          <span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token function">fullAssetPathFrom</span><span class="token punctuation">(</span>vmSnapshotData<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token function">fullAssetPathFrom</span><span class="token punctuation">(</span>isolateSnapshotData<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">addResource</span><span class="token punctuation">(</span><span class="token function">fullAssetPathFrom</span><span class="token punctuation">(</span>DEFAULT_KERNEL_BLOB<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      resourceExtractor<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> resourceExtractor<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果是JIT_RELEASE 模式或者是debug模式，这两个模式都是用于调试的。因此会提前调用AssetManager的open，解压内部压缩的资源。</p>
<h3 id="3-加载libflutter-so的动态库"><a href="#3-加载libflutter-so的动态库" class="headerlink" title="3. 加载libflutter.so的动态库"></a>3. 加载libflutter.so的动态库</h3><pre class="line-numbers language-cpp"><code class="language-cpp">JNIEXPORT jint <span class="token function">JNI_OnLoad</span><span class="token punctuation">(</span>JavaVM<span class="token operator">*</span> vm<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> reserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Initialize the Java VM.</span>
  fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">InitJavaVM</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">;</span>

  JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">bool</span> result <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Register FlutterMain.</span>
  result <span class="token operator">=</span> flutter<span class="token operator">::</span>FlutterMain<span class="token operator">::</span><span class="token function">Register</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FML_CHECK</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Register PlatformView</span>
  result <span class="token operator">=</span> flutter<span class="token operator">::</span>PlatformViewAndroid<span class="token operator">::</span><span class="token function">Register</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FML_CHECK</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Register VSyncWaiter.</span>
  result <span class="token operator">=</span> flutter<span class="token operator">::</span>VsyncWaiterAndroid<span class="token operator">::</span><span class="token function">Register</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FML_CHECK</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> JNI_VERSION_1_4<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.FlutterMain::Register FlutterMain注册一些方法到当前的JNI中</li>
<li>2.PlatformViewAndroid 注册当前的 JNI_ENV</li>
<li>3.VsyncWaiterAndroid 注册当前的JNI_ENV</li>
</ul>
<h3 id="4-FlutterMain-Register"><a href="#4-FlutterMain-Register" class="headerlink" title="4.FlutterMain::Register"></a>4.FlutterMain::Register</h3><pre class="line-numbers language-cpp"><code class="language-cpp">
<span class="token keyword">bool</span> FlutterMain<span class="token operator">::</span><span class="token function">Register</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> JNINativeMethod methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
      <span class="token punctuation">{</span>
          <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"nativeInit"</span><span class="token punctuation">,</span>
          <span class="token punctuation">.</span>signature <span class="token operator">=</span> <span class="token string">"(Landroid/content/Context;[Ljava/lang/String;Ljava/"</span>
                       <span class="token string">"lang/String;Ljava/lang/String;Ljava/lang/String;)V"</span><span class="token punctuation">,</span>
          <span class="token punctuation">.</span>fnPtr <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Init<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
          <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"nativeRecordStartTimestamp"</span><span class="token punctuation">,</span>
          <span class="token punctuation">.</span>signature <span class="token operator">=</span> <span class="token string">"(J)V"</span><span class="token punctuation">,</span>
          <span class="token punctuation">.</span>fnPtr <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RecordStartTimestamp<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  jclass <span class="token class-name">clazz</span> <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"io/flutter/embedding/engine/FlutterJNI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> fml<span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">(</span>methods<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>动态注册了两个方法到到方法表中，一个是FlutterJNI.nativeInit 对应FlutterMain的Init。另一个是FlutterJNI. nativeRecordStartTimestamp对应RecordStartTimestamp。</p>
<h3 id="5-PlatformViewAndroid-Register"><a href="#5-PlatformViewAndroid-Register" class="headerlink" title="5.PlatformViewAndroid::Register"></a>5.PlatformViewAndroid::Register</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> PlatformViewAndroid<span class="token operator">::</span><span class="token function">Register</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  g_flutter_callback_info_class <span class="token operator">=</span> <span class="token keyword">new</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span>ScopedJavaGlobalRef<span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"io/flutter/view/FlutterCallbackInformation"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  g_flutter_callback_info_constructor <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>
      g_flutter_callback_info_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"&lt;init>"</span><span class="token punctuation">,</span>
      <span class="token string">"(Ljava/lang/String;Ljava/lang/String;Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  g_flutter_jni_class <span class="token operator">=</span> <span class="token keyword">new</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span>ScopedJavaGlobalRef<span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"io/flutter/embedding/engine/FlutterJNI"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  g_surface_texture_class <span class="token operator">=</span> <span class="token keyword">new</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span>ScopedJavaGlobalRef<span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"android/graphics/SurfaceTexture"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  g_attach_to_gl_context_method <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>
      g_surface_texture_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"attachToGLContext"</span><span class="token punctuation">,</span> <span class="token string">"(I)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  g_update_tex_image_method <span class="token operator">=</span>
      env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>g_surface_texture_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"updateTexImage"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  g_get_transform_matrix_method <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>
      g_surface_texture_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"getTransformMatrix"</span><span class="token punctuation">,</span> <span class="token string">"([F)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  g_detach_from_gl_context_method <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>
      g_surface_texture_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"detachFromGLContext"</span><span class="token punctuation">,</span> <span class="token string">"()V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">return</span> <span class="token function">RegisterApi</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是获取SurfaceTexture的相关Java方法操作缓存jni中</p>
<h3 id="6-VsyncWaiterAndroid-Register"><a href="#6-VsyncWaiterAndroid-Register" class="headerlink" title="6.VsyncWaiterAndroid::Register"></a>6.VsyncWaiterAndroid::Register</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> VsyncWaiterAndroid<span class="token operator">::</span><span class="token function">Register</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">const</span> JNINativeMethod methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>
      <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"nativeOnVsync"</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span>signature <span class="token operator">=</span> <span class="token string">"(JJJ)V"</span><span class="token punctuation">,</span>
      <span class="token punctuation">.</span>fnPtr <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>OnNativeVsync<span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  jclass <span class="token class-name">clazz</span> <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"io/flutter/embedding/engine/FlutterJNI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  g_vsync_waiter_class <span class="token operator">=</span> <span class="token keyword">new</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span>ScopedJavaGlobalRef<span class="token operator">&lt;</span>jclass<span class="token operator">></span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>


  g_async_wait_for_vsync_method_ <span class="token operator">=</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>
      g_vsync_waiter_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"asyncWaitForVsync"</span><span class="token punctuation">,</span> <span class="token string">"(J)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">return</span> env<span class="token operator">-</span><span class="token operator">></span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methods<span class="token punctuation">,</span> fml<span class="token operator">::</span><span class="token function">size</span><span class="token punctuation">(</span>methods<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.注册了一个nativeOnVsync jni方法</li>
<li>2.获取Java层FlutterJNI的asyncWaitForVsync。之后可以进行回调</li>
</ul>
<h1 id="Flutter页面的初始化"><a href="#Flutter页面的初始化" class="headerlink" title="Flutter页面的初始化"></a>Flutter页面的初始化</h1><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>Bundle savedInstanceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>LOLLIPOP<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Window window <span class="token operator">=</span> activity<span class="token punctuation">.</span><span class="token function">getWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>LayoutParams<span class="token punctuation">.</span>FLAG_DRAWS_SYSTEM_BAR_BACKGROUNDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">setStatusBarColor</span><span class="token punctuation">(</span><span class="token number">0x40000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window<span class="token punctuation">.</span><span class="token function">getDecorView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setSystemUiVisibility</span><span class="token punctuation">(</span>PlatformPlugin<span class="token punctuation">.</span>DEFAULT_SYSTEM_UI<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    String<span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> <span class="token function">getArgsFromIntent</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    FlutterMain<span class="token punctuation">.</span><span class="token function">ensureInitializationComplete</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    flutterView <span class="token operator">=</span> viewFactory<span class="token punctuation">.</span><span class="token function">createFlutterView</span><span class="token punctuation">(</span>activity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flutterView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      FlutterNativeView nativeView <span class="token operator">=</span> viewFactory<span class="token punctuation">.</span><span class="token function">createFlutterNativeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      flutterView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlutterView</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> null<span class="token punctuation">,</span> nativeView<span class="token punctuation">)</span><span class="token punctuation">;</span>
      flutterView<span class="token punctuation">.</span><span class="token function">setLayoutParams</span><span class="token punctuation">(</span>matchParent<span class="token punctuation">)</span><span class="token punctuation">;</span>
      activity<span class="token punctuation">.</span><span class="token function">setContentView</span><span class="token punctuation">(</span>flutterView<span class="token punctuation">)</span><span class="token punctuation">;</span>
      launchView <span class="token operator">=</span> <span class="token function">createLaunchView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>launchView <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addLaunchView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadIntent</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getIntent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    String appBundlePath <span class="token operator">=</span> FlutterMain<span class="token punctuation">.</span><span class="token function">findAppBundlePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appBundlePath <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">runBundle</span><span class="token punctuation">(</span>appBundlePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>FlutterMain.ensureInitializationComplete 保证初始化结束</li>
</ol>
</li>
<li>2.初始化一个FlutterNativeView作为flutter的承载体</li>
<li>3.runBundle 开始启动flutter应用</li>
</ul>
<h2 id="FlutterLoader-ensureInitializationComplete"><a href="#FlutterLoader-ensureInitializationComplete" class="headerlink" title="FlutterLoader.ensureInitializationComplete"></a>FlutterLoader.ensureInitializationComplete</h2><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">ensureInitializationComplete</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> Context applicationContext<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">myLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
          <span class="token string">"ensureInitializationComplete must be called on the main thread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>settings <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
          <span class="token string">"ensureInitializationComplete must be called after startInitialization"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      InitResult result <span class="token operator">=</span> initResultFuture<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      List<span class="token operator">&lt;</span>String<span class="token operator">></span> shellArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--icu-symbol-prefix=_binary_icudtl_dat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      ApplicationInfo applicationInfo <span class="token operator">=</span> <span class="token function">getApplicationInfo</span><span class="token punctuation">(</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
      shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
          <span class="token string">"--icu-native-lib-path="</span>
              <span class="token operator">+</span> applicationInfo<span class="token punctuation">.</span>nativeLibraryDir
              <span class="token operator">+</span> File<span class="token punctuation">.</span>separator
              <span class="token operator">+</span> DEFAULT_LIBRARY<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Collections<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>shellArgs<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      String kernelPath <span class="token operator">=</span> null<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>BuildConfig<span class="token punctuation">.</span>DEBUG <span class="token operator">||</span> BuildConfig<span class="token punctuation">.</span>JIT_RELEASE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        String snapshotAssetPath <span class="token operator">=</span> result<span class="token punctuation">.</span>dataDirPath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> flutterAssetsDir<span class="token punctuation">;</span>
        kernelPath <span class="token operator">=</span> snapshotAssetPath <span class="token operator">+</span> File<span class="token punctuation">.</span>separator <span class="token operator">+</span> DEFAULT_KERNEL_BLOB<span class="token punctuation">;</span>
        shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--"</span> <span class="token operator">+</span> SNAPSHOT_ASSET_PATH_KEY <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> snapshotAssetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
        shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--"</span> <span class="token operator">+</span> VM_SNAPSHOT_DATA_KEY <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> vmSnapshotData<span class="token punctuation">)</span><span class="token punctuation">;</span>
        shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--"</span> <span class="token operator">+</span> ISOLATE_SNAPSHOT_DATA_KEY <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> isolateSnapshotData<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--"</span> <span class="token operator">+</span> AOT_SHARED_LIBRARY_NAME <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> aotSharedLibraryName<span class="token punctuation">)</span><span class="token punctuation">;</span>

        shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>
            <span class="token string">"--"</span>
                <span class="token operator">+</span> AOT_SHARED_LIBRARY_NAME
                <span class="token operator">+</span> <span class="token string">"="</span>
                <span class="token operator">+</span> applicationInfo<span class="token punctuation">.</span>nativeLibraryDir
                <span class="token operator">+</span> File<span class="token punctuation">.</span>separator
                <span class="token operator">+</span> aotSharedLibraryName<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--cache-dir-path="</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>engineCachesPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">.</span><span class="token function">getLogTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--log-tag="</span> <span class="token operator">+</span> settings<span class="token punctuation">.</span><span class="token function">getLogTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">long</span> initTimeMillis <span class="token operator">=</span> SystemClock<span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> initStartTimestampMillis<span class="token punctuation">;</span>

      Bundle bundle <span class="token operator">=</span> applicationInfo<span class="token punctuation">.</span>metaData<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>bundle <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> use_embedded_view <span class="token operator">=</span> bundle<span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span><span class="token string">"io.flutter.embedded_views_preview"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>use_embedded_view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          shellArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"--use-embedded-view"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      FlutterJNI<span class="token punctuation">.</span><span class="token function">nativeInit</span><span class="token punctuation">(</span>
          applicationContext<span class="token punctuation">,</span>
          shellArgs<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          kernelPath<span class="token punctuation">,</span>
          result<span class="token punctuation">.</span>appStoragePath<span class="token punctuation">,</span>
          result<span class="token punctuation">.</span>engineCachesPath<span class="token punctuation">,</span>
          initTimeMillis<span class="token punctuation">)</span><span class="token punctuation">;</span>

      initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Flutter initialization failed."</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心还是FlutterJNI.nativeInit，这个方法就是FlutterMain::Init</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> FlutterMain<span class="token operator">::</span><span class="token function">Init</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                       jclass <span class="token class-name">clazz</span><span class="token punctuation">,</span>
                       jobject context<span class="token punctuation">,</span>
                       jobjectArray jargs<span class="token punctuation">,</span>
                       jstring kernelPath<span class="token punctuation">,</span>
                       jstring appStoragePath<span class="token punctuation">,</span>
                       jstring engineCachesPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span> args<span class="token punctuation">;</span>
  args<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> arg <span class="token operator">:</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">StringArrayToVector</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jargs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    args<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">auto</span> command_line <span class="token operator">=</span> fml<span class="token operator">::</span><span class="token function">CommandLineFromIterators</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> args<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> settings <span class="token operator">=</span> <span class="token function">SettingsFromCommandLine</span><span class="token punctuation">(</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>


  flutter<span class="token operator">::</span>DartCallbackCache<span class="token operator">::</span><span class="token function">SetCachePath</span><span class="token punctuation">(</span>
      fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">JavaStringToString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> appStoragePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  fml<span class="token operator">::</span>paths<span class="token operator">::</span><span class="token function">InitializeAndroidCachesPath</span><span class="token punctuation">(</span>
      fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">JavaStringToString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> engineCachesPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  flutter<span class="token operator">::</span>DartCallbackCache<span class="token operator">::</span><span class="token function">LoadCacheFromDisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flutter<span class="token operator">::</span>DartVM<span class="token operator">::</span><span class="token function">IsRunningPrecompiledCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> kernelPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> application_kernel_path <span class="token operator">=</span>
        fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">JavaStringToString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> kernelPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fml<span class="token operator">::</span><span class="token function">IsFile</span><span class="token punctuation">(</span>application_kernel_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      settings<span class="token punctuation">.</span>application_kernel_asset <span class="token operator">=</span> application_kernel_path<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  settings<span class="token punctuation">.</span>task_observer_add <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>intptr_t key<span class="token punctuation">,</span> fml<span class="token operator">::</span>closure callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fml<span class="token operator">::</span>MessageLoop<span class="token operator">::</span><span class="token function">GetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AddTaskObserver</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  settings<span class="token punctuation">.</span>task_observer_remove <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>intptr_t key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fml<span class="token operator">::</span>MessageLoop<span class="token operator">::</span><span class="token function">GetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RemoveTaskObserver</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>


  g_flutter_main<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">FlutterMain</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  g_flutter_main<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetupObservatoryUriCallback</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.记录资源路径</li>
<li>2.生成一个FlutterMain 在全局中，并在FlutterMain中保存了所有的设置信息</li>
</ul>
<h3 id="FlutterView初始化"><a href="#FlutterView初始化" class="headerlink" title="FlutterView初始化"></a>FlutterView初始化</h3><pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlutterView</span> <span class="token keyword">extends</span> <span class="token class-name">SurfaceView</span>
    <span class="token keyword">implements</span> <span class="token class-name">BinaryMessenger</span><span class="token punctuation">,</span> TextureRegistry<span class="token punctuation">,</span> MouseCursorPlugin<span class="token punctuation">.</span>MouseCursorViewDelegate <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>这是一个继承了SurfaceView的状态，扩展了Android和Flutter通道接口BinaryMessenger</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token function">FlutterView</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> AttributeSet attrs<span class="token punctuation">,</span> FlutterNativeView nativeView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> attrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    Activity activity <span class="token operator">=</span> <span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Bad context"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>nativeView <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mNativeView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlutterNativeView</span><span class="token punctuation">(</span>activity<span class="token punctuation">.</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      mNativeView <span class="token operator">=</span> nativeView<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    dartExecutor <span class="token operator">=</span> mNativeView<span class="token punctuation">.</span><span class="token function">getDartExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    flutterRenderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlutterRenderer</span><span class="token punctuation">(</span>mNativeView<span class="token punctuation">.</span><span class="token function">getFlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mIsSoftwareRenderingEnabled <span class="token operator">=</span> mNativeView<span class="token punctuation">.</span><span class="token function">getFlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getIsSoftwareRenderingEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mMetrics <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewportMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mMetrics<span class="token punctuation">.</span>devicePixelRatio <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>density<span class="token punctuation">;</span>
    <span class="token function">setFocusable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setFocusableInTouchMode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    mNativeView<span class="token punctuation">.</span><span class="token function">attachViewAndActivity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> activity<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mSurfaceCallback <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">SurfaceHolder<span class="token punctuation">.</span>Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceCreated</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mNativeView<span class="token punctuation">.</span><span class="token function">getFlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onSurfaceCreated</span><span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">getSurface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceChanged</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">,</span> <span class="token keyword">int</span> format<span class="token punctuation">,</span> <span class="token keyword">int</span> width<span class="token punctuation">,</span> <span class="token keyword">int</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mNativeView<span class="token punctuation">.</span><span class="token function">getFlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onSurfaceChanged</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">surfaceDestroyed</span><span class="token punctuation">(</span>SurfaceHolder holder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assertAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mNativeView<span class="token punctuation">.</span><span class="token function">getFlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onSurfaceDestroyed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">getHolder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addCallback</span><span class="token punctuation">(</span>mSurfaceCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mActivityLifecycleListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFirstFrameListeners <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Create all platform channels</span>
    navigationChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NavigationChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keyEventChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KeyEventChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    lifecycleChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LifecycleChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    localizationChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalizationChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    platformChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlatformChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    systemChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SystemChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    settingsChannel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SettingsChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">;</span>

    PlatformPlugin platformPlugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PlatformPlugin</span><span class="token punctuation">(</span>activity<span class="token punctuation">,</span> platformChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addActivityLifecycleListener</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">ActivityLifecycleListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onPostResume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            platformPlugin<span class="token punctuation">.</span><span class="token function">updateSystemUiOverlays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mImm <span class="token operator">=</span> <span class="token punctuation">(</span>InputMethodManager<span class="token punctuation">)</span> <span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>INPUT_METHOD_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    PlatformViewsController platformViewsController <span class="token operator">=</span>
        mNativeView<span class="token punctuation">.</span><span class="token function">getPluginRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPlatformViewsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mTextInputPlugin <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">TextInputPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">TextInputChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">,</span> platformViewsController<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">>=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      mMouseCursorPlugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MouseCursorPlugin</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MouseCursorChannel</span><span class="token punctuation">(</span>dartExecutor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      mMouseCursorPlugin <span class="token operator">=</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    mLocalizationPlugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalizationPlugin</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> localizationChannel<span class="token punctuation">)</span><span class="token punctuation">;</span>
    androidKeyProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AndroidKeyProcessor</span><span class="token punctuation">(</span>keyEventChannel<span class="token punctuation">,</span> mTextInputPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    androidTouchProcessor <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">AndroidTouchProcessor</span><span class="token punctuation">(</span>flutterRenderer<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">/*trackMotionEvents=*/</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    platformViewsController<span class="token punctuation">.</span><span class="token function">attachToFlutterRenderer</span><span class="token punctuation">(</span>flutterRenderer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mNativeView
        <span class="token punctuation">.</span><span class="token function">getPluginRegistry</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">getPlatformViewsController</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">attachTextInputPlugin</span><span class="token punctuation">(</span>mTextInputPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mNativeView<span class="token punctuation">.</span><span class="token function">getFlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLocalizationPlugin</span><span class="token punctuation">(</span>mLocalizationPlugin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Send initial platform information to Dart</span>
    mLocalizationPlugin<span class="token punctuation">.</span><span class="token function">sendLocalesToFlutter</span><span class="token punctuation">(</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sendUserPlatformSettingsToDart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.创建FlutterNativeView，并绑定到当前的View和Activity</li>
<li>2.创建FlutterRender</li>
<li>3.创建监听SurfaceView的周期</li>
<li>4.生成各种插件，如通信通道，mouse，TextInput</li>
</ul>
<h4 id="4-FlutterNativeView"><a href="#4-FlutterNativeView" class="headerlink" title="4.FlutterNativeView"></a>4.FlutterNativeView</h4><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token function">FlutterNativeView</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> Context context<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBackgroundView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mContext <span class="token operator">=</span> context<span class="token punctuation">;</span>
    mPluginRegistry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlutterPluginRegistry</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlutterJNI <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlutterJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlutterJNI<span class="token punctuation">.</span><span class="token function">addIsDisplayingFlutterUiListener</span><span class="token punctuation">(</span>flutterUiDisplayListener<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dartExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DartExecutor</span><span class="token punctuation">(</span>mFlutterJNI<span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlutterJNI<span class="token punctuation">.</span><span class="token function">addEngineLifecycleListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">EngineLifecycleListenerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> isBackgroundView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assertAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.生成FlutterPluginRegistry，系统的FlutterPlugin都要往里面注册，自带MessageChannel</li>
<li>2.实例化FlutterJNI</li>
<li>3.实例化DartExecutor 自带<code>flutter/isolate</code>MessageChannel</li>
<li>4.FlutterJNI 的attachToNative 方法</li>
<li><ol start="5">
<li>FlutterJNI 保存PlatformMessageHandler对象。</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span>FlutterNativeView view<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBackgroundView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    mFlutterJNI<span class="token punctuation">.</span><span class="token function">attachToNative</span><span class="token punctuation">(</span>isBackgroundView<span class="token punctuation">)</span><span class="token punctuation">;</span>
    dartExecutor<span class="token punctuation">.</span><span class="token function">onAttachedToJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="4-1FlutterJNI-attachToNative"><a href="#4-1FlutterJNI-attachToNative" class="headerlink" title="4.1FlutterJNI.attachToNative"></a>4.1FlutterJNI.attachToNative</h4><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">attachToNative</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> isBackgroundView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ensureRunningOnMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ensureNotAttachedToNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    nativePlatformViewId <span class="token operator">=</span> <span class="token function">performNativeAttach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> isBackgroundView<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">performNativeAttach</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> FlutterJNI flutterJNI<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isBackgroundView<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">nativeAttach</span><span class="token punctuation">(</span>flutterJNI<span class="token punctuation">,</span> isBackgroundView<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是指c++ platform_view_andrid_jni.cc 的AttachJNI方法.</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> jlong <span class="token function">AttachJNI</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                       jclass <span class="token class-name">clazz</span><span class="token punctuation">,</span>
                       jobject flutterJNI<span class="token punctuation">,</span>
                       jboolean is_background_view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fml<span class="token operator">::</span>jni<span class="token operator">::</span>JavaObjectWeakGlobalRef <span class="token function">java_object</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> flutterJNI<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> shell_holder <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>AndroidShellHolder<span class="token operator">></span><span class="token punctuation">(</span>
      FlutterMain<span class="token operator">::</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> java_object<span class="token punctuation">,</span> is_background_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shell_holder<span class="token operator">-</span><span class="token operator">></span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>shell_holder<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实例化了一个很重要的对象 <code>AndroidShellHolder</code> 这个对象承载了所有Flutter在Android中实现的特性。</p>
<h3 id="4-1-1AndroidShellHolder-初始化"><a href="#4-1-1AndroidShellHolder-初始化" class="headerlink" title="4.1.1AndroidShellHolder 初始化"></a>4.1.1AndroidShellHolder 初始化</h3><pre class="line-numbers language-cpp"><code class="language-cpp">AndroidShellHolder<span class="token operator">::</span><span class="token function">AndroidShellHolder</span><span class="token punctuation">(</span>
    flutter<span class="token operator">::</span>Settings settings<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>jni<span class="token operator">::</span>JavaObjectWeakGlobalRef java_object<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> is_background_view<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">settings_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">java_object_</span><span class="token punctuation">(</span>java_object<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> size_t shell_count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> thread_label <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>shell_count<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>is_background_view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    thread_host_ <span class="token operator">=</span> <span class="token punctuation">{</span>thread_label<span class="token punctuation">,</span> ThreadHost<span class="token operator">::</span>Type<span class="token operator">::</span>UI<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    thread_host_ <span class="token operator">=</span> <span class="token punctuation">{</span>thread_label<span class="token punctuation">,</span> ThreadHost<span class="token operator">::</span>Type<span class="token operator">::</span>UI <span class="token operator">|</span> ThreadHost<span class="token operator">::</span>Type<span class="token operator">::</span>GPU <span class="token operator">|</span>
                                      ThreadHost<span class="token operator">::</span>Type<span class="token operator">::</span>IO<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span> <span class="token function">jni_exit_task</span><span class="token punctuation">(</span><span class="token punctuation">[</span>key <span class="token operator">=</span> thread_destruct_key_<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_CHECK</span><span class="token punctuation">(</span><span class="token function">pthread_setspecific</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  thread_host_<span class="token punctuation">.</span>ui_thread<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span>jni_exit_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_background_view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    thread_host_<span class="token punctuation">.</span>gpu_thread<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span>jni_exit_task<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  fml<span class="token operator">::</span>WeakPtr<span class="token operator">&lt;</span>PlatformViewAndroid<span class="token operator">></span> weak_platform_view<span class="token punctuation">;</span>
  Shell<span class="token operator">::</span>CreateCallback<span class="token operator">&lt;</span>PlatformView<span class="token operator">></span> on_create_platform_view <span class="token operator">=</span>
      <span class="token punctuation">[</span>is_background_view<span class="token punctuation">,</span> java_object<span class="token punctuation">,</span> <span class="token operator">&amp;</span>weak_platform_view<span class="token punctuation">]</span><span class="token punctuation">(</span>Shell<span class="token operator">&amp;</span> shell<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>PlatformViewAndroid<span class="token operator">></span> platform_view_android<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>is_background_view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          platform_view_android <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>PlatformViewAndroid<span class="token operator">></span><span class="token punctuation">(</span>
              shell<span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">// delegate</span>
              shell<span class="token punctuation">.</span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// task runners</span>
              java_object              <span class="token comment" spellcheck="true">// java object handle for JNI interop</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          platform_view_android <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>PlatformViewAndroid<span class="token operator">></span><span class="token punctuation">(</span>
              shell<span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">// delegate</span>
              shell<span class="token punctuation">.</span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// task runners</span>
              java_object<span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">// java object handle for JNI interop</span>
              shell<span class="token punctuation">.</span><span class="token function">GetSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                  <span class="token punctuation">.</span>enable_software_rendering  <span class="token comment" spellcheck="true">// use software rendering</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        weak_platform_view <span class="token operator">=</span> platform_view_android<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> platform_view_android<span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

  Shell<span class="token operator">::</span>CreateCallback<span class="token operator">&lt;</span>Rasterizer<span class="token operator">></span> on_create_rasterizer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span>Shell<span class="token operator">&amp;</span> shell<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Rasterizer<span class="token operator">></span><span class="token punctuation">(</span>shell<span class="token punctuation">,</span> shell<span class="token punctuation">.</span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>


  fml<span class="token operator">::</span>MessageLoop<span class="token operator">::</span><span class="token function">EnsureInitializedForCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>fml<span class="token operator">::</span>TaskRunner<span class="token operator">></span> gpu_runner<span class="token punctuation">;</span>
  fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>fml<span class="token operator">::</span>TaskRunner<span class="token operator">></span> ui_runner<span class="token punctuation">;</span>
  fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>fml<span class="token operator">::</span>TaskRunner<span class="token operator">></span> io_runner<span class="token punctuation">;</span>
  fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>fml<span class="token operator">::</span>TaskRunner<span class="token operator">></span> platform_runner <span class="token operator">=</span>
      fml<span class="token operator">::</span>MessageLoop<span class="token operator">::</span><span class="token function">GetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>is_background_view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> single_task_runner <span class="token operator">=</span> thread_host_<span class="token punctuation">.</span>ui_thread<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    gpu_runner <span class="token operator">=</span> single_task_runner<span class="token punctuation">;</span>
    ui_runner <span class="token operator">=</span> single_task_runner<span class="token punctuation">;</span>
    io_runner <span class="token operator">=</span> single_task_runner<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    gpu_runner <span class="token operator">=</span> thread_host_<span class="token punctuation">.</span>gpu_thread<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ui_runner <span class="token operator">=</span> thread_host_<span class="token punctuation">.</span>ui_thread<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    io_runner <span class="token operator">=</span> thread_host_<span class="token punctuation">.</span>io_thread<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  flutter<span class="token operator">::</span>TaskRunners <span class="token function">task_runners</span><span class="token punctuation">(</span>thread_label<span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// label</span>
                                    platform_runner<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// platform</span>
                                    gpu_runner<span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">// gpu</span>
                                    ui_runner<span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// ui</span>
                                    io_runner         <span class="token comment" spellcheck="true">// io</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  shell_ <span class="token operator">=</span>
      Shell<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">// task runners</span>
                    settings_<span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">// settings</span>
                    on_create_platform_view<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// platform view create callback</span>
                    on_create_rasterizer      <span class="token comment" spellcheck="true">// rasterizer create callback</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

  platform_view_ <span class="token operator">=</span> weak_platform_view<span class="token punctuation">;</span>

  is_valid_ <span class="token operator">=</span> shell_ <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>thread_host_根据设置的掩码，生成不同的线程。如果is_background_view 为false（默认），在这里可以分为3种线程 ui线程，gpu线程，io线程，否则则只生成ui.当然还有一个默认的PlatformThread，默认情况下不会生成，特指Android主线程。每一个Thread中都有一个MessageLooper，Looper中存在一个TaskRunner对象（核心还是借助了Android的ALooper体系，最后通过epoll阻塞等待）</li>
</ol>
</li>
</ul>
<pre><code>  enum Type {
    Platform = 1 &lt;&lt; 0,
    UI = 1 &lt;&lt; 1,
    GPU = 1 &lt;&lt; 2,
    IO = 1 &lt;&lt; 3,
  };</code></pre><p>这个过程中如果PlatformThread没有初始化，就在本线程的tls中创建一个MessageLooper</p>
<ul>
<li>2.创建一个方法指针on_create_platform_view，这个方法指针通过Shell的初始化，回调上来初始化AndroidShellHolder中的PlatformViewAndroid对象</li>
<li>3.创建一个方法指针on_create_rasterizer，用于创建rasterizer</li>
<li>4.为ThreadHost中获取每一个线程的TaskRunner对象，全部保存到TaskRunners中</li>
<li>5.通过Shell::Create方法，传入TaskRunners，on_create_platform_view，settings实例化Shell。无论是iOS还是Android最终都是通过Shell通信到Flutter。</li>
</ul>
<h4 id="4-1-1-1-Shell-Create-Shell的实例化"><a href="#4-1-1-1-Shell-Create-Shell的实例化" class="headerlink" title="4.1.1.1 Shell::Create Shell的实例化"></a>4.1.1.1 Shell::Create Shell的实例化</h4><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Shell<span class="token operator">></span> Shell<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
    TaskRunners task_runners<span class="token punctuation">,</span>
    Settings settings<span class="token punctuation">,</span>
    Shell<span class="token operator">::</span>CreateCallback<span class="token operator">&lt;</span>PlatformView<span class="token operator">></span> on_create_platform_view<span class="token punctuation">,</span>
    Shell<span class="token operator">::</span>CreateCallback<span class="token operator">&lt;</span>Rasterizer<span class="token operator">></span> on_create_rasterizer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">PerformInitializationTasks</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"Shell::Create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> vm <span class="token operator">=</span> DartVMRef<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FML_CHECK</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Must be able to initialize the VM."</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> vm_data <span class="token operator">=</span> vm<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetVMData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> Shell<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">,</span>             <span class="token comment" spellcheck="true">//</span>
                       std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//</span>
                       vm_data<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetIsolateSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">// isolate snapshot</span>
                       DartSnapshot<span class="token operator">::</span><span class="token function">Empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">// shared snapshot</span>
                       std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>on_create_platform_view<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                       std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>on_create_rasterizer<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//</span>
                       std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>                        <span class="token comment" spellcheck="true">//</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Shell<span class="token operator">></span> Shell<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>
    TaskRunners task_runners<span class="token punctuation">,</span>
    Settings settings<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> isolate_snapshot<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> shared_snapshot<span class="token punctuation">,</span>
    Shell<span class="token operator">::</span>CreateCallback<span class="token operator">&lt;</span>PlatformView<span class="token operator">></span> on_create_platform_view<span class="token punctuation">,</span>
    Shell<span class="token operator">::</span>CreateCallback<span class="token operator">&lt;</span>Rasterizer<span class="token operator">></span> on_create_rasterizer<span class="token punctuation">,</span>
    DartVMRef vm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">PerformInitializationTasks</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  fml<span class="token operator">::</span>AutoResetWaitableEvent latch<span class="token punctuation">;</span>
  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Shell<span class="token operator">></span> shell<span class="token punctuation">;</span>
  fml<span class="token operator">::</span>TaskRunner<span class="token operator">::</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>
      task_runners<span class="token punctuation">.</span><span class="token function">GetPlatformTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      fml<span class="token operator">::</span><span class="token function">MakeCopyable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>latch<span class="token punctuation">,</span>                                          <span class="token comment" spellcheck="true">//</span>
                         vm <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span>                              <span class="token comment" spellcheck="true">//</span>
                         <span class="token operator">&amp;</span>shell<span class="token punctuation">,</span>                                          <span class="token comment" spellcheck="true">//</span>
                         task_runners <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//</span>
                         settings<span class="token punctuation">,</span>                                        <span class="token comment" spellcheck="true">//</span>
                         isolate_snapshot <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                         shared_snapshot <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//</span>
                         on_create_platform_view<span class="token punctuation">,</span>                         <span class="token comment" spellcheck="true">//</span>
                         on_create_rasterizer                             <span class="token comment" spellcheck="true">//</span>
  <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">{</span>
        shell <span class="token operator">=</span> <span class="token function">CreateShellOnPlatformThread</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//</span>
                                            settings<span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//</span>
                                            std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                                            std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//</span>
                                            on_create_platform_view<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">//</span>
                                            on_create_rasterizer          <span class="token comment" spellcheck="true">//</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        latch<span class="token punctuation">.</span><span class="token function">Signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  latch<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> shell<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.DartVMRef::Create 创建Dart虚拟机</li>
<li>2.在Platform线程中执行CreateShellOnPlatformThread，并阻塞等待完成。</li>
</ul>
<h5 id="4-1-1-1-1-CreateShellOnPlatformThread"><a href="#4-1-1-1-1-CreateShellOnPlatformThread" class="headerlink" title="4.1.1.1.1 CreateShellOnPlatformThread"></a>4.1.1.1.1 CreateShellOnPlatformThread</h5><pre class="line-numbers language-java"><code class="language-java">std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>Shell<span class="token operator">></span> Shell<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CreateShellOnPlatformThread</span><span class="token punctuation">(</span>
    DartVMRef vm<span class="token punctuation">,</span>
    TaskRunners task_runners<span class="token punctuation">,</span>
    Settings settings<span class="token punctuation">,</span>
    fml<span class="token operator">:</span><span class="token operator">:</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> isolate_snapshot<span class="token punctuation">,</span>
    fml<span class="token operator">:</span><span class="token operator">:</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> shared_snapshot<span class="token punctuation">,</span>
    Shell<span class="token operator">:</span><span class="token operator">:</span>CreateCallback<span class="token operator">&lt;</span>PlatformView<span class="token operator">></span> on_create_platform_view<span class="token punctuation">,</span>
    Shell<span class="token operator">:</span><span class="token operator">:</span>CreateCallback<span class="token operator">&lt;</span>Rasterizer<span class="token operator">></span> on_create_rasterizer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>task_runners<span class="token punctuation">.</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Task runners to run the shell were invalid."</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  auto shell <span class="token operator">=</span>
      std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>Shell<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Shell</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span><span class="token punctuation">,</span> task_runners<span class="token punctuation">,</span> settings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Create the rasterizer on the GPU thread.</span>
  std<span class="token operator">:</span><span class="token operator">:</span>promise<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>Rasterizer<span class="token operator">>></span> rasterizer_promise<span class="token punctuation">;</span>
  auto rasterizer_future <span class="token operator">=</span> rasterizer_promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fml<span class="token operator">:</span><span class="token operator">:</span>TaskRunner<span class="token operator">:</span><span class="token operator">:</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>
      task_runners<span class="token punctuation">.</span><span class="token function">GetGPUTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>rasterizer_promise<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//</span>
                                        on_create_rasterizer<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                                        shell <span class="token operator">=</span> shell<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true">//</span>
  <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"ShellSetupGPUSubsystem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rasterizer_promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span><span class="token function">on_create_rasterizer</span><span class="token punctuation">(</span><span class="token operator">*</span>shell<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Create the platform view on the platform thread (this thread).</span>
  auto platform_view <span class="token operator">=</span> <span class="token function">on_create_platform_view</span><span class="token punctuation">(</span><span class="token operator">*</span>shell<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>platform_view <span class="token operator">||</span> <span class="token operator">!</span>platform_view<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  auto vsync_waiter <span class="token operator">=</span> platform_view<span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateVSyncWaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  std<span class="token operator">:</span><span class="token operator">:</span>promise<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>ShellIOManager<span class="token operator">>></span> io_manager_promise<span class="token punctuation">;</span>
  auto io_manager_future <span class="token operator">=</span> io_manager_promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  std<span class="token operator">:</span><span class="token operator">:</span>promise<span class="token operator">&lt;</span>fml<span class="token operator">:</span><span class="token operator">:</span>WeakPtr<span class="token operator">&lt;</span>ShellIOManager<span class="token operator">>></span> weak_io_manager_promise<span class="token punctuation">;</span>
  auto weak_io_manager_future <span class="token operator">=</span> weak_io_manager_promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  auto io_task_runner <span class="token operator">=</span> shell<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetIOTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fml<span class="token operator">:</span><span class="token operator">:</span>TaskRunner<span class="token operator">:</span><span class="token operator">:</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>
      io_task_runner<span class="token punctuation">,</span>
      <span class="token punctuation">[</span><span class="token operator">&amp;</span>io_manager_promise<span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//</span>
       <span class="token operator">&amp;</span>weak_io_manager_promise<span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">//</span>
       platform_view <span class="token operator">=</span> platform_view<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
       io_task_runner                                <span class="token comment" spellcheck="true">//</span>
  <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"ShellSetupIOSubsystem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        auto io_manager <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>ShellIOManager<span class="token operator">></span><span class="token punctuation">(</span>
            platform_view<span class="token operator">-</span><span class="token operator">></span><span class="token function">CreateResourceContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> io_task_runner<span class="token punctuation">)</span><span class="token punctuation">;</span>
        weak_io_manager_promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span>io_manager<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        io_manager_promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>io_manager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// Create the engine on the UI thread.</span>
  std<span class="token operator">:</span><span class="token operator">:</span>promise<span class="token operator">&lt;</span>std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>Engine<span class="token operator">>></span> engine_promise<span class="token punctuation">;</span>
  auto engine_future <span class="token operator">=</span> engine_promise<span class="token punctuation">.</span><span class="token function">get_future</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fml<span class="token operator">:</span><span class="token operator">:</span>TaskRunner<span class="token operator">:</span><span class="token operator">:</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>
      shell<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetUITaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      fml<span class="token operator">:</span><span class="token operator">:</span><span class="token function">MakeCopyable</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&amp;</span>engine_promise<span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">//</span>
                         shell <span class="token operator">=</span> shell<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">//</span>
                         isolate_snapshot <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                         shared_snapshot <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">//</span>
                         vsync_waiter <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>vsync_waiter<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//</span>
                         <span class="token operator">&amp;</span>weak_io_manager_future                          <span class="token comment" spellcheck="true">//</span>
  <span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> mutable <span class="token punctuation">{</span>
        <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"ShellSetupUISubsystem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> auto<span class="token operator">&amp;</span> task_runners <span class="token operator">=</span> shell<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        auto animator <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>Animator<span class="token operator">></span><span class="token punctuation">(</span><span class="token operator">*</span>shell<span class="token punctuation">,</span> task_runners<span class="token punctuation">,</span>
                                                   std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>vsync_waiter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        engine_promise<span class="token punctuation">.</span><span class="token function">set_value</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>Engine<span class="token operator">></span><span class="token punctuation">(</span>
            <span class="token operator">*</span>shell<span class="token punctuation">,</span>                       <span class="token comment" spellcheck="true">//</span>
            <span class="token operator">*</span>shell<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetDartVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//</span>
            std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
            std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//</span>
            task_runners<span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//</span>
            shell<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//</span>
            std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>animator<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">//</span>
            weak_io_manager_future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">//</span>
            <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>shell<span class="token operator">-</span><span class="token operator">></span><span class="token function">Setup</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>platform_view<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                    engine_future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>       <span class="token comment" spellcheck="true">//</span>
                    rasterizer_future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//</span>
                    io_manager_future<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment" spellcheck="true">//</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> shell<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.在GPU线程中调用<code>on_create_rasterizer</code> 初始化 rasterizer(光栅器)</li>
<li>2.调用  <code>on_create_platform_view</code> 创建PlatformViewAndroid</li>
<li>3.调用 PlatformViewAndroid 的CreateVSyncWaiter 创建一个VsyncWaiter 监听Vsync信号</li>
<li>4.在IO线程创建一个ShellIOManager</li>
<li>5.在UI线程创建一个Engine，并调用Shell的SetUp方法</li>
</ul>
<h4 id="4-1-1-1-1-1-Rasterizer"><a href="#4-1-1-1-1-1-Rasterizer" class="headerlink" title="4.1.1.1.1.1  Rasterizer"></a>4.1.1.1.1.1  Rasterizer</h4><pre class="line-numbers language-cpp"><code class="language-cpp">Rasterizer<span class="token operator">::</span><span class="token function">Rasterizer</span><span class="token punctuation">(</span>
    TaskRunners task_runners<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>flutter<span class="token operator">::</span>CompositorContext<span class="token operator">></span> compositor_context<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">Rasterizer</span><span class="token punctuation">(</span>dummy_delegate_<span class="token punctuation">,</span>
                 std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">,</span>
                 std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>compositor_context<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个光栅器实际上就是用于处理OpenGL中layer树的合成</p>
<h5 id="4-1-1-1-1-2-PlatformViewAndroid的创建"><a href="#4-1-1-1-1-2-PlatformViewAndroid的创建" class="headerlink" title="4.1.1.1.1.2 PlatformViewAndroid的创建"></a>4.1.1.1.1.2 PlatformViewAndroid的创建</h5><pre class="line-numbers language-cpp"><code class="language-cpp">PlatformViewAndroid<span class="token operator">::</span><span class="token function">PlatformViewAndroid</span><span class="token punctuation">(</span>
    PlatformView<span class="token operator">::</span>Delegate<span class="token operator">&amp;</span> delegate<span class="token punctuation">,</span>
    flutter<span class="token operator">::</span>TaskRunners task_runners<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>jni<span class="token operator">::</span>JavaObjectWeakGlobalRef java_object<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> use_software_rendering<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">PlatformView</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">java_object_</span><span class="token punctuation">(</span>java_object<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">android_surface_</span><span class="token punctuation">(</span>AndroidSurface<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>use_software_rendering<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建一个AndroidSurface保存在其中。这是一个AndroidSurfaceGL对象，也就是GPUSurfaceGL对象。实际上就是一个nativewindow对象</p>
<h5 id="4-1-1-1-1-3-CreateVSyncWaiter创建"><a href="#4-1-1-1-1-3-CreateVSyncWaiter创建" class="headerlink" title="4.1.1.1.1.3 CreateVSyncWaiter创建"></a>4.1.1.1.1.3 CreateVSyncWaiter创建</h5><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>VsyncWaiter<span class="token operator">></span> PlatformViewAndroid<span class="token operator">::</span><span class="token function">CreateVSyncWaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>VsyncWaiterAndroid<span class="token operator">></span><span class="token punctuation">(</span>task_runners_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

VsyncWaiterAndroid<span class="token operator">::</span><span class="token function">VsyncWaiterAndroid</span><span class="token punctuation">(</span>flutter<span class="token operator">::</span>TaskRunners task_runners<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">VsyncWaiter</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这是一个VsyncWaiterAndroid对象</p>
<h5 id="4-1-1-1-1-4-ShellIOManager创建"><a href="#4-1-1-1-1-4-ShellIOManager创建" class="headerlink" title="4.1.1.1.1.4 ShellIOManager创建"></a>4.1.1.1.1.4 ShellIOManager创建</h5><pre class="line-numbers language-cpp"><code class="language-cpp">ShellIOManager<span class="token operator">::</span><span class="token function">ShellIOManager</span><span class="token punctuation">(</span>
    sk_sp<span class="token operator">&lt;</span>GrContext<span class="token operator">></span> resource_context<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>fml<span class="token operator">::</span>TaskRunner<span class="token operator">></span> unref_queue_task_runner<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">resource_context_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>resource_context<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">resource_context_weak_factory_</span><span class="token punctuation">(</span>
          resource_context_ <span class="token operator">?</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>fml<span class="token operator">::</span>WeakPtrFactory<span class="token operator">&lt;</span>GrContext<span class="token operator">>></span><span class="token punctuation">(</span>
                                  resource_context_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                            <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">unref_queue_</span><span class="token punctuation">(</span>fml<span class="token operator">::</span>MakeRefCounted<span class="token operator">&lt;</span>flutter<span class="token operator">::</span>SkiaUnrefQueue<span class="token operator">></span><span class="token punctuation">(</span>
          std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>unref_queue_task_runner<span class="token punctuation">)</span><span class="token punctuation">,</span>
          fml<span class="token operator">::</span>TimeDelta<span class="token operator">::</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">weak_factory_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时会创建GrContext以及SkiaUnrefQueue对象。</p>
<h5 id="4-1-1-1-1-5-Engine创建"><a href="#4-1-1-1-1-5-Engine创建" class="headerlink" title="4.1.1.1.1.5 Engine创建"></a>4.1.1.1.1.5 Engine创建</h5><pre class="line-numbers language-java"><code class="language-java">Engine<span class="token operator">:</span><span class="token operator">:</span><span class="token function">Engine</span><span class="token punctuation">(</span>Delegate<span class="token operator">&amp;</span> delegate<span class="token punctuation">,</span>
               DartVM<span class="token operator">&amp;</span> vm<span class="token punctuation">,</span>
               fml<span class="token operator">:</span><span class="token operator">:</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> isolate_snapshot<span class="token punctuation">,</span>
               fml<span class="token operator">:</span><span class="token operator">:</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> shared_snapshot<span class="token punctuation">,</span>
               TaskRunners task_runners<span class="token punctuation">,</span>
               Settings settings<span class="token punctuation">,</span>
               std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>Animator<span class="token operator">></span> animator<span class="token punctuation">,</span>
               fml<span class="token operator">:</span><span class="token operator">:</span>WeakPtr<span class="token operator">&lt;</span>IOManager<span class="token operator">></span> io_manager<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">delegate_</span><span class="token punctuation">(</span>delegate<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">settings_</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>settings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">animator_</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>animator<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">activity_running_</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">have_surface_</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">image_decoder_</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">,</span>
                     vm<span class="token punctuation">.</span><span class="token function">GetConcurrentWorkerTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     io_manager<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">weak_factory_</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// Runtime controller is initialized here because it takes a reference to this</span>
  <span class="token comment" spellcheck="true">// object as its delegate. The delegate may be called in the constructor and</span>
  <span class="token comment" spellcheck="true">// we want to be fully initilazed by that point.</span>
  runtime_controller_ <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>RuntimeController<span class="token operator">></span><span class="token punctuation">(</span>
      <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span>                                 <span class="token comment" spellcheck="true">// runtime delegate</span>
      <span class="token operator">&amp;</span>vm<span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">// VM</span>
      std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">// isolate snapshot</span>
      std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// shared snapshot</span>
      std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>task_runners<span class="token punctuation">)</span><span class="token punctuation">,</span>               <span class="token comment" spellcheck="true">// task runners</span>
      std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>io_manager<span class="token punctuation">)</span><span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">// io manager</span>
      image_decoder_<span class="token punctuation">.</span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment" spellcheck="true">// image decoder</span>
      settings_<span class="token punctuation">.</span>advisory_script_uri<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// advisory script uri</span>
      settings_<span class="token punctuation">.</span>advisory_script_entrypoint<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// advisory script entrypoint</span>
      settings_<span class="token punctuation">.</span>idle_notification_callback<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// idle notification callback</span>
      settings_<span class="token punctuation">.</span>isolate_create_callback<span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// isolate create callback</span>
      settings_<span class="token punctuation">.</span>isolate_shutdown_callback    <span class="token comment" spellcheck="true">// isolate shutdown callback</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>engine 就是整个Flutter的运行引起，里面包含了IOManager，taskRunner，虚拟机等总体控制器RuntimeController。</p>
<h5 id="5-RuntimeController-创建"><a href="#5-RuntimeController-创建" class="headerlink" title="5. RuntimeController 创建"></a>5. RuntimeController 创建</h5><pre class="line-numbers language-cpp"><code class="language-cpp">RuntimeController<span class="token operator">::</span><span class="token function">RuntimeController</span><span class="token punctuation">(</span>
    RuntimeDelegate<span class="token operator">&amp;</span> p_client<span class="token punctuation">,</span>
    DartVM<span class="token operator">*</span> p_vm<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> p_isolate_snapshot<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> p_shared_snapshot<span class="token punctuation">,</span>
    TaskRunners p_task_runners<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>WeakPtr<span class="token operator">&lt;</span>IOManager<span class="token operator">></span> p_io_manager<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>WeakPtr<span class="token operator">&lt;</span>ImageDecoder<span class="token operator">></span> p_image_decoder<span class="token punctuation">,</span>
    std<span class="token operator">::</span>string p_advisory_script_uri<span class="token punctuation">,</span>
    std<span class="token operator">::</span>string p_advisory_script_entrypoint<span class="token punctuation">,</span>
    std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>int64_t<span class="token punctuation">)</span><span class="token operator">></span> idle_notification_callback<span class="token punctuation">,</span>
    WindowData p_window_data<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>closure p_isolate_create_callback<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>closure p_isolate_shutdown_callback<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">client_</span><span class="token punctuation">(</span>p_client<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">vm_</span><span class="token punctuation">(</span>p_vm<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">isolate_snapshot_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p_isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">shared_snapshot_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p_shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">task_runners_</span><span class="token punctuation">(</span>p_task_runners<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">io_manager_</span><span class="token punctuation">(</span>p_io_manager<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">image_decoder_</span><span class="token punctuation">(</span>p_image_decoder<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">advisory_script_uri_</span><span class="token punctuation">(</span>p_advisory_script_uri<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">advisory_script_entrypoint_</span><span class="token punctuation">(</span>p_advisory_script_entrypoint<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">idle_notification_callback_</span><span class="token punctuation">(</span>idle_notification_callback<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">window_data_</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>p_window_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">isolate_create_callback_</span><span class="token punctuation">(</span>p_isolate_create_callback<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">isolate_shutdown_callback_</span><span class="token punctuation">(</span>p_isolate_shutdown_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">auto</span> strong_root_isolate <span class="token operator">=</span>
      DartIsolate<span class="token operator">::</span><span class="token function">CreateRootIsolate</span><span class="token punctuation">(</span>vm_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetVMData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">GetSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                                     isolate_snapshot_<span class="token punctuation">,</span>                <span class="token comment" spellcheck="true">//</span>
                                     shared_snapshot_<span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">//</span>
                                     task_runners_<span class="token punctuation">,</span>                    <span class="token comment" spellcheck="true">//</span>
                                     std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>Window<span class="token operator">></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//</span>
                                     io_manager_<span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">//</span>
                                     image_decoder_<span class="token punctuation">,</span>                   <span class="token comment" spellcheck="true">//</span>
                                     p_advisory_script_uri<span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">//</span>
                                     p_advisory_script_entrypoint<span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//</span>
                                     <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                          <span class="token comment" spellcheck="true">//</span>
                                     isolate_create_callback_<span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">//</span>
                                     isolate_shutdown_callback_        <span class="token comment" spellcheck="true">//</span>
                                     <span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  root_isolate_ <span class="token operator">=</span> strong_root_isolate<span class="token punctuation">;</span>

  strong_root_isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetReturnCodeCallback</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">]</span><span class="token punctuation">(</span>uint32_t code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    root_isolate_return_code_ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token boolean">true</span><span class="token punctuation">,</span> code<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">*</span> window <span class="token operator">=</span> <span class="token function">GetWindowIfAvailable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tonic<span class="token operator">::</span>DartState<span class="token operator">::</span>Scope <span class="token function">scope</span><span class="token punctuation">(</span>strong_root_isolate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token operator">-</span><span class="token operator">></span><span class="token function">DidCreateIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.一旦运行环境运行起来，就立即通过CreateRootIsolate启动过root ioslate</li>
<li><ol start="2">
<li>一旦初始化成功根 isolate 就从 root ioslate获取Window对象</li>
</ol>
</li>
</ul>
<h4 id="6-CreateRootIsolate-创建-root-ioslate"><a href="#6-CreateRootIsolate-创建-root-ioslate" class="headerlink" title="6. CreateRootIsolate 创建 root ioslate"></a>6. CreateRootIsolate 创建 root ioslate</h4><pre class="line-numbers language-cpp"><code class="language-cpp">std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span> DartIsolate<span class="token operator">::</span><span class="token function">CreateRootIsolate</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Settings<span class="token operator">&amp;</span> settings<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> isolate_snapshot<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span><span class="token keyword">const</span> DartSnapshot<span class="token operator">></span> shared_snapshot<span class="token punctuation">,</span>
    TaskRunners task_runners<span class="token punctuation">,</span>
    std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Window<span class="token operator">></span> window<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>WeakPtr<span class="token operator">&lt;</span>IOManager<span class="token operator">></span> io_manager<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>WeakPtr<span class="token operator">&lt;</span>ImageDecoder<span class="token operator">></span> image_decoder<span class="token punctuation">,</span>
    std<span class="token operator">::</span>string advisory_script_uri<span class="token punctuation">,</span>
    std<span class="token operator">::</span>string advisory_script_entrypoint<span class="token punctuation">,</span>
    Dart_IsolateFlags<span class="token operator">*</span> flags<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>closure isolate_create_callback<span class="token punctuation">,</span>
    fml<span class="token operator">::</span>closure isolate_shutdown_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  Dart_Isolate vm_isolate <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span> embedder_isolate<span class="token punctuation">;</span>

  <span class="token keyword">char</span><span class="token operator">*</span> error <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>


  <span class="token keyword">auto</span> root_embedder_data <span class="token operator">=</span> std<span class="token operator">::</span>make_unique<span class="token operator">&lt;</span>std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">>></span><span class="token punctuation">(</span>
      std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span><span class="token punctuation">(</span>
          settings<span class="token punctuation">,</span>                     <span class="token comment" spellcheck="true">// settings</span>
          std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// isolate snapshot</span>
          std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>shared_snapshot<span class="token punctuation">)</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// shared snapshot</span>
          task_runners<span class="token punctuation">,</span>                 <span class="token comment" spellcheck="true">// task runners</span>
          std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>io_manager<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment" spellcheck="true">// IO manager</span>
          std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>image_decoder<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">// Image Decoder</span>
          advisory_script_uri<span class="token punctuation">,</span>          <span class="token comment" spellcheck="true">// advisory URI</span>
          advisory_script_entrypoint<span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">// advisory entrypoint</span>
          <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                      <span class="token comment" spellcheck="true">// child isolate preparer</span>
          isolate_create_callback<span class="token punctuation">,</span>      <span class="token comment" spellcheck="true">// isolate create callback</span>
          isolate_shutdown_callback     <span class="token comment" spellcheck="true">// isolate shutdown callback</span>
          <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span><span class="token function">tie</span><span class="token punctuation">(</span>vm_isolate<span class="token punctuation">,</span> embedder_isolate<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">CreateDartVMAndEmbedderObjectPair</span><span class="token punctuation">(</span>
      advisory_script_uri<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment" spellcheck="true">// advisory script URI</span>
      advisory_script_entrypoint<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// advisory script entrypoint</span>
      <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">// package root</span>
      <span class="token keyword">nullptr</span><span class="token punctuation">,</span>                             <span class="token comment" spellcheck="true">// package config</span>
      flags<span class="token punctuation">,</span>                               <span class="token comment" spellcheck="true">// flags</span>
      root_embedder_data<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>            <span class="token comment" spellcheck="true">// parent embedder data</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span>                                <span class="token comment" spellcheck="true">// is root isolate</span>
      <span class="token operator">&amp;</span>error                               <span class="token comment" spellcheck="true">// error (out)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>error <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">free</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>vm_isolate <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span> shared_embedder_isolate <span class="token operator">=</span>
      embedder_isolate<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>shared_embedder_isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    shared_embedder_isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">SetWindow</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  root_embedder_data<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> embedder_isolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.创建DartIsolate 对象</li>
<li>2.CreateDartVMAndEmbedderObjectPair 创建DartVM</li>
<li><ol start="3">
<li>shared_embedder_isolate 绑定窗口</li>
</ol>
</li>
</ul>
<p>关于isolate有四种：</p>
<ul>
<li>1.虚拟机isolate: <code>vm-isolate</code>，运行在ui线程</li>
<li>2.常见isolate：<code>isolate-xxx</code>，对于RootIsolate属于这个类别，运行在ui线程</li>
<li>3.虚拟机服务Isolate: <code>vm-service</code>,运行在独立线程</li>
<li>4.内核服务isolate：<code>kernel-service</code></li>
</ul>
<p>虚拟机创建于运行经历如下几个步骤：</p>
<ul>
<li>1.DartVMRef::Create() 创建虚拟机</li>
<li>2.DartIsolate::CreateRootIsolate 创建isolate</li>
<li>3.DartIsolate::Run运行isolate</li>
</ul>
<p>注意只有根isolate才能和window交互</p>
<h3 id="7-Shell-SetUp"><a href="#7-Shell-SetUp" class="headerlink" title="7.Shell::SetUp"></a>7.Shell::SetUp</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">bool</span> Shell<span class="token operator">::</span><span class="token function">Setup</span><span class="token punctuation">(</span>std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>PlatformView<span class="token operator">></span> platform_view<span class="token punctuation">,</span>
                  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Engine<span class="token operator">></span> engine<span class="token punctuation">,</span>
                  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>Rasterizer<span class="token operator">></span> rasterizer<span class="token punctuation">,</span>
                  std<span class="token operator">::</span>unique_ptr<span class="token operator">&lt;</span>ShellIOManager<span class="token operator">></span> io_manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>is_setup_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>platform_view <span class="token operator">||</span> <span class="token operator">!</span>engine <span class="token operator">||</span> <span class="token operator">!</span>rasterizer <span class="token operator">||</span> <span class="token operator">!</span>io_manager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  platform_view_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>platform_view<span class="token punctuation">)</span><span class="token punctuation">;</span>
  engine_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>engine<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rasterizer_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>rasterizer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  io_manager_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>io_manager<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">// The weak ptr must be generated in the platform thread which owns the unique</span>
  <span class="token comment" spellcheck="true">// ptr.</span>
  weak_engine_ <span class="token operator">=</span> engine_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  weak_rasterizer_ <span class="token operator">=</span> rasterizer_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  weak_platform_view_ <span class="token operator">=</span> platform_view_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  is_setup_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

  vm_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetServiceProtocol</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">AddHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">GetServiceProtocolDescription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  PersistentCache<span class="token operator">::</span><span class="token function">GetCacheForProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">AddWorkerTaskRunner</span><span class="token punctuation">(</span>
      task_runners_<span class="token punctuation">.</span><span class="token function">GetIOTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  PersistentCache<span class="token operator">::</span><span class="token function">GetCacheForProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">SetIsDumpingSkp</span><span class="token punctuation">(</span>
      settings_<span class="token punctuation">.</span>dump_skp_on_shader_compilation<span class="token punctuation">)</span><span class="token punctuation">;</span>

  display_refresh_rate_ <span class="token operator">=</span> weak_engine_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetDisplayRefreshRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.Shell缓存了PlatformView 也就是PlatformViewAndroid 一个NativeWindow</li>
<li>2.缓存了rasterizer 光栅器</li>
<li>3.缓存了Engine flutter的引擎对象</li>
</ul>
<h2 id="8-FlutterActivityDelegate-runBundle-启动dart程序"><a href="#8-FlutterActivityDelegate-runBundle-启动dart程序" class="headerlink" title="8.FlutterActivityDelegate.runBundle 启动dart程序"></a>8.FlutterActivityDelegate.runBundle 启动dart程序</h2><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">runBundle</span><span class="token punctuation">(</span>String appBundlePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>flutterView<span class="token punctuation">.</span><span class="token function">getFlutterNativeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isApplicationRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      FlutterRunArguments args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FlutterRunArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      args<span class="token punctuation">.</span>bundlePath <span class="token operator">=</span> appBundlePath<span class="token punctuation">;</span>
      args<span class="token punctuation">.</span>entrypoint <span class="token operator">=</span> <span class="token string">"main"</span><span class="token punctuation">;</span>
      flutterView<span class="token punctuation">.</span><span class="token function">runFromBundle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取dart文件路径，需要反射调用的方法为main，最后作为参数传入FlutterView中</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runFromBundle</span><span class="token punctuation">(</span>FlutterRunArguments args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">assertAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">preRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mNativeView<span class="token punctuation">.</span><span class="token function">runFromBundle</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">postRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>FlutterView 调用了FlutterNativeView的runFromBundle</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runFromBundle</span><span class="token punctuation">(</span>FlutterRunArguments args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">.</span>entrypoint <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"An entrypoint must be specified"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">assertAttached</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>applicationIsRunning<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"This Flutter engine instance is already running an application"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mFlutterJNI<span class="token punctuation">.</span><span class="token function">runBundleAndSnapshotFromLibrary</span><span class="token punctuation">(</span>
        args<span class="token punctuation">.</span>bundlePath<span class="token punctuation">,</span> args<span class="token punctuation">.</span>entrypoint<span class="token punctuation">,</span> args<span class="token punctuation">.</span>libraryPath<span class="token punctuation">,</span> mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    applicationIsRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心方法还是这个jni方法nativeRunBundleAndSnapshotFromLibrary</p>
<pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">runBundleAndSnapshotFromLibrary</span><span class="token punctuation">(</span>
      <span class="token annotation punctuation">@NonNull</span> String bundlePath<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> String entrypointFunctionName<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@Nullable</span> String pathToEntrypointFunction<span class="token punctuation">,</span>
      <span class="token annotation punctuation">@NonNull</span> AssetManager assetManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">ensureRunningOnMainThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ensureAttachedToNative</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">nativeRunBundleAndSnapshotFromLibrary</span><span class="token punctuation">(</span>
        nativePlatformViewId<span class="token punctuation">,</span>
        bundlePath<span class="token punctuation">,</span>
        entrypointFunctionName<span class="token punctuation">,</span>
        pathToEntrypointFunction<span class="token punctuation">,</span>
        assetManager<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="9-RunBundleAndSnapshotFromLibrary"><a href="#9-RunBundleAndSnapshotFromLibrary" class="headerlink" title="9.RunBundleAndSnapshotFromLibrary"></a>9.RunBundleAndSnapshotFromLibrary</h2><p>对应jni为：</p>
<pre class="line-numbers language-java"><code class="language-java"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RunBundleAndSnapshotFromLibrary</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
                                            jobject jcaller<span class="token punctuation">,</span>
                                            jlong shell_holder<span class="token punctuation">,</span>
                                            jstring jBundlePath<span class="token punctuation">,</span>
                                            jstring jEntrypoint<span class="token punctuation">,</span>
                                            jstring jLibraryUrl<span class="token punctuation">,</span>
                                            jobject jAssetManager<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  auto asset_manager <span class="token operator">=</span> std<span class="token operator">:</span><span class="token operator">:</span>make_shared<span class="token operator">&lt;</span>flutter<span class="token operator">:</span><span class="token operator">:</span>AssetManager<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  asset_manager<span class="token operator">-</span><span class="token operator">></span><span class="token function">PushBack</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span>make_unique<span class="token operator">&lt;</span>flutter<span class="token operator">:</span><span class="token operator">:</span>APKAssetProvider<span class="token operator">></span><span class="token punctuation">(</span>
      env<span class="token punctuation">,</span>                                             <span class="token comment" spellcheck="true">// jni environment</span>
      jAssetManager<span class="token punctuation">,</span>                                   <span class="token comment" spellcheck="true">// asset manager</span>
      fml<span class="token operator">:</span><span class="token operator">:</span>jni<span class="token operator">:</span><span class="token operator">:</span><span class="token function">JavaStringToString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jBundlePath<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true">// apk asset dir</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>IsolateConfiguration<span class="token operator">></span> isolate_configuration<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>flutter<span class="token operator">:</span><span class="token operator">:</span>DartVM<span class="token operator">:</span><span class="token operator">:</span><span class="token function">IsRunningPrecompiledCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    isolate_configuration <span class="token operator">=</span> IsolateConfiguration<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CreateForAppSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    std<span class="token operator">:</span><span class="token operator">:</span>unique_ptr<span class="token operator">&lt;</span>fml<span class="token operator">:</span><span class="token operator">:</span>Mapping<span class="token operator">></span> kernel_blob <span class="token operator">=</span>
        fml<span class="token operator">:</span><span class="token operator">:</span>FileMapping<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CreateReadOnly</span><span class="token punctuation">(</span>
            ANDROID_SHELL_HOLDER<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetSettings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>application_kernel_asset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kernel_blob<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FML_DLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to load the kernel blob asset."</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    isolate_configuration <span class="token operator">=</span>
        IsolateConfiguration<span class="token operator">:</span><span class="token operator">:</span><span class="token function">CreateForKernel</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>kernel_blob<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  RunConfiguration <span class="token function">config</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>isolate_configuration<span class="token punctuation">)</span><span class="token punctuation">,</span>
                          std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>asset_manager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token punctuation">{</span>
    auto entrypoint <span class="token operator">=</span> fml<span class="token operator">:</span><span class="token operator">:</span>jni<span class="token operator">:</span><span class="token operator">:</span><span class="token function">JavaStringToString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jEntrypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    auto libraryUrl <span class="token operator">=</span> fml<span class="token operator">:</span><span class="token operator">:</span>jni<span class="token operator">:</span><span class="token operator">:</span><span class="token function">JavaStringToString</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> jLibraryUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>libraryUrl<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span><span class="token function">SetEntrypointAndLibrary</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                     std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>libraryUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entrypoint<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      config<span class="token punctuation">.</span><span class="token function">SetEntrypoint</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>entrypoint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  ANDROID_SHELL_HOLDER<span class="token operator">-</span><span class="token operator">></span><span class="token function">Launch</span><span class="token punctuation">(</span>std<span class="token operator">:</span><span class="token operator">:</span><span class="token function">move</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.从上层中获取了该Apk拥有的assetManager并保存到asset_manager 集合中</li>
<li>2.生成RunConfiguration 对象，保存了之后需要加载dart应用的路径以及需要启动程序的入口函数(此时为main)</li>
<li>3.调用AndroidShellHolder的Launch方法。</li>
</ul>
<h3 id="10-AndroidShellHolder-Launch"><a href="#10-AndroidShellHolder-Launch" class="headerlink" title="10.AndroidShellHolder  Launch"></a>10.AndroidShellHolder  Launch</h3><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> AndroidShellHolder<span class="token operator">::</span><span class="token function">Launch</span><span class="token punctuation">(</span>RunConfiguration config<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  shell_<span class="token operator">-</span><span class="token operator">></span><span class="token function">RunEngine</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心调用了Shell的RunEngine</p>
<h4 id="10-1-Shell的RunEngine"><a href="#10-1-Shell的RunEngine" class="headerlink" title="10.1 Shell的RunEngine"></a>10.1 Shell的RunEngine</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Shell<span class="token operator">::</span><span class="token function">RunEngine</span><span class="token punctuation">(</span>RunConfiguration run_configuration<span class="token punctuation">,</span>
                      std<span class="token operator">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span>Engine<span class="token operator">::</span>RunStatus<span class="token punctuation">)</span><span class="token operator">></span> result_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token punctuation">[</span>platform_runner <span class="token operator">=</span> task_runners_<span class="token punctuation">.</span><span class="token function">GetPlatformTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 result_callback<span class="token punctuation">]</span><span class="token punctuation">(</span>Engine<span class="token operator">::</span>RunStatus run_result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    platform_runner<span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>result_callback<span class="token punctuation">,</span> run_result<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">result_callback</span><span class="token punctuation">(</span>run_result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">FML_DCHECK</span><span class="token punctuation">(</span>is_setup_<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">FML_DCHECK</span><span class="token punctuation">(</span>task_runners_<span class="token punctuation">.</span><span class="token function">GetPlatformTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">RunsTasksOnCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>weak_engine_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">result</span><span class="token punctuation">(</span>Engine<span class="token operator">::</span>RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  fml<span class="token operator">::</span>TaskRunner<span class="token operator">::</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>
      task_runners_<span class="token punctuation">.</span><span class="token function">GetUITaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      fml<span class="token operator">::</span><span class="token function">MakeCopyable</span><span class="token punctuation">(</span>
          <span class="token punctuation">[</span>run_configuration <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>run_configuration<span class="token punctuation">)</span><span class="token punctuation">,</span>
           weak_engine <span class="token operator">=</span> weak_engine_<span class="token punctuation">,</span> result<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">auto</span> run_result <span class="token operator">=</span> weak_engine<span class="token operator">-</span><span class="token operator">></span><span class="token function">Run</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>run_configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token function">result</span><span class="token punctuation">(</span>run_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心是在Platform线程中调用了Engine的run方法。</p>
<h4 id="10-1-1-Engine的run"><a href="#10-1-1-Engine的run" class="headerlink" title="10.1.1 Engine的run"></a>10.1.1 Engine的run</h4><pre class="line-numbers language-cpp"><code class="language-cpp">Engine<span class="token operator">::</span>RunStatus Engine<span class="token operator">::</span><span class="token function">Run</span><span class="token punctuation">(</span>RunConfiguration configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">auto</span> isolate_launch_status <span class="token operator">=</span>
      <span class="token function">PrepareAndLaunchIsolate</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span> isolate <span class="token operator">=</span>
      runtime_controller_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetRootIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">bool</span> isolate_running <span class="token operator">=</span>
      isolate <span class="token operator">&amp;&amp;</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> DartIsolate<span class="token operator">::</span>Phase<span class="token operator">::</span>Running<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate_running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    tonic<span class="token operator">::</span>DartState<span class="token operator">::</span>Scope <span class="token function">scope</span><span class="token punctuation">(</span>isolate<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>settings_<span class="token punctuation">.</span>root_isolate_create_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      settings_<span class="token punctuation">.</span><span class="token function">root_isolate_create_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>settings_<span class="token punctuation">.</span>root_isolate_shutdown_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">AddIsolateShutdownCallback</span><span class="token punctuation">(</span>
          settings_<span class="token punctuation">.</span>root_isolate_shutdown_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>string service_id <span class="token operator">=</span> isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>PlatformMessage<span class="token operator">></span> service_id_message <span class="token operator">=</span>
        fml<span class="token operator">::</span>MakeRefCounted<span class="token operator">&lt;</span>flutter<span class="token operator">::</span>PlatformMessage<span class="token operator">></span><span class="token punctuation">(</span>
            kIsolateChannel<span class="token punctuation">,</span>
            std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>uint8_t<span class="token operator">></span><span class="token punctuation">(</span>service_id<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> service_id<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HandlePlatformMessage</span><span class="token punctuation">(</span>service_id_message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> isolate_running <span class="token operator">?</span> Engine<span class="token operator">::</span>RunStatus<span class="token operator">::</span>Success
                         <span class="token operator">:</span> Engine<span class="token operator">::</span>RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>PrepareAndLaunchIsolate 准备以及启动isolate的main方法</li>
</ol>
</li>
<li>2.最后回调到FlutterJNI的handlePlatformMessageResponse 方法中告诉完成启动</li>
</ul>
<h4 id="11-PrepareAndLaunchIsolate"><a href="#11-PrepareAndLaunchIsolate" class="headerlink" title="11. PrepareAndLaunchIsolate"></a>11. PrepareAndLaunchIsolate</h4><pre class="line-numbers language-cpp"><code class="language-cpp">Engine<span class="token operator">::</span>RunStatus Engine<span class="token operator">::</span><span class="token function">PrepareAndLaunchIsolate</span><span class="token punctuation">(</span>
    RunConfiguration configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"Engine::PrepareAndLaunchIsolate"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">UpdateAssetManager</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> isolate_configuration <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">TakeIsolateConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span> isolate <span class="token operator">=</span>
      runtime_controller_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetRootIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">// This can happen on iOS after a plugin shows a native window and returns to</span>
  <span class="token comment" spellcheck="true">// the Flutter ViewController.</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> DartIsolate<span class="token operator">::</span>Phase<span class="token operator">::</span>Running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_DLOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Isolate was already running!"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>FailureAlreadyRunning<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate_configuration<span class="token operator">-</span><span class="token operator">></span><span class="token function">PrepareIsolate</span><span class="token punctuation">(</span><span class="token operator">*</span>isolate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not prepare to run the isolate."</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetEntrypointLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">Run</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetEntrypoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      settings_<span class="token punctuation">.</span>dart_entrypoint_args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not run the isolate."</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">RunFromLibrary</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetEntrypointLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 configuration<span class="token punctuation">.</span><span class="token function">GetEntrypoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 settings_<span class="token punctuation">.</span>dart_entrypoint_args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not run the isolate."</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Engine<span class="token operator">::</span>RunStatus Engine<span class="token operator">::</span><span class="token function">PrepareAndLaunchIsolate</span><span class="token punctuation">(</span>
    RunConfiguration configuration<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token function">UpdateAssetManager</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetAssetManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> isolate_configuration <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">TakeIsolateConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>DartIsolate<span class="token operator">></span> isolate <span class="token operator">=</span>
      runtime_controller_<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetRootIsolate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate_configuration<span class="token operator">-</span><span class="token operator">></span><span class="token function">PrepareIsolate</span><span class="token punctuation">(</span><span class="token operator">*</span>isolate<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetEntrypointLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">Run</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetEntrypoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      settings_<span class="token punctuation">.</span>dart_entrypoint_args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isolate<span class="token operator">-</span><span class="token operator">></span><span class="token function">RunFromLibrary</span><span class="token punctuation">(</span>configuration<span class="token punctuation">.</span><span class="token function">GetEntrypointLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 configuration<span class="token punctuation">.</span><span class="token function">GetEntrypoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                 settings_<span class="token punctuation">.</span>dart_entrypoint_args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not run the isolate."</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Failure<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> RunStatus<span class="token operator">::</span>Success<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>启动的核心就是DartIsolate的Run方法，这个EntryPoint就是指main方法。</p>
<h4 id="12-DartIsolate-Run"><a href="#12-DartIsolate-Run" class="headerlink" title="12.DartIsolate::Run"></a>12.DartIsolate::Run</h4><pre class="line-numbers language-cpp"><code class="language-cpp">FML_WARN_UNUSED_RESULT
<span class="token keyword">bool</span> DartIsolate<span class="token operator">::</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> entrypoint_name<span class="token punctuation">,</span>
                      <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">></span><span class="token operator">&amp;</span> args<span class="token punctuation">,</span>
                      fml<span class="token operator">::</span>closure on_run<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">TRACE_EVENT0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"DartIsolate::Run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>phase_ <span class="token operator">!=</span> Phase<span class="token operator">::</span>Ready<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  tonic<span class="token operator">::</span>DartState<span class="token operator">::</span>Scope <span class="token function">scope</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> user_entrypoint_function <span class="token operator">=</span>
      <span class="token function">Dart_GetField</span><span class="token punctuation">(</span><span class="token function">Dart_RootLibrary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span>entrypoint_name<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> entrypoint_args <span class="token operator">=</span> tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InvokeMainEntrypoint</span><span class="token punctuation">(</span>user_entrypoint_function<span class="token punctuation">,</span> entrypoint_args<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  phase_ <span class="token operator">=</span> Phase<span class="token operator">::</span>Running<span class="token punctuation">;</span>
  <span class="token function">FML_DLOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"New isolate is in the running state."</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>on_run<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">on_run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是InvokeMainEntrypoint 方法，先通过Dart_GetField 方法获取到main方法对象，然乎通过对象这个方法反射到dart的main中。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">FML_WARN_UNUSED_RESULT
<span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">InvokeMainEntrypoint</span><span class="token punctuation">(</span>Dart_Handle user_entrypoint_function<span class="token punctuation">,</span>
                                 Dart_Handle args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>tonic<span class="token operator">::</span><span class="token function">LogIfError</span><span class="token punctuation">(</span>user_entrypoint_function<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not resolve main entrypoint function."</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Dart_Handle start_main_isolate_function <span class="token operator">=</span>
      tonic<span class="token operator">::</span><span class="token function">DartInvokeField</span><span class="token punctuation">(</span><span class="token function">Dart_LookupLibrary</span><span class="token punctuation">(</span>tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span><span class="token string">"dart:isolate"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             <span class="token string">"_getStartMainIsolateFunction"</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>tonic<span class="token operator">::</span><span class="token function">LogIfError</span><span class="token punctuation">(</span>start_main_isolate_function<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not resolve main entrypoint trampoline."</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>tonic<span class="token operator">::</span><span class="token function">LogIfError</span><span class="token punctuation">(</span>tonic<span class="token operator">::</span><span class="token function">DartInvokeField</span><span class="token punctuation">(</span>
          <span class="token function">Dart_LookupLibrary</span><span class="token punctuation">(</span>tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span><span class="token string">"dart:ui"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"_runMainZoned"</span><span class="token punctuation">,</span>
          <span class="token punctuation">{</span>start_main_isolate_function<span class="token punctuation">,</span> user_entrypoint_function<span class="token punctuation">,</span> args<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">FML_LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not invoke the main entrypoint."</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>isolate的启动过程会经历如下几个方法的调用：</p>
<ul>
<li><ol>
<li>从dart:isolate 的作用域中找到_getStartMainIsolateFunction 获取_startMainIsolate的方法</li>
</ol>
</li>
</ul>
<p>在这里<a href="https://github.com/dart-lang/sdk/blob/275d8657326ca59e741ca929246404cac90f7ba3/sdk/lib/_internal/vm/lib/isolate_patch.dart">https://github.com/dart-lang/sdk/blob/275d8657326ca59e741ca929246404cac90f7ba3/sdk/lib/_internal/vm/lib/isolate_patch.dart</a></p>
<pre class="line-numbers language-dart"><code class="language-dart"><span class="token metadata symbol">@pragma</span><span class="token punctuation">(</span><span class="token string">"vm:entry-point"</span><span class="token punctuation">,</span> <span class="token string">"call"</span><span class="token punctuation">)</span>
Function <span class="token function">_getStartMainIsolateFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> _startMainIsolate<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token metadata symbol">@pragma</span><span class="token punctuation">(</span><span class="token string">"vm:entry-point"</span><span class="token punctuation">,</span> <span class="token string">"call"</span><span class="token punctuation">)</span>
<span class="token keyword">void</span> <span class="token function">_startMainIsolate</span><span class="token punctuation">(</span>Function entryPoint<span class="token punctuation">,</span> List<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token operator">?</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">_startIsolate</span><span class="token punctuation">(</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// no parent port</span>
      entryPoint<span class="token punctuation">,</span>
      args<span class="token punctuation">,</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// no message</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// isSpawnUri</span>
      <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// no control port</span>
      <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// no capabilities</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>就是这个方法指针。</p>
<ul>
<li>2.获取dart:ui 下的_runMainZoned方法，执行该_startMainIsolate方法，在_startMainIsolate方法中执行main方法。</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart"><span class="token metadata symbol">@pragma</span><span class="token punctuation">(</span><span class="token string">'vm:entry-point'</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">// ignore: unused_element</span>
<span class="token keyword">void</span> <span class="token function">_runMainZoned</span><span class="token punctuation">(</span>Function startMainIsolateFunction<span class="token punctuation">,</span>
                   Function userMainFunction<span class="token punctuation">,</span>
                   List<span class="token operator">&lt;</span>String<span class="token operator">></span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">startMainIsolateFunction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    runZoned<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>userMainFunction <span class="token operator">is</span> _BinaryFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>userMainFunction <span class="token operator">as</span> <span class="token keyword">dynamic</span><span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>userMainFunction <span class="token operator">is</span> _UnaryFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>userMainFunction <span class="token operator">as</span> <span class="token keyword">dynamic</span><span class="token punctuation">)</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">userMainFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> onError<span class="token punctuation">:</span> <span class="token punctuation">(</span>Object error<span class="token punctuation">,</span> StackTrace stackTrace<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_reportUnhandledException</span><span class="token punctuation">(</span>error<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> stackTrace<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个过程就是执行传入了_startMainIsolate方法，接着在回调中执行runZoned方法，最后在这个方法执行main方法，根据main是双参数，多参数还是无参数从而注入从顶层传递下来的args参数。 此时默认是无参数的(除非深入到Fluttermain::Init自定义,不然都是无参数)。</p>
<p>最后执行：</p>
<pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">runApp</span><span class="token punctuation">(</span><span class="token function">MyApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MyApp</span> <span class="token keyword">extends</span> <span class="token class-name">StatelessWidget</span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// This widget is the root of your application.</span>
  <span class="token metadata symbol">@override</span>
  Widget <span class="token function">build</span><span class="token punctuation">(</span>BuildContext context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">MaterialApp</span><span class="token punctuation">(</span>
      title<span class="token punctuation">:</span> <span class="token string">'Flutter Bridge Demo'</span><span class="token punctuation">,</span>
      theme<span class="token punctuation">:</span> <span class="token function">ThemeData</span><span class="token punctuation">(</span>
        primarySwatch<span class="token punctuation">:</span> Colors<span class="token punctuation">.</span>blue<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">,</span>
      home<span class="token punctuation">:</span> <span class="token function">MyHomePage</span><span class="token punctuation">(</span>title<span class="token punctuation">:</span> <span class="token string">'Flutter Bridge Home Page'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Flutter-渲染"><a href="#Flutter-渲染" class="headerlink" title="Flutter 渲染"></a>Flutter 渲染</h2><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">runApp</span><span class="token punctuation">(</span>Widget app<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  WidgetsFlutterBinding<span class="token punctuation">.</span><span class="token function">ensureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">scheduleAttachRootWidget</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">scheduleWarmUpFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>WidgetsFlutterBinding.ensureInitialized Widget的初始化</li>
</ol>
</li>
<li><ol start="2">
<li>scheduleAttachRootWidget 应用的Widget绑定为根</li>
</ol>
</li>
<li><ol start="3">
<li>scheduleWarmUpFrame开始启动刷新</li>
</ol>
</li>
</ul>
<h3 id="1-WidgetsFlutterBinding-ensureInitialized"><a href="#1-WidgetsFlutterBinding-ensureInitialized" class="headerlink" title="1.WidgetsFlutterBinding.ensureInitialized"></a>1.WidgetsFlutterBinding.ensureInitialized</h3><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">WidgetsFlutterBinding</span> <span class="token keyword">extends</span> <span class="token class-name">BindingBase</span> <span class="token keyword">with</span> GestureBinding<span class="token punctuation">,</span> SchedulerBinding<span class="token punctuation">,</span> ServicesBinding<span class="token punctuation">,</span> PaintingBinding<span class="token punctuation">,</span> SemanticsBinding<span class="token punctuation">,</span> RendererBinding<span class="token punctuation">,</span> WidgetsBinding <span class="token punctuation">{</span>

  <span class="token keyword">static</span> WidgetsBinding <span class="token function">ensureInitialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>WidgetsBinding<span class="token punctuation">.</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
      <span class="token function">WidgetsFlutterBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> WidgetsBinding<span class="token punctuation">.</span>instance<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到实际上这就是一个单例 的 WidgetsBinding 对象，这个对象是继承了BindingBase：</p>
<pre class="line-numbers language-dart"><code class="language-dart">  <span class="token function">BindingBase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    developer<span class="token punctuation">.</span>Timeline<span class="token punctuation">.</span><span class="token function">startSync</span><span class="token punctuation">(</span><span class="token string">'Framework initialization'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_debugInitialized<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_debugInitialized<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>_debugServiceExtensionsRegistered<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initServiceExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_debugServiceExtensionsRegistered<span class="token punctuation">)</span><span class="token punctuation">;</span>

    developer<span class="token punctuation">.</span><span class="token function">postEvent</span><span class="token punctuation">(</span><span class="token string">'Flutter.FrameworkInitialization'</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    developer<span class="token punctuation">.</span>Timeline<span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同时mixin了大量的对象，从右到左是：</p>
<ul>
<li><ol>
<li>WidgetsBinding</li>
</ol>
</li>
<li><ol start="2">
<li>RendererBinding</li>
</ol>
</li>
<li><ol start="3">
<li>SemanticsBinding</li>
</ol>
</li>
<li><ol start="4">
<li>PaintingBinding</li>
</ol>
</li>
<li><ol start="5">
<li>ServicesBinding</li>
</ol>
</li>
<li><ol start="6">
<li>SchedulerBinding</li>
</ol>
</li>
<li><ol start="7">
<li>GestureBinding</li>
</ol>
</li>
</ul>
<p>如果都有相同的方法执行也是按照从左到右的顺序执行。比如在BindingBase构造函数中执行了initInstances，发现WidgetsBinding存在initInstances则先执行WidgetsBinding 的initInstances</p>
<h4 id="1-1-GestureBinding-initInstances"><a href="#1-1-GestureBinding-initInstances" class="headerlink" title="1.1 GestureBinding initInstances"></a>1.1 GestureBinding initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>onPointerDataPacket <span class="token operator">=</span> _handlePointerDataPacket<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个方法就是接受从Android 原生传递下来的触点时间</p>
<h4 id="1-2-SchedulerBinding-initInstances"><a href="#1-2-SchedulerBinding-initInstances" class="headerlink" title="1.2 SchedulerBinding initInstances"></a>1.2 SchedulerBinding initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>简单的持有当前对象。SchedulerBinding这个对象是用于处理事务调度，如Android原生需要flutter端开始刷新的一帧的监听。</p>
<h4 id="1-3-ServicesBinding-initInstances"><a href="#1-3-ServicesBinding-initInstances" class="headerlink" title="1.3 ServicesBinding initInstances"></a>1.3 ServicesBinding initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">
  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    _defaultBinaryMessenger <span class="token operator">=</span> <span class="token function">createBinaryMessenger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>onPlatformMessage <span class="token operator">=</span> defaultBinaryMessenger<span class="token punctuation">.</span>handlePlatformMessage<span class="token punctuation">;</span>
    <span class="token function">initLicenses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SystemChannels<span class="token punctuation">.</span>system<span class="token punctuation">.</span><span class="token function">setMessageHandler</span><span class="token punctuation">(</span>handleSystemMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    SystemChannels<span class="token punctuation">.</span>lifecycle<span class="token punctuation">.</span><span class="token function">setMessageHandler</span><span class="token punctuation">(</span>_handleLifecycleMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">readInitialLifecycleStateFromNativeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>该对象创建了一个默认的通信管道<code>_DefaultBinaryMessenger</code>。并且设置该通信管道的handlePlatformMessage方法赋值给Window的onPlatformMessage。</p>
<p>并设置监听<code>flutter/system</code> 和<code>flutter/lifecycle</code>的监听，readInitialLifecycleStateFromNativeWindow 从本地窗口中读取状态。</p>
<h5 id="1-3-1-readInitialLifecycleStateFromNativeWindow"><a href="#1-3-1-readInitialLifecycleStateFromNativeWindow" class="headerlink" title="1.3.1 readInitialLifecycleStateFromNativeWindow"></a>1.3.1 readInitialLifecycleStateFromNativeWindow</h5><pre class="line-numbers language-dart"><code class="language-dart">   <span class="token metadata symbol">@protected</span>
  <span class="token keyword">void</span> <span class="token function">readInitialLifecycleStateFromNativeWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>lifecycleState <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">final</span> AppLifecycleState state <span class="token operator">=</span> <span class="token function">_parseAppLifecycleMessage</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>initialLifecycleState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handleAppLifecycleStateChanged</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>


    <span class="token metadata symbol">@protected</span>
  <span class="token metadata symbol">@mustCallSuper</span>
  <span class="token keyword">void</span> <span class="token function">handleAppLifecycleStateChanged</span><span class="token punctuation">(</span>AppLifecycleState state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>state <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _lifecycleState <span class="token operator">=</span> state<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> AppLifecycleState<span class="token punctuation">.</span>resumed<span class="token punctuation">:</span>
      <span class="token keyword">case</span> AppLifecycleState<span class="token punctuation">.</span>inactive<span class="token punctuation">:</span>
        <span class="token function">_setFramesEnabledState</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> AppLifecycleState<span class="token punctuation">.</span>paused<span class="token punctuation">:</span>
      <span class="token keyword">case</span> AppLifecycleState<span class="token punctuation">.</span>detached<span class="token punctuation">:</span>
        <span class="token function">_setFramesEnabledState</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 实际上就是读取当前Window的状态，只有resumed或者inactive 的时候才会执行_setFramesEnabledState 设置为true。</p>
<h4 id="1-3-1-1-setFramesEnabledState"><a href="#1-3-1-1-setFramesEnabledState" class="headerlink" title="1.3.1.1 _setFramesEnabledState"></a>1.3.1.1 _setFramesEnabledState</h4><pre class="line-numbers language-dart"><code class="language-dart">   <span class="token keyword">void</span> <span class="token function">_setFramesEnabledState</span><span class="token punctuation">(</span>bool enabled<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_framesEnabled <span class="token operator">==</span> enabled<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    _framesEnabled <span class="token operator">=</span> enabled<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span>
      <span class="token function">scheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p> 如果此时传入了的enabled微true，说明此事窗口已经绑定了，可视化了需要开始绘制了。</p>
<h4 id="1-3-1-1-1-scheduleFrame"><a href="#1-3-1-1-1-scheduleFrame" class="headerlink" title="1.3.1.1.1 scheduleFrame"></a>1.3.1.1.1 scheduleFrame</h4><pre class="line-numbers language-dart"><code class="language-dart">   <span class="token keyword">void</span> <span class="token function">scheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_hasScheduledFrame <span class="token operator">||</span> <span class="token operator">!</span>framesEnabled<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>debugPrintScheduleFrameStacks<span class="token punctuation">)</span>
        <span class="token function">debugPrintStack</span><span class="token punctuation">(</span>label<span class="token punctuation">:</span> <span class="token string">'scheduleFrame() called. Current phase is $schedulerPhase.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ensureFrameCallbacksRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    window<span class="token punctuation">.</span><span class="token function">scheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _hasScheduledFrame <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是调用两个步骤：</p>
<ul>
<li><ol>
<li>ensureFrameCallbacksRegistered 注册了Window开始绘制和正在绘制的方法指针</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@protected</span>
  <span class="token keyword">void</span> <span class="token function">ensureFrameCallbacksRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>onBeginFrame <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> _handleBeginFrame<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>onDrawFrame <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> _handleDrawFrame<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol start="2">
<li>window.scheduleFrame<pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">scheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> native <span class="token string">'Window_scheduleFrame'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
</li>
</ul>
<p>这里调用了Native层的 Window_scheduleFrame方法。可以看看在dart虚拟机也有类似jni的机制为注入一个c++的方法，这种方式成为ffi。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Window<span class="token operator">::</span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>tonic<span class="token operator">::</span>DartLibraryNatives<span class="token operator">*</span> natives<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  natives<span class="token operator">-</span><span class="token operator">></span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token punctuation">{</span><span class="token string">"Window_defaultRouteName"</span><span class="token punctuation">,</span> DefaultRouteName<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_scheduleFrame"</span><span class="token punctuation">,</span> ScheduleFrame<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_sendPlatformMessage"</span><span class="token punctuation">,</span> _SendPlatformMessage<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_respondToPlatformMessage"</span><span class="token punctuation">,</span> _RespondToPlatformMessage<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_render"</span><span class="token punctuation">,</span> Render<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_updateSemantics"</span><span class="token punctuation">,</span> UpdateSemantics<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_setIsolateDebugName"</span><span class="token punctuation">,</span> SetIsolateDebugName<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_reportUnhandledException"</span><span class="token punctuation">,</span> ReportUnhandledException<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span><span class="token string">"Window_setNeedsReportTimings"</span><span class="token punctuation">,</span> SetNeedsReportTimings<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注入的时候，虚拟机会在底层new一个DartLibraryNatives 静态对象</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">g_natives <span class="token operator">=</span> <span class="token keyword">new</span> tonic<span class="token operator">::</span><span class="token function">DartLibraryNatives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>所有的方法都会注入到这个对象中，之后需要查找就时候会从这个对象中获取注册号的方法指针。</p>
<h4 id="1-3-1-1-1-1-Window-ScheduleFrame"><a href="#1-3-1-1-1-1-Window-ScheduleFrame" class="headerlink" title="1.3.1.1.1.1 Window ScheduleFrame"></a>1.3.1.1.1.1 Window ScheduleFrame</h4><pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">void</span> <span class="token function">ScheduleFrame</span><span class="token punctuation">(</span>Dart_NativeArguments args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  UIDartState<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">window</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">client</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">ScheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>注意这里的WindowClient 其实就是RuntimeController</p>
<h5 id="1-3-1-1-1-1-1-RuntimeController-ScheduleFrame"><a href="#1-3-1-1-1-1-1-RuntimeController-ScheduleFrame" class="headerlink" title="1.3.1.1.1.1.1 RuntimeController ScheduleFrame"></a>1.3.1.1.1.1.1 RuntimeController ScheduleFrame</h5><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> RuntimeController<span class="token operator">::</span><span class="token function">ScheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  client_<span class="token punctuation">.</span><span class="token function">ScheduleFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>调用了RuntimeDelegate的ScheduleFrame。注意RuntimeDelegate 就是Engine对象。</p>
<pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Engine<span class="token operator">::</span><span class="token function">ScheduleFrame</span><span class="token punctuation">(</span><span class="token keyword">bool</span> regenerate_layer_tree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  animator_<span class="token operator">-</span><span class="token operator">></span><span class="token function">RequestFrame</span><span class="token punctuation">(</span>regenerate_layer_tree<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>此时就是跳转到Animator的RequestFrame</p>
<h6 id="1-3-1-1-1-1-1-1-Animator-RequestFrame"><a href="#1-3-1-1-1-1-1-1-Animator-RequestFrame" class="headerlink" title="1.3.1.1.1.1.1.1 Animator::RequestFrame"></a>1.3.1.1.1.1.1.1 Animator::RequestFrame</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> Animator<span class="token operator">::</span><span class="token function">RequestFrame</span><span class="token punctuation">(</span><span class="token keyword">bool</span> regenerate_layer_tree<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

  task_runners_<span class="token punctuation">.</span><span class="token function">GetUITaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span><span class="token punctuation">[</span>self <span class="token operator">=</span> weak_factory_<span class="token punctuation">.</span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                             frame_number <span class="token operator">=</span> frame_number_<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>self<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">TRACE_EVENT_ASYNC_BEGIN0</span><span class="token punctuation">(</span><span class="token string">"flutter"</span><span class="token punctuation">,</span> <span class="token string">"Frame Request Pending"</span><span class="token punctuation">,</span> frame_number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    self<span class="token operator">-</span><span class="token operator">></span><span class="token function">AwaitVSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  frame_scheduled_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> Animator<span class="token operator">::</span><span class="token function">AwaitVSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  waiter_<span class="token operator">-</span><span class="token operator">></span><span class="token function">AsyncWaitForVsync</span><span class="token punctuation">(</span>
      <span class="token punctuation">[</span>self <span class="token operator">=</span> weak_factory_<span class="token punctuation">.</span><span class="token function">GetWeakPtr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">(</span>fml<span class="token operator">::</span>TimePoint frame_start_time<span class="token punctuation">,</span>
                                          fml<span class="token operator">::</span>TimePoint frame_target_time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token operator">-</span><span class="token operator">></span><span class="token function">CanReuseLastLayerTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            self<span class="token operator">-</span><span class="token operator">></span><span class="token function">DrawLastLayerTree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            self<span class="token operator">-</span><span class="token operator">></span><span class="token function">BeginFrame</span><span class="token punctuation">(</span>frame_start_time<span class="token punctuation">,</span> frame_target_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  delegate_<span class="token punctuation">.</span><span class="token function">OnAnimatorNotifyIdle</span><span class="token punctuation">(</span>dart_frame_deadline_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在ui线程中执行AwaitVSync方法，这个线程实际上就是调用了VsyncWaiter的AsyncWaitForVsync方法等待下一个Vsync信号的到来。</p>
<ul>
<li>如果整个LayerTree可以复用则调用DrawLastLayerTree 绘制上一轮的渲染树</li>
<li>不能则调用BeginFrame 开始渲染。</li>
</ul>
<h4 id="VsyncWaiter-AsyncWaitForVsync"><a href="#VsyncWaiter-AsyncWaitForVsync" class="headerlink" title="VsyncWaiter AsyncWaitForVsync"></a>VsyncWaiter AsyncWaitForVsync</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> VsyncWaiter<span class="token operator">::</span><span class="token function">AsyncWaitForVsync</span><span class="token punctuation">(</span>Callback callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  <span class="token punctuation">{</span>
    std<span class="token operator">::</span>scoped_lock <span class="token function">lock</span><span class="token punctuation">(</span>callback_mutex_<span class="token punctuation">)</span><span class="token punctuation">;</span>

    callback_ <span class="token operator">=</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">AwaitVSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这个VsyncWaiter是一个虚类，实际上实现在VsyncWaiterAndroid。</p>
<h6 id="VsyncWaiterAndroid-AwaitVSync"><a href="#VsyncWaiterAndroid-AwaitVSync" class="headerlink" title="VsyncWaiterAndroid AwaitVSync"></a>VsyncWaiterAndroid AwaitVSync</h6><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">void</span> VsyncWaiterAndroid<span class="token operator">::</span><span class="token function">AwaitVSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">auto</span><span class="token operator">*</span> weak_this <span class="token operator">=</span> <span class="token keyword">new</span> std<span class="token operator">::</span>weak_ptr<span class="token operator">&lt;</span>VsyncWaiter<span class="token operator">></span><span class="token punctuation">(</span><span class="token function">shared_from_this</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  jlong java_baton <span class="token operator">=</span> <span class="token keyword">reinterpret_cast</span><span class="token operator">&lt;</span>jlong<span class="token operator">></span><span class="token punctuation">(</span>weak_this<span class="token punctuation">)</span><span class="token punctuation">;</span>

  task_runners_<span class="token punctuation">.</span><span class="token function">GetPlatformTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">PostTask</span><span class="token punctuation">(</span><span class="token punctuation">[</span>java_baton<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    JNIEnv<span class="token operator">*</span> env <span class="token operator">=</span> fml<span class="token operator">::</span>jni<span class="token operator">::</span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-</span><span class="token operator">></span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>g_vsync_waiter_class<span class="token operator">-</span><span class="token operator">></span><span class="token function">obj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment" spellcheck="true">//</span>
                              g_async_wait_for_vsync_method_<span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">//</span>
                              java_baton                       <span class="token comment" spellcheck="true">//</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>此时就是指Java层的VsyncWaiter的asyncWaitForVsync</p>
<h5 id="Java的VsyncWaiter-asyncWaitForVsync"><a href="#Java的VsyncWaiter-asyncWaitForVsync" class="headerlink" title="Java的VsyncWaiter asyncWaitForVsync"></a>Java的VsyncWaiter asyncWaitForVsync</h5><pre class="line-numbers language-java"><code class="language-java">  <span class="token keyword">private</span> <span class="token keyword">final</span> FlutterJNI<span class="token punctuation">.</span>AsyncWaitForVsyncDelegate asyncWaitForVsyncDelegate <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token class-name">FlutterJNI<span class="token punctuation">.</span>AsyncWaitForVsyncDelegate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">asyncWaitForVsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> cookie<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          Choreographer<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">postFrameCallback</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token class-name">Choreographer<span class="token punctuation">.</span>FrameCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doFrame</span><span class="token punctuation">(</span><span class="token keyword">long</span> frameTimeNanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                      <span class="token keyword">float</span> fps <span class="token operator">=</span> windowManager<span class="token punctuation">.</span><span class="token function">getDefaultDisplay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getRefreshRate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">long</span> refreshPeriodNanos <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1000000000.0</span> <span class="token operator">/</span> fps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      FlutterJNI<span class="token punctuation">.</span><span class="token function">nativeOnVsync</span><span class="token punctuation">(</span>
                          frameTimeNanos<span class="token punctuation">,</span> frameTimeNanos <span class="token operator">+</span> refreshPeriodNanos<span class="token punctuation">,</span> cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>也就是这个方法，实际上BeginFrame就是在Choreographer.getInstance 中注册Vsync的监听。当信号到来之后FlutterJNI.nativeOnVsync 通知Flutter 进行渲染，我们稍后再来看看。</p>
<h4 id="1-4-PaintingBinding-initInstances"><a href="#1-4-PaintingBinding-initInstances" class="headerlink" title="1.4 PaintingBinding initInstances"></a>1.4 PaintingBinding initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    _imageCache <span class="token operator">=</span> <span class="token function">createImageCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shaderWarmUp <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      shaderWarmUp<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.核心是构建通过createImageCache构建一个ImageCache 对象</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">ImageCache</span> <span class="token punctuation">{</span>
  <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> _PendingImage<span class="token operator">></span> _pendingImages <span class="token operator">=</span> <span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> _PendingImage<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> _CachedImage<span class="token operator">></span> _cache <span class="token operator">=</span> <span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> _CachedImage<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> Map<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> _LiveImage<span class="token operator">></span> _liveImages <span class="token operator">=</span> <span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> _LiveImage<span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


  int <span class="token keyword">get</span> maximumSize <span class="token operator">=</span><span class="token operator">></span> _maximumSize<span class="token punctuation">;</span>
  int _maximumSize <span class="token operator">=</span> _kDefaultSize<span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到里面保存了几种缓存</p>
<ul>
<li><ol>
<li>_pendingImages 在Image空间中通过precache提前缓存下来的图片数据</li>
</ol>
</li>
<li>2.如果_pendingImages 找不到，则从_cache中查找缓存的图片</li>
<li>3.如果_cache 中找不到则从_liveImages 中查找缓存的图片，找到了则更新当前缓存图片的时间轴</li>
</ul>
<p>在这个过程中 _cache 是一个LRUCache</p>
<ul>
<li><ol start="2">
<li>shaderWarmUp.execute</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart">  Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>PictureRecorder recorder <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">PictureRecorder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Canvas canvas <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Canvas</span><span class="token punctuation">(</span>recorder<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> <span class="token function">warmUpOnCanvas</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Picture picture <span class="token operator">=</span> recorder<span class="token punctuation">.</span><span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> TimelineTask shaderWarmUpTask <span class="token operator">=</span> <span class="token function">TimelineTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    shaderWarmUpTask<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">'Warm-up shader'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kIsWeb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> picture<span class="token punctuation">.</span><span class="token function">toImage</span><span class="token punctuation">(</span>size<span class="token punctuation">.</span>width<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> size<span class="token punctuation">.</span>height<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    shaderWarmUpTask<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code> PictureRecorder() { _constructor(); }
  void _constructor() native 'PictureRecorder_constructor';</code></pre><ul>
<li>1.首先构造函数是对应native 中的PictureRecorder的constructor方法</li>
<li>2.创建一个ui.Canvas 在其中</li>
<li><ol start="3">
<li>warmUpOnCanvas 开始对整个Flutter的画板做一些初始化的处理</li>
</ol>
</li>
<li><ol start="4">
<li>recorder.endRecording 绘制结束</li>
</ol>
</li>
<li>5.生成一个TimelineTask 对象，并调用start</li>
<li>6.如果不是web环境，则调用picture.toImage转化</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart">String <span class="token function">_toImage</span><span class="token punctuation">(</span>int width<span class="token punctuation">,</span> int height<span class="token punctuation">,</span> _Callback<span class="token operator">&lt;</span>Image<span class="token operator">></span> callback<span class="token punctuation">)</span> native <span class="token string">'Picture_toImage'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<ul>
<li><ol start="7">
<li>shaderWarmUpTask.finish</li>
</ol>
</li>
</ul>
<h4 id="1-4-1-PictureRecorder-constructor"><a href="#1-4-1-PictureRecorder-constructor" class="headerlink" title="1.4.1 PictureRecorder_constructor"></a>1.4.1 PictureRecorder_constructor</h4><pre class="line-numbers language-cpp"><code class="language-cpp"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PictureRecorder_constructor</span><span class="token punctuation">(</span>Dart_NativeArguments args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">DartCallConstructor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>PictureRecorder<span class="token operator">::</span>Create<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>PictureRecorder<span class="token operator">></span> PictureRecorder<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> fml<span class="token operator">::</span>MakeRefCounted<span class="token operator">&lt;</span>PictureRecorder<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>直接构造了一个PictureRecorder 返回。</p>
<h4 id="1-4-2-ui-Canvas-创建"><a href="#1-4-2-ui-Canvas-创建" class="headerlink" title="1.4.2 ui.Canvas 创建"></a>1.4.2 ui.Canvas 创建</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@pragma</span><span class="token punctuation">(</span><span class="token string">'vm:entry-point'</span><span class="token punctuation">)</span>
  <span class="token function">Canvas</span><span class="token punctuation">(</span>PictureRecorder recorder<span class="token punctuation">,</span> <span class="token punctuation">[</span> Rect<span class="token operator">?</span> cullRect <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">assert</span><span class="token punctuation">(</span>recorder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// ignore: unnecessary_null_comparison</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recorder<span class="token punctuation">.</span>isRecording<span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">ArgumentError</span><span class="token punctuation">(</span><span class="token string">'"recorder" must not already be associated with another Canvas.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cullRect <span class="token operator">?</span><span class="token operator">?</span><span class="token operator">=</span> Rect<span class="token punctuation">.</span>largest<span class="token punctuation">;</span>
    <span class="token function">_constructor</span><span class="token punctuation">(</span>recorder<span class="token punctuation">,</span> cullRect<span class="token punctuation">.</span>left<span class="token punctuation">,</span> cullRect<span class="token punctuation">.</span>top<span class="token punctuation">,</span> cullRect<span class="token punctuation">.</span>right<span class="token punctuation">,</span> cullRect<span class="token punctuation">.</span>bottom<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">_constructor</span><span class="token punctuation">(</span>PictureRecorder recorder<span class="token punctuation">,</span>
                    double left<span class="token punctuation">,</span>
                    double top<span class="token punctuation">,</span>
                    double right<span class="token punctuation">,</span>
                    double bottom<span class="token punctuation">)</span> native <span class="token string">'Canvas_constructor'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>Canvas<span class="token operator">></span> Canvas<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>PictureRecorder<span class="token operator">*</span> recorder<span class="token punctuation">,</span>
                                   <span class="token keyword">double</span> left<span class="token punctuation">,</span>
                                   <span class="token keyword">double</span> top<span class="token punctuation">,</span>
                                   <span class="token keyword">double</span> right<span class="token punctuation">,</span>
                                   <span class="token keyword">double</span> bottom<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>Canvas<span class="token operator">></span> canvas <span class="token operator">=</span> fml<span class="token operator">::</span>MakeRefCounted<span class="token operator">&lt;</span>Canvas<span class="token operator">></span><span class="token punctuation">(</span>
      recorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">BeginRecording</span><span class="token punctuation">(</span>SkRect<span class="token operator">::</span><span class="token function">MakeLTRB</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  recorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">set_canvas</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> canvas<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>调用BeginRecording</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-cpp"><code class="language-cpp">SkCanvas<span class="token operator">*</span> PictureRecorder<span class="token operator">::</span><span class="token function">BeginRecording</span><span class="token punctuation">(</span>SkRect bounds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> picture_recorder_<span class="token punctuation">.</span><span class="token function">beginRecording</span><span class="token punctuation">(</span>bounds<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rtree_factory_<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-cpp"><code class="language-cpp">SkCanvas<span class="token operator">*</span> SkPictureRecorder<span class="token operator">::</span><span class="token function">beginRecording</span><span class="token punctuation">(</span><span class="token keyword">const</span> SkRect<span class="token operator">&amp;</span> userCullRect<span class="token punctuation">,</span>
                                            SkBBHFactory<span class="token operator">*</span> bbhFactory <span class="token comment" spellcheck="true">/* = nullptr */</span><span class="token punctuation">,</span>
                                            uint32_t recordFlags <span class="token comment" spellcheck="true">/* = 0 */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> SkRect cullRect <span class="token operator">=</span> userCullRect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> SkRect<span class="token operator">::</span><span class="token function">MakeEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> userCullRect<span class="token punctuation">;</span>

    fCullRect <span class="token operator">=</span> cullRect<span class="token punctuation">;</span>
    fFlags <span class="token operator">=</span> recordFlags<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>bbhFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fBBH<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>bbhFactory<span class="token punctuation">)</span><span class="token punctuation">(</span>cullRect<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SkASSERT</span><span class="token punctuation">(</span>fBBH<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fRecord<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fRecord<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">new</span> SkRecord<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    SkRecorder<span class="token operator">::</span>DrawPictureMode dpm <span class="token operator">=</span> <span class="token punctuation">(</span>recordFlags <span class="token operator">&amp;</span> kPlaybackDrawPicture_RecordFlag<span class="token punctuation">)</span>
        <span class="token operator">?</span> SkRecorder<span class="token operator">::</span>Playback_DrawPictureMode
        <span class="token operator">:</span> SkRecorder<span class="token operator">::</span>Record_DrawPictureMode<span class="token punctuation">;</span>
    fRecorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">reset</span><span class="token punctuation">(</span>fRecord<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cullRect<span class="token punctuation">,</span> dpm<span class="token punctuation">,</span> fMiniRecorder<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fActivelyRecording <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getRecordingCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这个对象根据PictureRecorder 返回了一个SkCanvas对象，在上面绘制</p>
<ul>
<li>2.把Canvas 保存在PictureRecorder中</li>
</ul>
<h4 id="1-4-3-warmUpOnCanvas"><a href="#1-4-3-warmUpOnCanvas" class="headerlink" title="1.4.3 warmUpOnCanvas"></a>1.4.3 warmUpOnCanvas</h4><pre class="line-numbers language-dart"><code class="language-dart"> Future<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">></span> <span class="token function">warmUpOnCanvas</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>Canvas canvas<span class="token punctuation">)</span> <span class="token keyword">async</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ui<span class="token punctuation">.</span>RRect rrect <span class="token operator">=</span> ui<span class="token punctuation">.</span>RRect<span class="token punctuation">.</span><span class="token function">fromLTRBXY</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Path rrectPath <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">addRRect</span><span class="token punctuation">(</span>rrect<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Path circlePath <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">addOval</span><span class="token punctuation">(</span>
        ui<span class="token punctuation">.</span>Rect<span class="token punctuation">.</span><span class="token function">fromCircle</span><span class="token punctuation">(</span>center<span class="token punctuation">:</span> <span class="token keyword">const</span> ui<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">40.0</span><span class="token punctuation">,</span> <span class="token number">40.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> radius<span class="token punctuation">:</span> <span class="token number">20.0</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// The following path is based on</span>
    <span class="token comment" spellcheck="true">// https://skia.org/user/api/SkCanvas_Reference#SkCanvas_drawPath</span>
    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Path path <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">quadraticBezierTo</span><span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    path<span class="token punctuation">.</span><span class="token function">quadraticBezierTo</span><span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Path convexPath <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Path</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    convexPath<span class="token punctuation">.</span><span class="token function">moveTo</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">30.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    convexPath<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">40.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    convexPath<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">30.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    convexPath<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">60.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    convexPath<span class="token punctuation">.</span><span class="token function">lineTo</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    convexPath<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ui<span class="token punctuation">.</span>Path<span class="token operator">></span> paths <span class="token operator">=</span> <span class="token operator">&lt;</span>ui<span class="token punctuation">.</span>Path<span class="token operator">></span><span class="token punctuation">[</span>rrectPath<span class="token punctuation">,</span> circlePath<span class="token punctuation">,</span> path<span class="token punctuation">,</span> convexPath<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">final</span> List<span class="token operator">&lt;</span>ui<span class="token punctuation">.</span>Paint<span class="token operator">></span> paints <span class="token operator">=</span> <span class="token operator">&lt;</span>ui<span class="token punctuation">.</span>Paint<span class="token operator">></span><span class="token punctuation">[</span>
      ui<span class="token punctuation">.</span><span class="token function">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> ui<span class="token punctuation">.</span>PaintingStyle<span class="token punctuation">.</span>fill<span class="token punctuation">,</span>
      ui<span class="token punctuation">.</span><span class="token function">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> ui<span class="token punctuation">.</span>PaintingStyle<span class="token punctuation">.</span>fill<span class="token punctuation">,</span>
      ui<span class="token punctuation">.</span><span class="token function">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> ui<span class="token punctuation">.</span>PaintingStyle<span class="token punctuation">.</span>stroke
        <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span>
      ui<span class="token punctuation">.</span><span class="token function">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>isAntiAlias <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span>style <span class="token operator">=</span> ui<span class="token punctuation">.</span>PaintingStyle<span class="token punctuation">.</span>stroke
        <span class="token punctuation">.</span><span class="token punctuation">.</span>strokeWidth <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span>  <span class="token comment" spellcheck="true">// hairline</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Warm up path stroke and fill shaders.</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> paths<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canvas<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> ui<span class="token punctuation">.</span>Paint paint <span class="token keyword">in</span> paints<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        canvas<span class="token punctuation">.</span><span class="token function">drawPath</span><span class="token punctuation">(</span>paths<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> paint<span class="token punctuation">)</span><span class="token punctuation">;</span>
        canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>drawCallSpacing<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      canvas<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> drawCallSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">// Warm up shadow shaders.</span>
    <span class="token keyword">const</span> ui<span class="token punctuation">.</span>Color black <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">Color</span><span class="token punctuation">(</span><span class="token number">0xFF000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawShadow</span><span class="token punctuation">(</span>rrectPath<span class="token punctuation">,</span> black<span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>drawCallSpacing<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawShadow</span><span class="token punctuation">(</span>rrectPath<span class="token punctuation">,</span> black<span class="token punctuation">,</span> <span class="token number">10.0</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// Warm up text shaders.</span>
    canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> drawCallSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>ParagraphBuilder paragraphBuilder <span class="token operator">=</span> ui<span class="token punctuation">.</span><span class="token function">ParagraphBuilder</span><span class="token punctuation">(</span>
      ui<span class="token punctuation">.</span><span class="token function">ParagraphStyle</span><span class="token punctuation">(</span>textDirection<span class="token punctuation">:</span> ui<span class="token punctuation">.</span>TextDirection<span class="token punctuation">.</span>ltr<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">pushStyle</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span><span class="token function">TextStyle</span><span class="token punctuation">(</span>color<span class="token punctuation">:</span> black<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">addText</span><span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> ui<span class="token punctuation">.</span>Paragraph paragraph <span class="token operator">=</span> paragraphBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">layout</span><span class="token punctuation">(</span><span class="token keyword">const</span> ui<span class="token punctuation">.</span><span class="token function">ParagraphConstraints</span><span class="token punctuation">(</span>width<span class="token punctuation">:</span> <span class="token number">60.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canvas<span class="token punctuation">.</span><span class="token function">drawParagraph</span><span class="token punctuation">(</span>paragraph<span class="token punctuation">,</span> <span class="token keyword">const</span> ui<span class="token punctuation">.</span><span class="token function">Offset</span><span class="token punctuation">(</span><span class="token number">20.0</span><span class="token punctuation">,</span> <span class="token number">20.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> double fraction <span class="token keyword">in</span> <span class="token operator">&lt;</span>double<span class="token operator">></span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canvas
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>fraction<span class="token punctuation">,</span> fraction<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">clipRRect</span><span class="token punctuation">(</span>ui<span class="token punctuation">.</span>RRect<span class="token punctuation">.</span><span class="token function">fromLTRBR</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">328</span><span class="token punctuation">,</span> <span class="token number">248</span><span class="token punctuation">,</span> <span class="token keyword">const</span> ui<span class="token punctuation">.</span>Radius<span class="token punctuation">.</span><span class="token function">circular</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">drawRect</span><span class="token punctuation">(</span><span class="token keyword">const</span> ui<span class="token punctuation">.</span>Rect<span class="token punctuation">.</span><span class="token function">fromLTRB</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ui<span class="token punctuation">.</span><span class="token function">Paint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span>drawCallSpacing<span class="token punctuation">,</span> <span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    canvas<span class="token punctuation">.</span><span class="token function">translate</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">,</span> drawCallSpacing<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>这里面的事情其实就是对SkCanvas中进行绘制操作，从而预热GPU和Skia。通过这个过程可以加载一些缓存到底层的着色器生成和编译。</p>
<h4 id="1-4-4-recorder-endRecording"><a href="#1-4-4-recorder-endRecording" class="headerlink" title="1.4.4  recorder.endRecording"></a>1.4.4  recorder.endRecording</h4><pre class="line-numbers language-cpp"><code class="language-cpp">fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>Picture<span class="token operator">></span> PictureRecorder<span class="token operator">::</span><span class="token function">endRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isRecording</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

  fml<span class="token operator">::</span>RefPtr<span class="token operator">&lt;</span>Picture<span class="token operator">></span> picture <span class="token operator">=</span> Picture<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span>UIDartState<span class="token operator">::</span><span class="token function">CreateGPUObject</span><span class="token punctuation">(</span>
      picture_recorder_<span class="token punctuation">.</span><span class="token function">finishRecordingAsPicture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas_<span class="token operator">-</span><span class="token operator">></span><span class="token function">Clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas_<span class="token operator">-</span><span class="token operator">></span><span class="token function">ClearDartWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas_ <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
  <span class="token function">ClearDartWrapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> picture<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>当绘制结束后，就会通过 picture_recorder_.finishRecordingAsPicture</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">sk_sp<span class="token operator">&lt;</span>SkPicture<span class="token operator">></span> SkPictureRecorder<span class="token operator">::</span><span class="token function">finishRecordingAsPicture</span><span class="token punctuation">(</span>uint32_t finishFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fActivelyRecording <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    fRecorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">restoreToCount</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// If we were missing any restores, add them now.</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fRecord<span class="token operator">-</span><span class="token operator">></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">auto</span> pic <span class="token operator">=</span> fMiniRecorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">detachAsPicture</span><span class="token punctuation">(</span>fBBH <span class="token operator">?</span> <span class="token keyword">nullptr</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>fCullRect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fBBH<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> pic<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SkRecordOptimize</span><span class="token punctuation">(</span>fRecord<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    SkDrawableList<span class="token operator">*</span> drawableList <span class="token operator">=</span> fRecorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">getDrawableList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SkBigPicture<span class="token operator">::</span>SnapshotArray<span class="token operator">*</span> pictList <span class="token operator">=</span>
        drawableList <span class="token operator">?</span> drawableList<span class="token operator">-</span><span class="token operator">></span><span class="token function">newDrawableSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>fBBH<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        SkAutoTMalloc<span class="token operator">&lt;</span>SkRect<span class="token operator">></span> <span class="token function">bounds</span><span class="token punctuation">(</span>fRecord<span class="token operator">-</span><span class="token operator">></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SkRecordFillBounds</span><span class="token punctuation">(</span>fCullRect<span class="token punctuation">,</span> <span class="token operator">*</span>fRecord<span class="token punctuation">,</span> bounds<span class="token punctuation">)</span><span class="token punctuation">;</span>
        fBBH<span class="token operator">-</span><span class="token operator">></span><span class="token function">insert</span><span class="token punctuation">(</span>bounds<span class="token punctuation">,</span> fRecord<span class="token operator">-</span><span class="token operator">></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        SkRect bbhBound <span class="token operator">=</span> fBBH<span class="token operator">-</span><span class="token operator">></span><span class="token function">getRootBound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SkASSERT</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bbhBound<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> fCullRect<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>bbhBound<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">||</span> <span class="token punctuation">(</span>bbhBound<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fCullRect<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fCullRect <span class="token operator">=</span> bbhBound<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    size_t subPictureBytes <span class="token operator">=</span> fRecorder<span class="token operator">-</span><span class="token operator">></span><span class="token function">approxBytesUsedBySubPictures</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> pictList <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> pictList<span class="token operator">-</span><span class="token operator">></span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        subPictureBytes <span class="token operator">+</span><span class="token operator">=</span> pictList<span class="token operator">-</span><span class="token operator">></span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">approximateBytesUsed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> sk_make_sp<span class="token operator">&lt;</span>SkBigPicture<span class="token operator">></span><span class="token punctuation">(</span>fCullRect<span class="token punctuation">,</span> fRecord<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pictList<span class="token punctuation">,</span> fBBH<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                    subPictureBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意这里面就是fRecord.release 获取 中的内容生成SkBigPicture。这个fRecord 就是之前丢给flutter中绘制的RecordSkiaCanvas(在Android中)。</p>
<p>SkBigPicture最后保存在Picture中。</p>
<h4 id="1-4-5-TimelineTask-start"><a href="#1-4-5-TimelineTask-start" class="headerlink" title="1.4.5 TimelineTask start"></a>1.4.5 TimelineTask start</h4><pre class="line-numbers language-cpp"><code class="language-cpp">  <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span>String name<span class="token punctuation">,</span> <span class="token punctuation">{</span>Map<span class="token operator">?</span> arguments<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>_hasTimeline<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// TODO: When NNBD is complete, delete the following line.</span>
    ArgumentError<span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    var block <span class="token operator">=</span> <span class="token keyword">new</span> _AsyncBlock<span class="token punctuation">.</span><span class="token function">_</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> _taskId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _stack<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>

    var map <span class="token operator">=</span> <span class="token operator">&lt;</span>Object<span class="token operator">?</span><span class="token punctuation">,</span> Object<span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arguments <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>var key in arguments<span class="token punctuation">.</span>keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> arguments<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_parent <span class="token operator">!=</span> null<span class="token punctuation">)</span> map<span class="token punctuation">[</span><span class="token string">'parentId'</span><span class="token punctuation">]</span> <span class="token operator">=</span> _parent<span class="token operator">!</span><span class="token punctuation">.</span>_taskId<span class="token punctuation">.</span><span class="token function">toRadixString</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_filterKey <span class="token operator">!=</span> null<span class="token punctuation">)</span> map<span class="token punctuation">[</span>_kFilterKey<span class="token punctuation">]</span> <span class="token operator">=</span> _filterKey<span class="token punctuation">;</span>
    block<span class="token punctuation">.</span><span class="token function">_start</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是生成一个名字为 <code>Warm-up shader</code> 的TimelineTask 时间轴任务通知到底层。</p>
<h4 id="1-4-6-picture-toImage"><a href="#1-4-6-picture-toImage" class="headerlink" title="1.4.6 picture.toImage"></a>1.4.6 picture.toImage</h4><pre class="line-numbers language-dart"><code class="language-dart">  Future<span class="token operator">&lt;</span>Image<span class="token operator">></span> <span class="token function">toImage</span><span class="token punctuation">(</span>int width<span class="token punctuation">,</span> int height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>width <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">||</span> height <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">Exception</span><span class="token punctuation">(</span><span class="token string">'Invalid image dimensions.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_futurize</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span>_Callback<span class="token operator">&lt;</span>Image<span class="token operator">></span> callback<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token function">_toImage</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>


  String <span class="token function">_toImage</span><span class="token punctuation">(</span>int width<span class="token punctuation">,</span> int height<span class="token punctuation">,</span> _Callback<span class="token operator">&lt;</span>Image<span class="token operator">></span> callback<span class="token punctuation">)</span> native <span class="token string">'Picture_toImage'</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>Future&lt;T&gt; _futurize&lt;T&gt;(_Callbacker&lt;T&gt; callbacker) {
  final Completer&lt;T&gt; completer = Completer&lt;T&gt;.sync();
  final String? error = callbacker((T t) {
    if (t == null) {
      completer.completeError(Exception('operation failed'));
    } else {
      completer.complete(t);
    }
  });
  if (error != null)
    throw Exception(error);
  return completer.future;
}</code></pre><p>这里面实际上就是借助了Completer 的异步操作，调用了底层了 Picture_toImage。</p>
<p>这个过程实际上就是调用上面传递下来的callback，在这里就是调用了</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Dart_Handle Picture<span class="token operator">::</span><span class="token function">toImage</span><span class="token punctuation">(</span>uint32_t width<span class="token punctuation">,</span>
                             uint32_t height<span class="token punctuation">,</span>
                             Dart_Handle raw_image_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>picture_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span><span class="token string">"Picture is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token function">RasterizeToImage</span><span class="token punctuation">(</span>picture_<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">,</span> raw_image_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>核心就是RasterizeToImage</p>
<pre class="line-numbers language-cpp"><code class="language-cpp">Dart_Handle Picture<span class="token operator">::</span><span class="token function">RasterizeToImage</span><span class="token punctuation">(</span>sk_sp<span class="token operator">&lt;</span>SkPicture<span class="token operator">></span> picture<span class="token punctuation">,</span>
                                      uint32_t width<span class="token punctuation">,</span>
                                      uint32_t height<span class="token punctuation">,</span>
                                      Dart_Handle raw_image_callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">Dart_IsNull</span><span class="token punctuation">(</span>raw_image_callback<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">Dart_IsClosure</span><span class="token punctuation">(</span>raw_image_callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span><span class="token string">"Image callback was invalid"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>width <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> height <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span><span class="token string">"Image dimensions for scene were invalid."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">auto</span><span class="token operator">*</span> dart_state <span class="token operator">=</span> UIDartState<span class="token operator">::</span><span class="token function">Current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  tonic<span class="token operator">::</span>DartPersistentValue<span class="token operator">*</span> image_callback <span class="token operator">=</span>
      <span class="token keyword">new</span> tonic<span class="token operator">::</span><span class="token function">DartPersistentValue</span><span class="token punctuation">(</span>dart_state<span class="token punctuation">,</span> raw_image_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> unref_queue <span class="token operator">=</span> dart_state<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetSkiaUnrefQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> ui_task_runner <span class="token operator">=</span> dart_state<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetUITaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">auto</span> io_task_runner <span class="token operator">=</span> dart_state<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetTaskRunners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetIOTaskRunner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  fml<span class="token operator">::</span>WeakPtr<span class="token operator">&lt;</span>GrContext<span class="token operator">></span> resource_context <span class="token operator">=</span> dart_state<span class="token operator">-</span><span class="token operator">></span><span class="token function">GetResourceContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> picture_bounds <span class="token operator">=</span> SkISize<span class="token operator">::</span><span class="token function">Make</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">auto</span> ui_task <span class="token operator">=</span> fml<span class="token operator">::</span><span class="token function">MakeCopyable</span><span class="token punctuation">(</span><span class="token punctuation">[</span>image_callback<span class="token punctuation">,</span> unref_queue<span class="token punctuation">]</span><span class="token punctuation">(</span>
                                       sk_sp<span class="token operator">&lt;</span>SkImage<span class="token operator">></span> raster_image<span class="token punctuation">)</span> <span class="token keyword">mutable</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> dart_state <span class="token operator">=</span> image_callback<span class="token operator">-</span><span class="token operator">></span><span class="token function">dart_state</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dart_state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    tonic<span class="token operator">::</span>DartState<span class="token operator">::</span>Scope <span class="token function">scope</span><span class="token punctuation">(</span>dart_state<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>raster_image<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      tonic<span class="token operator">::</span><span class="token function">DartInvoke</span><span class="token punctuation">(</span>image_callback<span class="token operator">-</span><span class="token operator">></span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token function">Dart_Null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> dart_image <span class="token operator">=</span> CanvasImage<span class="token operator">::</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    dart_image<span class="token operator">-</span><span class="token operator">></span><span class="token function">set_image</span><span class="token punctuation">(</span><span class="token punctuation">{</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>raster_image<span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>unref_queue<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span><span class="token operator">*</span> raw_dart_image <span class="token operator">=</span> tonic<span class="token operator">::</span><span class="token function">ToDart</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">move</span><span class="token punctuation">(</span>dart_image<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tonic<span class="token operator">::</span><span class="token function">DartInvoke</span><span class="token punctuation">(</span>image_callback<span class="token operator">-</span><span class="token operator">></span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>raw_dart_image<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">delete</span> image_callback<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  fml<span class="token operator">::</span>TaskRunner<span class="token operator">::</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>io_task_runner<span class="token punctuation">,</span> <span class="token punctuation">[</span>ui_task_runner<span class="token punctuation">,</span> picture<span class="token punctuation">,</span>
                                                     picture_bounds<span class="token punctuation">,</span> ui_task<span class="token punctuation">,</span>
                                                     resource_context<span class="token punctuation">]</span> <span class="token punctuation">{</span>
    sk_sp<span class="token operator">&lt;</span>SkSurface<span class="token operator">></span> surface <span class="token operator">=</span>
        <span class="token function">MakeSnapshotSurface</span><span class="token punctuation">(</span>picture_bounds<span class="token punctuation">,</span> resource_context<span class="token punctuation">)</span><span class="token punctuation">;</span>
    sk_sp<span class="token operator">&lt;</span>SkImage<span class="token operator">></span> raster_image <span class="token operator">=</span> <span class="token function">MakeRasterSnapshot</span><span class="token punctuation">(</span>picture<span class="token punctuation">,</span> surface<span class="token punctuation">)</span><span class="token punctuation">;</span>

    fml<span class="token operator">::</span>TaskRunner<span class="token operator">::</span><span class="token function">RunNowOrPostTask</span><span class="token punctuation">(</span>
        ui_task_runner<span class="token punctuation">,</span> <span class="token punctuation">[</span>ui_task<span class="token punctuation">,</span> raster_image<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">ui_task</span><span class="token punctuation">(</span>raster_image<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">Dart_Null</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>整个核心就是在io线程中调用MakeRasterSnapshot方法获取surface中的SkImage对象。最后把这个raster_image对象通过ui线程执行<code>ui_task</code>任务，在这个任务中就把<code>raster_image</code>设置到dart的Image对象中。</p>
<h4 id="1-5-SemanticsBinding-initInstances"><a href="#1-5-SemanticsBinding-initInstances" class="headerlink" title="1.5 SemanticsBinding initInstances"></a>1.5 SemanticsBinding initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    _accessibilityFeatures <span class="token operator">=</span> window<span class="token punctuation">.</span>accessibilityFeatures<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>获取window.accessibilityFeatures 到全局变量中</p>
<h4 id="1-6-RendererBinding-initInstances"><a href="#1-6-RendererBinding-initInstances" class="headerlink" title="1.6 RendererBinding initInstances"></a>1.6 RendererBinding initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    _pipelineOwner <span class="token operator">=</span> <span class="token function">PipelineOwner</span><span class="token punctuation">(</span>
      onNeedVisualUpdate<span class="token punctuation">:</span> ensureVisualUpdate<span class="token punctuation">,</span>
      onSemanticsOwnerCreated<span class="token punctuation">:</span> _handleSemanticsOwnerCreated<span class="token punctuation">,</span>
      onSemanticsOwnerDisposed<span class="token punctuation">:</span> _handleSemanticsOwnerDisposed<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    window
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onMetricsChanged <span class="token operator">=</span> handleMetricsChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onTextScaleFactorChanged <span class="token operator">=</span> handleTextScaleFactorChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onPlatformBrightnessChanged <span class="token operator">=</span> handlePlatformBrightnessChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onSemanticsEnabledChanged <span class="token operator">=</span> _handleSemanticsEnabledChanged
      <span class="token punctuation">.</span><span class="token punctuation">.</span>onSemanticsAction <span class="token operator">=</span> _handleSemanticsAction<span class="token punctuation">;</span>
    <span class="token function">initRenderView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_handleSemanticsEnabledChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>renderView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addPersistentFrameCallback</span><span class="token punctuation">(</span>_handlePersistentFrameCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initMouseTracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>将window的响应的处理方法赋值对应的方法指针，设置PipelineOwner对象。</li>
</ol>
</li>
<li><ol start="2">
<li>initRenderView 构建一个RenderView 准备绘制</li>
</ol>
</li>
<li><ol start="3">
<li>_handleSemanticsEnabledChanged 如果window的semanticsEnabled 为true则设置_semanticsHandle为_pipelineOwner.ensureSemantics()</li>
</ol>
</li>
<li><ol start="4">
<li>addPersistentFrameCallback 添加一个从Java中回调上的onDrawFrame，对应dart的handleDrawFrame。</li>
</ol>
</li>
<li><ol start="5">
<li>initMouseTracker 初始化MouseTracker</li>
</ol>
</li>
</ul>
<h5 id="1-6-1-PipelineOwner"><a href="#1-6-1-PipelineOwner" class="headerlink" title="1.6.1 PipelineOwner"></a>1.6.1 PipelineOwner</h5><p>PipelineOwner 是flutter 用于控制渲染管道的。</p>
<pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">PipelineOwner</span> <span class="token punctuation">{</span>

  <span class="token function">PipelineOwner</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onNeedVisualUpdate<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onSemanticsOwnerCreated<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>onSemanticsOwnerDisposed<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">final</span> VoidCallback onNeedVisualUpdate<span class="token punctuation">;</span>

  <span class="token keyword">final</span> VoidCallback onSemanticsOwnerCreated<span class="token punctuation">;</span>

  <span class="token keyword">final</span> VoidCallback onSemanticsOwnerDisposed<span class="token punctuation">;</span>

   AbstractNode <span class="token keyword">get</span> rootNode <span class="token operator">=</span><span class="token operator">></span> _rootNode<span class="token punctuation">;</span>
  AbstractNode _rootNode<span class="token punctuation">;</span>
  <span class="token keyword">set</span> <span class="token function">rootNode</span><span class="token punctuation">(</span>AbstractNode value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_rootNode <span class="token operator">==</span> value<span class="token punctuation">)</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
    _rootNode<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _rootNode <span class="token operator">=</span> value<span class="token punctuation">;</span>
    _rootNode<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  List<span class="token operator">&lt;</span>RenderObject<span class="token operator">></span> _nodesNeedingLayout <span class="token operator">=</span> <span class="token operator">&lt;</span>RenderObject<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  List<span class="token operator">&lt;</span>RenderObject<span class="token operator">></span> _nodesNeedingLayout <span class="token operator">=</span> <span class="token operator">&lt;</span>RenderObject<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">flushLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kReleaseMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Timeline<span class="token punctuation">.</span><span class="token function">startSync</span><span class="token punctuation">(</span><span class="token string">'Layout'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> timelineArgumentsIndicatingLandmarkEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _debugDoingLayout <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment" spellcheck="true">// TODO(ianh): assert that we're not allowing previously dirty nodes to redirty themselves</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>_nodesNeedingLayout<span class="token punctuation">.</span>isNotEmpty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RenderObject<span class="token operator">></span> dirtyNodes <span class="token operator">=</span> _nodesNeedingLayout<span class="token punctuation">;</span>
        _nodesNeedingLayout <span class="token operator">=</span> <span class="token operator">&lt;</span>RenderObject<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RenderObject node <span class="token keyword">in</span> dirtyNodes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RenderObject a<span class="token punctuation">,</span> RenderObject b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a<span class="token punctuation">.</span>depth <span class="token operator">-</span> b<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_needsLayout <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>owner <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
            node<span class="token punctuation">.</span><span class="token function">_layoutWithoutResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _debugDoingLayout <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kReleaseMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Timeline<span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">flushCompositingBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kReleaseMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Timeline<span class="token punctuation">.</span><span class="token function">startSync</span><span class="token punctuation">(</span><span class="token string">'Compositing bits'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _nodesNeedingCompositingBitsUpdate<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RenderObject a<span class="token punctuation">,</span> RenderObject b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> a<span class="token punctuation">.</span>depth <span class="token operator">-</span> b<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RenderObject node <span class="token keyword">in</span> _nodesNeedingCompositingBitsUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_needsCompositingBitsUpdate <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>owner <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span>
        node<span class="token punctuation">.</span><span class="token function">_updateCompositingBits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    _nodesNeedingCompositingBitsUpdate<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kReleaseMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Timeline<span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  List<span class="token operator">&lt;</span>RenderObject<span class="token operator">></span> _nodesNeedingPaint <span class="token operator">=</span> <span class="token operator">&lt;</span>RenderObject<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">flushPaint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kReleaseMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      Timeline<span class="token punctuation">.</span><span class="token function">startSync</span><span class="token punctuation">(</span><span class="token string">'Paint'</span><span class="token punctuation">,</span> arguments<span class="token punctuation">:</span> timelineArgumentsIndicatingLandmarkEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _debugDoingPaint <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">final</span> List<span class="token operator">&lt;</span>RenderObject<span class="token operator">></span> dirtyNodes <span class="token operator">=</span> _nodesNeedingPaint<span class="token punctuation">;</span>
      _nodesNeedingPaint <span class="token operator">=</span> <span class="token operator">&lt;</span>RenderObject<span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token comment" spellcheck="true">// Sort the dirty nodes in reverse order (deepest first).</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> RenderObject node <span class="token keyword">in</span> dirtyNodes<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RenderObject a<span class="token punctuation">,</span> RenderObject b<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> b<span class="token punctuation">.</span>depth <span class="token operator">-</span> a<span class="token punctuation">.</span>depth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">assert</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>_layer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_needsPaint <span class="token operator">&amp;&amp;</span> node<span class="token punctuation">.</span>owner <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_layer<span class="token punctuation">.</span>attached<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            PaintingContext<span class="token punctuation">.</span><span class="token function">repaintCompositedChild</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            node<span class="token punctuation">.</span><span class="token function">_skippedPaintingOnLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span>_nodesNeedingPaint<span class="token punctuation">.</span>isEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _debugDoingPaint <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>kReleaseMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Timeline<span class="token punctuation">.</span><span class="token function">finishSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>能看到这个管道的职责就是，作为入口刷新每一个RenderObject。</p>
<h5 id="1-6-2-initRenderView"><a href="#1-6-2-initRenderView" class="headerlink" title="1.6.2 initRenderView"></a>1.6.2 initRenderView</h5><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token keyword">void</span> <span class="token function">initRenderView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>renderView <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderView <span class="token operator">=</span> <span class="token function">RenderView</span><span class="token punctuation">(</span>configuration<span class="token punctuation">:</span> <span class="token function">createViewConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> window<span class="token punctuation">:</span> window<span class="token punctuation">)</span><span class="token punctuation">;</span>
    renderView<span class="token punctuation">.</span><span class="token function">prepareInitialFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-dart"><code class="language-dart"><span class="token keyword">class</span> <span class="token class-name">RenderView</span> <span class="token keyword">extends</span> <span class="token class-name">RenderObject</span> <span class="token keyword">with</span> RenderObjectWithChildMixin<span class="token operator">&lt;</span>RenderBox<span class="token operator">></span> <span class="token punctuation">{</span>

  <span class="token function">RenderView</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    RenderBox child<span class="token punctuation">,</span>
    <span class="token metadata symbol">@required</span> ViewConfiguration configuration<span class="token punctuation">,</span>
    <span class="token metadata symbol">@required</span> ui<span class="token punctuation">.</span>Window window<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">assert</span><span class="token punctuation">(</span>configuration <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
       _configuration <span class="token operator">=</span> configuration<span class="token punctuation">,</span>
       _window <span class="token operator">=</span> window <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>child <span class="token operator">=</span> child<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>RenderView 是一个RenderObject，会持有一个child。此时初始化并没有，单数传递了一个窗体下去。</li>
</ol>
</li>
<li><ol start="2">
<li>renderView.prepareInitialFrame</li>
</ol>
</li>
</ul>
<h6 id="1-6-2-1-renderView-prepareInitialFrame"><a href="#1-6-2-1-renderView-prepareInitialFrame" class="headerlink" title="1.6.2.1 renderView.prepareInitialFrame"></a>1.6.2.1 renderView.prepareInitialFrame</h6><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token keyword">void</span> <span class="token function">prepareInitialFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>owner <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_rootTransform <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scheduleInitialLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">scheduleInitialPaint</span><span class="token punctuation">(</span><span class="token function">_updateMatricesAndCreateNewRootLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_rootTransform <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li><ol>
<li>scheduleInitialLayout 初始化布局</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  PipelineOwner <span class="token keyword">get</span> owner <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">super</span><span class="token punctuation">.</span>owner <span class="token operator">as</span> PipelineOwner<span class="token punctuation">;</span>

  <span class="token keyword">void</span> <span class="token function">scheduleInitialLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>attached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>parent <span class="token operator">is!</span> RenderObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span>_debugDoingLayout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_relayoutBoundary <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _relayoutBoundary <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      _debugCanParentUseSize <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    owner<span class="token punctuation">.</span>_nodesNeedingLayout<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>实际上就是给PipelineOwner的_nodesNeedingLayout 需要更新的RenderObject的集合将本根节点添加进去。</p>
<ul>
<li><ol start="2">
<li>scheduleInitialPaint</li>
</ol>
</li>
</ul>
<pre class="line-numbers language-dart"><code class="language-dart">  TransformLayer <span class="token function">_updateMatricesAndCreateNewRootLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _rootTransform <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">toMatrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">final</span> TransformLayer rootLayer <span class="token operator">=</span> <span class="token function">TransformLayer</span><span class="token punctuation">(</span>transform<span class="token punctuation">:</span> _rootTransform<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rootLayer<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_rootTransform <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rootLayer<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>生成一个TransformLayer 并把TransformLayer和当前的RenderView绑定起来，在scheduleInitialPaint中设置好TransformLayer，并添加到_nodesNeedingPaint ，需要绘制的ContainerLayer节点(也就是Layer)</p>
<pre class="line-numbers language-dart"><code class="language-dart">  <span class="token keyword">void</span> <span class="token function">scheduleInitialPaint</span><span class="token punctuation">(</span>ContainerLayer rootLayer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>rootLayer<span class="token punctuation">.</span>attached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>attached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>parent <span class="token operator">is!</span> RenderObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token operator">!</span>owner<span class="token punctuation">.</span>_debugDoingPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>isRepaintBoundary<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_layer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _layer <span class="token operator">=</span> rootLayer<span class="token punctuation">;</span>
    <span class="token keyword">assert</span><span class="token punctuation">(</span>_needsPaint<span class="token punctuation">)</span><span class="token punctuation">;</span>
    owner<span class="token punctuation">.</span>_nodesNeedingPaint<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-7-WidgetsBinding-initInstances"><a href="#1-7-WidgetsBinding-initInstances" class="headerlink" title="1.7 WidgetsBinding  initInstances"></a>1.7 WidgetsBinding  initInstances</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@override</span>
  <span class="token keyword">void</span> <span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">initInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _instance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>

    <span class="token keyword">assert</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">_debugAddStackFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    _buildOwner <span class="token operator">=</span> <span class="token function">BuildOwner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    buildOwner<span class="token punctuation">.</span>onBuildScheduled <span class="token operator">=</span> _handleBuildScheduled<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>onLocaleChanged <span class="token operator">=</span> handleLocaleChanged<span class="token punctuation">;</span>
    window<span class="token punctuation">.</span>onAccessibilityFeaturesChanged <span class="token operator">=</span> handleAccessibilityFeaturesChanged<span class="token punctuation">;</span>
    SystemChannels<span class="token punctuation">.</span>navigation<span class="token punctuation">.</span><span class="token function">setMethodCallHandler</span><span class="token punctuation">(</span>_handleNavigationInvocation<span class="token punctuation">)</span><span class="token punctuation">;</span>
    FlutterErrorDetails<span class="token punctuation">.</span>propertiesTransformers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>transformDebugCreator<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>1.window对象设置了onBuildScheduled 和onLocaleChanged回调方法。</li>
<li>2.设置一个Navgation的操作本地方法通信对象</li>
</ul>
<pre><code>  Future&lt;dynamic&gt; _handleNavigationInvocation(MethodCall methodCall) {
    switch (methodCall.method) {
      case 'popRoute':
        return handlePopRoute();
      case 'pushRoute':
        return handlePushRoute(methodCall.arguments as String);
    }
    return Future&lt;dynamic&gt;.value();
  }</code></pre><h3 id="2-scheduleAttachRootWidget"><a href="#2-scheduleAttachRootWidget" class="headerlink" title="2. scheduleAttachRootWidget"></a>2. scheduleAttachRootWidget</h3><h4 id="2-1-WidgetsBinding-scheduleAttachRootWidget"><a href="#2-1-WidgetsBinding-scheduleAttachRootWidget" class="headerlink" title="2.1 WidgetsBinding scheduleAttachRootWidget"></a>2.1 WidgetsBinding scheduleAttachRootWidget</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@protected</span>
  <span class="token keyword">void</span> <span class="token function">scheduleAttachRootWidget</span><span class="token punctuation">(</span>Widget rootWidget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Timer<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">attachRootWidget</span><span class="token punctuation">(</span>rootWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过Timer.run异步执行attachRootWidget</p>
<h4 id="Timer-异步原理"><a href="#Timer-异步原理" class="headerlink" title="Timer 异步原理"></a>Timer 异步原理</h4><pre class="line-numbers language-dart"><code class="language-dart">  <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token function">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">Timer</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span>zero<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-dart"><code class="language-dart">  <span class="token keyword">factory</span> <span class="token function">Timer</span><span class="token punctuation">(</span>Duration duration<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token function">Function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Zone<span class="token punctuation">.</span>current <span class="token operator">==</span> Zone<span class="token punctuation">.</span>root<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">createTimer</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> Zone<span class="token punctuation">.</span>current
        <span class="token punctuation">.</span><span class="token function">createTimer</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> Zone<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">bindCallbackGuarded</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-dart"><code class="language-dart">  <span class="token metadata symbol">@patch</span>
  <span class="token keyword">static</span> Timer <span class="token function">_createTimer</span><span class="token punctuation">(</span>Duration duration<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token keyword">factory</span> <span class="token operator">=</span> VMLibraryHooks<span class="token punctuation">.</span>timerFactory<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">factory</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UnsupportedError</span><span class="token punctuation">(</span><span class="token string">"Timer interface not supported."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    int milliseconds <span class="token operator">=</span> duration<span class="token punctuation">.</span>inMilliseconds<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>milliseconds <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> milliseconds <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">factory</span><span class="token punctuation">(</span>milliseconds<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>


            


        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-dot-circle-o"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/backup/Flutter启动.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Flutter Application初始化启动入口FlutterMain.startInitialization(this);
1. FlutterMain startInitialization  public static void 
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>

                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                本篇&nbsp;<i class="fa fa-dot-circle-o"></i>
            </div>
            <div class="card">
                <a href="/backup/Flutter启动.html">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/0.jpg" class="responsive-img" alt="">
                        
                        <span class="card-title"></span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Flutter Application初始化启动入口FlutterMain.startInitialization(this);
1. FlutterMain startInitialization  public static void 
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-01
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-user fa-fw"></i>
                            yjy239
                            
                        </span>
                    </div>
                </div>

                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: yjy239的博客<br />'
            + '作者: yjy239<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="center-align copy-right">
            <!-- 本站由&nbsp;&copy;<a href="https://github.com/yjy239/yjy239.github.io.git" target="_blank">yjy239</a>&nbsp;基于
            <a href="https://hexo.io/" target="_blank">Hexo</a>&nbsp;的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>&nbsp;主题搭建 -->
            <!-- <br> -->
            <div>&copy;Copyright yjy239的博客</div>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">804k</span>&nbsp;字
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="fa fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fa fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            <br>
            <!-- <span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span> -->
            <!-- <script>
                var now = new Date();

                function createtime() {
                    var grt = new Date("11/05/2019 00:00:00");
                    now.setTime(now.getTime() + 250);
                    days = (now - grt) / 1000 / 60 / 60 / 24;
                    dnum = Math.floor(days);
                    hours = (now - grt) / 1000 / 60 / 60 - (24 * dnum);
                    hnum = Math.floor(hours);
                    if (String(hnum).length == 1) {
                        hnum = "0" + hnum;
                    }
                    minutes = (now - grt) / 1000 / 60 - (24 * 60 * dnum) - (60 * hnum);
                    mnum = Math.floor(minutes);
                    if (String(mnum).length == 1) {
                        mnum = "0" + mnum;
                    }
                    seconds = (now - grt) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
                    snum = Math.round(seconds);
                    if (String(snum).length == 1) {
                        snum = "0" + snum;
                    }
                    document.getElementById("timeDate").innerHTML = "本站已安全运行 " + dnum + " 天 ";
                    document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
                }
                setInterval("createtime()", 250);
            </script> -->
            
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/yjy239" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>
















    <a href="https://www.jianshu.com/u/3a14616d66ba" class="tooltipped" target="_blank" data-tooltip="关注我的简书: https://www.jianshu.com/u/3a14616d66ba" data-position="top" data-delay="50">
        <i class="fa fa-inverse">简</i>
    </a>



</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Global site tag (gtag.js) - Google Analytics -->


    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    <!-- 在线聊天工具  洪卫 shw2018 modify 2019.09.17 -->
    

    
    <script>
        (function (i, s, o, g, r, a, m) {
            i["DaoVoiceObject"] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o), m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            a.charset = "utf-8";
            m.parentNode.insertBefore(a, m)
        })(window, document, "script", ('https:' == document.location.protocol ? 'https:' : 'http:') +
            "//widget.daovoice.io/widget/6984b559.js", "daovoice")
        daovoice('init', {
            app_id: ""
        });
        daovoice('update');
    </script>
    

    

    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon.min.js" async="async"></script>
    

    
    
    

</body>

</html>
